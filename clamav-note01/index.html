<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e71379dda153709d1a9a.css" id="gatsby-global-css">html{font-size:100}body{margin:0 0 0 calc(100vw - 100%);color:#222;line-height:1.4;font-size:.875rem;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background-color:#fcfcfc}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:1.575rem;line-height:2.25rem;margin-top:5rem;margin-bottom:1.25rem}h2{font-size:1.47656rem;line-height:1.875rem}h2,h3{margin-top:2.5rem;margin-bottom:.625rem}h3{font-size:1.20313rem;line-height:1.25rem}h4{font-size:1.05rem;margin-top:1.875rem}h4,h5{line-height:1.25rem;margin-bottom:.625rem}h5,h6{font-size:.875rem;margin-top:3.125rem}h6{line-height:1.25rem;margin-bottom:.625rem}img{max-width:100%;margin:inherit auto}hr,img{border:0;display:block}hr{color:#222;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);width:6.25rem}a{color:#918d40;text-decoration:none}a:active,a:focus,a:hover{color:#a9d159}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.25rem}ul li{padding:0 .3125rem;margin-bottom:.625rem}p{line-height:1.25rem;margin-bottom:1.25rem}blockquote{font-style:italic;text-align:center;background-color:#f5f5f5;padding:.1875rem .625rem}figure{display:block;width:100%;height:auto}figcaption{line-height:.9375rem;margin-top:.3125rem;color:#222;font-size:.75rem;font-style:italic;margin-bottom:0;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.25rem}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}li>code[class*=language-text],p>code[class*=language-text]{background:#f9f9f9!important;color:#2d2d2d!important}.Author-module--author__photo--36xCH{display:inline-block;margin-bottom:0;border-radius:50%;background-clip:padding-box}.Author-module--author__title--2CaTb{font-size:.98438rem;font-weight:600;line-height:1.40625rem;margin:.625rem 0}.Author-module--author__title-link--Yrism,.Author-module--author__title-link--Yrism:focus,.Author-module--author__title-link--Yrism:hover{color:#222}.Author-module--author__subtitle--cAaEB{color:#888;line-height:1.25rem;margin-bottom:1.25rem}.Icon-module--icon--Gpyvw{display:inline-block;width:1em;height:1em;stroke-width:0;stroke:currentColor;fill:currentColor;font-style:normal;font-weight:400;speak:none;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.Contacts-module--contacts--1rGd1{margin-bottom:1.25rem}.Contacts-module--contacts__list--3OgdW{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;padding:0;margin:.625rem -.1875rem;width:8.75rem}.Contacts-module--contacts__list-item--16p9q{padding:0;margin:.25rem;display:flex;align-content:center;align-items:center;justify-content:center;height:2.1875rem;width:2.1875rem;line-height:2.1875rem;border-radius:50%;text-align:center;border:1px solid #ebebeb}.Contacts-module--contacts__list-item-link--2MIDn{border:0;display:flex;color:#222}.Contacts-module--contacts__list-item-link--2MIDn:focus,.Contacts-module--contacts__list-item-link--2MIDn:hover{color:#918d40}.Copyright-module--copyright--1ariN{color:#b6b6b6;font-size:.75rem}.Menu-module--menu--Efbin{margin-bottom:1.25rem}.Menu-module--menu__list--31Zeo{list-style:none;padding:0;margin:0}.Menu-module--menu__list-item--1lJ6B{padding:0;margin:.625rem 0}.Menu-module--menu__list-item-link--10Ush{font-size:.875rem;color:#222;font-weight:400;border:0}.Menu-module--menu__list-item-link--10Ush:focus,.Menu-module--menu__list-item-link--10Ush:hover{color:#918d40;border-bottom:1px solid #918d40}.Menu-module--menu__list-item-link--active--2CbUO{color:#222;border-bottom:1px solid #222}.Sidebar-module--sidebar--X4z2p{width:100%}.Sidebar-module--sidebar__inner--Jdc5s{position:relative;padding:1.5625rem 1.25rem 0}.Sidebar-module--headerimage--19Rdy{width:100%;min-height:70px;max-height:120px;margin:0 0 .625rem}.Sidebar-module--logo-image--XDYae{min-height:70px;max-height:120px;margin:0 auto}input{-webkit-appearance:none;-moz-appearance:none;appearance:none;padding:.625rem;margin:.3125rem 0;border:1px solid #999;border-radius:.3125rem}.Sidebar-module--search-container--17C6F{position:relative}.Sidebar-module--search-container-input--27Tw4{width:100%}.Sidebar-module--search-container-submit--WwtLg{position:absolute;width:2.375rem;height:2.375rem;top:calc(50% - 19px);right:0;border:3px solid #999;border-radius:0 .25rem .25rem 0;background:#999}.Sidebar-module--search-container-submit--WwtLg:before{position:absolute;content:"";width:.9375rem;height:.9375rem;top:calc(50% - 9px);left:calc(50% - 9px);border-radius:50%;box-shadow:0 0 0 2px #fff}.Sidebar-module--search-container-submit--WwtLg:after{position:absolute;content:"";width:.5rem;height:.375rem;top:calc(50% + 6px);left:calc(50% + 2px);border-top:2px solid #fff;transform:rotate(45deg)}@media screen and (min-width:685px){.Sidebar-module--sidebar--X4z2p{width:calc(41.625% - 1.09375rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(12n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--Jdc5s:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);position:absolute;content:"";width:.0625rem;height:33.75rem;top:30px;right:-10px;bottom:0}}@media screen and (min-width:960px){.Sidebar-module--sidebar--X4z2p{width:calc(33.3% - 1.25rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(3n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:2.5rem}}.Layout-module--layout--3Pyz6{max-width:66.875rem;margin-left:auto;margin-right:auto}.Layout-module--layout--3Pyz6:before{content:"";display:table}.Layout-module--layout--3Pyz6:after{content:"";display:table;clear:both}.Feed-module--feed__item--2D5rE{margin-bottom:1.5625rem}.Feed-module--feed__item--2D5rE:last-child{margin-bottom:.625rem}.Feed-module--feed__item-title--3nigr{font-size:1.47656rem;line-height:1.875rem;margin-top:0;margin-bottom:.625rem}.Feed-module--feed__item-title-link--iFMRs{color:#222}.Feed-module--feed__item-title-link--iFMRs:focus,.Feed-module--feed__item-title-link--iFMRs:hover{color:#222;border-bottom:1px solid #222}.Feed-module--feed__item-description--1uO8e{font-size:.875rem;line-height:1.25rem;margin-bottom:.9375rem}.Feed-module--feed__item-meta-time--3t1fg{font-size:.75rem;color:#222;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--N-Q0A{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--23f8F{font-size:.75rem;color:#a9d159;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--23f8F:focus,.Feed-module--feed__item-meta-category-link--23f8F:hover{color:#918d40}.Feed-module--feed__item-readmore--1u6bI{font-size:.875rem;color:#918d40}.Feed-module--feed__item-readmore--1u6bI:focus,.Feed-module--feed__item-readmore--1u6bI:hover{color:#918d40;border-bottom:1px solid #918d40}.Page-module--page--2nMky{margin-bottom:2.5rem}.Page-module--page__inner--2M_vz{padding:1.5625rem 1.25rem}.Page-module--page__title--GPD8L{font-size:1.575rem;font-weight:600;line-height:2.5rem;margin-top:0;margin-bottom:1.8125rem}.Page-module--page__body--Ic6i6{font-size:.875rem;line-height:1.25rem;margin:0 0 1.25rem}@media screen and (min-width:685px){.Page-module--page--2nMky{width:calc(58.275% - .78125rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(12n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(12n+1){clear:both}.Page-module--page__inner--2M_vz{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--2nMky{width:calc(66.6% - .625rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(3n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(3n+1){clear:both}.Page-module--page__inner--2M_vz{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--2H3nO{margin-top:2.5rem;display:flex}.Pagination-module--pagination__prev--bet5s{width:50%;text-align:left}.Pagination-module--pagination__prev-link--1Nzs6{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--1Nzs6:focus,.Pagination-module--pagination__prev-link--1Nzs6:hover{color:#918d40}.Pagination-module--pagination__prev-link--disable--Yklx9{pointer-events:none;color:#bbb}.Pagination-module--pagination__next--3hFiN{width:50%;text-align:right}.Pagination-module--pagination__next-link--3FUtA{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--3FUtA:focus,.Pagination-module--pagination__next-link--3FUtA:hover{color:#918d40}.Pagination-module--pagination__next-link--disable--30UwZ{pointer-events:none;color:#bbb}.Author-module--author--2Yefr{border-top:1px solid #e6e6e6;max-width:43.75rem;padding-top:1.25rem;line-height:1.25rem;margin-top:1.25rem;margin-bottom:2.5rem}.Author-module--author__bio-twitter--n-O9n{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2Yefr{margin-left:auto;margin-right:auto}}.Content-module--content--3p512{max-width:62.8125rem;padding:0 .9375rem;margin:0 auto}.Content-module--content__title--2BDW9{font-size:1.75rem;max-width:43.75rem;font-weight:600;text-align:center;line-height:2.0625rem;margin:1.25rem auto 0}.Content-module--content__body--2TrQ- figure{margin-bottom:1.25rem}.Content-module--content__body--2TrQ- figure blockquote{font-style:italic;text-align:center;margin-top:0;padding:1.25rem 0}.Content-module--content__body--2TrQ- figure blockquote p{max-width:43.75rem;font-size:1.47149rem;margin-top:1.25rem;margin-bottom:1.25rem;line-height:1.875rem}.Content-module--content__body--2TrQ- a{text-decoration:underline}.Content-module--content__body--2TrQ- *{max-width:43.75rem;margin-left:auto;margin-right:auto}.Content-module--content__body--2TrQ- img{max-width:100%;margin-top:.625rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- li ul{margin-bottom:.625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- h2{position:relative;padding:1rem 1.5rem;color:#fff;border-radius:.625rem;background:#0c0000}.Content-module--content__body--2TrQ- h2:after{position:absolute;bottom:-9px;left:1rem;width:0;height:0;content:"";border-color:#0c0000 transparent transparent;border-style:solid;border-width:10px 10px 0}.Content-module--content__body--2TrQ- h3{border-bottom:3px dotted #0c0000;padding:1rem 0}@media screen and (min-width:960px){.Content-module--content--3p512{padding:0}.Content-module--content__title--2BDW9{font-size:1.75rem;line-height:2.8125rem;margin-top:2.8125rem;margin-bottom:1.875rem}.Content-module--content__body--2TrQ-,.Content-module--content__body--2TrQ- p{font-size:.98438rem;line-height:1.40625rem;margin-bottom:1.40625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}}.Meta-module--meta__date--29eD7{font-style:italic}.Tags-module--tags--1L_ct{margin-bottom:.625rem}.Tags-module--tags__list--91FqN{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--1M30P{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3SL_8{display:inline-block;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;border:1px solid #e6e6e6;text-decoration:none;border-radius:1.25rem;color:#222}.Tags-module--tags__list-item-link--3SL_8:focus,.Tags-module--tags__list-item-link--3SL_8:hover{color:#918d40}.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{max-width:43.75rem;margin:0 auto;padding:0 .9375rem}.Post-module--post__home-button--16Kl0{display:block;max-width:5.625rem;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;text-align:center;color:#222;border:1px solid #e6e6e6;border-radius:1.25rem;font-size:.875rem;font-weight:400;margin-left:auto;margin-right:auto;margin-top:1.25rem}.Post-module--post__home-button--16Kl0:focus,.Post-module--post__home-button--16Kl0:hover{color:#918d40}@media screen and (min-width:960px){.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{padding:0}.Post-module--post__home-button--16Kl0{position:fixed;max-width:auto;margin:0;top:30px;left:30px}}</style><meta name="generator" content="Gatsby 2.32.13"/><link rel="alternate" type="application/rss+xml" title="かえるのひみつきち" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-122086587-6"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-122086587-6', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#F7A046"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><title data-react-helmet="true">ClamAV をソースコードからビルドして OnAccessScan をセットアップするまでのまとめ - かえるのひみつきち</title><meta data-react-helmet="true" name="description" content="ClamAV をソースコードからビルドして OnAccessScan をセットアップするまでの手順をまとめました。"/><meta data-react-helmet="true" property="og:site_name" content="ClamAV をソースコードからビルドして OnAccessScan をセットアップするまでのまとめ - かえるのひみつきち"/><meta data-react-helmet="true" property="og:image" content="https://kashiwaba-yuki.com/static/34516ec698c27cd04cfd176d8c426baf/clamav-note01.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="ClamAV をソースコードからビルドして OnAccessScan をセットアップするまでのまとめ - かえるのひみつきち"/><meta data-react-helmet="true" name="twitter:description" content="ClamAV をソースコードからビルドして OnAccessScan をセットアップするまでの手順をまとめました。"/><meta data-react-helmet="true" name="twitter:image" content="https://kashiwaba-yuki.com/static/34516ec698c27cd04cfd176d8c426baf/clamav-note01.png"/><link as="script" rel="preload" href="/webpack-runtime-a3c0f166cb4b802ff58f.js"/><link as="script" rel="preload" href="/framework-3761df4ab6ee9f056936.js"/><link as="script" rel="preload" href="/532a2f07-92db97c0addf07d5cb73.js"/><link as="script" rel="preload" href="/dc6a8720040df98778fe970bf6c000a41750d3ae-7931894db9633ae8bcc9.js"/><link as="script" rel="preload" href="/app-96e4878161dbb29d31fb.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-js-381c1b847824134fa4bd.js"/><link as="fetch" rel="preload" href="/page-data/clamav-note01/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/251939775.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/401334301.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/825871152.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--3Pyz6"><div><a class="Post-module--post__home-button--16Kl0" href="/">All Articles</a><div><div class="Content-module--content--3p512"><h1 class="Content-module--content__title--2BDW9">ClamAV をソースコードからビルドして OnAccessScan をセットアップするまでのまとめ</h1><div class="Content-module--content__body--2TrQ-"><p>2024 年は大きめのプロダクトのソースコードをじっくり読み込みたく、一番興味のある AntiVirus をやっていきたいと思っています。</p>
<p>しかし、非常に残念なことに一般にソースコードが公開されている AntiVirus Software はほぼ存在しません。</p>
<p>そんな中で、ほぼ唯一オープンソースで開発を行っている AntiVirus Software が、主にメールゲートウェイを対象とするプロダクトの ClamAV です。</p>
<p>ClamAV は Linux 環境限定ではありますが、昨今の Linux 用 AntiVirus の多くが利用している fanotify を利用した OnAccesScan(リアルタイムスキャン) の機能もあり、非常に参考になりそうなプロダクトです。
(Windows 端末でも、オンデマンドスキャナとしての ClamAV を利用できます。)</p>
<p>今回は ClamAV のソースコードを読み解く足掛かりとして、ClamAV 1.2.0 のビルドと一通りのセットアップ手順をまとめてみました。</p>
<!-- omit in toc -->
<h2 id="もくじ" style="position:relative;"><a href="#%E3%82%82%E3%81%8F%E3%81%98" aria-label="もくじ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>もくじ</h2>
<ul>
<li>
<p><a href="#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99">事前準備</a></p>
<ul>
<li><a href="#%E3%83%93%E3%83%AB%E3%83%89--%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">ビルド &#x26; インストール</a></li>
<li><a href="#%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97">セットアップ</a></li>
<li><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB">インストールモジュール</a></li>
<li><a href="#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A6%E3%83%BC%E3%82%B6%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">サービスユーザアカウントを作成する</a></li>
</ul>
</li>
<li>
<p><a href="#%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">設定ファイルを作成する</a></p>
<ul>
<li><a href="#freshclamconf-%E3%82%92%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B">freshclam.conf を編集する</a></li>
<li><a href="#clamdconf-%E3%82%92%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B">clamd.conf を編集する</a></li>
</ul>
</li>
<li>
<p><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A8-systemd-%E3%82%92%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%97%E3%81%A6%E5%86%8D%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B">デバッグと Systemd を有効化して再ビルドする</a></p>
<ul>
<li><a href="#%E3%83%93%E3%83%AB%E3%83%89%E6%99%82%E3%81%AE%E8%AD%A6%E5%91%8A%E3%82%92%E6%8A%91%E5%88%B6%E3%81%99%E3%82%8B">ビルド時の警告を抑制する</a></li>
</ul>
</li>
<li><a href="#%E6%A4%9C%E7%9F%A5%E6%99%82%E3%81%AE%E9%80%9A%E7%9F%A5%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B">検知時の通知を設定する</a></li>
<li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li>
</ul>
<h2 id="事前準備" style="position:relative;"><a href="#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99" aria-label="事前準備 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>事前準備</h2>
<h3 id="ビルド--インストール" style="position:relative;"><a href="#%E3%83%93%E3%83%AB%E3%83%89--%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" aria-label="ビルド  インストール permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ビルド &#x26; インストール</h3>
<p>Ubuntu 20.04 に ClamAV をインストールするためには以下のコマンドを使用しました。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Run with root user in Ubuntu 20.04</span>
<span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y gcc <span class="token function">make</span> pkg-config python3 python3-pip python3-pytest valgrind cmake check libbz2-dev libcurl4-openssl-dev libjson-c-dev libmilter-dev libncurses5-dev libpcre2-dev libssl-dev libxml2-dev zlib1g-dev cargo rustc -y

<span class="token comment"># Install rust</span>
<span class="token function">curl</span> --proto <span class="token string">'=https'</span> --tlsv1.2 -sSf https://sh.rustup.rs <span class="token operator">|</span> <span class="token function">sh</span>

<span class="token comment"># Build and install</span>
<span class="token function">git</span> clone https://github.com/Cisco-Talos/clamav.git
<span class="token builtin class-name">cd</span> clamav <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> build
cmake <span class="token punctuation">..</span>
cmake --build <span class="token builtin class-name">.</span> --target <span class="token function">install</span>

<span class="token comment"># Check install version</span>
clamav-config --version</code></pre></div>
<p>参考：<a href="https://docs.clamav.net/manual/Installing/Installing-from-source-Unix.html" target="_blank" rel="nofollow noopener noreferrer">Unix from source (v0.104+) - ClamAV Documentation</a></p>
<p>ルートディレクトリにある CMakeLists.txt は CMake でビルドプロセスを管理するためのビルド設定を定義しているファイルです。</p>
<p>ClamAV 1.2.0 の場合はおよそ 1300 行ほどありますが、ざっと見ていくとどのようなファイルをビルドに使用しているかの大枠を把握できます。</p>
<p>参考：<a href="https://github.com/Cisco-Talos/clamav/blob/clamav-1.2.0/CMakeLists.txt" target="_blank" rel="nofollow noopener noreferrer">clamav/CMakeLists.txt at clamav-1.2.0 · Cisco-Talos/clamav</a></p>
<p>以下では、ルート直下の cmake ディレクトリを <code class="language-text">CMAKE_MODULE_PATH</code> としてセットし、バージョン情報を include していることがわかります。</p>
<div class="gatsby-highlight" data-language=";b"><pre class="language-;b"><code class="language-;b">set(CMAKE_MODULE_PATH &quot;${CMAKE_CURRENT_SOURCE_DIR}/cmake&quot; ${CMAKE_MODULE_PATH})
include(Version)

set(PACKAGE_NAME      &quot;${PROJECT_NAME}&quot;)
set(PACKAGE_VERSION   &quot;${PROJECT_VERSION}&quot;)
set(PACKAGE_STRING    &quot;${PROJECT_NAME} ${PROJECT_VERSION}${VERSION_SUFFIX}&quot;)
set(PACKAGE_BUGREPORT &quot;https://github.com/Cisco-Talos/clamav/issues&quot;)
set(PACKAGE_URL       &quot;https://www.clamav.net/&quot;)
HexVersion(PACKAGE_VERSION_NUM ${PROJECT_VERSION_MAJOR} ${PROJECT_VERSION_MINOR} ${PROJECT_VERSION_PATCH})</code></pre></div>
<p>Version.cmake の中には HexVersion と NumberToHex という 2 つの関数が定義されています。</p>
<p>それぞれ名前の通り、バージョン情報の値を 16 進数文字列に変換する用途で使用されているようです。</p>
<p>参考：<a href="https://github.com/Cisco-Talos/clamav/blob/clamav-1.2.0/cmake/Version.cmake" target="_blank" rel="nofollow noopener noreferrer">clamav/cmake/Version.cmake at clamav-1.2.0 · Cisco-Talos/clamav</a></p>
<p>以下では、ビルド対象のプラットフォームが Linux または Unix か macOS であるかを識別しています。</p>
<p>Linux の場合は <code class="language-text">C_LINUX</code> にフラグを立てます。</p>
<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token comment"># Define C_LINUX and C_BSD because CMake only defines UNIX, APPLE, WIN32, MSVC</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">CMAKE_SYSTEM_NAME</span> <span class="token operator">STREQUAL</span> <span class="token string">"Linux"</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>C_LINUX <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token variable">APPLE</span> <span class="token operator">OR</span> <span class="token variable">CMAKE_SYSTEM_NAME</span> <span class="token operator">MATCHES</span> <span class="token string">"BSD"</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>C_BSD <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>以下では、 デフォルトオプションをいくつか定義しています。</p>
<p>前述のコードで <code class="language-text">C_LINUX</code> にフラグが立っている場合は、<code class="language-text">ENABLE_CLAMONACC_DEFAULT</code> が ON に設定されます。 </p>
<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token comment"># CMake Option default values:</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>MAINTAINER_MODE_DEFAULT         <span class="token boolean">OFF</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_APP_DEFAULT              <span class="token boolean">ON</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">WIN32</span> <span class="token operator">OR</span> <span class="token variable">APPLE</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_MILTER_DEFAULT       <span class="token boolean">OFF</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_MILTER_DEFAULT       <span class="token boolean">ON</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>C_LINUX<span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_CLAMONACC_DEFAULT    <span class="token boolean">ON</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_CLAMONACC_DEFAULT    <span class="token boolean">OFF</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_EXAMPLES_DEFAULT         <span class="token boolean">OFF</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_TESTS_DEFAULT            <span class="token boolean">ON</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">WIN32</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_MAN_PAGES_DEFAULT    <span class="token boolean">OFF</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_MAN_PAGES_DEFAULT    <span class="token boolean">ON</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_DOXYGEN_DEFAULT          <span class="token boolean">OFF</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_UNRAR_DEFAULT            <span class="token boolean">ON</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>ENABLE_SYSTEMD_DEFAULT          <span class="token boolean">ON</span><span class="token punctuation">)</span></code></pre></div>
<p>また、ルート直下の CMakeOptions.cmake で定義したオプション設定もここでロードします。</p>
<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token comment"># See CMakeOptions.cmake for additional options.</span>
<span class="token keyword">include</span><span class="token punctuation">(</span>CMakeOptions.cmake<span class="token punctuation">)</span></code></pre></div>
<p>参考：<a href="https://github.com/Cisco-Talos/clamav/blob/clamav-1.2.0/CMakeOptions.cmake" target="_blank" rel="nofollow noopener noreferrer">clamav/CMakeOptions.cmake at clamav-1.2.0 · Cisco-Talos/clamav</a></p>
<p>続く以下の行では、CMake  のビルドタイプが指定されているかをチェックします。</p>
<p>ビルドタイプが指定されていない場合はデフォルトで RelWithDebInfo(ビルド時の最適化あり、デバッグ情報あり、asset なし) が選択されます。</p>
<p>その他、Debug を設定した場合はビルド時の最適化が行われず、デバッグ情報の付与や assert の有効化が行われます。</p>
<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token comment"># Set build type to RelWithDebInfo if not specified.</span>
<span class="token comment"># This must be done before pulling in the Rust module</span>
<span class="token comment"># or else the default build will be Debug for Rust stuffs.</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">NOT</span> <span class="token variable">CMAKE_BUILD_TYPE</span> <span class="token operator">AND</span> <span class="token operator">NOT</span> <span class="token variable">CMAKE_CONFIGURATION_TYPES</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_BUILD_TYPE</span> RelWithDebInfo <span class="token variable">CACHE</span> STRING <span class="token string">"Choose the build type"</span> FORCE<span class="token punctuation">)</span>

    <span class="token comment"># Include "None" as option to disable any additional (optimization) flags,</span>
    <span class="token comment"># relying on just CMAKE_C_FLAGS and CMAKE_CXX_FLAGS (which are empty by</span>
    <span class="token comment"># default). These strings are presented in cmake-gui.</span>
    <span class="token keyword">set_property</span><span class="token punctuation">(</span><span class="token variable">CACHE</span> <span class="token variable">CMAKE_BUILD_TYPE</span> PROPERTY <span class="token property">STRINGS</span>
        <span class="token string">"None"</span> <span class="token string">"Debug"</span> <span class="token string">"Release"</span> <span class="token string">"MinSizeRel"</span> <span class="token string">"RelWithDebInfo"</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>参考：<a href="https://docs.clamav.net/manual/Installing/Installing-from-source-Unix.html#a-build-for-development" target="_blank" rel="nofollow noopener noreferrer">ClamAV Documentation</a></p>
<p>テストに関するオプションなどを飛ばして読み進めると以下の箇所が見つかります。</p>
<p>ここでは、cmake の <code class="language-text">find_package</code> を使用していくつかの依存関係パッケージの存在確認を行っています。</p>
<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token comment"># Including CPack must be the very last CPack thing we do.</span>
<span class="token keyword">include</span><span class="token punctuation">(</span>CPack<span class="token punctuation">)</span>

<span class="token comment"># libclamav efficacy dependencies</span>
<span class="token keyword">find_package</span><span class="token punctuation">(</span>OpenSSL REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>OPENSSL_FOUND<span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>HAVE_LIBSSL <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">find_package</span><span class="token punctuation">(</span>ZLIB REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ZLIB_FOUND<span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>HAVE_ZLIB_H <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>HAVE_LIBZ <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">find_package</span><span class="token punctuation">(</span>BZip2 REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>BZIP2_FOUND<span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>HAVE_BZLIB_H <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Disable CMAKE_FIND_PACKAGE_PREFER_CONFIG, temporarily, because</span>
<span class="token comment"># we don't presently support the using libxml2's Config.cmake</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>PACKAGE_PREFER_CONFIG_BAK <span class="token punctuation">${</span><span class="token variable">CMAKE_FIND_PACKAGE_PREFER_CONFIG</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_FIND_PACKAGE_PREFER_CONFIG</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token keyword">find_package</span><span class="token punctuation">(</span>LibXml2 REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>LibXml2_FOUND<span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>HAVE_LIBXML2 <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Restore the requested CMAKE_FIND_PACKAGE_PREFER_CONFIG setting</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_FIND_PACKAGE_PREFER_CONFIG</span> <span class="token punctuation">${</span>PACKAGE_PREFER_CONFIG_BAK<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">find_package</span><span class="token punctuation">(</span>PCRE2 REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>PCRE2_FOUND<span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>HAVE_PCRE <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>USING_PCRE2 <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># libclamav feature dependencies</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">NOT</span> <span class="token variable">WIN32</span><span class="token punctuation">)</span>
    <span class="token keyword">find_package</span><span class="token punctuation">(</span>Iconv REQUIRED<span class="token punctuation">)</span>
    <span class="token comment"># Set variable required by libclamav to use iconv</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>HAVE_ICONV <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>参考：<a href="https://cmake.org/cmake/help/latest/command/find_package.html" target="_blank" rel="nofollow noopener noreferrer">find_package — CMake 3.28.1 Documentation</a></p>
<p>また、<code class="language-text">check_include_file</code> によりヘッダファイルのチェックも実施しています。</p>
<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token comment"># Checks for header files.</span>
<span class="token keyword">include</span><span class="token punctuation">(</span>CheckIncludeFile<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"arpa/inet.h"</span>        HAVE_ARPA_INET_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"fcntl.h"</span>            HAVE_FCNTL_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"grp.h"</span>              HAVE_GRP_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"limits.h"</span>           HAVE_LIMITS_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"malloc.h"</span>           HAVE_MALLOC_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"netdb.h"</span>            HAVE_NETDB_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"netinet/in.h"</span>       HAVE_NETINET_IN_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"poll.h"</span>             HAVE_POLL_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"pwd.h"</span>              HAVE_PWD_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"stdbool.h"</span>          HAVE_STDBOOL_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"stdlib.h"</span>           HAVE_STDLIB_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"string.h"</span>           HAVE_STRING_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"strings.h"</span>          HAVE_STRINGS_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/cdefs.h"</span>        HAVE_SYS_CDEFS_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/dl.h"</span>           HAVE_SYS_DL_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/fileio.h"</span>       HAVE_SYS_FILIO_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/mman.h"</span>         HAVE_SYS_MMAN_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/param.h"</span>        HAVE_SYS_PARAM_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/queue.h"</span>        HAVE_SYS_QUEUE_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/select.h"</span>       HAVE_SYS_SELECT_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/socket.h"</span>       HAVE_SYS_SOCKET_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/stat.h"</span>         HAVE_SYS_STAT_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/time.h"</span>         HAVE_SYS_TIME_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/times.h"</span>        HAVE_SYS_TIMES_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/uio.h"</span>          HAVE_SYS_UIO_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"syslog.h"</span>           USE_SYSLOG<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"termios.h"</span>          HAVE_TERMIOS_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"time.h"</span>             HAVE_TIME_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"unistd.h"</span>           HAVE_UNISTD_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/fanotify.h"</span>     HAVE_SYS_FANOTIFY_H<span class="token punctuation">)</span>
**
<span class="token comment"># int-types variants</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"inttypes.h"</span>         HAVE_INTTYPES_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/inttypes.h"</span>     HAVE_SYS_INTTYPES_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"sys/int_types.h"</span>    HAVE_SYS_INT_TYPES_H<span class="token punctuation">)</span>
<span class="token function">check_include_file</span><span class="token punctuation">(</span><span class="token string">"stdint.h"</span>           HAVE_STDINT_H<span class="token punctuation">)</span></code></pre></div>
<p>最後に、テストやビルドなどの処理を定義しています。</p>
<p>この時、<code class="language-text">CMAKE_INSTALL_PREFIX</code> や <code class="language-text">CLAMAV_USER</code> などのオプションによって、ClamAV のインストール先や ClamAV ユーザなどが決定されます。</p>
<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token comment"># autotools-compatible names</span>
<span class="token comment"># Sphinx expects relative paths in the .rst files. Use the fact that the files</span>
<span class="token comment"># below are all one directory level deep.</span>
<span class="token keyword">file</span><span class="token punctuation">(</span>RELATIVE_PATH top_srcdir   <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span></span>/dir"</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">file</span><span class="token punctuation">(</span>RELATIVE_PATH top_builddir <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span></span>/dir"</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>abs_top_srcdir   <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_SOURCE_DIR</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>abs_top_builddir <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token comment"># libclamav.pc (pkg-config file)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>prefix      <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_INSTALL_PREFIX</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>exec_prefix <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_INSTALL_PREFIX</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>bindir      <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_INSTALL_FULL_BINDIR</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>sbindir     <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_INSTALL_FULL_SBINDIR</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>libdir      <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_INSTALL_FULL_LIBDIR</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>includedir  <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_INSTALL_FULL_INCLUDEDIR</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token property">VERSION</span>     <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PACKAGE_VERSION</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span></code></pre></div>
<h3 id="セットアップ" style="position:relative;"><a href="#%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97" aria-label="セットアップ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>セットアップ</h3>
<p>ClamAV のビルドとインストールが完了したら、とりあえず ClamAV のシグネチャの更新とリアルタイム保護(オンアクセススキャン)、そしてオンデマンドスキャンによって最低限 Malware を検出できるところまでセットアップを進めていきます。</p>
<h3 id="インストールモジュール" style="position:relative;"><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB" aria-label="インストールモジュール permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>インストールモジュール</h3>
<p>セットアップの前に、ClamAV の動作に関わる主要なコンポーネントをチェックしていきます。</p>
<ul>
<li>clamd：これは、libclamav を使用してファイルスキャンを行うためのマルチスレッドデーモンです。スキャンの動作は <code class="language-text">clamd.conf</code> にて変更が可能です。</li>
<li>clamdscan：clamd のクライアントモジュールです。clamd のソケット(または TCP)に対してコマンド実行を要求したり、スキャン結果をレポートしたりすることができます。clamdscan によりスキャンを実行するためには clamd デーモンが稼働している必要があります。</li>
<li>clamscan：clamdscan と名称が似ていますがこちらは単体の手動スキャン(Onetime Scan)を実行するためのコマンドラインツールです。clamdscan とは異なり、スキャンを実行するために clamd デーモンの稼働を必要としません。</li>
<li>freshclam：ClamAV のシグネチャデータベース(.cvd)を更新するために使用するモジュールです。構成ファイル <code class="language-text">freshclam.conf</code> にて管理されます。</li>
<li>
<p>clamonacc：Linux システムにリアルタイム保護(オンアクセススキャン)を提供するモジュールです。これによって、ファイルアクセス時にリアルタイムに clamd によるファイルスキャンを行うことができるようになります。</p>
<p>リアルタイム保護では、スキャン結果に基づいて Malware へのアクセスをブロックできますが、既定では監査のみを行う設定になっています。</p>
</li>
<li>clamav-milter：clamd と連携して動作するメールフィルタリングツールです。メールサーバと連携して Malware スキャンを実施できます。</li>
<li>clamconf：ClamAV システム全体の構成をチェックするためのツールです。</li>
</ul>
<p>参考：<a href="https://docs.clamav.net/manual/Usage/Scanning.html#scanning" target="_blank" rel="nofollow noopener noreferrer">Scanning - ClamAV Documentation</a></p>
<p>参考：<a href="https://docs.clamav.net/manual/Usage/Configuration.html" target="_blank" rel="nofollow noopener noreferrer">Configuration - ClamAV Documentation</a></p>
<p>参考：<a href="https://centossrv.com/almalinux/postfix-clamav-milter.shtml" target="_blank" rel="nofollow noopener noreferrer">メールサーバーでウイルスチェック(Postfix+Clam AntiVirus+clamav-milter) - AlmaLinuxで自宅サーバー構築</a></p>
<h3 id="サービスユーザアカウントを作成する" style="position:relative;"><a href="#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A6%E3%83%BC%E3%82%B6%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B" aria-label="サービスユーザアカウントを作成する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>サービスユーザアカウントを作成する</h3>
<p>パッケージマネージャではなくソースコードから ClamAV をビルドする場合、サービスユーザアカウントは手動で作成する必要があります。</p>
<p>このサービスユーザは freshclam によるシグネチャの更新にも利用します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Run with root user in Ubuntu 20.04</span>
<span class="token function">groupadd</span> clamav
<span class="token function">useradd</span> -g clamav -s /bin/false -c <span class="token string">"Clam Antivirus"</span> clamav
<span class="token function">mkdir</span> -p /usr/local/share/clamav
<span class="token function">chown</span> -R clamav:clamav /usr/local/share/clamav</code></pre></div>
<p>参考：<a href="https://docs.clamav.net/manual/Usage/Configuration.html#users-and-on-user-privileges" target="_blank" rel="nofollow noopener noreferrer">Configuration - ClamAV Documentation</a></p>
<p>また、事前にログファイルを作成し、サービスユーザを所有者に変更しておきます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">touch</span> /var/log/freshclam.log <span class="token punctuation">;</span> <span class="token function">touch</span> /var/log/clamav.log
<span class="token function">chmod</span> <span class="token number">600</span> /var/log/freshclam.log <span class="token punctuation">;</span> <span class="token function">chmod</span> <span class="token number">600</span> /var/log/clamav.log
<span class="token function">chown</span> clamav /var/log/freshclam.log <span class="token punctuation">;</span> <span class="token function">chown</span> clamav /var/log/clamav.log</code></pre></div>
<p>そして、作成した clamav ユーザがパスワードなしで sudo 経由の <em>notification-send</em> を実行できるようにします。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"clamav ALL = (ALL) NOPASSWD: SETENV: /usr/bin/notify-send"</span> <span class="token operator">></span> /etc/sudoers.d/clamav</code></pre></div>
<p>参考：<a href="https://wiki.archlinux.org/title/ClamAV#OnAccessScan" target="_blank" rel="nofollow noopener noreferrer">ClamAV - ArchWiki</a></p>
<h2 id="設定ファイルを作成する" style="position:relative;"><a href="#%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B" aria-label="設定ファイルを作成する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>設定ファイルを作成する</h2>
<p>今回は clamav-milter は使用しないので <code class="language-text">clamd.conf</code> と <code class="language-text">freshclam.conf</code> の設定ファイルを作成します。</p>
<p>パッケージマネージャではなくソースコードから ClamAV をビルドする場合、構成ファイルは手動で作成する必要があります。</p>
<p>clamconf を使用することで構成ファイルのサンプルを作成できるので、このサンプルを編集した後に構成ディレクトリに配置します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Run with root user in Ubuntu 20.04</span>
<span class="token comment"># Generate sample config files</span>
<span class="token function">mkdir</span> -p /etc/clamav
clamconf -g freshclam.conf <span class="token operator">></span> /usr/local/etc/freshclam.confm.conf
clamconf -g clamd.conf <span class="token operator">></span> /usr/local/etc/clamd.conf</code></pre></div>
<p>参考：<a href="https://docs.clamav.net/manual/Usage/Configuration.html" target="_blank" rel="nofollow noopener noreferrer">Configuration - ClamAV Documentation</a></p>
<h3 id="freshclamconf-を編集する" style="position:relative;"><a href="#freshclamconf-%E3%82%92%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B" aria-label="freshclamconf を編集する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>freshclam.conf を編集する</h3>
<p>まず初めに freshclam で作成した <code class="language-text">/usr/local/etc/freshclam.conf</code> を直接編集していきます。</p>
<p>ClamAV をすでに運用中の場合は、別のディレクトリで編集し、あとで設定ファイルを置き換えます。</p>
<p>最終的に設定した freshclam.conf は以下の通りです。</p>
<p>※ 実運用環境での使用を想定していないため意図的にセキュリティレベルを低下させていたり、パフォーマンス影響の大きい設定を有効化していたりします。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment">##</span>
<span class="token comment">## freshclam.conf - automatically generated by clamconf 1.2.0</span>
<span class="token comment">##</span>

<span class="token comment"># Maximum size of the log file.</span>
<span class="token comment"># Value of 0 disables the limit.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 1048576</span>
LogFileMaxSize 5M

<span class="token comment"># Log time with each message.</span>
<span class="token comment"># Default: no</span>
LogTime <span class="token function">yes</span>

<span class="token comment"># Use the system logger (can work together with LogFile).</span>
<span class="token comment"># Default: no</span>
LogSyslog <span class="token function">yes</span>

<span class="token comment"># Type of syslog messages.</span>
<span class="token comment"># Please refer to 'man syslog' for the facility names.</span>
<span class="token comment"># Default: LOG_LOCAL6</span>
<span class="token comment">#LogFacility LOG_MAIL</span>

<span class="token comment"># Enable verbose logging.</span>
<span class="token comment"># Default: no</span>
LogVerbose <span class="token function">yes</span>

<span class="token comment"># Rotate log file. Requires LogFileMaxSize option set prior to this option.</span>
<span class="token comment"># Default: no</span>
LogRotate <span class="token function">yes</span>

<span class="token comment"># Save the process ID to a file.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment"># PidFile /run/clamav/clam.pid</span>

<span class="token comment"># This option allows you to change the default database directory.</span>
<span class="token comment"># If you enable it, please make sure it points to the same directory in</span>
<span class="token comment"># both clamd and freshclam.</span>
<span class="token comment"># Default: /usr/local/share/clamav</span>
<span class="token comment">#DatabaseDirectory /var/lib/clamav</span>

<span class="token comment"># Don't fork into background.</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#Foreground no</span>

<span class="token comment"># Enable debug messages in libclamav.</span>
<span class="token comment"># Default: no</span>
Debug <span class="token function">yes</span>

<span class="token comment"># Save all reports to a log file.</span>
<span class="token comment"># Default: disabled</span>
UpdateLogFile /var/log/freshclam.log

<span class="token comment"># When started by root freshclam will drop privileges and switch to the user</span>
<span class="token comment"># defined in this option.</span>
<span class="token comment"># Default: clamav</span>
<span class="token comment">#DatabaseOwner clamav</span>

<span class="token comment"># This option defined how many times daily freshclam should check for</span>
<span class="token comment"># a database update.</span>
<span class="token comment"># Default: 12</span>
Checks <span class="token number">1</span>

<span class="token comment"># Use DNS to verify the virus database version. FreshClam uses DNS TXT records</span>
<span class="token comment"># to verify the versions of the database and software itself. With this</span>
<span class="token comment"># directive you can change the database verification domain.</span>
<span class="token comment"># WARNING: Please don't change it unless you're configuring freshclam to use</span>
<span class="token comment"># your own database verification domain.</span>
<span class="token comment"># Default: current.cvd.clamav.net</span>
DNSDatabaseInfo current.cvd.clamav.net

<span class="token comment"># DatabaseMirror specifies to which mirror(s) freshclam should connect.</span>
<span class="token comment"># You should have at least one entry: database.clamav.net.</span>
<span class="token comment"># Default: disabled</span>
DatabaseMirror database.clamav.net

<span class="token comment"># This option allows you to easily point freshclam to private mirrors.</span>
<span class="token comment"># If PrivateMirror is set, freshclam does not attempt to use DNS</span>
<span class="token comment"># to determine whether its databases are out-of-date, instead it will</span>
<span class="token comment"># use the If-Modified-Since request or directly check the headers of the</span>
<span class="token comment"># remote database files. For each database, freshclam first attempts</span>
<span class="token comment"># to download the CLD file. If that fails, it tries to download the</span>
<span class="token comment"># CVD file. This option overrides DatabaseMirror, DNSDatabaseInfo</span>
<span class="token comment"># and Scripted Updates. It can be used multiple times to provide</span>
<span class="token comment"># fall-back mirrors.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#PrivateMirror mirror1.mynetwork.com</span>
<span class="token comment">#PrivateMirror mirror2.mynetwork.com</span>

<span class="token comment"># This option defines how many attempts freshclam should make before giving up.</span>
<span class="token comment"># Default: 3</span>
<span class="token comment">#MaxAttempts 5</span>

<span class="token comment"># With this option you can control scripted updates. It's highly recommended to keep them enabled.</span>
<span class="token comment"># Default: yes</span>
<span class="token comment">#ScriptedUpdates yes</span>

<span class="token comment"># With this option enabled, freshclam will attempt to load new</span>
<span class="token comment"># databases into memory to make sure they are properly handled</span>
<span class="token comment"># by libclamav before replacing the old ones. Tip: This feature uses a lot of RAM. If your system has limited RAM and you are actively running ClamD or ClamScan during the update, then you may need to set `TestDatabases no`.</span>
<span class="token comment"># Default: yes</span>
<span class="token comment">#TestDatabases yes</span>

<span class="token comment"># By default freshclam will keep the local databases (.cld) uncompressed to</span>
<span class="token comment"># make their handling faster. With this option you can enable the compression.</span>
<span class="token comment"># The change will take effect with the next database update.</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#CompressLocalDatabase </span>

<span class="token comment"># Include an optional signature databases (opt-in). This option can be used multiple times.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#ExtraDatabase dbname1</span>
<span class="token comment">#ExtraDatabase dbname2</span>

<span class="token comment"># Exclude a standard signature database (opt-out). This option can be used multiple times.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#ExcludeDatabase dbname1</span>
<span class="token comment">#ExcludeDatabase dbname2</span>

<span class="token comment"># With this option you can provide custom sources (http:// or file://) for database files.</span>
<span class="token comment"># This option can be used multiple times.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#DatabaseCustomURL http://myserver.com/mysigs.ndb</span>
<span class="token comment">#DatabaseCustomURL file:///mnt/nfs/local.hdb</span>

<span class="token comment"># If you're behind a proxy, please enter its address here.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#HTTPProxyServer your-proxy</span>

<span class="token comment"># HTTP proxy's port</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#HTTPProxyPort 8080</span>

<span class="token comment"># A user name for the HTTP proxy authentication.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#HTTPProxyUsername username</span>

<span class="token comment"># A password for the HTTP proxy authentication.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#HTTPProxyPassword pass</span>

<span class="token comment"># If your servers are behind a firewall/proxy which does a User-Agent</span>
<span class="token comment"># filtering you can use this option to force the use of a different</span>
<span class="token comment"># User-Agent header.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#HTTPUserAgent default</span>

<span class="token comment"># Send the RELOAD command to clamd after a successful update.</span>
<span class="token comment"># Default: /usr/local/etc/clamd.conf</span>
<span class="token comment">#NotifyClamd yes</span>

<span class="token comment"># Run a command after a successful database update. Use EXIT_1 to return 1 after successful database update.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#OnUpdateExecute command</span>

<span class="token comment"># Run a command when a database update error occurs.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#OnErrorExecute command</span>

<span class="token comment"># Run a command when freshclam reports an outdated version.</span>
<span class="token comment"># In the command string %v will be replaced with the new version number.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#OnOutdatedExecute command</span>

<span class="token comment"># With this option you can provide a client address for the database downloading.</span>
<span class="token comment"># Useful for multi-homed systems.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#LocalIPAddress aaa.bbb.ccc.ddd</span>

<span class="token comment"># Timeout in seconds when connecting to database server.</span>
<span class="token comment"># Default: 30</span>
<span class="token comment">#ConnectTimeout 30</span>

<span class="token comment"># Timeout in seconds when reading from database server. 0 means no timeout.</span>
<span class="token comment"># Default: 60</span>
<span class="token comment">#ReceiveTimeout 60</span>

<span class="token comment"># This option enables downloading of bytecode.cvd, which includes additional</span>
<span class="token comment"># detection mechanisms and improvements to the ClamAV engine.</span>
<span class="token comment"># Default: yes</span>
<span class="token comment">#Bytecode yes</span></code></pre></div>
<p>設定ファイルについて上から順に見ていきます。</p>
<p>まず、先頭行にある <code class="language-text">Example</code> という文字は必ず削除する必要があります。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Comment out or remove the line below.</span>
Example</code></pre></div>
<p>次に、ログファイルの最大サイズを 5 MB に変更し、LogTime と LogSyslog 、そして LogVerbose に LogRotate を有効化します。</p>
<p>LogFacility についてはデフォルトの LOG_LOCAL6 のままでよいので変更しません。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Maximum size of the log file.</span>
<span class="token comment"># Value of 0 disables the limit.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 1048576</span>
LogFileMaxSize 5M

<span class="token comment"># Log time with each message.</span>
<span class="token comment"># Default: no</span>
LogTime <span class="token function">yes</span>

<span class="token comment"># Use the system logger (can work together with LogFile).</span>
<span class="token comment"># Default: no</span>
LogSyslog <span class="token function">yes</span>

<span class="token comment"># Enable verbose logging.</span>
<span class="token comment"># Default: no</span>
LogVerbose <span class="token function">yes</span>

<span class="token comment"># Rotate log file. Requires LogFileMaxSize option set prior to this option.</span>
<span class="token comment"># Default: no</span>
LogRotate <span class="token function">yes</span></code></pre></div>
<p>PidFile は有効化し、パスを <code class="language-text">/run/clamav/clam.pid</code> に設定します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Save the process ID to a file.</span>
<span class="token comment"># Default: disabled</span>
PidFile /run/clamav/clam.pid</code></pre></div>
<p>DatabaseDirectory は既定値の <code class="language-text">/usr/local/share/clamav</code> を使用します。</p>
<p>このディレクトリを変更する場合は、サービスアカウント clamav に割り当てるディレクトリを追加する必要があります。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># This option allows you to change the default database directory.</span>
<span class="token comment"># If you enable it, please make sure it points to the same directory in</span>
<span class="token comment"># both clamd and freshclam.</span>
<span class="token comment"># Default: /usr/local/share/clamav</span>
<span class="token comment">#DatabaseDirectory /var/lib/clamav</span></code></pre></div>
<p>libclamav のデバッグメッセージを有効化します。</p>
<p>また、freshclam.log にログを出力するように設定します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Enable debug messages in libclamav.</span>
<span class="token comment"># Default: no</span>
Debug <span class="token function">yes</span>

<span class="token comment"># Save all reports to a log file.</span>
<span class="token comment"># Default: disabled</span>
UpdateLogFile /var/log/freshclam.log</code></pre></div>
<p>DatabaseOwner は既定値の clamav から変更しません。</p>
<p>シグネチャデータベースの更新頻度はとりあえず 1 時間にしておきます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># When started by root freshclam will drop privileges and switch to the user</span>
<span class="token comment"># defined in this option.</span>
<span class="token comment"># Default: clamav</span>
<span class="token comment">#DatabaseOwner clamav</span>

<span class="token comment"># This option defined how many times daily freshclam should check for</span>
<span class="token comment"># a database update.</span>
<span class="token comment"># Default: 12</span>
Checks <span class="token number">1</span></code></pre></div>
<p>Private Mirror は使用しないので、DatabaseMirror はデフォルトの公式配布元を指定しておきます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Use DNS to verify the virus database version. FreshClam uses DNS TXT records</span>
<span class="token comment"># to verify the versions of the database and software itself. With this</span>
<span class="token comment"># directive you can change the database verification domain.</span>
<span class="token comment"># WARNING: Please don't change it unless you're configuring freshclam to use</span>
<span class="token comment"># your own database verification domain.</span>
<span class="token comment"># Default: current.cvd.clamav.net</span>
DNSDatabaseInfo current.cvd.clamav.net

<span class="token comment"># DatabaseMirror specifies to which mirror(s) freshclam should connect.</span>
<span class="token comment"># You should have at least one entry: database.clamav.net.</span>
<span class="token comment"># Default: disabled</span>
DatabaseMirror database.clamav.net</code></pre></div>
<p>以降の設定はとりあえず既定値のまま使用するので変更しません。</p>
<p>これで flashclam コマンドを実行した際にシグネチャデータベースの更新がかかれば OK です。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e878dae14a361c4ece1093d19ff9a374/2d2d6/image-20240120000027395.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 27.500000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/klEQVQY03WR13KDMBBF+ZW0GRtwo4kqJNExyeT/f+Zmd+3wlDzcUYE9Oit5RWuh+xF6GBGXFSrbwYwzSuvA35pukHXT9TinCh/hWfLmh3gPTpJ9TvteRYV2WmCmGapp0a93uHmVPQZeshxRXtKocFWF5Hi5/Q9kEzbgMJDHlmx/DdOqwSnJcCNQEMU4EOz1GPwNpDwNZzHMao3a9SiNg9KtwBiaNRq5NgIOo4TAyQ7YEz7icbFYjZMUMXy4f1I2Mp2k9W5Z5Roq87Dm/9jq5eCL7R4/gFe77lmwSJvL1zcszceNoOsmj8QPw3dr6FBecxecqCgRxqk8Ft/1lfIDXWbHI1Kv8vEAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/e878dae14a361c4ece1093d19ff9a374/8ac56/image-20240120000027395.webp 240w,
/static/e878dae14a361c4ece1093d19ff9a374/d3be9/image-20240120000027395.webp 480w,
/static/e878dae14a361c4ece1093d19ff9a374/e46b2/image-20240120000027395.webp 960w,
/static/e878dae14a361c4ece1093d19ff9a374/9fb66/image-20240120000027395.webp 1205w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/e878dae14a361c4ece1093d19ff9a374/8ff5a/image-20240120000027395.png 240w,
/static/e878dae14a361c4ece1093d19ff9a374/e85cb/image-20240120000027395.png 480w,
/static/e878dae14a361c4ece1093d19ff9a374/d9199/image-20240120000027395.png 960w,
/static/e878dae14a361c4ece1093d19ff9a374/2d2d6/image-20240120000027395.png 1205w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/e878dae14a361c4ece1093d19ff9a374/d9199/image-20240120000027395.png"
            alt="image-20240120000027395"
            title="image-20240120000027395"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>更新が完了した場合、DatabaseDirectory で設定したパス(既定では <code class="language-text">/usr/local/share/clamav</code>) にcvd ファイルが書き込まれます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 595px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/238e4d9ccafeeff926cd184410184242/3dd3e/image-20240120153130319.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGElEQVQY0z2QWXLDIBBEdZbETlnR7kUbEgIkEBZy7CpX7n+UzsBHPqYoYOb1dEeTtuB6hdl2cKlQ1Q1uPUPNBlRNh2s/gskFVdvjVFSIyzOOSYZTmiHOciRFiS+6f8QpPr9TRPbxQi9mKoV24JDaoB8ntL64xCHJUdYt9OYwzgbjYrBYi1HNiPMygA8E+gd62LljSC91GFzuG9gk0ZHAoHQASmPx/n3DOAdpN8yrhfDCk0DHBS4tQ3ZtCJghamm4IFBcXsjSGdr90AaObM5Y9xdZZbSZhjIrBIEl/Rm3Q98dlnXD+nhCkUgzChzTAtGNceS3JsA8VFKT34iTNZ9vPUzoJkXvd5j9GeIRBPdnPYgQVUM9SXUNwD8RUKkgHvMOqQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/238e4d9ccafeeff926cd184410184242/8ac56/image-20240120153130319.webp 240w,
/static/238e4d9ccafeeff926cd184410184242/d3be9/image-20240120153130319.webp 480w,
/static/238e4d9ccafeeff926cd184410184242/536c8/image-20240120153130319.webp 595w"
              sizes="(max-width: 595px) 100vw, 595px"
              type="image/webp"
            />
          <source
            srcset="/static/238e4d9ccafeeff926cd184410184242/8ff5a/image-20240120153130319.png 240w,
/static/238e4d9ccafeeff926cd184410184242/e85cb/image-20240120153130319.png 480w,
/static/238e4d9ccafeeff926cd184410184242/3dd3e/image-20240120153130319.png 595w"
            sizes="(max-width: 595px) 100vw, 595px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/238e4d9ccafeeff926cd184410184242/3dd3e/image-20240120153130319.png"
            alt="image-20240120153130319"
            title="image-20240120153130319"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>freshclam による更新をデーモンとして実行する場合、<code class="language-text">freshclam -d</code> コマンドを発行します。</p>
<p>例えば、1 日に 10 回の更新チェックを指定する場合は <code class="language-text">freshclam -d -c 10</code> を実行して freshclam デーモンを起動します。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 707px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/325724517fde1a0ed03a8b541eee1780/394f7/image-20240120152820239.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 12.916666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsklEQVQI1x2O6Y6CQBCEeRvdmJVjgcAAg3OhzKirie//Kp+d+VHpo6qrugjxzi3dSc8X6f/F9ngyW4f2G35PeOHdHgWJIDp1cbTjhHaeQRvKbuBPzZT9QCu1UKvhIsc2bKwu4G+RelScmg5zjYzCK+PEyNLPWsyEKyt+64ZT1XAs64zDueJH5sKKQZD0KJ856XepylgRNaT3J+/ObZ8/CTExG5NNp3VlWCRALbTTQpeh+QKJK2eSa1ck+wAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/325724517fde1a0ed03a8b541eee1780/8ac56/image-20240120152820239.webp 240w,
/static/325724517fde1a0ed03a8b541eee1780/d3be9/image-20240120152820239.webp 480w,
/static/325724517fde1a0ed03a8b541eee1780/b71d6/image-20240120152820239.webp 707w"
              sizes="(max-width: 707px) 100vw, 707px"
              type="image/webp"
            />
          <source
            srcset="/static/325724517fde1a0ed03a8b541eee1780/8ff5a/image-20240120152820239.png 240w,
/static/325724517fde1a0ed03a8b541eee1780/e85cb/image-20240120152820239.png 480w,
/static/325724517fde1a0ed03a8b541eee1780/394f7/image-20240120152820239.png 707w"
            sizes="(max-width: 707px) 100vw, 707px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/325724517fde1a0ed03a8b541eee1780/394f7/image-20240120152820239.png"
            alt="image-20240120152820239"
            title="image-20240120152820239"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>または、cron などによって <code class="language-text">/usr/local/bin/freshclam --quiet</code> コマンドを発行するように構成することでも自動更新を構成することが可能です。</p>
<p>参考：<a href="https://docs.clamav.net/manual/Usage/Configuration.html#freshclamconf" target="_blank" rel="nofollow noopener noreferrer">Configuration - ClamAV Documentation</a></p>
<h3 id="clamdconf-を編集する" style="position:relative;"><a href="#clamdconf-%E3%82%92%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B" aria-label="clamdconf を編集する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>clamd.conf を編集する</h3>
<p>次に、<code class="language-text">/usr/local/etc/clamd.conf</code> を編集していきます。</p>
<p>最終的に使用する構成ファイルは以下の通りです。</p>
<p>※ 実運用環境での使用を想定していないため意図的にセキュリティレベルを低下させていたり、パフォーマンス影響の大きい設定を有効化していたりします。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment">##</span>
<span class="token comment">## clamd.conf - automatically generated by clamconf 1.2.0</span>
<span class="token comment">##</span>

<span class="token comment"># Default: no</span>
<span class="token comment">#AlertExceedsMax</span>

<span class="token comment"># Number of entries the cache can store.</span>
<span class="token comment"># Default: 65536</span>
<span class="token comment"># CacheSize 65536</span>

<span class="token comment"># Enable prelude</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#PreludeEnable </span>

<span class="token comment"># Name of the analyzer as seen in prewikka</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#PreludeAnalyzerName </span>

<span class="token comment"># Save all reports to a log file.</span>
<span class="token comment"># Default: disabled</span>
LogFile /var/log/clamav.log

<span class="token comment"># By default the log file is locked for writing and only a single</span>
<span class="token comment"># daemon process can write to it. This option disables the lock.</span>
<span class="token comment"># Default: no</span>
LogFileUnlock <span class="token function">yes</span>

<span class="token comment"># Maximum size of the log file.</span>
<span class="token comment"># Value of 0 disables the limit.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 1048576</span>
LogFileMaxSize 5M

<span class="token comment"># Log time with each message.</span>
<span class="token comment"># Default: no</span>
LogTime <span class="token function">yes</span>

<span class="token comment"># Log all clean files.</span>
<span class="token comment"># Useful in debugging but drastically increases the log size.</span>
<span class="token comment"># Default: no</span>
LogClean no

<span class="token comment"># Use the system logger (can work together with LogFile).</span>
<span class="token comment"># Default: no</span>
LogSyslog <span class="token function">yes</span>

<span class="token comment"># Type of syslog messages.</span>
<span class="token comment"># Please refer to 'man syslog' for the facility names.</span>
<span class="token comment"># Default: LOG_LOCAL6</span>
<span class="token comment">#LogFacility LOG_MAIL</span>

<span class="token comment"># Enable verbose logging.</span>
<span class="token comment"># Default: no</span>
LogVerbose <span class="token function">yes</span>

<span class="token comment"># Rotate log file. Requires LogFileMaxSize option set prior to this option.</span>
<span class="token comment"># Default: no</span>
LogRotate <span class="token function">yes</span>

<span class="token comment"># Log additional information about the infected file, such as its</span>
<span class="token comment"># size and hash, together with the virus name.</span>
<span class="token comment"># Default: no</span>
ExtendedDetectionInfo <span class="token function">yes</span>

<span class="token comment"># Save the process ID to a file.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment"># PidFile /run/clamav/clam.pid</span>

<span class="token comment"># This option allows you to change the default temporary directory.</span>
<span class="token comment"># Default: disabled</span>
TemporaryDirectory /tmp

<span class="token comment"># This option allows you to change the default database directory.</span>
<span class="token comment"># If you enable it, please make sure it points to the same directory in</span>
<span class="token comment"># both clamd and freshclam.</span>
<span class="token comment"># Default: /usr/local/share/clamav</span>
DatabaseDirectory /usr/local/share/clamav

<span class="token comment"># Only load the official signatures published by the ClamAV project.</span>
<span class="token comment"># Default: no</span>
OfficialDatabaseOnly no

<span class="token comment"># Return with a nonzero error code if the virus database is older than the specified number of days.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#FailIfCvdOlderThan -1</span>

<span class="token comment"># Path to a local socket file the daemon will listen on.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#LocalSocket /run/clamav/clamd.sock</span>

<span class="token comment"># Sets the group ownership on the unix socket.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#LocalSocketGroup virusgroup</span>

<span class="token comment"># Sets the permissions on the unix socket to the specified mode.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#LocalSocketMode 660</span>

<span class="token comment"># Remove a stale socket after unclean shutdown</span>
<span class="token comment"># Default: yes</span>
<span class="token comment">#FixStaleSocket yes</span>

<span class="token comment"># A TCP port number the daemon will listen on.</span>
<span class="token comment"># Default: disabled</span>
TCPSocket <span class="token number">3310</span>

<span class="token comment"># By default clamd binds to INADDR_ANY.</span>
<span class="token comment"># This option allows you to restrict the TCP address and provide</span>
<span class="token comment"># some degree of protection from the outside world.</span>
<span class="token comment"># Default: disabled</span>
TCPAddr <span class="token number">127.0</span>.0.1

<span class="token comment"># Maximum length the queue of pending connections may grow to.</span>
<span class="token comment"># Default: 200</span>
MaxConnectionQueueLength <span class="token number">200</span>

<span class="token comment"># Close the STREAM session when the data size limit is exceeded.</span>
<span class="token comment"># The value should match your MTA's limit for the maximum attachment size.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 104857600</span>
StreamMaxLength 100M

<span class="token comment"># The STREAM command uses an FTP-like protocol.</span>
<span class="token comment"># This option sets the lower boundary for the port range.</span>
<span class="token comment"># Default: 1024</span>
StreamMinPort <span class="token number">1024</span>

<span class="token comment"># This option sets the upper boundary for the port range.</span>
<span class="token comment"># Default: 2048</span>
StreamMaxPort <span class="token number">2048</span>

<span class="token comment"># Maximum number of threads running at the same time.</span>
<span class="token comment"># Default: 10</span>
MaxThreads <span class="token number">20</span>

<span class="token comment"># This option specifies the time (in seconds) after which clamd should</span>
<span class="token comment"># timeout if a client doesn't provide any data.</span>
<span class="token comment"># Default: 120</span>
ReadTimeout <span class="token number">120</span>

<span class="token comment"># This option specifies the time (in seconds) after which clamd should</span>
<span class="token comment"># timeout if a client doesn't provide any initial command after connecting.</span>
<span class="token comment"># Default: 30</span>
CommandReadTimeout <span class="token number">30</span>

<span class="token comment"># This option specifies how long to wait (in milliseconds) if the send buffer</span>
<span class="token comment"># is full. Keep this value low to prevent clamd hanging.</span>
<span class="token comment"># Default: 500</span>
SendBufTimeout <span class="token number">200</span>

<span class="token comment"># Maximum number of queued items (including those being processed by MaxThreads</span>
<span class="token comment"># threads). It is recommended to have this value at least twice MaxThreads</span>
<span class="token comment"># if possible.</span>
<span class="token comment"># WARNING: you shouldn't increase this too much to avoid running out of file</span>
<span class="token comment">#  descriptors, the following condition should hold:</span>
<span class="token comment">#  MaxThreads*MaxRecursion + MaxQueue - MaxThreads  + 6 &lt; RLIMIT_NOFILE</span>
<span class="token comment">#  (usual max for RLIMIT_NOFILE is 1024)</span>
<span class="token comment"># </span>
<span class="token comment"># Default: 100</span>
MaxQueue <span class="token number">200</span>

<span class="token comment"># This option specifies how long (in seconds) the process should wait</span>
<span class="token comment"># for a new job.</span>
<span class="token comment"># Default: 30</span>
IdleTimeout <span class="token number">60</span>

<span class="token comment"># Don't scan files/directories whose names match the provided</span>
<span class="token comment"># regular expression. This option can be specified multiple times.</span>
<span class="token comment"># Default: disabled</span>
ExcludePath ^/proc/
ExcludePath ^/sys/
ExcludePath ^/run/

<span class="token comment"># Maximum depth the directories are scanned at.</span>
<span class="token comment"># Default: 15</span>
MaxDirectoryRecursion <span class="token number">15</span>

<span class="token comment"># Follow directory symlinks.</span>
<span class="token comment"># Default: no</span>
FollowDirectorySymlinks <span class="token function">yes</span>

<span class="token comment"># Follow symlinks to regular files.</span>
<span class="token comment"># Default: no</span>
FollowFileSymlinks <span class="token function">yes</span>

<span class="token comment"># Scan files and directories on other filesystems.</span>
<span class="token comment"># Default: yes</span>
CrossFilesystems <span class="token function">yes</span>

<span class="token comment"># This option specifies the time intervals (in seconds) in which clamd</span>
<span class="token comment"># should perform a database check.</span>
<span class="token comment"># Default: 600</span>
SelfCheck <span class="token number">600</span>

<span class="token comment"># Enable non-blocking (multi-threaded/concurrent) database reloads. This feature </span>
<span class="token comment"># will temporarily load a second scanning engine while scanning continues using </span>
<span class="token comment"># the first engine. Once loaded, the new engine takes over. The old engine is </span>
<span class="token comment"># removed as soon as all scans using the old engine have completed. This feature </span>
<span class="token comment"># requires more RAM, so this option is provided in case users are willing to </span>
<span class="token comment"># block scans during reload in exchange for lower RAM requirements.</span>
<span class="token comment"># Default: yes</span>
<span class="token comment">#ConcurrentDatabaseReload yes</span>

<span class="token comment"># This option allows you to disable clamd's caching feature.</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#DisableCache no</span>

<span class="token comment"># Execute a command when a virus is found. In the command string %v will be</span>
<span class="token comment"># replaced with the virus name and %f will be replaced with the file name.</span>
<span class="token comment"># Additionally, two environment variables will be defined: $CLAM_VIRUSEVENT_FILENAME</span>
<span class="token comment"># and $CLAM_VIRUSEVENT_VIRUSNAME.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#VirusEvent /usr/bin/mailx -s "ClamAV VIRUS ALERT: %v" alert &lt; /dev/null</span>
VirusEvent /etc/clamav/virus-event.bash

<span class="token comment"># Stop the daemon when libclamav reports an out of memory condition.</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#ExitOnOOM yes</span>

<span class="token comment"># Permit use of the ALLMATCHSCAN command.</span>
<span class="token comment"># Default: yes</span>
<span class="token comment">#AllowAllMatchScan yes</span>

<span class="token comment"># Don't fork into background.</span>
<span class="token comment"># Default: no</span>
Foreground <span class="token function">yes</span>

<span class="token comment"># Enable debug messages in libclamav.</span>
<span class="token comment"># Default: no</span>
Debug <span class="token function">yes</span>

<span class="token comment"># Don't remove temporary files (for debugging purposes).</span>
<span class="token comment"># Default: no</span>
LeaveTemporaryFiles no

<span class="token comment"># Record metadata about the file being scanned.</span>
<span class="token comment"># Scan metadata is useful for file analysis purposes and for debugging scan behavior.</span>
<span class="token comment"># The JSON metadata will be printed after the scan is complete if Debug is enabled.</span>
<span class="token comment"># A metadata.json file will be written to the scan temp directory if LeaveTemporaryFiles is enabled.</span>
<span class="token comment"># Default: no</span>
GenerateMetadataJson <span class="token function">yes</span>

<span class="token comment"># Run the daemon as a specified user (the process must be started by root).</span>
<span class="token comment"># Default: disabled</span>
User clamav

<span class="token comment"># With this option enabled ClamAV will load bytecode from the database. It is highly recommended you keep this option on, otherwise you'll miss detections for many new viruses.</span>
<span class="token comment"># Default: yes</span>
Bytecode <span class="token function">yes</span>

<span class="token comment"># Set bytecode security level.</span>
<span class="token comment"># Possible values:</span>
<span class="token comment"># 	TrustSigned - trust bytecode loaded from signed .c[lv]d files,</span>
<span class="token comment"># 		 insert runtime safety checks for bytecode loaded from other sources</span>
<span class="token comment"># 	Paranoid - don't trust any bytecode, insert runtime checks for all</span>
<span class="token comment"># Recommended: TrustSigned, because bytecode in .cvd files already has these checks.</span>
<span class="token comment"># Default: TrustSigned</span>
BytecodeSecurity Paranoid

<span class="token comment"># Set bytecode timeout in milliseconds.</span>
<span class="token comment"># Default: 10000</span>
BytecodeTimeout <span class="token number">10000</span>

<span class="token comment"># Allow loading bytecode from outside digitally signed .c[lv]d files.</span>
<span class="token comment"># Default: no</span>
BytecodeUnsigned <span class="token function">yes</span>

<span class="token comment"># Set bytecode execution mode.</span>
<span class="token comment"># Possible values:</span>
<span class="token comment"># 	Auto - automatically choose JIT if possible, fallback to interpreter</span>
<span class="token comment"># ForceJIT - always choose JIT, fail if not possible</span>
<span class="token comment"># ForceInterpreter - always choose interpreter</span>
<span class="token comment"># Test - run with both JIT and interpreter and compare results. Make all failures fatal.</span>
<span class="token comment"># Default: Auto</span>
BytecodeMode Auto

<span class="token comment"># Detect Potentially Unwanted Applications.</span>
<span class="token comment"># Default: no</span>
DetectPUA <span class="token function">yes</span>

<span class="token comment"># Exclude a specific PUA category. This directive can be used multiple times.</span>
<span class="token comment"># See https://docs.clamav.net/faq/faq-pua.html for the complete list of PUA</span>
<span class="token comment"># categories.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#ExcludePUA NetTool</span>
<span class="token comment">#ExcludePUA PWTool</span>

<span class="token comment"># Only include a specific PUA category. This directive can be used multiple</span>
<span class="token comment"># times.</span>
<span class="token comment"># Default: disabled</span>
IncludePUA Spy
IncludePUA Scanner
IncludePUA RAT
IncludePUA NetTool
IncludePUA PWTool

<span class="token comment"># PE stands for Portable Executable - it's an executable file format used</span>
<span class="token comment"># in all 32- and 64-bit versions of Windows operating systems. This option</span>
<span class="token comment"># allows ClamAV to perform a deeper analysis of executable files and it's also</span>
<span class="token comment"># required for decompression of popular executable packers such as UPX or FSG.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanPE <span class="token function">yes</span>

<span class="token comment"># Executable and Linking Format is a standard format for UN*X executables.</span>
<span class="token comment"># This option allows you to control the scanning of ELF files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanELF <span class="token function">yes</span>

<span class="token comment"># Enable the built in email scanner.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without parsing individual messages/attachments.</span>
<span class="token comment"># Default: yes</span>
ScanMail no

<span class="token comment"># Scan RFC1341 messages split over many emails. You will need to</span>
<span class="token comment"># periodically clean up $TemporaryDirectory/clamav-partial directory.</span>
<span class="token comment"># WARNING: This option may open your system to a DoS attack. Please don't use</span>
<span class="token comment"># this feature on highly loaded servers.</span>
<span class="token comment"># Default: no</span>
ScanPartialMessages no

<span class="token comment"># With this option enabled ClamAV will try to detect phishing attempts by using</span>
<span class="token comment"># signatures.</span>
<span class="token comment"># Default: yes</span>
PhishingSignatures <span class="token function">yes</span>

<span class="token comment"># Scan URLs found in mails for phishing attempts using heuristics.</span>
<span class="token comment"># Default: yes</span>
PhishingScanURLs <span class="token function">yes</span>

<span class="token comment"># In some cases (eg. complex malware, exploits in graphic files, and others),</span>
<span class="token comment"># ClamAV uses special algorithms to provide accurate detection. This option</span>
<span class="token comment"># controls the algorithmic detection.</span>
<span class="token comment"># Default: yes</span>
HeuristicAlerts <span class="token function">yes</span>

<span class="token comment"># Allow heuristic match to take precedence.</span>
<span class="token comment"># When enabled, if a heuristic scan (such as phishingScan) detects</span>
<span class="token comment"># a possible virus/phish it will stop scan immediately. Recommended, saves CPU</span>
<span class="token comment"># scan-time.</span>
<span class="token comment"># When disabled, virus/phish detected by heuristic scans will be reported only</span>
<span class="token comment"># at the end of a scan. If an archive contains both a heuristically detected</span>
<span class="token comment"># virus/phish, and a real malware, the real malware will be reported.</span>
<span class="token comment"># Keep this disabled if you intend to handle "Heuristics.*" viruses</span>
<span class="token comment"># differently from "real" malware.</span>
<span class="token comment"># If a non-heuristically-detected virus (signature-based) is found first,</span>
<span class="token comment"># the scan is interrupted immediately, regardless of this config option.</span>
<span class="token comment"># Default: no</span>
HeuristicScanPrecedence <span class="token function">yes</span>

<span class="token comment"># Enable the Data Loss Prevention module.</span>
<span class="token comment"># Default: no</span>
StructuredDataDetection <span class="token function">yes</span>

<span class="token comment"># This option sets the lowest number of Credit Card numbers found in a file</span>
<span class="token comment"># to generate a detect.</span>
<span class="token comment"># Default: 3</span>
<span class="token comment">#StructuredMinCreditCardCount 5</span>

<span class="token comment"># This option sets the lowest number of Social Security Numbers found</span>
<span class="token comment"># in a file to generate a detect.</span>
<span class="token comment"># Default: 3</span>
<span class="token comment">#StructuredMinSSNCount 5</span>

<span class="token comment"># With this option enabled the DLP module will search for valid</span>
<span class="token comment"># SSNs formatted as xxx-yy-zzzz.</span>
<span class="token comment"># Default: yes</span>
<span class="token comment">#StructuredSSNFormatNormal yes</span>

<span class="token comment"># With this option enabled the DLP module will search for valid</span>
<span class="token comment"># SSNs formatted as xxxyyzzzz</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#StructuredSSNFormatStripped no</span>

<span class="token comment"># Perform HTML/JavaScript/ScriptEncoder normalisation and decryption.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanHTML <span class="token function">yes</span>

<span class="token comment"># This option enables scanning of OLE2 files, such as Microsoft Office</span>
<span class="token comment"># documents and .msi files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanOLE2 <span class="token function">yes</span>

<span class="token comment"># With this option enabled clamav will try to detect broken executables</span>
<span class="token comment"># (PE, ELF, &amp; Mach-O) and alert on them with a Broken.Executable heuristic signature.</span>
<span class="token comment"># Default: no</span>
AlertBrokenExecutables <span class="token function">yes</span>

<span class="token comment"># With this option enabled clamav will try to detect broken media files</span>
<span class="token comment"># (JPEG, TIFF, PNG, GIF) and alert on them with a Broken.Media heuristic signature.</span>
<span class="token comment"># Default: no</span>
AlertBrokenMedia <span class="token function">yes</span>

<span class="token comment"># Alert on encrypted archives and documents (encrypted .zip, .7zip, .rar, .pdf).</span>
<span class="token comment"># Default: no</span>
AlertEncrypted <span class="token function">yes</span>

<span class="token comment"># With this option enabled the DLP module will search for valid Credit Card</span>
<span class="token comment"># numbers only. Debit and Private Label cards will not be searched.</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#StructuredCCOnly no</span>

<span class="token comment"># Alert on encrypted archives (encrypted .zip, .7zip, .rar).</span>
<span class="token comment"># Default: no</span>
AlertEncryptedArchive <span class="token function">yes</span>

<span class="token comment"># Alert on encrypted documents (encrypted .pdf).</span>
<span class="token comment"># Default: no</span>
AlertEncryptedDoc <span class="token function">yes</span>

<span class="token comment"># With this option enabled OLE2 files with VBA macros, which were not</span>
<span class="token comment"># detected by signatures will be marked as "Heuristics.OLE2.ContainsMacros".</span>
<span class="token comment"># Default: no</span>
AlertOLE2Macros <span class="token function">yes</span>

<span class="token comment"># Alert on SSL mismatches in URLs, even if they're not in the database.</span>
<span class="token comment"># This feature can lead to false positives.</span>
<span class="token comment"># Default: no</span>
AlertPhishingSSLMismatch <span class="token function">yes</span>

<span class="token comment"># Alert on cloaked URLs, even if they're not in the database.</span>
<span class="token comment"># This feature can lead to false positives.</span>
<span class="token comment"># Default: no</span>
AlertPhishingCloak <span class="token function">yes</span>

<span class="token comment"># Alert on raw DMG image files containing partition intersections.</span>
<span class="token comment"># Default: no</span>
AlertPartitionIntersection <span class="token function">yes</span>

<span class="token comment"># This option enables scanning within PDF files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without decoding and additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanPDF <span class="token function">yes</span>

<span class="token comment"># This option enables scanning within SWF files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without decoding and additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanSWF <span class="token function">yes</span>

<span class="token comment"># This option enables scanning xml-based document files supported by libclamav.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanXMLDOCS <span class="token function">yes</span>

<span class="token comment"># This option enables scanning HWP3 files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanHWP3 <span class="token function">yes</span>

<span class="token comment"># Scan within archives and compressed files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without unpacking and additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanArchive <span class="token function">yes</span>

<span class="token comment"># This option causes memory or nested map scans to dump the content to disk.</span>
<span class="token comment"># If you turn on this option, more data is written to disk and is available</span>
<span class="token comment"># when the leave-temps option is enabled at the cost of more disk writes.</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#ForceToDisk no</span>

<span class="token comment"># This option sets the maximum amount of time a scan may take to complete.</span>
<span class="token comment"># The value of 0 disables the limit.</span>
<span class="token comment"># WARNING: disabling this limit or setting it too high may result allow scanning</span>
<span class="token comment"># of certain files to lock up the scanning process/threads resulting in a Denial of Service.</span>
<span class="token comment"># The value is in milliseconds.</span>
<span class="token comment"># Default: 0</span>
<span class="token comment">#MaxScanTime 120000</span>

<span class="token comment"># This option sets the maximum amount of data to be scanned for each input file.</span>
<span class="token comment"># Archives and other containers are recursively extracted and scanned up to this</span>
<span class="token comment"># value.</span>
<span class="token comment"># The value of 0 disables the limit.</span>
<span class="token comment"># WARNING: disabling this limit or setting it too high may result in severe</span>
<span class="token comment"># damage.</span>
<span class="token comment"># !!! MaxScanSize: UNKNOWN INTERNAL TYPE !!!</span>
<span class="token comment">#MaxScanSize 400M</span>

<span class="token comment"># Files/messages larger than this limit won't be scanned. Affects the input</span>
<span class="token comment"># file itself as well as files contained inside it (when the input file is</span>
<span class="token comment"># an archive, a document or some other kind of container).</span>
<span class="token comment"># The value of 0 disables the limit.</span>
<span class="token comment"># WARNING: disabling this limit or setting it too high may result in severe</span>
<span class="token comment"># damage to the system.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 104857600</span>
<span class="token comment">#MaxFileSize 100M</span>

<span class="token comment"># Nested archives are scanned recursively, e.g. if a Zip archive contains a RAR</span>
<span class="token comment"># file, all files within it will also be scanned. This option specifies how</span>
<span class="token comment"># deeply the process should be continued.</span>
<span class="token comment"># The value of 0 disables the limit.</span>
<span class="token comment"># WARNING: disabling this limit or setting it too high may result in severe</span>
<span class="token comment"># damage to the system.</span>
<span class="token comment"># Default: 17</span>
<span class="token comment">#MaxRecursion 17</span>

<span class="token comment"># Number of files to be scanned within an archive, a document, or any other</span>
<span class="token comment"># container file.</span>
<span class="token comment"># The value of 0 disables the limit.</span>
<span class="token comment"># WARNING: disabling this limit or setting it too high may result in severe</span>
<span class="token comment"># damage to the system.</span>
<span class="token comment"># Default: 10000</span>
<span class="token comment">#MaxFiles 10000</span>

<span class="token comment"># This option sets the maximum size of a file to check for embedded PE.</span>
<span class="token comment"># Files larger than this value will skip the additional analysis step.</span>
<span class="token comment"># Negative values are not allowed.</span>
<span class="token comment"># WARNING: setting this limit too high may result in severe damage or impact performance.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 41943040</span>
<span class="token comment">#MaxEmbeddedPE 40M</span>

<span class="token comment"># This option sets the maximum size of a HTML file to normalize.</span>
<span class="token comment"># HTML files larger than this value will not be normalized or scanned.</span>
<span class="token comment"># Negative values are not allowed.</span>
<span class="token comment"># WARNING: setting this limit too high may result in severe damage or impact performance.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 41943040</span>
<span class="token comment">#MaxHTMLNormalize 40M</span>

<span class="token comment"># This option sets the maximum size of a normalized HTML file to scan.</span>
<span class="token comment"># HTML files larger than this value after normalization will not be scanned.</span>
<span class="token comment"># Negative values are not allowed.</span>
<span class="token comment"># WARNING: setting this limit too high may result in severe damage or impact performance.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 8388608</span>
<span class="token comment">#MaxHTMLNoTags 8M</span>

<span class="token comment"># This option sets the maximum size of a script file to normalize.</span>
<span class="token comment"># Script content larger than this value will not be normalized or scanned.</span>
<span class="token comment"># Negative values are not allowed.</span>
<span class="token comment"># WARNING: setting this limit too high may result in severe damage or impact performance.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 20971520</span>
<span class="token comment">#MaxScriptNormalize 20M</span>

<span class="token comment"># This option sets the maximum size of a ZIP file to reanalyze type recognition.</span>
<span class="token comment"># ZIP files larger than this value will skip the step to potentially reanalyze as PE.</span>
<span class="token comment"># Negative values are not allowed.</span>
<span class="token comment"># WARNING: setting this limit too high may result in severe damage or impact performance.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 1048576</span>
<span class="token comment">#MaxZipTypeRcg 1M</span>

<span class="token comment"># This option sets the maximum number of partitions of a raw disk image to be scanned.</span>
<span class="token comment"># Raw disk images with more partitions than this value will have up to the value number partitions scanned.</span>
<span class="token comment"># Negative values are not allowed.</span>
<span class="token comment"># WARNING: setting this limit too high may result in severe damage or impact performance.</span>
<span class="token comment"># Default: 50</span>
<span class="token comment">#MaxPartitions 128</span>

<span class="token comment"># This option sets the maximum number of icons within a PE to be scanned.</span>
<span class="token comment"># PE files with more icons than this value will have up to the value number icons scanned.</span>
<span class="token comment"># Negative values are not allowed.</span>
<span class="token comment"># WARNING: setting this limit too high may result in severe damage or impact performance.</span>
<span class="token comment"># Default: 100</span>
<span class="token comment">#MaxIconsPE 100</span>

<span class="token comment"># This option sets the maximum recursive calls to HWP3 parsing function.</span>
<span class="token comment"># HWP3 files using more than this limit will be terminated and alert the user.</span>
<span class="token comment"># Scans will be unable to scan any HWP3 attachments if the recursive limit is reached.</span>
<span class="token comment"># Negative values are not allowed.</span>
<span class="token comment"># WARNING: setting this limit too high may result in severe damage or impact performance.</span>
<span class="token comment"># Default: 16</span>
<span class="token comment">#MaxRecHWP3 16</span>

<span class="token comment"># This option sets the maximum calls to the PCRE match function during an instance of regex matching.</span>
<span class="token comment"># Instances using more than this limit will be terminated and alert the user but the scan will continue.</span>
<span class="token comment"># For more information on match_limit, see the PCRE documentation.</span>
<span class="token comment"># Negative values are not allowed.</span>
<span class="token comment"># WARNING: setting this limit too high may severely impact performance.</span>
<span class="token comment"># Default: 100000</span>
<span class="token comment">#PCREMatchLimit 100000</span>

<span class="token comment"># This option sets the maximum recursive calls to the PCRE match function during an instance of regex matching.</span>
<span class="token comment"># Instances using more than this limit will be terminated and alert the user but the scan will continue.</span>
<span class="token comment"># For more information on match_limit_recursion, see the PCRE documentation.</span>
<span class="token comment"># Negative values are not allowed and values > PCREMatchLimit are superfluous.</span>
<span class="token comment"># WARNING: setting this limit too high may severely impact performance.</span>
<span class="token comment"># Default: 2000</span>
<span class="token comment">#PCRERecMatchLimit 5000</span>

<span class="token comment"># This option sets the maximum filesize for which PCRE subsigs will be executed.</span>
<span class="token comment"># Files exceeding this limit will not have PCRE subsigs executed unless a subsig is encompassed to a smaller buffer.</span>
<span class="token comment"># Negative values are not allowed.</span>
<span class="token comment"># Setting this value to zero disables the limit.</span>
<span class="token comment"># WARNING: setting this limit too high or disabling it may severely impact performance.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 104857600</span>
<span class="token comment">#PCREMaxFileSize 100M</span>

<span class="token comment"># This option specifies a directory or mount point which should be scanned on access. The mount point specified, or the mount point containing the specified directory will be watched, but only notifications will occur. If any directories are specified, this option will preempt the DDD system. It can also be used multiple times.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#OnAccessMountPath /</span>
<span class="token comment"># OnAccessMountPath /home</span>

<span class="token comment"># This option specifies a directory (including all files and directories</span>
<span class="token comment"># inside it), which should be scanned on access. This option can</span>
<span class="token comment"># be used multiple times.</span>
<span class="token comment"># Default: disabled</span>
OnAccessIncludePath /home
<span class="token comment">#OnAccessIncludePath /students</span>

<span class="token comment"># This option allows excluding directories from on-access scanning. It can</span>
<span class="token comment"># be used multiple times. Only works with DDD system.</span>
<span class="token comment"># Default: disabled</span>
OnAccessExcludePath /home/excluded
<span class="token comment">#OnAccessExcludePath /root</span>

<span class="token comment"># Use this option to exclude the root UID (0) and allow any processes run under root to access all watched files without triggering scans.</span>
<span class="token comment"># Default: disabled</span>
OnAccessExcludeRootUID <span class="token function">yes</span>

<span class="token comment"># With this option you can exclude specific UIDs. Processes with these UIDs</span>
<span class="token comment"># will be able to access all files.</span>
<span class="token comment"># This option can be used multiple times (one per line). Using a value of 0 on any line will disable this option entirely. To exclude the root UID please enable the OnAccessExcludeRootUID option.</span>
<span class="token comment"># Default: disabled</span>
OnAccessExcludeUID <span class="token number">0</span>

<span class="token comment"># This option allows exclusions via user names when using the on-access scanning client. It can</span>
<span class="token comment"># be used multiple times.</span>
<span class="token comment"># Default: disabled</span>
OnAccessExcludeUname clamav

<span class="token comment"># Files larger than this value will not be scanned in on access.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 5242880</span>
<span class="token comment">#OnAccessMaxFileSize 5M</span>

<span class="token comment"># This option toggles the dynamic directory determination system for on-access scanning (Linux only).</span>
<span class="token comment"># Default: no</span>
OnAccessDisableDDD no

<span class="token comment"># This option changes fanotify behavior to prevent access attempts on malicious files instead of simply notifying the user (On Access scan only).</span>
<span class="token comment"># Default: no</span>
OnAccessPrevention <span class="token function">yes</span>

<span class="token comment"># Enables extra scanning and notification after catching certain inotify events. Only works with the DDD system enabled.</span>
<span class="token comment"># Default: no</span>
OnAccessExtraScanning <span class="token function">yes</span>

<span class="token comment"># Max amount of time (in milliseconds) that the OnAccess client should spend for every connect, send, and recieve attempt when communicating with clamd via curl (5s default)</span>
<span class="token comment"># Default: 5000</span>
<span class="token comment">#OnAccessCurlTimeout 10000L</span>

<span class="token comment"># Max number of scanning threads to allocate to the OnAccess thread pool at startup--these threads are the ones responsible for creating a connection with the daemon and kicking off scanning after an event has been processed. To prevent clamonacc from consuming all clamd's resources keep this lower than clamd's max threads. Default is 5</span>
<span class="token comment"># Default: 5</span>
<span class="token comment">#OnAccessMaxThreads 10</span>

<span class="token comment"># Number of times the OnAccess client will retry a failed scan due to connection problems (or other issues). Defaults to no retries.</span>
<span class="token comment"># Default: 0</span>
<span class="token comment">#OnAccessRetryAttempts 3</span>

<span class="token comment"># When using prevention, if this option is turned on, any errors that occur during scanning will result in the event attempt being denied. This could potentially lead to unwanted system behaviour with certain configurations, so the client defaults to off and allowing access events in case of error.</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#OnAccessDenyOnError yes</span>

<span class="token comment"># Disable authenticode certificate chain verification in PE files.</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#DisableCertCheck no</span>

<span class="token comment"># Deprecated option to enable heuristic alerts (e.g. "Heuristics.&lt;sig name>")</span>
<span class="token comment"># Default: yes</span>
<span class="token comment">#AlgorithmicDetection no</span>

<span class="token comment"># </span>
<span class="token comment"># Default: no</span>
<span class="token comment">#BlockMax </span>

<span class="token comment"># Deprecated option to alert on SSL mismatches in URLs, even if they're not in the database.</span>
<span class="token comment"># This feature can lead to false positives.</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#PhishingAlwaysBlockSSLMismatch no</span>

<span class="token comment"># Deprecated option to alert on cloaked URLs, even if they're not in the database.</span>
<span class="token comment"># This feature can lead to false positives.</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#PhishingAlwaysBlockCloak no</span>

<span class="token comment"># Deprecated option to alert on raw DMG image files containing partition intersections.</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#PartitionIntersection no</span>

<span class="token comment"># With this option enabled OLE2 files with VBA macros, which were not</span>
<span class="token comment"># detected by signatures will be marked as "Heuristics.OLE2.ContainsMacros".</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#OLE2BlockMacros no</span>

<span class="token comment"># Deprecated option to alert on encrypted archives and documents (encrypted .zip, .7zip, .rar, .pdf).</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#ArchiveBlockEncrypted no</span></code></pre></div>
<p>まずは構成ファイルを有効化するため、<code class="language-text">Example</code> を削除します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Comment out or remove the line below.</span>
Example</code></pre></div>
<p>AlertExceedsMax はデフォルト値の no の設定のまま使用します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Default: no</span>
<span class="token comment">#AlertExceedsMax</span></code></pre></div>
<p>AlertExceedsMax は本記事執筆時点(2024 年 1 月)で有効に動作しない Bug が存在することが Open 中の issue にて言及されています。</p>
<p>参考：<a href="https://github.com/Cisco-Talos/clamav/issues/633" target="_blank" rel="nofollow noopener noreferrer">clamd.conf AlertExceedsMax true not working · Issue #633 · Cisco-Talos/clamav</a></p>
<p>次の CacheSize は一応設定を明示的に追加しますが、デフォルト値をそのまま使用します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Number of entries the cache can store.</span>
<span class="token comment"># Default: 65536</span>
<span class="token comment"># CacheSize 65536</span></code></pre></div>
<p>Prelude SIEM は使用しないので、関連する設定は無効化したままとします。</p>
<p>参考：<a href="https://blog.clamav.net/2018/04/clamav-01000-has-been-released.html" target="_blank" rel="nofollow noopener noreferrer">ClamAV® blog: ClamAV 0.100.0 has been released!</a></p>
<p>ログ関連の設定は以下の通りとしました。</p>
<p>LogFile については <code class="language-text">/var/log/clamav.log</code> にパスを変更しておきます。</p>
<p>そして LogFileUnlock を yes とし、LogFileMaxSize を 5 MB に変更します。</p>
<p>また、LogVerbose と LogRotate 、ExtendedDetectionInfo も有効化しています。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Save all reports to a log file.</span>
<span class="token comment"># Default: disabled</span>
LogFile /var/log/clamav.log

<span class="token comment"># By default the log file is locked for writing and only a single</span>
<span class="token comment"># daemon process can write to it. This option disables the lock.</span>
<span class="token comment"># Default: no</span>
LogFileUnlock <span class="token function">yes</span>

<span class="token comment"># Maximum size of the log file.</span>
<span class="token comment"># Value of 0 disables the limit.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 1048576</span>
LogFileMaxSize 5M

<span class="token comment"># Log time with each message.</span>
<span class="token comment"># Default: no</span>
LogTime <span class="token function">yes</span>

<span class="token comment"># Log all clean files.</span>
<span class="token comment"># Useful in debugging but drastically increases the log size.</span>
<span class="token comment"># Default: no</span>
LogClean no

<span class="token comment"># Use the system logger (can work together with LogFile).</span>
<span class="token comment"># Default: no</span>
LogSyslog <span class="token function">yes</span>

<span class="token comment"># Type of syslog messages.</span>
<span class="token comment"># Please refer to 'man syslog' for the facility names.</span>
<span class="token comment"># Default: LOG_LOCAL6</span>
<span class="token comment">#LogFacility LOG_MAIL</span>

<span class="token comment"># Enable verbose logging.</span>
<span class="token comment"># Default: no</span>
LogVerbose <span class="token function">yes</span>

<span class="token comment"># Rotate log file. Requires LogFileMaxSize option set prior to this option.</span>
<span class="token comment"># Default: no</span>
LogRotate <span class="token function">yes</span>

<span class="token comment"># Log additional information about the infected file, such as its</span>
<span class="token comment"># size and hash, together with the virus name.</span>
<span class="token comment"># Default: no</span>
ExtendedDetectionInfo <span class="token function">yes</span></code></pre></div>
<p>PidFile は一応有効化しておきます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Save the process ID to a file.</span>
<span class="token comment"># Default: disabled</span>
PidFile /run/clamav/clam.pid</code></pre></div>
<p>続く設定はいずれも既定値のままですが、DatabaseDirectory を flashclam で設定した <code class="language-text">/usr/local/share/clamav</code> に指定しています。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># This option allows you to change the default temporary directory.</span>
<span class="token comment"># Default: disabled</span>
TemporaryDirectory /tmp

<span class="token comment"># This option allows you to change the default database directory.</span>
<span class="token comment"># If you enable it, please make sure it points to the same directory in</span>
<span class="token comment"># both clamd and freshclam.</span>
<span class="token comment"># Default: /usr/local/share/clamav</span>
DatabaseDirectory /usr/local/share/clamav

<span class="token comment"># Only load the official signatures published by the ClamAV project.</span>
<span class="token comment"># Default: no</span>
OfficialDatabaseOnly no</code></pre></div>
<p>また、LocalSocket の設定は無効化したまま、TCPSocket  を有効化することにします。</p>
<p>これで、clamd が 127.0.0.1 の 3310 ポートを使用できるようになります。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># A TCP port number the daemon will listen on.</span>
<span class="token comment"># Default: disabled</span>
TCPSocket <span class="token number">3310</span>

<span class="token comment"># By default clamd binds to INADDR_ANY.</span>
<span class="token comment"># This option allows you to restrict the TCP address and provide</span>
<span class="token comment"># some degree of protection from the outside world.</span>
<span class="token comment"># Default: disabled</span>
TCPAddr <span class="token number">127.0</span>.0.1

<span class="token comment"># Maximum length the queue of pending connections may grow to.</span>
<span class="token comment"># Default: 200</span>
MaxConnectionQueueLength <span class="token number">200</span>

<span class="token comment"># Close the STREAM session when the data size limit is exceeded.</span>
<span class="token comment"># The value should match your MTA's limit for the maximum attachment size.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 104857600</span>
StreamMaxLength 100M

<span class="token comment"># The STREAM command uses an FTP-like protocol.</span>
<span class="token comment"># This option sets the lower boundary for the port range.</span>
<span class="token comment"># Default: 1024</span>
StreamMinPort <span class="token number">1024</span>

<span class="token comment"># This option sets the upper boundary for the port range.</span>
<span class="token comment"># Default: 2048</span>
StreamMaxPort <span class="token number">2048</span>

<span class="token comment"># Maximum number of threads running at the same time.</span>
<span class="token comment"># Default: 10</span>
MaxThreads <span class="token number">20</span>

<span class="token comment"># This option specifies the time (in seconds) after which clamd should</span>
<span class="token comment"># timeout if a client doesn't provide any data.</span>
<span class="token comment"># Default: 120</span>
ReadTimeout <span class="token number">120</span>

<span class="token comment"># This option specifies the time (in seconds) after which clamd should</span>
<span class="token comment"># timeout if a client doesn't provide any initial command after connecting.</span>
<span class="token comment"># Default: 30</span>
CommandReadTimeout <span class="token number">30</span>

<span class="token comment"># This option specifies how long to wait (in milliseconds) if the send buffer</span>
<span class="token comment"># is full. Keep this value low to prevent clamd hanging.</span>
<span class="token comment"># Default: 500</span>
SendBufTimeout <span class="token number">200</span></code></pre></div>
<p>MaxQueue と IdleTimeout を既定値から変えておきます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Maximum number of queued items (including those being processed by MaxThreads</span>
<span class="token comment"># threads). It is recommended to have this value at least twice MaxThreads</span>
<span class="token comment"># if possible.</span>
<span class="token comment"># WARNING: you shouldn't increase this too much to avoid running out of file</span>
<span class="token comment">#  descriptors, the following condition should hold:</span>
<span class="token comment">#  MaxThreads*MaxRecursion + MaxQueue - MaxThreads  + 6 &lt; RLIMIT_NOFILE</span>
<span class="token comment">#  (usual max for RLIMIT_NOFILE is 1024)</span>
<span class="token comment"># </span>
<span class="token comment"># Default: 100</span>
MaxQueue <span class="token number">200</span>

<span class="token comment"># This option specifies how long (in seconds) the process should wait</span>
<span class="token comment"># for a new job.</span>
<span class="token comment"># Default: 30</span>
IdleTimeout <span class="token number">60</span></code></pre></div>
<p>ExcludePath にはとりあえず以下の 3 つを指定します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Don't scan files/directories whose names match the provided</span>
<span class="token comment"># regular expression. This option can be specified multiple times.</span>
<span class="token comment"># Default: disabled</span>
ExcludePath ^/proc/
ExcludePath ^/sys/
ExcludePath ^/run/</code></pre></div>
<p>MaxDirectoryRecursion については既定値のまま、FollowDirectorySymlinks と FollowFileSymlinks は有効化しています。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Maximum depth the directories are scanned at.</span>
<span class="token comment"># Default: 15</span>
MaxDirectoryRecursion <span class="token number">15</span>

<span class="token comment"># Follow directory symlinks.</span>
<span class="token comment"># Default: no</span>
FollowDirectorySymlinks <span class="token function">yes</span>

<span class="token comment"># Follow symlinks to regular files.</span>
<span class="token comment"># Default: no</span>
FollowFileSymlinks <span class="token function">yes</span>

<span class="token comment"># Scan files and directories on other filesystems.</span>
<span class="token comment"># Default: yes</span>
CrossFilesystems <span class="token function">yes</span>

<span class="token comment"># This option specifies the time intervals (in seconds) in which clamd</span>
<span class="token comment"># should perform a database check.</span>
<span class="token comment"># Default: 600</span>
SelfCheck <span class="token number">600</span></code></pre></div>
<p>続く設定は既定値のままとし、Foreground と Debug を有効化します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Don't fork into background.</span>
<span class="token comment"># Default: no</span>
Foreground <span class="token function">yes</span>

<span class="token comment"># Enable debug messages in libclamav.</span>
<span class="token comment"># Default: no</span>
Debug <span class="token function">yes</span>

<span class="token comment"># Don't remove temporary files (for debugging purposes).</span>
<span class="token comment"># Default: no</span>
LeaveTemporaryFiles no

<span class="token comment"># Record metadata about the file being scanned.</span>
<span class="token comment"># Scan metadata is useful for file analysis purposes and for debugging scan behavior.</span>
<span class="token comment"># The JSON metadata will be printed after the scan is complete if Debug is enabled.</span>
<span class="token comment"># A metadata.json file will be written to the scan temp directory if LeaveTemporaryFiles is enabled.</span>
<span class="token comment"># Default: no</span>
<span class="token comment"># GenerateMetadataJson yes</span></code></pre></div>
<p>デーモンユーザを root にすることは非推奨らしいので、今回は clamav をユーザとして指定します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Run the daemon as a specified user (the process must be started by root).</span>
<span class="token comment"># Default: disabled</span>
User clamav</code></pre></div>
<p>また、BytecodeSecurity は Paranoid に変更し、BytecodeUnsigned も有効化しておきます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># With this option enabled ClamAV will load bytecode from the database. It is highly recommended you keep this option on, otherwise you'll miss detections for many new viruses.</span>
<span class="token comment"># Default: yes</span>
Bytecode <span class="token function">yes</span>

<span class="token comment"># Set bytecode security level.</span>
<span class="token comment"># Possible values:</span>
<span class="token comment"># 	TrustSigned - trust bytecode loaded from signed .c[lv]d files,</span>
<span class="token comment"># 		 insert runtime safety checks for bytecode loaded from other sources</span>
<span class="token comment"># 	Paranoid - don't trust any bytecode, insert runtime checks for all</span>
<span class="token comment"># Recommended: TrustSigned, because bytecode in .cvd files already has these checks.</span>
<span class="token comment"># Default: TrustSigned</span>
BytecodeSecurity Paranoid

<span class="token comment"># Set bytecode timeout in milliseconds.</span>
<span class="token comment"># Default: 10000</span>
BytecodeTimeout <span class="token number">10000</span>

<span class="token comment"># Allow loading bytecode from outside digitally signed .c[lv]d files.</span>
<span class="token comment"># Default: no</span>
BytecodeUnsigned <span class="token function">yes</span>

<span class="token comment"># Set bytecode execution mode.</span>
<span class="token comment"># Possible values:</span>
<span class="token comment"># 	Auto - automatically choose JIT if possible, fallback to interpreter</span>
<span class="token comment"># ForceJIT - always choose JIT, fail if not possible</span>
<span class="token comment"># ForceInterpreter - always choose interpreter</span>
<span class="token comment"># Test - run with both JIT and interpreter and compare results. Make all failures fatal.</span>
<span class="token comment"># Default: Auto</span>
BytecodeMode Auto</code></pre></div>
<p>PUA スキャンを有効化し、対象も適当に設定しておきます。</p>
<p>IncludePUA と ExcludePUA を同時に設定すると clamd 起動時に <code class="language-text">ExcludePUA and IncludePUA cannot be used at the same time</code> のエラーが発生します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Detect Potentially Unwanted Applications.</span>
<span class="token comment"># Default: no</span>
DetectPUA <span class="token function">yes</span>

<span class="token comment"># Exclude a specific PUA category. This directive can be used multiple times.</span>
<span class="token comment"># See https://docs.clamav.net/faq/faq-pua.html for the complete list of PUA</span>
<span class="token comment"># categories.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#ExcludePUA NetTool</span>
<span class="token comment">#ExcludePUA PWTool</span>

<span class="token comment"># Only include a specific PUA category. This directive can be used multiple</span>
<span class="token comment"># times.</span>
<span class="token comment"># Default: disabled</span>
IncludePUA Spy
IncludePUA Scanner
IncludePUA RAT
IncludePUA NetTool
IncludePUA PWTool</code></pre></div>
<p>各種ターゲットのスキャン設定を有効化します。</p>
<p>ただし、ScanMail と ScanPartialMessages は無効化しておきます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># PE stands for Portable Executable - it's an executable file format used</span>
<span class="token comment"># in all 32- and 64-bit versions of Windows operating systems. This option</span>
<span class="token comment"># allows ClamAV to perform a deeper analysis of executable files and it's also</span>
<span class="token comment"># required for decompression of popular executable packers such as UPX or FSG.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanPE <span class="token function">yes</span>

<span class="token comment"># Executable and Linking Format is a standard format for UN*X executables.</span>
<span class="token comment"># This option allows you to control the scanning of ELF files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanELF <span class="token function">yes</span>

<span class="token comment"># Enable the built in email scanner.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without parsing individual messages/attachments.</span>
<span class="token comment"># Default: yes</span>
ScanMail no

<span class="token comment"># Scan RFC1341 messages split over many emails. You will need to</span>
<span class="token comment"># periodically clean up $TemporaryDirectory/clamav-partial directory.</span>
<span class="token comment"># WARNING: This option may open your system to a DoS attack. Please don't use</span>
<span class="token comment"># this feature on highly loaded servers.</span>
<span class="token comment"># Default: no</span>
ScanPartialMessages no

<span class="token comment"># With this option enabled ClamAV will try to detect phishing attempts by using</span>
<span class="token comment"># signatures.</span>
<span class="token comment"># Default: yes</span>
PhishingSignatures <span class="token function">yes</span>

<span class="token comment"># Scan URLs found in mails for phishing attempts using heuristics.</span>
<span class="token comment"># Default: yes</span>
PhishingScanURLs <span class="token function">yes</span>

<span class="token comment"># In some cases (eg. complex malware, exploits in graphic files, and others),</span>
<span class="token comment"># ClamAV uses special algorithms to provide accurate detection. This option</span>
<span class="token comment"># controls the algorithmic detection.</span>
<span class="token comment"># Default: yes</span>
HeuristicAlerts <span class="token function">yes</span>

<span class="token comment"># Allow heuristic match to take precedence.</span>
<span class="token comment"># When enabled, if a heuristic scan (such as phishingScan) detects</span>
<span class="token comment"># a possible virus/phish it will stop scan immediately. Recommended, saves CPU</span>
<span class="token comment"># scan-time.</span>
<span class="token comment"># When disabled, virus/phish detected by heuristic scans will be reported only</span>
<span class="token comment"># at the end of a scan. If an archive contains both a heuristically detected</span>
<span class="token comment"># virus/phish, and a real malware, the real malware will be reported.</span>
<span class="token comment"># Keep this disabled if you intend to handle "Heuristics.*" viruses</span>
<span class="token comment"># differently from "real" malware.</span>
<span class="token comment"># If a non-heuristically-detected virus (signature-based) is found first,</span>
<span class="token comment"># the scan is interrupted immediately, regardless of this config option.</span>
<span class="token comment"># Default: no</span>
HeuristicScanPrecedence <span class="token function">yes</span></code></pre></div>
<p>どういう動きになるかいまいちわかってないですが、DLP も有効化しておきます。</p>
<p>関連する設定は既定値のままとします。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Enable the Data Loss Prevention module.</span>
<span class="token comment"># Default: no</span>
StructuredDataDetection <span class="token function">yes</span>

<span class="token comment"># This option sets the lowest number of Credit Card numbers found in a file</span>
<span class="token comment"># to generate a detect.</span>
<span class="token comment"># Default: 3</span>
<span class="token comment">#StructuredMinCreditCardCount 5</span>

<span class="token comment"># This option sets the lowest number of Social Security Numbers found</span>
<span class="token comment"># in a file to generate a detect.</span>
<span class="token comment"># Default: 3</span>
<span class="token comment">#StructuredMinSSNCount 5</span>

<span class="token comment"># With this option enabled the DLP module will search for valid</span>
<span class="token comment"># SSNs formatted as xxx-yy-zzzz.</span>
<span class="token comment"># Default: yes</span>
<span class="token comment">#StructuredSSNFormatNormal yes</span>

<span class="token comment"># With this option enabled the DLP module will search for valid</span>
<span class="token comment"># SSNs formatted as xxxyyzzzz</span>
<span class="token comment"># Default: no</span>
<span class="token comment">#StructuredSSNFormatStripped no</span></code></pre></div>
<p>こちらも既定値のままですが、HTML と OLE2 のスキャンを有効化しておきます。</p>
<p>さらに、PDF やアーカイブファイルなど、複数の設定を有効化します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Perform HTML/JavaScript/ScriptEncoder normalisation and decryption.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanHTML <span class="token function">yes</span>

<span class="token comment"># This option enables scanning of OLE2 files, such as Microsoft Office</span>
<span class="token comment"># documents and .msi files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanOLE2 <span class="token function">yes</span>

***

<span class="token comment"># This option enables scanning within PDF files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without decoding and additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanPDF <span class="token function">yes</span>

<span class="token comment"># This option enables scanning within SWF files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without decoding and additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanSWF <span class="token function">yes</span>

<span class="token comment"># This option enables scanning xml-based document files supported by libclamav.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanXMLDOCS <span class="token function">yes</span>

<span class="token comment"># This option enables scanning HWP3 files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanHWP3 <span class="token function">yes</span>

<span class="token comment"># Scan within archives and compressed files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without unpacking and additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanArchive <span class="token function">yes</span></code></pre></div>
<p>AlertBrokenExecutables、AlertBrokenMedia、そして AlertEncrypted を有効化します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># With this option enabled clamav will try to detect broken executables</span>
<span class="token comment"># (PE, ELF, &amp; Mach-O) and alert on them with a Broken.Executable heuristic signature.</span>
<span class="token comment"># Default: no</span>
AlertBrokenExecutables <span class="token function">yes</span>

<span class="token comment"># With this option enabled clamav will try to detect broken media files</span>
<span class="token comment"># (JPEG, TIFF, PNG, GIF) and alert on them with a Broken.Media heuristic signature.</span>
<span class="token comment"># Default: no</span>
AlertBrokenMedia <span class="token function">yes</span>

<span class="token comment"># Alert on encrypted archives and documents (encrypted .zip, .7zip, .rar, .pdf).</span>
<span class="token comment"># Default: no</span>
AlertEncrypted <span class="token function">yes</span></code></pre></div>
<p>過検出が増える懸念はありますが、以下の設定もすべて有効化します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Alert on encrypted archives (encrypted .zip, .7zip, .rar).</span>
<span class="token comment"># Default: no</span>
AlertEncryptedArchive <span class="token function">yes</span>

<span class="token comment"># Alert on encrypted documents (encrypted .pdf).</span>
<span class="token comment"># Default: no</span>
AlertEncryptedDoc <span class="token function">yes</span>

<span class="token comment"># With this option enabled OLE2 files with VBA macros, which were not</span>
<span class="token comment"># detected by signatures will be marked as "Heuristics.OLE2.ContainsMacros".</span>
<span class="token comment"># Default: no</span>
AlertOLE2Macros <span class="token function">yes</span>

<span class="token comment"># Alert on SSL mismatches in URLs, even if they're not in the database.</span>
<span class="token comment"># This feature can lead to false positives.</span>
<span class="token comment"># Default: no</span>
AlertPhishingSSLMismatch <span class="token function">yes</span>

<span class="token comment"># Alert on cloaked URLs, even if they're not in the database.</span>
<span class="token comment"># This feature can lead to false positives.</span>
<span class="token comment"># Default: no</span>
AlertPhishingCloak <span class="token function">yes</span>

<span class="token comment"># Alert on raw DMG image files containing partition intersections.</span>
<span class="token comment"># Default: no</span>
AlertPartitionIntersection <span class="token function">yes</span>

<span class="token comment"># This option enables scanning within PDF files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without decoding and additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanPDF <span class="token function">yes</span>

<span class="token comment"># This option enables scanning within SWF files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without decoding and additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanSWF <span class="token function">yes</span>

<span class="token comment"># This option enables scanning xml-based document files supported by libclamav.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanXMLDOCS <span class="token function">yes</span>

<span class="token comment"># This option enables scanning HWP3 files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanHWP3 <span class="token function">yes</span>

<span class="token comment"># Scan within archives and compressed files.</span>
<span class="token comment"># If you turn off this option, the original files will still be scanned, but</span>
<span class="token comment"># without unpacking and additional processing.</span>
<span class="token comment"># Default: yes</span>
ScanArchive <span class="token function">yes</span></code></pre></div>
<p>以降のスキャン制限に関する設定値はデフォルトのまま使用するので特に変更しません。</p>
<p>ただし、以下の行だけは、clamd 起動時に parse エラーを引き起こすため、コメントアウトしておきます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># This option sets the maximum amount of data to be scanned for each input file.</span>
<span class="token comment"># Archives and other containers are recursively extracted and scanned up to this</span>
<span class="token comment"># value.</span>
<span class="token comment"># The value of 0 disables the limit.</span>
<span class="token comment"># WARNING: disabling this limit or setting it too high may result in severe</span>
<span class="token comment"># damage.</span>
<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span> MaxScanSize: UNKNOWN INTERNAL TYPE <span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
<span class="token comment">#MaxScanSize 400M</span></code></pre></div>
<p>続く OnAccessScan の構成では、OnAccessMountPath を既定値の Disabled のままとします。</p>
<p>OnAccessMountPath は OnAccessScan で監視するファイルシステムのマウントポイントを指定することができますが、Dynamic Directory Determination(DDD) システムとは異なる fanotify 構成を使用するため、DDD との互換性がなくなります。</p>
<p>つまり、OnAccessExtraScanning  などのオプションを有効化できなくなります。</p>
<p>諸々の使いやすさなどを考慮し、今回は以下の設定で OnAccessScan を構成しました。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># This option specifies a directory or mount point which should be scanned on access. The mount point specified, or the mount point containing the specified directory will be watched, but only notifications will occur. If any directories are specified, this option will preempt the DDD system. It can also be used multiple times.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#OnAccessMountPath /</span>
<span class="token comment"># OnAccessMountPath /home</span>

<span class="token comment"># This option specifies a directory (including all files and directories</span>
<span class="token comment"># inside it), which should be scanned on access. This option can</span>
<span class="token comment"># be used multiple times.</span>
<span class="token comment"># Default: disabled</span>
OnAccessIncludePath /home
<span class="token comment">#OnAccessIncludePath /students</span>

<span class="token comment"># This option allows excluding directories from on-access scanning. It can</span>
<span class="token comment"># be used multiple times. Only works with DDD system.</span>
<span class="token comment"># Default: disabled</span>
OnAccessExcludePath /home/excluded
<span class="token comment">#OnAccessExcludePath /root</span>

<span class="token comment"># Use this option to exclude the root UID (0) and allow any processes run under root to access all watched files without triggering scans.</span>
<span class="token comment"># Default: disabled</span>
OnAccessExcludeRootUID <span class="token function">yes</span>

<span class="token comment"># With this option you can exclude specific UIDs. Processes with these UIDs</span>
<span class="token comment"># will be able to access all files.</span>
<span class="token comment"># This option can be used multiple times (one per line). Using a value of 0 on any line will disable this option entirely. To exclude the root UID please enable the OnAccessExcludeRootUID option.</span>
<span class="token comment"># Default: disabled</span>
OnAccessExcludeUID <span class="token number">0</span>

<span class="token comment"># This option allows exclusions via user names when using the on-access scanning client. It can</span>
<span class="token comment"># be used multiple times.</span>
<span class="token comment"># Default: disabled</span>
OnAccessExcludeUname clamav

<span class="token comment"># Files larger than this value will not be scanned in on access.</span>
<span class="token comment"># You may use 'M' or 'm' for megabytes (1M = 1m = 1048576 bytes)</span>
<span class="token comment"># and 'K' or 'k' for kilobytes (1K = 1k = 1024 bytes). To specify the size</span>
<span class="token comment"># in bytes just don't use modifiers.</span>
<span class="token comment"># Default: 5242880</span>
<span class="token comment">#OnAccessMaxFileSize 5M</span>

<span class="token comment"># This option toggles the dynamic directory determination system for on-access scanning (Linux only).</span>
<span class="token comment"># Default: no</span>
OnAccessDisableDDD no

<span class="token comment"># This option changes fanotify behavior to prevent access attempts on malicious files instead of simply notifying the user (On Access scan only).</span>
<span class="token comment"># Default: no</span>
OnAccessPrevention <span class="token function">yes</span>

<span class="token comment"># Enables extra scanning and notification after catching certain inotify events. Only works with the DDD system enabled.</span>
<span class="token comment"># Default: no</span>
OnAccessExtraScanning <span class="token function">yes</span></code></pre></div>
<p>参考：<a href="https://docs.clamav.net/manual/OnAccess.html?highlight=OnAccessMountPath#troubleshooting" target="_blank" rel="nofollow noopener noreferrer">On-Access Scanning - ClamAV Documentation</a></p>
<p>参考：<a href="https://inaba-serverdesign.jp/blog/20210409/clamav-realtime-scan.html" target="_blank" rel="nofollow noopener noreferrer">ClamAVによるリアルタイムスキャンの設定 | 稲葉サーバーデザイン</a></p>
<p>最後に、<code class="language-text">clamd</code> コマンドを実行してデーモンを起動した後、<code class="language-text">clamonacc</code> を実行すれば OK です。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># デーモンの起動(User の設定によって、デーモンの実行ユーザが clamav になる)</span>
clamd

<span class="token comment"># fds_poll_recv: timeout after 600 seconds が表示されたら実行</span>
clamonacc</code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/0a2019470bb7c8a7bdbcc3bab3d4eba5/561da/image-20240128225355498.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 67.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACHElEQVQ4y2WT6XKbQBCEeZVYTmwjdAACcS/3IWQnyvu/y6R7dJjYP6Z2i2J7v+nptcp+kKxupRxGqfpRYlNJezpLN79LPZ4kzIz4cSobP5C3vSe/NjtZ2Y48rzdayz3LKppOkrKWvO2laDs55kaqYdIKs0JsiKy9g2yDUGzXl5/OVp7e1vLj1X6Icb2XVXa9JFWjhKRNsR8//kiB7xW+NdMJxLPUWLv5LMfCiIML9DJcsFo7/5FaPFSPk7bNfQ5i0hkIelEsbpRoy/tjLEGWY410f8wLtYCky/at4fwu8+Wigu00KxG9I00G2mNegqqUEFbQX1oSmVL3hySTIM3lZbv/JGxAx8NKhqGw5RKrUsJX043qMYnzplURthugrqQGg9p+ClJs/PitIj1oTTcoIfe8jMKkJzktoQAF6SXbJsDrzpWnhyAMnyAYow0eTKtaD2SgScpKYrRLegp58PPu4T6M1EONkrMgvN486SH64fJnFCfJzNGfZfEbibhnfFjL+Fjz5a/GhS3Xtxa5Jw1/YCv3Q19rGegHIQ0nWVo3ajgj4t9WF7EhEetrgFe3i74Rcnot2qYwCSmcoX0D6gI+pmWjE/aTFBdfY3JArRFqvqDNIZSXxXPUYHOyFcQ4VeaLL6VBJrvTSYfFiETFNXtenIiDd73DUBz/8H0oEcbPVhle7tlq0fI51giw0XgwGhHEmAKSUoxpsG8vZWnDP/dwz0hcuFa4AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/0a2019470bb7c8a7bdbcc3bab3d4eba5/8ac56/image-20240128225355498.webp 240w,
/static/0a2019470bb7c8a7bdbcc3bab3d4eba5/d3be9/image-20240128225355498.webp 480w,
/static/0a2019470bb7c8a7bdbcc3bab3d4eba5/e46b2/image-20240128225355498.webp 960w,
/static/0a2019470bb7c8a7bdbcc3bab3d4eba5/bd9c6/image-20240128225355498.webp 969w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/0a2019470bb7c8a7bdbcc3bab3d4eba5/8ff5a/image-20240128225355498.png 240w,
/static/0a2019470bb7c8a7bdbcc3bab3d4eba5/e85cb/image-20240128225355498.png 480w,
/static/0a2019470bb7c8a7bdbcc3bab3d4eba5/d9199/image-20240128225355498.png 960w,
/static/0a2019470bb7c8a7bdbcc3bab3d4eba5/561da/image-20240128225355498.png 969w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/0a2019470bb7c8a7bdbcc3bab3d4eba5/d9199/image-20240128225355498.png"
            alt="image-20240128225355498"
            title="image-20240128225355498"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>参考：<a href="https://docs.clamav.net/manual/Usage/Scanning.html" target="_blank" rel="nofollow noopener noreferrer">Scanning - ClamAV Documentation</a></p>
<p>実際に OnAccessScan で Eicar ファイルがブロックされたことを確認できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 899px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/bac3134e03d9638e45a330e5487609e1/681f1/image-20240128231345106.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 48.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABnklEQVQoz4WS2XqbMBCFeZC0YGSXfTM7NgSDnRC+Ns77v8zpkSzSXKUX/zczSDqzYVzXFZfXBf31huH2gvM0o5+vuCxvGPhN+qfLTCZMy4p2vKA89yi6M5r+GXFRwfYC7INIYaz3Dyx/7kqgeR7RDCOypkXFy904Ia0bJSD9rG4RHAskVY24rB9xlkP44T/B5f1DZZ7fVj6akTNzeR5UBYcwVtnlA4n0JTvX/2SrbrtjSCHZZq0qmnV7M45NBzfJPjN/x6NCLbi83zG+vCrRjCIJW5FiadWw2hOivMT+S0v/w5CziDhYya84ha1KZ1ad2WJbpuMpu7W1sdPt2zo2PVboeD4OjkscOK4Hl7HjPawfhii5gJaVFmUFPwjg+UTbigtrWi6G97wwwpwFMG59gb4tcOKGu35AzktHioRpBjeKlV9w6xkFPcbym8vHDomPOZK80HGMKmXLU5+j6wpM62+knJ3PmUWcn8vfYR8lEHLTsn3aA0eyIc/UeRCrM4lF33iybDztiGnhB+1PjWkLmELAEnuNeHzbEF/PN1/gL6dbN+gFQDLGAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/bac3134e03d9638e45a330e5487609e1/8ac56/image-20240128231345106.webp 240w,
/static/bac3134e03d9638e45a330e5487609e1/d3be9/image-20240128231345106.webp 480w,
/static/bac3134e03d9638e45a330e5487609e1/8bcb7/image-20240128231345106.webp 899w"
              sizes="(max-width: 899px) 100vw, 899px"
              type="image/webp"
            />
          <source
            srcset="/static/bac3134e03d9638e45a330e5487609e1/8ff5a/image-20240128231345106.png 240w,
/static/bac3134e03d9638e45a330e5487609e1/e85cb/image-20240128231345106.png 480w,
/static/bac3134e03d9638e45a330e5487609e1/681f1/image-20240128231345106.png 899w"
            sizes="(max-width: 899px) 100vw, 899px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/bac3134e03d9638e45a330e5487609e1/681f1/image-20240128231345106.png"
            alt="image-20240128231345106"
            title="image-20240128231345106"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>また、ついでに clamscan コマンドでも検知テストを実行してみたところ、こちらでも Eicar ファイルの検出に成功しました。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 875px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a333db366953d2130db3691f5be78864/71c8e/image-20240128230756961.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 29.166666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7ElEQVQY032RWXLDIBBEuUqCZWtBS2RrX0GKLCn3P09nIMJ2pVL5eNUDTDXNwJYhxzSUKLoBedujVTOqQaIaFfp5wa1uiQa3pkWU5YjzElnbUV0gLStzllYNroQbJWAiK5HWPRlI1HKCF3/AJS50eA5jvHsBuOeTEn5g1m+ub9TWFu4LMLVukMuKbv5E2Y84BaFp1MqJkwjhHOha71vOr+ujZvpZDSVL8sJs2Nu5/2x0jmZjHIiHCbdKySxM3jeodf9JSfPTs0hoTo6InjeLVzPxMPoLNpJRLRWmbaekCvP+ZT7nd6Pzj4lNqfUbMMC7LrKs4G8AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/a333db366953d2130db3691f5be78864/8ac56/image-20240128230756961.webp 240w,
/static/a333db366953d2130db3691f5be78864/d3be9/image-20240128230756961.webp 480w,
/static/a333db366953d2130db3691f5be78864/a1ca4/image-20240128230756961.webp 875w"
              sizes="(max-width: 875px) 100vw, 875px"
              type="image/webp"
            />
          <source
            srcset="/static/a333db366953d2130db3691f5be78864/8ff5a/image-20240128230756961.png 240w,
/static/a333db366953d2130db3691f5be78864/e85cb/image-20240128230756961.png 480w,
/static/a333db366953d2130db3691f5be78864/71c8e/image-20240128230756961.png 875w"
            sizes="(max-width: 875px) 100vw, 875px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/a333db366953d2130db3691f5be78864/71c8e/image-20240128230756961.png"
            alt="image-20240128230756961"
            title="image-20240128230756961"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h2 id="デバッグと-systemd-を有効化して再ビルドする" style="position:relative;"><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A8-systemd-%E3%82%92%E6%9C%89%E5%8A%B9%E5%8C%96%E3%81%97%E3%81%A6%E5%86%8D%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B" aria-label="デバッグと systemd を有効化して再ビルドする permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>デバッグと Systemd を有効化して再ビルドする</h2>
<p>とりあえず一通りの設定ができたので、最後に Debug モードと Systemd を有効化して ClamAV を再ビルドしてみます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">cmake <span class="token punctuation">..</span> <span class="token punctuation">\</span>
    -D <span class="token assign-left variable">CMAKE_BUILD_TYPE</span><span class="token operator">=</span>Debug <span class="token punctuation">\</span>
    -D <span class="token assign-left variable">OPTIMIZE</span><span class="token operator">=</span>OFF <span class="token punctuation">\</span>
    -D <span class="token assign-left variable">ENABLE_EXAMPLES</span><span class="token operator">=</span>OFF <span class="token punctuation">\</span>
    -D <span class="token assign-left variable">ENABLE_STATIC_LIB</span><span class="token operator">=</span>ON <span class="token punctuation">\</span>
    -D <span class="token assign-left variable">ENABLE_SYSTEMD</span><span class="token operator">=</span>ON
cmake --build <span class="token builtin class-name">.</span> --target <span class="token function">install</span></code></pre></div>
<p>参考：<a href="https://docs.clamav.net/manual/Installing/Installing-from-source-Unix.html?highlight=systemd#building-clamav-with-cmake-v0104-and-newer" target="_blank" rel="nofollow noopener noreferrer">Unix from source (v0.104+) - ClamAV Documentation</a></p>
<p>ビルドとインストールが完了すると、Unit ファイルは既定で <code class="language-text">/lib/systemd/system</code> 直下に作成されます。</p>
<p>それぞれ以下のような内容になっています。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">cat</span> /lib/systemd/system/clamav-daemon.service

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Clam AntiVirus userspace daemon
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>man:clamd<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> man:clamd.conf<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> https://docs.clamav.net/
<span class="token comment"># Check for database existence</span>
<span class="token assign-left variable">ConditionPathExistsGlob</span><span class="token operator">=</span>/usr/local/share/clamav/main.<span class="token punctuation">{</span>c<span class="token punctuation">[</span>vl<span class="token punctuation">]</span>d,inc<span class="token punctuation">}</span>
<span class="token assign-left variable">ConditionPathExistsGlob</span><span class="token operator">=</span>/usr/local/share/clamav/daily.<span class="token punctuation">{</span>c<span class="token punctuation">[</span>vl<span class="token punctuation">]</span>d,inc<span class="token punctuation">}</span>

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/sbin/clamd --foreground<span class="token operator">=</span>true
<span class="token comment"># Reload the database</span>
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill -USR2 <span class="token variable">$MAINPID</span>
<span class="token assign-left variable">StandardOutput</span><span class="token operator">=</span>syslog
<span class="token assign-left variable">TimeoutStartSec</span><span class="token operator">=</span><span class="token number">420</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">cat</span> /lib/systemd/system/clamav-freshclam.service 
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>ClamAV virus database updater
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>man:freshclam<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> man:freshclam.conf<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> https://docs.clamav.net/
<span class="token comment"># If user wants it run from cron, don't start the daemon.</span>
<span class="token assign-left variable">ConditionPathExists</span><span class="token operator">=</span><span class="token operator">!</span>/etc/cron.d/clamav-freshclam
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>network-online.target
<span class="token assign-left variable">After</span><span class="token operator">=</span>network-online.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/freshclam -d --foreground<span class="token operator">=</span>true
<span class="token assign-left variable">StandardOutput</span><span class="token operator">=</span>syslog

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</code></pre></div>
<p>実際に以下のコマンドで clamd と freshclam の自動起動を有効化してから OS を再起動すると、以下の通り各デーモンが自動起動していることがわかります。</p>
<p>※ 起動時にデータベースファイルが存在していない場合 clamd の起動は <code class="language-text">ConditionPathExistsGlob=/usr/local/share/clamav/daily.{c[vl]d,inc} was not met</code> のようなメッセージとともに失敗するので、freshclam を事前に実行しておくと良いです。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> clamav-daemon.service
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> clamav-freshclam.service </code></pre></div>
<p>ただし、Unit ファイルの設定を見てもわかる通り、このままでは clamonacc は自動起動されず、OnAccessScan は使用できません。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a884c668fed595bfcdc916c088c57a2b/6f2be/image-20240129231359522.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 5.833333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAATklEQVQI1w3KSwqAIBRA0XZTEJTPUPNvEU4K2v9qbp3xGW6jiFbhc8aWA1ca/XnJV2fWhnERlPXIHjCpYmL5XyOExC4b4gK+nmgfmVbNBzcqIUZFKBAzAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/a884c668fed595bfcdc916c088c57a2b/8ac56/image-20240129231359522.webp 240w,
/static/a884c668fed595bfcdc916c088c57a2b/d3be9/image-20240129231359522.webp 480w,
/static/a884c668fed595bfcdc916c088c57a2b/e46b2/image-20240129231359522.webp 960w,
/static/a884c668fed595bfcdc916c088c57a2b/faf06/image-20240129231359522.webp 1029w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/a884c668fed595bfcdc916c088c57a2b/8ff5a/image-20240129231359522.png 240w,
/static/a884c668fed595bfcdc916c088c57a2b/e85cb/image-20240129231359522.png 480w,
/static/a884c668fed595bfcdc916c088c57a2b/d9199/image-20240129231359522.png 960w,
/static/a884c668fed595bfcdc916c088c57a2b/6f2be/image-20240129231359522.png 1029w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/a884c668fed595bfcdc916c088c57a2b/d9199/image-20240129231359522.png"
            alt="image-20240129231359522"
            title="image-20240129231359522"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>そこで、<code class="language-text">/lib/systemd/system/clamav-clamonacc.service</code> として以下の Unit ファイルを手動で作成し、こちらも自動起動設定を行います。(<code class="language-text">/quarantine</code> が存在しない場合は事前に作成しておきます。)</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>ClamAV On Access Scanner
<span class="token assign-left variable">Requires</span><span class="token operator">=</span>clamav-daemon.service
<span class="token assign-left variable">After</span><span class="token operator">=</span>clamav-daemon.service syslog.target network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>simple
<span class="token assign-left variable">User</span><span class="token operator">=</span>root
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/sbin/clamonacc -F --fdpass --config-file<span class="token operator">=</span>/usr/local/etc/clamd.conf --move<span class="token operator">=</span>/quarantine
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>20s

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</code></pre></div>
<p>これで、<code class="language-text">sudo systemctl enable clamav-clamonacc.service</code> コマンドで自動起動設定を入れて OS を再起動します。</p>
<p>OS の起動後、20 秒から 60 秒程度待つと、clamonacc が自動起動することを確認できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/b6fe2c62e7302b00c92fba5e17a3379c/82c1e/image-20240129232158799.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 6.666666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAATUlEQVQI1x3KQQqAIBQA0Y4TqKXlz1LMCArr/veZpMVsHtMl73EhEHJhKyflquhZUJPg1tj8YL8fan1JErDNJOb2LChj0WakHxzK+b8PLI4gzUCShp4AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/b6fe2c62e7302b00c92fba5e17a3379c/8ac56/image-20240129232158799.webp 240w,
/static/b6fe2c62e7302b00c92fba5e17a3379c/d3be9/image-20240129232158799.webp 480w,
/static/b6fe2c62e7302b00c92fba5e17a3379c/e46b2/image-20240129232158799.webp 960w,
/static/b6fe2c62e7302b00c92fba5e17a3379c/b391b/image-20240129232158799.webp 1398w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/b6fe2c62e7302b00c92fba5e17a3379c/8ff5a/image-20240129232158799.png 240w,
/static/b6fe2c62e7302b00c92fba5e17a3379c/e85cb/image-20240129232158799.png 480w,
/static/b6fe2c62e7302b00c92fba5e17a3379c/d9199/image-20240129232158799.png 960w,
/static/b6fe2c62e7302b00c92fba5e17a3379c/82c1e/image-20240129232158799.png 1398w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/b6fe2c62e7302b00c92fba5e17a3379c/d9199/image-20240129232158799.png"
            alt="image-20240129232158799"
            title="image-20240129232158799"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>これで Eicar ファイルを操作するとアクセスがブロックされ、隔離ディレクトリに Eicar ファイルが(生のまま！)配置されていることがわかります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 628px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/00e483f4b1c08926eae75fd015997b1c/3d84d/image-20240129232257243.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 20%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7ElEQVQY0zWQ626CQBSEeRMttbGwgIggyGWXyyLriheUxF9N+v4vMT2i/TGZsznJN3PW0MOI8/hA0ewRpAXWSQo3irETNbZFhayWYEGEueXg03Zh2uTMJXnT++mLt76cFYxCdkjrBsEug+VvEGacFj78JMPC8QjYUlBO8BKxqBCTm2yFD9t7Qd/6hxq8VWj7M7jcT+2qTmObc0jdI6TGKQFF2yEhWJQLal4iXDMwx8JsyTD/fmm2tGHSFcbxNuLx84ueXOoTDtcBtTpAnS5QlwH6ekdHc62O4AR+fkVeNiQKKMQUEvNquoRtIvwBijmFSLA2YbsAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/00e483f4b1c08926eae75fd015997b1c/8ac56/image-20240129232257243.webp 240w,
/static/00e483f4b1c08926eae75fd015997b1c/d3be9/image-20240129232257243.webp 480w,
/static/00e483f4b1c08926eae75fd015997b1c/724e7/image-20240129232257243.webp 628w"
              sizes="(max-width: 628px) 100vw, 628px"
              type="image/webp"
            />
          <source
            srcset="/static/00e483f4b1c08926eae75fd015997b1c/8ff5a/image-20240129232257243.png 240w,
/static/00e483f4b1c08926eae75fd015997b1c/e85cb/image-20240129232257243.png 480w,
/static/00e483f4b1c08926eae75fd015997b1c/3d84d/image-20240129232257243.png 628w"
            sizes="(max-width: 628px) 100vw, 628px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/00e483f4b1c08926eae75fd015997b1c/3d84d/image-20240129232257243.png"
            alt="image-20240129232257243"
            title="image-20240129232257243"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="ビルド時の警告を抑制する" style="position:relative;"><a href="#%E3%83%93%E3%83%AB%E3%83%89%E6%99%82%E3%81%AE%E8%AD%A6%E5%91%8A%E3%82%92%E6%8A%91%E5%88%B6%E3%81%99%E3%82%8B" aria-label="ビルド時の警告を抑制する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ビルド時の警告を抑制する</h3>
<p>ClamAV ビルド時の警告を抑制したい場合は、CMakeOptions.cmake に以下の行を追加します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">add_definitions<span class="token punctuation">(</span>-w<span class="token punctuation">)</span></code></pre></div>
<h2 id="検知時の通知を設定する" style="position:relative;"><a href="#%E6%A4%9C%E7%9F%A5%E6%99%82%E3%81%AE%E9%80%9A%E7%9F%A5%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B" aria-label="検知時の通知を設定する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>検知時の通知を設定する</h2>
<p>せっかくなので、ClamAV が Malware を検知した際にユーザに通知を発生させるようにしてみます。</p>
<p>作成した <code class="language-text">clamconf -g clamd.conf > /usr/local/etc/clamd.conf</code> で VirusEvent オプションを有効化します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Execute a command when a virus is found. In the command string %v will be</span>
<span class="token comment"># replaced with the virus name and %f will be replaced with the file name.</span>
<span class="token comment"># Additionally, two environment variables will be defined: $CLAM_VIRUSEVENT_FILENAME</span>
<span class="token comment"># and $CLAM_VIRUSEVENT_VIRUSNAME.</span>
<span class="token comment"># Default: disabled</span>
<span class="token comment">#VirusEvent /usr/bin/mailx -s "ClamAV VIRUS ALERT: %v" alert &lt; /dev/null</span>
VirusEvent /etc/clamav/virus-event.bash</code></pre></div>
<p>続いて、<code class="language-text">/etc/clamav/virus-event.bash</code> を作成して以下のスクリプトを埋め込み、<code class="language-text">chmod +x /etc/clamav/virus-event.bash</code> コマンドで実行権限を付与します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/bin
<span class="token assign-left variable">ALERT</span><span class="token operator">=</span><span class="token string">"Signature detected by clamav: <span class="token variable">$CLAM_VIRUSEVENT_VIRUSNAME</span> in <span class="token variable">$CLAM_VIRUSEVENT_FILENAME</span>"</span>

<span class="token comment"># Send an alert to all graphical users.</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">ADDRESS</span> <span class="token keyword">in</span> /run/user/*<span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token assign-left variable">USERID</span><span class="token operator">=</span><span class="token variable">${ADDRESS<span class="token operator">#</span><span class="token operator">/</span>run<span class="token operator">/</span>user<span class="token operator">/</span>}</span>
    /usr/bin/sudo -u <span class="token string">"#<span class="token variable">$USERID</span>"</span> <span class="token assign-left variable"><span class="token environment constant">DBUS_SESSION_BUS_ADDRESS</span></span><span class="token operator">=</span><span class="token string">"unix:path=<span class="token variable">$ADDRESS</span>/bus"</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">${<span class="token environment constant">PATH</span>}</span> <span class="token punctuation">\</span>
        /usr/bin/notify-send -i dialog-warning <span class="token string">"Virus found!"</span> <span class="token string">"<span class="token variable">$ALERT</span>"</span>
<span class="token keyword">done</span></code></pre></div>
<p>参考：<a href="https://wiki.archlinux.org/title/ClamAV#OnAccessScan" target="_blank" rel="nofollow noopener noreferrer">ClamAV - ArchWiki</a></p>
<p>これで、ClamAV による検知時に GUI ユーザに通知を送信できるようになりました。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a2ed62c689a2a4b8c2e58367b3fba170/f3abf/image-20240129233153867.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 8.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAf0lEQVQI103IQQqCQBiGYe8RtkiDnL8ZCyJqJbQIOkUYphndIO84y2Ta5EneZojAxcP78UUmXxGI1mQiZEp+/e+RpTZM4phn1zEMH6y1OOd4e6F9/yLaFwfMdodab0jFMFOaxDcdScLnhT2dLyiOJ673B+eqpmxayrrl4ls1N770s02dREQqqAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/a2ed62c689a2a4b8c2e58367b3fba170/8ac56/image-20240129233153867.webp 240w,
/static/a2ed62c689a2a4b8c2e58367b3fba170/d3be9/image-20240129233153867.webp 480w,
/static/a2ed62c689a2a4b8c2e58367b3fba170/e46b2/image-20240129233153867.webp 960w,
/static/a2ed62c689a2a4b8c2e58367b3fba170/f992d/image-20240129233153867.webp 1440w,
/static/a2ed62c689a2a4b8c2e58367b3fba170/0b448/image-20240129233153867.webp 1474w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/a2ed62c689a2a4b8c2e58367b3fba170/8ff5a/image-20240129233153867.png 240w,
/static/a2ed62c689a2a4b8c2e58367b3fba170/e85cb/image-20240129233153867.png 480w,
/static/a2ed62c689a2a4b8c2e58367b3fba170/d9199/image-20240129233153867.png 960w,
/static/a2ed62c689a2a4b8c2e58367b3fba170/07a9c/image-20240129233153867.png 1440w,
/static/a2ed62c689a2a4b8c2e58367b3fba170/f3abf/image-20240129233153867.png 1474w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/a2ed62c689a2a4b8c2e58367b3fba170/d9199/image-20240129233153867.png"
            alt="image-20240129233153867"
            title="image-20240129233153867"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h2 id="まとめ" style="position:relative;"><a href="#%E3%81%BE%E3%81%A8%E3%82%81" aria-label="まとめ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>まとめ</h2>
<p>とりあえず ClamAV のソースコードを読んでいくために一通りのセットアップと動作確認を試してみました。</p>
<p>ClamAV をまともに運用するのは中々骨が折れそうに感じました。</p></div></div></div><div class="Post-module--post__footer--3WzWU"><div><p class="Meta-module--meta__date--29eD7">Published <!-- -->Jan 27, 2024</p></div><div class="Tags-module--tags--1L_ct"><ul class="Tags-module--tags__list--91FqN"><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/clam-av/">ClamAV</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/malware/">Malware</a></li></ul></div><div class="Author-module--author--2Yefr"><p>リバースエンジニアになりたいCTF Player(Team: 0nePadding)。WinDbgとYARAが好き。OSCP / CISSP / AtCoder 緑 Microsoft Japanに所属してます。発言はすべて個人の見解。<a class="Author-module--author__bio-twitter--n-O9n" href="https://www.twitter.com/kash1064" rel="noopener noreferrer" target="_blank"><strong>かしわば</strong> on Twitter</a></p></div></div><div class="Post-module--post__comments--25y6I"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/clamav-note01";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-299cfcade846097f4d4b.js"],"app":["/app-96e4878161dbb29d31fb.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-fd4fb51a6fac1c18bdde.js"],"component---src-templates-categories-list-template-js":["/component---src-templates-categories-list-template-js-2181ec47d28e5c35d3e9.js"],"component---src-templates-category-template-js":["/component---src-templates-category-template-js-76f2006942127b3c7274.js"],"component---src-templates-index-template-js":["/component---src-templates-index-template-js-70ba56c0f46525baa629.js"],"component---src-templates-not-found-template-js":["/component---src-templates-not-found-template-js-d19905e5c8fc953958f1.js"],"component---src-templates-page-template-js":["/component---src-templates-page-template-js-6ba68ef37e264f701345.js"],"component---src-templates-post-template-js":["/component---src-templates-post-template-js-381c1b847824134fa4bd.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-0faa242d92f89b71e668.js"],"component---src-templates-tags-list-template-js":["/component---src-templates-tags-list-template-js-2d7007993fc2bf0f9caf.js"]};/*]]>*/</script><script src="/polyfill-299cfcade846097f4d4b.js" nomodule=""></script><script src="/component---src-templates-post-template-js-381c1b847824134fa4bd.js" async=""></script><script src="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-96e4878161dbb29d31fb.js" async=""></script><script src="/dc6a8720040df98778fe970bf6c000a41750d3ae-7931894db9633ae8bcc9.js" async=""></script><script src="/532a2f07-92db97c0addf07d5cb73.js" async=""></script><script src="/framework-3761df4ab6ee9f056936.js" async=""></script><script src="/webpack-runtime-a3c0f166cb4b802ff58f.js" async=""></script></body></html>