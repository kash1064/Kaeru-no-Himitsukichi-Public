<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e71379dda153709d1a9a.css" id="gatsby-global-css">html{font-size:100}body{margin:0 0 0 calc(100vw - 100%);color:#222;line-height:1.4;font-size:.875rem;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background-color:#fcfcfc}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:1.575rem;line-height:2.25rem;margin-top:5rem;margin-bottom:1.25rem}h2{font-size:1.47656rem;line-height:1.875rem}h2,h3{margin-top:2.5rem;margin-bottom:.625rem}h3{font-size:1.20313rem;line-height:1.25rem}h4{font-size:1.05rem;margin-top:1.875rem}h4,h5{line-height:1.25rem;margin-bottom:.625rem}h5,h6{font-size:.875rem;margin-top:3.125rem}h6{line-height:1.25rem;margin-bottom:.625rem}img{max-width:100%;margin:inherit auto}hr,img{border:0;display:block}hr{color:#222;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);width:6.25rem}a{color:#918d40;text-decoration:none}a:active,a:focus,a:hover{color:#a9d159}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.25rem}ul li{padding:0 .3125rem;margin-bottom:.625rem}p{line-height:1.25rem;margin-bottom:1.25rem}blockquote{font-style:italic;text-align:center;background-color:#f5f5f5;padding:.1875rem .625rem}figure{display:block;width:100%;height:auto}figcaption{line-height:.9375rem;margin-top:.3125rem;color:#222;font-size:.75rem;font-style:italic;margin-bottom:0;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.25rem}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}li>code[class*=language-text],p>code[class*=language-text]{background:#f9f9f9!important;color:#2d2d2d!important}.Author-module--author__photo--36xCH{display:inline-block;margin-bottom:0;border-radius:50%;background-clip:padding-box}.Author-module--author__title--2CaTb{font-size:.98438rem;font-weight:600;line-height:1.40625rem;margin:.625rem 0}.Author-module--author__title-link--Yrism,.Author-module--author__title-link--Yrism:focus,.Author-module--author__title-link--Yrism:hover{color:#222}.Author-module--author__subtitle--cAaEB{color:#888;line-height:1.25rem;margin-bottom:1.25rem}.Icon-module--icon--Gpyvw{display:inline-block;width:1em;height:1em;stroke-width:0;stroke:currentColor;fill:currentColor;font-style:normal;font-weight:400;speak:none;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.Contacts-module--contacts--1rGd1{margin-bottom:1.25rem}.Contacts-module--contacts__list--3OgdW{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;padding:0;margin:.625rem -.1875rem;width:8.75rem}.Contacts-module--contacts__list-item--16p9q{padding:0;margin:.25rem;display:flex;align-content:center;align-items:center;justify-content:center;height:2.1875rem;width:2.1875rem;line-height:2.1875rem;border-radius:50%;text-align:center;border:1px solid #ebebeb}.Contacts-module--contacts__list-item-link--2MIDn{border:0;display:flex;color:#222}.Contacts-module--contacts__list-item-link--2MIDn:focus,.Contacts-module--contacts__list-item-link--2MIDn:hover{color:#918d40}.Copyright-module--copyright--1ariN{color:#b6b6b6;font-size:.75rem}.Menu-module--menu--Efbin{margin-bottom:1.25rem}.Menu-module--menu__list--31Zeo{list-style:none;padding:0;margin:0}.Menu-module--menu__list-item--1lJ6B{padding:0;margin:.625rem 0}.Menu-module--menu__list-item-link--10Ush{font-size:.875rem;color:#222;font-weight:400;border:0}.Menu-module--menu__list-item-link--10Ush:focus,.Menu-module--menu__list-item-link--10Ush:hover{color:#918d40;border-bottom:1px solid #918d40}.Menu-module--menu__list-item-link--active--2CbUO{color:#222;border-bottom:1px solid #222}.Sidebar-module--sidebar--X4z2p{width:100%}.Sidebar-module--sidebar__inner--Jdc5s{position:relative;padding:1.5625rem 1.25rem 0}.Sidebar-module--headerimage--19Rdy{width:100%;min-height:70px;max-height:120px;margin:0 0 .625rem}.Sidebar-module--logo-image--XDYae{min-height:70px;max-height:120px;margin:0 auto}input{-webkit-appearance:none;-moz-appearance:none;appearance:none;padding:.625rem;margin:.3125rem 0;border:1px solid #999;border-radius:.3125rem}.Sidebar-module--search-container--17C6F{position:relative}.Sidebar-module--search-container-input--27Tw4{width:100%}.Sidebar-module--search-container-submit--WwtLg{position:absolute;width:2.375rem;height:2.375rem;top:calc(50% - 19px);right:0;border:3px solid #999;border-radius:0 .25rem .25rem 0;background:#999}.Sidebar-module--search-container-submit--WwtLg:before{position:absolute;content:"";width:.9375rem;height:.9375rem;top:calc(50% - 9px);left:calc(50% - 9px);border-radius:50%;box-shadow:0 0 0 2px #fff}.Sidebar-module--search-container-submit--WwtLg:after{position:absolute;content:"";width:.5rem;height:.375rem;top:calc(50% + 6px);left:calc(50% + 2px);border-top:2px solid #fff;transform:rotate(45deg)}@media screen and (min-width:685px){.Sidebar-module--sidebar--X4z2p{width:calc(41.625% - 1.09375rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(12n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--Jdc5s:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);position:absolute;content:"";width:.0625rem;height:33.75rem;top:30px;right:-10px;bottom:0}}@media screen and (min-width:960px){.Sidebar-module--sidebar--X4z2p{width:calc(33.3% - 1.25rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(3n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:2.5rem}}.Layout-module--layout--3Pyz6{max-width:66.875rem;margin-left:auto;margin-right:auto}.Layout-module--layout--3Pyz6:before{content:"";display:table}.Layout-module--layout--3Pyz6:after{content:"";display:table;clear:both}.Feed-module--feed__item--2D5rE{margin-bottom:1.5625rem}.Feed-module--feed__item--2D5rE:last-child{margin-bottom:.625rem}.Feed-module--feed__item-title--3nigr{font-size:1.47656rem;line-height:1.875rem;margin-top:0;margin-bottom:.625rem}.Feed-module--feed__item-title-link--iFMRs{color:#222}.Feed-module--feed__item-title-link--iFMRs:focus,.Feed-module--feed__item-title-link--iFMRs:hover{color:#222;border-bottom:1px solid #222}.Feed-module--feed__item-description--1uO8e{font-size:.875rem;line-height:1.25rem;margin-bottom:.9375rem}.Feed-module--feed__item-meta-time--3t1fg{font-size:.75rem;color:#222;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--N-Q0A{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--23f8F{font-size:.75rem;color:#a9d159;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--23f8F:focus,.Feed-module--feed__item-meta-category-link--23f8F:hover{color:#918d40}.Feed-module--feed__item-readmore--1u6bI{font-size:.875rem;color:#918d40}.Feed-module--feed__item-readmore--1u6bI:focus,.Feed-module--feed__item-readmore--1u6bI:hover{color:#918d40;border-bottom:1px solid #918d40}.Page-module--page--2nMky{margin-bottom:2.5rem}.Page-module--page__inner--2M_vz{padding:1.5625rem 1.25rem}.Page-module--page__title--GPD8L{font-size:1.575rem;font-weight:600;line-height:2.5rem;margin-top:0;margin-bottom:1.8125rem}.Page-module--page__body--Ic6i6{font-size:.875rem;line-height:1.25rem;margin:0 0 1.25rem}@media screen and (min-width:685px){.Page-module--page--2nMky{width:calc(58.275% - .78125rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(12n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(12n+1){clear:both}.Page-module--page__inner--2M_vz{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--2nMky{width:calc(66.6% - .625rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(3n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(3n+1){clear:both}.Page-module--page__inner--2M_vz{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--2H3nO{margin-top:2.5rem;display:flex}.Pagination-module--pagination__prev--bet5s{width:50%;text-align:left}.Pagination-module--pagination__prev-link--1Nzs6{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--1Nzs6:focus,.Pagination-module--pagination__prev-link--1Nzs6:hover{color:#918d40}.Pagination-module--pagination__prev-link--disable--Yklx9{pointer-events:none;color:#bbb}.Pagination-module--pagination__next--3hFiN{width:50%;text-align:right}.Pagination-module--pagination__next-link--3FUtA{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--3FUtA:focus,.Pagination-module--pagination__next-link--3FUtA:hover{color:#918d40}.Pagination-module--pagination__next-link--disable--30UwZ{pointer-events:none;color:#bbb}.Author-module--author--2Yefr{border-top:1px solid #e6e6e6;max-width:43.75rem;padding-top:1.25rem;line-height:1.25rem;margin-top:1.25rem;margin-bottom:2.5rem}.Author-module--author__bio-twitter--n-O9n{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2Yefr{margin-left:auto;margin-right:auto}}.Content-module--content--3p512{max-width:62.8125rem;padding:0 .9375rem;margin:0 auto}.Content-module--content__title--2BDW9{font-size:1.75rem;max-width:43.75rem;font-weight:600;text-align:center;line-height:2.0625rem;margin:1.25rem auto 0}.Content-module--content__body--2TrQ- figure{margin-bottom:1.25rem}.Content-module--content__body--2TrQ- figure blockquote{font-style:italic;text-align:center;margin-top:0;padding:1.25rem 0}.Content-module--content__body--2TrQ- figure blockquote p{max-width:43.75rem;font-size:1.47149rem;margin-top:1.25rem;margin-bottom:1.25rem;line-height:1.875rem}.Content-module--content__body--2TrQ- a{text-decoration:underline}.Content-module--content__body--2TrQ- *{max-width:43.75rem;margin-left:auto;margin-right:auto}.Content-module--content__body--2TrQ- img{max-width:100%;margin-top:.625rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- li ul{margin-bottom:.625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- h2{position:relative;padding:1rem 1.5rem;color:#fff;border-radius:.625rem;background:#0c0000}.Content-module--content__body--2TrQ- h2:after{position:absolute;bottom:-9px;left:1rem;width:0;height:0;content:"";border-color:#0c0000 transparent transparent;border-style:solid;border-width:10px 10px 0}.Content-module--content__body--2TrQ- h3{border-bottom:3px dotted #0c0000;padding:1rem 0}@media screen and (min-width:960px){.Content-module--content--3p512{padding:0}.Content-module--content__title--2BDW9{font-size:1.75rem;line-height:2.8125rem;margin-top:2.8125rem;margin-bottom:1.875rem}.Content-module--content__body--2TrQ-,.Content-module--content__body--2TrQ- p{font-size:.98438rem;line-height:1.40625rem;margin-bottom:1.40625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}}.Meta-module--meta__date--29eD7{font-style:italic}.Tags-module--tags--1L_ct{margin-bottom:.625rem}.Tags-module--tags__list--91FqN{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--1M30P{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3SL_8{display:inline-block;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;border:1px solid #e6e6e6;text-decoration:none;border-radius:1.25rem;color:#222}.Tags-module--tags__list-item-link--3SL_8:focus,.Tags-module--tags__list-item-link--3SL_8:hover{color:#918d40}.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{max-width:43.75rem;margin:0 auto;padding:0 .9375rem}.Post-module--post__home-button--16Kl0{display:block;max-width:5.625rem;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;text-align:center;color:#222;border:1px solid #e6e6e6;border-radius:1.25rem;font-size:.875rem;font-weight:400;margin-left:auto;margin-right:auto;margin-top:1.25rem}.Post-module--post__home-button--16Kl0:focus,.Post-module--post__home-button--16Kl0:hover{color:#918d40}@media screen and (min-width:960px){.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{padding:0}.Post-module--post__home-button--16Kl0{position:fixed;max-width:auto;margin:0;top:30px;left:30px}}</style><meta name="generator" content="Gatsby 2.32.13"/><link rel="alternate" type="application/rss+xml" title="かえるのひみつきち" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-122086587-6"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-122086587-6', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#F7A046"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><title data-react-helmet="true">angr のフック機能を使い、非想定解で Flag を取りに行く in X&#x27;mas Eve - かえるのひみつきち</title><meta data-react-helmet="true" name="description" content="angr のフック機能で処理をオーバーライドすることで、動的解析対策を回避して Flag を取得します。"/><meta data-react-helmet="true" property="og:site_name" content="angr のフック機能を使い、非想定解で Flag を取りに行く in X&#x27;mas Eve - かえるのひみつきち"/><meta data-react-helmet="true" property="og:image" content="https://kashiwaba-yuki.com/static/6d14aee85f354f54bee0c17ff2ad6c62/ctf-angr-hooking.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="angr のフック機能を使い、非想定解で Flag を取りに行く in X&#x27;mas Eve - かえるのひみつきち"/><meta data-react-helmet="true" name="twitter:description" content="angr のフック機能で処理をオーバーライドすることで、動的解析対策を回避して Flag を取得します。"/><meta data-react-helmet="true" name="twitter:image" content="https://kashiwaba-yuki.com/static/6d14aee85f354f54bee0c17ff2ad6c62/ctf-angr-hooking.png"/><link as="script" rel="preload" href="/webpack-runtime-a3c0f166cb4b802ff58f.js"/><link as="script" rel="preload" href="/framework-3761df4ab6ee9f056936.js"/><link as="script" rel="preload" href="/532a2f07-92db97c0addf07d5cb73.js"/><link as="script" rel="preload" href="/dc6a8720040df98778fe970bf6c000a41750d3ae-84d7c7f527ea24afde0e.js"/><link as="script" rel="preload" href="/app-f5b45fb557768b3cf36f.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-js-381c1b847824134fa4bd.js"/><link as="fetch" rel="preload" href="/page-data/ctf-angr-hooking/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/251939775.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/401334301.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/825871152.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--3Pyz6"><div><a class="Post-module--post__home-button--16Kl0" href="/">All Articles</a><div><div class="Content-module--content--3p512"><h1 class="Content-module--content__title--2BDW9">angr のフック機能を使い、非想定解で Flag を取りに行く in X&#x27;mas Eve</h1><div class="Content-module--content__body--2TrQ-"><p>この記事は <a href="https://adventar.org/calendars/9245" target="_blank" rel="nofollow noopener noreferrer">CTF Advent Calendar 2023</a> 用の記事として作成しました。</p>
<p>前回の記事は Edwow Math(N30Z30N) さんの「<a href="https://m5453.hatenablog.com/entry/2023/12/22/062638" target="_blank" rel="nofollow noopener noreferrer">良いCTF・悪いCTF・普通のCTF（for CTF Advent Calendar 2023） - Learning cyber security by playing and enjoying CTFs</a>」でした、</p>
<p>次回の記事は、、、残念ながら今のところ記載予定の方がいらっしゃらないようですので割愛します。。</p>
<p>今回は angr で任意のシンボル関数をフックしてその処理を一部変更したり処理をオーバーライドしたりする操作を試してみます。</p>
<!-- omit in toc -->
<h2 id="もくじ" style="position:relative;"><a href="#%E3%82%82%E3%81%8F%E3%81%98" aria-label="もくじ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>もくじ</h2>
<ul>
<li>
<p><a href="#angr-%E3%81%AE-hook_symbol-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E4%BD%BF%E3%81%86">angr の hook_symbol メソッドを使う</a></p>
<ul>
<li><a href="#angr-%E3%81%A7%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%AE%E6%88%BB%E3%82%8A%E5%80%A4%E3%82%92%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E3%83%A9%E3%82%A4%E3%83%89%E3%81%97%E3%81%A6-flag-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B">angr でシンボル関数の戻り値をオーバーライドして Flag を取得する</a></li>
<li><a href="#%E9%9D%99%E7%9A%84%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%95%E3%82%8C%E3%81%9F%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E6%95%B0%E3%81%AE%E5%87%A6%E7%90%86%E3%82%92%E7%BD%AE%E3%81%8D%E6%8F%9B%E3%81%88%E3%82%8B">静的リンクされたライブラリ関数の処理を置き換える</a></li>
</ul>
</li>
<li>
<p><a href="#angr-%E3%81%AE-hook-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E4%BD%BF%E3%81%86">angr の hook メソッドを使う</a></p>
<ul>
<li><a href="#hook-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A7%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%82%92%E6%9B%B8%E3%81%8D%E6%8F%9B%E3%81%88%E3%82%8B">hook メソッドで特定のレジスタを書き換える</a></li>
</ul>
</li>
<li>
<p><a href="#hook_symbol-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6-ctf-%E3%81%AE%E5%95%8F%E9%A1%8C%E3%82%92%E8%A7%A3%E3%81%8F">hook_symbol を使用して CTF の問題を解く</a></p>
<ul>
<li><a href="#angr-%E3%81%A7-sop-%E3%81%AE-flag-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">angr で SOP の Flag を取得する方法</a></li>
<li><a href="#%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%81%AE%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86">バイナリの解析を行う</a></li>
<li><a href="#hook_symbol-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6-solvar-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">hook_symbol を使用して Solvar を作成する</a></li>
</ul>
</li>
<li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li>
</ul>
<h2 id="angr-の-hook_symbol-メソッドを使う" style="position:relative;"><a href="#angr-%E3%81%AE-hook_symbol-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E4%BD%BF%E3%81%86" aria-label="angr の hook_symbol メソッドを使う permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>angr の hook_symbol メソッドを使う</h2>
<p>angr では hook_symbol メソッドを使うことで特定のシンボル関数をフックすることができます。</p>
<p>hook_symbol によりシンボル関数をオーバーライドする基本的な方法は、<code class="language-text">angr.SimProcedure</code> クラスを継承した任意のクラスを作成し、その中の run メソッドをフックしたい関数のシンボル名を指定して呼び出すことです。</p>
<p>この時、run メソッドには任意の引数を与えることもできます。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> angr <span class="token keyword">import</span> Project<span class="token punctuation">,</span> SimProcedure
project <span class="token operator">=</span> Project<span class="token punctuation">(</span><span class="token string">'examples/fauxware/fauxware'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">BugFree</span><span class="token punctuation">(</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Program running with argc=%s and argv=%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token keyword">return</span> <span class="token number">0</span>

<span class="token comment"># this assumes we have symbols for the binary</span>
project<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">,</span> BugFree<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Run a quick execution!</span>
simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span><span class="token punctuation">)</span>
simgr<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>参考：<a href="https://docs.angr.io/en/latest/extending-angr/simprocedures.html" target="_blank" rel="nofollow noopener noreferrer">Hooks and SimProcedures - angr documentation</a></p>
<p>SimProcedures と hook_symbol  を使用すると、例えば任意の関数やライブラリ関数の動作などをオーバーライドして Flag を取得できるようになります。</p>
<h3 id="angr-でシンボル関数の戻り値をオーバーライドして-flag-を取得する" style="position:relative;"><a href="#angr-%E3%81%A7%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%AE%E6%88%BB%E3%82%8A%E5%80%A4%E3%82%92%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E3%83%A9%E3%82%A4%E3%83%89%E3%81%97%E3%81%A6-flag-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B" aria-label="angr でシンボル関数の戻り値をオーバーライドして flag を取得する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>angr でシンボル関数の戻り値をオーバーライドして Flag を取得する</h3>
<p>初めに、以下のような C のコードで作成したバイナリを angr で解析して Flag を取得してみます。</p>
<p>以下のコードをコンパイルしたプログラムは、標準入力として文字列を受け取り、受け取った文字列が <code class="language-text">Flag{angr}</code> であり、かつ rand() 関数で生成した数値が 0x12345 の場合にのみ Success というテキストを出力するプログラムです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// gcc sample1.c -o chal.bin</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> flag<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%15s"</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token string">"Flag{angr}"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x12345</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>普通に実行しても rand() 関数の戻り値が 0x12345 ちょうどになることはまずないため、出力は常に Failed になります。</p>
<p>つまり、rand() 関数の戻り値が 0x12345 ちょうどになるという制約を満たさない限り、angr で正しい Flag を特定することができません。</p>
<p>このような場合には、以下のようなスクリプトで rand 関数をフックして戻り値を 0x12345 にオーバーライドすると Flag を取得できます。</p>
<p>以下の例では、flag というシンボル変数で定義したベクタを標準入力としてセットしたあと、hook_symbol メソッドで rand 関数のオーバーライドを行うことで、正しい Flag が <code class="language-text">Flag{angr}</code> であることを簡単に特定できます。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> angr
<span class="token keyword">import</span> claripy
<span class="token keyword">from</span> logging <span class="token keyword">import</span> getLogger<span class="token punctuation">,</span> WARN

getLogger<span class="token punctuation">(</span><span class="token string">"angr"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>WARN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">OverrideFunction</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x12345</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>data<span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">'big'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">correct</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">b"Success"</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">failed</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">b"Failed"</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

flag <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">,</span> explicit_name<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">"./chal.bin"</span><span class="token punctuation">,</span> load_options<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"auto_load_libs"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span>stdin<span class="token operator">=</span>flag<span class="token punctuation">)</span>
simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>correct<span class="token punctuation">,</span> avoid<span class="token operator">=</span>failed<span class="token punctuation">)</span>

proj<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"rand"</span><span class="token punctuation">,</span> OverrideFunction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    found <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># print(found.posix.dumps(0))</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>found<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Not Found"</span><span class="token punctuation">)</span></code></pre></div>
<p>参考：<a href="https://ptr-yudai.hatenablog.com/entry/2019/08/17/223044" target="_blank" rel="nofollow noopener noreferrer">angrをいろいろ使ってみる【yoshi-camp備忘録】 - CTFするぞ</a></p>
<p>ここでは、rand 関数が OverrideFunction クラスの run メソッドで定義された内容に置き換えられるそうです。</p>
<p>戻り値として整数を返す場合は、任意の整数を big エンディアン化したベクタにする必要があるようでしたので、以下のコードで 0x12345 という整数を big エンディアン形式のバイト列に変換した後、さらにそれを整数に置き換えてベクタを作成しています。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x12345</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>data<span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">'big'</span><span class="token punctuation">)</span>
claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></code></pre></div>
<p>これを実行すると、最終的に Success が出力された際のシンボル変数 flag がダンプされ、正しい Flag を特定できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 942px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/7dfe0772dd51c8c24d1a1527959380a8/f1901/image-20231223053728661.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 5.416666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAN0lEQVQI12OwUTZ10LV10LRyVLGxU7a3V7Z1ULGzlLW0kjRykDGxkzZ2lDMzFdDS51Q24FJBQwBaegonOf84oAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/7dfe0772dd51c8c24d1a1527959380a8/8ac56/image-20231223053728661.webp 240w,
/static/7dfe0772dd51c8c24d1a1527959380a8/d3be9/image-20231223053728661.webp 480w,
/static/7dfe0772dd51c8c24d1a1527959380a8/2fa1f/image-20231223053728661.webp 942w"
              sizes="(max-width: 942px) 100vw, 942px"
              type="image/webp"
            />
          <source
            srcset="/static/7dfe0772dd51c8c24d1a1527959380a8/8ff5a/image-20231223053728661.png 240w,
/static/7dfe0772dd51c8c24d1a1527959380a8/e85cb/image-20231223053728661.png 480w,
/static/7dfe0772dd51c8c24d1a1527959380a8/f1901/image-20231223053728661.png 942w"
            sizes="(max-width: 942px) 100vw, 942px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/7dfe0772dd51c8c24d1a1527959380a8/f1901/image-20231223053728661.png"
            alt="image-20231223053728661"
            title="image-20231223053728661"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="静的リンクされたライブラリ関数の処理を置き換える" style="position:relative;"><a href="#%E9%9D%99%E7%9A%84%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%95%E3%82%8C%E3%81%9F%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E9%96%A2%E6%95%B0%E3%81%AE%E5%87%A6%E7%90%86%E3%82%92%E7%BD%AE%E3%81%8D%E6%8F%9B%E3%81%88%E3%82%8B" aria-label="静的リンクされたライブラリ関数の処理を置き換える permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>静的リンクされたライブラリ関数の処理を置き換える</h3>
<p>angr には、libc などの一般的なライブラリ関数の代替機能がバンドルされているようです。</p>
<p>angr のドキュメントによると、angr ではこれを使用して libc などの代替を行うことで、動的リンクされたプログラムも正常に解析できるようになっています。</p>
<p>参考：<a href="https://docs.angr.io/en/latest/extending-angr/environment.html" target="_blank" rel="nofollow noopener noreferrer">Extending the Environment Model - angr documentation</a></p>
<p>ここで、以下のブログ記事には、バイナリにライブラリ関数が静的リンクされている場合は、リンクされたライブラリ関数まで angr が解析することで、処理が遅延することについて言及されています。</p>
<p>このような場合には、hook_symbol メソッドでライブラリ関数のシンボルと前述の angr にバンドルされたライブラリ関数の代替機能を紐づけてあげることで解析処理の高速化が可能なようです。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">p<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"__libc_start_main"</span><span class="token punctuation">,</span> angr<span class="token punctuation">.</span>SIM_PROCEDURES<span class="token punctuation">[</span><span class="token string">"glibc"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"__libc_start_main"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"printf"</span><span class="token punctuation">,</span> angr<span class="token punctuation">.</span>procedures<span class="token punctuation">.</span>libc<span class="token punctuation">.</span>printf<span class="token punctuation">.</span>printf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"__isoc99_scanf"</span><span class="token punctuation">,</span> angr<span class="token punctuation">.</span>procedures<span class="token punctuation">.</span>libc<span class="token punctuation">.</span>scanf<span class="token punctuation">.</span>scanf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"strcmp"</span><span class="token punctuation">,</span> angr<span class="token punctuation">.</span>procedures<span class="token punctuation">.</span>libc<span class="token punctuation">.</span>strcmp<span class="token punctuation">.</span>strcmp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">,</span> angr<span class="token punctuation">.</span>procedures<span class="token punctuation">.</span>libc<span class="token punctuation">.</span>puts<span class="token punctuation">.</span>puts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>参考：<a href="https://ptr-yudai.hatenablog.com/entry/2019/08/17/223044" target="_blank" rel="nofollow noopener noreferrer">angrをいろいろ使ってみる【yoshi-camp備忘録】 - CTFするぞ</a></p>
<h2 id="angr-の-hook-メソッドを使う" style="position:relative;"><a href="#angr-%E3%81%AE-hook-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E4%BD%BF%E3%81%86" aria-label="angr の hook メソッドを使う permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>angr の hook メソッドを使う</h2>
<p>前述の SimProcedure を使用する場合、解析時には関数全体がフックされるようです。 </p>
<p>一方で、user hook を使用すると、コードの特定の箇所をフックしてレジスタの置き換えなどを行うことができるようになります。</p>
<p>参考：<a href="https://docs.angr.io/en/latest/extending-angr/simprocedures.html#user-hooks" target="_blank" rel="nofollow noopener noreferrer">Hooks and SimProcedures - angr documentation</a></p>
<h3 id="hook-メソッドで特定のレジスタを書き換える" style="position:relative;"><a href="#hook-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A7%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%82%92%E6%9B%B8%E3%81%8D%E6%8F%9B%E3%81%88%E3%82%8B" aria-label="hook メソッドで特定のレジスタを書き換える permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hook メソッドで特定のレジスタを書き換える</h3>
<p>実際に以下のコードをコンパイルしたバイナリで angr の hook メソッドを試していきます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// gcc sample2.c -o chal.bin</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>

<span class="token keyword">int</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> v <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> flag<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%15s"</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token string">"Flag{angr}"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>上記のプログラムは、入力された文字列が <code class="language-text">Flag{angr}</code> であるかを検証しますが、変数 v の値が 1 以外の場合には正しい Flag を入力していても <code class="language-text">Success</code> が出力されません。</p>
<p>そして、変数 v は func 関数によって常に 0 になります。</p>
<p>このようなバイナリの Flag を angr で取得したい場合には、もちろん先ほどと同じように hook_symbol メソッドで func 関数のオーバーライドを行うことで実現できそうです。</p>
<p>ただし、今回はあえて関数のすべての処理をオーバーライドしてしまわないように、hook メソッドで戻り値の eax レジスタのみを書き換えて Flag を取得したいと思います。</p>
<p>まずは事前に objdmp コマンドなどで、func 関数の戻り値を変数 v に格納するコードのアドレスを確認します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">11d8:       e8 cc ff ff ff          call   11a9 <span class="token operator">&lt;</span>func<span class="token operator">></span>
11dd:       <span class="token number">89</span> <span class="token number">45</span> <span class="token function">dc</span>                mov    %eax,-0x24<span class="token punctuation">(</span>%rbp<span class="token punctuation">)</span></code></pre></div>
<p>続いて、以下のスクリプトを使用して hook メソッドで戻り値の eax レジスタのみを書き換えることで Flag を取得します。</p>
<p>以下のコードは先ほどのコードと類似していますが、func 関数を呼び出すアドレス 0x4011d8 から 5 バイト分の処理をオーバーライドして、eax レジスタの値を 1 にセットした後、0x4011dd 以降の処理を再開させています。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> angr
<span class="token keyword">import</span> claripy
<span class="token keyword">from</span> logging <span class="token keyword">import</span> getLogger<span class="token punctuation">,</span> WARN

getLogger<span class="token punctuation">(</span><span class="token string">"angr"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>WARN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">correct</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">b"Success"</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">failed</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">b"Failed"</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

flag <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">,</span> explicit_name<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">"./chal.bin"</span><span class="token punctuation">,</span> load_options<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"auto_load_libs"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@proj<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x4011d8</span><span class="token punctuation">,</span> length<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">set_eax</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> <span class="token number">1</span>

state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span>stdin<span class="token operator">=</span>flag<span class="token punctuation">)</span>
simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>correct<span class="token punctuation">,</span> avoid<span class="token operator">=</span>failed<span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    found <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># print(found.posix.dumps(0))</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>found<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Not Found"</span><span class="token punctuation">)</span></code></pre></div>
<p>このスクリプトを実行することで、<code class="language-text">v == 1</code> の検証を突破することができるようになるので、angr で正しい Flag を取得することができました。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 614px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/8a8746212af4464de374f358e9e2e9ec/e9131/image-20231223230810007.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 7.916666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiklEQVQI1yXIwQqCQABFUX/AiCDIhNplKjTTjKIOFikEaZKJ5qL//4+b2OJwec9SQYTy9CzbRchNhtikSDdHOBnniXDMTG4N4Tqh8gve4s4Q1zwOF5qw4Jt3PIMbVm8axrylOpWM5sWQtrSq4mO6qTX9tP9fPVfaR66uptwnKNtDT+KlT7IK0QuPH203QXvAAUXuAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/8a8746212af4464de374f358e9e2e9ec/8ac56/image-20231223230810007.webp 240w,
/static/8a8746212af4464de374f358e9e2e9ec/d3be9/image-20231223230810007.webp 480w,
/static/8a8746212af4464de374f358e9e2e9ec/5316f/image-20231223230810007.webp 614w"
              sizes="(max-width: 614px) 100vw, 614px"
              type="image/webp"
            />
          <source
            srcset="/static/8a8746212af4464de374f358e9e2e9ec/8ff5a/image-20231223230810007.png 240w,
/static/8a8746212af4464de374f358e9e2e9ec/e85cb/image-20231223230810007.png 480w,
/static/8a8746212af4464de374f358e9e2e9ec/e9131/image-20231223230810007.png 614w"
            sizes="(max-width: 614px) 100vw, 614px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/8a8746212af4464de374f358e9e2e9ec/e9131/image-20231223230810007.png"
            alt="image-20231223230810007"
            title="image-20231223230810007"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h2 id="hook_symbol-を使用して-ctf-の問題を解く" style="position:relative;"><a href="#hook_symbol-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6-ctf-%E3%81%AE%E5%95%8F%E9%A1%8C%E3%82%92%E8%A7%A3%E3%81%8F" aria-label="hook_symbol を使用して ctf の問題を解く permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hook_symbol を使用して CTF の問題を解く</h2>
<p>最後に、angr の hook_symbol メソッドを使用して CTF の問題を解いていきます。</p>
<p>今回 angr を使用して解く問題は、Gracier CTF 2023 の SOP という問題です。</p>
<p>参考：<a href="/ctf-gracier-2023#soprev">Gracier CTF 2023 Writeup SOP(Rev)</a></p>
<p>この問題自体は SOP(おそらく Signal Oriented Programming もしくは Sigreturn Oriented Programming) をテーマにしている問題で、main 関数の処理の終了時に例外を発生させるところから始まり、signal 関数で定義したハンドラ関数を raise 関数で次々に呼び出しています。</p>
<p>プログラムの実際の動作(入力値が正しい Flag であるか否かの検証)は main 関数の終了後の例外発生から始まるので、gdb を普通に使用しても動的解析を行うことができず、Frida hook や静的解析で Flag を特定する必要がある問題でした。</p>
<p>今回は、この問題の別解として、angr の hook_symbol によって signal 関数や raise 関数の処理をオーバーライドすることで、実際のバイナリの挙動を無視して正しい Flag を取得する方法を実践していきます。</p>
<h3 id="angr-で-sop-の-flag-を取得する方法" style="position:relative;"><a href="#angr-%E3%81%A7-sop-%E3%81%AE-flag-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95" aria-label="angr で sop の flag を取得する方法 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>angr で SOP の Flag を取得する方法</h3>
<p>今回のバイナリは、入力値として受け取った文字列が正しい Flag に一致するかどうかを検証するプログラムです。</p>
<p>そのため、通常であれば angr の SimulationManager によって比較的容易に解けるタイプの問題です。</p>
<p>ただし、このバイナリの Flag 検証処理は main 関数の終了後の例外から始まり、signal 関数で定義したハンドラ関数をたどっていく方式で実装されているため、ただ SimulationManager を走らせるだけでは解くことができません。</p>
<p>そこで、Ghidra でバイナリを解析して raise 関数の引数として渡されるシグナル番号と、バイナリ内で定義されているハンドラ関数の対応を特定した上で、hook_symbol メソッドによりプログラムの処理をオーバーライドすることで SimulationManager による Flag の特定を行います。</p>
<p>これによって、angr で signal 関数や raise 関数の処理を実際に解析する必要はなくなり、正しい Flag を簡単に特定できるようになります。</p>
<h3 id="バイナリの解析を行う" style="position:relative;"><a href="#%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%81%AE%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86" aria-label="バイナリの解析を行う permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>バイナリの解析を行う</h3>
<p>angr を使用した Solver を作成するために、事前に Ghidra を使用して Flag の取得に必要な情報を特定しておきます。</p>
<p>まず、main 関数では read 関数で標準入力から 0x44 バイト分の入力を受け取っており、<code class="language-text">DAT_001061c8 != 0x44</code> で比較を行った結果を返却していることがわかります。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">bool <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">size_t</span> sVar1<span class="token punctuation">;</span>
  <span class="token class-name">ssize_t</span> sVar2<span class="token punctuation">;</span>
  
  sVar1 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_001060f0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  DAT_001061c8 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>sVar1<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>DAT_001061c8 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sVar2 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>DAT_001060f0<span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    DAT_001061c8 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>sVar2<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> DAT_001061c8 <span class="token operator">!=</span> <span class="token number">0x44</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>この main 関数は <code class="language-text">__libc_start_main</code> から呼び出されていますが、<code class="language-text">__libc_start_main</code> で呼び出した main 関数の戻り値はそのまま exit 関数に渡されます。</p>
<p>参考：<a href="https://refspecs.linuxbase.org/LSB_3.1.1/LSB-Core-generic/LSB-Core-generic/baselib---libc-start-main-.html" target="_blank" rel="nofollow noopener noreferrer">_<em>libc</em>start_main</a></p>
<p>つまり、入力した文字数が<code class="language-text">DAT_001061c8 != 0x44</code> の比較が False になった場合、プログラムは異常終了したとみなされ、最初のトリガーとなる例外が発生することがわかります。</p>
<p>次に、シグナル番号とハンドラ関数の対応を特定します。</p>
<p>Ghidra で一通りの関数のデコンパイル結果を見ていくと、以下の signal 関数の定義が行われていることを確認できます。</p>
<p>なぜか SIGSEGV(0xb) のハンドラ関数を設定する箇所が複数存在していますが、ここでは動的なハンドラ関数の変更が行われていそうです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0xb</span><span class="token punctuation">,</span>FUN_001011e0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0xb</span><span class="token punctuation">,</span>FUN_00101bc0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0xb</span><span class="token punctuation">,</span>FUN_00102e60<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0xe</span><span class="token punctuation">,</span>FUN_00101bc0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span>FUN_00101350<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">,</span>FUN_001014a0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">,</span>FUN_00102fb0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0x15</span><span class="token punctuation">,</span>FUN_00101550<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0x16</span><span class="token punctuation">,</span>FUN_00102520<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>続けて、正しい Flag や誤った Flag を入力した場合の結果を特定します。</p>
<p>これは適当にプログラムを実行してみると <code class="language-text">FAIL</code> という文字列が出力されることから容易に特定できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 487px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/375a152cf38af44a74a1d68e29bc4bc6/7b439/image-20231224003011199.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 86.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAACSUlEQVQ4y41Ua3ObMBD0//9xMcTT6ce2SWxssBB6P3hsF3AS2sRp5bk5CUk7e3sr78qihHQWlbeovceL9RCGa+fQ+IDKOrTOYzumacK9sTscDpA24GcTcOoIZFp0tsOz6nAk+ItxqLRByAEu+Tewe6C7sizQyYzv34CqMvDuiXFGLc/4pa84KYHWR+ho0Hn1H4CPB1gy6boG3gvOWxhvMA498pDQD/nDpS9LLh8f4VyGlAnjNHx6aLqBvAc2+T0WwP2+QN9nODtBqYQYJVJSiMHAMkQUiDluoO+PGXT3QMCU1rJUN+JyHtDIK476Cc/ihNOxgVM9xgT0YcJA7Dn6AIwZb+tx2DB8BQw8pHRPRmnhkt0EdwJiCyQ1IQjO5cT5nOf9NceOoDepd0VZIuW8lOP9wKYk5D7eU/KT+V8l74uCACxpGGkfAa01jHbo6MeRdcxdzuz46/1/N4UvJca4aHC5aGrocL0aglZke4SjlS6yhqCdhnH8wzafAhb72TaeOvY4V5oMJbWsCVaz6yfu1TC2WYze6Q4hxQ3Tj7F7eCgWY/e5JRhZGQKoI7x9QbBXfmvhov8vU9+6XMIYPivpIEQLqWo01qC1ArURUFZBmYY6W0rjGAE5m8WrIWhmzbVlQ93KcAYUQtNvfMuXiCdJ/6kGHWWweeBBdp1AmX8Oib5Kkc8x++VbIvOcuJfC0ocbYMFn52BnT1GfcaLwS9DEBjA/AF+vXqS0CNfVe3MmsXUtVpO/GVtKdpWXffC0yrRx2rTx3Nex/EjiN4vXKa1EiOnAAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/375a152cf38af44a74a1d68e29bc4bc6/8ac56/image-20231224003011199.webp 240w,
/static/375a152cf38af44a74a1d68e29bc4bc6/d3be9/image-20231224003011199.webp 480w,
/static/375a152cf38af44a74a1d68e29bc4bc6/9d50c/image-20231224003011199.webp 487w"
              sizes="(max-width: 487px) 100vw, 487px"
              type="image/webp"
            />
          <source
            srcset="/static/375a152cf38af44a74a1d68e29bc4bc6/8ff5a/image-20231224003011199.png 240w,
/static/375a152cf38af44a74a1d68e29bc4bc6/e85cb/image-20231224003011199.png 480w,
/static/375a152cf38af44a74a1d68e29bc4bc6/7b439/image-20231224003011199.png 487w"
            sizes="(max-width: 487px) 100vw, 487px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/375a152cf38af44a74a1d68e29bc4bc6/7b439/image-20231224003011199.png"
            alt="image-20231224003011199"
            title="image-20231224003011199"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span> </p>
<p>上記のように、正しい Flag の場合の出力は <code class="language-text">SUCCESS</code> となり、誤った Flag の場合は <code class="language-text">FAIL</code> が出力されることがわかりました。</p>
<p>また、Flag の検証を実施している箇所のコードをさらに見ていきます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0x40</span> <span class="token operator">&lt;</span> DAT_001061c8<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DAT_001061c8 <span class="token operator">=</span> DAT_001061c8 <span class="token operator">-</span> <span class="token number">0x40</span><span class="token punctuation">;</span>
    DAT_00106210 <span class="token operator">=</span> DAT_00106210 <span class="token operator">+</span> <span class="token number">0x40</span><span class="token punctuation">;</span>
    DAT_001061c0 <span class="token operator">=</span> DAT_001061c0 <span class="token operator">+</span> <span class="token number">0x40</span><span class="token punctuation">;</span>
    <span class="token function">raise</span><span class="token punctuation">(</span><span class="token number">0xb</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>DAT_001061c8 <span class="token operator">&lt;</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>DAT_001061cc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> DAT_001061cc <span class="token operator">&lt;</span> DAT_001061c8<span class="token punctuation">;</span> DAT_001061cc <span class="token operator">=</span> DAT_001061cc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DAT_00106138 <span class="token operator">+</span> <span class="token punctuation">(</span>ulong<span class="token punctuation">)</span>DAT_001061cc<span class="token punctuation">)</span> <span class="token operator">=</span> DAT_00106210<span class="token punctuation">[</span>DAT_001061cc<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
DAT_001060d0 <span class="token operator">=</span> DAT_001061a4<span class="token punctuation">;</span>
DAT_001060d4 <span class="token operator">=</span> DAT_001061ac<span class="token punctuation">;</span>
<span class="token function">memcpy</span><span class="token punctuation">(</span>local_58<span class="token punctuation">,</span><span class="token operator">&amp;</span>DAT_00104050<span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span>local_168<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x110</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
local_16c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>local_16c <span class="token operator">==</span> <span class="token number">0x44</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SUCCESS\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">/* WARNING: Subroutine does not return */</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      local_170 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">getrandom</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>local_170<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      local_170 <span class="token operator">=</span> local_170 <span class="token operator">%</span> <span class="token number">0x44</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>local_168<span class="token punctuation">[</span>local_170<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    local_168<span class="token punctuation">[</span>local_170<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    local_16c <span class="token operator">=</span> local_16c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_00106220<span class="token punctuation">)</span><span class="token punctuation">[</span>local_170<span class="token punctuation">]</span> <span class="token operator">==</span> local_58<span class="token punctuation">[</span>local_170<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"FAIL\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>前半部分は読み飛ばし、以下の箇所に着目します。</p>
<p>ここでは、getrandom 関数で取得したランダムな値を 0x44 で mod した後にその結果を添え字として入力値に何らかの変換を加えた値がハードコードされた検証用のバイト列と一致するかを確認しています。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">do</span> <span class="token punctuation">{</span>
	<span class="token keyword">do</span> <span class="token punctuation">{</span>
<span class="token operator">*</span><span class="token operator">*</span>
      local_170 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">getrandom</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>local_170<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      local_170 <span class="token operator">=</span> local_170 <span class="token operator">%</span> <span class="token number">0x44</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>local_168<span class="token punctuation">[</span>local_170<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

local_168<span class="token punctuation">[</span>local_170<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
local_16c <span class="token operator">=</span> local_16c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token operator">*</span><span class="token operator">*</span>

<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_00106220<span class="token punctuation">)</span><span class="token punctuation">[</span>local_170<span class="token punctuation">]</span> <span class="token operator">==</span> local_58<span class="token punctuation">[</span>local_170<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>恐らく動的解析対策の一環として行われている処理かと思いますが、これも angr での解析を妨害する要因になります。</p>
<p>最後に、<code class="language-text">strace -e trace=signal</code> を使用して、実際にこのプログラムに 0x44 バイト分の文字列を与えた場合のコールバック関数の動作を追っていきます。 </p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token builtin class-name">echo</span> AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA <span class="token operator">|</span> <span class="token function">strace</span> -e <span class="token assign-left variable">trace</span><span class="token operator">=</span>signal ./app
rt_sigaction<span class="token punctuation">(</span>SIGSEGV, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91ed1e0, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>SEGV<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>SIG_DFL, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span>, <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
rt_sigaction<span class="token punctuation">(</span>SIGSTKFLT, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91ed350, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>STKFLT<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>SIG_DFL, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span>, <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
rt_sigaction<span class="token punctuation">(</span>SIGCHLD, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91ed4a0, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>CHLD<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>SIG_DFL, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span>, <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
rt_sigaction<span class="token punctuation">(</span>SIGCONT, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91eefb0, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>CONT<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>SIG_DFL, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span>, <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
--- SIGSEGV <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGSEGV, <span class="token assign-left variable">si_code</span><span class="token operator">=</span>SEGV_MAPERR, <span class="token assign-left variable">si_addr</span><span class="token operator">=</span>0xe91ef160<span class="token punctuation">}</span> ---
tgkill<span class="token punctuation">(</span><span class="token number">29240</span>, <span class="token number">29240</span>, SIGSTKFLT<span class="token punctuation">)</span>         <span class="token operator">=</span> <span class="token number">0</span>
--- SIGSTKFLT <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGSTKFLT, <span class="token assign-left variable">si_code</span><span class="token operator">=</span>SI_TKILL, <span class="token assign-left variable">si_pid</span><span class="token operator">=</span><span class="token number">29240</span>, <span class="token assign-left variable">si_uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">}</span> ---
tgkill<span class="token punctuation">(</span><span class="token number">29240</span>, <span class="token number">29240</span>, SIGCHLD<span class="token punctuation">)</span>           <span class="token operator">=</span> <span class="token number">0</span>
--- SIGCHLD <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGCHLD, <span class="token assign-left variable">si_code</span><span class="token operator">=</span>SI_TKILL, <span class="token assign-left variable">si_pid</span><span class="token operator">=</span><span class="token number">29240</span>, <span class="token assign-left variable">si_uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">}</span> ---
tgkill<span class="token punctuation">(</span><span class="token number">29240</span>, <span class="token number">29240</span>, SIGCONT<span class="token punctuation">)</span>           <span class="token operator">=</span> <span class="token number">0</span>
--- SIGCONT <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGCONT, <span class="token assign-left variable">si_code</span><span class="token operator">=</span>SI_TKILL, <span class="token assign-left variable">si_pid</span><span class="token operator">=</span><span class="token number">29240</span>, <span class="token assign-left variable">si_uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">}</span> ---
rt_sigaction<span class="token punctuation">(</span>SIGSEGV, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91eee60, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>SEGV<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91ed1e0, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>SEGV<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
tgkill<span class="token punctuation">(</span><span class="token number">29240</span>, <span class="token number">29240</span>, SIGSEGV<span class="token punctuation">)</span>           <span class="token operator">=</span> <span class="token number">0</span>
rt_sigreturn<span class="token punctuation">(</span><span class="token punctuation">{</span>mask<span class="token operator">=</span><span class="token punctuation">[</span>SEGV STKFLT CHLD<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
rt_sigreturn<span class="token punctuation">(</span><span class="token punctuation">{</span>mask<span class="token operator">=</span><span class="token punctuation">[</span>SEGV STKFLT<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token operator">=</span> <span class="token number">0</span>
rt_sigreturn<span class="token punctuation">(</span><span class="token punctuation">{</span>mask<span class="token operator">=</span><span class="token punctuation">[</span>SEGV<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>             <span class="token operator">=</span> <span class="token number">0</span>
rt_sigreturn<span class="token punctuation">(</span><span class="token punctuation">{</span>mask<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>                 <span class="token operator">=</span> <span class="token number">0</span>
--- SIGSEGV <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGSEGV, <span class="token assign-left variable">si_code</span><span class="token operator">=</span>SI_TKILL, <span class="token assign-left variable">si_pid</span><span class="token operator">=</span><span class="token number">29240</span>, <span class="token assign-left variable">si_uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">}</span> ---
rt_sigaction<span class="token punctuation">(</span>SIGTTOU, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91ee520, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>TTOU<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>SIG_DFL, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span>, <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
rt_sigaction<span class="token punctuation">(</span>SIGALRM, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91edbc0, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>ALRM<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>SIG_DFL, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span>, <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
rt_sigaction<span class="token punctuation">(</span>SIGTTIN, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91ed550, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>TTIN<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>SIG_DFL, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span>, <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
--- SIGALRM <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGALRM, <span class="token assign-left variable">si_code</span><span class="token operator">=</span>SI_KERNEL<span class="token punctuation">}</span> ---
rt_sigaction<span class="token punctuation">(</span>SIGSEGV, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91edbc0, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>SEGV<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91eee60, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>SEGV<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
tgkill<span class="token punctuation">(</span><span class="token number">29240</span>, <span class="token number">29240</span>, SIGTTIN<span class="token punctuation">)</span>           <span class="token operator">=</span> <span class="token number">0</span>
--- SIGTTIN <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGTTIN, <span class="token assign-left variable">si_code</span><span class="token operator">=</span>SI_TKILL, <span class="token assign-left variable">si_pid</span><span class="token operator">=</span><span class="token number">29240</span>, <span class="token assign-left variable">si_uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">}</span> ---
tgkill<span class="token punctuation">(</span><span class="token number">29240</span>, <span class="token number">29240</span>, SIGTTOU<span class="token punctuation">)</span>           <span class="token operator">=</span> <span class="token number">0</span>
--- SIGTTOU <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGTTOU, <span class="token assign-left variable">si_code</span><span class="token operator">=</span>SI_TKILL, <span class="token assign-left variable">si_pid</span><span class="token operator">=</span><span class="token number">29240</span>, <span class="token assign-left variable">si_uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">}</span> ---
tgkill<span class="token punctuation">(</span><span class="token number">29240</span>, <span class="token number">29240</span>, SIGSEGV<span class="token punctuation">)</span>           <span class="token operator">=</span> <span class="token number">0</span>
rt_sigreturn<span class="token punctuation">(</span><span class="token punctuation">{</span>mask<span class="token operator">=</span><span class="token punctuation">[</span>SEGV ALRM TTIN<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token operator">=</span> <span class="token number">0</span>
rt_sigreturn<span class="token punctuation">(</span><span class="token punctuation">{</span>mask<span class="token operator">=</span><span class="token punctuation">[</span>SEGV ALRM<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token operator">=</span> <span class="token number">0</span>
rt_sigreturn<span class="token punctuation">(</span><span class="token punctuation">{</span>mask<span class="token operator">=</span><span class="token punctuation">[</span>SEGV<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>             <span class="token operator">=</span> -1 EINTR <span class="token punctuation">(</span>Interrupted system call<span class="token punctuation">)</span>
rt_sigreturn<span class="token punctuation">(</span><span class="token punctuation">{</span>mask<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>                 <span class="token operator">=</span> <span class="token number">0</span>
--- SIGSEGV <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGSEGV, <span class="token assign-left variable">si_code</span><span class="token operator">=</span>SI_TKILL, <span class="token assign-left variable">si_pid</span><span class="token operator">=</span><span class="token number">29240</span>, <span class="token assign-left variable">si_uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">}</span> ---
rt_sigaction<span class="token punctuation">(</span>SIGSEGV, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91edbc0, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>SEGV<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token punctuation">{</span>sa_handler<span class="token operator">=</span>0x55a8e91edbc0, <span class="token assign-left variable">sa_mask</span><span class="token operator">=</span><span class="token punctuation">[</span>SEGV<span class="token punctuation">]</span>, <span class="token assign-left variable">sa_flags</span><span class="token operator">=</span>SA_RESTORER<span class="token operator">|</span>SA_RESTART, <span class="token assign-left variable">sa_restorer</span><span class="token operator">=</span>0x7f047a881520<span class="token punctuation">}</span>, <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
tgkill<span class="token punctuation">(</span><span class="token number">29240</span>, <span class="token number">29240</span>, SIGTTIN<span class="token punctuation">)</span>           <span class="token operator">=</span> <span class="token number">0</span>
--- SIGTTIN <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGTTIN, <span class="token assign-left variable">si_code</span><span class="token operator">=</span>SI_TKILL, <span class="token assign-left variable">si_pid</span><span class="token operator">=</span><span class="token number">29240</span>, <span class="token assign-left variable">si_uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">}</span> ---
tgkill<span class="token punctuation">(</span><span class="token number">29240</span>, <span class="token number">29240</span>, SIGTTOU<span class="token punctuation">)</span>           <span class="token operator">=</span> <span class="token number">0</span>
--- SIGTTOU <span class="token punctuation">{</span>si_signo<span class="token operator">=</span>SIGTTOU, <span class="token assign-left variable">si_code</span><span class="token operator">=</span>SI_TKILL, <span class="token assign-left variable">si_pid</span><span class="token operator">=</span><span class="token number">29240</span>, <span class="token assign-left variable">si_uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">}</span> ---
FAIL
+++ exited with <span class="token number">1</span> +++</code></pre></div>
<p>この結果から、最初に main 関数の終了時に SIGSEGV(0xb) が呼ばれており、その時の RVA が 0x11e0 であることがわかります。</p>
<p>さらに、SIGSTKFLT(0x10)、SIGCHLD(0x11)、SIGCONT(0x12) と処理が続いていきます。</p>
<p>全体を通して呼び出されているシグナルは以下でした。</p>
<p>これは、先ほど確認した signal 関数でハンドラ関数が定義されているものと一致しています。(SIGSEGV のハンドラ関数だけは動的に再設定されます)</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">SIGSEGV<span class="token punctuation">(</span>0xb<span class="token punctuation">)</span>
SIGALRM<span class="token punctuation">(</span>0xe<span class="token punctuation">)</span>
SIGSTKFLT<span class="token punctuation">(</span>0x10<span class="token punctuation">)</span>
SIGCHLD<span class="token punctuation">(</span>0x11<span class="token punctuation">)</span>
SIGCONT<span class="token punctuation">(</span>0x12<span class="token punctuation">)</span>
SIGTTIN<span class="token punctuation">(</span>0x15<span class="token punctuation">)</span>
SIGTTOU<span class="token punctuation">(</span>0x16<span class="token punctuation">)</span></code></pre></div>
<p>ここで気になるのは、raise 関数でトリガーされていない SIGALRM が呼び出されている点です。</p>
<p>少々トリッキーな実装ですが、<code class="language-text">alarm(1)</code> の直後に <code class="language-text">sleep(2)</code> を置くことで強制的にこのタイミングで SIGALRM を発生させているようです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0x16</span><span class="token punctuation">,</span>FUN_00102520<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0xe</span><span class="token punctuation">,</span>FUN_00101bc0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">0x15</span><span class="token punctuation">,</span>FUN_00101550<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>angr のようなシンボリック実行を利用する解析では、alarm や sleep などの時間経過の状態を正確に追跡できない場合があります。</p>
<p>そのため、Solver 側で sleep 関数をオーバーライドして、強制的に SIGALRM のコールバック関数を呼び出す処理に置き換えてあげる必要があります。</p>
<h3 id="hook_symbol-を使用して-solvar-を作成する" style="position:relative;"><a href="#hook_symbol-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6-solvar-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B" aria-label="hook_symbol を使用して solvar を作成する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hook_symbol を使用して Solvar を作成する</h3>
<p>これで一通りの情報がそろったのでいよいよ Flag を手に入れるための Solver を作成していきます。</p>
<p>この問題は以下の Solver で解くことができます。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> angr
<span class="token keyword">import</span> claripy
<span class="token keyword">from</span> logging <span class="token keyword">import</span> getLogger<span class="token punctuation">,</span> WARN

getLogger<span class="token punctuation">(</span><span class="token string">"angr"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>WARN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">)</span>
flag <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span>stdin<span class="token operator">=</span>flag<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>flag<span class="token punctuation">.</span>get_byte<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0x21</span><span class="token punctuation">)</span>
    state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>flag<span class="token punctuation">.</span>get_byte<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0x7f</span><span class="token punctuation">)</span>
	
<span class="token keyword">def</span> <span class="token function">correct</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">b"SUCCESS"</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">failed</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">b"FAIL"</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token keyword">class</span> <span class="token class-name">OverrideSignal</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sigid<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">:</span>
		sigid <span class="token operator">=</span> sigid<span class="token punctuation">.</span>concrete_value
		handler <span class="token operator">=</span> handler<span class="token punctuation">.</span>concrete_value
		self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
		self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>sigid<span class="token punctuation">]</span> <span class="token operator">=</span> handler
		<span class="token keyword">return</span> <span class="token number">0</span>

<span class="token keyword">class</span> <span class="token class-name">OverrideRaise</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sigid<span class="token punctuation">)</span><span class="token punctuation">:</span>
		sigid <span class="token operator">=</span> sigid<span class="token punctuation">.</span>concrete_value
		self<span class="token punctuation">.</span>call<span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>sigid<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sigid<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span>
		
<span class="token keyword">class</span> <span class="token class-name">OverrideSleep</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sigid<span class="token punctuation">)</span><span class="token punctuation">:</span>
		sigid <span class="token operator">=</span> <span class="token number">14</span>
		self<span class="token punctuation">.</span>call<span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>sigid<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sigid<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">OverrideGetRandom</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">:</span>
		res <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"i"</span><span class="token punctuation">]</span>
		<span class="token keyword">if</span> res <span class="token operator">==</span> <span class="token number">0x44</span><span class="token punctuation">:</span>
			<span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
		self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"i"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
		self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>mem<span class="token punctuation">[</span>val<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">int</span> <span class="token operator">=</span> res
		<span class="token keyword">return</span> <span class="token number">0</span>

<span class="token decorator annotation punctuation">@proj<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x4031F2</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">first_sigsegv</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
	state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rsp <span class="token operator">-=</span> <span class="token number">8</span>
	state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rip <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span>
	state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rdi <span class="token operator">=</span> <span class="token number">11</span>

state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token number">11</span><span class="token punctuation">:</span> <span class="token number">0x4011E0</span><span class="token punctuation">,</span>
	<span class="token number">14</span><span class="token punctuation">:</span> <span class="token number">0x401bc0</span><span class="token punctuation">,</span>
	<span class="token number">16</span><span class="token punctuation">:</span> <span class="token number">0x401350</span><span class="token punctuation">,</span>
	<span class="token number">17</span><span class="token punctuation">:</span> <span class="token number">0x4014A0</span><span class="token punctuation">,</span>
	<span class="token number">18</span><span class="token punctuation">:</span> <span class="token number">0x402FB0</span><span class="token punctuation">,</span>
	<span class="token number">21</span><span class="token punctuation">:</span> <span class="token number">0x401550</span><span class="token punctuation">,</span>
	<span class="token number">22</span><span class="token punctuation">:</span> <span class="token number">0x402520</span>
<span class="token punctuation">}</span>

state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"i"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
proj<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"signal"</span><span class="token punctuation">,</span> OverrideSignal<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
proj<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"raise"</span><span class="token punctuation">,</span> OverrideRaise<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
proj<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"sleep"</span><span class="token punctuation">,</span> OverrideSleep<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
proj<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"getrandom"</span><span class="token punctuation">,</span> OverrideGetRandom<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>state<span class="token punctuation">)</span>

<span class="token keyword">while</span> simgr<span class="token punctuation">.</span>active<span class="token punctuation">:</span>
    simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>correct<span class="token punctuation">,</span> avoid<span class="token operator">=</span>failed<span class="token punctuation">)</span>
    <span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span></code></pre></div>
<p>実装は一見複雑に見えますが、ここまでに使用してきたものの通りです。</p>
<p>まず冒頭部分の以下のコードでは、いつも通り Project の定義とシンボル変数 flag の宣言、そして、入力が正しい場合と誤っている場合に期待される出力結果を定義しています。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> angr
<span class="token keyword">import</span> claripy
<span class="token keyword">from</span> logging <span class="token keyword">import</span> getLogger<span class="token punctuation">,</span> WARN

getLogger<span class="token punctuation">(</span><span class="token string">"angr"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>WARN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">)</span>
flag <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span>stdin<span class="token operator">=</span>flag<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>flag<span class="token punctuation">.</span>get_byte<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0x21</span><span class="token punctuation">)</span>
    state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>flag<span class="token punctuation">.</span>get_byte<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0x7f</span><span class="token punctuation">)</span>
	
<span class="token keyword">def</span> <span class="token function">correct</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">b"SUCCESS"</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">failed</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">b"FAIL"</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span></code></pre></div>
<p>次の箇所では、SimProcedure でオーバーライドする 4 つの関数用のクラスを定義しています。</p>
<p>今回は、signal、raise、sleep、getrandom 関数をオーバーライドします。</p>
<p>signal については、すべてのハンドラ関数が固定であれば不要でしたが、SIGSEGV のコールバック関数が動的に変化する実装になっていたので、こちらもオーバーライドして、handlers というハンドラ関数と シグナル番号の対応を定義した辞書にハンドラ関数を追加しています。</p>
<p>また、恐らく動的解析対策で実装されていた getrandom による添え字のランダム化についても、処理をオーバーライドして先頭から 1 ずつ加算した結果を返すようにすることで、正しい Flag を先頭から順に比較するように変更しています。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">OverrideSignal</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sigid<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">:</span>
		sigid <span class="token operator">=</span> sigid<span class="token punctuation">.</span>concrete_value
		handler <span class="token operator">=</span> handler<span class="token punctuation">.</span>concrete_value
		self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
		self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>sigid<span class="token punctuation">]</span> <span class="token operator">=</span> handler
		<span class="token keyword">return</span> <span class="token number">0</span>

<span class="token keyword">class</span> <span class="token class-name">OverrideRaise</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sigid<span class="token punctuation">)</span><span class="token punctuation">:</span>
		sigid <span class="token operator">=</span> sigid<span class="token punctuation">.</span>concrete_value
		self<span class="token punctuation">.</span>call<span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>sigid<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sigid<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span>
		
<span class="token keyword">class</span> <span class="token class-name">OverrideSleep</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sigid<span class="token punctuation">)</span><span class="token punctuation">:</span>
		sigid <span class="token operator">=</span> <span class="token number">14</span>
		self<span class="token punctuation">.</span>call<span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>sigid<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sigid<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">OverrideGetRandom</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">:</span>
		res <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"i"</span><span class="token punctuation">]</span>
		<span class="token keyword">if</span> res <span class="token operator">==</span> <span class="token number">0x44</span><span class="token punctuation">:</span>
			<span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
		self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"i"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
		self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>mem<span class="token punctuation">[</span>val<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">int</span> <span class="token operator">=</span> res
		<span class="token keyword">return</span> <span class="token number">0</span></code></pre></div>
<p>以下の箇所では User Hook を使用して、main 関数の ret をオーバーライドして SIGSEGV を拾えるようにしています。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token decorator annotation punctuation">@proj<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x4031F2</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">first_sigsegv</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>
	state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rsp <span class="token operator">-=</span> <span class="token number">8</span>
	state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rip <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span>
	state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rdi <span class="token operator">=</span> <span class="token number">11</span></code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 787px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/5124c83621974206a69e1b15003b7150/e619b/image-20231224130612969.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 32.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABHElEQVQY002Q25LbIBBE/f+fmIds1VqysK4GiZvAOumwu6mAmi7B1KGHmxkMZtiYJogRXq8gr9RyYOaJzXsuzZ9xv98xz4UzQwg6ua523ly6PfqB4bE0YAhfwPN8cxwOYzr5xuF3nHVYd9J1nYAre3iT0oIo/D9uOWUBikQDOZcELpRSlDSRc1Qa1aRCUlHf90zzTEwn/ogEeaqVpPqWcFa0abRYi268GEelcVkte9ZtVkKviwJVwJprAz6MYQk75pUZFsfiVkJOX8CPT8PH58rqwCvlOAfBE7vSbT7i8/VP8bxay0+9oU0HT+sZ153ZWfYUcNq7ZbVb6oW+5jH8bb+2/7dUtRSpfqvrBh79L474G5tPDslHT8y+veEfGtHP3UL1148AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/5124c83621974206a69e1b15003b7150/8ac56/image-20231224130612969.webp 240w,
/static/5124c83621974206a69e1b15003b7150/d3be9/image-20231224130612969.webp 480w,
/static/5124c83621974206a69e1b15003b7150/32ee1/image-20231224130612969.webp 787w"
              sizes="(max-width: 787px) 100vw, 787px"
              type="image/webp"
            />
          <source
            srcset="/static/5124c83621974206a69e1b15003b7150/8ff5a/image-20231224130612969.png 240w,
/static/5124c83621974206a69e1b15003b7150/e85cb/image-20231224130612969.png 480w,
/static/5124c83621974206a69e1b15003b7150/e619b/image-20231224130612969.png 787w"
            sizes="(max-width: 787px) 100vw, 787px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/5124c83621974206a69e1b15003b7150/e619b/image-20231224130612969.png"
            alt="image-20231224130612969"
            title="image-20231224130612969"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>ここでは、スタックポインタなどのレジスタの変更に加えて、rip を SIGSEGV のハンドラ関数に指定することで、例外を回避しつつ処理を先に進めています。</p>
<p>続く以下のコードでは、signal 関数を使用する行から確認できたハンドラ関数の初期値をテーブル化しています。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"handlers"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token number">11</span><span class="token punctuation">:</span> <span class="token number">0x4011E0</span><span class="token punctuation">,</span>
	<span class="token number">14</span><span class="token punctuation">:</span> <span class="token number">0x401bc0</span><span class="token punctuation">,</span>
	<span class="token number">16</span><span class="token punctuation">:</span> <span class="token number">0x401350</span><span class="token punctuation">,</span>
	<span class="token number">17</span><span class="token punctuation">:</span> <span class="token number">0x4014A0</span><span class="token punctuation">,</span>
	<span class="token number">18</span><span class="token punctuation">:</span> <span class="token number">0x402FB0</span><span class="token punctuation">,</span>
	<span class="token number">21</span><span class="token punctuation">:</span> <span class="token number">0x401550</span><span class="token punctuation">,</span>
	<span class="token number">22</span><span class="token punctuation">:</span> <span class="token number">0x402520</span>
<span class="token punctuation">}</span></code></pre></div>
<p>最後に、各シンボル関数をフックし、SimulationManager による解析を実行しています。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"i"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
proj<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"signal"</span><span class="token punctuation">,</span> OverrideSignal<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
proj<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"raise"</span><span class="token punctuation">,</span> OverrideRaise<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
proj<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"sleep"</span><span class="token punctuation">,</span> OverrideSleep<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
proj<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">"getrandom"</span><span class="token punctuation">,</span> OverrideGetRandom<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>state<span class="token punctuation">)</span>

<span class="token keyword">while</span> simgr<span class="token punctuation">.</span>active<span class="token punctuation">:</span>
    simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>correct<span class="token punctuation">,</span> avoid<span class="token operator">=</span>failed<span class="token punctuation">)</span>
    <span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span></code></pre></div>
<p>これを実行すると、各ハンドラ関数の中の実装をほとんど解析することなく、正解となる Flag を angr で特定することができます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 734px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/5784b66a44a2df6cc701c2074f4272c2/c6d67/image-20231224131017306.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 5.833333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAVklEQVQI1w3ISwqAIAAA0Q7QKYKgLxXUIgRLM82FES2r+19jcjHwmER1EjMb9KQxo8L3DjcEdOvZKovto2uHyBa25mCPfy0t5xj45M0be8SFLxaGNOcHYQcijwQOMEkAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/5784b66a44a2df6cc701c2074f4272c2/8ac56/image-20231224131017306.webp 240w,
/static/5784b66a44a2df6cc701c2074f4272c2/d3be9/image-20231224131017306.webp 480w,
/static/5784b66a44a2df6cc701c2074f4272c2/a242a/image-20231224131017306.webp 734w"
              sizes="(max-width: 734px) 100vw, 734px"
              type="image/webp"
            />
          <source
            srcset="/static/5784b66a44a2df6cc701c2074f4272c2/8ff5a/image-20231224131017306.png 240w,
/static/5784b66a44a2df6cc701c2074f4272c2/e85cb/image-20231224131017306.png 480w,
/static/5784b66a44a2df6cc701c2074f4272c2/c6d67/image-20231224131017306.png 734w"
            sizes="(max-width: 734px) 100vw, 734px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/5784b66a44a2df6cc701c2074f4272c2/c6d67/image-20231224131017306.png"
            alt="image-20231224131017306"
            title="image-20231224131017306"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h2 id="まとめ" style="position:relative;"><a href="#%E3%81%BE%E3%81%A8%E3%82%81" aria-label="まとめ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>まとめ</h2>
<p>ちょうど 1 年くらい前に「俺たちはまだ angr を知らない」という記事を書きましたが、今でもまだ angr についてほとんどわかっていないことを痛感しました。</p>
<p>使いこなせば非常に強力な解析ツールになると思うので、引き続き学んでいこうと思います。</p>
<p>参考：<a href="/ctf-angr-tutorial">俺たちはまだ angr を知らない(Z3py も追記中) - かえるのひみつきち</a></p></div></div></div><div class="Post-module--post__footer--3WzWU"><div><p class="Meta-module--meta__date--29eD7">Published <!-- -->Dec 23, 2023</p></div><div class="Tags-module--tags--1L_ct"><ul class="Tags-module--tags__list--91FqN"><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/ctf/">CTF</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/rev/">Rev</a></li></ul></div><div class="Author-module--author--2Yefr"><p>リバースエンジニアになりたいCTF Player(Team: 0nePadding)。WinDbgとYARAが好き。OSCP / CISSP / AtCoder 緑 Microsoft Japanに所属してます。発言はすべて個人の見解。<a class="Author-module--author__bio-twitter--n-O9n" href="https://www.twitter.com/kash1064" rel="noopener noreferrer" target="_blank"><strong>かしわば</strong> on Twitter</a></p></div></div><div class="Post-module--post__comments--25y6I"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/ctf-angr-hooking";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-299cfcade846097f4d4b.js"],"app":["/app-f5b45fb557768b3cf36f.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-fd4fb51a6fac1c18bdde.js"],"component---src-templates-categories-list-template-js":["/component---src-templates-categories-list-template-js-2181ec47d28e5c35d3e9.js"],"component---src-templates-category-template-js":["/component---src-templates-category-template-js-76f2006942127b3c7274.js"],"component---src-templates-index-template-js":["/component---src-templates-index-template-js-70ba56c0f46525baa629.js"],"component---src-templates-not-found-template-js":["/component---src-templates-not-found-template-js-d19905e5c8fc953958f1.js"],"component---src-templates-page-template-js":["/component---src-templates-page-template-js-6ba68ef37e264f701345.js"],"component---src-templates-post-template-js":["/component---src-templates-post-template-js-381c1b847824134fa4bd.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-0faa242d92f89b71e668.js"],"component---src-templates-tags-list-template-js":["/component---src-templates-tags-list-template-js-2d7007993fc2bf0f9caf.js"]};/*]]>*/</script><script src="/polyfill-299cfcade846097f4d4b.js" nomodule=""></script><script src="/component---src-templates-post-template-js-381c1b847824134fa4bd.js" async=""></script><script src="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-f5b45fb557768b3cf36f.js" async=""></script><script src="/dc6a8720040df98778fe970bf6c000a41750d3ae-84d7c7f527ea24afde0e.js" async=""></script><script src="/532a2f07-92db97c0addf07d5cb73.js" async=""></script><script src="/framework-3761df4ab6ee9f056936.js" async=""></script><script src="/webpack-runtime-a3c0f166cb4b802ff58f.js" async=""></script></body></html>