<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e71379dda153709d1a9a.css" id="gatsby-global-css">html{font-size:100}body{margin:0 0 0 calc(100vw - 100%);color:#222;line-height:1.4;font-size:.875rem;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background-color:#fcfcfc}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:1.575rem;line-height:2.25rem;margin-top:5rem;margin-bottom:1.25rem}h2{font-size:1.47656rem;line-height:1.875rem}h2,h3{margin-top:2.5rem;margin-bottom:.625rem}h3{font-size:1.20313rem;line-height:1.25rem}h4{font-size:1.05rem;margin-top:1.875rem}h4,h5{line-height:1.25rem;margin-bottom:.625rem}h5,h6{font-size:.875rem;margin-top:3.125rem}h6{line-height:1.25rem;margin-bottom:.625rem}img{max-width:100%;margin:inherit auto}hr,img{border:0;display:block}hr{color:#222;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);width:6.25rem}a{color:#918d40;text-decoration:none}a:active,a:focus,a:hover{color:#a9d159}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.25rem}ul li{padding:0 .3125rem;margin-bottom:.625rem}p{line-height:1.25rem;margin-bottom:1.25rem}blockquote{font-style:italic;text-align:center;background-color:#f5f5f5;padding:.1875rem .625rem}figure{display:block;width:100%;height:auto}figcaption{line-height:.9375rem;margin-top:.3125rem;color:#222;font-size:.75rem;font-style:italic;margin-bottom:0;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.25rem}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}li>code[class*=language-text],p>code[class*=language-text]{background:#f9f9f9!important;color:#2d2d2d!important}.Author-module--author__photo--36xCH{display:inline-block;margin-bottom:0;border-radius:50%;background-clip:padding-box}.Author-module--author__title--2CaTb{font-size:.98438rem;font-weight:600;line-height:1.40625rem;margin:.625rem 0}.Author-module--author__title-link--Yrism,.Author-module--author__title-link--Yrism:focus,.Author-module--author__title-link--Yrism:hover{color:#222}.Author-module--author__subtitle--cAaEB{color:#888;line-height:1.25rem;margin-bottom:1.25rem}.Icon-module--icon--Gpyvw{display:inline-block;width:1em;height:1em;stroke-width:0;stroke:currentColor;fill:currentColor;font-style:normal;font-weight:400;speak:none;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.Contacts-module--contacts--1rGd1{margin-bottom:1.25rem}.Contacts-module--contacts__list--3OgdW{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;padding:0;margin:.625rem -.1875rem;width:8.75rem}.Contacts-module--contacts__list-item--16p9q{padding:0;margin:.25rem;display:flex;align-content:center;align-items:center;justify-content:center;height:2.1875rem;width:2.1875rem;line-height:2.1875rem;border-radius:50%;text-align:center;border:1px solid #ebebeb}.Contacts-module--contacts__list-item-link--2MIDn{border:0;display:flex;color:#222}.Contacts-module--contacts__list-item-link--2MIDn:focus,.Contacts-module--contacts__list-item-link--2MIDn:hover{color:#918d40}.Copyright-module--copyright--1ariN{color:#b6b6b6;font-size:.75rem}.Menu-module--menu--Efbin{margin-bottom:1.25rem}.Menu-module--menu__list--31Zeo{list-style:none;padding:0;margin:0}.Menu-module--menu__list-item--1lJ6B{padding:0;margin:.625rem 0}.Menu-module--menu__list-item-link--10Ush{font-size:.875rem;color:#222;font-weight:400;border:0}.Menu-module--menu__list-item-link--10Ush:focus,.Menu-module--menu__list-item-link--10Ush:hover{color:#918d40;border-bottom:1px solid #918d40}.Menu-module--menu__list-item-link--active--2CbUO{color:#222;border-bottom:1px solid #222}.Sidebar-module--sidebar--X4z2p{width:100%}.Sidebar-module--sidebar__inner--Jdc5s{position:relative;padding:1.5625rem 1.25rem 0}.Sidebar-module--headerimage--19Rdy{width:100%;min-height:70px;max-height:120px;margin:0 0 .625rem}.Sidebar-module--logo-image--XDYae{min-height:70px;max-height:120px;margin:0 auto}input{-webkit-appearance:none;-moz-appearance:none;appearance:none;padding:.625rem;margin:.3125rem 0;border:1px solid #999;border-radius:.3125rem}.Sidebar-module--search-container--17C6F{position:relative}.Sidebar-module--search-container-input--27Tw4{width:100%}.Sidebar-module--search-container-submit--WwtLg{position:absolute;width:2.375rem;height:2.375rem;top:calc(50% - 19px);right:0;border:3px solid #999;border-radius:0 .25rem .25rem 0;background:#999}.Sidebar-module--search-container-submit--WwtLg:before{position:absolute;content:"";width:.9375rem;height:.9375rem;top:calc(50% - 9px);left:calc(50% - 9px);border-radius:50%;box-shadow:0 0 0 2px #fff}.Sidebar-module--search-container-submit--WwtLg:after{position:absolute;content:"";width:.5rem;height:.375rem;top:calc(50% + 6px);left:calc(50% + 2px);border-top:2px solid #fff;transform:rotate(45deg)}@media screen and (min-width:685px){.Sidebar-module--sidebar--X4z2p{width:calc(41.625% - 1.09375rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(12n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--Jdc5s:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);position:absolute;content:"";width:.0625rem;height:33.75rem;top:30px;right:-10px;bottom:0}}@media screen and (min-width:960px){.Sidebar-module--sidebar--X4z2p{width:calc(33.3% - 1.25rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(3n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:2.5rem}}.Layout-module--layout--3Pyz6{max-width:66.875rem;margin-left:auto;margin-right:auto}.Layout-module--layout--3Pyz6:before{content:"";display:table}.Layout-module--layout--3Pyz6:after{content:"";display:table;clear:both}.Feed-module--feed__item--2D5rE{margin-bottom:1.5625rem}.Feed-module--feed__item--2D5rE:last-child{margin-bottom:.625rem}.Feed-module--feed__item-title--3nigr{font-size:1.47656rem;line-height:1.875rem;margin-top:0;margin-bottom:.625rem}.Feed-module--feed__item-title-link--iFMRs{color:#222}.Feed-module--feed__item-title-link--iFMRs:focus,.Feed-module--feed__item-title-link--iFMRs:hover{color:#222;border-bottom:1px solid #222}.Feed-module--feed__item-description--1uO8e{font-size:.875rem;line-height:1.25rem;margin-bottom:.9375rem}.Feed-module--feed__item-meta-time--3t1fg{font-size:.75rem;color:#222;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--N-Q0A{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--23f8F{font-size:.75rem;color:#a9d159;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--23f8F:focus,.Feed-module--feed__item-meta-category-link--23f8F:hover{color:#918d40}.Feed-module--feed__item-readmore--1u6bI{font-size:.875rem;color:#918d40}.Feed-module--feed__item-readmore--1u6bI:focus,.Feed-module--feed__item-readmore--1u6bI:hover{color:#918d40;border-bottom:1px solid #918d40}.Page-module--page--2nMky{margin-bottom:2.5rem}.Page-module--page__inner--2M_vz{padding:1.5625rem 1.25rem}.Page-module--page__title--GPD8L{font-size:1.575rem;font-weight:600;line-height:2.5rem;margin-top:0;margin-bottom:1.8125rem}.Page-module--page__body--Ic6i6{font-size:.875rem;line-height:1.25rem;margin:0 0 1.25rem}@media screen and (min-width:685px){.Page-module--page--2nMky{width:calc(58.275% - .78125rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(12n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(12n+1){clear:both}.Page-module--page__inner--2M_vz{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--2nMky{width:calc(66.6% - .625rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(3n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(3n+1){clear:both}.Page-module--page__inner--2M_vz{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--2H3nO{margin-top:2.5rem;display:flex}.Pagination-module--pagination__prev--bet5s{width:50%;text-align:left}.Pagination-module--pagination__prev-link--1Nzs6{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--1Nzs6:focus,.Pagination-module--pagination__prev-link--1Nzs6:hover{color:#918d40}.Pagination-module--pagination__prev-link--disable--Yklx9{pointer-events:none;color:#bbb}.Pagination-module--pagination__next--3hFiN{width:50%;text-align:right}.Pagination-module--pagination__next-link--3FUtA{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--3FUtA:focus,.Pagination-module--pagination__next-link--3FUtA:hover{color:#918d40}.Pagination-module--pagination__next-link--disable--30UwZ{pointer-events:none;color:#bbb}.Author-module--author--2Yefr{border-top:1px solid #e6e6e6;max-width:43.75rem;padding-top:1.25rem;line-height:1.25rem;margin-top:1.25rem;margin-bottom:2.5rem}.Author-module--author__bio-twitter--n-O9n{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2Yefr{margin-left:auto;margin-right:auto}}.Content-module--content--3p512{max-width:62.8125rem;padding:0 .9375rem;margin:0 auto}.Content-module--content__title--2BDW9{font-size:1.75rem;max-width:43.75rem;font-weight:600;text-align:center;line-height:2.0625rem;margin:1.25rem auto 0}.Content-module--content__body--2TrQ- figure{margin-bottom:1.25rem}.Content-module--content__body--2TrQ- figure blockquote{font-style:italic;text-align:center;margin-top:0;padding:1.25rem 0}.Content-module--content__body--2TrQ- figure blockquote p{max-width:43.75rem;font-size:1.47149rem;margin-top:1.25rem;margin-bottom:1.25rem;line-height:1.875rem}.Content-module--content__body--2TrQ- a{text-decoration:underline}.Content-module--content__body--2TrQ- *{max-width:43.75rem;margin-left:auto;margin-right:auto}.Content-module--content__body--2TrQ- img{max-width:100%;margin-top:.625rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- li ul{margin-bottom:.625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- h2{position:relative;padding:1rem 1.5rem;color:#fff;border-radius:.625rem;background:#0c0000}.Content-module--content__body--2TrQ- h2:after{position:absolute;bottom:-9px;left:1rem;width:0;height:0;content:"";border-color:#0c0000 transparent transparent;border-style:solid;border-width:10px 10px 0}.Content-module--content__body--2TrQ- h3{border-bottom:3px dotted #0c0000;padding:1rem 0}@media screen and (min-width:960px){.Content-module--content--3p512{padding:0}.Content-module--content__title--2BDW9{font-size:1.75rem;line-height:2.8125rem;margin-top:2.8125rem;margin-bottom:1.875rem}.Content-module--content__body--2TrQ-,.Content-module--content__body--2TrQ- p{font-size:.98438rem;line-height:1.40625rem;margin-bottom:1.40625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}}.Meta-module--meta__date--29eD7{font-style:italic}.Tags-module--tags--1L_ct{margin-bottom:.625rem}.Tags-module--tags__list--91FqN{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--1M30P{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3SL_8{display:inline-block;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;border:1px solid #e6e6e6;text-decoration:none;border-radius:1.25rem;color:#222}.Tags-module--tags__list-item-link--3SL_8:focus,.Tags-module--tags__list-item-link--3SL_8:hover{color:#918d40}.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{max-width:43.75rem;margin:0 auto;padding:0 .9375rem}.Post-module--post__home-button--16Kl0{display:block;max-width:5.625rem;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;text-align:center;color:#222;border:1px solid #e6e6e6;border-radius:1.25rem;font-size:.875rem;font-weight:400;margin-left:auto;margin-right:auto;margin-top:1.25rem}.Post-module--post__home-button--16Kl0:focus,.Post-module--post__home-button--16Kl0:hover{color:#918d40}@media screen and (min-width:960px){.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{padding:0}.Post-module--post__home-button--16Kl0{position:fixed;max-width:auto;margin:0;top:30px;left:30px}}</style><meta name="generator" content="Gatsby 2.32.13"/><link rel="alternate" type="application/rss+xml" title="かえるのひみつきち" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-122086587-6"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-122086587-6', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#F7A046"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><title data-react-helmet="true">Magical WinDbg VOL.2【4 章 DoPClient を動的解析する】 - かえるのひみつきち</title><meta data-react-helmet="true" name="description" content="技術書典 16 で頒布した Magical WinDbg 2 - CTF で学ぶユーザモード &amp; カーネルデバッギング - の WEB 版です。"/><meta data-react-helmet="true" property="og:site_name" content="Magical WinDbg VOL.2【4 章 DoPClient を動的解析する】 - かえるのひみつきち"/><meta data-react-helmet="true" property="og:image" content="https://kashiwaba-yuki.com/static/e9bfc3718fd53ab58623a496fc9a302e/magical-windbg-vol2.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="Magical WinDbg VOL.2【4 章 DoPClient を動的解析する】 - かえるのひみつきち"/><meta data-react-helmet="true" name="twitter:description" content="技術書典 16 で頒布した Magical WinDbg 2 - CTF で学ぶユーザモード &amp; カーネルデバッギング - の WEB 版です。"/><meta data-react-helmet="true" name="twitter:image" content="https://kashiwaba-yuki.com/static/e9bfc3718fd53ab58623a496fc9a302e/magical-windbg-vol2.png"/><link as="script" rel="preload" href="/webpack-runtime-a3c0f166cb4b802ff58f.js"/><link as="script" rel="preload" href="/framework-3761df4ab6ee9f056936.js"/><link as="script" rel="preload" href="/532a2f07-92db97c0addf07d5cb73.js"/><link as="script" rel="preload" href="/dc6a8720040df98778fe970bf6c000a41750d3ae-206f62bbc9a23b5258ed.js"/><link as="script" rel="preload" href="/app-5379d71873e8730fc841.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-js-381c1b847824134fa4bd.js"/><link as="fetch" rel="preload" href="/page-data/magical-windbg-vol2-04/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/251939775.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/401334301.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/825871152.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--3Pyz6"><div><a class="Post-module--post__home-button--16Kl0" href="/">All Articles</a><div><div class="Content-module--content--3p512"><h1 class="Content-module--content__title--2BDW9">Magical WinDbg VOL.2【4 章 DoPClient を動的解析する】</h1><div class="Content-module--content__body--2TrQ-"><p>この章では、DoPClient の checkPassword 関数を WinDbg を使用して動的解析することで、1 つ目の Flag を特定します。</p>
<p>動的解析とは、プログラムを実際に実行した際の挙動やメモリ、レジスタなどの情報から解析を行う手法です。</p>
<p>WinDbg などのデバッガを利用してプログラムの実行を中断し、メモリやレジスタの情報を参照(または変更)しつつ解析を行う手法はもちろん、プログラム実行中のプロセスモニターログやネットワークトレースなどを取得することも動的解析に該当します。</p>
<p>なお、本書では主に WinDbg を使用して解析を行います。</p>
<!-- omit in toc -->
<h2 id="もくじ" style="position:relative;"><a href="#%E3%82%82%E3%81%8F%E3%81%98" aria-label="もくじ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>もくじ</h2>
<ul>
<li><a href="#windbg-%E3%81%A7%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E5%AE%9F%E8%A1%8C%E3%81%97%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B">WinDbg でプログラム実行し、ブレークポイントを設定する</a></li>
<li><a href="#%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%A8%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E8%AA%AD%E3%81%BF%E5%8F%96%E3%82%8B">レジスタとスタック、メモリの情報を読み取る</a></li>
<li><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%AC%E3%81%A7%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E5%AE%9F%E8%A1%8C%E3%82%92%E5%86%8D%E9%96%8B%E3%81%99%E3%82%8B">デバッガでプログラムの実行を再開する</a></li>
<li><a href="#checkpassword-%E9%96%A2%E6%95%B0%E3%82%92%E9%9D%99%E7%9A%84%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B">checkPassword 関数を静的解析する</a></li>
<li><a href="#checkpassword-%E9%96%A2%E6%95%B0%E3%82%92%E5%8B%95%E7%9A%84%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B">checkPassword 関数を動的解析する</a></li>
<li><a href="#%E6%AD%A3%E3%81%97%E3%81%84%E6%96%87%E5%AD%97%E5%88%97%E3%82%92%E5%85%A5%E5%8A%9B%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E5%8B%95%E4%BD%9C%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B">正しい文字列を入力した場合の動作を解析する</a></li>
<li><a href="#javascript-%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B">JavaScript ベースのデバッグスクリプトを使用する</a></li>
<li><a href="#%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%AC%E6%93%8D%E4%BD%9C%E3%82%92%E8%87%AA%E5%8B%95%E5%8C%96%E3%81%99%E3%82%8B">スクリプトでデバッガ操作を自動化する</a></li>
<li><a href="#%E7%B7%8F%E5%BD%93%E3%81%9F%E3%82%8A%E6%94%BB%E6%92%83%E3%81%A7%E6%AD%A3%E3%81%97%E3%81%84-flag-%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B">総当たり攻撃で正しい Flag を特定する</a></li>
<li><a href="#%E7%B7%8F%E5%BD%93%E3%81%9F%E3%82%8A%E6%94%BB%E6%92%83%E3%82%92%E8%A1%8C%E3%81%86%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%82%92%E9%AB%98%E9%80%9F%E5%8C%96%E3%81%99%E3%82%8B">総当たり攻撃を行うスクリプトを高速化する</a></li>
<li><a href="#4-%E7%AB%A0%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81">4 章のまとめ</a></li>
<li><a href="#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF">各章へのリンク</a></li>
</ul>
<h2 id="windbg-でプログラム実行しブレークポイントを設定する" style="position:relative;"><a href="#windbg-%E3%81%A7%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E5%AE%9F%E8%A1%8C%E3%81%97%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B" aria-label="windbg でプログラム実行しブレークポイントを設定する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WinDbg でプログラム実行し、ブレークポイントを設定する</h2>
<p>一般的に、WinDbg などのデバッガを使用してユーザモードプログラムのデバッグを行う際には、「デバッガを使用してプログラムを実行する」か「実行中のプロセスにデバッガをアタッチする」方法が使用されます。</p>
<p>今回は「デバッガを使用してプログラムを実行する」で解析を行います。</p>
<p>DoPClient.exe を配置した仮想マシンで WinDbg を起動したら、[ファイル]>[Start Debugging] から [Launch executable(advanced)] をクリックします。</p>
<p>[Executable] 欄には、仮想マシンに配置した DoPClient.exe のパスを指定します。</p>
<p>また、[Start Directory] にはプログラムの実行フォルダを指定します。</p>
<p>今回、1 つ目の Flag を特定する上では [Start Directory] の指定は必要ありませんが、解析対象のプログラムがプログラムの実装によっては [Start Directory] にプログラムの実行フォルダを適切に指定しておく必要があります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/44a4531762bd9ccb381af93771fd11de/6bfd0/client-windbg-001.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACDklEQVQ4y31Ty24TQRDchIAQSBAkTnwBEhInDvyi4we2QziB/SlBcCCHRCEWjo2f+5rZ9b7Xa5+L7rEnsdbAodQ7Mz011V29xvtOF++6Xbz9/AVDx8V6uUSxWmFFWK/XCvxdFIXCanu2h+258fLsI16ctvG8fYqr8Rj2bIbReILBYEgYYDKdIk1T5HmukGUZMlqruMXuufHq0xlek7o3nQ76to3A87BYLFRiFEUqOY5juKTe9zf7S6qiDM4JggCGcXKCZ80WjlstXJoCfpBASglBSNXlAmEYwXEceihARiqK4r4Fug1JkmwID6s1HLfbePKhjm8jgYt+hPMrk2Dh/HKO7z0fN5NYqWV1TJCTIl2iBj/MMA6qVTxtNnFUq+Gn5WI+l7j+9Ru92wlGMwcyyOF6ESzTVAqjOFVtYFXlslUPD4nocaOBA1I6FDOkgQfLMiGFiySOsFrmFGM4QsJxXRV5rQlY9a5SwyCFRqWCw1odt/YYCRG6Qqh+6EtcbpJslGXZvaO8v/B96m8I284hhCYkYx7UGujNJogXTCiVMWyET46zg+XR4chGMMIwpBirvDuFDxtN/OjdQNoWJI0OEzL4wi6hJivHvZKZ8KJPhI5JI+PBo1J0sp7Hu8H+C6nGtuQKHtUb+DqeYi58eFLAJQN0H8uE5ZHZV0g9PCJTrucWQvobXHJYksp/Kfwf4R/415H4abHONgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/44a4531762bd9ccb381af93771fd11de/8ac56/client-windbg-001.webp 240w,
/static/44a4531762bd9ccb381af93771fd11de/d3be9/client-windbg-001.webp 480w,
/static/44a4531762bd9ccb381af93771fd11de/e46b2/client-windbg-001.webp 960w,
/static/44a4531762bd9ccb381af93771fd11de/7ed23/client-windbg-001.webp 1011w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/44a4531762bd9ccb381af93771fd11de/8ff5a/client-windbg-001.png 240w,
/static/44a4531762bd9ccb381af93771fd11de/e85cb/client-windbg-001.png 480w,
/static/44a4531762bd9ccb381af93771fd11de/d9199/client-windbg-001.png 960w,
/static/44a4531762bd9ccb381af93771fd11de/6bfd0/client-windbg-001.png 1011w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/44a4531762bd9ccb381af93771fd11de/d9199/client-windbg-001.png"
            alt="WinDbg で DoPClient を起動する"
            title="WinDbg で DoPClient を起動する"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>上記の指定をした後、[Record with Time Travel Debugging] のチェックは解除したまま [Debug] ボタンをクリックすることでプログラムが起動し、デバッガがアタッチされます。</p>
<p>Time Travel Debugging(TTD) <sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup> はプロセスの実行トレースをキャプチャすることで、プログラム実行中のレジスタやメモリの状態を自由に解析することができる強力な機能ですが、本書では使用しません。</p>
<p>デバッガによりユーザモードアプリケーションが起動すると、ユーザモードのシステム DLL である ntdll.dll 内に存在するイメージローダ(Ldr)の途中で処理が一時停止し、デバッガにアタッチされます。<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup></p>
<p>この時点では、プログラムの main 関数内で実装されたコードはまだ実行されていません。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f370e5d59bc045603502660420830c0d/35252/client-windbg-002.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 51.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB/ElEQVQoz42Sy4oaQRSGW4Mrb+hzuHMWI/gaE8gmmRnEleYdfIuErPIkMwtRAsIIaktrexm1qy/V3d7acbyMf6qOY8gmkIKfv+pAfXUupfzSBvj51ERtOIbr+TAcDtufwxZ7Z76AyT044my5HvzVmmLjGcOzwWDYHIy7YI4r9g5mlgOFOx72r1vYlgXuOJhMpmCMwRJn27Zp7/s+giCAXI1GA9mrK2SzWVznrpHL5ZDP55HJZFCpVKDMpgzc5XTZMk2YQp7nwRUvy9hms8Hx+CZ0JGC1WsWHcBjhd4VCIUQiESiKgmKxKDN04QrgfLEg0Gq1wuFwIJ1OJ1zWBViv1xGPx0mJRIKUSqUIWC6XoViibsYMKklmI7UQ8OVyCc45PbAO1hSX6+HhEbFYDNFolFwqmUwSsFQqQWGGCV3X0e/r6Ha7GAwGGA2H1LvxeEzORfnb7ZaAtVqNYP8EmqYtLo4wGo2gqiq0Xg96vy96aaHX00R8KLwPwzD+DzgTX6CnaQRqNp/QbrcFuIPpdIpWq0WPdDoqTf0CvPROgqSn0+n3Hn49ZyjLlGVrAix9MnmmLySzlpkZ4s95nvtnyvLy35LTll4oFKA4Ysq2nLS/xCp4wXqzRfCyw27/ht3hrP3hhNf9ecodVcPnL3dn3d4Lv8ftXQE3Hz/h2/cf+A3Lw1YBZFfE7wAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/f370e5d59bc045603502660420830c0d/8ac56/client-windbg-002.webp 240w,
/static/f370e5d59bc045603502660420830c0d/d3be9/client-windbg-002.webp 480w,
/static/f370e5d59bc045603502660420830c0d/e46b2/client-windbg-002.webp 960w,
/static/f370e5d59bc045603502660420830c0d/01875/client-windbg-002.webp 1204w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/f370e5d59bc045603502660420830c0d/8ff5a/client-windbg-002.png 240w,
/static/f370e5d59bc045603502660420830c0d/e85cb/client-windbg-002.png 480w,
/static/f370e5d59bc045603502660420830c0d/d9199/client-windbg-002.png 960w,
/static/f370e5d59bc045603502660420830c0d/35252/client-windbg-002.png 1204w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/f370e5d59bc045603502660420830c0d/d9199/client-windbg-002.png"
            alt="WinDbg によるデバッグ開始直後の画面"
            title="WinDbg によるデバッグ開始直後の画面"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>プログラムの実行を再開する前に、3 章で確認したパスワードを検証する checkPassword 関数の呼び出しアドレスにブレークポイントを設定しておきます。</p>
<div class="gatsby-highlight" data-language="nasm"><pre class="language-nasm"><code class="language-nasm">14000198b  lea     <span class="token register variable">rcx</span>, <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">0x40</span> {inputText}<span class="token operator">]</span>
<span class="token number">140001990</span>  call    checkPassword</code></pre></div>
<p>WinDbg を使用する場合、ブレークポイントは様々な方法で設定可能 <sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup> ですが、今回はシンプルに bp コマンドを使用して指定のアドレスにブレークポイントを設定します。</p>
<p>なお、ほとんどの Windows プログラムは実行時にプログラムの実行コードが再配置されるため、bp コマンドでブレークポイントを設定する際に指定可能な仮想アドレス(VA)が毎回変動します。</p>
<p>そのため、ブレークポイントを設定する場合は仮想アドレスを直接指定するのではなく、実行プログラムのイメージベースアドレスに相対仮想アドレス(RVA)を加算したものを指定する方が便利です。</p>
<p>例えば、既定の設定の Binary Ninja 上で 0x140001990 と表示されるアドレスにブレークポイントを設定したい場合は、以下のように <code class="language-text">DoPClient</code>(または <code class="language-text">!DoPClient</code>) でアクセスできるプログラムのイメージベースアドレスに相対仮想アドレス 0x1990 を加算したものを指定します。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">bp DoPClient+0x1990</code></pre></div>
<p>上記のコマンドでブレークポイントを設定した後に、g コマンドでプログラムの実行を再開すると、DoPClient がユーザにパスワードの入力を求める画面が表示されます。</p>
<p>そこで、3 章で確認した通り <code class="language-text">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</code> のように 45 文字の文字列を入力して Enter キーを送信すると、<code class="language-text">DoPClient+0x1990</code> のアドレスで再び実行が中断され、デバッガからの操作が可能になることを確認できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/09a0c0d27bae89e029da9941b2362179/60b8f/client-windbg-003.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB/UlEQVQoz02QT0tiYRjFLxIEEaPbgiBXCYHTooVlrvoIwQS1aoppL7gZpS8wnyAHdfwMbodhmGmSqCYcLJ1S8981r3r/6L1qiMNvXm8OzAuH8zzP4rznHCn1M8OHL185z91TeqxSKNco1VQq9Rbluky1ofDUVqk3W7T1HlrXQuv1McwBhjWF+QJFNZAubjJ8Tv/g2/kZl1dXZH7dcHHZ4y4nC2TpqBqqrtHRNN5HIrzZ3eXw6Ih3x8e8FXw4xd7+PvFEAumxWOIhX+J3vk7hoUStWqXR0FGUNnK9jqqqtFstms0ma2uvkSSJmZkZHA6HPf+PYDCIdH//wO1tToi00DSdbreLYehCqCN2jdZUbHLf3t7G7XbjWVlhedmN1+tlcXERp8tpfxIOh5FkuUE+n6NSKSPLMuVyWYg/USwWxT2PrhuMRiPG4zEHBwesr6+ztbXF5uYmgUDA3l0ul+0wIiqxBa+vr8hms+RyedLpNBPXhUJBOL/DtCz+vZ2dHVZXV9nY8OHz+QRv4PF4cDpf2RWcnJy8CFZFbxN3iqLQ6XREZMOOOBwO6QvBSezx+A9+v5/Z2VmWlpbsqAsLC8zNzTE/P287DIVCSA25aXdlWX0G/QHPz882m6ZFr2cKNu15MBiSSqU4PY0Sj8eJxWICcRKJTySTSaLRj5x9P+MvOzrW2x6MYSwAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/09a0c0d27bae89e029da9941b2362179/8ac56/client-windbg-003.webp 240w,
/static/09a0c0d27bae89e029da9941b2362179/d3be9/client-windbg-003.webp 480w,
/static/09a0c0d27bae89e029da9941b2362179/e46b2/client-windbg-003.webp 960w,
/static/09a0c0d27bae89e029da9941b2362179/ffb96/client-windbg-003.webp 1217w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/09a0c0d27bae89e029da9941b2362179/8ff5a/client-windbg-003.png 240w,
/static/09a0c0d27bae89e029da9941b2362179/e85cb/client-windbg-003.png 480w,
/static/09a0c0d27bae89e029da9941b2362179/d9199/client-windbg-003.png 960w,
/static/09a0c0d27bae89e029da9941b2362179/60b8f/client-windbg-003.png 1217w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/09a0c0d27bae89e029da9941b2362179/d9199/client-windbg-003.png"
            alt="checkPassword 関数の呼び出し箇所にブレークポイントを設定する"
            title="checkPassword 関数の呼び出し箇所にブレークポイントを設定する"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>ちなみに、現在適用されているブレークポイントの設定は bl コマンド、または Breakpoints ウィンドウで確認することができます。</p>
<p>また、WinDbg の Disassembly ウィンドウを起動すると、現在の実行コードが黄色に、そしてブレークポイントとして設定したコードが赤くマーキングされるため、ここからもブレークポイントの設定を確認できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 593px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/831cbe19a2e8eb1e14f84a4a65e4dfc5/0b5b1/client-windbg-004.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 103.75000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAERklEQVQ4y2VUaY/bVBTN7wJaxAckfgISPw61dDaoUJsZikZAP1A6DFKTOIkTx2s273biLYmdbQ7Hb9oZJBw9Oc/vvrucc+5tfNds4tvLJr6+OMdnL17g6dnZ/To/xxO+vzg9xZPTM7GePuxP8aU4P8XnJydifcX9Ny9fouF7HsIwhGPbcB0HRV6gXG+wKgpsywrHwwG7bYn9thJ7jza+6yL0AyzjBYosR7Up8elpyHIf3W4Phq6j1+9BN0xMJmMEAS8sE2FUvzflGnEUwTItTKcz2K4NL/JR7ktUuwp3d3f3Di3LhEEn89mMznTM5szUdSC+m6YwTNMCVVUhyzK4nos4jVHuSoSrCEEeYlkscTweUbtsDIcDDAZDRjYhD2RY4wnUkQJZHjDLUER17A2K1ZEOl3TowfFs+GmAA+H471MHb/S6XbTbHWjqCB2pA1XTYZoG5vM5HMcVl6IowXq9ZukLZm4hJBx5mcNObMyTObzEExmKkk1mpuvGfcnEscZnxv8py9vtdjQ5IlmW2GzumGHCIA4DRDjs9jzff0wNjxiqzExVNUGEoijMzoKuqRgOFRHojr9imWNbHbFYxBhPCImuQtZlBHHEcMeH7ETJEststdvEbYRWq0U8FfTJtqppJGIrDD1/CyoGabJEGIfwMg9u5mKxXpKUAKtq9ehQ50VFGWFaR1ZVwfJ0OkEUxw+R82WBXXVghhHtpvC9AA7t6vd6tUZZlo8OTcMQspnNptDofDqbw7bnlEr2wF4SUeR0mKaJwC8rMhQUfrXd/p/lriSh05HIsipK7vVlyCy51+tjPB7jSKPYXaJa7xD4HkbEd+JMEbg+ncfY7rfY7x8Jog6HxKx/r0NZFp1SS0ho0xoLoyioyyLbyUKwrFs6JE2CTT16iYs0z1B+bL9GrauaWZu6qyU0tx3BeH3x8BHDJGU/M4HNesXLKeJ1jKRMsNpxX6ai/R5KrsurMzR0Dd1elxkaxFIVLfbpCb2czvbsHJcwWGKYiCHh+RwmPNusHx32+wN2CEvVLEhdmXIZ06FJvdkssRD9mUcZ9iw5CBYYUrMKS3acAAvq897RIzENy5Cgq//Ankow1FuMrRZm1gcog/fQRrdsFOpsYWG7cpAuddgzkmXy3HjPDjJ5HuLuEDysxqDbxEB6Bmv0I3qtZxjJZzCUC9jjJvLFH4x5C3dyjSR8S7avoMoXMJWfMLcukYU8P9wA23dcf4lF2fTRbvUxGupofZAwkDUM+goU7qWOjEWcIfVzrNMdPDckHGxR4j3QRzDtGfJViSMJO+zuV0O7uUXr59eQLt9AuvoVPb7br5pov77Czck53n//HP3Lt+i/vsbo+jdob/9E5/oXfPj9Cn9fvsS7H55Dab6B/OoKA66GyoEw4iCYUD7DWoccXwZFrvH7mHJakcUlBVxw+kS+D5MTSTNG6A2J/VjjnMxw5FTas2sOXP8C4Wz4FgZLhc8AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/831cbe19a2e8eb1e14f84a4a65e4dfc5/8ac56/client-windbg-004.webp 240w,
/static/831cbe19a2e8eb1e14f84a4a65e4dfc5/d3be9/client-windbg-004.webp 480w,
/static/831cbe19a2e8eb1e14f84a4a65e4dfc5/ee627/client-windbg-004.webp 593w"
              sizes="(max-width: 593px) 100vw, 593px"
              type="image/webp"
            />
          <source
            srcset="/static/831cbe19a2e8eb1e14f84a4a65e4dfc5/8ff5a/client-windbg-004.png 240w,
/static/831cbe19a2e8eb1e14f84a4a65e4dfc5/e85cb/client-windbg-004.png 480w,
/static/831cbe19a2e8eb1e14f84a4a65e4dfc5/0b5b1/client-windbg-004.png 593w"
            sizes="(max-width: 593px) 100vw, 593px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/831cbe19a2e8eb1e14f84a4a65e4dfc5/0b5b1/client-windbg-004.png"
            alt="Disassembly ウィンドウからブレークポイント前後のコードを参照する"
            title="Disassembly ウィンドウからブレークポイント前後のコードを参照する"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>なお、実際に解析結果を見てみるとわかる通り、WinDbg の Disassembly ウインドウや u、ub コマンドなどで参照できる逆アセンブル結果は Binary Ninja などの解析ツールによるものよりも可読性が低いです。</p>
<p>そのため、WinDbg でシンボルのないプログラムのデバッグを行う際には、3 章で使用したような別の解析ツールを併用することをおすすめします。</p>
<h2 id="レジスタとスタックメモリの情報を読み取る" style="position:relative;"><a href="#%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%A8%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E8%AA%AD%E3%81%BF%E5%8F%96%E3%82%8B" aria-label="レジスタとスタックメモリの情報を読み取る permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>レジスタとスタック、メモリの情報を読み取る</h2>
<p>WinDbg で checkPassword 関数の呼び出しアドレスにブレークポイントを設定したところで、レジスタやスタック、メモリの情報を参照する方法を簡単に紹介します。</p>
<p>まずレジスタの状態ですが、r コマンド <sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup> で確認することが可能です。</p>
<p>r コマンドを実行すると、現在のスレッドコンテキストに紐づくレジスタの状態が表示されます。</p>
<p>また、<code class="language-text">r rax</code> や <code class="language-text">r zf</code> コマンドで特定のレジスタ、フラグの状態のみを参照することや、<code class="language-text">r eax = 10</code> コマンドで特定のレジスタの値を任意に置き換えることも可能です。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> r
rax=000000000000002d rbx=0000028219807970 rcx=00000087212ffa70
rdx=00007fff7cc0f490 rsi=0000000000000000 rdi=0000000000000000
rip=00007ff6dd091990 rsp=00000087212ffa30 <span class="token function">rbp</span>=0000000000000000
 r8=000000000000002e  r9=0000028219812fd0 r10=0000000000000058
r11=0000000000000246 r12=0000000000000000 r13=0000000000000000
r14=0000000000000000 r15=0000000000000000
iopl=0         <span class="token function">nv</span> up ei pl zr na po nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
DoPClient+0x1990:
00007ff6`dd091990 e8cbf9ffff      call    DoPClient+0x1360 <span class="token punctuation">(</span>00007ff6`dd091360<span class="token punctuation">)</span>

0:000> r rax
rax=000000000000002d</code></pre></div>
<p>ちなみに、ユーザモードプログラムのデバッグ中に他のスレッドコンテキストと紐づくレジスタの状態を参照したい場合、スレッド番号を使用して <code class="language-text">~2 r</code> コマンドを実行するか、<code class="language-text">~* r</code> コマンドですべてのスレッドのレジスタの状態を参照できます。</p>
<p>次は、Display Memory(<code class="language-text">d、da、db、dc、dd、dD、df、dp、dq、du、dw</code>) コマンド <sup id="fnref-5"><a href="#fn-5" class="footnote-ref">5</a></sup> で指定のアドレスのメモリの情報を参照してみます。</p>
<p>3 章で確認した通り、fgets 関数で受け取った入力文字列はスタック領域に格納されており、その先頭アドレスは <code class="language-text">RSP+0x40</code> です。</p>
<p>以下は、<code class="language-text">RSP+0x40</code> のアドレスを様々なコマンドで参照した場合の出力結果です。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 657px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/13e85eb3b20b46a553316d0b808df55a/a1253/client-windbg-005.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 115.83333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADdElEQVQ4y3VVB3LiQBDU/7/k40w2YIIiQhJRiGRjGwdwKMNc98BS+K6OqqkRi7a3Z7pnseq1mtzc3IjvB9JqtaTf74vneWLbtniup98Hg4HmJOnLcrmU5+dn2Ww253h8fDyHZdsdcV1XhsMRQD2ZzWaSZVOZTo+xweanpydsBAjyy8uLAl6CfHx8yOfnp4blg43v+wCay3g8Vgb9JJE5gMko0xzrb2E3kDSd6rPjOKjABfOBHA4HMR+Li4wsm4HlUBbzuebRaKSb0mmmzBMc0ul0tJLVaqXBcsmOgCaUIXvGUnnyLMuk2+1KFEXSvL2VBL1rtZq61um0FdiU+fX1pfGToedqyePJROI4lglyEAQAHynIcHTMFKXX6ynz9/d32W63GrvdTr6/v2W/32u2bhsNqdfruqkNlakoQRncnKapPpO9ZqyNT3k6TbUSEmDwUKvRqEu1WpUwDMVFz7hIcLIhc+YAYvCZ6wGy5/na3yjqSafdBqGGNJtNkBmKVavdSLVSwcuh2Gg6FQ7DnpbPU30ExaC12GtVF5nfeUAcJ2qvxWIh9/f3AISpybB7YhiBkW07Z3M7jquArVb7+AxGbQTXyDaDiHNYbg53rJarC1HQI57IF3gagy+ZoAuY7+7u5OHhQYMGp5kpDINinQEnk1QtQX+xXPaO31nGer2WNTKfd9hERff7w1nZy7BYAksjAEsxTI0gVJGZvUpwUBh2ta+s4PX1VVlyHE1YXSjYQ/9Yar+fnEtivnw2TJeogLPNz+WEnCeFl4MDETh69BYnhSw5o7QQfcg8hD/pUbIf4XcD+PfHorK0wBQzyw1LlGKMTSD2M4piLd14lPn/DDGf9B8BeSmkAArRM3qRtugByDvdSFwjAYp1QvyXIfsXcmYBFqmysd4oHDuuUX1z+7AVzHTCdruTt7c3DYpjwuKPvLLMlURxzAFU12SWybLZljWEWuHe5PsUjbePyValUpZSsah/ARSnC0vkr68xCbbk83npwFLFQkFntVQqIbf0SjuOXawgVN2EznIFsxzgBfaKLVBAABUARI8WiwUFKpePgGTJfpq78QdgGacW8gUFo8mZf11d6cbcr5w0caX9zuWkhisun7/WmyUGECtiK0yp5z8pMxXj8eSoMnzngBV75jrH/wzaKkJ5/CtgmTP0nGKx35dTwvgDSU2BicS0IhsAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/13e85eb3b20b46a553316d0b808df55a/8ac56/client-windbg-005.webp 240w,
/static/13e85eb3b20b46a553316d0b808df55a/d3be9/client-windbg-005.webp 480w,
/static/13e85eb3b20b46a553316d0b808df55a/b9f96/client-windbg-005.webp 657w"
              sizes="(max-width: 657px) 100vw, 657px"
              type="image/webp"
            />
          <source
            srcset="/static/13e85eb3b20b46a553316d0b808df55a/8ff5a/client-windbg-005.png 240w,
/static/13e85eb3b20b46a553316d0b808df55a/e85cb/client-windbg-005.png 480w,
/static/13e85eb3b20b46a553316d0b808df55a/a1253/client-windbg-005.png 657w"
            sizes="(max-width: 657px) 100vw, 657px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/13e85eb3b20b46a553316d0b808df55a/a1253/client-windbg-005.png"
            alt="RSP+0x40 のメモリアドレスを参照する"
            title="RSP+0x40 のメモリアドレスを参照する"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>特に、指定のアドレスの ASCII テキストを参照する <code class="language-text">da RSP+0x40</code> コマンドを実行した場合には、入力した 45 文字の文字列を取得できていることがわかります。</p>
<p><code class="language-text">du RSP+0x40</code> コマンドを実行した場合には、指定のアドレスのデータは Unicode 文字列として解釈されています。(UTF-16 Encoding で 0x4141 の文字)</p>
<p>今回のような ASCII テキストではなく、Unicode テキストがメモリ内に存在する場合は、da ではなく du コマンドを使用します。</p>
<p>なお、今回の入力文字列はスタック領域に直接書き込まれています。</p>
<p>スタック領域の値は上記の Display Memory コマンドでも参照可能ですが、スタックに格納されている値については実行中のアーキテクチャのポインタサイズに合わせて取得する方が解析が容易です。</p>
<p>また、スタック領域にはしばしば実行コードへのポインタアドレスが格納されます。</p>
<p>そのため、スタック領域の参照には特定のメモリ内の値をポインタサイズに合わせた値と、解決可能な場合にはシンボル情報を表示できる dps コマンド <sup id="fnref-6"><a href="#fn-6" class="footnote-ref">6</a></sup> をよく使用します。</p>
<p>実際に <code class="language-text">dps rsp</code> コマンドを実行してみると、<code class="language-text">RSP+0x40</code> 以降の領域に文字 <code class="language-text">A(0x41)</code> が格納されていることを確認できます。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> dps rsp
000000f9`7ecff6d0  00007ff6`0000000a
000000f9`7ecff6d8  000002be`0c567970
000000f9`7ecff6e0  00007fff`7cc0f490 ucrtbase!iob
000000f9`7ecff6e8  00000000`00000000
000000f9`7ecff6f0  00000000`00000002
000000f9`7ecff6f8  00007fff`7cb41d56 ucrtbase!_set_new_mode+0x16
000000f9`7ecff700  00000000`00000000
000000f9`7ecff708  00000000`00000000
000000f9`7ecff710  41414141`41414141
000000f9`7ecff718  41414141`41414141
000000f9`7ecff720  41414141`41414141
000000f9`7ecff728  41414141`41414141
000000f9`7ecff730  41414141`41414141
000000f9`7ecff738  00000041`41414141
000000f9`7ecff740  00008243`49734515
000000f9`7ecff748  00000000`00000000</code></pre></div>
<h2 id="デバッガでプログラムの実行を再開する" style="position:relative;"><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%AC%E3%81%A7%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E5%AE%9F%E8%A1%8C%E3%82%92%E5%86%8D%E9%96%8B%E3%81%99%E3%82%8B" aria-label="デバッガでプログラムの実行を再開する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>デバッガでプログラムの実行を再開する</h2>
<p>設定したブレークポイントで一時停止したプログラムの処理は g コマンド <sup id="fnref-7"><a href="#fn-7" class="footnote-ref">7</a></sup> で再開することができます。</p>
<p>また、ステップ実行とトレース実行はそれぞれ p コマンド(または F10 キー) <sup id="fnref-8"><a href="#fn-8" class="footnote-ref">8</a></sup> と t コマンド(または F11 キー) <sup id="fnref-9"><a href="#fn-9" class="footnote-ref">9</a></sup> が対応しています。</p>
<p>p コマンドは WinDbg の GUI で操作する場合の [Step Over] の操作と対応しています。</p>
<p>そのため、例えば Call 命令の行で p コマンドを実行した場合には、Call 命令の次の行の命令まで実行を進めます。</p>
<p>一方で、t コマンドは [Step Into] の操作と対応しています。</p>
<p>Call 命令の行で実行した場合には、p コマンドとは異なり呼び出し先の関数の先頭アドレスで処理を停止します。</p>
<p>他にも、指定のアドレスまでステップ実行またはトレースを続ける pa、ta コマンドや、次の分岐、リターン命令まで実行を続ける ph、th、pt、tt、また次の Call 命令まで実行する pc、tc コマンドなど、状況に応じてステップ実行やトレースコマンドを使い分けられるようにしておくと便利です。</p>
<h2 id="checkpassword-関数を静的解析する" style="position:relative;"><a href="#checkpassword-%E9%96%A2%E6%95%B0%E3%82%92%E9%9D%99%E7%9A%84%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B" aria-label="checkpassword 関数を静的解析する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>checkPassword 関数を静的解析する</h2>
<p>最低限のデバッガコマンドを紹介したところで、いよいよ checkPassword 関数を解析して Flag を特定していきます。</p>
<p>まずは 3 章と同じ手順で、Binary Ninja を使用して checkPassword 関数のアドレスにアクセスして静的解析を行います。</p>
<p>そして、今度は Graph ビューではなく Linear ビューに表示を変更し、[Pseudo C] からデコンパイルされた疑似コードを確認します。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 615px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/3803bf8c1288f8d196e9cb900d35576f/f6b72/checkpassword-binaryninja-001.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 64.16666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABxklEQVQ4y5VS2XLbMAzU19SiTt4UqcNOlMSe6UxtzzTp/3/JFmDs1H2I0z6sSELEEotFcTwecT6f8fr6E7z/9faG8+mEw+GA/X7/3yhCCEgpYYwJcVowr88YdyvS8oBxmjDNE5btFt4Hgv8UzMNrUdc1tDMYlgQTHNquhzIWxjk4Oiut0DQtxTs0jLbLd5qWYoyupf8NmIdRlJsSfh7weHxBmAJEWcJaizAExDEixAFSa/TWQTpPq4UaInqlYIyGpjOTCyEyCv4opxF3I1WqUVUVNBEoSuDqrLOQSqKieyU9Jq64nMvLnvMYBQf8HLGe9kSaKLGCs+pDQkUQfPmy3ibf4hovRCmgvcX4tMAll4M1wVJftSUYA0+95JVl8iOfkV4IqWfJY/d9JWMGkiCQosfT44whRaSZ3Y/oqE+d7LMB/0zIprBka6mH1HBJBEyivCGS6qN31R3p75IDSV5nuOhIbp2TrergvEMvZY7V117eIXs3ZXNjyjbmYNs25LKksTB5hNj1r6T+VaEiA+LDCEuVsmRJVUmp8uAqo6gygc23zZdy/4zNRIP94xlxiflyHDyWeSR3PRkzYFomeBr0ru/ABdyr8DdezJtHnE+ZpwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/3803bf8c1288f8d196e9cb900d35576f/8ac56/checkpassword-binaryninja-001.webp 240w,
/static/3803bf8c1288f8d196e9cb900d35576f/d3be9/checkpassword-binaryninja-001.webp 480w,
/static/3803bf8c1288f8d196e9cb900d35576f/26ec8/checkpassword-binaryninja-001.webp 615w"
              sizes="(max-width: 615px) 100vw, 615px"
              type="image/webp"
            />
          <source
            srcset="/static/3803bf8c1288f8d196e9cb900d35576f/8ff5a/checkpassword-binaryninja-001.png 240w,
/static/3803bf8c1288f8d196e9cb900d35576f/e85cb/checkpassword-binaryninja-001.png 480w,
/static/3803bf8c1288f8d196e9cb900d35576f/f6b72/checkpassword-binaryninja-001.png 615w"
            sizes="(max-width: 615px) 100vw, 615px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/3803bf8c1288f8d196e9cb900d35576f/f6b72/checkpassword-binaryninja-001.png"
            alt="Binary Ninja で checkPassword 関数のデコンパイル結果を確認する"
            title="Binary Ninja で checkPassword 関数のデコンパイル結果を確認する"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>このデコンパイル結果から構造部分のみ抜粋したコードは以下の通りです。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token class-name">int64_t</span> <span class="token function">checkPassword</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> arg1<span class="token punctuation">)</span>

<span class="token punctuation">{</span>
    <span class="token keyword">void</span> var_f8<span class="token punctuation">;</span>
    <span class="token class-name">int64_t</span> rax_1 <span class="token operator">=</span> <span class="token punctuation">(</span>__security_cookie <span class="token operator">^</span> <span class="token operator">&amp;</span>var_f8<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> r10 <span class="token operator">=</span> arg1<span class="token punctuation">;</span>
    <span class="token class-name">int64_t</span> rax_2 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span>
    <span class="token punctuation">{</span>
        rax_2 <span class="token operator">=</span> <span class="token punctuation">(</span>rax_2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>arg1<span class="token punctuation">[</span>rax_2<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">int32_t</span> rcx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rax_2 <span class="token operator">!=</span> <span class="token number">0x2d</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* no return */</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">int32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">int128_t</span> var_d8<span class="token punctuation">;</span>
    <span class="token class-name">int32_t</span><span class="token operator">*</span> r11 <span class="token operator">=</span> <span class="token operator">&amp;</span>var_d8<span class="token punctuation">;</span>
    <span class="token keyword">do</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">uint64_t</span> rdx_1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>r10<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0x16</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0x22</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0x29</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    rcx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>rdx_1 <span class="token operator">+</span> <span class="token number">0x5f6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0x2a</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    rcx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rdx_1 <span class="token operator">*</span> <span class="token number">0x21</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/* 中略 */</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token number">0x23</span><span class="token operator">:</span>
                    <span class="token punctuation">{</span>
                        rcx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rdx_1 <span class="token operator">*</span> <span class="token number">0x35</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0xdab8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">/* 中略 */</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/* 中略 */</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 中略 */</span>

        <span class="token function">__builtin_memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>var_d8<span class="token punctuation">,</span> <span class="token string">"&lt;ハードコードされたバイト列>"</span><span class="token punctuation">,</span> <span class="token number">0xb4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>rcx <span class="token operator">!=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token punctuation">)</span>r11<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Password is Wrong\n"</span><span class="token punctuation">,</span> rdx_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r10 <span class="token operator">=</span> <span class="token operator">&amp;</span>r10<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        r11 <span class="token operator">=</span> <span class="token operator">&amp;</span>r11<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0x2d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__security_check_cookie</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rax_1 <span class="token operator">^</span> <span class="token operator">&amp;</span>var_f8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>0x14000138a から 0x140001392 までに実行されている以下のコードは 3 章で確認した文字数の検証コードとほとんど同じコードであることがわかります。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">char</span><span class="token operator">*</span> r10 <span class="token operator">=</span> arg1<span class="token punctuation">;</span>
<span class="token class-name">int64_t</span> rax_2 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">do</span>
<span class="token punctuation">{</span>
    rax_2 <span class="token operator">=</span> <span class="token punctuation">(</span>rax_2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>arg1<span class="token punctuation">[</span>rax_2<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">int32_t</span> rcx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>rax_2 <span class="token operator">!=</span> <span class="token number">0x2d</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>checkPassword 関数は、第 1 引数(arg1)としてスタックに格納された入力文字列のポインタアドレスを受け取っています。</p>
<p>この文字列の長さをループ処理で取得した後に、文字列の長さが 45(0x2d) 文字であることを再確認しています。</p>
<p>文字列の長さの検証を突破すると、0x14000139b から 0x1400017dd までの間に、複雑な条件分岐を含むループ処理が実装されていることがわかります。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token class-name">int32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">int128_t</span> var_d8<span class="token punctuation">;</span>
<span class="token class-name">int32_t</span><span class="token operator">*</span> r11 <span class="token operator">=</span> <span class="token operator">&amp;</span>var_d8<span class="token punctuation">;</span>
<span class="token keyword">do</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint64_t</span> rdx_1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>r10<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0x16</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0x22</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0x29</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                rcx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>rdx_1 <span class="token operator">+</span> <span class="token number">0x5f6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/* 中略 */</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* 中略 */</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 中略 */</span>

    <span class="token function">__builtin_memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>var_d8<span class="token punctuation">,</span> <span class="token string">"&lt;ハードコードされたバイト列>"</span><span class="token punctuation">,</span> <span class="token number">0xb4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rcx <span class="token operator">!=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token punctuation">)</span>r11<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Password is Wrong\n"</span><span class="token punctuation">,</span> rdx_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r10 <span class="token operator">=</span> <span class="token operator">&amp;</span>r10<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    r11 <span class="token operator">=</span> <span class="token operator">&amp;</span>r11<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0x2d</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>このループ処理の実装をよく見ると、45(0x2d) 回のループ処理の中で、毎回 <code class="language-text">if (rcx != *(uint32_t*)r11)</code> というコードで何かが検証され、一致しない場合は <code class="language-text">Password is Wrong</code> という文字列が出力されることがわかります。</p>
<p>また、ここで比較されている RCX レジスタには <code class="language-text">rcx = ((int32_t)(rdx_1 + 0x5f6));</code> などの行で加工された <code class="language-text">rdx_1</code> の値が格納されているようです。</p>
<p><code class="language-text">rdx_1</code> には <code class="language-text">uint64_t rdx_1 = ((uint64_t)((int32_t)*(uint8_t*)r10))</code> の行で、ループ処理ごとに 1 文字ずつ取得される入力文字列が格納されています。</p>
<p>また、r11 には、ハードコードされたバイト列 <code class="language-text">var_d8</code> から順番に取り出した int32 型の整数値が格納されています。</p>
<p>つまり、checkPassword 関数では、ループ処理の中で入力文字列を先頭から順に取り出し、複雑な条件分岐の後に何らかの演算を行った上で、ハードコードされたバイト列と一致するかを確認し、すべての文字の検証に成功した場合にのみ 0 を返却する関数であると推測できます。</p>
<h2 id="checkpassword-関数を動的解析する" style="position:relative;"><a href="#checkpassword-%E9%96%A2%E6%95%B0%E3%82%92%E5%8B%95%E7%9A%84%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B" aria-label="checkpassword 関数を動的解析する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>checkPassword 関数を動的解析する</h2>
<p>それでは、上記の推測が正しいか実際にデバッガを使用して確認してみましょう。</p>
<p>まずはコマンドウィンドウで以下のコマンドを順に実行します。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell"><span class="token punctuation">.</span>restart
bp <span class="token operator">!</span>DoPClient+0x13a2 <span class="token punctuation">;</span> bp <span class="token operator">!</span>DoPClient+0x17ca <span class="token punctuation">;</span> g</code></pre></div>
<p>.restart コマンドを実行すると、デバッグ対象のプログラムが再起動され、ブレークポイントなどの設定もリセットされます。</p>
<p>そして、<code class="language-text">bp !DoPClient+0x13a2 ; bp !DoPClient+0x17ca ; g</code> では、ワンライナーで複数のブレークポイントを 2 つ設定した後、プログラムの実行を再開しています。</p>
<p>このように、WinDbg ではセミコロン(<code class="language-text">;</code>)で連結することで複数のコマンドをまとめて実行できます。</p>
<p>上記のコマンドでは、ループ処理の中で入力文字から 1 文字を抜き出すコードと、入力文字に何らかの演算を行った結果とハードコードされた整数値を比較するコードの 2 箇所にブレークポイントを設定しています。</p>
<p>プログラムを実行して 45 文字の <code class="language-text">A(0x41)</code> を入力すると、まずはじめに入力文字列から 1 文字を取り出すコード <code class="language-text">movsx  edx,byte ptr [r10]</code> の実行直前のタイミングでプログラムが一時停止します。</p>
<p>この時点では、 EDX レジスタには入力された文字ではなく 0x7cc0f490 という値が格納されています。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> g
Breakpoint 0 hit
DoPClient+0x13a2:
00007ff6`dd0913a2 410fbe12  movsx   edx<span class="token punctuation">,</span>byte ptr <span class="token namespace">[r10]</span> ds:000000bd`b9cffc80=41

0:000> r edx
edx=7cc0f490</code></pre></div>
<p>ここで、p コマンドでプログラムをステップ実行すると、r10 に格納されているアドレスから 1 文字目の <code class="language-text">A(0x41)</code> が EDX に格納されたことを確認できました。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> p
DoPClient+0x13a6:
00007ff6`dd0913a6 4183f816        cmp     r8d<span class="token punctuation">,</span>16h

0:000> r edx
edx=41</code></pre></div>
<p>次に、もう 1 度 g コマンドでプログラムの実行を再開すると、2 つ目のブレークポイント <code class="language-text">DoPClient+0x17ca</code> で実行が一時停止します。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> g
Breakpoint 1 hit
DoPClient+0x17ca:
00007ff6`dd0917ca 413b0b          cmp     ecx<span class="token punctuation">,</span>dword ptr <span class="token namespace">[r11]</span> ds:00000055`a5effc90=000021a7</code></pre></div>
<p>この時点では、ECX レジスタには整数値 2076 が格納されているものの、比較対象の R11 レジスタが指すポインタアドレスには、整数値 8615 が格納されています。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> r ecx
ecx=2076

0:000> dd r11 L1 <span class="token punctuation">;</span> ? <span class="token variable">$p</span>
00000055`a5effc90  000021a7
Evaluate expression: 8615 = 00000000`000021a7</code></pre></div>
<p>そのため、最初の入力文字が <code class="language-text">A(0x41)</code> の場合には、<code class="language-text">if (rcx != *(uint32_t*)r11)</code> のコードでの検証に失敗し、 <code class="language-text">Password is Wrong</code> という出力とともにプログラムが終了してしまいます。</p>
<p>ちなみに、ここで実行している <code class="language-text">dd r11 L1 ; ? $p</code> というコマンドは WinDbg の疑似レジスタ <sup id="fnref-10"><a href="#fn-10" class="footnote-ref">10</a></sup> を利用しています。</p>
<p>疑似レジスタとは、デバッガ内で特定の値を保持するために使用される値です。</p>
<p>そして、疑似レジスタ $p には、直前の Display Memory コマンドが出力した値が格納されます。</p>
<p>そのため、<code class="language-text">dd r11 L1</code> コマンドで取得した R11 レジスタが指す DWORD サイズの値を <code class="language-text">? $p</code> で評価させることで、0x21a7 を 10 進数の整数値 8615 として出力させています。</p>
<p>このような疑似レジスタを利用した記法は、ワンライナーコマンドやスクリプティングを行う際に応用できるので、覚えておくと便利です。</p>
<h2 id="正しい文字列を入力した場合の動作を解析する" style="position:relative;"><a href="#%E6%AD%A3%E3%81%97%E3%81%84%E6%96%87%E5%AD%97%E5%88%97%E3%82%92%E5%85%A5%E5%8A%9B%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E5%8B%95%E4%BD%9C%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B" aria-label="正しい文字列を入力した場合の動作を解析する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>正しい文字列を入力した場合の動作を解析する</h2>
<p>パスワード文字の検証を行っていると思われる箇所にブレークポイントをセットしたものの、<code class="language-text">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</code> を入力文字とした場合には検証をパスすることができませんでした。</p>
<p>そこで次は、正しい Flag フォーマットを満たす 45 文字の文字列 <code class="language-text">FLAG{ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklm}</code> を入力値として再度プログラムを実行してみます。</p>
<p>すると、最初のブレークポイントのコード(<code class="language-text">movsx  edx,byte ptr [r10]</code>)で EDX レジスタに格納される値が <code class="language-text">A(0x41)</code> から <code class="language-text">F(0x46)</code> に変化しました。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> g
Breakpoint 0 hit
DoPClient+0x13a2:
00007ff6`dd0913a2 410fbe12        movsx   edx<span class="token punctuation">,</span>byte ptr <span class="token namespace">[r10]</span> ds:0000001a`ed4ffaf0=46

0:000> p
DoPClient+0x13a6:
00007ff6`dd0913a6 4183f816        cmp     r8d<span class="token punctuation">,</span>16h

0:000> r edx
edx=46</code></pre></div>
<p>そして、2 つ目のブレークポイントに設定した行では、ECX レジスタの値と R11 レジスタが指す整数値が一致していることから、1 文字目が <code class="language-text">F(0x46)</code> の場合には最初の検証をパスすることができることがわかりました。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> g
Breakpoint 1 hit
DoPClient+0x17ca:
00007ff6`dd0917ca 413b0b          cmp     ecx<span class="token punctuation">,</span>dword ptr <span class="token namespace">[r11]</span> ds:0000001a`ed4ff9d0=000021a7

0:000> r ecx
ecx=21a7

0:000> dd r11 L1 <span class="token punctuation">;</span> ? <span class="token variable">$p</span>
0000001a`ed4ff9d0  000021a7
Evaluate expression: 8615 = 00000000`000021a7</code></pre></div>
<p>このことからも、checkPassword 関数では 45(0x2d) 回のループ処理の中で、入力された文字列を 1 文字ずつ取り出して何らかの演算を行った値と、ハードコードされた整数値が一致するかどうかを検証しているという仮説が正しそうであることがわかります。</p>
<p>その後も処理を継続してみると、<code class="language-text">if (rcx != *(uint32_t*)r11)</code> のコードで行われる検証に 5 回パスした後、6 回目の検証に失敗してプログラムが終了しました。</p>
<p>入力文字列のうち、<code class="language-text">FLAG{</code> という最初の 5 文字が正しいパスワードと一致したために、5 回の検証に成功し、6 回目で失敗した可能性が高そうです。</p>
<h2 id="javascript-ベースのデバッグスクリプトを使用する" style="position:relative;"><a href="#javascript-%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B" aria-label="javascript ベースのデバッグスクリプトを使用する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JavaScript ベースのデバッグスクリプトを使用する</h2>
<p>正しい Flag を取得するため、DoPClient がパスワードを検証する際の動作についてもう少し詳しく調べてみましょう。</p>
<p>具体的には、Flag の検証が入力文字列の先頭から 1 文字ずつ行われているかどうかを特定したいです。</p>
<p>そのためには、デバッガを使用して以下の操作を行う必要があります。</p>
<ol>
<li>入力文字列から 1 文字を取り出した直後の <code class="language-text">DoPClient+0x13a6</code> にブレークポイントを設定して、45 回のループ処理の中で文字列が先頭から取り出されているかを確認する。</li>
<li>入力文字に何らかの演算を行った結果を比較した直後の <code class="language-text">DoPClient+0x17cd</code> にブレークポイントを設定して、検証にパスするかどうかを確認する。</li>
<li>入力文字で検証に失敗した場合は、プログラムを終了させずループ処理を継続するためにゼロフラグの値を改ざんする。</li>
</ol>
<p>上記の操作を行うため、今回は WinDbg のコマンド操作を自動化してみます。</p>
<p>WinDbg では、デバッグ操作を自動化する方法はいくつか用意されていますが、まずは最新の WinDbg で利用できる JavaScript ベースのデバッガスクリプト <sup id="fnref-11"><a href="#fn-11" class="footnote-ref">11</a></sup> を使用します。</p>
<p>最新の WinDbg では既定で JavaScript ベースのデバッガスクリプトを使用できますが、念のためスクリプトプロバイダがデバッガにロードされていることを確認します。</p>
<p>現在起動中の WinDbg で <code class="language-text">.scriptproviders</code> コマンドを実行し、<code class="language-text">JavaScript (extension '.js')</code> が一覧に表示されている場合は、スクリプトプロバイダがデバッガにロードされていると判断できます。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> <span class="token punctuation">.</span>scriptproviders
Available Script Providers:
    NatVis <span class="token punctuation">(</span>extension <span class="token string">'.NatVis'</span><span class="token punctuation">)</span>
    JavaScript <span class="token punctuation">(</span>extension <span class="token string">'.js'</span><span class="token punctuation">)</span></code></pre></div>
<p>JavaScript ベースのデバッガスクリプトを使用する場合、事前に作成した JavaScript ファイルを、<code class="language-text">.scriptload</code> または <code class="language-text">.scriptrun</code> コマンドで読み取る必要があります。</p>
<p>実際に問題バイナリの解析用のスクリプトを作成する前に、以下のサンプルスクリプトを実行してみましょう。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token string">"use strict"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">initializeScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    host<span class="token punctuation">.</span>diagnostics<span class="token punctuation">.</span><span class="token function">debugLog</span><span class="token punctuation">(</span><span class="token string">"RunCommands>; initializeScript was called \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">invokeScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    host<span class="token punctuation">.</span>diagnostics<span class="token punctuation">.</span><span class="token function">debugLog</span><span class="token punctuation">(</span><span class="token string">"RunCommands>; invokeScript was called \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">uninitializeScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    host<span class="token punctuation">.</span>diagnostics<span class="token punctuation">.</span><span class="token function">debugLog</span><span class="token punctuation">(</span><span class="token string">"RunCommands>; uninitialize was called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">RunCommands</span><span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">var</span> ctl <span class="token operator">=</span> host<span class="token punctuation">.</span>namespace<span class="token punctuation">.</span>Debugger<span class="token punctuation">.</span>Utility<span class="token punctuation">.</span>Control<span class="token punctuation">;</span>   
	<span class="token keyword">var</span> output <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">ExecuteCommand</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	host<span class="token punctuation">.</span>diagnostics<span class="token punctuation">.</span><span class="token function">debugLog</span><span class="token punctuation">(</span><span class="token string">"RunCommands> Displaying command output \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> line <span class="token keyword">of</span> output<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		host<span class="token punctuation">.</span>diagnostics<span class="token punctuation">.</span><span class="token function">debugLog</span><span class="token punctuation">(</span><span class="token string">"  "</span><span class="token punctuation">,</span> line<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	host<span class="token punctuation">.</span>diagnostics<span class="token punctuation">.</span><span class="token function">debugLog</span><span class="token punctuation">(</span><span class="token string">"RunCommands> Exiting RunCommands Function \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>このサンプルスクリプトは、以下の Github リポジトリからもダウンロードできます。</p>
<br>
<p>RunCommands.js：</p>
<p><a href="https://github.com/kash1064/ctf-and-windows-debug/blob/main/RunCommands.js" target="_blank" rel="nofollow noopener noreferrer">https://github.com/kash1064/ctf-and-windows-debug/</a></p>
<br>
<p>このサンプルスクリプトを <code class="language-text">C:\CTF\RunCommands.js</code> として仮想マシンに保存したら、WinDbg で .scriptrun コマンドを実行してみましょう。</p>
<p>.scriptrun コマンドは、スクリプトをロードし、ルートコード、そして initializeScript と invokeScript 関数を順に実行するコマンドです。</p>
<p>そのため、<code class="language-text">.scriptrun C:\CTF\RunCommands.js</code> を実行すると、以下のように initializeScript と invokeScript 関数内で定義した debugLog 関数が実行されるとともに、スクリプトがデバッガにロードされたことを .scriptlist コマンドで確認できるようになります。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> <span class="token punctuation">.</span>scriptrun C:\CTF\RunCommands<span class="token punctuation">.</span>js
RunCommands><span class="token punctuation">;</span> initializeScript was called 
JavaScript script successfully loaded <span class="token keyword">from</span> <span class="token string">'C:\CTF\RunCommands.js'</span>
RunCommands><span class="token punctuation">;</span> invokeScript was called

0:000> <span class="token punctuation">.</span>scriptlist
Command Loaded Scripts:
    <span class="token punctuation">{</span>中略<span class="token punctuation">}</span>
    JavaScript script <span class="token keyword">from</span> <span class="token string">'C:\CTF\RunCommands.js'</span>
Other Clients' Scripts:
    &lt;None Loaded></code></pre></div>
<p>次に、<code class="language-text">.scriptunload C:\CTF\RunCommands.js</code> コマンドでスクリプトをアンロードした後に、今度は <code class="language-text">.scriptload C:\CTF\RunCommands.js</code> コマンドでスクリプトをロードしてみます。</p>
<p><code class="language-text">.scriptunload C:\CTF\RunCommands.js</code> コマンドが実行された場合には、アンロードルーチンとして uninitializeScript 関数が実行されます。</p>
<p>そして、.scriptload コマンドを実行した場合には、initializeScript 関数のみが実行されます。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> <span class="token punctuation">.</span>scriptunload C:\CTF\RunCommands<span class="token punctuation">.</span>js
RunCommands><span class="token punctuation">;</span> uninitialize was called
JavaScript script unloaded <span class="token keyword">from</span> <span class="token string">'C:\CTF\RunCommands.js'</span>

0:000> <span class="token punctuation">.</span>scriptload C:\CTF\RunCommands<span class="token punctuation">.</span>js
RunCommands><span class="token punctuation">;</span> initializeScript was called 
JavaScript script successfully loaded <span class="token keyword">from</span> <span class="token string">'C:\CTF\RunCommands.js'</span></code></pre></div>
<p>スクリプトファイルのロードに成功したので、独自に実装した関数 RunCommands をデバッガから実行します。</p>
<p>この関数は引数として受け取ったデバッガコマンドを WinDbg で実行し、出力結果をコンソール上に表示する関数です。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">RunCommands</span><span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">var</span> ctl <span class="token operator">=</span> host<span class="token punctuation">.</span>namespace<span class="token punctuation">.</span>Debugger<span class="token punctuation">.</span>Utility<span class="token punctuation">.</span>Control<span class="token punctuation">;</span>   
	<span class="token keyword">var</span> output <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">ExecuteCommand</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	host<span class="token punctuation">.</span>diagnostics<span class="token punctuation">.</span><span class="token function">debugLog</span><span class="token punctuation">(</span><span class="token string">"RunCommands> Displaying command output \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> line <span class="token keyword">of</span> output<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		host<span class="token punctuation">.</span>diagnostics<span class="token punctuation">.</span><span class="token function">debugLog</span><span class="token punctuation">(</span><span class="token string">"  "</span><span class="token punctuation">,</span> line<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	host<span class="token punctuation">.</span>diagnostics<span class="token punctuation">.</span><span class="token function">debugLog</span><span class="token punctuation">(</span><span class="token string">"RunCommands> Exiting RunCommands Function \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>ロードした関数にデバッガからアクセスするには dx コマンドを使用します。</p>
<p>RunCommands 関数を実行するには、<code class="language-text">dx Debugger.State.Scripts.RunCommands.Contents.RunCommands("&lt;コマンド>")</code> を実行します。</p>
<p>以下は、<code class="language-text">RunCommands("lm")</code> と <code class="language-text">RunCommands("~k")</code> を実行した結果です。</p>
<p>WinDbg のコマンドウィンドウから直接 lm や ~k コマンドを実行した場合の出力と同じ結果を得られることがわかります。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> dx Debugger<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Scripts<span class="token punctuation">.</span>RunCommands<span class="token punctuation">.</span>Contents<span class="token punctuation">.</span>RunCommands<span class="token punctuation">(</span><span class="token string">"lm"</span><span class="token punctuation">)</span>
RunCommands> Displaying command output 
  <span class="token function">start</span>             <span class="token keyword">end</span>                 module name
  00007ff6`dd090000 00007ff6`dd099000   DoPClient C <span class="token punctuation">(</span>no symbols<span class="token punctuation">)</span>           
  00007fff`675f0000 00007fff`6760d000   VCRUNTIME140   <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7cb20000 00007fff`7cc20000   ucrtbase   <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7cc20000 00007fff`7cf16000   KERNELBASE   <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7d080000 00007fff`7d0a7000   bcrypt     <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7dc90000 00007fff`7ddb3000   RPCRT4     <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7deb0000 00007fff`7df4e000   msvcrt     <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7e610000 00007fff`7e6b0000   sechost    <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7e970000 00007fff`7ea2d000   KERNEL32   <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7eb90000 00007fff`7ec40000   ADVAPI32   <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7f130000 00007fff`7f328000   ntdll      <span class="token punctuation">(</span>pdb symbols<span class="token punctuation">)</span>          C:\ProgramData\Dbg\sym\ntdll<span class="token punctuation">.</span>pdb\1669C503FDE3540E0A2FBE91C81204361\ntdll<span class="token punctuation">.</span>pdb
RunCommands> Exiting RunCommands <span class="token keyword">Function</span> 
Debugger<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Scripts<span class="token punctuation">.</span>RunCommands<span class="token punctuation">.</span>Contents<span class="token punctuation">.</span>RunCommands<span class="token punctuation">(</span><span class="token string">"lm"</span><span class="token punctuation">)</span>

0:000> dx Debugger<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Scripts<span class="token punctuation">.</span>RunCommands<span class="token punctuation">.</span>Contents<span class="token punctuation">.</span>RunCommands<span class="token punctuation">(</span><span class="token string">"~k"</span><span class="token punctuation">)</span>
RunCommands> Displaying command output 
   <span class="token comment"># Child-SP          RetAddr               Call Site</span>
  00 00000024`05cff758 00007fff`7f1fca0e     ntdll!DbgBreakPoint
  01 00000024`05cff760 00007fff`7e987344     ntdll!DbgUiRemoteBreakin+0x4e
  02 00000024`05cff790 00007fff`7f1826b1     KERNEL32!BaseThreadInitThunk+0x14
  03 00000024`05cff7c0 00000000`00000000     ntdll!RtlUserThreadStart+0x21
RunCommands> Exiting RunCommands <span class="token keyword">Function</span> 
Debugger<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Scripts<span class="token punctuation">.</span>RunCommands<span class="token punctuation">.</span>Contents<span class="token punctuation">.</span>RunCommands<span class="token punctuation">(</span><span class="token string">"~k"</span><span class="token punctuation">)</span></code></pre></div>
<p>ちなみに、カスタム関数を実行するたびに <code class="language-text">Debugger.State.Scripts.RunCommands.Contents.RunCommands("&lt;コマンド>)</code> を実行するのは不便です。</p>
<p>そのため、dx コマンドでロードしたスクリプトの情報(<code class="language-text">Debugger.State.Scripts.RunCommands.Contents</code>)をカスタム変数として登録すると便利です。</p>
<p>RunCommands.js を変数として登録するには、<code class="language-text">dx @$runCommand = Debugger.State.Scripts.RunCommands.Contents</code> コマンドを実行します。</p>
<p>これで、<code class="language-text">dx @$runCommand.RunCommands("lm")</code> や <code class="language-text">dx @$runCommand.RunCommands("~k")</code> を実行することで、カスタム関数 RunCommands を実行できるようになりました。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> dx @<span class="token variable">$runCommand</span> = Debugger<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Scripts<span class="token punctuation">.</span>RunCommands<span class="token punctuation">.</span>Contents
@<span class="token variable">$runCommand</span> = Debugger<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Scripts<span class="token punctuation">.</span>RunCommands<span class="token punctuation">.</span>Contents                 : <span class="token namespace">[object Object]</span>
    host             : <span class="token namespace">[object Object]</span>

0:000> dx @<span class="token variable">$runCommand</span><span class="token punctuation">.</span>RunCommands<span class="token punctuation">(</span><span class="token string">"lm"</span><span class="token punctuation">)</span>
RunCommands> Displaying command output 
  <span class="token function">start</span>             <span class="token keyword">end</span>                 module name
  00007ff6`dd090000 00007ff6`dd099000   DoPClient C <span class="token punctuation">(</span>no symbols<span class="token punctuation">)</span>           
  00007fff`675f0000 00007fff`6760d000   VCRUNTIME140   <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7cb20000 00007fff`7cc20000   ucrtbase   <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7cc20000 00007fff`7cf16000   KERNELBASE   <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7d080000 00007fff`7d0a7000   bcrypt     <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7dc90000 00007fff`7ddb3000   RPCRT4     <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7deb0000 00007fff`7df4e000   msvcrt     <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7e610000 00007fff`7e6b0000   sechost    <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7e970000 00007fff`7ea2d000   KERNEL32   <span class="token punctuation">(</span>pdb symbols<span class="token punctuation">)</span>          C:\ProgramData\Dbg\sym\kernel32<span class="token punctuation">.</span>pdb\B07C97792B439ABC0DF83499536C7AE51\kernel32<span class="token punctuation">.</span>pdb
  00007fff`7eb90000 00007fff`7ec40000   ADVAPI32   <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
  00007fff`7f130000 00007fff`7f328000   ntdll      <span class="token punctuation">(</span>pdb symbols<span class="token punctuation">)</span>          C:\ProgramData\Dbg\sym\ntdll<span class="token punctuation">.</span>pdb\1669C503FDE3540E0A2FBE91C81204361\ntdll<span class="token punctuation">.</span>pdb
RunCommands> Exiting RunCommands <span class="token keyword">Function</span> 
@<span class="token variable">$runCommand</span><span class="token punctuation">.</span>RunCommands<span class="token punctuation">(</span><span class="token string">"lm"</span><span class="token punctuation">)</span>

0:000> dx @<span class="token variable">$runCommand</span><span class="token punctuation">.</span>RunCommands<span class="token punctuation">(</span><span class="token string">"~k"</span><span class="token punctuation">)</span>
RunCommands> Displaying command output 
   <span class="token comment"># Child-SP          RetAddr               Call Site</span>
  00 00000024`05cffb08 00007fff`7f1fca0e     ntdll!DbgBreakPoint
  01 00000024`05cffb10 00007fff`7e987344     ntdll!DbgUiRemoteBreakin+0x4e
  02 00000024`05cffb40 00007fff`7f1826b1     KERNEL32!BaseThreadInitThunk+0x14
  03 00000024`05cffb70 00000000`00000000     ntdll!RtlUserThreadStart+0x21
RunCommands> Exiting RunCommands <span class="token keyword">Function</span> 
@<span class="token variable">$runCommand</span><span class="token punctuation">.</span>RunCommands<span class="token punctuation">(</span><span class="token string">"~k"</span><span class="token punctuation">)</span></code></pre></div>
<h2 id="スクリプトでデバッガ操作を自動化する" style="position:relative;"><a href="#%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%AC%E6%93%8D%E4%BD%9C%E3%82%92%E8%87%AA%E5%8B%95%E5%8C%96%E3%81%99%E3%82%8B" aria-label="スクリプトでデバッガ操作を自動化する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>スクリプトでデバッガ操作を自動化する</h2>
<p>JavaScript ベースのデバッガスクリプトを利用できるようになったので、前述した以下の操作を自動化するスクリプトを作成します。</p>
<ol>
<li>入力文字列から 1 文字を取り出した直後の <code class="language-text">DoPClient+0x13a6</code> にブレークポイントを設定して、45 回のループ処理の中で文字列が先頭から取り出されているかを確認する。</li>
<li>入力文字に何らかの演算を行った結果を比較した直後の <code class="language-text">DoPClient+0x17cd</code> にブレークポイントを設定して、検証にパスするかどうかを確認する。</li>
<li>入力文字で検証に失敗した場合は、プログラムを終了させずループ処理を継続するためにゼロフラグの値を改ざんする。</li>
</ol>
<p>上記の操作を自動化するため、以下の JavaScript を作成しました。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// .scriptrun C:\CTF\Autorun.js</span>
<span class="token comment">// FLAG{AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA}</span>
<span class="token string">"use strict"</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> word <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> a1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">RunCommands</span><span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> ctl <span class="token operator">=</span> host<span class="token punctuation">.</span>namespace<span class="token punctuation">.</span>Debugger<span class="token punctuation">.</span>Utility<span class="token punctuation">.</span>Control<span class="token punctuation">;</span>
	<span class="token keyword">let</span> output <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">ExecuteCommand</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> line <span class="token keyword">of</span> output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		host<span class="token punctuation">.</span>diagnostics<span class="token punctuation">.</span><span class="token function">debugLog</span><span class="token punctuation">(</span><span class="token string">"  "</span><span class="token punctuation">,</span> line<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> output<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">SetBreakPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> ctl <span class="token operator">=</span> host<span class="token punctuation">.</span>namespace<span class="token punctuation">.</span>Debugger<span class="token punctuation">.</span>Utility<span class="token punctuation">.</span>Control<span class="token punctuation">;</span>
	<span class="token keyword">let</span> breakpoint<span class="token punctuation">;</span>

	breakpoint <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">SetBreakpointAtOffset</span><span class="token punctuation">(</span><span class="token string">"DoPClient"</span><span class="token punctuation">,</span> <span class="token number">0x13a6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	breakpoint<span class="token punctuation">.</span>Command <span class="token operator">=</span> <span class="token string">"dx -r1 @$autoRun.CheckPoint1() ; g"</span><span class="token punctuation">;</span>

	breakpoint <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">SetBreakpointAtOffset</span><span class="token punctuation">(</span><span class="token string">"DoPClient"</span><span class="token punctuation">,</span> <span class="token number">0x17cd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	breakpoint<span class="token punctuation">.</span>Command <span class="token operator">=</span> <span class="token string">"dx -r1 @$autoRun.CheckPoint2() ; r zf = 1 ; g"</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> line <span class="token keyword">of</span> a1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		host<span class="token punctuation">.</span>diagnostics<span class="token punctuation">.</span><span class="token function">debugLog</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> line<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">CheckPoint1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> context <span class="token operator">=</span> host<span class="token punctuation">.</span>namespace<span class="token punctuation">.</span>Debugger<span class="token punctuation">.</span>State<span class="token punctuation">.</span>DebuggerVariables<span class="token punctuation">.</span>curthread<span class="token punctuation">.</span>Registers<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
	<span class="token keyword">let</span> edxValue <span class="token operator">=</span> context<span class="token punctuation">.</span>edx<span class="token punctuation">;</span>
	word <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">fromCodePoint</span><span class="token punctuation">(</span>edxValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">CheckPoint2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> context <span class="token operator">=</span> host<span class="token punctuation">.</span>namespace<span class="token punctuation">.</span>Debugger<span class="token punctuation">.</span>State<span class="token punctuation">.</span>DebuggerVariables<span class="token punctuation">.</span>curthread<span class="token punctuation">.</span>Registers<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
	<span class="token keyword">var</span> memory <span class="token operator">=</span> host<span class="token punctuation">.</span>memory<span class="token punctuation">;</span>
	<span class="token keyword">let</span> edxValue <span class="token operator">=</span> context<span class="token punctuation">.</span>ecx<span class="token punctuation">;</span>
	<span class="token keyword">let</span> r11Value <span class="token operator">=</span> context<span class="token punctuation">.</span>r11<span class="token punctuation">;</span>
	<span class="token keyword">let</span> int32Value <span class="token operator">=</span> memory<span class="token punctuation">.</span><span class="token function">readMemoryValues</span><span class="token punctuation">(</span>r11Value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	a1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"Result: Word is "</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">" EDX = "</span> <span class="token operator">+</span> edxValue<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" R11 = "</span> <span class="token operator">+</span> int32Value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" IsValid = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>edxValue<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>int32Value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initializeScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">[</span>
		<span class="token keyword">new</span> <span class="token class-name">host<span class="token punctuation">.</span>apiVersionSupport</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">invokeScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">RunCommands</span><span class="token punctuation">(</span><span class="token string">"dx @$autoRun = Debugger.State.Scripts.Autorun.Contents"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RunCommands</span><span class="token punctuation">(</span><span class="token string">"dx @$autoRun.SetBreakPoints()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RunCommands</span><span class="token punctuation">(</span><span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>このコードは、以下の Github リポジトリから Autorun.js としてダウンロードできます。</p>
<br>
<p>Autorun.js：</p>
<p><a href="https://github.com/kash1064/ctf-and-windows-debug/blob/main/Autorun.js" target="_blank" rel="nofollow noopener noreferrer">https://github.com/kash1064/ctf-and-windows-debug/blob/main/Autorun.js</a></p>
<br>
<p>このコードを <code class="language-text">.scriptrun C:\CTF\Autorun.js</code> コマンドでロードすると、はじめに initializeScript 関数と invokeScript 関数が実行されます。</p>
<p>initializeScript 関数では、<code class="language-text">new host.apiVersionSupport(1, 7)</code> にて使用する API のバージョンを宣言しています。</p>
<p>そして、invokeScript 関数では、<code class="language-text">@$autoRun</code> オブジェクトの定義と、SetBreakPoints 関数の実行を行っています。</p>
<p>SetBreakPoints 関数では <code class="language-text">Debugger.Utility.Control</code> の SetBreakpointAtOffset を使用して <code class="language-text">DoPClient+0x13a6</code> と <code class="language-text">DoPClient+0x17cd</code> にブレークポイントを設定しています。</p>
<p>また、Command 要素を指定することで、ブレークポイントに到達した際に実行するコマンドを指定しています。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">SetBreakPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> ctl <span class="token operator">=</span> host<span class="token punctuation">.</span>namespace<span class="token punctuation">.</span>Debugger<span class="token punctuation">.</span>Utility<span class="token punctuation">.</span>Control<span class="token punctuation">;</span>
	<span class="token keyword">let</span> breakpoint<span class="token punctuation">;</span>

	breakpoint <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">SetBreakpointAtOffset</span><span class="token punctuation">(</span><span class="token string">"DoPClient"</span><span class="token punctuation">,</span> <span class="token number">0x13a6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	breakpoint<span class="token punctuation">.</span>Command <span class="token operator">=</span> <span class="token string">"dx -r1 @$autoRun.CheckPoint1() ; g"</span><span class="token punctuation">;</span>

	breakpoint <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">SetBreakpointAtOffset</span><span class="token punctuation">(</span><span class="token string">"DoPClient"</span><span class="token punctuation">,</span> <span class="token number">0x17cd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	breakpoint<span class="token punctuation">.</span>Command <span class="token operator">=</span> <span class="token string">"dx -r1 @$autoRun.CheckPoint2() ; r zf = 1 ; g"</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>このスクリプトが実行された後に bl コマンドを実行すると、コマンド付きのブレークポイントが定義されたことを確認できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/06d7818537330fb97c6fa4483f1699ae/b12f7/client-windbg-006.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 6.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAARElEQVQI1y3GMQqAMAxAUe9/ww62CYQGTIpkcvwWcXjwjoiL1u7tQYYzRkdViQj62Zlz4u6ICCr6XfflZ2ZkJmstqooXk4BJf7fXftgAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/06d7818537330fb97c6fa4483f1699ae/8ac56/client-windbg-006.webp 240w,
/static/06d7818537330fb97c6fa4483f1699ae/d3be9/client-windbg-006.webp 480w,
/static/06d7818537330fb97c6fa4483f1699ae/e46b2/client-windbg-006.webp 960w,
/static/06d7818537330fb97c6fa4483f1699ae/52c2b/client-windbg-006.webp 1020w"
              sizes="(max-width: 960px) 100vw, 960px"
              type="image/webp"
            />
          <source
            srcset="/static/06d7818537330fb97c6fa4483f1699ae/8ff5a/client-windbg-006.png 240w,
/static/06d7818537330fb97c6fa4483f1699ae/e85cb/client-windbg-006.png 480w,
/static/06d7818537330fb97c6fa4483f1699ae/d9199/client-windbg-006.png 960w,
/static/06d7818537330fb97c6fa4483f1699ae/b12f7/client-windbg-006.png 1020w"
            sizes="(max-width: 960px) 100vw, 960px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/06d7818537330fb97c6fa4483f1699ae/d9199/client-windbg-006.png"
            alt="スクリプトで設定したブレークポイント"
            title="スクリプトで設定したブレークポイント"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>なお、<code class="language-text">Debugger.Utility.Control.SetBreakpointAtOffset</code> などの便利なコマンドについては、現在のところあまりドキュメントは充実していません。</p>
<p>しかし、WinDbg で dx コマンドを使用して <code class="language-text">dx -r1 Debugger.Utility.Control</code> などによってオブジェクトの情報を参照することで、各コマンドについて詳細な説明を参照することができます。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0:000> dx <span class="token operator">-</span>r1 Debugger<span class="token punctuation">.</span>Utility<span class="token punctuation">.</span>Control
              
ExecuteCommand   <span class="token namespace">[ExecuteCommand(command) - Method which executes a debugger command and returns a collection of strings representing the lines of output of the command execution]</span>

SetBreakpointAtSourceLocation <span class="token namespace">[SetBreakpointAtSourceLocation(source_file, source_line, (opt) module_name) - Method which sets a breakpoint at a source line location and returns it as an object in order to be able to control its options]</span>

SetBreakpointAtOffset <span class="token namespace">[SetBreakpointAtOffset(function_name, function_offset, (opt) module_name) - Method which sets a breakpoint at an offset and returns it as an object in order to be able to control its options]</span>

SetBreakpointForReadWrite <span class="token namespace">[SetBreakpointForReadWrite(address, (opt) type, (opt) size) - Method which sets a breakpoint on read/write (default) at a certain address and returns it as an object in order to be able to control its options]</span>

ChangeRegisterContext <span class="token namespace">[ChangeRegisterContext(inheritUnspecifiedValues, pc, sp, [fp], [regCtx]) | ChangeRegisterContext(inheritUnspecifiedValues, regCtx) - Changes the active register context with a given abstract pc, sp, and optional fp or an optional object which contains named registers and values.  This is largely equivalent to having done .cxr in the debugger.  It does *NOT* change the register values of the thread/processor, only the debugger's current view of them]</span>

WalkStackForRegisterContext <span class="token namespace">[WalkStackForRegisterContext(inheritUnspecifiedValues, pc, sp, [fp], [regCtx]) | WalkStackForRegisterContext(inheritUnspecifiedValues, regCtx) - Performs a stack walk given the incoming abstract pc, sp, and optional fp or an optional object which contains named registers and values.  The returned stack walk is of the same form as &lt;ThreadObject>.Stack]</span></code></pre></div>
<p>このデバッガスクリプトをロードした後、プログラムを実行して <code class="language-text">FLAG{AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA}</code> のような 45 文字のダミー Flag を入力すると、最初のブレークポイント <code class="language-text">DoPClient+0x13a6</code> に到達し、<code class="language-text">dx -r1 @$autoRun.CheckPoint1() ; g</code> が実行されます。</p>
<p>ここで実行される CheckPoint1 関数では、一時停止したタイミングの EDX レジスタの値を ASCII 文字としてグローバル変数 word に格納します。</p>
<p>本章でここまでに解析した結果が正しければ、この word にはユーザが入力したパスワード文字列が 1 文字ずつ格納されるはずです。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">CheckPoint1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> context <span class="token operator">=</span> host<span class="token punctuation">.</span>namespace<span class="token punctuation">.</span>Debugger<span class="token punctuation">.</span>State<span class="token punctuation">.</span>DebuggerVariables<span class="token punctuation">.</span>curthread<span class="token punctuation">.</span>Registers<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
	<span class="token keyword">let</span> edxValue <span class="token operator">=</span> context<span class="token punctuation">.</span>edx<span class="token punctuation">;</span>
	word <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">fromCodePoint</span><span class="token punctuation">(</span>edxValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>最初のブレークポイントに設定しているコマンド <code class="language-text">dx -r1 @$autoRun.CheckPoint1() ; g</code> では、上記の CheckPoint1 関数を実行した後 g コマンドでプログラムの実行が再開されるため、プログラムは一時停止しません。</p>
<p>そのため、すぐに 2 つ目のブレークポイントの <code class="language-text">DoPClient+0x17cd</code> に到達し、<code class="language-text">dx -r1 @$autoRun.CheckPoint2() ; r zf = 1 ; g</code> が実行されます。</p>
<p>そして、次に実行される CheckPoint2 関数では以下の通り、<code class="language-text">DoPClient+0x17cd</code> 時点の ECX レジスタの値と、R11 レジスタが指すアドレスの 32 bit 整数をそれぞれ取得し、その結果を a1 配列に追加します。</p>
<p>また、JavaScript ベースのデバッガスクリプトでは、特定のメモリアドレスに存在する値は、<code class="language-text">host.memory.readMemoryValues(location, numElements, [elementSize], [isSigned], [contextInheritor])</code> <sup id="fnref-12"><a href="#fn-12" class="footnote-ref">12</a></sup> で取得できます。</p>
<p>つまり、<code class="language-text">memory.readMemoryValues(r11Value, 1, 4)</code> では、R11 レジスタに格納されているポインタアドレスから 4 バイト分の値を 1 つの要素として取得しています。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">CheckPoint2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> context <span class="token operator">=</span> host<span class="token punctuation">.</span>namespace<span class="token punctuation">.</span>Debugger<span class="token punctuation">.</span>State<span class="token punctuation">.</span>DebuggerVariables<span class="token punctuation">.</span>curthread<span class="token punctuation">.</span>Registers<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
	<span class="token keyword">var</span> memory <span class="token operator">=</span> host<span class="token punctuation">.</span>memory<span class="token punctuation">;</span>
	<span class="token keyword">let</span> edxValue <span class="token operator">=</span> context<span class="token punctuation">.</span>ecx<span class="token punctuation">;</span>
	<span class="token keyword">let</span> r11Value <span class="token operator">=</span> context<span class="token punctuation">.</span>r11<span class="token punctuation">;</span>
	<span class="token keyword">let</span> int32Value <span class="token operator">=</span> memory<span class="token punctuation">.</span><span class="token function">readMemoryValues</span><span class="token punctuation">(</span>r11Value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	a1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"Result: Word is "</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">" EDX = "</span> <span class="token operator">+</span> edxValue<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" R11 = "</span> <span class="token operator">+</span> int32Value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" IsValid = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>edxValue<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>int32Value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>先ほど確認した通り、2 つ目のブレークポイントでは、CheckPoint2 関数が実行された後に <code class="language-text">r zf = 1</code> コマンドが実行されます。</p>
<p>これによって、直前の <code class="language-text">cmp   ecx, dword [r11]</code> での比較結果に関わらずゼロフラグに 1 がセットされるため、入力文字が正しいかどうかに関わらず最後までループが継続されます。</p>
<p>実際に、プログラムの実行が完了した後に <code class="language-text">dx -r1 @$autoRun.Result()</code> を実行してみると、以下のように CheckPoint2 関数で収集した情報が出力されます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 531px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e41782217e14cfad814313a6ce6feb44/d4713/client-windbg-007.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 142.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEWUlEQVRIx22W2ZqqSgyFff/n6kFAQAaZFLUHex7sfoGc9afA3hfngg+EVCpZQ8rFep1bUZQ2jqN1bWd5ntsqWVldVVbpWq/X9vDwaK+vr/b4+Ginpyf9frC3tzd7fn7W+zf7+fmx8/lsX19ftmibje2UrO86a9vWTqeTNU1rh/3eNptaCQvdNzb0g213O6vr2uIksWEYrCxLOxyPvgHrvr+/bRFHSyur2vIsszRNbTts7fZ26ckSLVze3nrS3XZrURR7xctlZKOSZ1pzOj3Zx8eHX1S5GIbeRlVDwFaLaGujKg6Hg/V97zCM4z5Aot/EkPR4vLOd1lAhLQMB1yJJYlXTGFgSSBCVdW1j6WplNze3VhaFuqiUbLCV3vmlmFzxtTrZ1BtfR+sLqhnUJvg1TWN32jHPcgVsnZg8X3ulR70virWuwuMGVQq2D+ro5eVF+J3th5bZnVZaVUTgXu0XwgwIKm1Ggl6EhISFx4E1cTyzFuy+xbCznGepNcKpLAtvjUBvuWsddJ5hHQz5DVlRHDuWdV35piSC4Uk2jT6KEMmA1u7u7qwqKzuKlEYtlXoed6O/z1RZLxLBeq/vbMJmJLskTOIokJL/kYI8GukziiKL42QiZGvX19ciIveq0zTzd7QPGRdhdyJj65IJFd7f37tDDgcJW9UjZKoCQzCGKAgkGXdIQWqfn59B2LTR6ENVla582khXaq3vvOIkSV0e+/3BpbXSt0p4Y9FeMEEUKrkkLBTUdb2LOVR2cC8jeGQSqeVCCRA/m9JugKdweICD++dEzAKsIIWK8DOtkXi/H11nmRbjW97P0kLM3OmG6iDsUiFerqX0PM9cFmCDl2EYR1xf31iiu8tJcol1EXd1deUJk1XikGE/J2Xog5d3k5dhDCKOk5crDY5O1VMF3ytnPEwdcD0eD4Ks8+HgFa60A2yC1ywbMIR9JMFkAXiXiCpFSiRdLpeCoHNYWPf+PiXcSO1gNOMDVrS0m6ohGOvRMu+JAR4YBnOqZcqQ7By8vP5fL1MpCcERJlECA2HGFocQj9TQIeq4k4YXabpSy60V0/gC6FhOwZK07EO1CBvkk5syTaNC92YSPmYAw/f39z+n0OIwebmuAimtCz4441Fk+bOStF3AjljgIuHv7+9ECgMWUv4dsPE0YFMG7PJyiEEOVeLvMMpaX0NiKrwcUjDYO46tfyx8jI0+nrAaBxTzkWoqH7q5bwyerHl5edbv0ZMuOJyg32ebgn3uaZJgPVzCYhYFSyaOG6TAMs+snV3iFdJqKwbnhLAcqprP6MQXkZDzBxL8HBKR4A5hkPHPuRwGLBWhKydlOvXwOdoDjsPkJshgY9rneXYL+g1e1oCtN8HLMzazlxn1VEMChgdkrHVo4ZZRGLN2VMKzEl2sx9kBoH8D9k82VFD7qRikAWb4dp40rKEynHJpOcumAVuGAUurPmC7bpJI7NMI1qNo6Zsg+DB09179k/7jzKT8B4oKAQPT9BrhAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/e41782217e14cfad814313a6ce6feb44/8ac56/client-windbg-007.webp 240w,
/static/e41782217e14cfad814313a6ce6feb44/d3be9/client-windbg-007.webp 480w,
/static/e41782217e14cfad814313a6ce6feb44/a33a1/client-windbg-007.webp 531w"
              sizes="(max-width: 531px) 100vw, 531px"
              type="image/webp"
            />
          <source
            srcset="/static/e41782217e14cfad814313a6ce6feb44/8ff5a/client-windbg-007.png 240w,
/static/e41782217e14cfad814313a6ce6feb44/e85cb/client-windbg-007.png 480w,
/static/e41782217e14cfad814313a6ce6feb44/d4713/client-windbg-007.png 531w"
            sizes="(max-width: 531px) 100vw, 531px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/e41782217e14cfad814313a6ce6feb44/d4713/client-windbg-007.png"
            alt="スクリプト実行結果"
            title="スクリプト実行結果"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>この結果から、ユーザが入力した文字列 <code class="language-text">FLAG{AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA}</code> が先頭から 1 文字ずつ検証されており、かつ先頭の <code class="language-text">FLAG{</code> までと末尾の <code class="language-text">}</code> のみがパスワードの検証に成功していることを確認できます。</p>
<p>つまり、入力文字を先頭から 1 文字ずつ総当たりし、<code class="language-text">cmp     ecx, dword [r11]</code> での検証に成功する文字をデバッガで特定することで、正しい Flag を特定できそうだということがわかります。</p>
<h2 id="総当たり攻撃で正しい-flag-を特定する" style="position:relative;"><a href="#%E7%B7%8F%E5%BD%93%E3%81%9F%E3%82%8A%E6%94%BB%E6%92%83%E3%81%A7%E6%AD%A3%E3%81%97%E3%81%84-flag-%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B" aria-label="総当たり攻撃で正しい flag を特定する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>総当たり攻撃で正しい Flag を特定する</h2>
<p>ここまでの解析結果から、正しいパスワード文字列の長さは 45 文字であることがわかっています。</p>
<p>また、Flag フォーマットが <code class="language-text">^FLAG\{[\x20-\x7E]+\}$</code> であることから、先頭から順に総当たりで Flag を特定する場合に必要な総当たりの回数は、最大で 39 文字 × 出力可能な ASCII 文字の数(0x7E-0x20) で 3666 回程度になることが予想されます。</p>
<p>当然これだけの回数のデバッガ操作を手動で行うことは現実的ではありませんので、デバッガ操作による総当たり攻撃を自動化したいです。</p>
<p>しかし、今回のようにパスワードの総当たりのためにプログラムの再実行が必要な操作は、前項の JavaScript ベースのデバッガスクリプトなど、WinDbg にロードするタイプのスクリプトとは相性が悪いです。</p>
<p>いくつか方法はありますが、今回は外部から Python スクリプトでプログラムの実行とデバッガ操作を自動化することにしました。</p>
<p>本書ではプログラムの実行とデバッガ操作を自動化するため、少々力業ですが、専用のインターフェースではなく、コマンドラインで利用できる cdb.exe というデバッガを Python スクリプトから利用します。</p>
<p>cdb.exe は Windows SDK に含まれる CLI ベースのデバッガで、WinDbg と同じデバッガコマンドを実行することができます。</p>
<p>DoPClient から総当たりで Flag を取得するため、以下の Python スクリプトを作成しました。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> subprocess

cdb_path <span class="token operator">=</span> <span class="token string">"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\cdb.exe"</span>
exe_path <span class="token operator">=</span> <span class="token string">"C:\\CTF\\DoPClient.exe"</span>
flag_path <span class="token operator">=</span> <span class="token string">"C:\\CTF\\input.txt"</span>
script_path <span class="token operator">=</span> <span class="token string">"C:\\CTF\\script.txt"</span>

dbg_cmd <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"$$&lt; </span><span class="token interpolation"><span class="token punctuation">{</span>script_path<span class="token punctuation">}</span></span><span class="token string">"</span></span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>script_path<span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    cmd <span class="token operator">=</span> <span class="token string">""</span>
    cmd <span class="token operator">+=</span> <span class="token string">"g ;"</span>
    cmd <span class="token operator">+=</span> <span class="token string">"p ;"</span>
    cmd <span class="token operator">+=</span> <span class="token string">".if (@zf == 1) { .printf \"Solver: R8 is %d\\n\", @r8 ; "</span> <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"$$&lt; </span><span class="token interpolation"><span class="token punctuation">{</span>script_path<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token operator">+</span> <span class="token string">" } .else { .echo \"Fail.\" ; .kill }"</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>

command <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"\"</span><span class="token interpolation"><span class="token punctuation">{</span>cdb_path<span class="token punctuation">}</span></span><span class="token string">\" -G -o -kqm -c \"bp !DoPClient+0x17ca ; </span><span class="token interpolation"><span class="token punctuation">{</span>dbg_cmd<span class="token punctuation">}</span></span><span class="token string">\" \"</span><span class="token interpolation"><span class="token punctuation">{</span>exe_path<span class="token punctuation">}</span></span><span class="token string">\" &lt; \"</span><span class="token interpolation"><span class="token punctuation">{</span>flag_path<span class="token punctuation">}</span></span><span class="token string">\""</span></span>

i <span class="token operator">=</span> <span class="token number">4</span>
flag <span class="token operator">=</span> <span class="token string">r"FLAG{"</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">44</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>flag_path<span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            word <span class="token operator">=</span> <span class="token string">""</span>
            word <span class="token operator">+=</span> flag
            word <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
            word <span class="token operator">+=</span> <span class="token string">"A"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">45</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            word <span class="token operator">+=</span> <span class="token string">"\n"</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>word<span class="token punctuation">)</span>

        process <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>command<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
        stdout<span class="token punctuation">,</span> stderr <span class="token operator">=</span> process<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"============================================================"</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> line <span class="token keyword">in</span> stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"Solver:"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>
            
            <span class="token keyword">if</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"Solver: R8 is"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                t <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"============================================================"</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> t <span class="token operator">></span> i<span class="token punctuation">:</span>
            i <span class="token operator">=</span> t
            flag <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Flag: </span><span class="token interpolation"><span class="token punctuation">{</span>flag<span class="token punctuation">}</span></span><span class="token string">, i: </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        
<span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></code></pre></div>
<p>このスクリプトは、以下のリポジトリから <code class="language-text">Stage1_Solver_1.py</code> としてダウンロードできます。</p>
<br>
<p><code class="language-text">Stage1_Solver_1.py</code>：</p>
<p><a href="https://github.com/kash1064/ctf-and-windows-debug/blob/main/Stage1_Solver_1.py" target="_blank" rel="nofollow noopener noreferrer">https://github.com/kash1064/ctf-and-windows-debug/</a></p>
<br>
<p>このスクリプトを実行すると Python の標準ライブラリ関数である subprocess.Popen を使用して、はじめに以下のコマンドが実行されます。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token string">"C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\cdb.exe"</span> <span class="token operator">-</span>G <span class="token operator">-</span>o <span class="token operator">-</span>kqm <span class="token operator">-</span>c <span class="token string">"bp !DoPClient+0x17ca ; $$&lt; C:\CTF\script.txt"</span> <span class="token string">"C:\CTF\DoPClient.exe"</span> <span class="token operator">&lt;</span> <span class="token string">"C:\CTF\input.txt"</span></code></pre></div>
<p>このコマンドでは、<code class="language-text">-G -o -kqm</code> をオプション引数 <sup id="fnref-13"><a href="#fn-13" class="footnote-ref">13</a></sup> として cdb.exe を起動し、<code class="language-text">C:\CTF\DoPClient.exe</code> のデバッグを開始します。(総当たりするパスワードは <code class="language-text">"C:\CTF\input.txt"</code> からプログラムにリダイレクトしています)</p>
<p>また、<code class="language-text">-c "bp !DoPClient+0x17ca ; $$&lt; C:\CTF\script.txt"</code> では実行時に <code class="language-text">!DoPClient+0x17ca</code> にブレークポイントを設定するとともに、デバッガスクリプト <code class="language-text">C:\CTF\script.txt</code> を実行します。</p>
<p>ここで使用しているデバッガスクリプトは、前項の JavaScript ベースのデバッガスクリプトとは異なり、手動で実行可能なデバッガコマンドをスクリプト化したものです。</p>
<p>WinDbg や CDB では複数のデバッグコマンドを記述したデバッガスクリプトをファイルからロードして実行できる機能があります。<sup id="fnref-14"><a href="#fn-14" class="footnote-ref">14</a></sup></p>
<p>上記の Python スクリプトでは、以下のデバッグコマンドを <code class="language-text">C:\CTF\script.txt</code> として保存した後、<code class="language-text">$$&lt; C:\CTF\script.txt</code> コマンドでスクリプトを自動実行しています。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">g <span class="token punctuation">;</span>p <span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>@zf == 1<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>printf <span class="token string">"Solver: R8 is %d\n"</span><span class="token punctuation">,</span> @r8 <span class="token punctuation">;</span> $$&lt; C:\CTF\script<span class="token punctuation">.</span>txt <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token function">echo</span> <span class="token string">"Fail."</span> <span class="token punctuation">;</span> <span class="token punctuation">.</span><span class="token function">kill</span> <span class="token punctuation">}</span></code></pre></div>
<p>このコマンドでは、まず g により <code class="language-text">DoPClient+0x17ca</code> のブレークポイントに到達するまでプログラムの実行を継続します。</p>
<p><code class="language-text">DoPClient+0x17ca</code> では、入力文字に対して何らかの演算を行った結果が格納されている ECX レジスタの値と、R11 レジスタが指すアドレスにハードコードされている 32bit の整数値が比較されます。</p>
<p>ここで、入力文字が正しい文字の場合には検証に成功してゼロフラグが 1 となります。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">1400017ca  cmp     ecx<span class="token punctuation">,</span> dword <span class="token namespace">[r11]</span>
1400017cd  jne     0x1400017fa

1400017cf  inc     r8d
1400017d2  inc     r10
1400017d5  add     r11<span class="token punctuation">,</span> 0x4
1400017d9  cmp     r8d<span class="token punctuation">,</span> 0x2d
1400017dd  jl      0x1400013a2</code></pre></div>
<p>その後に実行される <code class="language-text">.if (@zf == 1) { 中略 } .else { 中略 }</code> の構文では、この検証を行った直後のゼロフラグが 1 であるかを比較しています。</p>
<p>正しい文字が入力されている場合は、<code class="language-text">cmp   ecx, dword [r11]</code> の実行後にゼロフラグが 1 になるため、<code class="language-text">.printf "Solver: R8 is %d\n", @r8 ; $$&lt; C:\CTF\script.txt</code> というデバッガコマンドが実行されます。</p>
<p>このコマンドでは、R8 レジスタの値を <code class="language-text">%d</code> に代入し、<code class="language-text">Solver: R8 is %d\n</code> という文字列を表示した後、もう一度デバッガスクリプト <code class="language-text">C:\CTF\script.txt</code> で定義したコマンドが実行されます。</p>
<p>つまり、プログラムの実行を再開して次の文字の検証結果を確認する操作を、 45 文字すべての検証に成功するか、誤った文字が入力されるまで繰り返し実行することになります。</p>
<p>前述の通り、この Python スクリプトではデバッガコマンドを指定して cdb.exe によるデバッグを繰り返し行うことで入力文字列を先頭から総当たりしています。</p>
<p>正しいパスワード文字の検証に成功した場合には <code class="language-text">Solver: R8 is</code> から始まる文字列が標準出力に与えられるため、この文字列の出力有無から正しい入力文字を特定することができます。</p>
<p>実際にこのスクリプトを実行すると、完了まで非常に長い時間がかかるものの、最終的に <code class="language-text">FLAG{You_can_use_debug_script_in_WinDbg_Next}</code> が正しい 1 つ目の Flag であることを特定することができます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 480px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c69c358a133a373a0b3aa02d3565c150/e85cb/client-solver-001.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 79.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABLUlEQVQ4y62USZODIBCFvbpcJu6OC6JxJyb+///2phtni1VzmODhVdNQ9dGPBqxpmlCWJapKQMoaQgiEYQjHceB53r9lLctCIAlR12jbBpKiEVAp9QvYom0axHEM27ZfA7JltlmJ3XJN4DiOXgeyZYYIUaOh6hgeBIHBGc7zucCZgAzZgZLghl0+As+7NmdZVoemMNzo2jx3WWqoEXB+6rLUL8Xs2lCFDNvfstRiIFfouu63HNf5GdNmf8lii0VR0AdR6YbwR5EkCS5vFwKHGu77wWf0tXjMa1EU7Qr3yPPWuq7orld0fQe2z+95mmbc1IJxHLFtm47DMECpG9jR/f6g+Qf6ftDPNYpi5FQUn72VpSlSEie8C8eE8iLP9fhLvJZl79pNlmU6P9rn/ANF94mJwYnRSgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/c69c358a133a373a0b3aa02d3565c150/8ac56/client-solver-001.webp 240w,
/static/c69c358a133a373a0b3aa02d3565c150/d3be9/client-solver-001.webp 480w"
              sizes="(max-width: 480px) 100vw, 480px"
              type="image/webp"
            />
          <source
            srcset="/static/c69c358a133a373a0b3aa02d3565c150/8ff5a/client-solver-001.png 240w,
/static/c69c358a133a373a0b3aa02d3565c150/e85cb/client-solver-001.png 480w"
            sizes="(max-width: 480px) 100vw, 480px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/c69c358a133a373a0b3aa02d3565c150/e85cb/client-solver-001.png"
            alt="Solver を実行して Flag を特定する"
            title="Solver を実行して Flag を特定する"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>このスクリプトで特定した Flag(正しいパスワード)をコマンドプロンプトから DoPClient に入力してみると、<code class="language-text">Clear Stage1</code> という文字列が表示されるコードにたどり着くことができました。</p>
<p>そのため、ここで特定した 1 つ目の Flag は正しい Flag で間違いないと判断できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 448px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/71c48cea47498ea143c91576cd5de0c4/33b38/client-solver-002.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 91.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACeElEQVQ4y5VU23baQAz0WwMJ2A4Xc7OBAuZyGmzAdxPI///UVCNiCmmatg86u7J2xzOSVka/18NwOMB4PFbzPA+DwQCj0QjNZhOPj49qT09P1/UrMxqNxvWSWr1+5zN+C/Y3UGM6naDTaWPkunDFZvM5yNpxevg+m8H3fXQ7nX9ip4C3DtlQZuODb5rm3aWvwI3bYF3kPjx805Xfm00TrednjdVqNYk93IF9BmxUAV6wbUsKNEKr1dKgbduwhB1Z9iQNLBbZ8uyfQI0LkI3lcoXtyxan0xn7XSgAjh62LBszyWWSZkiTBGG4g+eOVMVnoEar3UGapjiWRxyPR2RZhiIvUBQlokOEw36PspR9FMm5BFEc4+18FgL+HdMrIA9kPCgXMgGOxc/zDIfDAXlR6BpFB/1RGIbCNBUFOyVBZbdMFfAkf0sTAc1zBeRaClAs8sg4kTWJIxxfX7ETwFdJyS4MZD3BX8y1UHeAmcgjYBwnIjVXpmVZYC9Sryko8is4geJoj/PbGyZj7zfZxg8pRJ6lCIJAZVAWcxUEofqRsGMxyJg/SyQWSwoIbr4/zTtA07Swk5xkWa7JJyNK54VcGOfFJQVaOGFJ6UdRMPa8z4uiTSwb1/WwWq2URbDdKgBZs0iXImTy4xD+cqn9WjV5/cPbN6rHzwAbms3rdLvo9/vazH3xB7LnFKJvWaY+STY4zZJKV3s+AGO7fcF6vcZisYAjF5arNTbiT6ZTBacNh0PMZWhwdQV4PL6MuIkMlvnCx0JibH4OGeNFAPmBoJvNRpk5joN2u32VQfaVtGpfGfNYq/2KGwTxhR0BmbP+uzyOMjLq/Mfoov0EEnPb7lfyGB8AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/71c48cea47498ea143c91576cd5de0c4/8ac56/client-solver-002.webp 240w,
/static/71c48cea47498ea143c91576cd5de0c4/76be4/client-solver-002.webp 448w"
              sizes="(max-width: 448px) 100vw, 448px"
              type="image/webp"
            />
          <source
            srcset="/static/71c48cea47498ea143c91576cd5de0c4/8ff5a/client-solver-002.png 240w,
/static/71c48cea47498ea143c91576cd5de0c4/33b38/client-solver-002.png 448w"
            sizes="(max-width: 448px) 100vw, 448px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/71c48cea47498ea143c91576cd5de0c4/33b38/client-solver-002.png"
            alt="DoPClient に正しいパスワードを入力する"
            title="DoPClient に正しいパスワードを入力する"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>なお、上記の画面では <code class="language-text">Clear Stage1</code> という文字列は表示されているものの、OpenSCManager 関数を使用してのドライバの登録には失敗しているようです。(DoPClient の動作については 3 章を参照してください)</p>
<p>1 章に記載の手順で仮想マシンでテスト署名モードを有効化し、DoPClient.exe と DoPDriver.sys を同じフォルダ内に配置した上で、管理者権限で起動したコマンドプロンプトから DoPClient を実行することで、以下のように正しいパスワードを入力した際に DoPDriver がシステムにロードできるようになります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 474px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/ad71f16a69db4433005c74e1eeb6f88f/5595f/client-solver-004.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 99.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAC6klEQVQ4y61UXVPaUBDN+KKG7y8DBIEQKAJiSEhICNDfoNSX+qTOyA/tTPs36lPVotWZjq893V2Nldbal2Zm2bt79549u+y9yoePn/D5/BxXy2tcXF7i+uYGy+sbspf4dnuH27s7fLm4xNXXJb7f34O/H/j7p7w/OsLJ8TEWiwUWZ2c4Izk9PcXJyTHezeeYHxxgf38fByRzsg8PD18VRVlbox/l/4nRMKFtbaFarYrUajWUy2URs9lCo2Egm8shmUwilUr9U5RMNodEIoF0Oi2SzWblsKwJKPdox+PxJ4nFYiv2c1Fi8YQEsKiqio2NDdEsETDvbW5uQo2p/wRVEskUYnSYDzBAoVAQzawzmczTWtM0Aee4COwlUEUlZyqdQbvdhuM4eDubwtrbQ57K5QAG6nR7mJF/OByi2+lIr7iCCDT2HLBAB1zXQxiGmEynGHkuwgnpkYeh6xKII3u8HnkexuOA9kbENvWM4S+miu0MKWhMoK5oz2U7JM3AIQYDC0EwFmCPkjm2LXFGvSbl/1HydDajAwF8P5DAIPAxJkYj35cyHccm5jP4xNgnn0/seG9Mcczs9z4qDjOjTdt25MDQcQScmUwmE2HKjH1/JH4uO6DE/d3eUx9XAN/s7BCTGQHaVOKEgAbClJlx76RvrIkZ+5nhlHpdLpdeLlmlH9NsygHOHDCT4KHxDBiSjxkyWxZuD9+el9hx+QK4vr4uM9ega8hj0SbWPDo8Sr1el2RXbMMwkKaR4Xj1cXYjiRIoJbqzRRqdfD4vV227UkGpVJL5KxaLonW9gkpFl6HXtKLcfY322KfrD1Kg8wyqWAMbA2uPhreLWr2OVquFHWLIjwPf6xwl2SIAtjkpr0VLQk38TIBjpeROryelmKaJfr8vrJgpsxBGZPOVi+54VF5UKvtXSu5bFlrNJup1Axatm7RmBgzMmUuPTOOvvDArf0qDAKrVbejUOwbT+S0kIAYt6w99i8YjepVeA/0JBfBKmwbflQ4AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/ad71f16a69db4433005c74e1eeb6f88f/8ac56/client-solver-004.webp 240w,
/static/ad71f16a69db4433005c74e1eeb6f88f/01944/client-solver-004.webp 474w"
              sizes="(max-width: 474px) 100vw, 474px"
              type="image/webp"
            />
          <source
            srcset="/static/ad71f16a69db4433005c74e1eeb6f88f/8ff5a/client-solver-004.png 240w,
/static/ad71f16a69db4433005c74e1eeb6f88f/5595f/client-solver-004.png 474w"
            sizes="(max-width: 474px) 100vw, 474px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/ad71f16a69db4433005c74e1eeb6f88f/5595f/client-solver-004.png"
            alt="DoPClient がドライバをロードすることを確認する"
            title="DoPClient がドライバをロードすることを確認する"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h2 id="総当たり攻撃を行うスクリプトを高速化する" style="position:relative;"><a href="#%E7%B7%8F%E5%BD%93%E3%81%9F%E3%82%8A%E6%94%BB%E6%92%83%E3%82%92%E8%A1%8C%E3%81%86%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%82%92%E9%AB%98%E9%80%9F%E5%8C%96%E3%81%99%E3%82%8B" aria-label="総当たり攻撃を行うスクリプトを高速化する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>総当たり攻撃を行うスクリプトを高速化する</h2>
<p>前項で使用した <code class="language-text">Stage1_Solver_1.py</code> を使用することで正しい Flag を取得できましたが、このスクリプトで Flag を完全に特定するためには非常に長い時間がかかります。</p>
<p>実際に総当たりに要する時間は環境に依存しますが、私の環境で実行した際には概ね 40 分程度の時間を要しました。</p>
<p>最終的に正しい Flag を特定できるのであれば実行に要する時間は問題ではないと思われるかもしれませんが、CTF では Flag を取得するためのスクリプトの実行時間が長いとライバルに先を越されてしまったり、スクリプトのバグに気づくのが遅れる要因になったりするなど、様々なデメリットがあります。</p>
<p>そのため、このように総当たりで Flag を特定する必要がある問題を解く場合には、スクリプトの実行時間を短縮するためのより良いアルゴリズムを検討することも重要です。</p>
<p>例えば、前項で使用した <code class="language-text">Stage1_Solver_1.py</code> では、先頭から 1 文字ずつ総当たりで検証することで正しいパスワードを特定しています。</p>
<p>Flag のフォーマットは <code class="language-text">^FLAG\{[\x20-\x7E]+\}$</code> であり、正しいパスワードの長さは 45 文字であることがわかっているので、総当たりに必要な最悪の検証回数は 3705 回になります。<sup id="fnref-15"><a href="#fn-15" class="footnote-ref">15</a></sup></p>
<p>今回のスクリプトでは 1 回の総当たりごとに DoPClient プログラムを再起動する必要があり、1 文字の検証当たりのオーバーヘッドがかなり大きいです。</p>
<p>そのため、少しでも検証回数を減らすことができれば、実行時間の大幅な短縮につながりそうです。</p>
<p>そこで、総当たりの実行を高速化するために、スクリプトを以下のように書き換えました。</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> subprocess

cdb_path <span class="token operator">=</span> <span class="token string">"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\cdb.exe"</span>
exe_path <span class="token operator">=</span> <span class="token string">"C:\\CTF\\DoPClient.exe"</span>
flag_path <span class="token operator">=</span> <span class="token string">"C:\\CTF\\input.txt"</span>
script_path <span class="token operator">=</span> <span class="token string">"C:\\CTF\\script.txt"</span>

dbg_cmd <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"$$&lt; </span><span class="token interpolation"><span class="token punctuation">{</span>script_path<span class="token punctuation">}</span></span><span class="token string">"</span></span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>script_path<span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    cmd <span class="token operator">=</span> <span class="token string">""</span>
    cmd <span class="token operator">+=</span> <span class="token string">"g ;"</span>
    cmd <span class="token operator">+=</span> <span class="token string">"p ;"</span>
    cmd <span class="token operator">+=</span> <span class="token string">".if (@zf == 1) { .printf \"Solver: Correct word in %d\\n\", @r8 ; "</span> <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"$$&lt; </span><span class="token interpolation"><span class="token punctuation">{</span>script_path<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token operator">+</span> <span class="token string">" } .else { r zf=1 ; "</span> <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"$$&lt; </span><span class="token interpolation"><span class="token punctuation">{</span>script_path<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token operator">+</span> <span class="token string">"}"</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>

command <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"\"</span><span class="token interpolation"><span class="token punctuation">{</span>cdb_path<span class="token punctuation">}</span></span><span class="token string">\" -G -o -kqm -c \"bp !DoPClient+0x17ca ; </span><span class="token interpolation"><span class="token punctuation">{</span>dbg_cmd<span class="token punctuation">}</span></span><span class="token string">\" \"</span><span class="token interpolation"><span class="token punctuation">{</span>exe_path<span class="token punctuation">}</span></span><span class="token string">\" &lt; \"</span><span class="token interpolation"><span class="token punctuation">{</span>flag_path<span class="token punctuation">}</span></span><span class="token string">\""</span></span>


flag <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">""</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"============================================================"</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>flag_path<span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        word <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">45</span>
        word <span class="token operator">+=</span> <span class="token string">"\n"</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>word<span class="token punctuation">)</span>

    process <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>command<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
    stdout<span class="token punctuation">,</span> stderr <span class="token operator">=</span> process<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> line <span class="token keyword">in</span> stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>          
        <span class="token keyword">if</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"Solver: Correct word"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            t <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            flag<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"flag[</span><span class="token interpolation"><span class="token punctuation">{</span>t<span class="token punctuation">}</span></span><span class="token string">] is </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"============================================================"</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>このスクリプトは、以下のリポジトリから <code class="language-text">Stage1_Solver_2.py</code> としてダウンロードできます。</p>
<br>
<p><code class="language-text">Stage1_Solver_2.py</code>：</p>
<p><a href="https://github.com/kash1064/ctf-and-windows-debug/blob/main/Stage1_Solver_2.py" target="_blank" rel="nofollow noopener noreferrer">https://github.com/kash1064/ctf-and-windows-debug/</a></p>
<br>
<p>新しく作成したスクリプトでは、デバッガでゼロフラグの値を 1 に改ざんすることでパスワードの検証コードをバイパスできることを利用し、最大 95 回(Printable な ASCII 文字の数)の実行で正しい Flag を取得できるように処理が効率化されています。</p>
<p>このスクリプトでは、実行するデバッガコマンドスクリプトには以下のコマンドを以下の通り変更しています。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">g <span class="token punctuation">;</span>p <span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>@zf == 1<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>printf <span class="token string">"Solver: Correct word in %d\n"</span><span class="token punctuation">,</span> @r8 <span class="token punctuation">;</span> $$&lt; C:\CTF\script<span class="token punctuation">.</span>txt <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token keyword">else</span> <span class="token punctuation">{</span> r zf=1 <span class="token punctuation">;</span> $$&lt; C:\CTF\script<span class="token punctuation">.</span>txt<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">cmp   ecx, dword [r11]</code> の実行後のゼロフラグが 1 の場合(入力文字が正しい場合)の処理は前回とほぼ同じですが、ゼロフラグが 0 の場合(入力文字が正しくない場合)のコマンドが大きく変更されています。</p>
<p>前項では、入力文字が正しくなかった場合には .kill コマンドでプログラムのデバッグを終了し、もう一度新しい総当たりのテストを開始していました。</p>
<p>一方で、今回のスクリプトでは <code class="language-text">r zf=1</code> コマンドでゼロフラグを 1 に改ざんすることで、入力文字の検証結果に関わらず、プログラムの処理を最後まで継続させることができます。</p>
<p>つまり、1 度のプログラムの実行につき、特定の文字が正しいパスワードに合致するか否かを、45 文字すべてに対してまとめて検証することができます。</p>
<p>これにより、前項で使用したスクリプトでは総当たりのために最悪 3705 回のプログラムの実行が必要だったのに対し、今回のスクリプトでは最大 95 回の実行で正しい Flag を特定できるようになります。</p>
<p>実際にこのスクリプトを実行すると、およそ 1 分程度で正しい Flag を特定でき、前項で使用したスクリプトと比較して数十倍の高速化に成功しました。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 494px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/ab7c5cf658d45fc27c3dfc58537bde3c/d72d4/client-solver-003.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 71.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABJUlEQVQ4y62TWW+DMBCEeQyE+woJDgaHOxFHE/7/T5t6TVP1rVLdh5EtrTT7eWdttP2AeZ4hqhKMMcRxBMuyYNv2n2Qs6we2bUPbNqiqClGkadgPI6ZpAi8KRRiGoZ7hLAlfrxduQijC+D8I13VFyQvkOYPneTgej3qEz+cTQlQ7YRxrEo53LMsizfaUg8DXI5zmFZucYdPUKMtSn3CQhDRDSjlnNENXl3BRhpQyl4RBEMDSMRzuDxUKGV6vV7XY2oS0hyoUaeg4Dg6HA0zT/FU0658iEKNuWozjqALhnONyuSDLMpzPZ5xOJ3Wnk/SuZdleS5LkW2mawvd9GEI+Vcj9K2QoZEjhCHGTf7vdm3w1onrf9+i6DnVdg+U5PNdTJm+5rotPPU5U/Yw77J4AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/ab7c5cf658d45fc27c3dfc58537bde3c/8ac56/client-solver-003.webp 240w,
/static/ab7c5cf658d45fc27c3dfc58537bde3c/d3be9/client-solver-003.webp 480w,
/static/ab7c5cf658d45fc27c3dfc58537bde3c/32f69/client-solver-003.webp 494w"
              sizes="(max-width: 494px) 100vw, 494px"
              type="image/webp"
            />
          <source
            srcset="/static/ab7c5cf658d45fc27c3dfc58537bde3c/8ff5a/client-solver-003.png 240w,
/static/ab7c5cf658d45fc27c3dfc58537bde3c/e85cb/client-solver-003.png 480w,
/static/ab7c5cf658d45fc27c3dfc58537bde3c/d72d4/client-solver-003.png 494w"
            sizes="(max-width: 494px) 100vw, 494px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/ab7c5cf658d45fc27c3dfc58537bde3c/d72d4/client-solver-003.png"
            alt="高速化した Solver を実行して Flag を特定する"
            title="高速化した Solver を実行して Flag を特定する"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>このように、デバッガコマンドを利用してプログラムの動作を任意に変更することで、簡単な変更で総当たりなどの攻撃を効率化できる場合があります。</p>
<h2 id="4-章のまとめ" style="position:relative;"><a href="#4-%E7%AB%A0%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81" aria-label="4 章のまとめ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4 章のまとめ</h2>
<p>この章では、JavaScript ベースのデバッグスクリプトや cdb.exe を利用した外部スクリプトからのデバッガコマンド実行を使用して、総当たり攻撃で未知のパスワードを特定しました。</p>
<p>ここまではユーザモードアプリケーションである DoPClient の解析を行ってきましたが、5 章からはカーネルドライバモジュールである DoPDriver の解析に踏み込んでいきます。</p>
<h2 id="各章へのリンク" style="position:relative;"><a href="#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF" aria-label="各章へのリンク permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>各章へのリンク</h2>
<ul>
<li><a href="/magical-windbg-vol2-00">まえがき</a></li>
<li><a href="/magical-windbg-vol2-01">1 章 環境構築</a></li>
<li><a href="/magical-windbg-vol2-02">2 章 DoPClient と DoPDriver の表層解析</a></li>
<li><a href="/magical-windbg-vol2-03">3 章 DoPClient の静的解析を行う</a></li>
<li><a href="/magical-windbg-vol2-04">4 章 DoPClient を動的解析する</a></li>
<li><a href="/magical-windbg-vol2-05">5 章 DoPDriver の静的解析を行う</a></li>
<li><a href="/magical-windbg-vol2-06">6 章 DoPDriver を動的解析する</a></li>
</ul>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1">
<p>Time Travel Debugging <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/time-travel-debugging-overview" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/time-travel-debugging-overview</a></p>
<a href="#fnref-1" class="footnote-backref">↩</a>
</li>
<li id="fn-2">
<p>インサイド Windows 第 7 版 上 P.171 (Pavel Yosifovich, Alex Ionescu, Mark E. Russinovich, David A. Solomon 著 / 山内 和朗 訳 / 日系 BP 社 / 2018 年)</p>
<a href="#fnref-2" class="footnote-backref">↩</a>
</li>
<li id="fn-3">
<p>ブレークポイントを制御するメソッド <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/methods-of-controlling-breakpoints" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/methods-of-controlling-breakpoints</a></p>
<a href="#fnref-3" class="footnote-backref">↩</a>
</li>
<li id="fn-4">
<p>r (レジスタ) <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/r--registers-" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/r—registers-</a></p>
<a href="#fnref-4" class="footnote-backref">↩</a>
</li>
<li id="fn-5">
<p>d、da、db、dc、dd、dD、df、dp、dq、du、dw (メモリの表示) <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/d--da--db--dc--dd--dd--df--dp--dq--du--dw--dw--dyb--dyd--display-memor" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/d—da—db—dc—dd—dd—df—dp—dq—du—dw—dw—dyb—dyd—display-memor</a></p>
<a href="#fnref-5" class="footnote-backref">↩</a>
</li>
<li id="fn-6">
<p>dds、dps、dqs (ワードとシンボルの表示) <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/dds--dps--dqs--display-words-and-symbols-" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/dds—dps—dqs—display-words-and-symbols-</a></p>
<a href="#fnref-6" class="footnote-backref">↩</a>
</li>
<li id="fn-7">
<p>g (実行) <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/g--go-" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/g—go-</a></p>
<a href="#fnref-7" class="footnote-backref">↩</a>
</li>
<li id="fn-8">
<p>p (ステップ実行) <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/p--step-" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/p—step-</a></p>
<a href="#fnref-8" class="footnote-backref">↩</a>
</li>
<li id="fn-9">
<p>t (トレース) <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/t--trace-" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/t—trace-</a></p>
<a href="#fnref-9" class="footnote-backref">↩</a>
</li>
<li id="fn-10">
<p>疑似レジスタの構文 <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/pseudo-register-syntax" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/pseudo-register-syntax</a></p>
<a href="#fnref-10" class="footnote-backref">↩</a>
</li>
<li id="fn-11">
<p>JavaScript デバッガーのスクリプト <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/javascript-debugger-scripting" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/javascript-debugger-scripting</a></p>
<a href="#fnref-11" class="footnote-backref">↩</a>
</li>
<li id="fn-12">
<p>JavaScript 拡張機能のネイティブデバッガオブジェクト <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/native-objects-in-javascript-extensions-debugger-objects" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/native-objects-in-javascript-extensions-debugger-objects</a></p>
<a href="#fnref-12" class="footnote-backref">↩</a>
</li>
<li id="fn-13">
<p>CDB のコマンドライン オプション <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/cdb-command-line-options" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/cdb-command-line-options</a></p>
<a href="#fnref-13" class="footnote-backref">↩</a>
</li>
<li id="fn-14">
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mtext>、</mtext></mrow><annotation encoding="application/x-tex">&lt;、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">、</span></span></span></span>>&#x3C;、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mtext>、</mtext></mrow><annotation encoding="application/x-tex">&lt;、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">、</span></span></span></span>>&#x3C;、$$ >a&#x3C; (スクリプト ファイルの実行) <a href="https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/-----------------------a---run-script-file-" target="_blank" rel="nofollow noopener noreferrer">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/-----------------------a---run-script-file-</a></p>
<a href="#fnref-14" class="footnote-backref">↩</a>
</li>
<li id="fn-15">
<p>95(Printable な ASCII 文字の数) x 39(45 文字から FLAG{} の 6 文字を引いた数)  = 3705</p>
<a href="#fnref-15" class="footnote-backref">↩</a>
</li>
</ol>
</div></div></div></div><div class="Post-module--post__footer--3WzWU"><div><p class="Meta-module--meta__date--29eD7">Published <!-- -->May 26, 2024</p></div><div class="Tags-module--tags--1L_ct"><ul class="Tags-module--tags__list--91FqN"><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/magical-win-dbg/">Magical WinDbg</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/windows/">Windows</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/win-dbg/">WinDbg</a></li></ul></div><div class="Author-module--author--2Yefr"><p>リバースエンジニアになりたいCTF Player(Team: 0nePadding)。WinDbgとYARAが好き。OSCP / CISSP / AtCoder 緑 Microsoft Japanに所属してます。発言はすべて個人の見解。<a class="Author-module--author__bio-twitter--n-O9n" href="https://www.twitter.com/kash1064" rel="noopener noreferrer" target="_blank"><strong>かしわば</strong> on Twitter</a></p></div></div><div class="Post-module--post__comments--25y6I"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/magical-windbg-vol2-04";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-299cfcade846097f4d4b.js"],"app":["/app-5379d71873e8730fc841.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-fd4fb51a6fac1c18bdde.js"],"component---src-templates-categories-list-template-js":["/component---src-templates-categories-list-template-js-2181ec47d28e5c35d3e9.js"],"component---src-templates-category-template-js":["/component---src-templates-category-template-js-76f2006942127b3c7274.js"],"component---src-templates-index-template-js":["/component---src-templates-index-template-js-70ba56c0f46525baa629.js"],"component---src-templates-not-found-template-js":["/component---src-templates-not-found-template-js-d19905e5c8fc953958f1.js"],"component---src-templates-page-template-js":["/component---src-templates-page-template-js-6ba68ef37e264f701345.js"],"component---src-templates-post-template-js":["/component---src-templates-post-template-js-381c1b847824134fa4bd.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-0faa242d92f89b71e668.js"],"component---src-templates-tags-list-template-js":["/component---src-templates-tags-list-template-js-2d7007993fc2bf0f9caf.js"]};/*]]>*/</script><script src="/polyfill-299cfcade846097f4d4b.js" nomodule=""></script><script src="/component---src-templates-post-template-js-381c1b847824134fa4bd.js" async=""></script><script src="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-5379d71873e8730fc841.js" async=""></script><script src="/dc6a8720040df98778fe970bf6c000a41750d3ae-206f62bbc9a23b5258ed.js" async=""></script><script src="/532a2f07-92db97c0addf07d5cb73.js" async=""></script><script src="/framework-3761df4ab6ee9f056936.js" async=""></script><script src="/webpack-runtime-a3c0f166cb4b802ff58f.js" async=""></script></body></html>