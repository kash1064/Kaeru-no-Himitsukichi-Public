{"componentChunkName":"component---src-templates-post-template-js","path":"/ctf-angr-bigginer","result":{"data":{"markdownRemark":{"id":"03cd5169-0e82-5e98-a28d-e9c36c7c02f4","html":"<p>先日開催されました<a href=\"https://wanictf.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">WaniCTF’21-spring</a>に参加してました。</p>\n<p>今回はソロ参加だったこともあり、久しぶりにReversing以外の問題も解きました。</p>\n<p>全完できたのはRevとMiscのみで、結果は56位でした。\n脱初心者への道のりはまだまだ長そうです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a51e130b45a9d9e17daa790344b16069/0b533/wani.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.916666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACZklEQVQoz2WTS2sTURTHs3Rdmnkkdx73zmQmj8mrNu9UA7ZNGw1pI40LC+JCcCMSKYjgQnHlphvXIlItitWPoFjqY2NrXVRFN+76ERSEv2dm0mpx8Z87995zfucxZyK6pkPXj4oxBsdxkc1m4XkeUqkUcrkcMpkMTNP8zz7QiBPxHwZJ0zQ6COW/W5YF13WRSCRg2zYFcALpI9t/dQSo0oHMDAgu6NIiOA8NmRZkerD6xkKIIJAQoWzLJj/+F+oDa4KjP5FEIuli0EmjkON0YR5mYgXOItxT4GzWwvqzNiaKlIDloHL/EazGFJgiQzcMRDKlMi5cHyCfVlE910K+2wf3sxyV7veMj7JQFYZC0cL3H0uoljlU4aK1/RWJdgcsGg2BjBtQ03WU+qu4e2qA05N5aoF22NcAaHKYtI9KcXg5gU9fzqJSEogR8MSbHdjTM4iPjxHQRERTJJTvPcD02m/sXruMvdU6Ug5HnKA6Af1yhSVwbFzB1cU8bl+axPvdRdQrBLQI+HYHznwPepyHGRqGjurWLha+fcT2uwH2P/dxsulCpvL8O0ZG1aSDm/kSnq408PzOFDa3F1A7zqEYSTRfvUZlZR3l5YdgcZkylGSkh1fweH+In7+WsLbRDvrnj4FftkrAeS+DvdkzeDJsYP1WE1sfephZSMFpTaD+chPVGy9QvbgxApIjUyV0u0mcXy5Qz3TEYgezRR+GVi9ho5fJYq6WwmwzSbYeSu00ip0i3E4Xbn0OTnGWes7CwdZ1A9Eow9hY7HCmtIM/iPaMJJEUCiSrDJLEEJNpRhUKKEvQYnIg3/4PL9JjpGnevnsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a51e130b45a9d9e17daa790344b16069/8ac56/wani.webp 240w,\n/static/a51e130b45a9d9e17daa790344b16069/d3be9/wani.webp 480w,\n/static/a51e130b45a9d9e17daa790344b16069/b0a15/wani.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a51e130b45a9d9e17daa790344b16069/8ff5a/wani.png 240w,\n/static/a51e130b45a9d9e17daa790344b16069/e85cb/wani.png 480w,\n/static/a51e130b45a9d9e17daa790344b16069/0b533/wani.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a51e130b45a9d9e17daa790344b16069/0b533/wani.png\"\n            alt=\"image-20210505010349068\"\n            title=\"image-20210505010349068\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Pwnが想像以上に解けなかったことなど、新たに浮き彫りになった課題も多く、大変有意義な機会でした。</p>\n<p>今回は、ReversingのVeriyHard問題「licence」を通して、複雑な処理をシンボリック実行で解析してくれるツール「angr」の使い方について学ぶことができたので、<strong>振り返りもかねて「angr」の使い方についてまとめていきます。</strong></p>\n<h2 id=\"今回学んだこと\" style=\"position:relative;\"><a href=\"#%E4%BB%8A%E5%9B%9E%E5%AD%A6%E3%82%93%E3%81%A0%E3%81%93%E3%81%A8\" aria-label=\"今回学んだこと permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>今回学んだこと</h2>\n<ol>\n<li>「angr」の使い方</li>\n<li>「angr」のロジック</li>\n</ol>\n<h2 id=\"licenseの解法\" style=\"position:relative;\"><a href=\"#license%E3%81%AE%E8%A7%A3%E6%B3%95\" aria-label=\"licenseの解法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>licenseの解法</h2>\n<p>今回解いた「licence」ですが、こんな感じの問題でした。</p>\n<p>正解者は36人と比較的少ない問題なので、結構難しかった方なのかもしれません。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2aa2919985cfc2d56e305f3b337bef9d/0b533/wani2png.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAARlAAAEZQAGA43XUAAACVElEQVQ4y41USY7bMBD0LyxZm7VYsvbdhjUeRJZyyCUGMpc8Iv9JkHMeWukmRduDyTKHQlNks9hVTWoVRRF834djO7Btm7DErQs7LGARnO0WSZIIuDz/mLfAcRyYpomVrunQNA2bzQaWZcGiRRHdgMhKmGEFm8a+54mD7WXdtpY8HtMck6VpitU8TxinCcP5LE5RCbKCOyzawJuY6LEyVZ2u65jnGaumrtHs9yjDEM6ySZwsovx+hKrKMq0buSIcx5EImxonw8BAkmOS5ZIsj6PrYkve8TgIAiGXwfMMz/Vkhdad8HK5YFWWJQoizaoKh+MRR0Lf96ip8jzPxZgTh2HA6XRC07YoigJciPLzFeGe5GZZiiSORRfZ2JjmoogREWFHmxtwXlHk4pCQ7DFI1Z8rFEmZSGRkWYbD4YC2a1ETEVfG37vd7mYDE8jqXnsoCKM4g0K4T2Wk6pRnyr/bDfhHl2WF/TOa4wd0pxHdcEH/NMOhe6fuJkvjqDqsus3zCvzN+YKwaQ+o2x5pXiLJSsRJjoR8ZOnsJ0tl/7hSBfaQ17k5bFNKPeAqxbU59hWKLKJG+NgFNqLQE4kVdZ0hN+eIqWncpJw8T9NMNKrrZMP4RvBLEoRJdUVSfUbWXJG3Lwj2Z5KowdjcpSpZj1J5TcE0TKzXayl5vH7H9OUnPr78wKevv9A8faMEjSRs35j/N3Curm8kYVWVNz+MpSJ1JeQz+390bAu6tlToL0/N9z1hrIC9wHlnDGLozg7TRD8H07w/dnnq/bf0PpDsqIYWVHgeL/gNml/o8Z+Nc+0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2aa2919985cfc2d56e305f3b337bef9d/8ac56/wani2png.webp 240w,\n/static/2aa2919985cfc2d56e305f3b337bef9d/d3be9/wani2png.webp 480w,\n/static/2aa2919985cfc2d56e305f3b337bef9d/b0a15/wani2png.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2aa2919985cfc2d56e305f3b337bef9d/8ff5a/wani2png.png 240w,\n/static/2aa2919985cfc2d56e305f3b337bef9d/e85cb/wani2png.png 480w,\n/static/2aa2919985cfc2d56e305f3b337bef9d/0b533/wani2png.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2aa2919985cfc2d56e305f3b337bef9d/0b533/wani2png.png\"\n            alt=\"image-20210505011116132\"\n            title=\"image-20210505011116132\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>大まかな解法は以下のとおりです。</p>\n<ol>\n<li><strong>デコンパイルしてkeyファイルの形式とFlagの検証をしているcheck関数の挙動を見る</strong></li>\n<li><strong>最終的に正しいkeyを与えた場合に着地するアドレスを確認する</strong></li>\n<li><strong>「angr」を使って、check関数の検証を突破したときのデータを確認する</strong></li>\n</ol>\n<p>問題を解いていく前に、今回のメインテーマである「angr」について紹介していきます。</p>\n<h2 id=\"angrとは\" style=\"position:relative;\"><a href=\"#angr%E3%81%A8%E3%81%AF\" aria-label=\"angrとは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>「angr」とは</h2>\n<p><a href=\"https://angr.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">「angr」</a>とは、バイナリを分析するためのPythonフレームワークです。</p>\n<p>シンボリック実行（プログラムが実行しうるパスを網羅的に抽出する技術）を用いた解析ツールで、カリフォルニア大学のラボ、SEFCOM、CTFチームShellphishによって開発されたOSSツールです。</p>\n<p>ソースコードは<a href=\"https://github.com/angr/angr\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GitHub</a>で公開されています。</p>\n<p>「angr」は様々な機能を持っているようですが、今回は「angr」によるシンボリック実行を利用してFlagを取得していきます。</p>\n<h2 id=\"angrを使ってみる\" style=\"position:relative;\"><a href=\"#angr%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"angrを使ってみる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>「angr」を使ってみる</h2>\n<p>「angr」を初めて使うにあたってとにかく苦労したことは、導入のハードルの高さです。</p>\n<p>僕がこの分野に対してほとんど知見がないことも一因であったとは思いますが、「angr」のどの機能を使えばFlagが取得できるのかを理解するまでとにかく時間がかかりました。</p>\n<p>ともかくまずは「angr」が動く環境を用意していきます。</p>\n<p>「angr」は、仮想環境以外での利用をサポートしていません。\n実際、僕の利用しているParrotOSの環境でも、他のPythonパッケージと競合が発生するため、仮想環境を利用するのがいいと思います。</p>\n<p>ちなみに、Dockerコンテナも提供されています。</p>\n<p>公式に推奨されているのは<code class=\"language-text\">mkvirtualenv</code>を利用する方法ですが、今回は<code class=\"language-text\">pipenv</code>を利用しました。\n以下のコマンドを実行すれば、「angr」が利用可能になります。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">pipenv <span class=\"token function\">install</span>\npipenv shell\npip <span class=\"token function\">install</span> angr</code></pre></div>\n<p>とりあえず動作確認をかねて、「angr」を利用してバイナリファイルの基本的な情報を出力してみます。\n基本的に対話形式で実行していきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">import</span> angr\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">import</span> monkeyhex\n\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> proj <span class=\"token operator\">=</span> angr<span class=\"token punctuation\">.</span>Project<span class=\"token punctuation\">(</span><span class=\"token string\">\"licence.exe\"</span><span class=\"token punctuation\">,</span> auto_load_libs<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\nWARNING <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">05</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token number\">02</span><span class=\"token punctuation\">:</span><span class=\"token number\">02</span><span class=\"token punctuation\">:</span><span class=\"token number\">01</span><span class=\"token punctuation\">,</span><span class=\"token number\">328</span> <span class=\"token operator\">|</span> cle<span class=\"token punctuation\">.</span>loader <span class=\"token operator\">|</span> The main binary <span class=\"token keyword\">is</span> a position<span class=\"token operator\">-</span>independent executable<span class=\"token punctuation\">.</span> It <span class=\"token keyword\">is</span> being loaded <span class=\"token keyword\">with</span> a base address of <span class=\"token number\">0x400000</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ARCH\"</span><span class=\"token punctuation\">,</span> proj<span class=\"token punctuation\">.</span>arch<span class=\"token punctuation\">)</span>\nARCH <span class=\"token operator\">&lt;</span>Arch AMD64 <span class=\"token punctuation\">(</span>LE<span class=\"token punctuation\">)</span><span class=\"token operator\">></span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"EntryPoint\"</span><span class=\"token punctuation\">,</span> proj<span class=\"token punctuation\">.</span>entry<span class=\"token punctuation\">)</span>\nEntryPoint <span class=\"token number\">4198656</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"FileName\"</span><span class=\"token punctuation\">,</span> proj<span class=\"token punctuation\">.</span>filename<span class=\"token punctuation\">)</span>\nFileName licence<span class=\"token punctuation\">.</span>exe</code></pre></div>\n<h2 id=\"angrでシンボリック解析をする\" style=\"position:relative;\"><a href=\"#angr%E3%81%A7%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AA%E3%83%83%E3%82%AF%E8%A7%A3%E6%9E%90%E3%82%92%E3%81%99%E3%82%8B\" aria-label=\"angrでシンボリック解析をする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>「angr」でシンボリック解析をする</h2>\n<p>「angr」の使い方について学ぶには、まず一通り<a href=\"https://docs.angr.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">angr Documentation</a>の内容を読み通しておくのがおすすめです。</p>\n<p>僕はここをサボってしまったために余計な時間を使ってしまいました。\n特に今回参考にしたのは、以下の項目です。</p>\n<ul>\n<li><a href=\"https://docs.angr.io/core-concepts/toplevel\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Top Level Interfaces - angr Documentation</a></li>\n<li><a href=\"https://docs.angr.io/core-concepts/loading\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Loading a Binary - angr Documentation</a></li>\n<li><a href=\"https://docs.angr.io/core-concepts/solver\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Solver Engine - angr Documentation</a></li>\n<li><a href=\"https://docs.angr.io/core-concepts/pathgroups\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Simulation Managers - angr Documentation</a></li>\n<li><a href=\"https://docs.angr.io/examples\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Examples - angr Documentation</a></li>\n</ul>\n<p>「angr」は、バイナリのエミュレータではなく、シンボリック実行により解析を行うツールです。</p>\n<p>そもそもこのシンボリック実行が何者なのかが全くつかめなかったことが、「angr」でFlagを取得するための大きな壁でした。</p>\n<p>以下、不正確な点はありそうですが、シンボリック実行について僕が理解したことをまとめます。</p>\n<ul>\n<li><strong>シンボリック変数を使って実行する</strong></li>\n<li><strong>シンボリック変数とは、1,2,3などの具体的な数値ではなく、プログラム内で使用する変数や引数につけられた「シンボル（名前？）」を指す</strong></li>\n<li><strong>シンボリック変数で算術演算を行うと、抽象構文木（AST）ができる</strong></li>\n<li><strong>プログラム内でシンボルに対して条件分岐を判定する際には、真偽それぞれのケースを場合分けして記録し、実行する</strong></li>\n<li><strong>記録された場合分けがあり得るか、SMTソルバ（制約充足問題を高速に解決する）によって判定する</strong></li>\n<li><strong>つまり、ASTを利用することで、「この一連の操作の出力を考えると、入力は何でなければならないか」といった問いを立てることができる</strong></li>\n<li><strong>「angr」は、この問いに答えるためのツールである</strong></li>\n<li><strong>シンボルに利用できるデータ型は、数値と文字列のみで、配列などの可変長のデータ構造は扱えない</strong></li>\n</ul>\n<p>つまりどういうことだってばよ、って感じなんですが、「angr」を使うことで、「正しいkeyを入力した場合の出力に到達するためには、keyとしてどんな値を入れればよいか」を特定することができるイメージです。</p>\n<p>では、「angr」の基本的な使い方を見ていきます。</p>\n<h3 id=\"cle-loader\" style=\"position:relative;\"><a href=\"#cle-loader\" aria-label=\"cle loader permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CLE loader</h3>\n<p>まず、「angr」はバイナリファイルをProjectとしてロードします。\nこれで<code class=\"language-text\">&lt;class 'angr.project.Project'></code>が作成され、すべての処理の起点になります。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> angr\nproj <span class=\"token operator\">=</span> angr<span class=\"token punctuation\">.</span>Project<span class=\"token punctuation\">(</span><span class=\"token string\">'licence.exe'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>次に重要になるポイントは「loader」です。</p>\n<p>「loader」は、バイナリファイルを仮想アドレス空間上に展開（？）するためのCLEモジュールを指し、<code class=\"language-text\">.loader</code>プロパティで使用することができます。</p>\n<p>実際に問題バイナリに対して使用すると、下記の出力が得られます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> proj<span class=\"token punctuation\">.</span>loader\n<span class=\"token operator\">&lt;</span>Loaded licence<span class=\"token punctuation\">.</span>exe<span class=\"token punctuation\">,</span> maps <span class=\"token punctuation\">[</span><span class=\"token number\">0x400000</span><span class=\"token punctuation\">:</span><span class=\"token number\">0x807fff</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> proj<span class=\"token punctuation\">.</span>loader<span class=\"token punctuation\">.</span>min_addr\n<span class=\"token number\">0x400000</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> proj<span class=\"token punctuation\">.</span>loader<span class=\"token punctuation\">.</span>max_addr\n<span class=\"token number\">0x807fff</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> proj<span class=\"token punctuation\">.</span>loader<span class=\"token punctuation\">.</span>main_object \n<span class=\"token operator\">&lt;</span>ELF Object licence<span class=\"token punctuation\">.</span>exe<span class=\"token punctuation\">,</span> maps <span class=\"token punctuation\">[</span><span class=\"token number\">0x400000</span><span class=\"token punctuation\">:</span><span class=\"token number\">0x408017</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span></code></pre></div>\n<p>ここで、「loader（CLEモジュール）」は、以降の「angr」による処理に適した形でバイナリファイルを読み込む役目を持ちます。</p>\n<p>具体的には、Projectとして読み込んだ実行可能プログラムとライブラリを取得し、そのプログラムがロードされて実行できるアドレス空間を生成するためのモジュールです。</p>\n<p>「loader」によって読み込まれたバイナリは、その形式（ELFなど）に合わせた<code class=\"language-text\">cle.Backend</code>クラスモジュールによって読み込まれ、単一のメモリ空間に展開されます。</p>\n<p>CLEモジュールの利用可能なオプションについては以下のドキュメントが参考になりますが、非常に多機能なようで、全部は読めてません。</p>\n<ul>\n<li><a href=\"http://angr.io/api-doc/cle.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cle — Binary Loader — angr 9.0.6885 documentation</a></li>\n</ul>\n<h1 id=\"simulation-managers\" style=\"position:relative;\"><a href=\"#simulation-managers\" aria-label=\"simulation managers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Simulation Managers</h1>\n<p>さて、今回はFlag取得のために、「正しいkeyを入力した場合の出力に到達するためには、keyとしてどんな値を入れればよいか」という情報を特定したいと考えています。</p>\n<p>そのために利用するのが「Simulation Managers」です。</p>\n<p>「Simulation Managers」とは、という話についてちゃんと書きたいのですが、残念ながら「シンボリック実行をして入力値を特定できるなんかすごいやつ」以上の理解ができていないので割愛します。</p>\n<p>とりあえず、先ほど作成した問題バイナリのProjectにて「Simulation Managers」を使っていきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> init_state <span class=\"token operator\">=</span> proj<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span>entry_state<span class=\"token punctuation\">(</span>args <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'licence.exe'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'key.dat'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> simgr <span class=\"token operator\">=</span> proj<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span>simgr<span class=\"token punctuation\">(</span>init_state<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> simgr<span class=\"token punctuation\">.</span>active\n<span class=\"token punctuation\">[</span><span class=\"token operator\">&lt;</span>SimState @ <span class=\"token number\">0x401100</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span></code></pre></div>\n<p><code class=\"language-text\">.factory.entry_state</code>は、シンボリック実行のための初期化を行うステートコンストラクタです。</p>\n<p>いくつか種類がありますが、<code class=\"language-text\">entry_state</code>は、バイナリのエントリポイント実行可能な状態を構築するようです。</p>\n<p>実行時引数を与えたうえでシンボリック実行を行いたい場合は、ここで引数を定義します。</p>\n<p>この際、一つ目の引数にはバイナリの呼び出しが含まれることに注意が必要です。\nコンソールからコマンドライン引数を与えてプログラムを呼び出したときの引数を与えるイメージのようです。</p>\n<p>これで、Flag取得のためのシンボリック実行の準備ができました。</p>\n<p>いよいよFlagを取得していきます。</p>\n<h2 id=\"問題バイナリについて\" style=\"position:relative;\"><a href=\"#%E5%95%8F%E9%A1%8C%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"問題バイナリについて permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>問題バイナリについて</h2>\n<p>Flag取得のため、問題バイナリを解析してみます。</p>\n<p>main関数内にはたくさんの分岐があり、大半がfail関数につながっています。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 492px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3edb5e3c5ce987920fa3022f84b3f266/5c6e9/wani3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 122.08333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAARlAAAEZQAGA43XUAAADIElEQVQ4y21Va2/aQBD0/5fa7/2Sz41UtaqC2jQqSpQHCUkgqSIIEEqoEmxjwE/AgH07Xb99wIFl+x5ze7MzawWlRkT5xW8QAmi3fby8hPl4cSfsa4oMljwLkSxwHKDRXOH11eD3dTxeBs2eJcDtCQkYYNsEXRfptBBB8M5jyxy0HECMQaUIk4FiN8uKwEiKPLoHgco9bpkkbAepZHwEQQQk0O2GaLXEDljWNL0Lw3D4Aq+hFLQUYQa42QBXNRcnJ1PMZkiTQnkUGWijscLp6RhnZzaWS+wHzI7s8ml0HRKIzFeSeZVPXoDJJ1DKcvB9ipNR7su4KviimOMw3Jq3L0LTBEukkI6sgHQV//v9ZPO9EZaTclNf4PjYgjGhHaFni4bDEEeVGe6Zy316TCJMd1bNOXrjCYJVQTZJiyhOWLttw7JNOfoUR4kfRAK4whI2TMle2e5Zxg0j4i8WEPeJOEllapQy9T486BglACQkj0dtsQDTkfV7fL2XBE7pkdcEv8Z+bQF3zzPcPutQB9jhZzgMUK266PWSQjEaBXj808PT0xyaVhhBActkUfHRvg7x3FrgQ+UMP/udXAoZYLe3xsWFBVVLAFU1RK22xM2Nxe4R+48cIXx+/47q5irm0iJL0thkUq5GbFWba9BapiVPShhvssFo8RefjG+coDlMMqGSyoUrWWUYIndL1Ez2vu8LKYlKmadQMOvk4ED/gdugEfdtaMP5VKF5Hh6brIQ15c7pdAhvb7IFJesFYs4vHm6cDg6tn5iBS0oaTb3hsejH6KXVOzr+8S+Di8mEoywyLQlbRBGyHDxa40A7woB/GY+rFcHzRFqyEu4Gg4D7NFmH5QgFF8+VWgfma1Ssa1x5D5hgjDkttvQW+V7EuuTUsNCd4siUOSWKotqE+fEL69XAKxk41Ko8fQqNdIQUItP6iq2ZcZeYIKoowfY3RYCGU1Cfzer6/BUJ8VW/QHvdZxJc6CIulFwvQxa4hXo9Ji729t39PzSbWlztld3al+cB9/M2fk8bcDjOmTAZ1sZ0DJyfO1zCkmrjuoSHBx+Xly67aYP/JyxGZ3qt990AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/3edb5e3c5ce987920fa3022f84b3f266/8ac56/wani3.webp 240w,\n/static/3edb5e3c5ce987920fa3022f84b3f266/d3be9/wani3.webp 480w,\n/static/3edb5e3c5ce987920fa3022f84b3f266/9d6da/wani3.webp 492w\"\n              sizes=\"(max-width: 492px) 100vw, 492px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/3edb5e3c5ce987920fa3022f84b3f266/8ff5a/wani3.png 240w,\n/static/3edb5e3c5ce987920fa3022f84b3f266/e85cb/wani3.png 480w,\n/static/3edb5e3c5ce987920fa3022f84b3f266/5c6e9/wani3.png 492w\"\n            sizes=\"(max-width: 492px) 100vw, 492px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/3edb5e3c5ce987920fa3022f84b3f266/5c6e9/wani3.png\"\n            alt=\"image-20210505100538601\"\n            title=\"image-20210505100538601\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>具体的には、以下のどれか一つにでも引っかかるとアウトのようです。</p>\n<ul>\n<li>実行時引数にファイルが含まれているか</li>\n<li>ファイルの中身が空ではないか</li>\n<li>ファイルの先頭行が<code class=\"language-text\">-----BEGIN LICENCE KEY-----\\n</code>になっているか</li>\n<li><code class=\"language-text\">check</code>関数の戻り値が<code class=\"language-text\">1</code>ではないか</li>\n<li>ファイルの末尾が<code class=\"language-text\">-----END LICENCE KEY-----\\n</code>になっているか</li>\n</ul>\n<p>このうち、check関数の戻り値以外については、簡単に突破することができます。</p>\n<p>ここから、最終的なkeyファイルはこのような形式になることがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">-----BEGIN LICENCE KEY-----\nFLAG{xxxxxxxxxx}\n-----END LICENCE KEY-----</code></pre></div>\n<p>つまり、check関数を突破できるような<code class=\"language-text\">FLAG{xxxxxxxxx}</code>の値こそが、正解のFlagになるわけです。</p>\n<p>というわけで、check関数の中身をのぞいてみます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7311eea956d0d215209a64cfe15d4890/0b533/wani4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAAB7ElEQVQoz3WTu28TQRDG/SciGoRERZWKAtFRITqEFEpoaEDUSAQJQRASUgL2xQkGBYySEJzEjnMv7712ffv6mN07G0SSOY32MavffjM713nZC/D44xqGW1PsDk+xvx9idBRjcpoiShjCJMVZmKC/PcCXwTds73zFj+Eefu4d4OBwhKPjCUYnY5xMz/D6zTo6gMZteQdr1StcZtZaMDbzczFXkORKGShpoI3ycWebnwMC0jyyEa5m1xEUOz4g20OLg0opRFHk52XFwStBMO3BtayhtPKxjc0uOpoUOuiu/Y4r2TWM5xMf1LbZXwLjuL3EnMvAmGZv41PPpUyKrPQbb/U6brCb4Eq0ULMEJkmC+VxCCAkpJc0p9VrC0JlzQHezso3sZ+oFVtgtWNPII00eGJNCQcCi4Kjr2oNrQelSeS4Eus+nSfZQruIuu+feq6mpA5JCpTWqqvIXKKV9HbUh1wtg9y8QtlHTvgPulw/wNH2+BLqUcUH9/rXmlRcKW3c1cXA3PkqfoFv0/frX4W+MxxOE9NphFHuP4oSUU7/GKcqyxLv3HxrgZSah0GMDzARDxjJqmcq7S5tzah8uwIXwo6tjsNVHpyhKZHmB/D/P8hwuxguBOE0xpT8hpzXLcn8+nTHvbu1Uuv7sBn38ASZ1Q7Yb30eEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7311eea956d0d215209a64cfe15d4890/8ac56/wani4.webp 240w,\n/static/7311eea956d0d215209a64cfe15d4890/d3be9/wani4.webp 480w,\n/static/7311eea956d0d215209a64cfe15d4890/b0a15/wani4.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7311eea956d0d215209a64cfe15d4890/8ff5a/wani4.png 240w,\n/static/7311eea956d0d215209a64cfe15d4890/e85cb/wani4.png 480w,\n/static/7311eea956d0d215209a64cfe15d4890/0b533/wani4.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7311eea956d0d215209a64cfe15d4890/0b533/wani4.png\"\n            alt=\"image-20210505101318726\"\n            title=\"image-20210505101318726\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>なんと！デコンパイル結果で2581行分の条件分岐があり、どれか一つに<strong>マッチしてしまう</strong>とFailする関数でした！</p>\n<p>すべての条件に「マッチする」Flagなら、気合いと根性で見つけられるかもしれませんが、「マッチしない」文字列となると、手動で見つけ出すのはちょっと無理そうです。</p>\n<p>というわけで、「angr」を用いてこのcheck関数を突破することを目標に進めていきます。</p>\n<h2 id=\"flag取得\" style=\"position:relative;\"><a href=\"#flag%E5%8F%96%E5%BE%97\" aria-label=\"flag取得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Flag取得</h2>\n<p>先に見た通り、「angr」を使うと「正しいkeyを入力した場合の出力に到達するためには、keyとしてどんな値を入れればよいか」という情報を特定することができます。</p>\n<p>そのため、Flag取得のためには「angr」に以下の情報を与える必要があります。</p>\n<ol>\n<li>正しいKeyを入力したときに到達する「仮想アドレス」</li>\n<li>誤ったKeyを入力したときに到達する「仮想アドレス」</li>\n</ol>\n<p>それぞれ、ディスアセンブルした結果から確認できます。</p>\n<p>まず、正しいkeyを入力した場合は、<code class=\"language-text\">0x5e57</code>の出力に到達することがわかります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/77a2bf46ad81022706f9d755bc459eb1/0b533/wani5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAARlAAAEZQAGA43XUAAAA40lEQVQY0y2PwW6DMBAFwWCMjY0hwQRSksakbXpoK/X/P266lXIY7WpXT5pXpMWwLpaDaXifRz7OE7tzrGkipkSYFvy4YMKKG45o01I2nsIfKcpKKAX13GXq74j+ipRdID9ufD4yIUamfOX4tuPvGXu/016FZccdNly84N2J0PRYbfBC+U9tKPrzgH+dCd3AlDbW/IvLP+h0w6UzlZg2y0Y9zlTxhBlfsDFh2w4nGSu0TqT6hLI9hd1q7KWhURXzPHDICW0dLkggDeihRXcaJX9VFJi6xYtJkIqdYOVeq/pZW/EHfgVdEMHcI3UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/77a2bf46ad81022706f9d755bc459eb1/8ac56/wani5.webp 240w,\n/static/77a2bf46ad81022706f9d755bc459eb1/d3be9/wani5.webp 480w,\n/static/77a2bf46ad81022706f9d755bc459eb1/b0a15/wani5.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/77a2bf46ad81022706f9d755bc459eb1/8ff5a/wani5.png 240w,\n/static/77a2bf46ad81022706f9d755bc459eb1/e85cb/wani5.png 480w,\n/static/77a2bf46ad81022706f9d755bc459eb1/0b533/wani5.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/77a2bf46ad81022706f9d755bc459eb1/0b533/wani5.png\"\n            alt=\"image-20210505103929092\"\n            title=\"image-20210505103929092\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>しかし、すでに見たとおり、「angr」のloaderは、今回の問題バイナリを<code class=\"language-text\">[0x400000:0x807fff]</code>の仮想アドレス空間にマッピングしているため、<code class=\"language-text\">0x5e57</code>も<code class=\"language-text\">0x405e57</code>に変換して渡してあげる必要があります。</p>\n<p>次に、誤ったkeyを入力した場合は、すべて<code class=\"language-text\">0x5e86</code>の関数をコールします。</p>\n<p>そのため、このアドレスに「到達しない」よう「angr」に指示を出します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e8856cfc280b6dde24d600e4d2e2325f/0b533/wani6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.083333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAARlAAAEZQAGA43XUAAAAfklEQVQI1w2N2w6CMBBE227bXRAUgjcSH4gQxYT//73jvp3JTM6E/FLKXgmtcO6U9zJxaZRshTS35FmR2536OWiPL3EakCRoNqpkLGVnpdGeYoN7RuX6UDrLTHbi2feMsXD2UVUj+klYNsK6E7af84oURcV7qS4UakxYFIrnP0IkLVO00Nx3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e8856cfc280b6dde24d600e4d2e2325f/8ac56/wani6.webp 240w,\n/static/e8856cfc280b6dde24d600e4d2e2325f/d3be9/wani6.webp 480w,\n/static/e8856cfc280b6dde24d600e4d2e2325f/b0a15/wani6.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e8856cfc280b6dde24d600e4d2e2325f/8ff5a/wani6.png 240w,\n/static/e8856cfc280b6dde24d600e4d2e2325f/e85cb/wani6.png 480w,\n/static/e8856cfc280b6dde24d600e4d2e2325f/0b533/wani6.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e8856cfc280b6dde24d600e4d2e2325f/0b533/wani6.png\"\n            alt=\"image-20210505102848116\"\n            title=\"image-20210505102848116\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>というわけで、「Simulation Managers」のfindに正解アドレス、avoidに失敗アドレスを与えてexplore関数を呼び出すことで、<code class=\"language-text\">0x5e57</code>に到達するためのシンボル情報を取得することができました。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> simgr<span class=\"token punctuation\">.</span>explore<span class=\"token punctuation\">(</span>find<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x405e57</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> avoid<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x405e86</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n・・・\n<span class=\"token operator\">&lt;</span>SimulationManager <span class=\"token keyword\">with</span> <span class=\"token number\">3</span> active<span class=\"token punctuation\">,</span> <span class=\"token number\">390</span> deadended<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> found<span class=\"token operator\">></span>\n\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> simgr<span class=\"token punctuation\">.</span>found<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>posix<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n<span class=\"token string\">b'-----BEGIN LICENCE KEY-----\\nFLAG{4n6r_15_4_5up3r_p0w3rfu1_5ymb0l1c_xxxxxxx_xxxxxxxx}\\n-----END LICENCE KEY-----\\n'</span></code></pre></div>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>WaniCTFのReversing問題「licence」を通して、複雑な処理をシンボリック実行で解析してくれるツール「angr」の使い方について学んだことをまとめてみました。</p>\n<p>今後Rev問をやっていく上で非常に有用なツールについて学ぶことができてよかったです。</p>\n<p>一方で理解が及んでいない点も多いので、今後も勉強していこうと思います。\nもし本記事の記載に誤りがある場合は、ご指摘いただけると助かります。</p>\n<p>改めて非常に有意義なCTFを運営してくださった方々と、対戦しれくれたプレイヤーに感謝です。</p>\n<p>次は上位に入りたい…。</p>\n<h2 id=\"今回使用したsolver\" style=\"position:relative;\"><a href=\"#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9Fsolver\" aria-label=\"今回使用したsolver permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>今回使用したSolver</h2>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> angr\n<span class=\"token keyword\">import</span> monkeyhex\n\nproj <span class=\"token operator\">=</span> angr<span class=\"token punctuation\">.</span>Project<span class=\"token punctuation\">(</span><span class=\"token string\">\"licence.exe\"</span><span class=\"token punctuation\">,</span> auto_load_libs<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\npipenv shell\npip install angr\n\"\"\"</span>\n\n<span class=\"token comment\"># create project</span>\nproj <span class=\"token operator\">=</span> angr<span class=\"token punctuation\">.</span>Project<span class=\"token punctuation\">(</span><span class=\"token string\">'licence.exe'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># initial_state at the entry point of the binary</span>\ninit_state <span class=\"token operator\">=</span> proj<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span>entry_state<span class=\"token punctuation\">(</span>args <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'licence.exe'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'key.dat'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># create simulation</span>\nsimgr <span class=\"token operator\">=</span> proj<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span>simgr<span class=\"token punctuation\">(</span>init_state<span class=\"token punctuation\">)</span>\n\nsimgr<span class=\"token punctuation\">.</span>explore<span class=\"token punctuation\">(</span>find<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x405e57</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> avoid<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x405e86</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>simgr<span class=\"token punctuation\">.</span>found<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>simgr<span class=\"token punctuation\">.</span>found<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>posix<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h3>\n<ul>\n<li><a href=\"https://angr.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">angr Document</a></li>\n<li><a href=\"https://www.fujitsu.com/downloads/JP/archive/imgjp/jmag/vol66-5/paper05.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">シンボリック実行を活用した網羅的テストケース生成</a></li>\n<li><a href=\"http://inaz2.hatenablog.com/entry/2016/03/16/190756\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">angrでシンボリック実行をやってみる - ももいろテクノロジー</a></li>\n<li><a href=\"https://github.com/angr/angr\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GitHub - angr/angr: A powerful and user-friendly binary analysis platform!</a></li>\n<li><a href=\"http://angr.io/api-doc/cle.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cle — Binary Loader — angr 9.0.6885 documentation</a></li>\n<li><a href=\"https://gist.github.com/tanishiking/1c2a9aa824cd715948cde37b1ea2c2ec\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">シンボリック実行お勉強めも · GitHub</a></li>\n<li><a href=\"https://prepack.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Prepack · Partial evaluator for JavaScript</a></li>\n</ul>","fields":{"slug":"/ctf-angr-bigginer","tagSlugs":["/tag/ctf/","/tag/reversing/","/tag/angr/"]},"frontmatter":{"date":"2021-10-03","description":"今回は、ReversingのVeriyHard問題「licence」を通して、複雑な処理をシンボリック実行で解析してくれるツール「angr」の使い方について学ぶことができたので、振り返りもかねて「angr」の使い方についてまとめていきます。","tags":["CTF","Reversing","Angr"],"title":"angrによるシンボリック実行でRev問を解いてみたまとめ【WaniCTF2021】","socialImage":{"publicURL":"/static/334bd91f01f5d703919e643c6130dca6/ctf-elf-training.png"}}}},"pageContext":{"slug":"/ctf-angr-bigginer"}},"staticQueryHashes":["251939775","401334301","825871152"]}