{"componentChunkName":"component---src-templates-post-template-js","path":"/hackthebox-linux-mirai","result":{"data":{"markdownRemark":{"id":"a14018c9-7494-5b46-bde3-22cbd8495fce","html":"<p>「Hack The Box」という、ペネトレーションテストの学習プラットフォームを利用してセキュリティについて学んでいます。\n「Hack The Box」のランクは、本記事執筆時点でProHackerです。</p>\n<img src=\"http://www.hackthebox.eu/badge/image/327080\" alt=\"Hack The Box\">\n<p>この記事では、HackTheBoxのマシン攻略を通して「 IoT機器」に対する攻撃と、セキュリティ向上のための対処方法について勉強したことをまとめていきます。</p>\n<!-- omit in toc -->\n<h2 id=\"本記事について\" style=\"position:relative;\"><a href=\"#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"本記事について permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>本記事について</h2>\n<p><strong>本記事の内容は社会秩序に反する行為を推奨することを目的としたものではございません。</strong></p>\n<p>自身の所有する環境、もしくは許可された環境以外への攻撃の試行は、「不正アクセス行為の禁止等に関する法律（不正アクセス禁止法）」に違反する可能性があること、予めご留意ください。</p>\n<p>またすべての発言は所属団体ではなく個人に帰属します。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li><a href=\"#%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E6%A6%82%E8%A6%81\">マシンの概要</a></li>\n<li><a href=\"#%E3%81%93%E3%81%AE%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E6%94%BB%E7%95%A5%E3%81%A7%E6%96%B0%E3%81%9F%E3%81%AB%E5%AD%A6%E7%BF%92%E3%81%97%E3%81%9F%E9%A0%85%E7%9B%AE\">このマシンの攻略で新たに学習した項目</a></li>\n<li>\n<p><a href=\"#%E6%8E%A2%E7%B4%A2\">探索</a></p>\n<ul>\n<li><a href=\"#pi-hole-%E3%81%A8%E3%81%AF\">Pi-hole とは?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E4%BE%B5%E5%85%A5\">侵入</a></p>\n<ul>\n<li><a href=\"#%E8%84%86%E5%BC%B1%E6%80%A7%E3%81%AE%E8%AA%BF%E6%9F%BB\">脆弱性の調査</a></li>\n<li><a href=\"#%E8%AA%8D%E8%A8%BC%E6%83%85%E5%A0%B1%E3%81%AE%E5%8F%96%E5%BE%97\">認証情報の取得</a></li>\n<li><a href=\"#mirai-%E3%81%A8%E3%81%AF\">Mirai とは</a></li>\n<li><a href=\"#mirai-%E3%81%AA%E3%81%A9%E3%81%AE-iot-%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%B8%E3%81%AE%E5%AF%BE%E7%AD%96\">Mirai などの IoT マルウェアへの対策</a></li>\n</ul>\n</li>\n<li><a href=\"#%E4%BB%8A%E5%BA%A6%E3%81%93%E3%81%9D%E4%BE%B5%E5%85%A5\">今度こそ侵入</a></li>\n<li><a href=\"#%E5%86%85%E9%83%A8%E6%8E%A2%E7%B4%A2\">内部探索</a></li>\n<li><a href=\"#%E6%A8%A9%E9%99%90%E6%98%87%E6%A0%BC\">権限昇格</a></li>\n<li>\n<p><a href=\"#%E3%82%82%E3%81%86%E4%B8%80%E5%BA%A6%E5%86%85%E9%83%A8%E6%8E%A2%E7%B4%A2\">もう一度内部探索</a></p>\n<ul>\n<li><a href=\"#linux-%E3%81%AE%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%9E%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF\">Linux のデバイスマウントの仕組み</a></li>\n</ul>\n</li>\n<li><a href=\"#root-%E3%83%95%E3%83%A9%E3%82%B0%E5%8F%96%E5%BE%97\">root フラグ取得</a></li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n<h2 id=\"マシンの概要\" style=\"position:relative;\"><a href=\"#%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E6%A6%82%E8%A6%81\" aria-label=\"マシンの概要 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>マシンの概要</h2>\n<ul>\n<li>プラットフォーム：Linux</li>\n<li>難易度：Easy (かなり簡単な部類の Easy )</li>\n<li>\n<p>必要なテクニック / 知識</p>\n<ul>\n<li>nmap / gobuster などを用いた探索</li>\n<li>IoT マルウェアの攻撃手法</li>\n<li>権限昇格のための内部探索手法</li>\n<li>Linux のデバイス管理について</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"このマシンの攻略で新たに学習した項目\" style=\"position:relative;\"><a href=\"#%E3%81%93%E3%81%AE%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E6%94%BB%E7%95%A5%E3%81%A7%E6%96%B0%E3%81%9F%E3%81%AB%E5%AD%A6%E7%BF%92%E3%81%97%E3%81%9F%E9%A0%85%E7%9B%AE\" aria-label=\"このマシンの攻略で新たに学習した項目 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>このマシンの攻略で新たに学習した項目</h2>\n<ul>\n<li>IoT マルウェアの概要および攻撃手法について</li>\n<li>Linux のデバイスファイルについて</li>\n<li>フラッシュメモリから削除されたデータのサルベージ方法</li>\n</ul>\n<h2 id=\"探索\" style=\"position:relative;\"><a href=\"#%E6%8E%A2%E7%B4%A2\" aria-label=\"探索 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>探索</h2>\n<p>さっそくマシン攻略を始めていきます。\nまずはいつも通りポートスキャンから試していきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash:console\"><pre class=\"language-bash:console\"><code class=\"language-bash:console\">TARGET=10.10.10.48 &amp;&amp; expose TARGET\nnmap -sV -sC -T4 $TARGET| tee nmap1.txt</code></pre></div>\n<p>こちらのコマンドで、次のような出力が得られました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 757px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ec45743e4c678dab0438bb79b78b122c/1fbe8/aa.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpklEQVQoz2WS2XKrMBBE+Y8kjjH7LnaEAOO18p7//5bOzMSkuHUfpiQh1DrdIyvR3yi6JzKzIltvKK4PVI8vKJonE3273NHON3TthKoeUZYDiqJH0xgkSUXzDkr18LwMx2MIy4xnrOsTy3TDbK5YzA0qa+G7KezPAM4xwsmO5efTKZY6HDypT9rnOhx82bftCFahBujxitFcUNOt8/JAQzS+nyOKKwRhgZjGMFRSQZAjiTO4ji8C+xLCfjhD6wuyrJGDGdGxhTRtkJMdXpel/rOWpjU8l8gdptrEwj9Ra9ArDNulnBaiM2R7nh9Ud6K+0vqCabpjoIuX5YkzxeM6HpyTtxPbCWp9Frst2WSrXTdL4Bx+FJVClCQ1zZU4yPOWGpDAPgY7uzvBvl8oQ8rv1UFeszgLuNSY93cXHx8elS/ztzf31YTovwxfhCuJEOXIlLPMJ4qASTk7znbLjtdVpYV4a8I2bmWxPe6uUoMEz5R1bX5t02EeO6Jm8oKEt4Yx/Sb4DyHb45v5IAffvh4wkzAljyy8/cdiQVAIsbyEvPt9AfTY+ZIf6942BsCuJ9MAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ec45743e4c678dab0438bb79b78b122c/8ac56/aa.webp 240w,\n/static/ec45743e4c678dab0438bb79b78b122c/d3be9/aa.webp 480w,\n/static/ec45743e4c678dab0438bb79b78b122c/4578a/aa.webp 757w\"\n              sizes=\"(max-width: 757px) 100vw, 757px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ec45743e4c678dab0438bb79b78b122c/8ff5a/aa.png 240w,\n/static/ec45743e4c678dab0438bb79b78b122c/e85cb/aa.png 480w,\n/static/ec45743e4c678dab0438bb79b78b122c/1fbe8/aa.png 757w\"\n            sizes=\"(max-width: 757px) 100vw, 757px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ec45743e4c678dab0438bb79b78b122c/1fbe8/aa.png\"\n            alt=\"image.png\"\n            title=\"image.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>80 番ポートが開いているので、とりあえずブラウザアクセスしてみます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0d2f5b1a606b0d48597654f06b791636/0b533/bb.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAABCklEQVQoz62P3U6DQBBGeQgVQ3GDGExvfGWfo7alrBZN38SaQIMgQvaHz90NpNiC7YWTnMyyzJydsZwbF8S7B/GnuHI8kNsp7oIHOG5gsCc+Lmx3lMtrAtvx4al+lwSwZrM5whUFfYkRPa/xtAgN82XUssIijEZZqt6Ixnh924DSNSz8c1hlWUJKCS4EhIJxDsYYOBcKPohoa4ew6ro25qZpTK6qClmW/TlFVzs44aFQT5DnOfTkRVGYs87dd7++6+k/cCTU6yZJijTdKVJ1TlpSbLcfJjPGj6SjQp31nZ50bN295ITw8Gd310fHeybxGNf4/D5j5SHJb2EDJhrsviSEPEN4Koa26McPAnYiDtUiot4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/0d2f5b1a606b0d48597654f06b791636/8ac56/bb.webp 240w,\n/static/0d2f5b1a606b0d48597654f06b791636/d3be9/bb.webp 480w,\n/static/0d2f5b1a606b0d48597654f06b791636/b0a15/bb.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/0d2f5b1a606b0d48597654f06b791636/8ff5a/bb.png 240w,\n/static/0d2f5b1a606b0d48597654f06b791636/e85cb/bb.png 480w,\n/static/0d2f5b1a606b0d48597654f06b791636/0b533/bb.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/0d2f5b1a606b0d48597654f06b791636/0b533/bb.png\"\n            alt=\"image.png\"\n            title=\"image.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>404 が返ってきたので、今度はこの WEB ページに対して探索を行います。\ngobuster での探索を試みる前に、とりあえずありがちなファイルパスでアクセス可能か試してみました。</p>\n<blockquote>\n<p>/robots.txt\n/admin\n/login</p>\n</blockquote>\n<p>どうやら<code class=\"language-text\">/admin</code>でヒットしたようで、 Pi-hole というアプリケーションの管理コンソール画面が開きました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4db5f75df9f7c1b3cecb205325cac96f/0b533/cc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 91.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAARlAAAEZQAGA43XUAAADgUlEQVQ4y43Ta1CUVRzH8eeFvbcZDRhYYBfYBUQWJYMyywFZbsul0E0xBm/MlBPL1Ewv4mJDgXIXNZoJMWjkvqsshiuZ0mVKC5BSkLAyRoRdxA2ooSjE+XZ2wcRIxhef+T/nPOf85pzznEfy9vZCqQrA23c17nIlSmUAKn81XqpAPLxW4Sb3Reblh4tMwROuclw8fHAS1cnVEyc3Bc4yb1zcfcR8MV6uQlKm5BK6t5Rn08sIfrWMxNzjJORUE5N51CE2s2quZlXNEW1t1rzsY8TvqyZB2JH3IfGZHyCFhz1NiFaH4qkonteloeux4d85wZrOcYJEXYpajFF/O+4Yq/zcSurFIaTnPNwIXKfG08ePjZoowr6bZOWlaeQ90zh3T7O8608e7xa6Hm6FGL/s3C22XBCB7sGhKILWstzdg5DISF7vNBH7ZSUbzx0i7PyRR7Kp4z1C20t444tGpIAn16NSr8NF7seG6HhCzuTymGEPUvMupPqUR9OQilSVyCZTHpL3qmDsXOT+hIvAK18V0Hs+g37zDnrP7BR2zdeH62vfTZdpK90dhUievkEo/Nc4AsOi4phpfwFOKKFRBk2uUL9CWLm0RmdsFcv4xahDkjsC184HJjDcUMxYTQ7WozmMlOuxHEqfU76EwxncKEzjh7ryBYEKEaiJY/C1NIaSE7meGMFAqD8D6wMZeGb1kq5tCOKCSsbXe9MWrtCP8JhERrsuMtXzDVOXu/mr/zKzP15l9lofd+4Z6F1kZqCPu6Jarnx/P9DZ048I7YuMTf6GueMzao1GjjcbqDUYqTOeoP5kC40tJppaTwmtNJnua5yvl3qvPhio0SYxarFSVVnJ/vx89mVnk6HXszM1lS1JScRpY4nUaIgSosWdjYmOQhsbI/q1jr5mg2HxCm+P3cZgaOajmhoa6uuFOupqa6mpqeb9igqKiwrJzspCn55O2p7dpLy8ne3Jybyk09EiVr8g0BdN3GYso6McPHyEdw4UkF9Y9K/9RcUUlJRRVHaQwtIyDpSU8va7ebz5ViavpOvZvHUbRrHtBwIjROCN4WFMp820/J82MyfbTjvY263mdj7+5KxD29lP6f/p58Vf+fepP5gFZpZw5z/tv4W7gnV8/F6g+FPEGdov9pDlFlZxjvatj9lsjE9M8uvEhIP92SYm3RS7sL+/OTLiMGK1OtrXBwf5B+Wbli8HbvUWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4db5f75df9f7c1b3cecb205325cac96f/8ac56/cc.webp 240w,\n/static/4db5f75df9f7c1b3cecb205325cac96f/d3be9/cc.webp 480w,\n/static/4db5f75df9f7c1b3cecb205325cac96f/b0a15/cc.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4db5f75df9f7c1b3cecb205325cac96f/8ff5a/cc.png 240w,\n/static/4db5f75df9f7c1b3cecb205325cac96f/e85cb/cc.png 480w,\n/static/4db5f75df9f7c1b3cecb205325cac96f/0b533/cc.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4db5f75df9f7c1b3cecb205325cac96f/0b533/cc.png\"\n            alt=\"pihle\"\n            title=\"pihle\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"pi-hole-とは\" style=\"position:relative;\"><a href=\"#pi-hole-%E3%81%A8%E3%81%AF\" aria-label=\"pi hole とは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pi-hole とは?</h3>\n<p>この Pi-hole というアプリケーションは初めて見たものでしたので、とりあえずドキュメントを眺めてみます。</p>\n<blockquote>\n<p>The Pi-hole® is a DNS sinkhole that protects your devices from unwanted content, without installing any client-side software.\n<a href=\"https://docs.pi-hole.net/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Overview of Pi-hole - Pi-hole documentation</a></p>\n</blockquote>\n<p>上記のとおり、 Pi-hole は、不要なコンテンツからデバイスを保護する DNS シンクホールとして利用できるアプリケーションのようです。(DNS シンクホールは、問い合わせに対してわざと間違った応答を返す DSN のこと)</p>\n<p>Pi-hole という名前ですが、 Rasberry-pi だけでなく、Debian や Docker コンテナなど、様々なプラットフォームにデプロイできるようです。</p>\n<p>同じくドキュメントより、 Pi-hole で使用されている技術について特定ができました。</p>\n<blockquote>\n<p>Pi-hole being a advertising-aware DNS/Web server,\nmakes use of the following technologies:  </p>\n</blockquote>\n<ul>\n<li>dnsmasq - a lightweight DNS and DHCP server</li>\n<li>curl - A command-line tool for transferring data with URL syntax</li>\n<li>lighttpd - web server designed and optimized for high performance</li>\n<li>php - a popular general-purpose web scripting language</li>\n<li>AdminLTE Dashboard - premium admin control panel based on Bootstrap 3.x</li>\n<li>sqlite3 - SQL Database engine\n<a href=\"https://docs.pi-hole.net/main/origins/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Pi-hole Origins - Pi-hole documentation</a></li>\n</ul>\n<p>いくつか気になる点はありましたが、脆弱性の報告数がトップクラスで知られる PHP で実装されているようですので、ここを起点に侵入できる穴がないか探っていこうと思います。</p>\n<h2 id=\"侵入\" style=\"position:relative;\"><a href=\"#%E4%BE%B5%E5%85%A5\" aria-label=\"侵入 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>侵入</h2>\n<h3 id=\"脆弱性の調査\" style=\"position:relative;\"><a href=\"#%E8%84%86%E5%BC%B1%E6%80%A7%E3%81%AE%E8%AA%BF%E6%9F%BB\" aria-label=\"脆弱性の調査 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>脆弱性の調査</h3>\n<p>さて、 Pi-hole の脆弱性を起点にマシンに侵入できる経路がないか探していきます。\nまず、管理コンソールから Pi-hole のバージョンが<code class=\"language-text\">Pi-hole Version v3.1.4</code>であることを確認しました。</p>\n<p>上記のバージョンに該当する脆弱性について探したところ、こちらの 2 つが使えそうに感じましたが、残念ながらどちらもまず管理コンソールにログインできる認証情報を取得する必要がありました。\n(※メタ的な話ですが、このマシンが作られたのは 2017 年なので、CVE-2020-xxx は確実に想定解ではなさそう。)</p>\n<blockquote>\n</blockquote>\n<ul>\n<li>\n<p><a href=\"https://www.exploit-db.com/exploits/48442\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CVE-2020-11108</a></p>\n<ul>\n<li>認証が必要</li>\n<li>ブロックリストの脆弱性を利用した RCE の脆弱性</li>\n</ul>\n</li>\n<li>\n<p><a href=\"https://nvd.nist.gov/vuln/detail/CVE-2020-8816\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CVE-2020-8816</a></p>\n<ul>\n<li>認証が必要</li>\n<li>細工されたDHCP静的リースを介して行われる RCE の脆弱性</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"認証情報の取得\" style=\"position:relative;\"><a href=\"#%E8%AA%8D%E8%A8%BC%E6%83%85%E5%A0%B1%E3%81%AE%E5%8F%96%E5%BE%97\" aria-label=\"認証情報の取得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>認証情報の取得</h3>\n<p>とりあえず<code class=\"language-text\">Pi-hole Password</code>などのワードで Google 検索を試してみました。\nすると、ローカル環境にログインして、次のコマンドを実行することで、 Pi-hole のパスワードをリセットできることがわかりました。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash:bash\"><pre class=\"language-bash:bash\"><code class=\"language-bash:bash\">sudo pihole -a -p</code></pre></div>\n<p>また、いくつかの Pi-hole の設定方法の書かれた記事を読むと、 Pi-hole をインストールする Rasberry-pi に初期パスワード<code class=\"language-text\">raspberry</code>でログインしましょうという記載がありました。</p>\n<p>ここで、このマシンのタイトルが<code class=\"language-text\">Mirai</code>であることにようやく気付きました笑</p>\n<h3 id=\"mirai-とは\" style=\"position:relative;\"><a href=\"#mirai-%E3%81%A8%E3%81%AF\" aria-label=\"mirai とは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mirai とは</h3>\n<p>Mirai とは、IoT 機器に感染し、巨大なボットネットを形成するマルウェアです。\nネットワークのスキャンを行い、発見された IoT に対して侵入します。</p>\n<p>Mirai は、多くの IoT デバイスにおいて、認証情報が初期設定のまま放置されているという穴を突く感染の容易さ、ソースコードが容易に入手可能であったことなど、様々な要因から、亜種も含めて大いに流行しました。\nMirai の脅威としては、 2016 年に 100Gbps 超の DDoS 攻撃が複数回行われたことで米国の DNS サービスが停止し、 Twitter などのサービスに影響が発生したことなどが知られています。</p>\n<p>初期設定の認証情報の悪用などによって IoT デバイスが感染すると、攻撃者の C＆C サーバからの遠隔操作によって、ボットとしてマルウェアの拡散に利用されたり、 DDoS 攻撃などに利用されたする場合があります。</p>\n<ul>\n<li><a href=\"https://www.ipa.go.jp/files/000059579.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">IPA:顕在化したIoTのセキュリティ脅威とその対策</a></li>\n<li><a href=\"https://www.itmedia.co.jp/news/articles/1802/21/news034.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">史上最悪規模のDDoS攻撃　「Mirai」まん延、なぜ？ (1/4) - ITmedia NEWS</a></li>\n<li><a href=\"https://www.trendmicro.com/jp/iot-security/news/3056\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Mirai流行の背景、「IoT機器の初期設定」に主因 | IoTのセキュリティ情報なら「iot security」</a></li>\n<li><a href=\"https://www.atmarkit.co.jp/ait/articles/1611/08/news028.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">「Mirai」ソースコード徹底解剖－その仕組みと対策を探る (1/4)：大規模DDoS攻撃を引き起こしたIoTボットネット - ＠IT</a></li>\n</ul>\n<p>また、Mirai のスキャナーのソースコードを読むと、 IoT デバイスの初期設定の認証情報がハードコーディングされており、非常に興味深いです。\n中には、東芝のネットワークカメラや、パナソニックのプリンタを狙っていると思われる認証情報も含まれています。</p>\n<p>他にも、Mirai ではありませんが、 Rasberry-pi を狙った IoT マルウェアも複数確認されております。\nLinux.MulDrop.14 はその一例で、 Rasberry-pi 用 OS である Rasbian の初期設定の認証情報を狙っています。</p>\n<blockquote>\n<p>Raspberry Piの公式ディストリーである「Rasbian」はセットアップした直後だと、ユーザー名が「pi」、パスワードが「raspberry」でSSH接続できるようになっています。\n<a href=\"https://news.livedoor.com/article/detail/13202811/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">初期パスワードを変更していない脆弱な「Raspberry Pi」を狙う新たなIoTウイルス「Linux.MulDrop.14」が登場！感染後に暗号通貨のマイニングを実施 - ライブドアニュース</a></p>\n</blockquote>\n<h3 id=\"mirai-などの-iot-マルウェアへの対策\" style=\"position:relative;\"><a href=\"#mirai-%E3%81%AA%E3%81%A9%E3%81%AE-iot-%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%B8%E3%81%AE%E5%AF%BE%E7%AD%96\" aria-label=\"mirai などの iot マルウェアへの対策 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mirai などの IoT マルウェアへの対策</h3>\n<p>さて、一応僕はサイバーセキュリティの防御側の立場から、攻撃者の思考を知るためにマシン攻略を行ってますので、これらの IoT マルウェアに対する対策も簡単に検討してみます。\n(※ あくまで個人の考えですのでご留意ください)</p>\n<p>ぱっと思いつくものだと、<code class=\"language-text\">IoT デバイスのパスワードを工場出荷時のままにしない</code>というのは有効だと思います。\n実際に Rasberry-pi も、公式に初期設定の認証情報を変更するようアナウンスしています。</p>\n<p>とはいえ実際に十分な強度のパスワードを設定している人がどれくらいいるのかは疑問です。\nなので、OS が初めから起動時に認証情報を設定するようにデザインしてもいいのではとは思ってます。\n実際に Rasberry-pi 用の Ubuntu をインストールすると、起動時に認証情報の設定が必要になります。</p>\n<p>あとは、<code class=\"language-text\">不要なデバイスをネットワークに公開しない / 不要なポートを公開しない</code>というのも当然ながら必要かと思います。\nMirai などのマルウェアは、結構ネットワークカメラデバイスを狙っているものが多いように感じます。</p>\n<p>防犯用のカメラなど、外出先から映像を監視するために一般家庭でもポート開放を行うケースが結構あるみたいですね。\n自由なインターネットは恐ろしいので、とてもじゃないですが自宅のネットワークに外部から接続可能な状態にはしたくないですね…。</p>\n<p>上記以外にも、<code class=\"language-text\">IoT デバイスをきちんと更新して脆弱性対策を行う</code>とか、<code class=\"language-text\">出口対策として、特定の宛先以外には情報を送信しないように設定する</code>とかが考えられますね。\nただ、IoT カメラデバイスなど、メーカーによっては、脆弱性が公表されても全然パッチを提供しないケースとかも見たことがあるので、バージョンアップが十分な脆弱性対策になるかは若干疑問です。</p>\n<h2 id=\"今度こそ侵入\" style=\"position:relative;\"><a href=\"#%E4%BB%8A%E5%BA%A6%E3%81%93%E3%81%9D%E4%BE%B5%E5%85%A5\" aria-label=\"今度こそ侵入 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>今度こそ侵入</h2>\n<p>さて、少し脱線しましたが、マシン攻略に戻ります。</p>\n<p>Pi-hole が動いていますので、動作環境は Rasberry-pi の可能性があります。\n(そして、マシンのチャレンジ名は Mirai ・・・)</p>\n<p>というわけで、 Rasbian の初期パスワードでの SSH を試みます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash:bash\"><pre class=\"language-bash:bash\"><code class=\"language-bash:bash\">ssh pi@10.10.10.48 #パスワードに「raspberry」を入力</code></pre></div>\n<p>ログインできました！\nやっぱり Rasberry-pi だったんだ！</p>\n<p>確認してみると、次のような出力が取れました。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash:console\"><pre class=\"language-bash:console\"><code class=\"language-bash:console\">pi@raspberrypi:~ $ uname -a\nLinux raspberrypi 3.16.0-4-686-pae #1 SMP Debian 3.16.36-1+deb8u2 (2016-10-19) i686 GNU/Linux</code></pre></div>\n<p>ともかく、これで user を取得できました。</p>\n<h2 id=\"内部探索\" style=\"position:relative;\"><a href=\"#%E5%86%85%E9%83%A8%E6%8E%A2%E7%B4%A2\" aria-label=\"内部探索 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>内部探索</h2>\n<p>次に、root を取得するため、権限昇格が可能な穴を探していきます。\nまずは、探索用の Linpeas ファイルを SCP でマシンに転送し、実行結果ファイルをローカルに取得します。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash:bash(ローカル)\"><pre class=\"language-bash:bash(ローカル)\"><code class=\"language-bash:bash(ローカル)\">scp /home/kali/Hacking/Knowledge/Exploits/linPEAS/linpeas.sh  pi@$TARGET:~/</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash:bash(マシン)\"><pre class=\"language-bash:bash(マシン)\"><code class=\"language-bash:bash(マシン)\">sh linpeas.sh | tee linpeas_result.txt</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash:bash(ローカル)\"><pre class=\"language-bash:bash(ローカル)\"><code class=\"language-bash:bash(ローカル)\">scp pi@$TARGET:~/linpeas_result.txt ./</code></pre></div>\n<p>出力結果を見たところ、以下の出力が確認できました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 647px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7934cb7bffceea8b489e25c7c5f1052c/ca12d/dd.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsUlEQVQY022PUQ6DIBBEuYSKgiQqy4eoBZV6/5NNWWyaNunHy+wAu8OKGHfsx4EQAuZ5xrZt2e9Y1xUxBjzCjXMEay2maSpopVBVFeq6/kHEGJHSWZqv60LIPoQHzvPEMyUsywLvfQljZc81kcMwDBjH8QN7wakM0Z3OF5YIlM+MMflnDqbvIaVE27ZvJLqug8oUVayq1MLnNF75yGvyYJVX0VoX+AErD2mapgz91n+8AOt0cIuPiisEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7934cb7bffceea8b489e25c7c5f1052c/8ac56/dd.webp 240w,\n/static/7934cb7bffceea8b489e25c7c5f1052c/d3be9/dd.webp 480w,\n/static/7934cb7bffceea8b489e25c7c5f1052c/8f3a3/dd.webp 647w\"\n              sizes=\"(max-width: 647px) 100vw, 647px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7934cb7bffceea8b489e25c7c5f1052c/8ff5a/dd.png 240w,\n/static/7934cb7bffceea8b489e25c7c5f1052c/e85cb/dd.png 480w,\n/static/7934cb7bffceea8b489e25c7c5f1052c/ca12d/dd.png 647w\"\n            sizes=\"(max-width: 647px) 100vw, 647px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7934cb7bffceea8b489e25c7c5f1052c/ca12d/dd.png\"\n            alt=\"image.png\"\n            title=\"image.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ガバガバ権限です。\n<code class=\"language-text\">sudo -l</code> の結果が上記のような出力の場合、ユーザは <code class=\"language-text\">sudo &lt;コマンド></code> をパスワードなしで実行できます。</p>\n<ul>\n<li><a href=\"https://qiita.com/RyodoTanaka/items/e9b15d579d17651650b7\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">sudo のパスワードを入力なしで使うには - Qiita</a></li>\n</ul>\n<p>まさかと思って調べてみたところ、やっぱり Rasbian は初期設定で sudo にパスワードが設定されていないようです。\nつまり、初期設定の Rasbian は、SSH 接続も権限昇格もし放題ってことですね。</p>\n<p>もし Rasbian をサーバ用途で使う場合は注意が必要そうですね。</p>\n<ul>\n<li><a href=\"https://qiita.com/R-STYLE/items/b481ba2d695ddf8bcee4\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RaspberryPiをRaspbianで使う場合の初期設定メモ（ユーザ追加） - Qiita</a></li>\n</ul>\n<h2 id=\"権限昇格\" style=\"position:relative;\"><a href=\"#%E6%A8%A9%E9%99%90%E6%98%87%E6%A0%BC\" aria-label=\"権限昇格 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>権限昇格</h2>\n<p>というわけで、サクッと root 権限を取得できました。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash:bash\"><pre class=\"language-bash:bash\"><code class=\"language-bash:bash\">sudo su</code></pre></div>\n<p>これでクリア！\nと、思いきや、もう少しだけ続きます。</p>\n<p>root.txt を開いてみると、フラグではなく次のテキストが書かれていました。\nどうやら本物の root.txt は失われてしまったようです。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">root@raspberrypi:~# cd /root/\nroot@raspberrypi:~# cat root.txt \nI lost my original root.txt! I think I may have a backup on my USB stick...</code></pre></div>\n<p>でもご安心。\nどうやらバックアップを USB に保存しているそうです。</p>\n<h2 id=\"もう一度内部探索\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%86%E4%B8%80%E5%BA%A6%E5%86%85%E9%83%A8%E6%8E%A2%E7%B4%A2\" aria-label=\"もう一度内部探索 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もう一度内部探索</h2>\n<p>ここから、バックアップされたデータを取得するためにもう一度探索を行います。</p>\n<p>とはいえ、 USB を探すのなんて楽勝です。\nLinux に一度でも USB を接続したことがあれば、 <code class=\"language-text\">/media</code> 配下にマウントされることが多いことがわかるかと思います。</p>\n<p>中身を見てみると、やはりありました。\nしかし、どうやらうっかりデータを削除してしまったようです…。</p>\n<p>James はうっかり屋さんですね。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">root@raspberrypi:~# cd /media\nroot@raspberrypi:/media# ls\nusbstick\nroot@raspberrypi:/media# cd usbstick/\nroot@raspberrypi:/media/usbstick# ls\ndamnit.txt  lost+found\nroot@raspberrypi:/media/usbstick# cat damnit.txt \nDamnit! Sorry man I accidentally deleted your files off the USB stick.\nDo you know if there is any way to get them back?\n-James</code></pre></div>\n<p>うっかり屋の James の尻ぬぐいもといフォローのため、何とかして失われた root.txt の中のフラグをサルベージしたいと思います。</p>\n<p>しかし、何を手掛かりに探せばいいのでしょうか？</p>\n<p>ここで考えるべきは、「Linux のデバイスマウントの仕組み」です。\n余談ですが Linux のカーネルがどんな動きをするのかについては、こちらの本が入門的で非常に参考になります。</p>\n<p><a href=\"https://amzn.to/2LyGD35\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">動かしながらゼロから学ぶ Linuxカーネルの教科書</a></p>\n<h3 id=\"linux-のデバイスマウントの仕組み\" style=\"position:relative;\"><a href=\"#linux-%E3%81%AE%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%9E%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF\" aria-label=\"linux のデバイスマウントの仕組み permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Linux のデバイスマウントの仕組み</h3>\n<p>Linux(というか Unix 系) は接続されたデバイスをすべて「デバイスファイル」として抽象化して管理しています。\n参考: <a href=\"https://wa3.i-3-i.info/word11689.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">デバイスファイル (device file)とは｜「分かりそう」で「分からない」でも「分かった」気になれるIT用語辞典</a></p>\n<p>デバイスドライバは、Linux カーネルによって「デバイスファイル」として抽象化され、慣例的な名前(sda, sdbなど)を付けられたのちに<code class=\"language-text\">/dev</code> 配下に格納されます。\nOS 上のアプリケーションは、この「デバイスファイル」を参照することで、ハードディスクや USB、マウスなどのデバイスを操作するわけです。</p>\n<p>デバイスファイルは、主に「キャラクター型」と「ブロック型」に分類され、ハードディスクなどの固定長のデータは、「ブロック型」として保存されます。\n参考：<a href=\"https://qiita.com/angel_p_57/items/1faafa275525469788b4\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Linuxのファイルの種類 - Qiita</a></p>\n<h2 id=\"root-フラグ取得\" style=\"position:relative;\"><a href=\"#root-%E3%83%95%E3%83%A9%E3%82%B0%E5%8F%96%E5%BE%97\" aria-label=\"root フラグ取得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>root フラグ取得</h2>\n<p>今回のターゲットの USB もこちらの「ブロック型」のデバイスファイルとして保存されているはずです。\nOS が利用できるブロックデバイスは、<code class=\"language-text\">lsblk</code>で出力可能です。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash:\"><pre class=\"language-bash:\"><code class=\"language-bash:\">root@raspberrypi:~# lsblk\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      8:0    0   10G  0 disk \n├─sda1   8:1    0  1.3G  0 part /lib/live/mount/persistence/sda1\n└─sda2   8:2    0  8.7G  0 part /lib/live/mount/persistence/sda2\nsdb      8:16   0   10M  0 disk /media/usbstick\nsr0     11:0    1 1024M  0 rom  \nloop0    7:0    0  1.2G  1 loop /lib/live/mount/rootfs/filesystem.squashfs</code></pre></div>\n<p>フラグの格納されている <code class=\"language-text\">/media/usbstick</code> は <code class=\"language-text\">sdb</code> というデバイスファイルとして扱われていることがわかりました。\n最後に、ここからデータを取り出していきます。</p>\n<p>HackTheBox のフラグはテキストとして保存されているので、正直 <code class=\"language-text\">strings /dev/sdb</code> だけでも簡単に取得できます。\nとはいえそれではあまりに面白くないので、 <code class=\"language-text\">/dev/sdb</code> の中身を見てみたいと思います。</p>\n<p><code class=\"language-text\">lsblk</code> の結果から、<code class=\"language-text\">/dev/sdb</code> のサイズは 10MB とわかっていますので、末尾のアドレスは<code class=\"language-text\">0xa00000</code>になります。\n<code class=\"language-text\">hexdump</code> で出力してあげます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash:bash\"><pre class=\"language-bash:bash\"><code class=\"language-bash:bash\">root@raspberrypi:~# hexdump -C /dev/sdb \n00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n0005b800  02 00 00 00 0c 00 01 02  2e 00 00 00 02 00 00 00  |................|\n0005b810  0c 00 02 02 2e 2e 00 00  0b 00 00 00 24 00 0a 02  |............$...|\n0005b820  6c 6f 73 74 2b 66 6f 75  6e 64 00 00 0c 00 00 00  |lost+found......|\n0005b830  10 00 08 01 72 6f 6f 74  2e 74 78 74 0d 00 00 00  |....root.txt....|\n0005b840  c4 03 0a 01 64 61 6d 6e  69 74 2e 74 78 74 00 00  |....damnit.txt..|\n0005b850  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n省略\n* Flag\n0080a800  33 64 33 65 34 38 33 31  34 33 66 66 31 32 65 63  |xxxxxxxxxxxxxxxx|\n0080a810  35 30 35 64 30 32 36 66  61 31 33 65 30 32 30 62  |xxxxxxxxxxxxxxxx|\n0080a820  0a 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n0080a830  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n0080ac00  44 61 6d 6e 69 74 21 20  53 6f 72 72 79 20 6d 61  |Damnit! Sorry ma|\n0080ac10  6e 20 49 20 61 63 63 69  64 65 6e 74 61 6c 6c 79  |n I accidentally|\n0080ac20  20 64 65 6c 65 74 65 64  20 79 6f 75 72 20 66 69  | deleted your fi|\n0080ac30  6c 65 73 20 6f 66 66 20  74 68 65 20 55 53 42 20  |les off the USB |\n0080ac40  73 74 69 63 6b 2e 0a 44  6f 20 79 6f 75 20 6b 6e  |stick..Do you kn|\n0080ac50  6f 77 20 69 66 20 74 68  65 72 65 20 69 73 20 61  |ow if there is a|\n0080ac60  6e 79 20 77 61 79 20 74  6f 20 67 65 74 20 74 68  |ny way to get th|\n0080ac70  65 6d 20 62 61 63 6b 3f  0a 0a 2d 4a 61 6d 65 73  |em back?..-James|\n0080ac80  0a 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n0080ac90  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00a00000</code></pre></div>\n<p>正直勉強不足で、USB メモリなどのフラッシュディスクのアドレスマップはよくわかってないですが、後半のブロックに実際のデータが格納されていそうなことはわかりました。</p>\n<p>つまり、James が USB メモリから root.txt を削除した段階では、root.txt を参照するための情報が削除されたにすぎず、実データは、そのアドレスに別のデータが上書きされるまで残り続けるというのが、このマシンの root を取得するための方法だったと考えられます。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>さて、これで Mirai の攻略に成功しました！\n今回のマシン攻略を通して得た防御側の知見としては以下のものがあるかと思います。</p>\n<ul>\n<li>初期設定の認証情報は狙われている</li>\n<li>sudo 権限は絞りましょう</li>\n<li>外部から SSH 接続をさせない(SSH を公開するときは PW 認証ではなく秘密鍵を使う)</li>\n<li>メディアデバイスを破棄する際にデータを削除する場合は上書き削除すること</li>\n</ul>\n<p>WriteUp は学んだことの整理に有益なのでまた書きたいですね。\nそれでは。</p>","fields":{"slug":"/hackthebox-linux-mirai","tagSlugs":["/tag/hack-the-box/","/tag/linux/","/tag/easy-box/"]},"frontmatter":{"date":"2021-10-04","description":"","tags":["HackTheBox","Linux","EasyBox"],"title":"【Easy/Linux】Mirai(HackTheBox)","socialImage":{"publicURL":"/static/dc4d8b7f8795f3c3d3489d9957d155f2/no-image.png"}}}},"pageContext":{"slug":"/hackthebox-linux-mirai"}},"staticQueryHashes":["251939775","401334301","825871152"]}