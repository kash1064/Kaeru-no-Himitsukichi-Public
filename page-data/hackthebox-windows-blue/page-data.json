{"componentChunkName":"component---src-templates-post-template-js","path":"/hackthebox-windows-blue","result":{"data":{"markdownRemark":{"id":"c5202e95-069f-5e03-81fa-a9545549a4e7","html":"<p>「Hack The Box」という、ペネトレーションテストの学習プラットフォームを利用してセキュリティについて学んでいます。\n「Hack The Box」のランクは、本記事執筆時点でProHackerです。</p>\n<img src=\"http://www.hackthebox.eu/badge/image/327080\" alt=\"Hack The Box\">\n<p>この記事では、HackTheBoxのマシン攻略を通して「EternalBlue」に関連した攻撃方法について勉強したことをまとめていきます。</p>\n<p>社会的に大きな被害を与えた「EternalBlue」に関連した攻撃について理解すべく、勉強したことをまとめていきます。</p>\n<p>「EternalBlue」は、世界中で猛威を奮ったランサムウェア「WannaCry」の拡散の要因となったことでも知られています。</p>\n<!-- omit in toc -->\n<h2 id=\"本記事について\" style=\"position:relative;\"><a href=\"#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"本記事について permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>本記事について</h2>\n<p><strong>本記事の内容は社会秩序に反する行為を推奨することを目的としたものではございません。</strong></p>\n<p>自身の所有する環境、もしくは許可された環境以外への攻撃の試行は、「不正アクセス行為の禁止等に関する法律（不正アクセス禁止法）」に違反する可能性があること、予めご留意ください。</p>\n<p>またすべての発言は所属団体ではなく個人に帰属します。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li><a href=\"#eternalblue%E3%81%A8%E3%81%AF\">EternalBlueとは</a></li>\n<li><a href=\"#eternalblue%E3%81%AE%E3%83%A1%E3%82%AB%E3%83%8B%E3%82%BA%E3%83%A0\">EternalBlueのメカニズム</a></li>\n<li>\n<p><a href=\"#file-extendedattribute%E6%8B%A1%E5%BC%B5%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%B1%9E%E6%80%A7fea%E3%81%A8%E3%81%AF\">File ExtendedAttribute（拡張ファイル属性、FEA）とは</a></p>\n<ul>\n<li><a href=\"#srvsrvos2fealistsizetont-%E9%96%A2%E6%95%B0\">srv!SrvOs2FeaListSizeToNt 関数</a></li>\n</ul>\n</li>\n<li><a href=\"#smb%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\">SMBプロトコルについて</a></li>\n<li>\n<p><a href=\"#eternalblue%E3%81%AE%E6%A4%9C%E8%A8%BC%E7%92%B0%E5%A2%83\">EternalBlueの検証環境</a></p>\n<ul>\n<li><a href=\"#%E3%82%BF%E3%83%BC%E3%82%B2%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3\">ターゲットマシン（仮想マシン）</a></li>\n<li><a href=\"#%E6%94%BB%E6%92%83%E3%83%9E%E3%82%B7%E3%83%B3%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3\">攻撃マシン（仮想マシン）</a></li>\n<li><a href=\"#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%83%9E%E3%82%B7%E3%83%B3%E3%83%9B%E3%82%B9%E3%83%88\">デバッグマシン（ホスト）</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E3%82%BF%E3%83%BC%E3%82%B2%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E6%BA%96%E5%82%99\">ターゲットマシンの準備</a></p>\n<ul>\n<li><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96\">カーネルモードデバッグの有効化</a></li>\n<li><a href=\"#smvv1%E3%81%AE%E7%A8%BC%E5%83%8D%E7%A2%BA%E8%AA%8D\">SMVv1の稼働確認</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#windbg%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0\">WinDbgを利用したカーネルデバッグ</a></p>\n<ul>\n<li><a href=\"#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\">インストール</a></li>\n<li><a href=\"#windbg%E3%81%AB%E3%82%88%E3%82%8B%E3%82%BF%E3%83%BC%E3%82%B2%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%B8%E3%81%AE%E6%8E%A5%E7%B6%9A\">WinDbgによるターゲットマシンへの接続</a></li>\n</ul>\n</li>\n<li><a href=\"#%E8%84%86%E5%BC%B1%E6%80%A7%E3%82%92%E6%82%AA%E7%94%A8%E3%81%97%E3%81%A6%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B9%E3%82%B7%E3%82%A7%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97\">脆弱性を悪用してリバースシェルを取得</a></li>\n<li>\n<p><a href=\"#windbg%E3%81%A7%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E5%AE%9F%E8%B7%B5\">WinDbgで、カーネルデバッグを実践</a></p>\n<ul>\n<li><a href=\"#%E6%82%AA%E7%94%A8%E6%99%82%E3%81%AE%E9%80%9A%E4%BF%A1%E3%82%92%E8%BF%BD%E3%81%86\">悪用時の通信を追う</a></li>\n<li><a href=\"#%E6%94%BB%E6%92%83%E3%82%B5%E3%83%BC%E3%83%90%E3%81%8B%E3%82%89%E3%81%AEsmb%E9%80%9A%E4%BF%A1\">攻撃サーバからのSMB通信</a></li>\n<li><a href=\"#%E3%83%90%E3%83%83%E3%83%95%E3%82%A1%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E3%83%95%E3%83%AD%E3%83%BC%E6%99%82%E3%81%AE%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0\">バッファオーバーフロー時のカーネルデバッグ</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n<li>\n<p><a href=\"#%E5%8F%82%E8%80%83\">参考</a></p>\n<ul>\n<li><a href=\"#book\">Book</a></li>\n<li><a href=\"#web\">Web</a></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"本記事のテーマ\" style=\"position:relative;\"><a href=\"#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%AE%E3%83%86%E3%83%BC%E3%83%9E\" aria-label=\"本記事のテーマ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>本記事のテーマ</h3>\n<p>今回のテーマは、「EternalBlue」の再現を通して、脆弱性の詳細と悪用方法について学び、セキュリティ対策に活用することです。</p>\n<h2 id=\"eternalblueとは\" style=\"position:relative;\"><a href=\"#eternalblue%E3%81%A8%E3%81%AF\" aria-label=\"eternalblueとは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EternalBlueとは</h2>\n<p>EternalBlueは、Windows SMB1.0に存在したセキュリティ上の欠陥を利用した攻撃ツールを指します。</p>\n<p>EternalBlueでは、「Windows SMB1.0（SMBv1）」の欠陥を悪用することで、攻撃者が任意のコードを実行できるようにします。</p>\n<p>EternalBlueは、2017 年 3 月に公開された更新プログラム「MS17-010」によって解決されています。\n参考：<a href=\"https://docs.microsoft.com/ja-jp/security-updates/securitybulletins/2017/ms17-010\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">マイクロソフト セキュリティ情報 MS17-010 - 緊急 | Microsoft Docs</a></p>\n<p>EternalBlueは、世界中で猛威を振るったランサムウェア「WannaCry」に利用され、世界中で約230,000台ものコンピューターに被害を及ぼし、世界中で猛威を振るった「WannaCry」による被害額は、合計で40億ドルに及んだと推計されているようです。</p>\n<p>日本国内でも、日立製作所など、多くの企業が被害にあっています。</p>\n<p>参考：<a href=\"https://www.kaspersky.co.jp/resource-center/threats/ransomware-wannacry\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ランサムウェア「WannaCry」 のすべて | カスペルスキー</a>\n参考：<a href=\"https://monoist.atmarkit.co.jp/mn/articles/1807/04/news042.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">日立は「WannaCry」被害から何を学んだのか、IoTセキュリティサービスに昇華：IoTセキュリティ（1/2 ページ） - MONOist</a></p>\n<p>EternalBlueは、「Shadow Brokers」と呼ばれるハッカー集団が流出された攻撃ツールに含まれていました。\nこれらの攻撃ツールは米国のNSAから流出したものと言われているようですが、真偽は不明です。</p>\n<p>また、インターネットで検索すると、EternalBlueを脆弱性としているページとEternalBlueを脆弱性としているページが混在していますが、ESETやTrendmiroのレポートから、EternalBlueは「MS17-010」に関連した脆弱性を悪用するエクスプロイトという認識が正しそうです。</p>\n<p>参考：<a href=\"https://www.welivesecurity.com/2018/05/10/one-year-later-eternalblue-exploit-wannacryptor/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">One year later: EternalBlue exploit more popular now than during WannaCryptor outbreak | WeLiveSecurity</a>\n参考：<a href=\"https://blog.trendmicro.co.jp/archives/15154\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">トレンドマイクロ セキュリティブログ「WannaCry」を拡散させた脆弱性攻撃「EternalBlue」の仕組みを解説 | トレンドマイクロ セキュリティブログ</a></p>\n<p>興味深い点としては、EternalBlueが公に流出した時点ではすでに「MS17-010」のパッチが提供されていたことです。</p>\n<p>参考：<a href=\"https://msrc-blog.microsoft.com/2017/04/14/protecting-customers-and-evaluating-risk/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Protecting customers and evaluating risk – Microsoft Security Response Center</a></p>\n<p>脆弱性の修正パッチが提供されていたにも関わらず、EternalBlueは世界中で悪用されてしまいました。\nまた、<a href=\"https://press.avast.com/ja-jp/avast-wannacry\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Avastの調査</a>によると、「WannaCry」の流行後一年が経過しても、全世界のWindowsPCの29%にパッチが適用されておらず、脆弱性が残存していたようです。</p>\n<p>Criticalな脆弱性に対するパッチを適用さえしていれば、自端末の感染、もしくは少なくとも感染拡大については抑制が可能であったことを考えると、教訓とすべき事例なのかもしれません。</p>\n<h2 id=\"eternalblueのメカニズム\" style=\"position:relative;\"><a href=\"#eternalblue%E3%81%AE%E3%83%A1%E3%82%AB%E3%83%8B%E3%82%BA%E3%83%A0\" aria-label=\"eternalblueのメカニズム permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EternalBlueのメカニズム</h2>\n<p>さて、ではEternalBlueの攻撃メカニズムについて詳細を見ていきたいと思います。</p>\n<p>EternalBlueは、「Windows SMB1.0（SMBv1）」のカーネル関数「srv!SrvOs2FeaListToNt」による「File ExtendedAttribute（拡張ファイル属性、FEA）」処理時に「Large Non-PagedPool（ラージ非ページプール）領域」のバッファオーバーフローを発生させる脆弱性です。</p>\n<p>具体的には、カーネル関数「srv!SrvOs2FeaListToNt」にて、FEA（拡張ファイル属性） を「NTFEA（Windows NT FEA）」に変換する際、関数「srv!SrvOs2FeaListSizeToNt」を呼び出して FEA（拡張ファイル属性）リストのサイズを計算する際の不具合に起因したオーバーフローが発生します。</p>\n<p>Trendmiroの調査によると、以下のフローでオーバーフローが発生するようです。</p>\n<blockquote>\n<ol>\n<li>関数「srv!SrvOs2FeaListSizeToNt」がFEA リストのサイズを計算し、受け取った FEA リストのサイズを更新する。</li>\n<li>この時、間違ったデータ型（WORD型、2 バイトの符号なし整数を扱う C 言語のデータ型）への型変換により、FEA のサイズが元の値より大きくなる。</li>\n<li>不正確なリストサイズにより、FEA リストを NTFEA リストに変換する繰り返し処理時、非ページプール上でオーバーフローが発生する。</li>\n</ol>\n<p>引用：<a href=\"https://blog.trendmicro.co.jp/archives/15154\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">トレンドマイクロ セキュリティブログ「WannaCry」を拡散させた脆弱性攻撃「EternalBlue」の仕組みを解説 | トレンドマイクロ セキュリティブログ</a></p>\n</blockquote>\n<h2 id=\"file-extendedattribute拡張ファイル属性feaとは\" style=\"position:relative;\"><a href=\"#file-extendedattribute%E6%8B%A1%E5%BC%B5%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%B1%9E%E6%80%A7fea%E3%81%A8%E3%81%AF\" aria-label=\"file extendedattribute拡張ファイル属性feaとは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>File ExtendedAttribute（拡張ファイル属性、FEA）とは</h2>\n<p>さて、EternalBuleで悪用される脆弱性を持つFEA（拡張ファイル属性）とはそもそも何でしょうか。</p>\n<p>RFC8276によると、この拡張ファイル属性は、ファイルシステムによって解釈されない不透明なメタデータをファイルおよびディレクトリに関連付けるために提供されるもののようです。</p>\n<p>つまり、ファイルシステムが解釈しないメタデータをユーザ側がファイルと紐づけることができる仕組みというイメージでしょうか。</p>\n<p>一方で、ファイルの権限やatime、ctimeなどの属性は、通常の属性としてファイルシステムにより厳密に定義されているものとしてFEAとは区別されているようです。</p>\n<p>参考：</p>\n<ul>\n<li><a href=\"https://ja.wikipedia.org/wiki/%E6%8B%A1%E5%BC%B5%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%B1%9E%E6%80%A7\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">拡張ファイル属性 - Wikipedia</a></li>\n<li><a href=\"https://tex2e.github.io/rfc-translater/html/rfc8276.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RFC 8276 - File System Extended Attributes in NFSv4 日本語訳</a></li>\n</ul>\n<h3 id=\"srvsrvos2fealistsizetont-関数\" style=\"position:relative;\"><a href=\"#srvsrvos2fealistsizetont-%E9%96%A2%E6%95%B0\" aria-label=\"srvsrvos2fealistsizetont 関数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>srv!SrvOs2FeaListSizeToNt 関数</h3>\n<p>EternalBuleでは、<code class=\"language-text\">srv!SrvOs2FeaListSizeToNt</code>関数が計算したFEAリストのサイズを処理した際に生じるバッファオーバーフローの脆弱性を悪用します。</p>\n<p><code class=\"language-text\">srv!SrvOs2FeaListSizeToNt</code>関数は、SMBプロトコルのためのカーネルドライバである<code class=\"language-text\">SRV.sys</code>に含まれる関数で、OS/2 FEAリストをNT FEAリスト変換するための機能を持っています。</p>\n<p>参考：</p>\n<ul>\n<li><a href=\"https://medium.com/@singhavijeet1994/eternal-series-part-1-eternal-blue-and-analysis-windows-7-and-8-1-c631572e549b\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Eternal Series — Part 1 | Eternal Blue and Analysis | Windows 7 and 8.1 Exploitation | Hack Windows 7 and 8.1 Remotely | by Abhijeet Singh | Medium</a></li>\n</ul>\n<h2 id=\"smbプロトコルについて\" style=\"position:relative;\"><a href=\"#smb%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"smbプロトコルについて permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SMBプロトコルについて</h2>\n<p>EternalBuleで悪用される、<code class=\"language-text\">srv!SrvOs2FeaListSizeToNt</code>関数は、SMBプロトコルが利用する<code class=\"language-text\">SRV.sys</code>というカーネルドライバに存在することがわかりました。</p>\n<p>しかし、そもそもSMBプロトコルとはなんでしょうか（知らない）。\nよく名前は聞きますが、いまいち実態がつかめないプロトコルです。</p>\n<p>SMBプロトコルは、<strong>Windowsを中心とした環境において、ファイル共有やプリンタ共有などに使用される通信プロトコルの総称</strong>、だそうです。</p>\n<p>SMBプロトコルは、複数のプロトコル上で動作することが可能で、SMBv1はダイレクトホスティングSMBという機能により、ポート445を利用してTCP上で直接動作することも可能になりました。</p>\n<p><strong>SMBプロトコルはもともと、OS/2ベースのファイルサーバーOSで動作していたファイルサーバのファイル共有用プロトコル</strong>でしたが、Windows 3.xや9xからファイルサーバー機能が搭載されるようになったことで、一般的に利用されるようになりました。</p>\n<p><code class=\"language-text\">srv!SrvOs2FeaListSizeToNt</code>がOS/2 FEAリストをNT FEAリスト変換する処理を行っているのは、こういう歴史的な背景もありそうです。</p>\n<p>参考：</p>\n<ul>\n<li><a href=\"https://ja.wikipedia.org/wiki/Server_Message_Block\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Server Message Block - Wikipedia</a></li>\n<li><a href=\"https://www.atmarkit.co.jp/ait/articles/1507/02/news026.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">第7回　ファイル共有プロトコルSMBの概要：Windowsネットワークの基礎 - ＠IT</a></li>\n<li><a href=\"https://docs.oracle.com/cd/E19253-01/820-5121/gfhaq/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SMB プロトコルの説明</a></li>\n</ul>\n<h2 id=\"eternalblueの検証環境\" style=\"position:relative;\"><a href=\"#eternalblue%E3%81%AE%E6%A4%9C%E8%A8%BC%E7%92%B0%E5%A2%83\" aria-label=\"eternalblueの検証環境 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EternalBlueの検証環境</h2>\n<p>さて、EternalBuleの悪用方法や環境についてのリサーチが大体できたところで、実際に攻撃手法を検証していきたいと思います。</p>\n<p>今回はEternalBuleの検証のため、次の環境を準備しました。</p>\n<h3 id=\"ターゲットマシン仮想マシン\" style=\"position:relative;\"><a href=\"#%E3%82%BF%E3%83%BC%E3%82%B2%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3\" aria-label=\"ターゲットマシン仮想マシン permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ターゲットマシン（仮想マシン）</h3>\n<ul>\n<li>\n<p>Windows7 64bit （IP:169.254.100.60）</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kd> vertarget\n\nWindows 7 Kernel Version 7601 (Service Pack 1) MP (1 procs) Free x64\nBuilt by: 7601.17514.amd64fre.win7sp1_rtm.101119-1850\nMachine Name:\nKernel base = 0xfffff800`02e1f000 PsLoadedModuleList = 0xfffff800`03064e90\nDebug session time: Mon Apr 26 01:19:52.742 2021 (UTC + 9:00)\nSystem Uptime: 0 days 0:08:03.468</code></pre></div>\n</li>\n</ul>\n<h3 id=\"攻撃マシン仮想マシン\" style=\"position:relative;\"><a href=\"#%E6%94%BB%E6%92%83%E3%83%9E%E3%82%B7%E3%83%B3%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3\" aria-label=\"攻撃マシン仮想マシン permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>攻撃マシン（仮想マシン）</h3>\n<ul>\n<li>Parrot OS（IP:169.254.100.10）</li>\n<li>WireShark</li>\n</ul>\n<h3 id=\"デバッグマシンホスト\" style=\"position:relative;\"><a href=\"#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%83%9E%E3%82%B7%E3%83%B3%E3%83%9B%E3%82%B9%E3%83%88\" aria-label=\"デバッグマシンホスト permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>デバッグマシン（ホスト）</h3>\n<ul>\n<li>Windows 10 Pro 20H2</li>\n<li>Hyper-V</li>\n<li>WinDbg 10.0.19041.685 X86</li>\n</ul>\n<h2 id=\"ターゲットマシンの準備\" style=\"position:relative;\"><a href=\"#%E3%82%BF%E3%83%BC%E3%82%B2%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E6%BA%96%E5%82%99\" aria-label=\"ターゲットマシンの準備 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ターゲットマシンの準備</h2>\n<h3 id=\"カーネルモードデバッグの有効化\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96\" aria-label=\"カーネルモードデバッグの有効化 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カーネルモードデバッグの有効化</h3>\n<p>まずはターゲットマシンのWindows7にて、カーネルデバッグを有効にします。</p>\n<p>今回のターゲットマシンはHyper-Vで構築した仮想マシンなので、デバッグのためのシリアルポートを名前付きパイプとして設定します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 748px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3a736d6c270b9232fa798f7a249d1527/f8915/blue.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABrUlEQVQoz11S2Y7iQAzM/38WL7NaLYfYgSGQkKNz3xckCJZaVyMQIpLluN0uV9ltLPc2QqVQliXKosBut0OSJGjqGmmSoqoquK6rfdM0qOWcPk1TXdO2LcZxxOl0wuVygWF7HnzXgQoCKBVIscS+QnfqUQ81uqHDNE44n88vY/ETZBgGfcaGhRAyVj82fm89HNwIXhAjSHL4QQLLsbD3D/AjpZmSEZnTZ1mm/9/jOI4fgFacYa9iJGmOtuvArxEZ33+/Mf8zh7kzsdlssFqt9DgWi4W27Xarz9frNebzOSIB9H0PRlid4aoQXdvgdrvhnxjnwoLZbAbTNHV3x3GkwNfesiwZj0IgY2J8PB410zBQMOJCJEqyF3bjNGES4zzCMNQdCcKYTfq+f1kn95/GOVKuluyFSjoeUFc1rterlsxNPtksl0u95Vo2W+S5MMk0CBu8G+eYS96IM2ETJfBk22TCj8+BctjRtm2dYwMugTne+7QXYJSW8PxAyyMzsiQQJXNOv76+9DI4x+cbpH83nhHMOuxhjNNFOjwS9/v9JZlglPJ40A9Zn0CfgGT5HyL46XhL9htsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/3a736d6c270b9232fa798f7a249d1527/8ac56/blue.webp 240w,\n/static/3a736d6c270b9232fa798f7a249d1527/d3be9/blue.webp 480w,\n/static/3a736d6c270b9232fa798f7a249d1527/0bb9d/blue.webp 748w\"\n              sizes=\"(max-width: 748px) 100vw, 748px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/3a736d6c270b9232fa798f7a249d1527/8ff5a/blue.png 240w,\n/static/3a736d6c270b9232fa798f7a249d1527/e85cb/blue.png 480w,\n/static/3a736d6c270b9232fa798f7a249d1527/f8915/blue.png 748w\"\n            sizes=\"(max-width: 748px) 100vw, 748px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/3a736d6c270b9232fa798f7a249d1527/f8915/blue.png\"\n            alt=\"image-20210425142147502\"\n            title=\"image-20210425142147502\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>次に、ターゲットマシンにログインして、カーネルモードのデバッグを有効にします。</p>\n<p>管理者権限で起動したコマンドプロンプトで以下のコマンドを実行することで有効化できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"cmd\"><pre class=\"language-cmd\"><code class=\"language-cmd\">bcdedit /debug on\nbcdedit /dbgsettings serial debugport:1 baudrate:115200\nshutdown /r /t 0</code></pre></div>\n<p><code class=\"language-text\">Msconfig.exe</code>を起動して、詳細オプションからCOM1ポートを指定してデバッグを有効した後に再起動してもOKです。</p>\n<h3 id=\"smvv1の稼働確認\" style=\"position:relative;\"><a href=\"#smvv1%E3%81%AE%E7%A8%BC%E5%83%8D%E7%A2%BA%E8%AA%8D\" aria-label=\"smvv1の稼働確認 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SMVv1の稼働確認</h3>\n<p>次に、ターゲットホストのWindows7にて、SMVv1が有効になっていることを確認します。</p>\n<p>以下のコマンドの出力結果に、<code class=\"language-text\">DEPENDENCIES: MRxSmb10</code>存在するとSMB1.0が有効になっていると判断できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"cmd\"><pre class=\"language-cmd\"><code class=\"language-cmd\">sc.exe qc lanmanworkstation</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 634px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/847de4493cf443ed9f77787bcf91b12d/374ac/2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABBUlEQVQoz5WR6Y6DMAyEQ7nvo1AoUjkEvP8juvqsBq1W2nb7YxST4PHM2NzvdwG3202GYZDr9apo2/asq6pSRFEkxpj3KIpCQJIkkmXZibIsxXXdzwS/AdHj8VBF1HmeS5qmqoga4qZp9L2ua/3+QGrUKqR930sYhvrAyYBt22QcR1XteZ7iX4Q0rusqx3GoEhq7rpNpmnSQjcZGEsexDuUOJ9y9MjbawFIggoSfsY1NGrDPeblcNFcLx3HOmjdwKlyWReZ5PjNiIhvm9H3/m8UYbSAvlL2mqMJ931X5l5s2p1ws2OCxSaZsOAgCHfrT3ltCQqXR5kWOBI5KIgDka8PHyV+ETz1s2+iG7W7KAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/847de4493cf443ed9f77787bcf91b12d/8ac56/2.webp 240w,\n/static/847de4493cf443ed9f77787bcf91b12d/d3be9/2.webp 480w,\n/static/847de4493cf443ed9f77787bcf91b12d/14369/2.webp 634w\"\n              sizes=\"(max-width: 634px) 100vw, 634px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/847de4493cf443ed9f77787bcf91b12d/8ff5a/2.png 240w,\n/static/847de4493cf443ed9f77787bcf91b12d/e85cb/2.png 480w,\n/static/847de4493cf443ed9f77787bcf91b12d/374ac/2.png 634w\"\n            sizes=\"(max-width: 634px) 100vw, 634px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/847de4493cf443ed9f77787bcf91b12d/374ac/2.png\"\n            alt=\"image-20210425111203549\"\n            title=\"image-20210425111203549\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これでターゲットマシン側の準備は完了しました。</p>\n<h2 id=\"windbgを利用したカーネルデバッグ\" style=\"position:relative;\"><a href=\"#windbg%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0\" aria-label=\"windbgを利用したカーネルデバッグ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbgを利用したカーネルデバッグ</h2>\n<h3 id=\"インストール\" style=\"position:relative;\"><a href=\"#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\" aria-label=\"インストール permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>インストール</h3>\n<p>ホスト側のWindows10にWinDbgをセットアップして、ターゲットマシンのカーネルデバッグを行います。</p>\n<p>WinDbgは、Debugging Tools for Windowsに含まれるカーネルモードおよびユーザーモードのデバッガです。\nWinDbgを利用することで、Windowsシステムドライバのデバッグも可能になります。</p>\n<p>本記事執筆時点でWinDbgをセットアップする方法は、大きく以下の2通りあります。</p>\n<ol>\n<li>Microsoft Storeから、Download WinDbg(Preview)のUWPアプリを入手する</li>\n<li><a href=\"https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Windows 10 SDK</a>から、Debugging Tools for Windowsが含まれるWindows SDKを入手する</li>\n</ol>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/debugger-download-tools\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Download Debugging Tools for Windows - WinDbg - Windows drivers | Microsoft Docs</a></p>\n<p>簡単なのはMicrosoft Storeから、プレビュービルドのWinDbgを入手する方法ですが、まだ正式リリース前ということもあり、不具合が多いためWindows SDKをインストールする方が無難に使用可能です。</p>\n<p>Debugging Tools for Windowsのチェックボックスを有効化した状態でWindows SDKのインストールが完了すると、<code class=\"language-text\">C:\\Program Files (x86)\\Windows Kits\\</code>というフォルダが作成されます。</p>\n<p>WinDbgは、この中に含まれます。</p>\n<p>今回のターゲットマシンは64bit版のWindow7なので、<code class=\"language-text\">C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\</code>内にあるWinDbgを使用します。</p>\n<h3 id=\"windbgによるターゲットマシンへの接続\" style=\"position:relative;\"><a href=\"#windbg%E3%81%AB%E3%82%88%E3%82%8B%E3%82%BF%E3%83%BC%E3%82%B2%E3%83%83%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%B8%E3%81%AE%E6%8E%A5%E7%B6%9A\" aria-label=\"windbgによるターゲットマシンへの接続 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbgによるターゲットマシンへの接続</h3>\n<p>ダウンロードした<code class=\"language-text\">C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\</code>内のWinDbgを、<strong>管理者権限で起動</strong>します。</p>\n<p>この際、一般ユーザ権限で起動すると、ターゲットマシンのカーネルデバッグ接続時に<code class=\"language-text\">Kernel debugger failed initialization, Win32 error 5 アクセス拒否されました</code>というエラーが発生して、カーネルデバッグに失敗するので注意してください。</p>\n<p>WinDbgを管理者権限で起動したら、[File]>[Kernel Debug]を選択し、以下の画像のように名前付きパイプを利用してターゲットマシンに接続させます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 401px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/195ac5d45d15a09936874f470b2ff5dd/9144d/3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 101.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACqklEQVQ4y51UbVPaQBDO//8L/Wpn7DgWEcEXdKZ+6PgGCEEJtoAgEJIQAnlPRHi6e0yoCrS2mXlm9+72ntt7di/ShXyPsTWG5/kEF0EYkPXg+z5c10X8/IyPfHPGfA4p8EOEUSQ2+0TkEZFH/ng8RkTz1mgE23YQxzEsy8JsNl8QzN/a5JO2tz8hk0khnz/F0dERstksDg8PkcvlxJgtj4+Pj8X45OREIJ/P4+DgAPv7+xRzht1UDttfMpB2drawt/eVSBeLC6SXfjqdXiKTybyK+b2WSu1hZ3cXW1ufIbmOh6FuYqAOoGs6tP4A//K9vLwsbbfbhWRZIxjGkHSyoWkaTNKM50ZkJ5OJ0E3YkYkR+Vwwx3HegPcGQYBarQap3++h2XoUmx7qdZimBZXmWo+P5JtoNBriQIv8McWEYSRimSQBj7kr7u7u6MpUUc5GVVW02x30ej0Mh0ORbbvdFmtMzOuGYaDT6Qj/dZVns5nwFUXhK1tQKDMe8GmsxTP1Hgey7ff74lrLfnvXJq/nBCGn22w28fT0JPqOteCsp9OpABNylrzG44TgPZaEo4mDcu0n2uoQnYGJoU2E8RxTukUUheIwvj5fNwzDlSxXCG0vRKtvoNUlzVQDxsSHHc0QUzeE9Ay5KCwLv5R1r2OFkAM3acIa8vXZchUT8f9IGEXxii7rNm0qysYM14n8N39tUbh6m4I+ijd9uE7D//0EIYvO7ZAgIjj0j9QmAQx7YU0nEP3J4JjE50L5/sJyYuLp8WNP4LoeosDHQ89CtaWiICu4b3RQbGjoDXT8eFBQKpVQp5el6zrUgSb+AxW5ioFuoFyuQOLFBIpSp011XN7e4/Sygvz3Is4ubnF2JaNckVEqFnB1dY2bQgGyzHMVFOmA6+sbyNUqvp2f4xfIseDzcfSdwgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/195ac5d45d15a09936874f470b2ff5dd/8ac56/3.webp 240w,\n/static/195ac5d45d15a09936874f470b2ff5dd/b3c31/3.webp 401w\"\n              sizes=\"(max-width: 401px) 100vw, 401px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/195ac5d45d15a09936874f470b2ff5dd/8ff5a/3.png 240w,\n/static/195ac5d45d15a09936874f470b2ff5dd/9144d/3.png 401w\"\n            sizes=\"(max-width: 401px) 100vw, 401px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/195ac5d45d15a09936874f470b2ff5dd/9144d/3.png\"\n            alt=\"image-20210425143834960\"\n            title=\"image-20210425143834960\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>プロンプトが起動し、<code class=\"language-text\">dt nt!_*</code>を実行したときに以下のようにシンボルリストが出力されれば接続は成功です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 832px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5bf59694043a70a0ca10ceeaafc4f7ac/ef6b9/4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.16666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABnklEQVQ4y3WTWYvCUAyF+/9/kO8+KIooiI772qK27ktr3TP9AilOHS+ENJfk5OTk1vGDlURRKIfDIbVTGEocx3I+n1MfRZFafLnI7Xb7as7PT0c8zxPPdcV1PZlMJmpuEs/nc1ksFhL4gSyXS/3GuNfGp5Mcj0fZbrcaD4dDcUqlknS7XWk2m9LpdPSS4vV6rUkwxOiOv16vapeE6ePxEM7r9VLfbrfFqVarMp1OFQg/Ho/V+v2+xnhimNj4WJjIQhPO8/lUrwzL5bK0Wi0tNkAkYGzG22w26mENUPbAzgCRyanX6zIajRR9MBgoI74BpgHgJJLj+77sdjvVbLVa6ZLeGZLvoFUQBNJoNLQIZgCaniYHI9/v91QvxjXGH4CIu9/vtbsthCawYGQ8+r0fwO3uDyAjUqDPIwFhvNlspqNyhyfmnjwaMjKN/mWIhmj3vmXTzthSbN4Aidn0B2Cv11MGsCGRAuLsiBRhtlX7/gDktXNYAs+nVqtJpVJRxvYrZsG/PZsUEIELhYIUi0XJ5/OSy+UU9P0vseKsZRn+AnqG1cCPblNMAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/5bf59694043a70a0ca10ceeaafc4f7ac/8ac56/4.webp 240w,\n/static/5bf59694043a70a0ca10ceeaafc4f7ac/d3be9/4.webp 480w,\n/static/5bf59694043a70a0ca10ceeaafc4f7ac/de44a/4.webp 832w\"\n              sizes=\"(max-width: 832px) 100vw, 832px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/5bf59694043a70a0ca10ceeaafc4f7ac/8ff5a/4.png 240w,\n/static/5bf59694043a70a0ca10ceeaafc4f7ac/e85cb/4.png 480w,\n/static/5bf59694043a70a0ca10ceeaafc4f7ac/ef6b9/4.png 832w\"\n            sizes=\"(max-width: 832px) 100vw, 832px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/5bf59694043a70a0ca10ceeaafc4f7ac/ef6b9/4.png\"\n            alt=\"image-20210425144046592\"\n            title=\"image-20210425144046592\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>初回接続時にはまだターゲットマシンのカーネルが稼働しているため、Busy状態と表示され、コマンドが入力できない状態になっているかと思います。</p>\n<p>WinDbgからコマンド操作ができるようにするためには、<code class=\"language-text\">Ctrl+Break(Breakキーがない場合は、Ctrl+Fn+Bなど)</code>か、Breakボタンをクリックします。</p>\n<p>なお、カーネルデバッグ実行中は、ターゲットマシンの操作は不可能になるため、ターゲットマシンを再度操作する場合は、<code class=\"language-text\">F5</code>キーかGoボタンをクリックします。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 641px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4109c03f368fb927b1b409d11c0347e0/c7dcc/5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABOElEQVQoz32S246CQBBE5/8/y5jIkzxhIioXFcULeCUBFWtzOpnNxs0uSaWrZ+jq7gK3XC61Xq+12WxUFIV87rFarSxyR8yyzEAOuKfW17u2bRVFkcIw1GQyUZ7nms1mxqfTqcbjsebzuXHeoaiua/V9r8/ner3KdV2n7XZrQmmaWic4kYkQOh6Pulwu2u/3ut/ver/fJvAZb7ebHORnt6qqrBPxfD7rdDpZ3O121hjQ4Pl86vF4fIOcZg4/mGyxWNhESZJYzmpM6j2Cc48wnOg5A2ADzR1CeOaF4QChOI7tjELWBYiTHw4HlWVpE8OZmtxhOKIUc0gniihmbc7w6PV6/QJWec7K5A5/2B3TMbVpGouccwbg/4FVqcFLNxqNNBgMNBwO7RcJgsDA12Vq4G34C7yD9/j+BZUbnj8ILmS5AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4109c03f368fb927b1b409d11c0347e0/8ac56/5.webp 240w,\n/static/4109c03f368fb927b1b409d11c0347e0/d3be9/5.webp 480w,\n/static/4109c03f368fb927b1b409d11c0347e0/de042/5.webp 641w\"\n              sizes=\"(max-width: 641px) 100vw, 641px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4109c03f368fb927b1b409d11c0347e0/8ff5a/5.png 240w,\n/static/4109c03f368fb927b1b409d11c0347e0/e85cb/5.png 480w,\n/static/4109c03f368fb927b1b409d11c0347e0/c7dcc/5.png 641w\"\n            sizes=\"(max-width: 641px) 100vw, 641px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4109c03f368fb927b1b409d11c0347e0/c7dcc/5.png\"\n            alt=\"image-20210425144334695\"\n            title=\"image-20210425144334695\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"脆弱性を悪用してリバースシェルを取得\" style=\"position:relative;\"><a href=\"#%E8%84%86%E5%BC%B1%E6%80%A7%E3%82%92%E6%82%AA%E7%94%A8%E3%81%97%E3%81%A6%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B9%E3%82%B7%E3%82%A7%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97\" aria-label=\"脆弱性を悪用してリバースシェルを取得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>脆弱性を悪用してリバースシェルを取得</h2>\n<p>カーネルドライバの動きを確認する準備ができたところで、さっそくEternalBuleの攻撃を再現していきます。</p>\n<p>攻撃には、Metasploitの<code class=\"language-text\">windows/smb/ms17_010_eternalblue</code>を使用します。</p>\n<p>攻撃サーバからエクスプロイトを実行すると、Root権限のシェルを取得することができました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 641px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4109c03f368fb927b1b409d11c0347e0/c7dcc/5-165352297411874.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABOElEQVQoz32S246CQBBE5/8/y5jIkzxhIioXFcULeCUBFWtzOpnNxs0uSaWrZ+jq7gK3XC61Xq+12WxUFIV87rFarSxyR8yyzEAOuKfW17u2bRVFkcIw1GQyUZ7nms1mxqfTqcbjsebzuXHeoaiua/V9r8/ner3KdV2n7XZrQmmaWic4kYkQOh6Pulwu2u/3ut/ver/fJvAZb7ebHORnt6qqrBPxfD7rdDpZ3O121hjQ4Pl86vF4fIOcZg4/mGyxWNhESZJYzmpM6j2Cc48wnOg5A2ADzR1CeOaF4QChOI7tjELWBYiTHw4HlWVpE8OZmtxhOKIUc0gniihmbc7w6PV6/QJWec7K5A5/2B3TMbVpGouccwbg/4FVqcFLNxqNNBgMNBwO7RcJgsDA12Vq4G34C7yD9/j+BZUbnj8ILmS5AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4109c03f368fb927b1b409d11c0347e0/8ac56/5-165352297411874.webp 240w,\n/static/4109c03f368fb927b1b409d11c0347e0/d3be9/5-165352297411874.webp 480w,\n/static/4109c03f368fb927b1b409d11c0347e0/de042/5-165352297411874.webp 641w\"\n              sizes=\"(max-width: 641px) 100vw, 641px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4109c03f368fb927b1b409d11c0347e0/8ff5a/5-165352297411874.png 240w,\n/static/4109c03f368fb927b1b409d11c0347e0/e85cb/5-165352297411874.png 480w,\n/static/4109c03f368fb927b1b409d11c0347e0/c7dcc/5-165352297411874.png 641w\"\n            sizes=\"(max-width: 641px) 100vw, 641px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4109c03f368fb927b1b409d11c0347e0/c7dcc/5-165352297411874.png\"\n            alt=\"image-20210426105539203\"\n            title=\"image-20210426105539203\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これで、今回構築した環境でEternalBuleの攻撃が再現できることが確認できました。</p>\n<h2 id=\"windbgでカーネルデバッグを実践\" style=\"position:relative;\"><a href=\"#windbg%E3%81%A7%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E5%AE%9F%E8%B7%B5\" aria-label=\"windbgでカーネルデバッグを実践 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbgで、カーネルデバッグを実践</h2>\n<p>さて、それではいよいよエクスプロイト実行時のSRV.sysの動きをWinDbgで見てみます。</p>\n<p>カーネルドライバのデバッグを行うので、<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Windows ドライバーのデバッグ</a>の手順を参考に進めました。</p>\n<p>まずは、<strong>デバッガーマークアップ言語 (DML) を有効</strong>にした後に、コマンドリファレンスヘルプを表示します。</p>\n<p>このヘルプが非常に役に立ちます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kd> .prefer_dml 1\nkd> .hh .prefer_dml</code></pre></div>\n<p>次に、読み込まれているカーネルモジュールの一覧を<code class=\"language-text\">lm</code>コマンドで表示します。</p>\n<p>モジュールがいくつも表示されますが、この中から、今回のターゲットであるSRV.sysを特定します。\n<code class=\"language-text\">Ctrl+f</code>で文字列検索ができます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 381px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c6be1bcbac9abf2edaa6d270ba232c00/2add2/7.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB+UlEQVQoz4WTSY+bQBSE/f9/R47JJckhkZIZKfICZrGNF/CCsTWKPM6wGDAee1gqXY2MguYQJIRo+n2vXlXT6ff7cBwHpmlis9nAsizMZjNouo70FOIpyvHJDGHsMzw4MQbuGZvnFH+OR0wmFsbjsdzveR7KskRHURQJHI1GEsiPhOq6gUQAj2mBr1YE+/AKoAIvd7vFYDCAbdswDANBEMj1qqrQoUJ20TQNq9VKdJ3IjZqmIwp9hJcSj0JZ301xuRWycCuArJvP56Kx3gayE0FUuF6v5SY2UBRVKIzwci7xfXbCj0XcADke6+5WtYCUzA/D4RCu62K5XGI6nUIV70kc4RAX+GnH2Ac34VHVAP+1qgWkX4TcgRyHa8OhJj08JAUeBDC9Fo2H/wUyCAIJI5Q+EhgLYJiV+DKJYIqU86JsjUyvOXIYhm1gHYLWKKSPtcIIz0LhRyPE4zKB518bYK/Xw2KxeJ8yFxgGFfLJgAhUVBVxFEgPP48jaLszK5qUCeRk71K+KySQnamS3hiGKT2kwl+rRJ7DW16PvNvVHrI5T0RrZHrAVLvdrlTIgOhhfWwC7MMcHxQf3ssVb8JDIrfeTnrIOk7o+76ESSBV8SboKH4n3uzsOEu8ZmcEWYFv4hyq3hnT3xeMnzLEl1wcqZPcx1r+Yfex/wLBf2ZMv8b3hgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/c6be1bcbac9abf2edaa6d270ba232c00/8ac56/7.webp 240w,\n/static/c6be1bcbac9abf2edaa6d270ba232c00/25250/7.webp 381w\"\n              sizes=\"(max-width: 381px) 100vw, 381px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/c6be1bcbac9abf2edaa6d270ba232c00/8ff5a/7.png 240w,\n/static/c6be1bcbac9abf2edaa6d270ba232c00/2add2/7.png 381w\"\n            sizes=\"(max-width: 381px) 100vw, 381px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/c6be1bcbac9abf2edaa6d270ba232c00/2add2/7.png\"\n            alt=\"image-20210425201017305\"\n            title=\"image-20210425201017305\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>SRV.sysらしきものが見つかったので、クリックしてみると次のような詳細が表示されました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kd> lmDvmsrv\nBrowse full module list\nstart    end        module name\n93269000 932ba000   srv        (deferred)             \n    Image path: \\SystemRoot\\System32\\DRIVERS\\srv.sys\n    Image name: srv.sys\n    Browse all global symbols  functions  data\n    Timestamp:        Sat Nov 20 17:45:29 2010 (4CE78AA9)\n    CheckSum:         0005542B\n    ImageSize:        00051000\n    Translations:     0000.04b0 0000.04e4 0409.04b0 0409.04e4\n    Information from resource tables</code></pre></div>\n<p>どうやら<code class=\"language-text\">93269000</code>からのアドレスにSRV.sysが配置されているようです。</p>\n<p>次に、SRV.sysの中から、問題のある関数のアドレスを特定していきます。\n<code class=\"language-text\">srv!a*</code>コマンドを実行すると、SRV.sysの持つ関数がアルファベット別に表示されました。</p>\n<p>脆弱性のある関数は<code class=\"language-text\">SrvOs2FeaListSizeToNt</code>ですが、問題の関数は<code class=\"language-text\">srv!SrvSmbOpen2</code>から呼び出されるため、まずは<code class=\"language-text\">srv!SrvSmbOpen2</code>のアドレスを特定しました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 654px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b2e9850499605353e98bd30eb06bee9/68e9c/8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAArUlEQVQI1z2OSwuDMBCE/f8/pJfeC4WeWpBGU6KJKamCfSS+RRBvXqbNQl34YJdhZjYYhgH/cc7h+f6geFncpMY5vEIphbIsobVG13VEXddomoY0IQTdy7JgnmcE4zhugXXlEEmD/Ylhd7jgGCbI85yMjDHEcQwpJfq+x7qu8N62bTFNE4VaaxH4pu3DqsLDGIgbJ+5aIU1TcM6JoihgfnoURbR7sixDkiRU6gu/Rj7Xtl5+mUUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/3b2e9850499605353e98bd30eb06bee9/8ac56/8.webp 240w,\n/static/3b2e9850499605353e98bd30eb06bee9/d3be9/8.webp 480w,\n/static/3b2e9850499605353e98bd30eb06bee9/d7085/8.webp 654w\"\n              sizes=\"(max-width: 654px) 100vw, 654px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/3b2e9850499605353e98bd30eb06bee9/8ff5a/8.png 240w,\n/static/3b2e9850499605353e98bd30eb06bee9/e85cb/8.png 480w,\n/static/3b2e9850499605353e98bd30eb06bee9/68e9c/8.png 654w\"\n            sizes=\"(max-width: 654px) 100vw, 654px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/3b2e9850499605353e98bd30eb06bee9/68e9c/8.png\"\n            alt=\"image-20210425201740669\"\n            title=\"image-20210425201740669\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">932a156f</code>に<code class=\"language-text\">srv!SrvSmbOpen2</code>が配置されていることがわかったので、以下のコマンドで関数にブレークポイントを仕掛けます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">bp srv!SrvSmbOpen2</code></pre></div>\n<p>ブレークポイントは、<code class=\"language-text\">bl</code>コマンドか、Disassemblyウィンドウから確認可能です。</p>\n<p><code class=\"language-text\">Alt+Shift+7</code>キーでDisassemblyウィンドウを開くと、ブレークポイントが設定されたアドレスがハイライトされます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ba808daf6d077886ceab59fc100ededd/77672/9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB7klEQVQ4y42T25KaQBCGff83SSUXqVSqUqnam1xk92Yr6nIeAWURFpCDgqXI6d+eAY1GTTJVzQw9zEd3/z2jh8cpHh4neJqaGBtLYc+aI4yvJ8zDmC3vGt//OWHi/KePXzBSVBWaIsEyGeqqBB9pskK+yYCuxf+N/jtmWRhNJQWSJMFgDOXhIDaCMETXdX9F8O2WHvy7pu2BujHD6IWAsixB13XEcYymaZAkCeq6xoF+wK0sSzFXVXXytQOEA9srII/QMBBSZByUpqk4vN/vhe12OzEf4Xx9E8g4UCagIsM0TRyqIeUgACXzz8ody3IZ4ZRqOH6BzWyUWxKlBpIoETOvdTfU6ZbdjHD22Yb1wYL/1Uf9VKP70SH7lmH7fYt2+Tutc8CVxgPQtOd9yooqQ9VU5EUuNhzXQZyQQG1zAbkHPgKt+aIXRVF6e3VeqfU6RGEkBMqy7Cboz7SvgbIMTdMElCvJVfY8D4x6k6+Lorjbl+c17IFc5QGo6wZ830e0Wp2AKt0ki24Aj3hF/vV6fWon3rMXQHvBb4o89KEuDruuS4cy0To8cp1+pKoK3t58AU2otjX1aDvU93zMFw5GxszGwnFJiCU8P4AfUCRxSpbQFYwoWpojimxTIFvnJFZGvlj4Q/ILo/dNXuD51wTvcgwlZkESd4gAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ba808daf6d077886ceab59fc100ededd/8ac56/9.webp 240w,\n/static/ba808daf6d077886ceab59fc100ededd/d3be9/9.webp 480w,\n/static/ba808daf6d077886ceab59fc100ededd/e46b2/9.webp 960w,\n/static/ba808daf6d077886ceab59fc100ededd/e811e/9.webp 1060w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ba808daf6d077886ceab59fc100ededd/8ff5a/9.png 240w,\n/static/ba808daf6d077886ceab59fc100ededd/e85cb/9.png 480w,\n/static/ba808daf6d077886ceab59fc100ededd/d9199/9.png 960w,\n/static/ba808daf6d077886ceab59fc100ededd/77672/9.png 1060w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ba808daf6d077886ceab59fc100ededd/d9199/9.png\"\n            alt=\"image-20210426012153835\"\n            title=\"image-20210426012153835\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ここで、エクスプロイトを再実行すると、ブレークポイントに設定したカーネル関数が呼び出されたタイミングで、処理を停止し、デバッグモードに移行することが確認できました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 435px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/13d8e3584c97f3d3d31e279e410620e8/330eb/10.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.833333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfklEQVQI121OSwrFIBDz/tcqLgS9gC5dFfwWP12oeYzQRxcdCDMkIRlmjIG1Ftd14b5v1FrRe8fXrLU+7zfHpJQQQuA4DiilwDmH1hqtNYQQdgEZnwAqewppk06Yc26O0Wcppf0hwTmHnPPGeZ5beweSp5Tyv2OM8N5jjLG5H1VJ5rZKClI9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/13d8e3584c97f3d3d31e279e410620e8/8ac56/10.webp 240w,\n/static/13d8e3584c97f3d3d31e279e410620e8/267d1/10.webp 435w\"\n              sizes=\"(max-width: 435px) 100vw, 435px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/13d8e3584c97f3d3d31e279e410620e8/8ff5a/10.png 240w,\n/static/13d8e3584c97f3d3d31e279e410620e8/330eb/10.png 435w\"\n            sizes=\"(max-width: 435px) 100vw, 435px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/13d8e3584c97f3d3d31e279e410620e8/330eb/10.png\"\n            alt=\"image-20210426012304866\"\n            title=\"image-20210426012304866\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これで、WinDbgによるカーネルデバッグの準備は完了です。</p>\n<h3 id=\"悪用時の通信を追う\" style=\"position:relative;\"><a href=\"#%E6%82%AA%E7%94%A8%E6%99%82%E3%81%AE%E9%80%9A%E4%BF%A1%E3%82%92%E8%BF%BD%E3%81%86\" aria-label=\"悪用時の通信を追う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>悪用時の通信を追う</h3>\n<p>EternalBule攻撃時のメモリの動きを追う前に、どのような攻撃パケットが送り込まれているのか、通信の中身をのぞいてみようと思います。</p>\n<h3 id=\"攻撃サーバからのsmb通信\" style=\"position:relative;\"><a href=\"#%E6%94%BB%E6%92%83%E3%82%B5%E3%83%BC%E3%83%90%E3%81%8B%E3%82%89%E3%81%AEsmb%E9%80%9A%E4%BF%A1\" aria-label=\"攻撃サーバからのsmb通信 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>攻撃サーバからのSMB通信</h3>\n<p>意外なことに、攻撃サーバから送り込まれてきたSMBパケットは40件程度と少なかったので、まずはここから見ていきます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/974964402402b19c700fd2d08c29f598/0b533/11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAAB6ElEQVQoz2WSa3uaQBSE+f//px9agRitKF6SCEZBQG6KgspFkzSpaafnLOqTpB/mYVlm353ZRWpoJr61H6AMHNzeuWiS1KEDWbegDuY056FjRKQQmhmhP1tDnyXoTRPoHzWrJfleD5bdhW3r8FwdQTDEbNrB46SNdWJglz0iSyfY0rPYWyhyC2Vu41i5JAcHVumgKuZC0tQewHbvEcYTTO0hNpkDPzTEeJ3aiJMpfTPBPi8Yw3JG8CMTnj+md0P488JHdYxQHUJIbtCAFypI9x3MFz+QH3rX8b7qXeX4tc8NZPiximXaQvnUF/7ntxHeYeBEklwyBssmQTRaJKM49JHuOmKcVzqKY188vUBBuGoSUMFy3SKPJnR8GeHtfUxAE6e/JqQF7RrENzVw0SCgfgY2aHcd+7In5Pp1MgZzgOWmJTZiPb/enYEGA2VRJRMJvwB5waEWJ/NpY/bGlHCbd8X86+lBgBj4hyR5oSyM2afK2rVySZV3RVd4uPIiUgUwydpYbehP2P5E9TQQtX/9vqeEkYIouf0C/HyG21yjmjcCxlqlbXE5vJbnGcrJLfd7DQyvl/J/5SswroG8cEnJ5nTeNVSltB+AAR00V+GEbGDAZcxnxJW3VJk39c/QS0KG8EVdEtpeA/8ADWgQuFg1U/cAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/974964402402b19c700fd2d08c29f598/8ac56/11.webp 240w,\n/static/974964402402b19c700fd2d08c29f598/d3be9/11.webp 480w,\n/static/974964402402b19c700fd2d08c29f598/b0a15/11.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/974964402402b19c700fd2d08c29f598/8ff5a/11.png 240w,\n/static/974964402402b19c700fd2d08c29f598/e85cb/11.png 480w,\n/static/974964402402b19c700fd2d08c29f598/0b533/11.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/974964402402b19c700fd2d08c29f598/0b533/11.png\"\n            alt=\"image-20210426110622437\"\n            title=\"image-20210426110622437\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>まず着目したのは、攻撃サーバからの不審な<code class=\"language-text\">NT Trans Request</code>です。</p>\n<p>パケット情報を見ると、<code class=\"language-text\">Total Data Count</code>が<code class=\"language-text\">66512</code>に設定されています。\nそして、SMBヘッダー直後のデータが<code class=\"language-text\">0x00010000</code>に設定され、それ以降大量のデータが連続して送信されています。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a09cd3133aed7bfb6d7fcef81bd9f799/0b533/12.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAADOElEQVQ4y1VUS28TSRCeH7L8iNVy44B2BQhxQ2IltNKeYAEJ8foFK64clitawQESWAghARQggZV2EYrAiR17np4Z2/PweCZ+JI7tYCcz4/ijqu0EGOnT113V/VV1d9VIU6+zmP03h/n3Gp79J2Puf0WM59+r+OfNJ8yR7W3Ox1LWxeLqGEtZD0uT8eKKQ+yMbQSp2WigXHHg+T4c10WlUoHremLObBgGLNuG47hwPQ9F0xJryuWysNmlMkzLQqlUovUupKDqI5PJQNd1giY4v7aGQr4ARZahKirkQgG5bFZgjX00l8nH/tXVVeHnACXLhFRfj5DL5VAsFmGRwTRNMeYF1WoVURiKyK7jCLvPJ+ETUbZlyo6z9TwfQRCg0WxCqvqeiMiZsZhF6TMHQU2ARdvtLWxvb6NH6Ha76PV6B+gyuj10Oh0BaWd3FyuKhQ9ZA2tFD2a1BdNvwfbrCDcHqG300ejGaPYS4uSAo06C9W4q5i22Eepkl/r9AZqbHWy12+AHqtfrqDeaqIRtBJs7CNs7CDYG3yFqDyjjPtqdz/BbAwEO3tgaQDI0GflKC48ym5heXsdMpo7pj01cepHg18cxzs/H+G0mxrm5GBeexzj9MMYbM0HO7+PPxS5OTaU4ejfGSyMGQBlWyzoe5HZx+C5wbAr45cEYxwlH7gEnyPbzffLR/OQ08NPfwKwBXFwADt0GfrwD/PAX8EiF+CSvZOC13scfL4a48SrB1YUxrr9KcYFs14ivLKSCLy8McfPdAOWog1vLwJkne/h9boSzT0fIhiOSG0Hy6ZVdKlBV1aAQVFUV43xBFsVdoFrTNB0K1SP7dVVGFPjg7btxgjgdIk5S0tobZ1gLqqKudE2DoRsEnbqDBEiYfRygWJzYCRqtq9VCsTlNEuwNU6Qp8d5EkAuXi5ILtELCzBzAplbiF+eWchxn4h+3XJOqQAgOh0JoSDwajSaCUSiq36Z+5c22XRJsUs9GUSQKnUX27bZli0D8JZQhi6Vp+jXDsBaIDYqiiOPtc566hwNxF/Ex+Q6Fn+6UT/RVMBX8jWBNHIU36dr4jrgNZRLmtuMA/MfZt2t8t7Tnuwy/EfwCPHtus+t5UrMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a09cd3133aed7bfb6d7fcef81bd9f799/8ac56/12.webp 240w,\n/static/a09cd3133aed7bfb6d7fcef81bd9f799/d3be9/12.webp 480w,\n/static/a09cd3133aed7bfb6d7fcef81bd9f799/b0a15/12.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a09cd3133aed7bfb6d7fcef81bd9f799/8ff5a/12.png 240w,\n/static/a09cd3133aed7bfb6d7fcef81bd9f799/e85cb/12.png 480w,\n/static/a09cd3133aed7bfb6d7fcef81bd9f799/0b533/12.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a09cd3133aed7bfb6d7fcef81bd9f799/0b533/12.png\"\n            alt=\"image-20210426132307955\"\n            title=\"image-20210426132307955\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>この値、<code class=\"language-text\">0x00010000</code>は、EternalBlueが悪用するバッファオーバーフロー脆弱性のポイントになる<code class=\"language-text\">SizeOfListInBytes</code>であり、それ以降の空のデータは加工されたFEAリストのようです。</p>\n<p>この<code class=\"language-text\">SizeOfListInBytes</code>の情報から、SMB ドライバが FEA リストを NTFEA リストに変換する際に必要なメモリのバッファ領域を確保します。</p>\n<p>このバッファ領域の確保のために、脆弱性を持つ<code class=\"language-text\">srv!SrvOs2FeaListSizeToNt</code>が呼び出されるようです。</p>\n<p>参考：<a href=\"https://www.virusbulletin.com/virusbulletin/2018/06/eternalblue-prominent-threat-actor-20172018/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Virus Bulletin :: EternalBlue: a prominent threat actor of 2017–2018</a></p>\n<p>次に、<code class=\"language-text\">Total Data Count</code>が<code class=\"language-text\">4096</code>である <code class=\"language-text\">Trans2 Secondary Request</code>が15回連続で送信されています。</p>\n<p>これ、最初は何をしているのかさっぱりわからなかったのですが、どうやら脆弱性の悪用のために、先ほどの空のFEAレコードを605個送ったあと、加工された<code class=\"language-text\">0xf383 + 5</code>の大きさの606個目のFEAレコードと、<code class=\"language-text\">0xa8 + 5</code>の大きさの607個目のFEAレコードを送付する必要があるようです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2fc24e6c5efcd6d642ff74c27fc92ad1/0b533/13.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAARlAAAEZQAGA43XUAAACAklEQVQ4y6WS6W7bMBCE9f5vVKcOiiIBkqDxKVkXdd+yZJ2+j8mSDoL8aN0AETDYlcj9tLOklOUKTPaCNFOg6U+IExlJModKeZYv6H0G3x/Dcl5hkxx3BMcbIQiniOIZeH1IMaKarrch1e0LTOcOq+YZhjVAWjygolxjA5T1E1btM7LiEbY3hOUOKd7DDe6h017T+Yko/Q3TvoPtD3E4TyFVVMBogUfDHiArH0XOC8rmCkyXDwIo5N+LYo39gEGNBPEv0YgAXgjoeguySpZssqmNoBsTmOYUsvIHzJrBMOmdTcWasniFpo3JOo3JmoPZMu2haMk0AgNVHUKymA1ZVqAoKlRVJxjDYqFBo1zXDfHNcVzk2RJZlqOuW/T95l3rD3XdGm3bQ/J9jwp1GryPNE2wWq2w3W6xXq+FNptr3O93pD12u51Y/5t2uy0knriuizAMBex8PuM7j3Q4HGBbFkE9slPjcrl8S9KeLDDGRIe82688N4Gn0wkBzS/LMjR1g67thNq2pUF36Ltr3jSNcND3/W3LRVEgz5dIk1RA0zRFHCd0qjn9KBAnXBSlALUE7yj+61C4JF4UBCE8mmEcxQgp5/PMCKyqKibjCaqq+q/VD8tRGIHLpU6id6D3CTj+BPzSKbuOA9/zBUjYjSIB5CPg93M+m6MsS3Gd+I04Ho839QY/8hxliSD5CAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2fc24e6c5efcd6d642ff74c27fc92ad1/8ac56/13.webp 240w,\n/static/2fc24e6c5efcd6d642ff74c27fc92ad1/d3be9/13.webp 480w,\n/static/2fc24e6c5efcd6d642ff74c27fc92ad1/b0a15/13.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2fc24e6c5efcd6d642ff74c27fc92ad1/8ff5a/13.png 240w,\n/static/2fc24e6c5efcd6d642ff74c27fc92ad1/e85cb/13.png 480w,\n/static/2fc24e6c5efcd6d642ff74c27fc92ad1/0b533/13.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2fc24e6c5efcd6d642ff74c27fc92ad1/0b533/13.png\"\n            alt=\"image-20210426133625120\"\n            title=\"image-20210426133625120\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>606個目のFEAレコードと、607個目のFEAレコードのサイズを合計すると、10進数で<code class=\"language-text\">62517</code>となり、ちょうど<code class=\"language-text\">4096</code>バイトのパケット15個分になりました。</p>\n<p>ここで、607個目のFEAレコードが送信された時点で、<code class=\"language-text\">SizeOfListInBytes</code>で指定した<code class=\"language-text\">0x10000</code>の領域を超えて、次のメモリ領域である「SRVNET.sys」のプールを上書きすることでバッファオーバーフローが成立する流れのようです。</p>\n<h3 id=\"バッファオーバーフロー時のカーネルデバッグ\" style=\"position:relative;\"><a href=\"#%E3%83%90%E3%83%83%E3%83%95%E3%82%A1%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E3%83%95%E3%83%AD%E3%83%BC%E6%99%82%E3%81%AE%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0\" aria-label=\"バッファオーバーフロー時のカーネルデバッグ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>バッファオーバーフロー時のカーネルデバッグ</h3>\n<p>では最後に、この607個目のレコードの送付によって、SRVNET バッファと SRVNET の一部が上書きされるところをカーネルデバッグで観察してみたいと思います。</p>\n<p>ブレークポイントは、こんな感じで設定してみました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">bp srv!SrvOs2FeaToNt+04d “.printf \\”MOV2: dst: %p src: %p size:%p\\\\n\\”,ebx,eax,poi(esp+8);g;”\n\nbp srv!SrvOs2FeaListToNt+0xd4</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 731px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/636594634d60c56de83b1ea595690504/6e9ba/14.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 117.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAADmklEQVQ4y3VVy5LiRhDk/7/BXh88V0f45ItPPjjCs8OsACEhoUEvHpKQEOI5wAzkVhZulvGuO6KiW/3IrqzKarWsQYQvYpaXoO2EOn7qj6SP4Ua52iDO4SWFmp/O9dusdfwUj70h2nLmz78+o9Xr9dDtdNBuP2nf7XbwEgTY7baoyhKLRYXZbIrh0Mfo5QW9XhfhaKTz69UKeTZDFIYYj1NkMm45jgvP8wSoC9/38SKHFosF2JbLJTabDfKiQCCXpGmKMIwwmUwwl8vW6zXKstJ9RTEXJ/Zo9QXQcRxYloV+v68Hd7udAs7nczRNI5sLRFGkPefYE2y/3+s6ra5rbLdbAew7cN1vgLZtYySUDNBKaLHnfCle5XmuDlRVpd/suZesFov6DlDi57quUn9+ftYNpcbw2ndkPY5jiVOmgBwzPPxmWHgxgVu2ACrlfwE5Ji02AjE+PMSL6KUBIUXSJpABVMo3QKFsPEySRAFJhxt5wXA4lGzP9PDhcMDb2xvO5zNOp5Pa8XjUOU3KYDBQSuyZcQIZQBpjyDUaL2WW6T0vM3Esily/b1kmIGVDD0nTZPneQ3pHBZAaM0yvXl9fdWzWJCkuXAHtWALo+drHUfwthvVSewKummu8DAiN4AQ2rWVLhh3PwZeuBS8Qgfe72quH9RzTfIq8ynXPOBsjnaQaS4IylveA5/MFrfAhxvjnMcKfQkx+mSD+FKP+rQb+kEr5dYnmocHyYYn0U4rD7wecHk84nA7A5eYULpeLJuhdrOU+evD+8WD/bSNoB/A/+9jNpFLWkpRARBs1KIMS/pOPbJAhH+W32DJm1B7lw7gzBC17IMIeurB6ltLieL1f3yg32wZZmcH1XVSN1O1qedMgaTOmH3R4TYqjyWByHNFlMAyUUlXyRVmjyAt5YUKkSaqiZsyovff3d9UezWhRZUNtUTaUD40ZZUxYdqamWSWUFdcofHplqBrjBd9VCscEMTo0pUcwftN4EWkT1IBxbrP5QenRUz5hRoeMDWViKoWVRAAmxMiG481GnjOJ6e21IRA38xA9IuV7QF7GeT5fpMx5UiSoqZjj8XT1kJvpIWnxl8Dni7eat44x5IV8safT6e1t/G8TOX5MCnuCkgYbvSE94+n3AJcPppXSl/i5t1+ALdJIdPEKmAlgrQk43dXr/zcCDoawHalh20GvP0CUjDHNCrVgFGMUJRhPM6nhDJNZ/kPjelXLi73e4SvLVu4EGdNPBgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/636594634d60c56de83b1ea595690504/8ac56/14.webp 240w,\n/static/636594634d60c56de83b1ea595690504/d3be9/14.webp 480w,\n/static/636594634d60c56de83b1ea595690504/feeb6/14.webp 731w\"\n              sizes=\"(max-width: 731px) 100vw, 731px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/636594634d60c56de83b1ea595690504/8ff5a/14.png 240w,\n/static/636594634d60c56de83b1ea595690504/e85cb/14.png 480w,\n/static/636594634d60c56de83b1ea595690504/6e9ba/14.png 731w\"\n            sizes=\"(max-width: 731px) 100vw, 731px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/636594634d60c56de83b1ea595690504/6e9ba/14.png\"\n            alt=\"image-20210426140721254\"\n            title=\"image-20210426140721254\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ブレークポイントで止まるタイミングで<code class=\"language-text\">dd</code>コマンドを使ってメモリの中身をのぞいてみると、0で埋まっています。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 585px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/53dde56dfccad24b8757a2be2d2a667f/78a22/15.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABFElEQVQoz21S6cqDQBDz/Z/Mo160VevV21att6A/pCkZEL5+dGFQM5lsNquy3+/RdZ3U6/XC7XbD9XpFlmV4PB5o2xbP5xOn00nqeDyiKArhlWWJ8/mMy+WCNE3R9z0Uy7Kw2+1wOBwQhqE0OEgiB+Z5FlFuVlWVYMMwCEYTxOq6lv40TVAoRpee58E0TXm6rivPpmnAxcFlWTCOo2Acpktu9n8pvu+LYBRFIkiHdOs4jhyP4kEQSNm2jSRJBCOH6/1+f5WyOiJB0zTJL45jqKoqIoZhYLvdSizsk7fZbOT7pyDd/RVkwHSr67pkug6TR3FiazSr4NeReZv3+x15nstFMGTmw4tZMXJYfGePp+Af8MvhB4kgAsbZPv3DAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/53dde56dfccad24b8757a2be2d2a667f/8ac56/15.webp 240w,\n/static/53dde56dfccad24b8757a2be2d2a667f/d3be9/15.webp 480w,\n/static/53dde56dfccad24b8757a2be2d2a667f/737f1/15.webp 585w\"\n              sizes=\"(max-width: 585px) 100vw, 585px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/53dde56dfccad24b8757a2be2d2a667f/8ff5a/15.png 240w,\n/static/53dde56dfccad24b8757a2be2d2a667f/e85cb/15.png 480w,\n/static/53dde56dfccad24b8757a2be2d2a667f/78a22/15.png 585w\"\n            sizes=\"(max-width: 585px) 100vw, 585px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/53dde56dfccad24b8757a2be2d2a667f/78a22/15.png\"\n            alt=\"image-20210426143302073\"\n            title=\"image-20210426143302073\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>アドレスの番地も+5ずつ増えていることから、これが空のFEAレコードで埋められている部分と考えてよさそうです（多分）</p>\n<p>これが605回続くと結構大変なので、一旦<code class=\"language-text\">srv!SrvOs2FeaListToNt+0xd4</code>のブレークポイントを解除して、関数終了前の<code class=\"language-text\">srv!SrvOs2FeaListToNt+0x120</code>に設定しなおしました。</p>\n<p>そのまま最後までエクスプロイトを実行させたあと607回上記の処理が実行されたことを確認し、出力結果を取得しました。</p>\n<p>最終的に607回目のレコードが<code class=\"language-text\">fffffa8001c9b000</code>という、ひとつ前のアドレスに<code class=\"language-text\">0xf383 + 0x5 + 0x5</code>した値からコピーされており、ここから607個目のFEAによるオーバーフローが実行されていそうです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7fe0a0744ddaf8ff96b04e1e636f1c16/0b533/16.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.249999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAARlAAAEZQAGA43XUAAAAvklEQVQI1x2ObW6DMBAFOU2EAduYNhgTTAAnATWqkn6oitr7n2O67Y8nPWmfZifbFQVl80ToPMYabF0TQs88TwxxwDlHUZakU2LdLpKNaV6wxhCXM68fD96+vrl9PjC1I9vJWEnx7f4fWGnNvvWMY6Q/9LjGoeTpcRpJaWFJiRhHrGyH+cT1/Q/4w12g1jVkqqrItaFxNZV0pZRYNXRi7H1LLcZ5nhP6IMYHSZRbh9YVzz5wTCvn7UpaX9DG8gsxUmPlPFFnhAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7fe0a0744ddaf8ff96b04e1e636f1c16/8ac56/16.webp 240w,\n/static/7fe0a0744ddaf8ff96b04e1e636f1c16/d3be9/16.webp 480w,\n/static/7fe0a0744ddaf8ff96b04e1e636f1c16/b0a15/16.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7fe0a0744ddaf8ff96b04e1e636f1c16/8ff5a/16.png 240w,\n/static/7fe0a0744ddaf8ff96b04e1e636f1c16/e85cb/16.png 480w,\n/static/7fe0a0744ddaf8ff96b04e1e636f1c16/0b533/16.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7fe0a0744ddaf8ff96b04e1e636f1c16/0b533/16.png\"\n            alt=\"image-20210426175537572\"\n            title=\"image-20210426175537572\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>最後にこのアドレスから<code class=\"language-text\">+a8</code>内のメモリ情報を出力することで、オーバーフローによるエクスプロイトが成功したことを確認したかったのですが、いかんせんバイナリ列を見ても上書きが成功しているかどうかの判断がつかず、断念しました。。。</p>\n<p>そのうちカーネルデバッグの知識が身についてから再トライしようと思います。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回は、「EternalBlue」の再現を通して、脆弱性の詳細と悪用方法について学ぶことを目的に色々検証した結果についてまとめました。</p>\n<p>Windowsのカーネルデバッグについては全くの初めてだったこともあり、手探りで進めたため結構時間がかかりました。</p>\n<p>HackTheBoxのマシンを攻略するだけでなく、そこで利用した脆弱性について深堀りしてみることは非常に学びになるなと思います。</p>\n<p>特に今回テーマにした「EternalBlue」は、MetasploitやExploitDBのコードを使うと簡単に再現できてしまうため、マシン攻略としての難易度は非常に低いのですが、脆弱性の詳細をちゃんと理解することは結構難しいと感じました。</p>\n<p>脆弱性の深堀り記事は今後も書いていきたいと思います。\n通信プロトコル系はまだちょっと難しいということを改めて実感したので、もっとライトに検証できるOSSなどから攻めてみようかと感じています。</p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<h3 id=\"book\" style=\"position:relative;\"><a href=\"#book\" aria-label=\"book permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Book</h3>\n<ul>\n<li><a href=\"https://amzn.to/3nuJxo5\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">インサイド Windows 第7版</a></li>\n<li><a href=\"https://amzn.to/2RTn9J1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Windows Sysinternals徹底解説</a></li>\n</ul>\n<h3 id=\"web\" style=\"position:relative;\"><a href=\"#web\" aria-label=\"web permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Web</h3>\n<ul>\n<li><a href=\"https://blog.trendmicro.co.jp/archives/15154\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">トレンドマイクロ セキュリティブログ「WannaCry」を拡散させた脆弱性攻撃「EternalBlue」の仕組みを解説 | トレンドマイクロ セキュリティブログ</a></li>\n<li><a href=\"https://www.welivesecurity.com/2018/05/10/one-year-later-eternalblue-exploit-wannacryptor/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">One year later: EternalBlue exploit more popular now than during WannaCryptor outbreak | WeLiveSecurity</a></li>\n<li><a href=\"https://docs.microsoft.com/ja-jp/security-updates/securitybulletins/2017/ms17-010\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">マイクロソフト セキュリティ情報 MS17-010 - 緊急 | Microsoft Docs</a></li>\n<li><a href=\"https://japan.zdnet.com/article/35137511/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NSAから流出のハッキングツール、米都市への攻撃に悪用の可能性 - ZDNet Japan</a></li>\n<li><a href=\"https://msrc-blog.microsoft.com/2017/04/14/protecting-customers-and-evaluating-risk/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Protecting customers and evaluating risk – Microsoft Security Response Center</a></li>\n<li><a href=\"https://www.kaspersky.co.jp/resource-center/threats/ransomware-wannacry\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ランサムウェア「WannaCry」 のすべて | カスペルスキー</a></li>\n<li><a href=\"https://monoist.atmarkit.co.jp/mn/articles/1807/04/news042.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">日立は「WannaCry」被害から何を学んだのか、IoTセキュリティサービスに昇華：IoTセキュリティ（1/2 ページ） - MONOist</a></li>\n<li><a href=\"https://press.avast.com/ja-jp/avast-wannacry\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Avast Press | Avast、WannaCry騒動から1年経っても 日本の約10％のPCが引き続き感染のリスクに さらされていることを公表</a></li>\n<li><a href=\"https://www.exploit-db.com/exploits/42315\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Microsoft Windows 7/8.1/2008 R2/2012 R2/2016 R2 - ‘EternalBlue’ SMB Remote Code Execution (MS17-010) - Windows remote Exploit</a></li>\n<li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/debugger-download-tools\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Download Debugging Tools for Windows - WinDbg - Windows drivers | Microsoft Docs</a></li>\n<li><a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-#kernelmodedebuggingcommandsandtechniques\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Windows ドライバーのデバッグ-ステップバイステップラボ (Echo カーネルモード) - Windows drivers | Microsoft Docs</a></li>\n<li><a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/u--unassemble-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">u, ub, uu (Unassemble) - Windows drivers | Microsoft Docs</a></li>\n<li><a href=\"https://tex2e.github.io/rfc-translater/html/rfc8276.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RFC 8276 - File System Extended Attributes in NFSv4 日本語訳</a></li>\n<li><a href=\"https://ja.wikipedia.org/wiki/%E6%8B%A1%E5%BC%B5%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%B1%9E%E6%80%A7\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">拡張ファイル属性 - Wikipedia</a></li>\n<li><a href=\"https://medium.com/@singhavijeet1994/eternal-series-part-1-eternal-blue-and-analysis-windows-7-and-8-1-c631572e549b\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Eternal Series — Part 1 | Eternal Blue and Analysis | Windows 7 and 8.1 Exploitation | Hack Windows 7 and 8.1 Remotely | by Abhijeet Singh | Medium</a></li>\n<li><a href=\"https://ja.wikipedia.org/wiki/Server_Message_Block\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Server Message Block - Wikipedia</a></li>\n<li><a href=\"https://www.atmarkit.co.jp/ait/articles/1507/02/news026.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">第7回　ファイル共有プロトコルSMBの概要：Windowsネットワークの基礎 - ＠IT</a></li>\n<li><a href=\"https://docs.oracle.com/cd/E19253-01/820-5121/gfhaq/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SMB プロトコルの説明</a></li>\n<li><a href=\"https://www.exploit-db.com/exploits/42315\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Microsoft Windows 7/8.1/2008 R2/2012 R2/2016 R2 - ‘EternalBlue’ SMB Remote Code Execution (MS17-010) - Windows remote Exploit</a></li>\n<li><a href=\"https://github.com/worawit/MS17-010/blob/master/mysmb.py\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MS17-010/mysmb.py at master · worawit/MS17-010</a></li>\n<li><a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Windows ドライバーのデバッグ-ステップバイステップラボ (Echo カーネルモード) - Windows drivers | Microsoft Docs</a></li>\n<li><a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/disassembly-window\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">WinDbg でのアセンブリ コードのデバッグ - Windows drivers | Microsoft Docs</a></li>\n<li><a href=\"https://research.checkpoint.com/2017/eternalblue-everything-know/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">EternalBlue – Everything There Is To Know</a></li>\n<li><a href=\"https://www.virusbulletin.com/virusbulletin/2018/06/eternalblue-prominent-threat-actor-20172018/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Virus Bulletin :: EternalBlue: a prominent threat actor of 2017–2018</a></li>\n</ul>","fields":{"slug":"/hackthebox-windows-blue","tagSlugs":["/tag/hack-the-box/","/tag/windows/","/tag/easy-box/"]},"frontmatter":{"date":"2021-10-04","description":"HackTheBox の Retired Machine [Blue] を通して、 について学びます。","tags":["HackTheBox","Windows","EasyBox"],"title":"HackTheBox 「Blue」で学ぶ EternalBlue 脆弱性","socialImage":{"publicURL":"/static/dc4d8b7f8795f3c3d3489d9957d155f2/no-image.png"}}}},"pageContext":{"slug":"/hackthebox-windows-blue"}},"staticQueryHashes":["251939775","401334301","825871152"]}