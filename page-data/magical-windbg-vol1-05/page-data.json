{"componentChunkName":"component---src-templates-post-template-js","path":"/magical-windbg-vol1-05","result":{"data":{"markdownRemark":{"id":"debc3b66-c80b-58d1-b1e8-f2610bc8599f","html":"<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%AF%E3%83%A9%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E7%99%BA%E7%94%9F%E3%81%95%E3%81%9B%E3%81%A6%E3%83%95%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\">システムクラッシュを発生させてフルメモリダンプを作成する</a></li>\n<li><a href=\"#%E3%83%95%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92-windbg-%E3%81%A7%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B\">フルメモリダンプを WinDbg でロードする</a></li>\n<li><a href=\"#analyze-%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD%E3%81%A7%E3%82%AF%E3%83%A9%E3%83%83%E3%82%B7%E3%83%A5%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%88%86%E6%9E%90%E3%81%99%E3%82%8B\">!analyze 拡張機能でクラッシュダンプを分析する</a></li>\n<li><a href=\"#%E3%82%AF%E3%83%A9%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E7%99%BA%E7%94%9F%E3%81%95%E3%81%9B%E3%81%9F%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\">クラッシュを発生させたプロセスを特定する</a></li>\n<li><a href=\"#%E3%82%AF%E3%83%A9%E3%83%83%E3%82%B7%E3%83%A5%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%9F%E5%89%8D%E5%BE%8C%E3%81%AE%E5%91%BD%E4%BB%A4%E3%82%92%E8%AA%AD%E3%82%80\">クラッシュが発生した前後の命令を読む</a></li>\n<li><a href=\"#windbg-%E3%81%A7-iatimport-address-table-%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\">WinDbg で IAT(Import Address Table) を解析する</a></li>\n<li><a href=\"#5-%E7%AB%A0%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81\">5 章のまとめ</a></li>\n<li><a href=\"#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF\">各章へのリンク</a></li>\n</ul>\n<p>4 章ではシンプルなアプリケーションのクラッシュダンプを解析しました。</p>\n<p>続く 5 章では、シンプルなシステムクラッシュ発生時に取得したフルメモリダンプの解析を行います。</p>\n<h2 id=\"システムクラッシュを発生させてフルメモリダンプを作成する\" style=\"position:relative;\"><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%AF%E3%83%A9%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E7%99%BA%E7%94%9F%E3%81%95%E3%81%9B%E3%81%A6%E3%83%95%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\" aria-label=\"システムクラッシュを発生させてフルメモリダンプを作成する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>システムクラッシュを発生させてフルメモリダンプを作成する</h2>\n<p>4 章で確認した通り、ユーザーモードで稼働するアプリケーションの処理内で例外が発生した際には、アプリケーションのクラッシュが発生し、アプリケーションクラッシュダンプが生成されました。</p>\n<p>上記と同じように、カーネルモードで動作するシステムプロセス内で例外が発生した場合は、BSOD(Blue screen of death) と呼ばれるシステムクラッシュが発生し、システムクラッシュダンプが生成されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aed56d2ac06acaecdc7941c14636d092/0b533/fulldump-003.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABZUlEQVQoz41S2U4CQRBcXxARF8EDwXjFC2OIiQ/GaHzwm4AlgiKigOAVj+iXufeun1J2zyywIQZ5qO2Z7p6artpRlPI3FC2EIqE0BC2If9V69bIuo1IykL6xBRbrNvKPHnIdF/tdT+wzDZnfbLs4eHax0rSw0bax9+BgrWVjt+sgUTMlMZMqmo7MrYV1Kp5++Dh+83Hy7mO742Dr3kGODuzQ+vzrB4cvHo5ePZx9+sg/uaKuElmkog+mZMnxSwMzVwaydxY1GEhem4hRbqpqIFqVtVTdFHuuzdGac5MVY2BVXzJ9eMLVpo15ahQ+FYY8KoZQCFAc8lQLEfKEfHOCblUJyZqcIFqR0/FEKvXEA0yzIo5VuY9R7JMyIZOx3GXCUsOiH2SKOFuTh1k++8Ty+TBL71nCkfNSuvBQR4oIF4gkS9LTDSY1hfzIhY4J9qYUelajnk05kDyysd/8D8ITjtU8Th/hFw2O1/mgLvuiAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/aed56d2ac06acaecdc7941c14636d092/8ac56/fulldump-003.webp 240w,\n/static/aed56d2ac06acaecdc7941c14636d092/d3be9/fulldump-003.webp 480w,\n/static/aed56d2ac06acaecdc7941c14636d092/b0a15/fulldump-003.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/aed56d2ac06acaecdc7941c14636d092/8ff5a/fulldump-003.png 240w,\n/static/aed56d2ac06acaecdc7941c14636d092/e85cb/fulldump-003.png 480w,\n/static/aed56d2ac06acaecdc7941c14636d092/0b533/fulldump-003.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/aed56d2ac06acaecdc7941c14636d092/0b533/fulldump-003.png\"\n            alt=\"一般的な BSOD 画面\"\n            title=\"一般的な BSOD 画面\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>生成できるシステムクラッシュダンプにはいくつかの種類がありますが、今回取得するフルメモリダンプには、その端末で稼働する Windows システムがアクセス可能なすべての物理メモリ内のページ情報が全て含まれます。</p>\n<p>フルメモリダンプは Windows の既定の設定では生成されませんが、本書の 1 章の手順でダンプファイルの取得設定を行っている環境の場合には、すでにフルメモリダンプの取得設定が完了しています。</p>\n<p>そのため、D4C.exe を使用して解析用のフルメモリダンプの取得を行います。</p>\n<p>まずは、1 章でダウンロードした D4C.exe を実行し、プロンプトに表示されるメニューで 3 を入力して Enter キーで実行します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/895194835e2bf33b1f9a1d952955a1c1/0b533/system-crash-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABIUlEQVQoz53SzU6DQBAH8AWXYneXz2BBo8GEUnwFYy9G5ODZl9LE2KRNtWptjyYmvuLfATS2aYro4ZcZlpnZXQIbjSe4ubvHLRmNp3h8nuOBzF5e8TRfkOVX3GZJtQtMpjO8vX+AHUQRojCs7FMe9noIggCuY6NjGNB1DTu63kCDwTkYYxgOz8DSfh9pOkCSJMiyrFLmIW2glIJt27CsZo7jwKDNi6IA81wXnu/D8zz4FMuXlmVBCFENbKOs53TKPM/BJDVKKdd8F67mrQeqLU1th22eULa/2p8GVtdVtep5Jf5mfWDZRAtS/Z9FfwLnBg28pG9oGlC7Jum0YG7qmrBFF1xjKC7OwUScQRyf1OImVHdUGvw4rCla53sxTq+u8QndXiVen2BFKwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/895194835e2bf33b1f9a1d952955a1c1/8ac56/system-crash-001.webp 240w,\n/static/895194835e2bf33b1f9a1d952955a1c1/d3be9/system-crash-001.webp 480w,\n/static/895194835e2bf33b1f9a1d952955a1c1/b0a15/system-crash-001.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/895194835e2bf33b1f9a1d952955a1c1/8ff5a/system-crash-001.png 240w,\n/static/895194835e2bf33b1f9a1d952955a1c1/e85cb/system-crash-001.png 480w,\n/static/895194835e2bf33b1f9a1d952955a1c1/0b533/system-crash-001.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/895194835e2bf33b1f9a1d952955a1c1/0b533/system-crash-001.png\"\n            alt=\"D4C.exe でシステムクラッシュを発生させる\"\n            title=\"D4C.exe でシステムクラッシュを発生させる\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>D4C.exe の 3 番の操作を実行すると、システムクラッシュが発生して自動的に端末が再起動します。</p>\n<p>システムの再起動後、<code class=\"language-text\">C:\\Windows</code> フォルダの直下に FULL_MEMORY.DMP というファイルが生成されていれば、フルメモリダンプの取得は完了です。</p>\n<h2 id=\"フルメモリダンプを-windbg-でロードする\" style=\"position:relative;\"><a href=\"#%E3%83%95%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92-windbg-%E3%81%A7%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B\" aria-label=\"フルメモリダンプを windbg でロードする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>フルメモリダンプを WinDbg でロードする</h2>\n<p>フルメモリダンプの解析を行う場合も、アプリケーションクラッシュダンプの際と同じく、管理者権限で起動した 64 bit 用の WinDbg でショートカットキー [Ctrl + D] を使用して、このフォルダの中から取得したダンプファイルをロードします。</p>\n<p>ロードが完了し、<code class=\"language-text\">For analysis of this file, run !analyze -v</code> というメッセージが表示されたらロードは完了です。(フルメモリダンプのファイルサイズによってはロードに少々時間がかかる場合があります。)</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bf0f8ecb264f0eb81cf72ac1ff52fc71/0b533/system-crash-002.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABhklEQVQoz42S607CQBCFef8X8qeCGC9RUAohYGsBu92lLbdyKba0x5mRoiIaNzmZdLb7zZnZrZzVn3DxYKP2+IKLhkOyUW2+kBzKuaLLJ1f26tYQV9boT1Vsx0EUjjGJQmhfwWgfvvIoF0jOGA3lvcr3f1bFcQcYjw08T1EMEIYhPKXg+z4USWuD4XCI2Wz2K6QoWIWoYnW65EhhtVqJlsulxCAIEEURFRlD0f52uxUlSSJxs0lIG1Ge53swAc+rNXTabfR6Pbiui9FoJBBxSKDBYACHxmKMkTwXYuB6vT6Y2O12n8Dbu3s89/vodrsCtG0brVYLfcpZliVi+Hw+R5qmohLwve3iY4ZX1zdoNhrigiHskGfGTljsajqdSvtxHIsjbruElDo49HyNeLEgBwsZPLdTuih/5hmVh44d/bhl5Ru5CIZx9UPFIhcQg7/GY0fHYHqHrrw1rTXNSssTWq7WiDcZkrfsW1vHsJMOJ9M5Vc+QZhmyvd7SDHGyQ5LmJw/+BuP1DupDRYTagIAoAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/bf0f8ecb264f0eb81cf72ac1ff52fc71/8ac56/system-crash-002.webp 240w,\n/static/bf0f8ecb264f0eb81cf72ac1ff52fc71/d3be9/system-crash-002.webp 480w,\n/static/bf0f8ecb264f0eb81cf72ac1ff52fc71/b0a15/system-crash-002.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/bf0f8ecb264f0eb81cf72ac1ff52fc71/8ff5a/system-crash-002.png 240w,\n/static/bf0f8ecb264f0eb81cf72ac1ff52fc71/e85cb/system-crash-002.png 480w,\n/static/bf0f8ecb264f0eb81cf72ac1ff52fc71/0b533/system-crash-002.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/bf0f8ecb264f0eb81cf72ac1ff52fc71/0b533/system-crash-002.png\"\n            alt=\"フルメモリダンプを WinDbg にロードする\"\n            title=\"フルメモリダンプを WinDbg にロードする\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"analyze-拡張機能でクラッシュダンプを分析する\" style=\"position:relative;\"><a href=\"#analyze-%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD%E3%81%A7%E3%82%AF%E3%83%A9%E3%83%83%E3%82%B7%E3%83%A5%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%88%86%E6%9E%90%E3%81%99%E3%82%8B\" aria-label=\"analyze 拡張機能でクラッシュダンプを分析する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>!analyze 拡張機能でクラッシュダンプを分析する</h2>\n<p>システムクラッシュに関する調査を行う場合も、アプリケーションクラッシュダンプの調査の際と同じく <code class=\"language-text\">!analyze -v</code> コマンドが非常に役に立ちます。</p>\n<p>そのため、Command ウインドウで <code class=\"language-text\">!analyze -v</code> コマンドを実行した際の出力を順番に確認していきます。</p>\n<p>最初のセクションには、以下のように <code class=\"language-text\">.bugcheck</code> コマンドで取得できるバグチェックデータ<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>の解析結果が表示されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">CRITICAL_PROCESS_DIED (ef)\n        A critical system process died\nArguments:\nArg1: ffffc18f36303080, Process object or thread object\nArg2: 0000000000000000, If this is 0, a process died. If this is 1, a thread died.\nArg3: 0000000000000000, The process object that initiated the termination.\nArg4: 0000000000000000</code></pre></div>\n<p>上記の出力結果を参照すると、システムクラッシュの発生原因が <code class=\"language-text\">CRITICAL_PROCESS_DIED</code> であることがわかります。</p>\n<p>実際に <code class=\"language-text\">.bugcheck</code> コマンドを WinDbg で実行してみると、以下の出力を得ることができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">6: kd> .bugcheck\nBugcheck code 000000EF\nArguments ffffc18f`36303080 00000000`00000000 00000000`00000000 00000000`00000000</code></pre></div>\n<p>Windows のバグチェックコードは以下の公式ドキュメントで公開されています。</p>\n<p>このリファレンス内で <code class=\"language-text\">000000EF</code> の値を探してみると、<code class=\"language-text\">!analyze -v</code> コマンドで表示された <code class=\"language-text\">CRITICAL_PROCESS_DIED</code> のバグチェックコードと一致していることがわかります。</p>\n<p>また、<code class=\"language-text\">!analyze -v</code> コマンドの出力結果は、<code class=\"language-text\">!analyze -show &lt;バグチェックコード> &lt;Arg1></code> コマンドでバグチェックの解析を行った場合と同等です。</p>\n<br>\n<p>バグチェックコード:</p>\n<p><a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/bug-check-code-reference2#bug-check-codes\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/bug-check-code-reference2#bug-check-codes</a></p>\n<br>\n<p>これらのコマンドの出力結果から、システムクラッシュの原因が Windows の重要なシステムプロセスが終了したことによる <code class=\"language-text\">CRITICAL_PROCESS_DIED(0xef)</code> であることがわかります。</p>\n<p>では、Windows の重要なシステムプロセスとは何を指すのでしょうか。</p>\n<p>Windows の重要なシステムプロセスとは、csrss.exe、wininit.exe、logonui.exe、smss.exe、services.exe、conhost.exe、winlogon.exe などのシステム組込みのプロセスが該当します。</p>\n<br>\n<p>バグチェック 0xEF: <code class=\"language-text\">CRITICAL_PROCESS_DIED</code></p>\n<p><a href=\"https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0xef--critical-process-died\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0xef—critical-process-died</a></p>\n<br>\n<p>さらに、Arg2 の値が 0 であることから、例外の発生原因はスレッドではなくプロセスの終了であることと、停止したプロセスオブジェクトの実態が 0xffffc18f36303080 に存在していることがわかります。</p>\n<p>実際にこのアドレスに存在する EPROCESS 構造体が管理する情報を参照してみると、停止したシステムプロセスは PID が 0x3bc の svchost.exe であることを特定できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">6: kd> !process ffffc18f`36303080 0\nPROCESS ffffc18f36303080\n    SessionId: 0  Cid: 02dc    Peb: 27dedd6000  ParentCid: 03bc\n    DirBase: 7fbd5002  ObjectTable: ffffe50cc9052800  HandleCount: 1465.\n    Image: svchost.exe\n\n6: kd> dt nt!_EPROCESS 0xffffc18f`36303080\n   {{ 省略 }}\n   +0x440 UniqueProcessId  : 0x00000000`000002dc Void\n   +0x5a8 ImageFileName    : [15]  \"svchost.exe\"\n   {{ 省略 }}</code></pre></div>\n<p>以上のように、<code class=\"language-text\">!analyze -v</code> コマンドで参照できる最初の出力からバグチェックの解析を行うだけで、システムクラッシュの原因に大きく迫ることができました。</p>\n<p>このまま次のセクションを見ていきます。</p>\n<p>バグチェック解析の次のセクションにも非常に興味深い情報が出力されており、 <code class=\"language-text\">CriticalProcessDied.Process</code> の情報からも、クラッシュ対象のプロセスが svchost.exe であることがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Debugging Details:\n------------------\n\nKEY_VALUES_STRING: 1\n\n    Key  : Analysis.CPU.mSec\n    Value: 3765\n\n    Key  : Analysis.DebugAnalysisManager\n    Value: Create\n\n    Key  : Analysis.Elapsed.mSec\n    Value: 4092\n\n    Key  : Analysis.Init.CPU.mSec\n    Value: 78343\n\n    Key  : Analysis.Init.Elapsed.mSec\n    Value: 78474127\n\n    Key  : Analysis.Memory.CommitPeak.Mb\n    Value: 128\n\n    Key  : CriticalProcessDied.ExceptionCode\n    Value: 42bd7080\n\n    Key  : CriticalProcessDied.Process\n    Value: svchost.exe\n\n    Key  : WER.OS.Branch\n    Value: vb_release\n\n    Key  : WER.OS.Timestamp\n    Value: 2019-12-06T14:06:00Z\n\n    Key  : WER.OS.Version\n    Value: 10.0.19041.1</code></pre></div>\n<p>続くセクションでは以下の情報が出力されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FILE_IN_CAB:  FULL_MEMORY.DMP\n\nBUGCHECK_CODE:  ef\n\nBUGCHECK_P1: ffffc18f36303080\n\nBUGCHECK_P2: 0\n\nBUGCHECK_P3: 0\n\nBUGCHECK_P4: 0\n\nPROCESS_NAME:  svchost.exe\n\nCRITICAL_PROCESS:  svchost.exe\n\nERROR_CODE: (NTSTATUS) 0x42bd7080 - &lt;Unable to get error code text>\n\nBLACKBOXBSD: 1 (!blackboxbsd)\n\nBLACKBOXNTFS: 1 (!blackboxntfs)\n\nBLACKBOXPNP: 1 (!blackboxpnp)\n\nBLACKBOXWINLOGON: 1</code></pre></div>\n<p>この <code class=\"language-text\">BUGCHECK_CODE</code> や <code class=\"language-text\">BUGCHECK_P1</code> から <code class=\"language-text\">BUGCHECK_P4</code> までの情報は、最初のセクションで確認したバグチェックの情報と一致します。</p>\n<p>また、<code class=\"language-text\">CRITICAL_PROCESS</code> からシステムクラッシュの原因となった停止プロセスが svchost.exe であることもわかります。</p>\n<p>そして、次のセクションはスタックバックトレースです。</p>\n<p>ここでは <code class=\"language-text\">.cxr; .ecxr ; kb</code> コマンドを実行した場合と同等の出力が行われています。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">STACK_TEXT:  \nffffa209`4982f838 fffff801`2d70e592 : {{ 省略 }} : nt!KeBugCheckEx\nffffa209`4982f840 fffff801`2d616045 : {{ 省略 }} : nt!PspCatchCriticalBreak+0x10e\nffffa209`4982f8e0 fffff801`2d4819b0 : {{ 省略 }} : nt!PspTerminateAllThreads+0x15e655\nffffa209`4982f950 fffff801`2d4817ac : {{ 省略 }} : nt!PspTerminateProcess+0xe0\nffffa209`4982f990 fffff801`2d2105f5 : {{ 省略 }} : nt!NtTerminateProcess+0x9c\nffffa209`4982fa00 00007ff8`7accd3d4 : {{ 省略 }} : nt!KiSystemServiceCopyEnd+0x25\n00000087`d59ef568 00000000`00000000 : {{ 省略 }} : ntdll!NtTerminateProcess+0x14</code></pre></div>\n<p>スタックバックトレースの一番上にある KeBugCheckEx 関数は、直接的にシステムクラッシュを発生させる関数です。<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup></p>\n<p>KeBugCheckEx 関数は、ストップコードとストップコードごとに解釈される 4 つのパラメータを受け取ります。</p>\n<p>これが、先ほど確認した <code class=\"language-text\">.bugcheck</code> コマンドなどで参照できるバグチェックの情報にあたります。</p>\n<p>逆に、スタックバックトレースの一番下の NtTerminateProcess 関数は、以下にてドキュメント化されている通り、通常はユーザーモードアプリケーションからプロセスを停止する API を呼び出す際に使用する関数です。</p>\n<br>\n<p>ZwTerminateProcess 関数 (ntddk.h)：</p>\n<p><a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/ntddk/nf-ntddk-zwterminateprocess\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/ntddk/nf-ntddk-zwterminateprocess</a></p>\n<br>\n<p>上記のスタックバックトレースの出力をバグチェックの情報と合わせて考えると、何らかのユーザーモードアプリケーションから重要なシステムプロセスである svchost.exe が停止されたために、システムクラッシュが発生した可能性が高いと判断できます。</p>\n<p>また、<code class=\"language-text\">!analyze -v</code> コマンドの最後のセクションである以下の出力においても、<code class=\"language-text\">FAILURE_BUCKET_ID</code> に <code class=\"language-text\">0xEF_svchost.exe_BUGCHECK_CRITICAL_PROCESS_42bd7080_ntdll!NtTerminateProcess</code> と表示されており、今回のシステムクラッシュは NtTerminateProcess 関数によって svchost.exe が停止させられたことによって発生したものであると判断できます。 </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">SYMBOL_NAME:  ntdll!NtTerminateProcess+14\n\nMODULE_NAME: ntdll\n\nIMAGE_NAME:  ntdll.dll\n\nSTACK_COMMAND:  .cxr; .ecxr ; kb\n\nBUCKET_ID_FUNC_OFFSET:  14\n\nFAILURE_BUCKET_ID:  0xEF_svchost.exe_BUGCHECK_CRITICAL_PROCESS_42bd7080_ntdll!NtTerminateProcess\n\nOS_VERSION:  10.0.19041.1\n\nBUILDLAB_STR:  vb_release\n\nOSPLATFORM_TYPE:  x64\n\nOSNAME:  Windows 10\n\nFAILURE_ID_HASH:  {f6ece2b4-3d35-e4e4-9739-fdbc46a086b0}\n\nFollowup:     MachineOwner</code></pre></div>\n<h2 id=\"クラッシュを発生させたプロセスを特定する\" style=\"position:relative;\"><a href=\"#%E3%82%AF%E3%83%A9%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E7%99%BA%E7%94%9F%E3%81%95%E3%81%9B%E3%81%9F%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"クラッシュを発生させたプロセスを特定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>クラッシュを発生させたプロセスを特定する</h2>\n<p><code class=\"language-text\">!analyze -v</code> コマンドの出力結果からクラッシュの直接的な原因になった例外を特定することはできました。</p>\n<p>しかし、<code class=\"language-text\">!analyze -v</code> コマンドの出力結果で表示されたスタックバックトレースには <code class=\"language-text\">ntdll!NtTerminateProcess+0x14</code> より以前の情報が含まれていなかったため、具体的に何が例外の原因となったのかについては特定ができませんでした。</p>\n<p>これは、今回の例外と紐づくコンテキストが「停止されられた側」の svchost.exe のプロセスコンテキストであるためです。</p>\n<p>現在の例外と紐づくプロセスコンテキストは <code class=\"language-text\">.ecxr; !peb</code> で確認できます。(<code class=\"language-text\">!peb</code> 拡張機能<sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup>は、現在のプロセスコンテキストに対応する PEB(プロセス環境ブロック) を表示できます。)</p>\n<p><code class=\"language-text\">.ecxr</code> で指定可能な例外と紐づくコンテキストからは詳細な調査が困難でしたので、より詳細な調査を進めるためには、クラッシュを引き起こした可能性のあるプロセスにコンテキストを変更する必要があります。</p>\n<p>クラッシュを引き起こしたプロセスとは、今回で言えば D4C.exe です。</p>\n<p><code class=\"language-text\">.ecxr; !thread</code> コマンドで例外を引き起こしたコンテキストでスレッド情報を表示すると、<code class=\"language-text\">Owning Process</code> が D4C.exe であり、プロセスオブジェクトのアドレスが 0xffffc18f45284080 と表示されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f6ac26e1fa815010e9d28f8e905fe500/0b533/system-crash-003.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABGUlEQVQY042R2W6DMBBF8/8/VrWQBjBrWBqzBEjAlIqIJYhbj5UuD33oSNZ4ZM2Z6zu7NE3BmIUkSeD7Aeq6Rp5nsG0bXdchCAJEUYS2bWFZlnrnnMM0TQgh4Lqu6qXYtg07zlM8Pb/AdlzsdQ1xHCHNC+j7A66XCzzPU80E0jRNwUiErutomkaK8BGG4Q/w9WAg4gXExw1RWiGvBd6HEbd5RdV0GMcRy7JgmiaV13XFX0EwBTTk9DzL0LQCzvGEomrk5Cvu9wXjvOA/8QX7BpIPpiGVHgPw05usPfn1GOdzgU76JB6HPO37HmVZqjwMg1L9O3ZMmk8+ORIax4lqshmTi2LKO1oEe9R0p0GUDSmAhBB4nmdlDeVPgOy9uFRlynAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f6ac26e1fa815010e9d28f8e905fe500/8ac56/system-crash-003.webp 240w,\n/static/f6ac26e1fa815010e9d28f8e905fe500/d3be9/system-crash-003.webp 480w,\n/static/f6ac26e1fa815010e9d28f8e905fe500/b0a15/system-crash-003.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f6ac26e1fa815010e9d28f8e905fe500/8ff5a/system-crash-003.png 240w,\n/static/f6ac26e1fa815010e9d28f8e905fe500/e85cb/system-crash-003.png 480w,\n/static/f6ac26e1fa815010e9d28f8e905fe500/0b533/system-crash-003.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f6ac26e1fa815010e9d28f8e905fe500/0b533/system-crash-003.png\"\n            alt=\"クラッシュが発生したスレッドを調査する\"\n            title=\"クラッシュが発生したスレッドを調査する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>そこで、<code class=\"language-text\">.process /r /P 0xffffc18f45284080</code> コマンドを使用してデバッガのプロセスコンテキストを D4C.exe プロセスに変更します。</p>\n<p>プロセスのコンテキストを変更した状態で再度 <code class=\"language-text\">!peb</code> コマンドを実行すると、表示される情報が svchost.exe の PEB ではなく D4C.exe の PEB に変化することを確認できます。</p>\n<p>この、<code class=\"language-text\">.process /r /P &lt;プロセスオブジェクト(EPROCESS)のアドレス></code> によるプロセスコンテキストの変更は、フルメモリダンプを解析する上で頻出のコマンドなので覚えておくと良いでしょう。</p>\n<p>最後に、プロセスコンテキストを D4C.exe に変更した状態で再度 <code class=\"language-text\">k</code> コマンドによりスタックバックトレースを出力してみると、<code class=\"language-text\">ntdll!NtTerminateProcess+0x14</code> が呼び出される以前のスタックバックトレースも参照することができるようになりました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">6: kd> k\n # Child-SP          RetAddr               Call Site\n00 ffffa209`4982f838 fffff801`2d70e592     nt!KeBugCheckEx\n01 ffffa209`4982f840 fffff801`2d616045     nt!PspCatchCriticalBreak+0x10e\n02 ffffa209`4982f8e0 fffff801`2d4819b0     nt!PspTerminateAllThreads+0x15e655\n03 ffffa209`4982f950 fffff801`2d4817ac     nt!PspTerminateProcess+0xe0\n04 ffffa209`4982f990 fffff801`2d2105f5     nt!NtTerminateProcess+0x9c\n05 ffffa209`4982fa00 00007ff8`7accd3d4     nt!KiSystemServiceCopyEnd+0x25\n06 00000087`d59ef568 00007ff8`789643d0     ntdll!NtTerminateProcess+0x14\n07 00000087`d59ef570 00007ff6`e99012d3     KERNELBASE!TerminateProcess+0x30\n08 00000087`d59ef5a0 00007ff6`e9901a40     D4C+0x12d3\n09 00000087`d59ef860 00007ff8`7a497344     D4C+0x1a40\n0a 00000087`d59ef8a0 00007ff8`7ac826b1     KERNEL32!BaseThreadInitThunk+0x14\n0b 00000087`d59ef8d0 00000000`00000000     ntdll!RtlUserThreadStart+0x21</code></pre></div>\n<p>この結果から、D4C.exe のオフセット 0x12d3 の 1 つ前の命令が TerminateProcess API を呼び出し、svchost.exe の停止が行われた可能性が高いと推察できます。</p>\n<h2 id=\"クラッシュが発生した前後の命令を読む\" style=\"position:relative;\"><a href=\"#%E3%82%AF%E3%83%A9%E3%83%83%E3%82%B7%E3%83%A5%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%9F%E5%89%8D%E5%BE%8C%E3%81%AE%E5%91%BD%E4%BB%A4%E3%82%92%E8%AA%AD%E3%82%80\" aria-label=\"クラッシュが発生した前後の命令を読む permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>クラッシュが発生した前後の命令を読む</h2>\n<p>ここまでの解析で、D4C.exe のオフセット 0x12d3 の 1 つ前の命令が TerminateProcess API を呼び指してシステムクラッシュを引き起こした可能性が高いことを確認しました。</p>\n<p>次は、オフセット 0x12d3 の前後の命令がどのようなものであったかを調査していきます。</p>\n<p>4 章と同じく <code class=\"language-text\">u</code> コマンドや Disassembly ウインドウを使用してオフセット 0x12d3 の前後の命令を取得しました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">00007ff6`e99012b0 448b442448      mov     r8d,dword ptr [rsp+48h]\n00007ff6`e99012b5 8d48f5          lea     ecx,[rax-0Bh]\n00007ff6`e99012b8 33d2            xor     edx,edx\n00007ff6`e99012ba ff15781d0000    call    qword ptr [D4C+0x3038 (00007ff6`e9903038)]\n00007ff6`e99012c0 488bd8          mov     rbx,rax\n00007ff6`e99012c3 4885c0          test    rax,rax\n00007ff6`e99012c6 7416            je      D4C+0x12de (00007ff6`e99012de)\n00007ff6`e99012c8 33d2            xor     edx,edx\n00007ff6`e99012ca 488bc8          mov     rcx,rax\n00007ff6`e99012cd ff155d1d0000    call    qword ptr [D4C+0x3030 (00007ff6`e9903030)]\n00007ff6`e99012d3 488bcb          mov     rcx,rbx\n00007ff6`e99012d6 ff158c1d0000    call    qword ptr [D4C+0x3068 (00007ff6`e9903068)]\n00007ff6`e99012dc eb11            jmp     D4C+0x12ef (00007ff6`e99012ef)\n00007ff6`e99012de 488d54246c      lea     rdx,[rsp+6Ch]\n00007ff6`e99012e3 488d0d26410000  lea     rcx,[D4C+0x5410 (00007ff6`e9905410)]\n00007ff6`e99012ea e821fdffff      call    D4C+0x1010 (00007ff6`e9901010)\n00007ff6`e99012ef 488d542440      lea     rdx,[rsp+40h]\n00007ff6`e99012f4 488bcf          mov     rcx,rdi\n00007ff6`e99012f7 ff15431d0000    call    qword ptr [D4C+0x3040 (00007ff6`e9903040)]\n00007ff6`e99012fd 85c0            test    eax,eax</code></pre></div>\n<p>私が取得したダンプファイルにおいて、D4C.exe のイメージベースアドレスは 0x00007ff6e9900000 ですので、オフセット(RVA) 0x12d3 の仮想アドレスは <code class=\"language-text\">0x00007ff6e99012d3</code> となります。</p>\n<p>余談ですが、アドレスの計算などは <code class=\"language-text\">?</code> コマンドを使用した式の評価でも以下の通り行うことが可能です。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># D4C.exe のイメージベースアドレスを特定する\n6: kd> ? !D4C\nEvaluate expression: 140698457210880 = 00007ff6`e9900000\n\n# D4C.exe のオフセット 0x12d3 のアドレスを計算する\n6: kd> ? !D4C+0x12d3\nEvaluate expression: 140698457215699 = 00007ff6`e99012d3</code></pre></div>\n<p>上記のディスアセンブル結果を参照すると、スタックバックトレースに追加されているオフセット 0x12d3 の直前の命令は <code class=\"language-text\">call  qword ptr [D4C+0x3030 (00007ff6e9903030)]</code> であることがわかります。</p>\n<p>また、以降のスタックバックトレースの情報から、恐らくこの命令で TerminateProcess API を呼び出しているであろうことが推察できます。</p>\n<p>では、実際にこの関数が TerminateProcess 関数を呼び出しているのかどうかをダンプファイルから確認してみます。</p>\n<h2 id=\"windbg-で-iatimport-address-table-を解析する\" style=\"position:relative;\"><a href=\"#windbg-%E3%81%A7-iatimport-address-table-%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\" aria-label=\"windbg で iatimport address table を解析する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbg で IAT(Import Address Table) を解析する</h2>\n<p>本書の 3 章で簡単に紹介しましたが、Windows システムにおいて実行されるプログラム(EXE ファイル)は、一般に PE ファイルフォーマットで作成されています。</p>\n<p>Windows システムでプログラムを実行する場合、システムは PE ファイルのヘッダ内の情報からいくつかの情報をロードしてプロセスに割り当てたメモリ空間に展開します。</p>\n<p>この内の一つが IAT(Import Address Table) と呼ばれる情報です。</p>\n<p><code class=\"language-text\">D4C+0x3030</code> で呼び出している関数が TerminateProcess であるかを特定するため、この IAT の情報を参照してみましょう。</p>\n<p>まずは、WinDbg を使用してこのダンプファイルからメモリに展開された D4C.exe のヘッダ情報を収集します。</p>\n<p>WinDbg では <code class=\"language-text\">!dh</code> 拡張機能<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup>を使用することで、特定のイメージのヘッダ情報を参照できるようになります。</p>\n<p>ただし、<code class=\"language-text\">!dh</code> 拡張機能を使用してフルメモリダンプから特定の PE ファイルのヘッダ情報を参照する場合には、事前に <code class=\"language-text\">.process /r /P &lt;プロセスオブジェクト(EPROCESS)のアドレス></code> コマンドでその PE ファイルの実行プロセスにコンテキストを変更しておく必要があります。</p>\n<p>プロセスのコンテキストを D4C.exe に変更したら、<code class=\"language-text\">!dh -f !D4C</code> コマンドを実行して情報を取得します。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">6: kd> !dh -f !D4C\n\n{{ 省略 }}\n\n   0 [       0] address [size] of Export Directory\n5B40 [      C8] address [size] of Import Directory\n9000 [     1E8] address [size] of Resource Directory\n8000 [     1D4] address [size] of Exception Directory\n   0 [       0] address [size] of Security Directory\nA000 [      3C] address [size] of Base Relocation Directory\n5610 [      70] address [size] of Debug Directory\n   0 [       0] address [size] of Description Directory\n   0 [       0] address [size] of Special Directory\n   0 [       0] address [size] of Thread Storage Directory\n54D0 [     140] address [size] of Load Configuration Directory\n   0 [       0] address [size] of Bound Import Directory\n3000 [     248] address [size] of Import Address Table Directory\n   0 [       0] address [size] of Delay Import Directory\n   0 [       0] address [size] of COR20 Header Directory\n   0 [       0] address [size] of Reserved Directory</code></pre></div>\n<p>今回参照したいのは IAT ですので、上記の出力結果の <code class=\"language-text\">Import Address Table Directory</code> の行に着目します。</p>\n<p>この行の情報は、IAT のオフセットが 0x3000 であり、サイズが 0x248 であることを示しています。</p>\n<p>次に、指定の範囲内のメモリの内容をシンボルテーブル内の一連のアドレスとして解決させる <code class=\"language-text\">dps</code> コマンド<sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup>を使用して、IAT のシンボルを解決します。</p>\n<p>このコマンドによってプロセスメモリ内に展開された IAT のシンボルが解決され、仮想アドレス 0x00007ff6e9903030、つまり <code class=\"language-text\">D4C+0x3030</code> の関数が <code class=\"language-text\">KERNEL32!TerminateProcessStub</code> であることを確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># dps !&lt;module_name>+&lt;IAT のアドレス> !&lt;module_name>+&lt;IAT のアドレス>+&lt;IAT のサイズ>\n\n6: kd> dps !D4C+0x3000 !D4C+0x3000+0x248\n00007ff6`e9903000  00007ff8`7ab57880 ADVAPI32!AdjustTokenPrivilegesStub\n00007ff6`e9903008  00007ff8`7ab56920 ADVAPI32!OpenProcessTokenStub\n00007ff6`e9903010  00007ff8`7ab4f970 ADVAPI32!LookupPrivilegeValueW\n00007ff6`e9903018  00000000`00000000\n00007ff6`e9903020  00007ff8`7a495f00 KERNEL32!GetLastErrorStub\n00007ff6`e9903028  00007ff8`7a4a4ba0 KERNEL32!GetCurrentProcessId\n00007ff6`e9903030  00007ff8`7a4a0a70 KERNEL32!TerminateProcessStub\n00007ff6`e9903038  00007ff8`7a49b0f0 KERNEL32!OpenProcessStub\n00007ff6`e9903040  00007ff8`7a4a2740 KERNEL32!Process32NextW\n00007ff6`e9903048  00007ff8`7a4a29a0 KERNEL32!Process32FirstW\n{{ 省略 }}</code></pre></div>\n<p>なお、上記のようにわざわざ WinDbg で IAT の解析を実施せずとも、Ghidra などのデコンパイラの自動解析機能を利用することで、簡単に <code class=\"language-text\">D4C+0x3030</code> の関数を特定することが可能です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/37bb1a5b06acf83c2dcb7c32fce18cd5/0b533/ghidra-iat-01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.916666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABCklEQVQY022Q2U6DUBRF+f+v0hjTKvVBU7BaLC1wGcqMtGW43CWD8cmT7OwhOS9LC/2QPCvJc+ha5hukoqqavxwFFcn5QihqqmLZUf9L273v8LyQkwNpOoybou16rEPC1KSUpHZGJgoSL6DOauQwMKhFiuVn+HXt7vjAo79hFX2NbvFa7zG6D+7tN7bNJ2a3Y+3qrIWOnj2hJwYrf8smNXnJzdn1szHuJs+xgba39pw8HxFJXNFTNz2NbLHshFvf0soG3xEEIiDOPKK4wPVz4vybrKxniaAgjMvx94Z2OhzxvYQ4guY6MVu42YcC2Y9YpmzHuE6G55TEI8tL3XG9dNyuPW0j5z5JKcUPCZZ6HxunuPMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/37bb1a5b06acf83c2dcb7c32fce18cd5/8ac56/ghidra-iat-01.webp 240w,\n/static/37bb1a5b06acf83c2dcb7c32fce18cd5/d3be9/ghidra-iat-01.webp 480w,\n/static/37bb1a5b06acf83c2dcb7c32fce18cd5/b0a15/ghidra-iat-01.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/37bb1a5b06acf83c2dcb7c32fce18cd5/8ff5a/ghidra-iat-01.png 240w,\n/static/37bb1a5b06acf83c2dcb7c32fce18cd5/e85cb/ghidra-iat-01.png 480w,\n/static/37bb1a5b06acf83c2dcb7c32fce18cd5/0b533/ghidra-iat-01.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/37bb1a5b06acf83c2dcb7c32fce18cd5/0b533/ghidra-iat-01.png\"\n            alt=\"Ghidra のディスアセンブル結果\"\n            title=\"Ghidra のディスアセンブル結果\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>オフセット 0x3030 のディスアセンブル結果も自動的に解析され、ここで呼び出される関数が TerminateProcess 関数であることを簡単に調査することが可能です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cac71f1f2674618b04dc9ab65b91d0de/0b533/ghidra-iat-02.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAB2klEQVQoz32S6XKcQAyEef8Xy9/YScWOvWFPdrkWmIOBYYAvArJJqnKIakalkVpqQXRTEw9cm3FDHbhUPUnt5fQk1SD+IHfhJ1I9r1jqHv6CKJNXZliLDpld8e1q+XrUvF9avuxLXg65+BVxatb7hfz3QR5YCT9J4knIUj3xdCp4uzUcC8+Htzuv14FTEbZGecsxd5zK7o+pHpMuiHaSmKiRVKS+HBXvZ5nw3PIxLnlLLOfMS6KosHBVgZteCmUtgo1kWdNEpmFRGyX1SNIghT3vByPyWl73mlj83clyvDmupZBWgV2hOFQd8d3ylFz4fEt5vl55PosyYTzLzqO8spTSQTkEI42b6J3H5XecbnG1pi0b2trQelbYfsL0I/oHTB9Q3SCnSOZh88jge8LQ45zDmBZrW+qmRmmFNoauc/i+I4SBf1lUWUsfAtMo0tOMqmlQSrO/KLKipyzvKInVdb3GreRP08w8/x1RnOd0w9Yxk0nc4JmZiPOMuChEXr8JkOf/thDKhK3fCGbpWt4NZa5pKkcqflZohvCLaBgHxmlc4UdPGMMa86JwnjfSSCsrMpC9CWFuSeX/MJl8hN2ZUNbMInmuKpCG1i/r8SuZ6Q3OuzVmXC9r2Ai/A2l4TBBW70BYAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/cac71f1f2674618b04dc9ab65b91d0de/8ac56/ghidra-iat-02.webp 240w,\n/static/cac71f1f2674618b04dc9ab65b91d0de/d3be9/ghidra-iat-02.webp 480w,\n/static/cac71f1f2674618b04dc9ab65b91d0de/b0a15/ghidra-iat-02.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/cac71f1f2674618b04dc9ab65b91d0de/8ff5a/ghidra-iat-02.png 240w,\n/static/cac71f1f2674618b04dc9ab65b91d0de/e85cb/ghidra-iat-02.png 480w,\n/static/cac71f1f2674618b04dc9ab65b91d0de/0b533/ghidra-iat-02.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/cac71f1f2674618b04dc9ab65b91d0de/0b533/ghidra-iat-02.png\"\n            alt=\"Ghidra のディスアセンブル結果\"\n            title=\"Ghidra のディスアセンブル結果\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>このように、WinDbg のみで解析を行うよりも、デコンパイラなどの複数の強力なツールを利用し、多角的に解析することでより効率的に解析を進められる場合があります。</p>\n<p>これで、ダンプファイルを解析した結果、システムクラッシュの発生原因が「svchost.exe が D4C.exe が呼び出した TerminateProcess API によって停止されたこと」であることを特定することができました。</p>\n<h2 id=\"5-章のまとめ\" style=\"position:relative;\"><a href=\"#5-%E7%AB%A0%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"5 章のまとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5 章のまとめ</h2>\n<p>以上で、シンプルなシステムクラッシュダンプの解析は終了です。</p>\n<p>4 章で解析したアプリケーションクラッシュダンプと同じく、BSOD の発生した直接的な原因(例外)自体はダンプファイルから容易に特定できます。</p>\n<p>もちろん、その例外を発生させた原因となるプログラムの挙動について調査を行う場合には、本章のように簡単に特定できることは少ないでしょう。</p>\n<p>そのような場合には、WinDbg によるダンプファイルの解析のみではなく、プロセスモニターやパケットキャプチャなどを使用した問題再現時の環境のトレース、そしてソースコードやデコンパイル結果を使用した机上でのデバッグ、さらにはライブデバッグなど、様々なアプローチでの調査をお試しいただくと、より効率的な原因調査ができるのではないかと思います。</p>\n<h2 id=\"各章へのリンク\" style=\"position:relative;\"><a href=\"#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF\" aria-label=\"各章へのリンク permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>各章へのリンク</h2>\n<ul>\n<li><a href=\"/magical-windbg-vol1-00\">まえがき</a></li>\n<li><a href=\"/magical-windbg-vol1-01\">1 章 環境構築</a></li>\n<li><a href=\"/magical-windbg-vol1-02\">2 章 WinDbg の基本操作</a></li>\n<li><a href=\"/magical-windbg-vol1-03\">3 章 解析に必要な前提知識</a></li>\n<li><a href=\"/magical-windbg-vol1-04\">4 章 アプリケーションのクラッシュダンプを解析する</a></li>\n<li><a href=\"/magical-windbg-vol1-05\">5 章 システムクラッシュ時のフルメモリダンプを解析する</a></li>\n<li><a href=\"/magical-windbg-vol1-06\">6 章 プロセスダンプからユーザモードアプリケーションのメモリリーク事象を調査する</a></li>\n<li><a href=\"/magical-windbg-vol1-07\">7 章 フルメモリダンプからユーザモードメモリリーク事象を調査する</a></li>\n<li><a href=\"/magical-windbg-vol1-50\">付録 A WinDbg の Tips</a></li>\n<li><a href=\"/magical-windbg-vol1-51\">付録 B Volatility 3 でクラッシュダンプを解析する</a></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>ブルースクリーンデータ <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/blue-screen-data\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/blue-screen-data</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-2\">\n<p>インサイド Windows 第 6 版 下 P.606 (Mark E. Russinovich・David A. Solomon・Alex Ionescu 著 / 株式会社クイープ 訳 / 日系 BP 社 / 2013 年)</p>\n<a href=\"#fnref-2\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-3\">\n<p>!peb 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-peb\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-peb</a></p>\n<a href=\"#fnref-3\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-4\">\n<p>!dh <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-dh\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-dh</a></p>\n<a href=\"#fnref-4\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-5\">\n<p>dps <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/dds--dps--dqs--display-words-and-symbols-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/dds—dps—dqs—display-words-and-symbols-</a></p>\n<a href=\"#fnref-5\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","fields":{"slug":"/magical-windbg-vol1-05","tagSlugs":["/tag/magical-win-dbg/","/tag/windows/","/tag/win-dbg/"]},"frontmatter":{"date":"2023-11-15","description":"技術書典 15 で頒布した Magical WinDbg -雰囲気で楽しむ Windows ダンプ解析とトラブルシューティング- VOL.1 の WEB 版です。","tags":["Magical WinDbg","Windows","WinDbg"],"title":"Magical WinDbg VOL.1【5 章 システムクラッシュ時のフルメモリダンプを解析する】","socialImage":{"publicURL":"/static/2dbf3e09d59db889dc9dc41adcc8e827/magical-windbg-vol1.png"}}}},"pageContext":{"slug":"/magical-windbg-vol1-05"}},"staticQueryHashes":["251939775","401334301","825871152"]}