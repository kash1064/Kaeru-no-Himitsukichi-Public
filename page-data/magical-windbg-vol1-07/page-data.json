{"componentChunkName":"component---src-templates-post-template-js","path":"/magical-windbg-vol1-07","result":{"data":{"markdownRemark":{"id":"586b70a0-f5bf-5203-a912-5bf92addace4","html":"<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E3%83%95%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%81%AE%E5%8F%96%E5%BE%97\">システムのフルメモリダンプの取得</a></li>\n<li><a href=\"#windbg-%E3%81%AB%E3%83%95%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B\">WinDbg にフルメモリダンプをロードする</a></li>\n<li><a href=\"#%E7%AB%AF%E6%9C%AB%E3%81%AE%E3%83%8F%E3%83%BC%E3%83%89%E3%82%A6%E3%82%A7%E3%82%A2%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%8E%E9%9B%86%E3%81%99%E3%82%8B\">端末のハードウェア情報を収集する</a></li>\n<li><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%8E%E9%9B%86%E3%81%99%E3%82%8B\">システム情報を収集する</a></li>\n<li><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E3%83%AC%E3%82%B8%E3%82%B9%E3%83%88%E3%83%AA%E6%83%85%E5%A0%B1%E3%82%92%E6%8E%A2%E7%B4%A2%E3%81%99%E3%82%8B\">システムのレジストリ情報を探索する</a></li>\n<li><a href=\"#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E4%BD%BF%E7%94%A8%E6%83%85%E5%A0%B1%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B\">メモリリソース使用情報を調査する</a></li>\n<li><a href=\"#%E7%A8%BC%E5%83%8D%E4%B8%AD%E3%81%AE%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B\">稼働中のプロセスの情報を調査する</a></li>\n<li><a href=\"#%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%90%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B\">特定のプロセスのスタックバックトレースを調査する</a></li>\n<li><a href=\"#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%BC%E3%83%89%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AE%E3%83%92%E3%83%BC%E3%83%97%E6%83%85%E5%A0%B1%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B\">ユーザモードプロセスのヒープ情報を調査する</a></li>\n<li><a href=\"#7-%E7%AB%A0%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81\">7 章のまとめ</a></li>\n<li><a href=\"#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF\">各章へのリンク</a></li>\n</ul>\n<p>本書の最後の章である 7 章では、6 章で解析したものと同じユーザモードのメモリリーク事象をシステムのフルメモリダンプから解析していきます。</p>\n<p>メモリリーク事象の調査方法自体は 6 章と同じですので、7 章はどちらかというとフルメモリダンプから様々な情報を抜き出すテクニックの紹介が中心となります。</p>\n<p>しかし、カーネルモードのメモリ情報を含むフルメモリダンプを解析する場合には、ユーザモードのプロセスダンプ解析と比較して使用可能なコマンドや出力結果が異なるため、また違ったアプローチでの解析を楽しむことができると思います。</p>\n<h2 id=\"システムのフルメモリダンプの取得\" style=\"position:relative;\"><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E3%83%95%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%81%AE%E5%8F%96%E5%BE%97\" aria-label=\"システムのフルメモリダンプの取得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>システムのフルメモリダンプの取得</h2>\n<p>解析用のフルメモリダンプを取得するため、6 章の手順と同じく、D4C.exe を起動し、2 番のメニューを選択してアプリケーションのメモリリーク事象を再現します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c9686e0bd856e304ccbd48f263c244c5/0b533/mem-leak-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA7EAAAOxAGVKw4bAAACNklEQVQ4y42TS2/TQBSFDUpC4lect+147PEj8atpRSR+E2wRC1YsCGxb/gYgiEARXVAoISqs+UeHO5OkhLaBLo6uc618PufeGWX++Rvmi094+2Eh9Wb+Ea9J7xenOPt+gS+rH7Jun7+ufu6I3i0vcHq2xPlyhXfnv6D0XQ+9ThtqowFdU2HquqxN04CmUk+lnqFLqY06atXKddVqqNxR8OjpSyjBKEORZzg4mKAoSlKBsiwxnU7lc5pmyKn2+31YlgXDMG6QCa1ew+Pnr6DYjMNzXQQBx3A4BPMZHMdBFEXyt+d5Us1mEyq51UWCazKg3quugXFWggcBAQMkSUKgGGEYYjweYzAYoNvtoiHGsfmzpml7gJU1MDu8j/EoQZbnmEwmyKmKmL7vy5hb6M2gK8DZCZQwzRGRI89jEuJSXOGW0wjsgY1WqwXTNG8BFJFPxFJSxDQvRkAxR2/oSbD4iIi+G1lA90feAPkG6DMfnHO5AOFQ9MQH2u32JWS/y12HycYhYxIkNivA256IfOulzGgpUVZQPH4JFA5deYzIZRzDtm3pUpy3fzsk4AsCjsoJQr4GCajj2LIKpxa5E+dPQP8PrK637FPkhJyIRYglSKcUWZ5J6nd7PdTr9T+Rr0j2je0Mj2mG8QhJGMAnh5ygzHVkTaIQAfPQtprQ6A7r8l7vEd19tXoXT2YE5EcPEJdHcJMMLC3gxCnYuEBYHMIb5bBcH2rHhtZ1SPbf6mxE71SzhYfPjvEbvIqsR9VDrFUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/c9686e0bd856e304ccbd48f263c244c5/8ac56/mem-leak-001.webp 240w,\n/static/c9686e0bd856e304ccbd48f263c244c5/d3be9/mem-leak-001.webp 480w,\n/static/c9686e0bd856e304ccbd48f263c244c5/b0a15/mem-leak-001.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/c9686e0bd856e304ccbd48f263c244c5/8ff5a/mem-leak-001.png 240w,\n/static/c9686e0bd856e304ccbd48f263c244c5/e85cb/mem-leak-001.png 480w,\n/static/c9686e0bd856e304ccbd48f263c244c5/0b533/mem-leak-001.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/c9686e0bd856e304ccbd48f263c244c5/0b533/mem-leak-001.png\"\n            alt=\"D4C.exe でユーザモードメモリリーク事象の再現\"\n            title=\"D4C.exe でユーザモードメモリリーク事象の再現\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Process Explorer などのツールを使用して D4C.exe のプロセスが使用する仮想メモリ領域が肥大化したことを確認したら、キーボード操作によってシステムクラッシュを発生させることでフルメモリダンプを取得します。</p>\n<p>キーボード操作によるシステムクラッシュは、1 章と同じ手順でキーボードの右 Ctrl キーを押しながら、Space キーを 2 回連打することで引き起こすことが可能です。</p>\n<p>1 章で実施したキーボードクラッシュの設定が反映されている場合、上記のキー操作を実施するとシステムがクラッシュし、ブルースクリーン画面が表示されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aed56d2ac06acaecdc7941c14636d092/0b533/fulldump-003.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABZUlEQVQoz41S2U4CQRBcXxARF8EDwXjFC2OIiQ/GaHzwm4AlgiKigOAVj+iXufeun1J2zyywIQZ5qO2Z7p6artpRlPI3FC2EIqE0BC2If9V69bIuo1IykL6xBRbrNvKPHnIdF/tdT+wzDZnfbLs4eHax0rSw0bax9+BgrWVjt+sgUTMlMZMqmo7MrYV1Kp5++Dh+83Hy7mO742Dr3kGODuzQ+vzrB4cvHo5ePZx9+sg/uaKuElmkog+mZMnxSwMzVwaydxY1GEhem4hRbqpqIFqVtVTdFHuuzdGac5MVY2BVXzJ9eMLVpo15ahQ+FYY8KoZQCFAc8lQLEfKEfHOCblUJyZqcIFqR0/FEKvXEA0yzIo5VuY9R7JMyIZOx3GXCUsOiH2SKOFuTh1k++8Ty+TBL71nCkfNSuvBQR4oIF4gkS9LTDSY1hfzIhY4J9qYUelajnk05kDyysd/8D8ITjtU8Th/hFw2O1/mgLvuiAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/aed56d2ac06acaecdc7941c14636d092/8ac56/fulldump-003.webp 240w,\n/static/aed56d2ac06acaecdc7941c14636d092/d3be9/fulldump-003.webp 480w,\n/static/aed56d2ac06acaecdc7941c14636d092/b0a15/fulldump-003.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/aed56d2ac06acaecdc7941c14636d092/8ff5a/fulldump-003.png 240w,\n/static/aed56d2ac06acaecdc7941c14636d092/e85cb/fulldump-003.png 480w,\n/static/aed56d2ac06acaecdc7941c14636d092/0b533/fulldump-003.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/aed56d2ac06acaecdc7941c14636d092/0b533/fulldump-003.png\"\n            alt=\"ブルースクリーン(BSOD)\"\n            title=\"ブルースクリーン(BSOD)\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>システムの再起動後、<code class=\"language-text\">C:\\Windows</code> フォルダ直下に仮想マシンの物理メモリとほぼ同サイズの <code class=\"language-text\">FULL_MEMORY.DMP</code> が生成されます。</p>\n<p>本章では、このフルメモリダンプを使用してアプリケーションのメモリリーク事象の調査を行います。</p>\n<p>ちなみに、1 章でも記載した通り、本書の手順で設定したキーボードクラッシュは、 RDP 経由で接続している場合には有効に動作しません。</p>\n<p>物理キーボードを使用可能な場合は、ローカルマシンに直接サインインした状態で「右 Ctrl キーを押しながら、Space キーを 2 回連打」することでシステムクラッシュを発生させる必要があります。</p>\n<p>また、Hyper-V 仮想マシンを利用している場合には、拡張セッションを無効化した状態でマシンにサインインし、「右 Ctrl キーを押しながら、Space キーを 2 回連打」することでキーボードクラッシュを行うことが可能です。</p>\n<p>その他の仮想マシンを利用している場合には、ソフトウェアキーボードの使用を試してみてください。</p>\n<p>もしキーボードクラッシュを実施できない環境の場合は、[Sysinternals ユーティリティのインストール] でダウンロードした SysinternalsSuite に含まれる notmyfault.exe を使用することでも、意図的にシステムクラッシュを再現することが可能です。</p>\n<h2 id=\"windbg-にフルメモリダンプをロードする\" style=\"position:relative;\"><a href=\"#windbg-%E3%81%AB%E3%83%95%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B\" aria-label=\"windbg にフルメモリダンプをロードする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbg にフルメモリダンプをロードする</h2>\n<p>解析用のダンプファイルを取得できたら、さっそく管理者権限で起動した WinDbg にロードしましょう。</p>\n<p>これまでの章と同じく、<code class=\"language-text\">!analyze -v</code> コマンドを実行してダンプファイルに含まれる Bugcheck の情報を参照すると、以下のように <code class=\"language-text\">MANUALLY_INITIATED_CRASH (e2)</code><sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup> と表示されました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> !analyze -v\n\nMANUALLY_INITIATED_CRASH (e2)\nThe user manually initiated this crash dump.\nArguments:\nArg1: 0000000000000000\nArg2: 0000000000000000\nArg3: 0000000000000000\nArg4: 0000000000000000</code></pre></div>\n<p>これは、ユーザがカーネルデバッガやキーボード操作によって意図的にシステムクラッシュを引き起こした場合に記録される値です。</p>\n<p>つまり、6 章で手動生成したプロセスダンプと同じく、フルメモリダンプに含まれる例外発生時のコンテキストがメモリリーク事象の解析には役に立たないものであることがわかります。</p>\n<p>そのため、フルメモリダンプからクラッシュ以外の問題の調査を行う場合は、まず適切な解析対象を絞り込み、デバッガのコンテキストを合わせる必要があります。</p>\n<p>そこで、ここからの項では、適切な解析対象を特定するために、フルメモリダンプからシステム内の情報を網羅的に収集していきます。</p>\n<p>フルメモリダンプにはシステムの物理メモリ上に保持されているすべてのページの情報が含まれており、高機能なデバッガである WinDbg の機能をフルに使用することで、システム内のあらゆる情報をフルメモリダンプから取得できます。</p>\n<p>実行するコマンドによっては出力結果が膨大になる場合があるので、必要に応じて <code class=\"language-text\">.logopen</code> コマンドで出力結果をファイルに書き出すようにしておくと良いでしょう。</p>\n<h2 id=\"端末のハードウェア情報を収集する\" style=\"position:relative;\"><a href=\"#%E7%AB%AF%E6%9C%AB%E3%81%AE%E3%83%8F%E3%83%BC%E3%83%89%E3%82%A6%E3%82%A7%E3%82%A2%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%8E%E9%9B%86%E3%81%99%E3%82%8B\" aria-label=\"端末のハードウェア情報を収集する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>端末のハードウェア情報を収集する</h2>\n<p>はじめに、<code class=\"language-text\">!sysinfo</code> 拡張機能<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup>を使用してダンプファイルに記録されているハードウェアの情報を収集してみます。</p>\n<p><code class=\"language-text\">!sysinfo</code> 拡張機能にはいくつかのオプションがありますが、本書では CPU の情報を表示する <code class=\"language-text\">!sysinfo cpuinfo</code> コマンドと端末情報を表示する <code class=\"language-text\">!sysinfo machineid</code> コマンドを使用してみました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># CPU の情報を表示\n0: kd> !sysinfo cpuinfo\n[CPU Information]\n~MHz = REG_DWORD 1992\nComponent Information = REG_BINARY 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\nConfiguration Data = REG_FULL_RESOURCE_DESCRIPTOR ff,ff,ff,ff,ff,ff,ff,ff,0,0,0,0,0,0,0,0\nIdentifier = REG_SZ Intel64 Family 6 Model 142 Stepping 10\nProcessorNameString = REG_SZ Intel(R) Core(TM) i7-8550U CPU @ 1.80GHz\nUpdate Status = REG_DWORD 7\nVendorIdentifier = REG_SZ GenuineIntel\nMSR8B = REG_QWORD ea00000000\n\n# 端末情報を表示する\n0: kd> !sysinfo machineid\nMachine ID Information [From Smbios 3.0, DMIVersion 0, Size=3046]\nBiosMajorRelease = 1\nBiosMinorRelease = 43\nFirmwareMajorRelease = 1\nFirmwareMinorRelease = 10\nBiosVendor = LENOVO\nBiosVersion = N20ET58W (1.43 )\nBiosReleaseDate = 07/26/2021\nSystemManufacturer = LENOVO\nSystemProductName = 20KES0KB00\nSystemFamily = ThinkPad X280\nSystemVersion = ThinkPad X280\nSystemSKU = LENOVO_MT_20KE_BU_Think_FM_ThinkPad X280\nBaseBoardManufacturer = LENOVO\nBaseBoardProduct = 20KES0KB00\nBaseBoardVersion = Not Defined</code></pre></div>\n<p>このコマンドを実行することで、上記のようにシステムのクラッシュが発生した端末が Intel i7-8550U を搭載した ThinkPad X280 であることを確認できました。</p>\n<p>CPU についてさらに詳細な情報を表示したい場合、<code class=\"language-text\">!cpuinfo</code> 拡張機能<sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup>を使用できます。</p>\n<p><code class=\"language-text\">!cpuinfo</code> コマンドをオプション無しで実行すると、すべてのプロセッサの情報が表示されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e2b34eda87dc1bf2f29cbe237be8f562/0b533/system-windbg-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.499999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAA8ElEQVQY002QWauDQAyF/f8/qSjog/pQxbq2uCAVUcEFq6B1PZcELHcghDk5+ZIZ4f1+w7ZthGGItm3R9z3KskSWZZyLomCtrmt0XYemafhO3qqqWL80ygKBXNeFYRiQZRn3+x2O40DXddxuNw5JknjAtm2YpgnrumIYBvZblsVQ0uZ5hpCmKZ7PJ4Ig4CLlOI4ZqqoqgxVF4ab/hwA0/PV6YRzHny4kScLAx+MBTdNgmiY8z2MzbUYhiiLyPMd5nliWBfu+4/v9sp+8n8+HYVQXjuNgA2UK+lOaSsYoin7/6/s+v4AGU402vHoIdAH/AOdKbH6gd91XAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e2b34eda87dc1bf2f29cbe237be8f562/8ac56/system-windbg-001.webp 240w,\n/static/e2b34eda87dc1bf2f29cbe237be8f562/d3be9/system-windbg-001.webp 480w,\n/static/e2b34eda87dc1bf2f29cbe237be8f562/b0a15/system-windbg-001.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e2b34eda87dc1bf2f29cbe237be8f562/8ff5a/system-windbg-001.png 240w,\n/static/e2b34eda87dc1bf2f29cbe237be8f562/e85cb/system-windbg-001.png 480w,\n/static/e2b34eda87dc1bf2f29cbe237be8f562/0b533/system-windbg-001.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e2b34eda87dc1bf2f29cbe237be8f562/0b533/system-windbg-001.png\"\n            alt=\"!cpuinfo 拡張機能の実行結果\"\n            title=\"!cpuinfo 拡張機能の実行結果\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Intel i7-8550U は 4 コア 8 スレッドの CPU ですので、<code class=\"language-text\">!cpuinfo</code> コマンドの実行結果も 8 行になっています。</p>\n<p>CP 列の 0 から 7 までの値は各プロセッサを表しており、MHz 列は周波数を表しています。</p>\n<h2 id=\"システム情報を収集する\" style=\"position:relative;\"><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%8E%E9%9B%86%E3%81%99%E3%82%8B\" aria-label=\"システム情報を収集する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>システム情報を収集する</h2>\n<p>次に、フルメモリダンプからダンプファイルを取得した OS のシステム情報を収集します。</p>\n<p>OS のシステム情報については、ユーザが実行しているプロセスにコンテキストを合わせた状態で <code class=\"language-text\">!peb</code> コマンドを実行することで、PEB に含まれるユーザの環境変数の情報から参照することが可能です。</p>\n<p>実際に、今回の解析対象のフルメモリダンプからも、以下のようにコンピュータ名や CPU の数、PATH 環境変数やユーザ名などの情報を取得することができました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> !peb\n{{ 省略 }}\nEnvironment:  000001d5a58027f0\n  ...\n  COMPUTERNAME=THINKPAD-X280\n  ...\n  NUMBER_OF_PROCESSORS=8\n  OS=Windows_NT\n  Path=C:\\Program Files\\Common Files\\Oracle\\Java\\javapath;C:\\WINDOWS\\system32;C:\\WINDOWS;C:\\WINDOWS\\System32\\Wbem;C:\\WINDOWS\\System32\\WindowsPowerShell\\v1.0\\;C:\\WINDOWS\\System32\\OpenSSH\\;C:\\Program Files\\Intel\\WiFi\\bin\\;C:\\Program Files\\Common Files\\Intel\\WirelessCommon\\;C:\\WINDOWS\\ServiceProfiles\\NetworkService\\AppData\\Local\\Microsoft\\WindowsApps\n  ...\n  PROCESSOR_ARCHITECTURE=AMD64\n  PROCESSOR_IDENTIFIER=Intel64 Family 6 Model 142 Stepping 10, GenuineIntel\n  ...\n  USERDOMAIN=THINKPAD-X280\n  USERDOMAIN_ROAMINGPROFILE=THINKPAD-X280\n  USERNAME=Win10\n  USERPROFILE=C:\\Users\\Win10</code></pre></div>\n<p>さらに、本書の「付録 A WinDbg の Tips」で紹介している MEX 拡張機能<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup>の <code class=\"language-text\">!mex.ver</code> コマンドや <code class=\"language-text\">!mex.computername</code> コマンドを使用することでも、システムの OS 情報やコンピュータ名の情報を収集できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># MEX 拡張機能による OS のバージョン情報の確認\n0: kd> !mex.ver\nPlatform ID: 2\nMajor Version: 10\nMinor Version: 0\nWinXP: False\nWin2K3: False\nWin2k3SP1OrNewer: True\nVista: False\nVistaOrNewer: True\nWin7: False\nWin8: False\nBlue: False\n19041.1.amd64fre.vb_release.191206-1406\nBuild Number: 19041\nKernel Start Address: ffff800000000000\nSystem Version Build String: 19041.1.amd64fre.vb_release.191206-1406\n\n# MEX 拡張機能によるコンピュータ名の確認\n0: kd> !mex.computername\nComputer Name: THINKPAD-X280</code></pre></div>\n<h2 id=\"システムのレジストリ情報を探索する\" style=\"position:relative;\"><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E3%83%AC%E3%82%B8%E3%82%B9%E3%83%88%E3%83%AA%E6%83%85%E5%A0%B1%E3%82%92%E6%8E%A2%E7%B4%A2%E3%81%99%E3%82%8B\" aria-label=\"システムのレジストリ情報を探索する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>システムのレジストリ情報を探索する</h2>\n<p>Windows システムの場合、OS やアプリケーションの設定や、その他の様々な情報はレジストリに保存されています。</p>\n<p>そのため、フルメモリダンプを解析してレジストリハイブを探索することで、システムや設定に関するほとんどの情報にアクセスできます。</p>\n<p>WinDbg でフルメモリダンプからレジストリの検索を行うためには <code class=\"language-text\">!reg</code> 拡張機能<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup>を使用します。 </p>\n<p>例えば、以下のステップでコマンドを実行することで <code class=\"language-text\">!reg</code> 拡張機能を使用してフルメモリダンプから指定のレジストリ値を探索できます。</p>\n<ol>\n<li><code class=\"language-text\">!reg hivelist</code> コマンドを使用して、システム内のレジストリハイブのアドレスを取得する</li>\n<li><code class=\"language-text\">!reg openkeys &lt;ハイブのアドレス></code> コマンドを使用して、正確なハイブ名やキー制御ブロック(KCB)のアドレスを取得する</li>\n<li><code class=\"language-text\">!reg querykey &lt;ハイブ名></code> コマンドを使用して、サブキーのアドレス情報を取得する</li>\n<li><code class=\"language-text\">!reg keyinfo &lt;ハイブのアドレス> &lt;サブキーのアドレス></code> コマンドを使用してサブキー内のキーとレジストリ値を取得する</li>\n</ol>\n<p>このコマンドを使用して、実際に今回の解析対象のフルメモリダンプから適当なレジストリの情報を取得してみます。</p>\n<p>まずは、<code class=\"language-text\">!reg hivelist</code> コマンドでシステム内のレジストリハイブの情報を列挙します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ceef47beab3b33b70571ad495ffb9d6d/0b533/system-reg-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABj0lEQVQoz3WS2YrCQBRE8/+f5W5co8Z9J7hmcVf0oYZzh4RBGEE6dBdV51a3s91uFcexTqeT7ve7rterbreb/b/3LpeL7Z3PZ1tfr5ftsaJ5Pp9yXNfVYrHQfr/XbDaT53lqNptKkkRBEGiz2aher8v3fU2nU1UqFQ2HQ9MBgw4gQt7vt5xSqWSGHGDYbrfN4PF4KAxDHY9HVatV9Xo9LZdLoZ9MJpkpQcVi0XT8nHw+b0YkzOdz1Wo1o8CQPxSFQsGC0OVyOY3HY/X7fdNhyDdAZsgmhHSwWq1s3EajYX3QG1WggZBACBkdSkL4Xq/XFm6GpCOkXA4xo1cM6QRCpmA8CNFD2O12rQpMmYp6MkK6gRDS9FK4uc/no91uZ1QYcI6e4MFgYDrIOctGplAIGQ8CCEnEMCWEKiVEDyHdQYieS4yi6NewXC5bMu+NlREQ/UeInv4wRYeesIyQfv52SNo34XeHo9Eo67DVatnovEUzxIAHzLPhlumk0+lkhIfDwQLojNtEDwDvEB37rOnIP0kTGOJKKiOPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ceef47beab3b33b70571ad495ffb9d6d/8ac56/system-reg-001.webp 240w,\n/static/ceef47beab3b33b70571ad495ffb9d6d/d3be9/system-reg-001.webp 480w,\n/static/ceef47beab3b33b70571ad495ffb9d6d/b0a15/system-reg-001.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ceef47beab3b33b70571ad495ffb9d6d/8ff5a/system-reg-001.png 240w,\n/static/ceef47beab3b33b70571ad495ffb9d6d/e85cb/system-reg-001.png 480w,\n/static/ceef47beab3b33b70571ad495ffb9d6d/0b533/system-reg-001.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ceef47beab3b33b70571ad495ffb9d6d/0b533/system-reg-001.png\"\n            alt=\"レジストリハイブの列挙\"\n            title=\"レジストリハイブの列挙\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>画像の縮尺だと読みづらいかとは思いますが、出力結果の 7 行目に FileName が <code class=\"language-text\">emRoot\\System32\\Config\\SOFTWARE</code> となっているハイブの情報が表示されています。(FileName の列は字数制限でパスの末尾 32 文字しか表示されません。)</p>\n<p>これは、既定の SOFTWARE ハイブのパスである <code class=\"language-text\">%SystemRoot%\\System32\\Config\\SOFTWARE</code> と一致します。<sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup></p>\n<p>つまり、<code class=\"language-text\">HKEY_LOCAL_MACHINE\\SOFTWARE</code> と対応するレジストリを探索する場合は、7 行目の HiveAddr に表示されているアドレス 0xffffa58428b62000 を使用すればよいことがわかります。</p>\n<p>次に、取得した SOFTWARE ハイブの HiveAddr を使用して <code class=\"language-text\">!reg openkeys ffffa58428b62000</code> コマンドを実行します。</p>\n<p><code class=\"language-text\">!reg openkeys</code> コマンドは引数無しでも実行できますが、出力結果が非常に多くなるため解析対象のハイブアドレスを指定しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> !reg openkeys ffffa58428b62000\n\nHive: \\REGISTRY\\MACHINE\\SOFTWARE\n===========================================================================================\nIndex 0: \t 00000000 kcb=ffffa5842b2d1d50 cell=00000020 f=002c0000 \\REGISTRY\\MACHINE\\SOFTWARE\nIndex 1: \t f386608f kcb=ffffa584316e1d00 cell=017c4288 f=00200000 \\REGISTRY\\MACHINE\\SOFTWARE\\SYNAPTICS\\SYNTPENH\\ZONECONFIG\\DEFAULTS\\PALMCHECK GROUP\\2FVSCROLL ZONE\n\t\t 8a10ced9 kcb=ffffa5842d346350 cell=80008f90 f=00200000 \\REGISTRY\\MACHINE\\SOFTWARE\\MICROSOFT\\WINDOWS\\CURRENTVERSION\\APPMODEL\\STATEREPOSITORY\\CACHE\\PACKAGEEXTERNALLOCATION\nIndex 2: \t 5c8055db kcb=ffffa58433820390 cell=002a8cf8 f=00200000 \\REGISTRY\\MACHINE\\SOFTWARE\\CLASSES\\CLSID\\{896664F7-12E1-490F-8782-C0835AFD98FC}\\INSTANCE\n{{ 省略 }}</code></pre></div>\n<p>実際にこのコマンドを実行してみると、上記のように出力結果の最初の行に <code class=\"language-text\">Hive: \\REGISTRY\\MACHINE\\SOFTWARE</code> と表示されることを確認できます。</p>\n<p>そのため、この結果を使用して <code class=\"language-text\">!reg querykey \\REGISTRY\\MACHINE\\SOFTWARE</code> コマンドを実行します。(ある程度解析に慣れている場合は、初めからこのコマンドを実行しても問題ありません。)</p>\n<p>このコマンドの出力結果は以下のようになりました。</p>\n<p>ここまでで特定したハイブアドレスの 0xffffa58428b62000 や、キー制御ブロック(KCB)のアドレス、さらにサブキーの一覧とともに SubKeyAddr が表示されていることがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> !reg querykey \\REGISTRY\\MACHINE\\SOFTWARE\n\nFound KCB = ffffa5842b2d1d50 :: \\REGISTRY\\MACHINE\\SOFTWARE\n\nHive         ffffa58428b62000\nKeyNode      0000022eaab61024\n\n[SubKeyAddr]         [SubKeyName]\n22eaab61174          Classes\n22eab25daec          Clients\n22eab5b2184          CVSM\n22eab5b244c          DefaultUserEnvironment\n22eab5b2624          Dolby\n22eab5b297c          Fortemedia\n22eab5b2b0c          Google\n22eab5b2dec          InstalledOptions\n22eab5b2e4c          Intel\n22eab5b7af4          JavaSoft\n22eab5b7b4c          Lenovo\n22eab5b8524          Microsoft\n22eac3103ac          Mozilla\n22eac310614          Nuance\n22eac31066c          ODBC\n22eac3106c4          OEM\n22eac310894          OpenSSH\n22eac31097c          Oracle\n22eac3109d4          Partner\n22eac310a2c          Policies\n22eac313854          Realtek\n22eac313d34          RegisteredApplications\n22eac3144bc          SRS Labs\n22eac31467c          Synaptics\n22eac32d2c4          Windows\n22eac32d31c          WOW6432Node\n\n Use '!reg keyinfo ffffa58428b62000 &lt;SubKeyAddr>' to dump the subkey details\n\n[ValueType]         [ValueName]                   [ValueData]\n Key has no Values</code></pre></div>\n<p>これで必要な情報を得ることができたので、最後に、<code class=\"language-text\">!reg keyinfo &lt;ハイブのアドレス> &lt;サブキーのアドレス></code> コマンドを使用してサブキー内のキーとレジストリ値を取得します。</p>\n<p>例えば、SOFTWARE ハイブ内で SubKeyAddr が 0x22eab5b8524 であるサブキー Microsoft の探索を行う場合のコマンドは <code class=\"language-text\">!reg keyinfo ffffa58428b62000 22eab5b8524</code> になります。</p>\n<p>このコマンドを実行してみると、以下のように <code class=\"language-text\">HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft</code> 内のサブキーの一覧と SubKeyAddr が表示されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> !reg keyinfo ffffa58428b62000 22eab5b8524\n\nKeyPath \t\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\n\n[SubKeyAddr]         [SubKeyName]\n22eab5b8694          .NETFramework\n22eab5fc13c          AccountsControl\n22eab5fc19c          Active Setup\n22eab5ff7dc          ActiveSync\n22eab6009ac          ADs\n22eab600a04          Advanced INF Setup\n22eab600a6c          ALG\n22eab600ce4          AllUserInstallAgent\n22eab600e94          AMSI\n・・・\n22eab79a0ec          Windows\n22eac107024          Windows Advanced Threat Protection\n22eac1073ac          Windows Defender\n22eac10bcf4          Windows Defender Security Center\n・・・</code></pre></div>\n<p>さらに深い階層のレジストリ情報を探索したい場合は、上記で取得した SubKeyAddr を指定して再度 <code class=\"language-text\">!reg keyinfo</code> コマンドを発行します。</p>\n<p>例えば、SubKeyAddr が 0x22eac1073ac であるサブキー <code class=\"language-text\">Windows Defender</code> の情報を取得する場合、実行するコマンドは <code class=\"language-text\">!reg keyinfo ffffa58428b62000 22eac1073ac</code> になります。</p>\n<p>実際にこのコマンドを実行してみると、出力結果の上部に <code class=\"language-text\">HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender</code> 内のサブキーの一覧が表示され、下部にこのレジストリキー内に存在する値の一覧が表示されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cb7580691f56033fb5dc0071dfc780ed/0b533/system-reg-002.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.916666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABbUlEQVQ4y42Sh6rCUBBE8/+/paCI0djQqMResCXBXvdxBiJifQtLbsLeszObdZbLpfX7fWWn07Fer6fzYDCw1Wplm83G4ji20+lkxO12s2/h+L6vYi6Xy2ULgkDvXDyfzzofj0e7Xq//AxYKBR1QmsvlbDqd6jKw58u/YAIWi0UVzmYzAefzuW232xebCeynwkqloiIUlkolKTwcDi8WE+gv8N0yCj3P0yxR+GjzUz6rFxAIAajRaMhyFEWaIT/jXXyDO4vFQqsBhFUZj8dSyzMMQ81yvV7f83K5fG2iGQJkdplMxlqtlkAETbLZrGbLd1aq2+1au93WmQbUJPOWZdd1ZQ9FqVTKms2mVFFEcb1eVwJiHDQejUZyQ2PEMBoYqHfoRAyHQ0un01atVgXa7/dSwHcAgNgExpGMhDpg/ERq2Q6nVqsJyCUUYhtLFE8mE6l4tyIf1+ZZYT6f1xnbJJbovNvtpIR38nFPH/MPK5vlIdst9hYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/cb7580691f56033fb5dc0071dfc780ed/8ac56/system-reg-002.webp 240w,\n/static/cb7580691f56033fb5dc0071dfc780ed/d3be9/system-reg-002.webp 480w,\n/static/cb7580691f56033fb5dc0071dfc780ed/b0a15/system-reg-002.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/cb7580691f56033fb5dc0071dfc780ed/8ff5a/system-reg-002.png 240w,\n/static/cb7580691f56033fb5dc0071dfc780ed/e85cb/system-reg-002.png 480w,\n/static/cb7580691f56033fb5dc0071dfc780ed/0b533/system-reg-002.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/cb7580691f56033fb5dc0071dfc780ed/0b533/system-reg-002.png\"\n            alt=\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender のレジストリ情報\"\n            title=\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender のレジストリ情報\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これで、フルメモリダンプからシステム内のレジストリ情報を探索することができました。</p>\n<h2 id=\"メモリリソース使用情報を調査する\" style=\"position:relative;\"><a href=\"#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E4%BD%BF%E7%94%A8%E6%83%85%E5%A0%B1%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B\" aria-label=\"メモリリソース使用情報を調査する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>メモリリソース使用情報を調査する</h2>\n<p>ここまでの項では、ハードウェアや OS の構成情報を収集しました。</p>\n<p>続いては、フルメモリダンプ取得時(システムクラッシュ発生時)のメモリリソースの使用状況を調査します。</p>\n<p>このような情報は特に、今回のようなメモリリーク事象などのパフォーマンス系の問題を調査する際に役に立ちます。</p>\n<p>まずは、システム内の仮想メモリの使用状況を調査可能な <code class=\"language-text\">!vm</code> 拡張機能<sup id=\"fnref-6\"><a href=\"#fn-6\" class=\"footnote-ref\">6</a></sup>を使用します。</p>\n<p><code class=\"language-text\">!vm</code> コマンドをオプション引数無しで実行すると、システム全体の仮想メモリ使用量に関する統計情報とプロセスごとのコミットサイズに関する情報を取得できます。</p>\n<p>今回の解析対象のフルメモリダンプをロードして <code class=\"language-text\">!vm</code> コマンドを実行することで、D4C.exe のプロセスがシステム内で最も仮想メモリ領域を消費しており、ユーザモードメモリリークが発生している可能性が高いことを特定できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/19f2114e7884b2430ee1551475271988/0b533/system-resource-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAA7klEQVQY01WM2W6CUBRF+f/fafrQIWn6YGpji8AFvJdRBoEqt1KNHbSySvCpO1kP65zsbUQrjZeU2EGGiEqa/e9IvTsOnC58/BBXGifMyTZ7ZNniJvXoadOxPvRE9ZYwrzAmTsTNxOTq4ZnbJ4uJmxJvvli+H0n1N1l3YrHquH6ccTe1sZM36k94DSvuB5+pgnLfIzLN1F5gpHGIJ2xcx8IXDsp3gTP/cj5hmS8ju60eT8UyQVgm66Ya/bDrkL6HkecFruthzufMB6RUKBUQBAFtqzn3Pf1QkFIOf4tWXwbzosARgqqqR++6YVAp/gBjfyQeUKCFCQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/19f2114e7884b2430ee1551475271988/8ac56/system-resource-001.webp 240w,\n/static/19f2114e7884b2430ee1551475271988/d3be9/system-resource-001.webp 480w,\n/static/19f2114e7884b2430ee1551475271988/b0a15/system-resource-001.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/19f2114e7884b2430ee1551475271988/8ff5a/system-resource-001.png 240w,\n/static/19f2114e7884b2430ee1551475271988/e85cb/system-resource-001.png 480w,\n/static/19f2114e7884b2430ee1551475271988/0b533/system-resource-001.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/19f2114e7884b2430ee1551475271988/0b533/system-resource-001.png\"\n            alt=\"プロセスごとの仮想メモリ使用量\"\n            title=\"プロセスごとの仮想メモリ使用量\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>仮想メモリのリソース消費状況を確認できたので、次は物理メモリのリソース消費量を調査してみます。</p>\n<p>物理メモリのリソース消費量を調査するには <code class=\"language-text\">!memusage</code> 拡張機能<sup id=\"fnref-7\"><a href=\"#fn-7\" class=\"footnote-ref\">7</a></sup>を使用できます。</p>\n<p><code class=\"language-text\">!memusage</code> 拡張機能は、Windows システムが物理メモリの管理に使用するページフレーム番号(PFN)データベースの情報を使用することで物理メモリの統計情報を出力します。</p>\n<p><code class=\"language-text\">!memusage</code> コマンドの出力結果は非常に膨大になるので、今回は概要情報のみを表示する <code class=\"language-text\">!memusage 0x08</code> コマンドを実行します。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> !memusage 0x08\nloading PFN database\nloading (100% complete)\nCompiling memory usage data (99% Complete).\n          Zeroed:   319761 ( 1279044 kb)\n            Free:      460 (    1840 kb)\n         Standby:  1669387 ( 6677548 kb)\n        Modified:    50530 (  202120 kb)\n ModifiedNoWrite:        7 (      28 kb)\n    Active/Valid:  1118305 ( 4473220 kb)\n      Transition:  1002519 ( 4010076 kb)\n      SLIST/Temp:     6687 (   26748 kb)\n             Bad:        0 (       0 kb)\n         Unknown:        0 (       0 kb)\n           TOTAL:  4167656 (16670624 kb)\n\nDangling Yes Commit:      169 (     676 kb)\n Dangling No Commit:    50768 (  203072 kb)</code></pre></div>\n<p>このコマンドを実行すると、上記の通りシステムの物理メモリ使用量に関する統計情報を取得できます。</p>\n<p>出力結果の各項目は PFN データベースに含まれる物理ページの状態に関する情報と対応しています。</p>\n<p>よく参照する一部の項目の概要について以下に記載します。<sup id=\"fnref-8\"><a href=\"#fn-8\" class=\"footnote-ref\">8</a></sup></p>\n<ul>\n<li>Zeroed：ゼロで初期化されているか、既にゼロであることが明らかな空きページ</li>\n<li>Free：空きページだが、ゼロで初期化されていないページ</li>\n<li>Standby：過去にワーキングセットに登録されていたが、現在はスタンバイページリストに追加されているページ</li>\n<li>Active または Valid：ワーキングセットの一部であるページや、非ページカーネルページ</li>\n<li>Transition：ワーキングセットや他のページリストにも存在しない一時的なページ(そのページに対して I/O 処理が行われている場合などに発生)</li>\n<li>Bad：ハードウェアエラーにより読み取り不可となったページ</li>\n</ul>\n<p>PFN データベースに関してより詳しく知りたい場合は、参考情報に記載している「インサイド Windows 第 7 版 上」がおすすめです。</p>\n<h2 id=\"稼働中のプロセスの情報を調査する\" style=\"position:relative;\"><a href=\"#%E7%A8%BC%E5%83%8D%E4%B8%AD%E3%81%AE%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B\" aria-label=\"稼働中のプロセスの情報を調査する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>稼働中のプロセスの情報を調査する</h2>\n<p>次は、システム内で稼働しているプロセスに関する情報を収集します。</p>\n<p>稼働中のプロセスに関する情報は、適切なプロセスコンテキストの設定や CPU 使用率の高騰などの問題の調査など、様々な場面で使用します。</p>\n<p>プロセスの情報収集に使用できる方法は複数ありますが、本書では一部のみ紹介します。</p>\n<p>まずは、<code class=\"language-text\">!process</code> 拡張機能<sup id=\"fnref-9\"><a href=\"#fn-9\" class=\"footnote-ref\">9</a></sup>を使用してみます。</p>\n<p>システムのフルメモリダンプなど、EPROCESS 構造体の情報を含むカーネル空間のメモリ情報を WinDbg にロードして <code class=\"language-text\">!process 0 0</code> コマンドを実行することで、システム内のすべてのプロセスの概要情報を列挙できます。</p>\n<p>このコマンドの出力結果には以下のように EPROCESS 構造体のアドレスとプロセス名が含まれます。</p>\n<p>そのため、このコマンドで取得した EPROCESS 構造体のアドレスを使用してプロセスのコンテキストを変更したり、対象プロセスのより詳細な情報を取得したりできるようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> !process 0 0\n\n**** NT ACTIVE PROCESS DUMP ****\nPROCESS ffffcb0c8a6bf080\n    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000\n    DirBase: 001ad002  ObjectTable: ffffa58427e2e600  HandleCount: 3952.\n    Image: System\n\nPROCESS ffffcb0c8a71f080\n    SessionId: none  Cid: 007c    Peb: 00000000  ParentCid: 0004\n    DirBase: 007dc002  ObjectTable: ffffa58427e5c5c0  HandleCount:   0.\n    Image: Registry\n\n{{ 省略 }}</code></pre></div>\n<p>また、すでに調査対象のプロセス名を特定できている場合は、<code class=\"language-text\">!process 0 0 &lt;プロセス名></code> とすることで、特定のプロセスのプロセスオブジェクト(EPROCESS)のアドレスを検索することも可能です。</p>\n<p>実際に D4C.exe を指定して <code class=\"language-text\">!process 0 0 D4C.exe</code> コマンドを実行してみると、D4C.exe のプロセスオブジェクトがアドレス 0xffffcb0c950ea0c0 に存在することを特定できました。(このアドレスは後ほど使用します。)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> !process 0 0 D4C.exe\n\nPROCESS ffffcb0c950ea0c0\n    SessionId: 3  Cid: 0d40    Peb: 13c75e4000  ParentCid: 3758\n    DirBase: 27cd1f002  ObjectTable: ffffa5843cdd8c00  HandleCount:  51.\n    Image: D4C.exe</code></pre></div>\n<p>ちなみに、<code class=\"language-text\">!process</code> コマンドの 1 つ目の引数にプロセスオブジェクトのアドレスを与えることでも、特定のプロセスの情報を出力させることが可能です。(0 が指定されている場合はすべてのアクティブなプロセスの情報が表示されます)</p>\n<p>そして、2 つ目の引数は表示する情報に関する Flag を意味しており、0 が指定された場合は最小限の情報のみが出力されます。</p>\n<p>一方で、2 つ目の引数に 7 を指定した場合は、プロセスに関連するスレッドやスタックバックトレースを含む詳細情報を表示できます。</p>\n<p>そのため、解析対象のプロセス名が特定できている場合には、<code class=\"language-text\">!process 0 7 D4C.exe</code> のようなコマンドを実行することでより詳細な情報を収集できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/789b4acf2e17814c210e3b87e85cb67b/0b533/system-process-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABoElEQVQoz41SiY6CQAz1//9LE090dUEFVFROFRgORQ7ftpOVxGQ3OslLO9drX9vOYrHAt6pht7MQC4GLyBHFMcIwRCRSVFWFpmnweDzA62n/Wx1lOsPBj+CcYkRRjK19wnJzRHAOIUSC6/WK2+2Guq4/I5xMJnAcG57r4n6/Y0OZ2m6AsqpldmVZSjDRO0jCbreL9XqNNEkkoU5+cc3R1BXtCyK7ky3xyWLSzmq1gkgzNHTAsnZHF96FyElhTUGb5iFryHecMdu/0GZ4OBwwXxpUx5DqFmHv+PDO1JS0QJiVEEmGJBGyllmWScvI87wF71tCVVWxmM+RpYI+pzAsB8FFwKW6ngIft9+mfCJXStY0DSrBMAywfGUyhkZBgiCgLgsURfG2sy+Euq5LIp5HJnccF5ZlwTRN2LYN3/dJavrScfYZHIzLwGft2DDZ12yGGUFRFEmUUMfZHw4GmE6nGI1GGI/HGA6H4DHr9/vynlX1ej2554T4X2e/32O73cHcbOmBKbPjC5381VqXZ4auy888Xk/LgV2aXfZZJavzPA8/vvNCve/bD58AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/789b4acf2e17814c210e3b87e85cb67b/8ac56/system-process-001.webp 240w,\n/static/789b4acf2e17814c210e3b87e85cb67b/d3be9/system-process-001.webp 480w,\n/static/789b4acf2e17814c210e3b87e85cb67b/b0a15/system-process-001.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/789b4acf2e17814c210e3b87e85cb67b/8ff5a/system-process-001.png 240w,\n/static/789b4acf2e17814c210e3b87e85cb67b/e85cb/system-process-001.png 480w,\n/static/789b4acf2e17814c210e3b87e85cb67b/0b533/system-process-001.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/789b4acf2e17814c210e3b87e85cb67b/0b533/system-process-001.png\"\n            alt=\"D4C.exe プロセスの詳細情報の出力\"\n            title=\"D4C.exe プロセスの詳細情報の出力\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">!for_each_process</code> 拡張機能<sup id=\"fnref-10\"><a href=\"#fn-10\" class=\"footnote-ref\">10</a></sup>も、オプション引数なしで実行した場合には <code class=\"language-text\">!process 0 0</code> と同等の情報を出力します。</p>\n<p>ただし、システム内でアクティブなすべてのプロセスに対して任意のデバッガコマンドを発行できる点が <code class=\"language-text\">!process</code> 拡張機能との違いです。</p>\n<p>例えば、<code class=\"language-text\">!for_each_process \".echo @#Process\"</code> コマンドを実行すると、すべてのプロセスのプロセスオブジェクトのアドレスを出力できます。(<code class=\"language-text\">!for_each_process</code> のコマンド文字列内では、<code class=\"language-text\">@#Process</code> が自動的にプロセスオブジェクトのアドレスに置換されます。)</p>\n<p>そのため、<code class=\"language-text\">!for_each_process \".process /r /p @#Process; lm\"</code> のようなコマンドを実行すると、すべてのアクティブなプロセスにプロセスコンテキストを変更して <code class=\"language-text\">lm</code> コマンドを実行する、といった操作が可能になります。</p>\n<p>さらに高度な応用として <code class=\"language-text\">!for_each_process \".process @#Process; dt ntdll!_EPROCESS @#Process Peb->ProcessParameters->CommandLine\"</code> のようなコマンドを使用できます。</p>\n<p>これは、<code class=\"language-text\">!for_each_process</code> で取得したすべてのプロセスの EPROCESS 構造体から PEB の情報を取得し、コマンドラインの情報を列挙しています。</p>\n<p>このように、<code class=\"language-text\">!for_each_process</code> はプロセスの列挙を行う際に非常に柔軟なコマンドを発行できます。</p>\n<p>また、システム内のプロセスを列挙する場合には、MEX 拡張機能に含まれる <code class=\"language-text\">!mex.tlist</code> なども非常に便利です。</p>\n<p><code class=\"language-text\">!mex.tlist</code> コマンドを実行すると、以下のように PID やプロセスオブジェクトのアドレス、そしてプロセス名をフォーマットして出力できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5488e9f872ac4cbd0e1da97b6fc5ec51/0b533/system-process-002.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 106.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADPUlEQVQ4y4VUaVPaABDN//8t7Wg9avvBqRyCnDm4CYIiIAJCCCAox+u+xaRa7dSZHZiJebxr17DdHsbjMYbDIUbDAUrNe9R6M8wXT8Buje1mDbe/gP/0jPXLM56f/z3r9RpGqVLDYrFAs9nCbrtBtesjWhrgqjaSGaLY9lAoVXF/38dqtcJ8Ptf//2yWyyWMbCYD3/eRzeXkcwq7s8Sx7eHQnODInuJXxUM6nYZj2/rC//6MWCyOdruNnAD2el0Uuyt8dyY4tiY4kUm4UxSKRQVsNpvYbDb64m63+3SMeDyOTqeDTDaL4eABBQE8tSc6B/kJYrUpHMdBsVBAUYBHo9E7wL+/G5FIRBkmr64U0O6scGSOcSTsvonseN1HIplELBZDQUBd11UfA6APgGTY7XbVw9ubFoq9veQTYXjmeEg1Z0ilM8iI12SYz+dDwLegoYdkeHd3B8uy4NbrKpmAZwVPQROuj5yAmKaJUqmkTLNiz+3trSR//7lkAublhXqtqoAEOhXQn0UPyYYv/uaQFwUEvLy8BFXZElK/3/8Q0DtAt157rc1ERxkKYFokk1XAMBqN4ko8r4uiIPVQMh8wZf4iAa07AbTGCvglO0aEKUsY9C4rTAmcSqXQaDQwnU7VT/aT8/LyAoMPGQoBKdlsLyXdsc5XAYxJypY8o8dkSOCbmxv1j+v68PCgw+/8ASMplSBD07TQal6jJCn/lEB+yLA6THkPaGrKTJsBMZRPN+Xi4kI9ZJLX1w044uGfYu8ZBpLJkpKphiw9z/vQR4MmayjyAj1kymeSMKtzJMUmYCaThcUWSAiJRCKUTx8pl5YxcfoZbgoB6SFT5g6fvKYcq0+VPXedm8J95rkjOx6V7Xar7PgZMiQgd7laKevqMWUNRiRfur4+y/DiOAWV3Gq1FJB7HdxS3sPQQ1Img0Dy6Su7g9xYe8i1ZBC8Oiw2JQ8GA61KcAuDPiqgXhvxqVat6C5zSzgMJf5m9crlcrgpvED07+2fSj4/P99LljqQocNrw2Jb+2LTQ16ioC48tpVKRVN+fHzUs//2RipDdopbQIaszfFrKIdyD6OyKWm9NmmtS3DGKJke8nM2m4WAvwHGffI5oWAX+gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/5488e9f872ac4cbd0e1da97b6fc5ec51/8ac56/system-process-002.webp 240w,\n/static/5488e9f872ac4cbd0e1da97b6fc5ec51/d3be9/system-process-002.webp 480w,\n/static/5488e9f872ac4cbd0e1da97b6fc5ec51/b0a15/system-process-002.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/5488e9f872ac4cbd0e1da97b6fc5ec51/8ff5a/system-process-002.png 240w,\n/static/5488e9f872ac4cbd0e1da97b6fc5ec51/e85cb/system-process-002.png 480w,\n/static/5488e9f872ac4cbd0e1da97b6fc5ec51/0b533/system-process-002.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/5488e9f872ac4cbd0e1da97b6fc5ec51/0b533/system-process-002.png\"\n            alt=\"!mex.tlist によるプロセス一覧の取得\"\n            title=\"!mex.tlist によるプロセス一覧の取得\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>他にも、MEX 拡張機能に含まれる非常に便利なコマンドとして <code class=\"language-text\">!mex.commandline -a</code> があります。</p>\n<p>これは、システム内でアクティブなすべてのプロセスのコマンドラインを列挙できるコマンドです。</p>\n<p>このコマンドを実行することで、以下のようにすべてのプロセスのアドレスと実行時のコマンドラインの情報を出力できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b14eef29ffe42faae6ef5a8618c9d7f7/0b533/system-process-004.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABmklEQVQoz32SWWvCUBCF8///SB8LpbVQ2roXrEtioiZxS8zimhpNBEGUU89UQ+1DLxzu3IT57pmZqxR6K3zYEUzLhqap8H0fk8kEnudhsVhgu90iTVMRYyqOYzknSXIj/lPu1Rgv5g6O66FSLkM3DDiOA9d1Bbjf77Hb7XA4HMB1Op3+lfJsxCj2U3h+gGq1gmaziW63C+MCNk1TYsJns1nmjvtvp4w3mw2U3AU48QKUSyU0Go1z6RparRYGg4HAa7WagBmrqpq1goC/S3nSYxTsW2C73RYR2Ov1BNLpdGSn2yAIsFqtMB6PsVwupR1XKQ9ajFczEWCpVMwcMtm2bQHQLUWnhLD06XSK4XAovQ7DUC5hr8Xhu5XC9XwUiwXU6/UbIJ0SRqe8bDQaiTs6I4Rls4fcBfh4Br5ZCbwgRKVSzkomsN/vC4AwxuwhzxzAer3OXgLPhB6Px5+hFDiU85Tz+bwACbu6upbNoViWJeJ3iuUTfB0Qocrd5xdyxhbhdCYwXdclmQl0wMHQMR3yGc3nc4FEUSSgv+sbWF3VbSTE66MAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b14eef29ffe42faae6ef5a8618c9d7f7/8ac56/system-process-004.webp 240w,\n/static/b14eef29ffe42faae6ef5a8618c9d7f7/d3be9/system-process-004.webp 480w,\n/static/b14eef29ffe42faae6ef5a8618c9d7f7/b0a15/system-process-004.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b14eef29ffe42faae6ef5a8618c9d7f7/8ff5a/system-process-004.png 240w,\n/static/b14eef29ffe42faae6ef5a8618c9d7f7/e85cb/system-process-004.png 480w,\n/static/b14eef29ffe42faae6ef5a8618c9d7f7/0b533/system-process-004.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b14eef29ffe42faae6ef5a8618c9d7f7/0b533/system-process-004.png\"\n            alt=\"プロセスのコマンドライン情報の列挙\"\n            title=\"プロセスのコマンドライン情報の列挙\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>WinDbg でプロセスの一覧を取得する方法は他にもありますが、基本的には上記のいずれかを使用しておけば困ることはないでしょう。</p>\n<p>次に、特定のプロセスにプロセスコンテキストを変更した上でより詳細な情報を参照していきます。</p>\n<p>プロセスコンテキストの変更は <code class=\"language-text\">.process /r /p &lt;プロセスオブジェクトのアドレス></code> で行うことが可能です。</p>\n<p>先ほど特定した D4C.exe のプロセスにコンテキストを変更する場合は <code class=\"language-text\">.process /r /p 0xffffcb0c950ea0c0</code> コマンドを実行します。</p>\n<p>プロセスコンテキストの変更に成功したかどうかを確認するには、<code class=\"language-text\">!peb</code> や <code class=\"language-text\">lm</code> などのコマンドを実行してみるとよいでしょう。</p>\n<p>これらのコマンドはデバッガのプロセスコンテキストに基づいて情報を出力するため、D4C.exe に関する情報が出力された場合には、プロセスのコンテキストを正常に変更できたと判断できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a612bd29deed41ea810d1127fa46debb/0b533/system-process-003.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABdElEQVQoz11S226CQBTk/z+nP9C3RoLFekFRQEQRJCB38RacMqeBtN1ksrtnz23mrGKaJlzXxeFwwGw2w2KxwPF4FDiOg81mA/pst1tMp1O53+93cL1erz/gUvb7PaIoQhzHA06nEy6Xizi0bSvoz7+D/y/aFSbI81xQFAXqukaWZbKnaYqyLAewCP2appE3gr7McbvdfjocjUZCdTweY7lcShBBWpZlwTAMJEkiBcgkCAJJyjNl4Z2JB8q+7wtFoj/33fT0aafN87zu/iMPk/EtDEMp2Mco7IJYr9dSjcPhAKgtnRlEGzuiT9j5cIj9IEmZOwfHeIVTZWVWqKpK9CGl3W6H6/Uq2pAu3zkUJ3nCz56IqhZB/kBzqSVm0JDa8Tswqa7rUFVVOqF9Pp9Lt5qmdXcN53MK1W3wbhYwggZWWMN2XEwmuuSgFMpqtYJt20KN/47JqBn/G2mRNs+UhQw+vQZvXxk+nApx+ei09MEcfCezbxu4nb1zkQDPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a612bd29deed41ea810d1127fa46debb/8ac56/system-process-003.webp 240w,\n/static/a612bd29deed41ea810d1127fa46debb/d3be9/system-process-003.webp 480w,\n/static/a612bd29deed41ea810d1127fa46debb/b0a15/system-process-003.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a612bd29deed41ea810d1127fa46debb/8ff5a/system-process-003.png 240w,\n/static/a612bd29deed41ea810d1127fa46debb/e85cb/system-process-003.png 480w,\n/static/a612bd29deed41ea810d1127fa46debb/0b533/system-process-003.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a612bd29deed41ea810d1127fa46debb/0b533/system-process-003.png\"\n            alt=\"プロセスコンテキストの変更\"\n            title=\"プロセスコンテキストの変更\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>前述の通りプロセスのコマンドを変更することで、ユーザモードプロセスダンプを解析した際と同じように <code class=\"language-text\">!peb</code> や <code class=\"language-text\">lm</code> コマンドなどによってプロセスの詳細情報を調査することができるようになります。</p>\n<h2 id=\"特定のプロセスのスタックバックトレースを調査する\" style=\"position:relative;\"><a href=\"#%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%90%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B\" aria-label=\"特定のプロセスのスタックバックトレースを調査する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>特定のプロセスのスタックバックトレースを調査する</h2>\n<p>システムのプロセス情報を列挙してデバッガのプロセスコンテキストを変更することができたので、次は特定のプロセスのスタックバックトレースの情報を取得します。</p>\n<p>すでに <code class=\"language-text\">!process 0 7 D4C.exe</code> コマンドでプロセスのすべてのスレッドのスタックバックトレースを出力可能であることは前項で確認済みですが、ここではあえて <code class=\"language-text\">k</code> コマンドによる情報取得を実施します。</p>\n<p>しかし、前項までの手順でデバッガのプロセスコンテキストを D4C.exe に設定しても、実行スレッドのスタックバックトレースを出力する <code class=\"language-text\">k</code> コマンドは D4C.exe の情報を出力しません。</p>\n<p>これは、<code class=\"language-text\">k</code> コマンドはデバッガのレジスタコンテキストに依存しているためです。<sup id=\"fnref-11\"><a href=\"#fn-11\" class=\"footnote-ref\">11</a></sup></p>\n<p>そのため、まずは <code class=\"language-text\">.thread</code> コマンド<sup id=\"fnref-12\"><a href=\"#fn-12\" class=\"footnote-ref\">12</a></sup>を使用してデバッガのレジスタコンテキストを変更します。</p>\n<p><code class=\"language-text\">.thread</code> コマンドでレジスタコンテキストを変更するためには、変更対象のスレッドのアドレスを指定する必要があります。</p>\n<p>システムのフルメモリダンプからプロセスのスレッドを探索する方法はいくつかありますが、前項で紹介した <code class=\"language-text\">!process</code> 拡張機能を使用する方法が簡単です。</p>\n<p><code class=\"language-text\">!process</code> 拡張機能でプロセスのスレッド情報を表示するには、オプション引数の Flag に 2 を指定します。(すべての情報を出力できる 7 を使用することも可能です)</p>\n<p><code class=\"language-text\">!process</code> 拡張機能で D4C.exe のプロセスのスレッド情報を取得する場合、<code class=\"language-text\">!process 0 2 D4C.exe</code> コマンドを実行します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4a2d1adf33347305d7035d5c8967341c/0b533/system-thread-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.750000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABR0lEQVQY0z2R2W7jMAxF/f8/lqdBkXRcJ95XeZPX2BmvOZVddAQcEKSIS15JM00TwzD4q+vYts3t9kkQhOz7zrquTOvOOO8qvn/yaWLdNpXD/ob3yfs/2uVy4Xq94vs+D+MLkUQkcUhZZHiei6gGPizB3c+xLAvXsc/7uycoZc22TGxqwO/R+r5XTQ6OF2BGFaF84eWqlj1pmlYJ5zS1pGsb2oNhxpf/SKoRvxjJ2om6qpBSUjcN2qEqZYmrBK0gQ7djdCfGETVBGJGmGcfQYRx5KZ6vhbxfqceN8rmpuNJ1nRrWMgwD2uE7FQLT8XjENTev5CuosESPEKmyF/8Iqua+a5GdciBnonrGLSdEM1Op7YqiODk3zNIU03b5tBM+7iF/jADdy4miGEt92kPhuu4peFiOmoWsW0jahbJf1JPUSGW7UZa/AU05wdFI6wRkAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4a2d1adf33347305d7035d5c8967341c/8ac56/system-thread-001.webp 240w,\n/static/4a2d1adf33347305d7035d5c8967341c/d3be9/system-thread-001.webp 480w,\n/static/4a2d1adf33347305d7035d5c8967341c/b0a15/system-thread-001.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4a2d1adf33347305d7035d5c8967341c/8ff5a/system-thread-001.png 240w,\n/static/4a2d1adf33347305d7035d5c8967341c/e85cb/system-thread-001.png 480w,\n/static/4a2d1adf33347305d7035d5c8967341c/0b533/system-thread-001.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4a2d1adf33347305d7035d5c8967341c/0b533/system-thread-001.png\"\n            alt=\"D4C.exe のスレッド情報を表示\"\n            title=\"D4C.exe のスレッド情報を表示\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これによって、D4C.exe のプロセスと紐づく 3 つのスレッドのアドレスがそれぞれ 0xffffcb0c93f24080 と 0xffffcb0c93d17080、そして 0xffffcb0c95645080 であることを特定できました。</p>\n<p>これで、特定した 3 つのアドレスを使用してスレッドコンテキストを設定することで、<code class=\"language-text\">k</code> コマンドにより D4C.exe のスレッドのスタックバックトレースの情報を参照できるようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 1 つめのスレッドコンテキストを設定してスタックバックトレースを出力\n0: kd> .thread 0xffffcb0c93f24080; k\nImplicit thread is now ffffcb0c`93f24080\n  *** Stack trace for last set context - .thread/.cxr resets it\n # Child-SP          RetAddr               Call Site\n00 ffffef81`2c6ef5e0 fffff806`72e1bca0     nt!KiSwapContext+0x76\n01 ffffef81`2c6ef720 fffff806`72e1b1cf     nt!KiSwapThread+0x500\n02 ffffef81`2c6ef7d0 fffff806`72e1aa73     nt!KiCommitThreadWait+0x14f\n03 ffffef81`2c6ef870 fffff806`73201b11     nt!KeWaitForSingleObject+0x233\n04 ffffef81`2c6ef960 fffff806`73201a6a     nt!ObWaitForSingleObject+0x91\n{{ 省略 }}\n\n# 2 つめのスレッドコンテキストを設定してスタックバックトレースを出力\n0: kd> .thread 0xffffcb0c93d17080; k\nImplicit thread is now ffffcb0c`93d17080\n  *** Stack trace for last set context - .thread/.cxr resets it\n # Child-SP          RetAddr               Call Site\n00 ffffef81`2c7476e0 fffff806`72e1bca0     nt!KiSwapContext+0x76\n01 ffffef81`2c747820 fffff806`72e1b1cf     nt!KiSwapThread+0x500\n02 ffffef81`2c7478d0 fffff806`72ef51a4     nt!KiCommitThreadWait+0x14f\n03 ffffef81`2c747970 fffff806`732b1d20     nt!KeWaitForAlertByThreadId+0xc4\n04 ffffef81`2c7479d0 fffff806`730105f5     nt!NtWaitForAlertByThreadId+0x30\n{{ 省略 }}\n\n# 3 つめのスレッドコンテキストを設定してスタックバックトレースを出力\n0: kd> .thread 0xffffcb0c95645080; k\nImplicit thread is now ffffcb0c`95645080\n  *** Stack trace for last set context - .thread/.cxr resets it\n # Child-SP          RetAddr               Call Site\n00 ffffef81`2c847310 fffff806`72e1bca0     nt!KiSwapContext+0x76\n01 ffffef81`2c847450 fffff806`72e1b1cf     nt!KiSwapThread+0x500\n02 ffffef81`2c847500 fffff806`72e1aa73     nt!KiCommitThreadWait+0x14f\n03 ffffef81`2c8475a0 fffff806`72ff1494     nt!KeWaitForSingleObject+0x233\n04 ffffef81`2c847690 fffff806`732011ab     nt!IopWaitForSynchronousIoEvent+0x50\n{{ 省略 }}</code></pre></div>\n<p>さらに、スレッドオブジェクトのアドレスを <code class=\"language-text\">!thread</code> 拡張機能<sup id=\"fnref-13\"><a href=\"#fn-13\" class=\"footnote-ref\">13</a></sup>の引数として与えることで、スレッドコンテキストを変更しなくても対象スレッドの実行時間やスタックバックトレースをまとめて表示できます。</p>\n<p>以下は、<code class=\"language-text\">!thread 0xffffcb0c93d17080</code> コマンドを実行した場合の出力結果です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2351d31a38a34156ad37b3381da4e24e/0b533/system-thread-002.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABAUlEQVQY04WRWWuEQBCE/f9/zBfvA13HNSibXR0luh54W7EbhIQ8ZKD4XrqrqxjFclxESYqXrJA9Xvh6d3j3I+p2QNd1mKYJ4zhinmfmTy3LAnrHcbDoKZZl4fn5QNM0CMQHnrlEVUpM58K6rvjvXWaXFMdxcLvd4HkeRBThfo8hRIwsy1CWJfq+/6VhGFDXNaff9/3PAcU8E7quC0oqhEBVVdA0DbquMw3DYJqmyaTjNKuqKjPPc65O2rYNCi3ats0LYRiiKAo2uQyItEgzxDiOQa2uQ0EQcAhK3rbtmdC04Ps+D0dnZapJJtcRIolMiNSCGiVJgjRNIaXkD6N0lPIbF1m6aOApsOgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2351d31a38a34156ad37b3381da4e24e/8ac56/system-thread-002.webp 240w,\n/static/2351d31a38a34156ad37b3381da4e24e/d3be9/system-thread-002.webp 480w,\n/static/2351d31a38a34156ad37b3381da4e24e/b0a15/system-thread-002.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2351d31a38a34156ad37b3381da4e24e/8ff5a/system-thread-002.png 240w,\n/static/2351d31a38a34156ad37b3381da4e24e/e85cb/system-thread-002.png 480w,\n/static/2351d31a38a34156ad37b3381da4e24e/0b533/system-thread-002.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2351d31a38a34156ad37b3381da4e24e/0b533/system-thread-002.png\"\n            alt=\"!thread 拡張機能の出力結果\"\n            title=\"!thread 拡張機能の出力結果\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ちなみに、3 章で触れた通り、Windows のスレッドは ETHREAD 構造体として表現されており、その最初のメンバである KTHREAD 構造体の中に TEB(スレッド環境ブロック) が含まれています。</p>\n<p>つまり、ここで取得したスレッドオブジェクトのアドレスを使用して <code class=\"language-text\">dt ntdll!_ETHREAD &lt;スレッドオブジェクトのアドレス> Tcb->Teb</code> コマンドを実行することで特定のスレッドオブジェクトの TEB のアドレスを簡単に参照できます。</p>\n<p>取得した TEB のアドレスを <code class=\"language-text\">!teb</code> 拡張機能の引数として与えることで、対象の TEB の情報をデバッガで出力することが可能になります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> dt ntdll!_ETHREAD 0xffffcb0c93f24080 Tcb->Teb\n   +0x000 Tcb      : \n      +0x0f0 Teb      : 0x00000013`c75e5000 Void\n\n0: kd> !teb 0x00000013c75e5000\nTEB at 00000013c75e5000\n  ExceptionList:        0000000000000000\n  StackBase:            00000013c7360000\n  StackLimit:           00000013c735c000\n  SubSystemTib:         0000000000000000\n  FiberData:            0000000000001e00\n  ArbitraryUserPointer: 0000000000000000\n  Self:                 00000013c75e5000\n  EnvironmentPointer:   0000000000000000\n  ClientId:             0000000000000d40 . 00000000000029c8\n  RpcHandle:            0000000000000000\n  Tls Storage:          000001244e6d33c0\n  PEB Address:          00000013c75e4000\n  LastErrorValue:       0\n  LastStatusValue:      c0000034\n  Count Owned Locks:    0\n  HardErrorMode:        0</code></pre></div>\n<h2 id=\"ユーザモードプロセスのヒープ情報を調査する\" style=\"position:relative;\"><a href=\"#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%BC%E3%83%89%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AE%E3%83%92%E3%83%BC%E3%83%97%E6%83%85%E5%A0%B1%E3%82%92%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B\" aria-label=\"ユーザモードプロセスのヒープ情報を調査する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ユーザモードプロセスのヒープ情報を調査する</h2>\n<p>解析対象がシステムのフルメモリダンプの場合でも、デバッガのプロセスコンテキストを適切に設定することで、<code class=\"language-text\">!heap</code> 拡張機能によるプロセスヒープの情報を参照できるようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> .process /r /p 0xffffcb0c950ea0c0\n\n0: kd> !heap\nHeap Address      NT/Segment Heap\n 1244e6d0000       NT Heap\n 1244e500000       NT Heap\n 1244e950000       NT Heap\n\n0: kd> !heap -a\nHEAPEXT: Unable to get address of ntdll!RtlpHeapInvalidBadAddress.\nIndex   Address  Name      Debugging options enabled\n  1:   1244e6d0000 \n    Segment at 000001244e6d0000 to 000001244e7cf000 (000ef000 bytes committed)\n    Segment at 000001244e810000 to 000001244e90f000 (000f8000 bytes committed)\n    Segment at 000001244e960000 to 000001244eb5f000 (001f8000 bytes committed)\n    Segment at 000001244eb60000 to 000001244ef5f000 (003f7000 bytes committed)\n{{ 省略 }}</code></pre></div>\n<p><code class=\"language-text\">!heap</code> コマンドによるユーザモードヒープの調査方法は 6 章と同じですので、ここでは割愛します。</p>\n<p>6 章と同じように適当なヒープセグメント内のヒープエントリをいくつかダンプしてみると、以下のように <code class=\"language-text\">==> Allocated addr:</code> から始まる文字列が書き込まれていることを確認できました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/82cba68fddce35c0dcfacfa398ca1593/0b533/system-heap-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABwklEQVQ4y12Tx44DMQxD5/9/Kv2Q3nvvvSE9SMDFE6Bsdg+GxrJNUaQmSKVSqtVqyufzyuVy6nQ6KpfLajabarVaGgwG6vf7Flnj8VjT6dS+9/u9Xq+XHo+HVquVzuezglAoZGAAZ7NZjUajDyCLYoVCwXKlUkmVSkWNRkPFYlGz2czAD4eDlsulrtergng8bpdh54CAOENitVo1EM/RRb1e12Kx0PF41OVyMbbEIBKJWDUYZjIZAwQAUECIsCIHCGCAsofVZrPR6XQytsQgFov9YcgBD3nkDL11CnieIvP5XO/323REv+fzqSAajRrDdDptC9F53G63P4/ZUwRAbx2Gk8nEGHKX/Ha7VQAIh7TLNwewhQFAFEAGIgCYQBfkdrudMbzdbqYhMUgkEuaet8yIAOYMvTqsiN1u1+6wX6/XZgSLQjY24XDYWoZhMpk0JmjqILRKQbpwczgjB1Pmj7HBkPv9/js2zCIMXUM3wPX6NgqnOWdsaJX5w3FG6DM2zhDqMPl2F0BfXoQ7w+HQAGGGIfwxH5fR8L/LDurz6E47a1oGBGboaRrCzCu6LrTU6/VMfKLvWf5PU5CWcZp77NHyBy1MoiteW1+BAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/82cba68fddce35c0dcfacfa398ca1593/8ac56/system-heap-001.webp 240w,\n/static/82cba68fddce35c0dcfacfa398ca1593/d3be9/system-heap-001.webp 480w,\n/static/82cba68fddce35c0dcfacfa398ca1593/b0a15/system-heap-001.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/82cba68fddce35c0dcfacfa398ca1593/8ff5a/system-heap-001.png 240w,\n/static/82cba68fddce35c0dcfacfa398ca1593/e85cb/system-heap-001.png 480w,\n/static/82cba68fddce35c0dcfacfa398ca1593/0b533/system-heap-001.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/82cba68fddce35c0dcfacfa398ca1593/0b533/system-heap-001.png\"\n            alt=\"ヒープ領域のメモリ情報をダンプ\"\n            title=\"ヒープ領域のメモリ情報をダンプ\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ここから、6 章と同じ手順で Ghidra デコンパイラを使用してヒープへの書き込みを行っている処理を調べることで、ユーザモードメモリリークの原因箇所を特定できます。</p>\n<p>ちなみに、本書では使用しませんが、ユーザモードではなくカーネルモードのメモリリーク事象を調査する場合は、<code class=\"language-text\">!pool</code> 拡張機能<sup id=\"fnref-14\"><a href=\"#fn-14\" class=\"footnote-ref\">14</a></sup>や <code class=\"language-text\">!poolused</code> 拡張機能<sup id=\"fnref-15\"><a href=\"#fn-15\" class=\"footnote-ref\">15</a></sup>などを使用してページプールや非ページプールの情報を確認します。</p>\n<h2 id=\"7-章のまとめ\" style=\"position:relative;\"><a href=\"#7-%E7%AB%A0%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"7 章のまとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7 章のまとめ</h2>\n<p>6 章と 7 章では、クラッシュを伴わない問題の原因をダンプファイルから調査する例として、ユーザモードアプリケーションのメモリリーク事象の解析を行いました。</p>\n<p>プロセスダンプの解析とは異なり、システムのフルメモリダンプから特定のプロセスのトラブルシューティングを行う場合には、適切なプロセスコンテキストやレジスタコンテキストをデバッガに設定する必要があります。</p>\n<p>この点は、はじめてダンプファイルを解析する方にとって一つのハードルになりやすい点かと思いますので、6 章の解析と比較しながらお読みいただければと思います。</p>\n<p>なお、本書ではクラッシュを伴わない問題としてユーザアプリケーションのメモリリーク事象を扱いましたが、このような問題は他にいくつもあります。</p>\n<p>例えば、CPU 使用率の高騰やプロセスのハングアップ、他にもアプリケーションのデッドロックやハンドルリーク、さらにはシステムのメモリプールの枯渇といった問題も、ダンプファイルを解析することで原因調査が可能です。</p>\n<p>これらの問題を調査する場合には、クラッシュやメモリリークとはまた違ったアプローチでのダンプファイルの解析を楽しむことができます。</p>\n<p>Vol.1 では残念ながらこれらの解析手法を紹介することができませんが、Windows のダンプファイル解析をさらに深く学びたい方は、「Welcome to WinDbg.info」の Crash Me や、NotMyFault などを使用して様々なトラブルを再現し、ダンプファイルを取得して解析を行うことをおすすめします。</p>\n<br>\n<p>Crash Me：</p>\n<p><a href=\"http://windbg.info/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://windbg.info/</a></p>\n<br>\n<h2 id=\"各章へのリンク\" style=\"position:relative;\"><a href=\"#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF\" aria-label=\"各章へのリンク permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>各章へのリンク</h2>\n<ul>\n<li><a href=\"/magical-windbg-vol1-00\">まえがき</a></li>\n<li><a href=\"/magical-windbg-vol1-01\">1 章 環境構築</a></li>\n<li><a href=\"/magical-windbg-vol1-02\">2 章 WinDbg の基本操作</a></li>\n<li><a href=\"/magical-windbg-vol1-03\">3 章 解析に必要な前提知識</a></li>\n<li><a href=\"/magical-windbg-vol1-04\">4 章 アプリケーションのクラッシュダンプを解析する</a></li>\n<li><a href=\"/magical-windbg-vol1-05\">5 章 システムクラッシュ時のフルメモリダンプを解析する</a></li>\n<li><a href=\"/magical-windbg-vol1-06\">6 章 プロセスダンプからユーザモードアプリケーションのメモリリーク事象を調査する</a></li>\n<li><a href=\"/magical-windbg-vol1-07\">7 章 フルメモリダンプからユーザモードメモリリーク事象を調査する</a></li>\n<li><a href=\"/magical-windbg-vol1-50\">付録 A WinDbg の Tips</a></li>\n<li><a href=\"/magical-windbg-vol1-51\">付録 B Volatility 3 でクラッシュダンプを解析する</a></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>バグチェック <code class=\"language-text\">0xE2:MANUALLY_INITIATED_CRASH</code> <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/bug-check-0xe2--manually-initiated-crash\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/bug-check-0xe2—manually-initiated-crash</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-2\">\n<p>!sysinfo 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-sysinfo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-sysinfo</a></p>\n<a href=\"#fnref-2\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-3\">\n<p>!cpuinfo 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-cpuinfo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-cpuinfo</a></p>\n<a href=\"#fnref-3\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-4\">\n<p>MEX 拡張機能 <a href=\"https://www.microsoft.com/en-us/download/details.aspx?id=53304\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.microsoft.com/en-us/download/details.aspx?id=53304</a></p>\n<a href=\"#fnref-4\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-4\">\n<p>!reg 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-reg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-reg</a></p>\n<a href=\"#fnref-4\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-5\">\n<p>上級ユーザー向けの Windows レジストリ情報 <a href=\"https://learn.microsoft.com/ja-jp/troubleshoot/windows-server/performance/windows-registry-advanced-users\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/troubleshoot/windows-server/performance/windows-registry-advanced-users</a></p>\n<a href=\"#fnref-5\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-6\">\n<p>!vm 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-vm\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-vm</a></p>\n<a href=\"#fnref-6\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-7\">\n<p>!memusage 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-memusage\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-memusage</a></p>\n<a href=\"#fnref-7\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-8\">\n<p>インサイド Windows 第 7 版 上 P.471 (Pavel Yosifovich, Alex Ionescu, Mark E. Russinovich, David A. Solomon 著 / 山内 和朗 訳 / 日系 BP 社 / 2018 年) </p>\n<a href=\"#fnref-8\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-9\">\n<p>!process 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-process\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-process</a></p>\n<a href=\"#fnref-9\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-10\">\n<p>!for<em>each</em>process 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-for-each-process\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-for-each-process</a></p>\n<a href=\"#fnref-10\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-11\">\n<p>k、kb、kc、kd、kp、kP、kv スタック バックトレースの表示 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/k--kb--kc--kd--kp--kp--kv--display-stack-backtrace-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/k—kb—kc—kd—kp—kp—kv—display-stack-backtrace-</a></p>\n<a href=\"#fnref-11\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-12\">\n<p>.thread レジスタコンテキストの設定 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-thread--set-register-context-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-thread—set-register-context-</a></p>\n<a href=\"#fnref-12\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-13\">\n<p>!thread 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-thread\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-thread</a></p>\n<a href=\"#fnref-13\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-14\">\n<p>!pool 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-pool\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-pool</a></p>\n<a href=\"#fnref-14\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-15\">\n<p>!poolused 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-poolused\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-poolused</a></p>\n<a href=\"#fnref-15\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","fields":{"slug":"/magical-windbg-vol1-07","tagSlugs":["/tag/magical-win-dbg/","/tag/windows/","/tag/win-dbg/"]},"frontmatter":{"date":"2023-11-15","description":"技術書典 15 で頒布した Magical WinDbg -雰囲気で楽しむ Windows ダンプ解析とトラブルシューティング- VOL.1 の WEB 版です。","tags":["Magical WinDbg","Windows","WinDbg"],"title":"Magical WinDbg VOL.1【7 章 フルメモリダンプからユーザモードメモリリーク事象を調査する】","socialImage":{"publicURL":"/static/2dbf3e09d59db889dc9dc41adcc8e827/magical-windbg-vol1.png"}}}},"pageContext":{"slug":"/magical-windbg-vol1-07"}},"staticQueryHashes":["251939775","401334301","825871152"]}