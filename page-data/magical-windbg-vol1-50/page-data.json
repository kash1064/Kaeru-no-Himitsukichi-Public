{"componentChunkName":"component---src-templates-post-template-js","path":"/magical-windbg-vol1-50","result":{"data":{"markdownRemark":{"id":"e161ae35-8dc7-53cb-8dfd-cfc876775b39","html":"<p>この章では、本書の内容に含めることができなかったデバッガ操作のテクニックをいくつか紹介します。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li><a href=\"#command-%E3%82%A6%E3%82%A3%E3%83%B3%E3%83%89%E3%82%A6%E3%81%AE%E7%B5%90%E6%9E%9C%E3%82%92%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B\">Command ウィンドウの結果をファイルに出力する</a></li>\n<li><a href=\"#windbg-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%92%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E5%8C%96%E3%81%97%E3%81%A6%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\">WinDbg コマンドをスクリプト化して実行する</a></li>\n<li><a href=\"#mex-%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B\">MEX 拡張機能を使用する</a></li>\n<li><a href=\"#%E3%83%95%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%81%8B%E3%82%89%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B\">フルメモリダンプからファイルの中身を参照する</a></li>\n<li><a href=\"#%E3%83%80%E3%83%B3%E3%83%97%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89-windbg-%E3%81%A7%E5%AE%9F%E8%A1%8C%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B\">ダンプファイルから WinDbg で実行ファイルを抽出する</a></li>\n<li><a href=\"#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF\">各章へのリンク</a></li>\n</ul>\n<h2 id=\"command-ウィンドウの結果をファイルに出力する\" style=\"position:relative;\"><a href=\"#command-%E3%82%A6%E3%82%A3%E3%83%B3%E3%83%89%E3%82%A6%E3%81%AE%E7%B5%90%E6%9E%9C%E3%82%92%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B\" aria-label=\"command ウィンドウの結果をファイルに出力する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Command ウィンドウの結果をファイルに出力する</h2>\n<p>WinDbg の Command ウインドウは、任意のファイルに実行結果を出力するように設定することが可能です。</p>\n<p>これは、WinDbg を使用した解析の履歴を保存したい場合や、出力が膨大な量になるコマンドの実行結果を WinDbg 以外の方法で解析したい場合などに便利です。</p>\n<p>WinDbg のコマンド出力結果を指定のファイルに保存したい場合、Command ウインドウにて <code class=\"language-text\">.logopen &lt;保存先のファイルのフルパス></code> コマンドを実行します。</p>\n<p>このコマンドによって、以降のコマンド実行結果が ASCII テキスト形式で指定したパスのファイルに書き込まれるようになります。</p>\n<p>書き込みを終了してファイルを閉じるには、<code class=\"language-text\">.logclose</code> コマンド実行します。</p>\n<p>上記のコマンドを実行することで、以下の画像のように出力結果がログに保存されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b7fd878508bf57c5eaaa84bfbe78ce7c/0b533/appendix-logfile-01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7EAAAOxAGVKw4bAAACH0lEQVQ4y6VT53LiQAzm/V+KACHH0AI4BGPcwQ3b2FRj2neSAgy5v7czmi32fkXSVrLNBofDAceiwH63w/l8xv+Mynq9RpZliOMYq9UKeZ7TnAmJEJUlCiLjOJ1OuN1uEtfr9RmPM47KcDiCZVoEmGC73WJDisMoQpLEiGheEZnvefAokiTB5XKRi4/xCiaAruPgeDxKlBQpXcpIJTOzopIU8o8MyGQZudhstgLM8QoslrvdLhzbgTIa4e3tDZ12B++NdywWC4yGQ1SrVQRBCFVVYVoW3PkcFs3adIoh3WE3ZXl6glYURYFNgLOZhl6vh/HXGP1+XxTpMx2fnwOxOtNmGBCB5/lI00RAHXIXBIG4ewIOBgPM3TkBKWg2m+B9u91GSKpYdaNel4JZpokuEXq+j3gZyTeVVPq057Q8AVmVoZv4IqV/Pj4EsNVqSRom39/odDqIlkuEYQDDMHCmvM1dF1MCM4jkFUxyOB6PqYo+1MkEnE+2zKBLAtGmmpwlSUppsaHrhrQP53eqTmmvY78//Kp2pUsKDMMUC7VaDbxvNBqicED5q9fqpC4kQAsKke2o+Vkh517TNCH4pXBCysJ7FX8KZFOBdORZDpcu8vmWQBiUi8OD7XPRbMemdfTomx+FbJEvsnXOSUxW83yNVZpKMRiI19zk0uj0irg/uQf5mb42ugCW96fFjfxY8/xo9qI43KMQu/yaXl/Kv439F/JazWlRGWzVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b7fd878508bf57c5eaaa84bfbe78ce7c/8ac56/appendix-logfile-01.webp 240w,\n/static/b7fd878508bf57c5eaaa84bfbe78ce7c/d3be9/appendix-logfile-01.webp 480w,\n/static/b7fd878508bf57c5eaaa84bfbe78ce7c/b0a15/appendix-logfile-01.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b7fd878508bf57c5eaaa84bfbe78ce7c/8ff5a/appendix-logfile-01.png 240w,\n/static/b7fd878508bf57c5eaaa84bfbe78ce7c/e85cb/appendix-logfile-01.png 480w,\n/static/b7fd878508bf57c5eaaa84bfbe78ce7c/0b533/appendix-logfile-01.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b7fd878508bf57c5eaaa84bfbe78ce7c/0b533/appendix-logfile-01.png\"\n            alt=\"ログファイルに出力されたコマンド実行結果\"\n            title=\"ログファイルに出力されたコマンド実行結果\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>なお、<code class=\"language-text\">.logopen</code> コマンドでログの出力先を指定した場合、そのパスにすでにファイルが存在している場合は、既存のファイルのデータが削除され、新しいコマンド出力結果が上書きされるため注意してください。</p>\n<p>もし、既存のファイルに追記する形でコマンド出力結果を保存したい場合は、<code class=\"language-text\">.logopen</code> コマンドではなく <code class=\"language-text\">.logappend &lt;保存先のファイルのフルパス></code> コマンドを使用します。</p>\n<p>また、うっかり過去の解析結果を保存したファイルを上書きしてしまうことを避けたい場合には、<code class=\"language-text\">.logopen</code> コマンドの <code class=\"language-text\">/t</code> オプションを使用することもできます。</p>\n<p><code class=\"language-text\">/t</code> オプションを使用すると、以下の例のように、指定のファイルパスに自動的に記録の開始日時に関するタイムスタンプ情報が追加されるため、既存のファイルの上書きを防ぐことが可能になります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0:000> .logopen /t C:\\Users\\Public\\windbg.log\nClosing open log file C:\\Users\\Public\\windbg.log\nOpened log file 'C:\\Users\\Public\\windbg_1058_2023-09-24_08-36-13-088.log'</code></pre></div>\n<p>どのコマンドを使用する場合も、書き込みを終了してファイルを閉じるには、<code class=\"language-text\">.logclose</code> コマンド使用します。</p>\n<p>WinDbg の出力結果の保存に関するより詳しい情報は、以下の公式ドキュメントを参照してください。</p>\n<br>\n<p>WinDbg でのログファイルの保持:</p>\n<p><a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/keeping-a-log-file-in-windbg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/keeping-a-log-file-in-windbg</a></p>\n<br>\n<h2 id=\"windbg-コマンドをスクリプト化して実行する\" style=\"position:relative;\"><a href=\"#windbg-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%92%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E5%8C%96%E3%81%97%E3%81%A6%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\" aria-label=\"windbg コマンドをスクリプト化して実行する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbg コマンドをスクリプト化して実行する</h2>\n<p>WinDbg ではスクリプト化した複雑な処理を実行することが可能です。</p>\n<p>本書でダンプファイルの解析にコマンドを使用した際には、WinDbg の Command ウインドウに単一のコマンド、もしくは セミコロン(<code class=\"language-text\">;</code>) で区切った複数のコマンドを入力して実行していました。</p>\n<p>しかし、より効率的に解析を行う場合には、複雑なコマンドを一括で実行したり、条件分岐を設定して実行するコマンドを制御したりする必要がある場合があります。</p>\n<p>例えば、以下のスクリプトはカーネルメモリ空間内の EPROCESS 構造体を列挙し、If 文を使用して D4C.exe のプロセスが見つかったときにそのアドレスのみを出力する事ができるスクリプトです。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$$  Get process list LIST_ENTRY in $t0.\nr $t0 = nt!PsActiveProcessHead\n\n$$  Iterate over all processes in list.\n.for (r $t1 = poi(@$t0);\n      (@$t1 != 0) &amp; (@$t1 != @$t0);\n      r $t1 = poi(@$t1))\n{\n    r? $t2 = #CONTAINING_RECORD(@$t1, nt!_EPROCESS, ActiveProcessLinks);\n    as /x Procc @$t2\n\n    $$  Get image name into $ImageName.\n    as /ma $ImageName @@c++(&amp;@$t2->ImageFileName[0])\n\n    .block\n    {\n\t   .if ($scmp(\"D4C.exe\",\"${$ImageName}\")) { } .else {.echo ${$ImageName} at ${Procc}}\n    }\n\n    ad $ImageName\n    ad Procc\n}</code></pre></div>\n<p>このスクリプトを <code class=\"language-text\">C:\\Users\\Win10\\Downloads\\windbg_script.txt</code> として保存し、WinDbg で以下のように呼び出すことで実行できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">6: kd> $$>a&lt;C:\\Users\\Win10\\Downloads\\windbg_script.txt\nD4C.exe at 0xffffc18f45284080</code></pre></div>\n<p>なお、スクリプトの呼び出しコマンド<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>や、このスクリプト内で使用している条件分岐<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup>とループ<sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup>の構文、またエイリアス<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup>や疑似レジスタ<sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup>の使用方法については、本書では詳しく解説しません。</p>\n<p>各コマンドの詳細については公開ドキュメントの情報を参照してください。</p>\n<h2 id=\"mex-拡張機能を使用する\" style=\"position:relative;\"><a href=\"#mex-%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B\" aria-label=\"mex 拡張機能を使用する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MEX 拡張機能を使用する</h2>\n<p>MEX 拡張機能は、Microsoft が公式に提供している WinDbg 用の拡張機能です。</p>\n<p>MEX 拡張機能のいくつかのコマンドについては 7 章で使用しました。</p>\n<p>本書で実施した程度の解析であれば MEX 拡張機能を使用する必要はありませんが、覚えておくと便利かと思います。</p>\n<p>MEX 拡張機能を利用するにはまず、以下の URL からダウンロード可能な Mex.exe を Windows システムで実行します。</p>\n<br>\n<p>Download MEX Debugging Extension from Official Microsoft Download Center:</p>\n<p><a href=\"https://www.microsoft.com/en-us/download/details.aspx?id=53304\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.microsoft.com/en-us/download/details.aspx?id=53304</a></p>\n<br>\n<p>次に、利用規約に同意した後に表示されるウィンドウで任意のフォルダパスを指定し、MEX 拡張機能のモジュールを配置します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c75e8c47f84c63428c00b284e2b7ec7a/0b533/MEX-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7EAAAOxAGVKw4bAAABbklEQVQoz22R7WriQBiFc9NegJewa//4xwtoC34gmGDW0n8ioqDRNB8qJnFjKiaxpuJHu89OBrIg7MDDOcMMw5nzKr1eD1XtoHU1uoJOR0XVNHovL4xGozvG4zHD4ZDBYCB9of1+X56Xy2WUNE15370TbHx2u0iwI4oi4iTh9vXF7Xbjer1KLXyxP51OXITPNV+1Wg1ltVrhui6O4+B5HsvlUvpCTdNkPp9jWdY/tW0H17GxLVPwxtJ14M83lUoFJU8ThiG+77PZbAiCQCbcbrfs93uyLLvjeMz4zI54UcJ8FWI4HobrE8QnKg8PKLZtM51OJYZhMJlMmM1mUtfrNYfDgTiOJYmoIUlS0mQvH3sdL+j2DX4NTGbBBz9+ioT53y+Xy103hT+fz7KfPFmeeLFYSPKe0zThd7jlTXzfEuT3q9Uqiq7rYrIdMWn1v2hi4rk2m03q9bqk1WrRbrdpNBo8Pz/x9PiIrncplUr8BSyS7eMrbQRfAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/c75e8c47f84c63428c00b284e2b7ec7a/8ac56/MEX-001.webp 240w,\n/static/c75e8c47f84c63428c00b284e2b7ec7a/d3be9/MEX-001.webp 480w,\n/static/c75e8c47f84c63428c00b284e2b7ec7a/b0a15/MEX-001.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/c75e8c47f84c63428c00b284e2b7ec7a/8ff5a/MEX-001.png 240w,\n/static/c75e8c47f84c63428c00b284e2b7ec7a/e85cb/MEX-001.png 480w,\n/static/c75e8c47f84c63428c00b284e2b7ec7a/0b533/MEX-001.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/c75e8c47f84c63428c00b284e2b7ec7a/0b533/MEX-001.png\"\n            alt=\"MEX モジュールの展開\"\n            title=\"MEX モジュールの展開\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>上記で指定したパスをエクスプローラで参照すると <code class=\"language-text\">Mex.zip</code> というファイルが配置されていることを確認できるので、この ZIP ファイルを解凍してください。</p>\n<p>解凍したフォルダ内に含まれる <code class=\"language-text\">mex.dll</code> というファイルを <code class=\"language-text\">.load &lt;mex.dll のフルパス></code> コマンドで WinDbg にロードすることで、MEX 拡張機能を利用できるようになります。</p>\n<p>本書では MEX 拡張機能について詳細な解説は行いませんが、<code class=\"language-text\">!mex.help -all</code> コマンドを実行することで使用可能な各機能に関するヘルプを出力できます。</p>\n<h2 id=\"フルメモリダンプからファイルの中身を参照する\" style=\"position:relative;\"><a href=\"#%E3%83%95%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%81%8B%E3%82%89%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B\" aria-label=\"フルメモリダンプからファイルの中身を参照する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>フルメモリダンプからファイルの中身を参照する</h2>\n<p>この項ではフルメモリダンプで取得したメモリデータからファイルのデータを取得するテクニックを紹介します。</p>\n<p>Windows システムでは、キャッシュマネージャという仕組みによってファイルのコンテンツやファイルシステムのメタデータなどをキャッシュします。<sup id=\"fnref-6\"><a href=\"#fn-6\" class=\"footnote-ref\">6</a></sup></p>\n<p>このキャッシュマネージャは「仮想ブロックキャッシュ(Virtual Block Caching)」という仕組みによってどのファイルのどの部分がキャッシュ内に存在するかを追跡します。</p>\n<p>本書では、メモリにマップされたファイルオブジェクトからキャッシュマネージャの管理する「仮想アドレス制御ブロック(VACB)」と呼ばれる構造体のアドレスを特定することで、メモリ内にキャッシュされた情報からからシステム内のファイルコンテンツを抽出することを試みます。</p>\n<p>なお、この方法はフルメモリダンプで取得したメモリ内のページにキャッシュデータが存在していることを前提とするため、取得したフルメモリダンプから必ずしもファイルのコンテンツを取得できるとは限らない点に注意が必要です。</p>\n<p>フルメモリダンプからファイルコンテンツを抽出するため、まずは取得したフルメモリダンプを WinDbg にロードして <code class=\"language-text\">!memusage</code> コマンドを実行します。</p>\n<p><code class=\"language-text\">!memusage</code> コマンドの出力結果は膨大になるため、事前に <code class=\"language-text\">.logopen</code> コマンドで実行結果をファイルに出力する設定を有効化しておくことをおすすめします。</p>\n<p><code class=\"language-text\">!memusage</code> コマンドを実行して PFN データベースの情報を解析した結果、mapped_file として no-cached-file.txt と Microsoft-Windows-Windows Defender%4Operational.evtx(Microsoft Defender ウイルス対策のイベントログファイル) の存在を確認できました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> !memusage\nloading PFN database\n{{ 省略 }}\nUsage Summary (in Kb):\nControl       Valid Standby Dirty Shared Locked PageTables  name\n・・・\nffffc40861b53750     0      4     0     0     0     0  mapped_file( no-cached-file.txt )\n・・・\nffffc40861b5c350    68      0     0     0    68     0  mapped_file( Microsoft-Windows-Windows Defender%4Operational.evtx )\n・・・</code></pre></div>\n<p>ここで特定した Control の情報を参照するには <code class=\"language-text\">!ca</code> 拡張機能<sup id=\"fnref-7\"><a href=\"#fn-7\" class=\"footnote-ref\">7</a></sup>を使用します。</p>\n<p><code class=\"language-text\">mapped_file( no-cached-file.txt )</code> に対応するコントロール領域のアドレスである 0xffffc40861b53750 を使用して <code class=\"language-text\">!ca ffffc40861b53750</code> コマンドを実行したところ、以下の結果を得ることができました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ff05f77f98d57df8289c61e0929e0b30/0b533/windbg-read-file-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABRklEQVQoz3WSa8uCQBCF/f//y/wiEaZUlJVdtAuVUtndE8+AYry8C8NeZvfMOWfWWa1W2u/3ms1miqJIw+FQm81G7/db9Xi9Xno+nxbt83bu8Xjo8/nI8TxP2+1W5/NZSZJouVxqsVhYAH69XpXnuXa7nQ6HgxULgsDuQqQoip+c47quer2eTqeTxfF4tOR4PFan05Hv+7rdbg0jAMhNp1OlafrDluJOlmXNBapiAfLZMxPI+m9UVdUEw0Haer02+oDN53NjiEwqYgUMAeWMQMX9fv8BrNfmYRiGdglj60eXy8W8wVOK0QzOCGS3bajBjCFyYYhcmjAajcwCwGHFTBfbLIg6R2f/MKTLsAKIr9Ptds27wWBg+ziO7QGsJpOJ+v2+eUwTy7I0axpAvgBy8ASJsEUma74BfnJG89gTFGZmwBCmNeAXZluo2l5c/fcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ff05f77f98d57df8289c61e0929e0b30/8ac56/windbg-read-file-001.webp 240w,\n/static/ff05f77f98d57df8289c61e0929e0b30/d3be9/windbg-read-file-001.webp 480w,\n/static/ff05f77f98d57df8289c61e0929e0b30/b0a15/windbg-read-file-001.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ff05f77f98d57df8289c61e0929e0b30/8ff5a/windbg-read-file-001.png 240w,\n/static/ff05f77f98d57df8289c61e0929e0b30/e85cb/windbg-read-file-001.png 480w,\n/static/ff05f77f98d57df8289c61e0929e0b30/0b533/windbg-read-file-001.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ff05f77f98d57df8289c61e0929e0b30/0b533/windbg-read-file-001.png\"\n            alt=\"!ca で no-cached-file.txt のコントロール領域の情報を取得する\"\n            title=\"!ca で no-cached-file.txt のコントロール領域の情報を取得する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>同じく、<code class=\"language-text\">mapped_file( Microsoft-Windows-Windows Defender%4Operational.evtx )</code> に対応するコントロール領域のアドレスである 0xffffc40861b5c350 を使用して <code class=\"language-text\">!ca ffffc40861b5c350</code> コマンドを実行したところ、結果は以下のようになりました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9d4e16a72f9099898ae7d0f08c992c63/0b533/windbg-read-file-002.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABT0lEQVQoz22S646CUAyEef/nMjH4DyVGRBEv4BVEAe8ym68Jxt1sk5PTnKHTmRZntVrpcDhoOp1qOBxqNBpps9no/X6rjcfjofv9buf1euk7/mKO67rKskzn81nL5VI0iKJIi8XCGtR1rePxqP1+b43TNJXneZrNZtrtdjqdTobBwe10Oh0NBgMjzPPcigAp6PV6hqGijaqqDJvP51qv17/UotKh42QyMUWcOI6VJImKojBlNCGnEWrIy7K0HKzF+bZpGjlYZGbIJ4fwm4hCCC6Xi5Fy+BZHt9vNVOGAY4Tdble+71shRdiFjCWhnrlCwJKwy4Hser3qv3AoxCJzCcPQthwEgXVnayh4Pp/WnWhvMFSBtZs3hQweBViBaDwef2YKOeppRqAMjDeE4IQ3RvMh7Pf7ZoffA+Ltdmvr52aL5NhmzuTcNGUc3/9iS/gDMqynVyJaYIAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/9d4e16a72f9099898ae7d0f08c992c63/8ac56/windbg-read-file-002.webp 240w,\n/static/9d4e16a72f9099898ae7d0f08c992c63/d3be9/windbg-read-file-002.webp 480w,\n/static/9d4e16a72f9099898ae7d0f08c992c63/b0a15/windbg-read-file-002.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/9d4e16a72f9099898ae7d0f08c992c63/8ff5a/windbg-read-file-002.png 240w,\n/static/9d4e16a72f9099898ae7d0f08c992c63/e85cb/windbg-read-file-002.png 480w,\n/static/9d4e16a72f9099898ae7d0f08c992c63/0b533/windbg-read-file-002.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/9d4e16a72f9099898ae7d0f08c992c63/0b533/windbg-read-file-002.png\"\n            alt=\"!ca でイベントログファイルのコントロール領域の情報を取得する\"\n            title=\"!ca でイベントログファイルのコントロール領域の情報を取得する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>この出力結果から、各ファイルのパスとファイルオブジェクトのアドレスを確認できます。</p>\n<p>例えば、no-cached-file.txt の出力結果では <code class=\"language-text\">File Object  ffffc40861f5f720</code> と表示されているため、このファイルのファイルオブジェクトが 0xffffc40861f5f720 に存在していることを特定できます。</p>\n<p>また、イベントログファイルの出力結果は <code class=\"language-text\">File Object  ffffc40861920440</code> となっていることを確認できます。</p>\n<p>確認のためにこれらのアドレスを使用して <code class=\"language-text\">!fileobj</code> 拡張機能を実行することで、ファイルオブジェクトの詳細情報を参照できることを確認しておきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># no-cached-file.txt のファイルオブジェクトを調査\n0: kd> !fileobj ffffc40861f5f720\n\n\\Users\\Vuln\\Desktop\\no-cached-file.txt\n\nDevice Object: 0xffffc4085b32ec00   \\Driver\\volmgr\nVpb: 0xffffc4085b3c69c0\nAccess: Read SharedRead SharedWrite \n\nFlags:  0x44042\n\tSynchronous IO\n\tCache Supported\n\tCleanup Complete\n\tHandle Created\n\nFinal Status: 80000005\nFsContext: 0xffff83807b62d700\tFsContext2: 0xffff83807ceb2580\nCurrentByteOffset: 0\nCache Data:\n  Section Object Pointers: ffffc40861f22a98\n  Shared Cache Map: 00000000\n\n\n# イベントログファイルのファイルオブジェクトを調査\n0: kd> !fileobj ffffc40861920440\n\n\\Windows\\System32\\winevt\\Logs\\Microsoft-Windows-Windows Defender%4Operational.evtx\n\nDevice Object: 0xffffc4085b32ec00   \\Driver\\volmgr\nVpb: 0xffffc4085b3c69c0\nEvent signalled\nAccess: Read Write SharedRead \n\nFlags:  0x41042\n\tSynchronous IO\n\tCache Supported\n\tModified\n\tHandle Created\n\nFsContext: 0xffff83807a55f700\tFsContext2: 0xffff83807a55f970\nPrivate Cache Map: 0xffffc40861582b98\nCurrentByteOffset: 36a0\nCache Data:\n  Section Object Pointers: ffffc40861981b38\n  Shared Cache Map: ffffc40861582a20         File Offset: 36a0 in VACB number 0\n  Vacb: ffffc4085abd5ea0\n  Your data is at: ffff9688ea9436a0</code></pre></div>\n<p>各ファイルオブジェクトのアドレスを特定できたので、次に <code class=\"language-text\">nt!_FILE_OBJECT</code> 構造体内の情報から <code class=\"language-text\">nt!_SECTION_OBJECT_POINTERS</code> 構造体のアドレスを取得します。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># no-cached-file.txt のファイルオブジェクトを調査\n0: kd> dt nt!_FILE_OBJECT ffffc40861f5f720 SectionObjectPointer\n   +0x028 SectionObjectPointer : 0xffffc408`61f22a98 _SECTION_OBJECT_POINTERS\n\n# イベントログファイルのファイルオブジェクトを調査\n0: kd> dt nt!_FILE_OBJECT ffffc40861920440 SectionObjectPointer\n   +0x028 SectionObjectPointer : 0xffffc408`61981b38 _SECTION_OBJECT_POINTERS</code></pre></div>\n<p>さらにこのアドレスが指す <code class=\"language-text\">nt!_SECTION_OBJECT_POINTERS</code> 構造体の情報をダンプします。</p>\n<p>先に no-cached-file.txt の情報をダンプしてみると、以下のように SharedCacheMap が空であることがわかります。</p>\n<p>この場合、no-cached-file.txt はキャッシュマネージャによってキャッシュされていないため、キャッシュからコンテンツを参照することができません。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> dt nt!_SECTION_OBJECT_POINTERS ffffc408`61f22a98 \n   +0x000 DataSectionObject : 0xffffc408`61b53750 Void\n   +0x008 SharedCacheMap   : (null) \n   +0x010 ImageSectionObject : (null)</code></pre></div>\n<p>では次に、イベントログファイルの構造体情報をダンプしてみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> dt nt!_SECTION_OBJECT_POINTERS ffffc40861981b38\n   +0x000 DataSectionObject : 0xffffc408`61b5c350 Void\n   +0x008 SharedCacheMap   : 0xffffc408`61582a20 Void\n   +0x010 ImageSectionObject : (null) </code></pre></div>\n<p>こちらは SharedCacheMap に 0xffffc40861582a20 というアドレスが格納されていることがわかります。</p>\n<p>SharedCacheMap 構造体の中には VACB のアドレスが含まれています。</p>\n<p>そのため、特定した SharedCacheMap のアドレスを使用して <code class=\"language-text\">t nt!_SHARED_CACHE_MAP ffffc40861582a20 Vacbs</code> コマンドを実行することで、対象ファイルのコンテンツが含まれるキャッシュを参照するための VACB のアドレスを特定できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> dt nt!_SHARED_CACHE_MAP ffffc40861582a20 Vacbs\n   +0x058 Vacbs : 0xffffc408`61582a58  -> 0xffffc408`5abd5ea0 _VACB</code></pre></div>\n<p>上記のコマンドで特定した VACB のアドレス 0xffffc4085abd5ea0 を使用して <code class=\"language-text\">nt!_VACB</code> 構造体の情報をダンプすることで、以下の情報を取得できました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0: kd> dt nt!_VACB ffffc4085abd5ea0\n   +0x000 BaseAddress      : 0xffff9688`ea940000 Void\n   +0x008 SharedCacheMap   : 0xffffc408`61582a20 _SHARED_CACHE_MAP\n   +0x010 Overlay          : &lt;anonymous-tag>\n   +0x020 ArrayHead        : 0xffffc408`5abce000 _VACB_ARRAY_HEADER</code></pre></div>\n<p>VACB 構造体はシステムの VACB 配列によって管理されており、各 VACB エントリはシステムキャッシュ用に割り当てられている 256 KB のスロットのアドレスを記述しています。<sup id=\"fnref-8\"><a href=\"#fn-8\" class=\"footnote-ref\">8</a></sup></p>\n<p>つまり、Microsoft Defender ウイルス対策のイベントログファイルのコンテンツは、VACB の BaseAddress で確認したアドレス 0xffff9688ea940000 にキャッシュされていることがわかります。</p>\n<p>実際に <code class=\"language-text\">db 0xffff9688ea940000 L60</code> コマンドで、BaseAddress から 60 バイト分のメモリをダンプしてみると、Windows のイベントログファイル(EVTX) フォーマットのシグネチャにあたる <code class=\"language-text\">ElfFile\\x00</code> から始まるデータであることがわかります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7eaa5672a14e677b12c278b63f52b5e2/0b533/windbg-read-file-003.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.166666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAmUlEQVQI1z2OSQqFMBBEc/9juRBRNMEhDmQhunEgbiVKKOmC/xePSjXhdaumaaC1Rp7nsNaiLEv2YRiwbRuO48C+78zzPDn7pfce13WR930RY4QqigJJkpB1XVHXNcVd15GqqmCM+c/l3bYtlzrnEELAfd9MkSr5kGUZ0jTFsiyQi/u+J+M4sotIJNJlyTRN7PM88yoRPc9DPgkq17+R/b8eAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7eaa5672a14e677b12c278b63f52b5e2/8ac56/windbg-read-file-003.webp 240w,\n/static/7eaa5672a14e677b12c278b63f52b5e2/d3be9/windbg-read-file-003.webp 480w,\n/static/7eaa5672a14e677b12c278b63f52b5e2/b0a15/windbg-read-file-003.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7eaa5672a14e677b12c278b63f52b5e2/8ff5a/windbg-read-file-003.png 240w,\n/static/7eaa5672a14e677b12c278b63f52b5e2/e85cb/windbg-read-file-003.png 480w,\n/static/7eaa5672a14e677b12c278b63f52b5e2/0b533/windbg-read-file-003.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7eaa5672a14e677b12c278b63f52b5e2/0b533/windbg-read-file-003.png\"\n            alt=\"イベントログファイルのキャッシュされたメモリのダンプ\"\n            title=\"イベントログファイルのキャッシュされたメモリのダンプ\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>※ Windows のイベントログファイル(EVTX) フォーマットの詳細な仕様は公開されていませんが、Github で公開されている <a href=\"https://github.com/libyal/libevtx/blob/main/documentation/Windows%20XML%20Event%20Log%20(EVTX).asciidoc#windows-xml-event-log-evtx-format\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">libyal/libevtx</a> リポジトリの情報から、ファイルヘッダやチャンクヘッダに関する情報を得ることができます。</p>\n<p>さらに、この BaseAddress から始まるメモリ領域にイベントログファイルのデータが書き込まれているかどうか確認するため、<code class=\"language-text\">.writemem C:\\windefend-event.txt ffff9688ea940000 L10000</code> コマンドで適当に 10000 バイト分のデータを windefend-event.txt にダンプします。</p>\n<p>イベントログファイル内のテキストはワイド文字列として書き込まれているので、<code class=\"language-text\">strings -e l windefend-event.txt</code> のようなコマンドを使用してファイルのテキストを抽出すると、以下のようなイベントログファイル内に記述されるデータを取得できていることがわかりました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ strings -e l windefend-event.txt\n・・・\nMicrosoft Defender Antivirus\n4.18.23080.2006\n1.397.865.0\n1.1.23080.2005\nSecurity intelligence update\nC:\\ProgramData\\Microsoft\\Windows Defender\\Scans\\RtSigs\\data\\884898236a1fb17353dac39aea1e06cfeadc24e4\n0.0.0.0\n10/20/2023 11:36:23 AM\nDuration\n2592000000\nMicrosoft-Windows-Windows Defender\nMicrosoft-Windows-Windows Defender/Operational</code></pre></div>\n<p>ちなみに、今回は VACB のアドレスに到達するためにファイルオブジェクトのアドレスから構造体の情報を順に辿っていきましたが、<code class=\"language-text\">!finddata</code> 拡張機能<sup id=\"fnref-9\"><a href=\"#fn-9\" class=\"footnote-ref\">9</a></sup>を使用すると、もっと簡単にコンテンツがキャッシュされたアドレスを特定できます。</p>\n<p>ここまでに調査した no-cached-file.txt とイベントログファイルのファイルオブジェクトのアドレスを使用して <code class=\"language-text\">!finddata</code> コマンドを実行すると、以下のような結果が得られました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># no-cached-file.txt のファイルオブジェクトを調査\n0: kd> !finddata ffffc40861f5f720\n・・・\nFindData for FileObject ffffc40861f5f720   Section Object Pointers: ffffc40861f22a98\nShared Cache Map: 00000000Unable to read nt!_SHARED_CACHE_MAP at 0000000000000000\n\n\n# イベントログファイルのファイルオブジェクトを調査\n0: kd> !finddata ffffc40861920440\n・・・\nFindData for FileObject ffffc40861920440   Section Object Pointers: ffffc40861981b38\nShared Cache Map: ffffc40861582a20         File Offset: 0 in VACB number 0\nVacb: ffffc4085abd5ea0\nYour data is at: ffff9688ea940000</code></pre></div>\n<p>メモリ内にキャッシュが存在していなかった no-cached-file.txt の場合は <code class=\"language-text\">nt!_SHARED_CACHE_MAP</code> 構造体のアドレスを参照できなかった旨のテキストが出力されています。</p>\n<p>一方で、イベントログファイルの場合は、<code class=\"language-text\">Your data is at: ffff9688ea940000</code> として、VACB 構造体の情報から特定したコンテンツのキャッシュされているアドレスが出力されました。</p>\n<p>以上で、フルメモリダンプからシステムにキャッシュされたファイルのデータを抽出することができました。</p>\n<p>この方法では狙ったファイルや元の完全なファイルを取得することは困難ですが、フルメモリダンプを解析する上で知っておくと面白いテクニックかと思います。</p>\n<h2 id=\"ダンプファイルから-windbg-で実行ファイルを抽出する\" style=\"position:relative;\"><a href=\"#%E3%83%80%E3%83%B3%E3%83%97%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89-windbg-%E3%81%A7%E5%AE%9F%E8%A1%8C%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B\" aria-label=\"ダンプファイルから windbg で実行ファイルを抽出する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ダンプファイルから WinDbg で実行ファイルを抽出する</h2>\n<p>実際のトラブルシューティングの場面で使用する必要はありませんが、例えばマルウェアに感染した端末のダンプファイルを解析する場合などに、メモリダンプから元の実行ファイルを取得したい場合があります。</p>\n<p>そのような場合は、プロセスのメモリ内に展開されたデータを WinDbg で抽出してファイルとしてエクスポートすることで、実行ファイル(PE ファイル)を取得できます。</p>\n<p>しかし、この方法でプロセスのメモリから展開した実行ファイルは、元の実行ファイルと完全に同一のファイルではない点に注意する必要があります。<sup id=\"fnref-10\"><a href=\"#fn-10\" class=\"footnote-ref\">10</a></sup></p>\n<p>この理由は複数ありますが、1 つは PE ファイルの一部のセクションがプロセスメモリ内に展開されないことが挙げられます。</p>\n<p>また、メモリに展開されたグローバル変数の値や実行コードなどがプログラムによってに書き換えられた場合にも、元の実行ファイルを抽出することができなくなります。</p>\n<p>プロセスメモリから元の実行ファイルと完全に同一のファイルを抽出することが困難な理由は他にもありますが、本書では詳細な解説は割愛します。</p>\n<p>プロセスメモリからの実行ファイルの抽出については参考文献に記載している「The Art of Memory Forensics」で詳しく解説されています。</p>\n<p>本書では、WinDbg を使用してプロセスのフルメモリダンプから D4C.exe の実行ファイル復元を行います。</p>\n<p>基本的には、PE ファイルのローダの逆の操作を行い、プロセスのメモリ内に展開された PE ヘッダや各セクションの情報を抜き出して 1 つのファイルとしてマージすることでファイルの復元が可能です。</p>\n<p>5 章や 6 章で紹介したように <code class=\"language-text\">!dh -f</code> コマンドと <code class=\"language-text\">!dh -s</code> コマンドを使用して IAT やセクションヘッダの情報を取得し、<code class=\"language-text\">.writemem</code> コマンドで各領域のメモリをファイルをとして出力していく方法でも実行ファイルの復元は技術的には可能です。</p>\n<p>しかし、今回は Github 上で公開されているオープンソースの拡張機能(<a href=\"https://github.com/HongThatCong/dumpext\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">HongThatCong/dumpext</a>)を利用して実行ファイルの抽出を行います。</p>\n<p>なお、本書ではあくまでプロセスダンプから実行ファイルを抽出可能であるということの紹介のみを行うため、拡張機能の詳細については解説しません。</p>\n<p>実行ファイルの抽出のため、6 章で取得した D4C.exe のプロセスダンプを使用します。</p>\n<p>D4C.exe のプロセスダンプを WinDbg にロードしたら、<a href=\"https://github.com/HongThatCong/dumpext\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">HongThatCong/dumpext</a> リポジトリからダウンロードした拡張機能を <code class=\"language-text\">.load C:\\Users\\Public\\Downloads\\dumpext.dll</code> コマンドで読み込みます。</p>\n<p>拡張機能をロードしたら、<code class=\"language-text\">!dumpext.dump_pe !D4C</code> コマンドを実行してプロセスから実行ファイルをダンプします。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ef34154aad3352406c6345fc16287d37/0b533/windbg-recover-file-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAs0lEQVQY031PSQqEQBDr//9MEfetXUHFBUFFvQhqhsphbjMFoUJ1k0X5vo+iKOC6LoQnSYIoitB1Hfq+xziO5G3bYlkWHMeBf6M8z6OIbdsIggBZlsFxHN7iOEZVVUjTFGEY8q2ua27BMAxomgbTNNFs33coy7L42TAMJhRh4aZp8q61ppEYSOJ1XSmwbRvTyr6ui+ne94XK85yVyrL8QlIJpO48zzjPE/d943men1VFTOYDlwcm7ogkQKcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ef34154aad3352406c6345fc16287d37/8ac56/windbg-recover-file-001.webp 240w,\n/static/ef34154aad3352406c6345fc16287d37/d3be9/windbg-recover-file-001.webp 480w,\n/static/ef34154aad3352406c6345fc16287d37/b0a15/windbg-recover-file-001.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ef34154aad3352406c6345fc16287d37/8ff5a/windbg-recover-file-001.png 240w,\n/static/ef34154aad3352406c6345fc16287d37/e85cb/windbg-recover-file-001.png 480w,\n/static/ef34154aad3352406c6345fc16287d37/0b533/windbg-recover-file-001.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ef34154aad3352406c6345fc16287d37/0b533/windbg-recover-file-001.png\"\n            alt=\"!dumpext.dump_pe !D4C による実行ファイルのダンプ\"\n            title=\"!dumpext.dump_pe !D4C による実行ファイルのダンプ\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>拡張機能によって出力されたバイナリは WinDbg の実行フォルダ(<code class=\"language-text\">C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64</code>) に dump.out として保存されるため、dump.exe などにリネームしておきます。</p>\n<p>dump.exe を実行してみると、オリジナルの D4C.exe と同じように起動し、各種機能を利用できました。</p>\n<p>しかし、ここで取得した dump.exe とオリジナルの D4C.exe のファイルハッシュを比較してみると、ダンプファイルから取得したファイルは元のファイルとは一致していないことがわかります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ee1759107617605fb2474109be3a1476/0b533/windbg-recover-file-003.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7EAAAOxAGVKw4bAAABPUlEQVQoz22R6U4CQRCER25EIaCCoAgKiCzxAAXF4xEMKIu7S0RBFtH3f4CyeoJ4ZH9UZiZdfX2j4scjxE9ekDx7xeb5BJmWi1RT3j1sNB+QbXcRq5tYqw8RM2wkTsU/QrIxRro11Tnpizd6x4jWhlA7VzOI1llYFfsMTCBN1L4JdTD4UWmh33cvSbHAoQVfxWKRvu5cvPtE9nKmlaPy13Nst6fI0bt3M0eoarOw6d1Egn4WDPIMHTmIcOxwzeHdRMQwEaUC1YFuGqTEI95vv0j88l4pP0ElhAf5pTiZrJtpk2FjRFZdTtvjZPdYNfqUQ0YW0TxrPJoh2W0t+Em+NFUFrrBkWHjUBgmqkgV/xYavzA0q1h8t1/RiLGxkVJ+My4B03u3wo6jC7Qe5uWTpan5y5jvvCHNNSZa8//oCAgPazg3wKOcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ee1759107617605fb2474109be3a1476/8ac56/windbg-recover-file-003.webp 240w,\n/static/ee1759107617605fb2474109be3a1476/d3be9/windbg-recover-file-003.webp 480w,\n/static/ee1759107617605fb2474109be3a1476/b0a15/windbg-recover-file-003.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ee1759107617605fb2474109be3a1476/8ff5a/windbg-recover-file-003.png 240w,\n/static/ee1759107617605fb2474109be3a1476/e85cb/windbg-recover-file-003.png 480w,\n/static/ee1759107617605fb2474109be3a1476/0b533/windbg-recover-file-003.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ee1759107617605fb2474109be3a1476/0b533/windbg-recover-file-003.png\"\n            alt=\"ファイルハッシュの比較\"\n            title=\"ファイルハッシュの比較\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>以上の通り、プロセスダンプから元のファイルと完全には一致しないものの、実行可能な EXE ファイルを抽出できることが確認できました。</p>\n<h2 id=\"各章へのリンク\" style=\"position:relative;\"><a href=\"#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF\" aria-label=\"各章へのリンク permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>各章へのリンク</h2>\n<ul>\n<li><a href=\"/magical-windbg-vol1-00\">まえがき</a></li>\n<li><a href=\"/magical-windbg-vol1-01\">1 章 環境構築</a></li>\n<li><a href=\"/magical-windbg-vol1-02\">2 章 WinDbg の基本操作</a></li>\n<li><a href=\"/magical-windbg-vol1-03\">3 章 解析に必要な前提知識</a></li>\n<li><a href=\"/magical-windbg-vol1-04\">4 章 アプリケーションのクラッシュダンプを解析する</a></li>\n<li><a href=\"/magical-windbg-vol1-05\">5 章 システムクラッシュ時のフルメモリダンプを解析する</a></li>\n<li><a href=\"/magical-windbg-vol1-06\">6 章 プロセスダンプからユーザモードアプリケーションのメモリリーク事象を調査する</a></li>\n<li><a href=\"/magical-windbg-vol1-07\">7 章 フルメモリダンプからユーザモードメモリリーク事象を調査する</a></li>\n<li><a href=\"/magical-windbg-vol1-50\">付録 A WinDbg の Tips</a></li>\n<li><a href=\"/magical-windbg-vol1-51\">付録 B Volatility 3 でクラッシュダンプを解析する</a></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>&lt;</mo><mo separator=\"true\">,</mo></mrow><annotation encoding=\"application/x-tex\">&lt;,</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\"></span><span class=\"mrel\">&lt;</span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.3em;vertical-align:-0.1944em;\"></span><span class=\"mpunct\">,</span></span></span></span>>&#x3C;, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>&lt;</mo><mo separator=\"true\">,</mo></mrow><annotation encoding=\"application/x-tex\">&lt;,</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\"></span><span class=\"mrel\">&lt;</span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.3em;vertical-align:-0.1944em;\"></span><span class=\"mpunct\">,</span></span></span></span>>&#x3C;, $$ >a&#x3C; Run Script File: <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-----------------------a---run-script-file-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-----------------------a---run-script-file-</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-2\">\n<p>.if: <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-if\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-if</a></p>\n<a href=\"#fnref-2\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-3\">\n<p>.for: <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-for\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-for</a></p>\n<a href=\"#fnref-3\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-4\">\n<p>as, aS Set Alias: <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/as--as--set-alias-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/as—as—set-alias-</a></p>\n<a href=\"#fnref-4\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-5\">\n<p>疑似レジスタの構文: <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/pseudo-register-syntax\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/pseudo-register-syntax</a></p>\n<a href=\"#fnref-5\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-6\">\n<p>インサイド Windows 第 7 版 下 P.595 (Andrea Allievi, Mark E.Russinovich, Alex Ionescu, David A.Solomon 著 / 山内和朗 訳 / 日系 BP 社 / 2022 年) </p>\n<a href=\"#fnref-6\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-7\">\n<p>!ca 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-ca\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-ca</a></p>\n<a href=\"#fnref-7\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-8\">\n<p>インサイド Windows 第 7 版 下 P.606 (Andrea Allievi, Mark E.Russinovich, Alex Ionescu, David A.Solomon 著 / 山内和朗 訳 / 日系 BP 社 / 2022 年)</p>\n<a href=\"#fnref-8\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-9\">\n<p>!finddata 拡張機能 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-finddata\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-finddata</a></p>\n<a href=\"#fnref-9\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-10\">\n<p>The Art of Memory Forensics: Detecting Malware and Threats in Windows, Linux, and Mac Memory 1st Edition P.239 (Michael Hale Ligh, Andrew Case, Jamie Levy, AAron Walters 著 / Wiley / 2014 年 )</p>\n<a href=\"#fnref-10\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","fields":{"slug":"/magical-windbg-vol1-50","tagSlugs":["/tag/magical-win-dbg/","/tag/windows/","/tag/win-dbg/"]},"frontmatter":{"date":"2023-11-15","description":"技術書典 15 で頒布した Magical WinDbg -雰囲気で楽しむ Windows ダンプ解析とトラブルシューティング- VOL.1 の WEB 版です。","tags":["Magical WinDbg","Windows","WinDbg"],"title":"Magical WinDbg VOL.1【付録 A WinDbg の Tips】","socialImage":{"publicURL":"/static/2dbf3e09d59db889dc9dc41adcc8e827/magical-windbg-vol1.png"}}}},"pageContext":{"slug":"/magical-windbg-vol1-50"}},"staticQueryHashes":["251939775","401334301","825871152"]}