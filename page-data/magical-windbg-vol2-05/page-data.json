{"componentChunkName":"component---src-templates-post-template-js","path":"/magical-windbg-vol2-05","result":{"data":{"markdownRemark":{"id":"fd9e0b4d-ac6d-5349-aea9-67bf9056ac9f","html":"<p>3 章と 4 章では、DoPClient の解析を行い、パスワード(1 つ目の Flag)を特定しました。</p>\n<p>3 章で確認した通り、DoPClient に正しいパスワードを入力すると、プログラムは <code class=\"language-text\">Password is Correct</code> と <code class=\"language-text\">Clear Stage1</code> という文字列を順に出力した後に、カーネルドライバ DoPDriver.sys をロードし、ドライバオブジェクトに対して CreateFileW 関数を使用することがわかっています。</p>\n<p>4 章と 5 章では、2 つ目の Flag を特定するために、カーネルドライバモジュール DoPDriver の解析を行います。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li><a href=\"#driverentry-%E9%96%A2%E6%95%B0%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\">DriverEntry 関数を特定する</a></li>\n<li><a href=\"#driverentry-%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\">DriverEntry 関数を解析する</a></li>\n<li><a href=\"#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\">ディスパッチルーチンのコールバック関数を解析する</a></li>\n<li><a href=\"#irp_mj_create-%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\"><code class=\"language-text\">IRP_MJ_CREATE</code> のコールバック関数を解析する</a></li>\n<li><a href=\"#irp_mj_close-%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\"><code class=\"language-text\">IRP_MJ_CLOSE</code> のコールバック関数を解析する</a></li>\n<li><a href=\"#pssetcreateprocessnotifyroutine-%E3%81%A7%E7%99%BB%E9%8C%B2%E3%81%97%E3%81%9F%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\">PsSetCreateProcessNotifyRoutine で登録したコールバック関数を解析する</a></li>\n<li><a href=\"#%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%90%8D%E3%81%AE%E6%A4%9C%E8%A8%BC%E3%82%92%E8%A1%8C%E3%81%86%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\">イメージファイル名の検証を行う関数を解析する</a></li>\n<li><a href=\"#%E6%9C%AC%E7%AB%A0%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81\">本章のまとめ</a></li>\n<li><a href=\"#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF\">各章へのリンク</a></li>\n</ul>\n<h2 id=\"driverentry-関数を特定する\" style=\"position:relative;\"><a href=\"#driverentry-%E9%96%A2%E6%95%B0%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"driverentry 関数を特定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DriverEntry 関数を特定する</h2>\n<p>2 章で確認した通り、Windows のカーネルドライバモジュールである DoPDriver.sys ファイルも、ユーザモードプログラムと同じく PE ファイルフォーマットのファイルとしてビルドされています。</p>\n<p>そのため、DoPDriver.sys ファイルについても、DoPClient.exe ファイルと同じく Binary Ninja などの解析ツールを使用して静的解析を行うことができます。</p>\n<p>ただし、DoPDriver のようなカーネルドライバモジュールは DoPClient のようなユーザモードプログラムとは少し異なる構造になっているので注意が必要です。</p>\n<p>例えば、C 言語で作成したユーザモードプログラムの場合は main 関数が最初に実行されますが、Windows カーネルドライバに main 関数は存在しません。</p>\n<p>Windows のカーネルドライバでは、DriverEntry 関数がエントリポイントとして設定されており、カーネルがドライバモジュールを起動する際に初めに実行されます。<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup></p>\n<p>そのため、カーネルドライバファイルの静的解析を行う場合にはまず、この DriverEntry 関数を特定することが有効なアプローチの 1 つといえます。</p>\n<p>Windows カーネルドライバモジュールの DriverEntry 関数は以下のように定義されており、第 1 引数で <code class=\"language-text\">DRIVER_OBJECT</code> 構造体へのポインタが、第 2 引数でドライバのレジストリキーへのパス文字列へのポインタが受け渡されます。<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup></p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">DRIVER_INITIALIZE DriverEntry<span class=\"token punctuation\">;</span>\n\n_Use_decl_annotations_ NTSTATUS <span class=\"token function\">DriverEntry</span><span class=\"token punctuation\">(</span> \n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DRIVER_OBJECT</span>  <span class=\"token operator\">*</span>DriverObject<span class=\"token punctuation\">,</span>\nPUNICODE_STRING  RegistryPath \n<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Function body</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>なお、上記は Windows 98 以降で利用できる WDM(Windows Driver Model) ドライバを作成する場合のコードサンプルですが、ドライバの起動時に DriverEntry 関数が実行される点と、引数に <code class=\"language-text\">DRIVER_OBJECT</code> 構造体へのポインタとレジストリキーへのパス文字列へのポインタが受け渡される点は Windows Vista 以降でサポートされる KMDF/UMDF でも共通です。(ただし、KMDF や UMDF ドライバの場合は WdfDriverCreate 関数で WDFDRIVER オブジェクトを生成する必要があるなど、WDM ドライバとは必要な記述が大きく異なります)</p>\n<p>DriverEntry 関数を特定する最も簡単なアプローチは、Binary Ninja などの解析ツールで DriverObject と RegistryPath を引数として受け取るエントリポイントを特定し、その中からさらに DriverObject を引数として呼び出される関数を特定することです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/5df5d/driver-binary-ninja-013.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABxUlEQVQoz22R3W+aYBSHuZrpEr+WLVmCVURBBESsNlXLh5g008RSPgSkdTVLt2RX+//vfjsvq6TLdvHkHCDneX/nhVssl5hNRhhIEkRBgG7oGJsGjBG9G8hwbAue52HtreBYt7AsCzZVx6betrFYLDCfz0u4Xl/ExNTAtwV8/MxDMnVosyuoIxNdSYaqaSQeEAqGw2GBoigFb/sz3NTbYLkNod+uMbi2YK7vMPHuoC89TFdfYE5nNKhAVdV/hv8HJ7TbkPs9XFTe4X2lgnb/EkKvg08fmmDfdErIkmgkdNwVXMKmVR3HKXFdt4D13OxmgavrG8jygJChjXS6xxFJVBiGgfF4XJyskXh/zHB4fkQcx4iTBFl+oBojCAMEQQDf98HJNNiXJXToh3S6IgShg1arBZ7n0SLY/bF1NVVDlMdIScqG78MIfhRhs91is9mUcLV6HbVaDUUl6q/P1Wq1oNvtFumYNDmmyClhst8jzXLkTyf49z52u10J12w2SdJAo8Gov9Y/MLkoimXCw+kRzy8n5HmO76dv+PXjJ74ej0iyFNkhQ5qmZ+HfordClpAJGWzl5ClDGITYPTwgyvYI4whbWvvMb5ZrHYnkkjouAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/8ac56/driver-binary-ninja-013.webp 240w,\n/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/d3be9/driver-binary-ninja-013.webp 480w,\n/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/e46b2/driver-binary-ninja-013.webp 960w,\n/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/f992d/driver-binary-ninja-013.webp 1440w,\n/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/c6231/driver-binary-ninja-013.webp 1572w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/8ff5a/driver-binary-ninja-013.png 240w,\n/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/e85cb/driver-binary-ninja-013.png 480w,\n/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/d9199/driver-binary-ninja-013.png 960w,\n/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/07a9c/driver-binary-ninja-013.png 1440w,\n/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/5df5d/driver-binary-ninja-013.png 1572w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/8b9cf72cf2f92bffcbfa3ad2566db5c4/d9199/driver-binary-ninja-013.png\"\n            alt=\"DoPDriver の _start 関数\"\n            title=\"DoPDriver の _start 関数\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ただし、本章では DriverEntry 関数の性質を利用した他のアプローチで関数アドレスを特定してみます。</p>\n<p>DoPDriver.sys ファイルを解析して DriverEntry 関数を特定するため、まずは、Binary Ninja で DoPDriver.sys ファイルをロードして Symbols ウインドウを参照します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 682px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d757507cfc8080b0580af5e7f5ca2585/160a3/driver-binary-ninja-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 131.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEF0lEQVRIx4WV2U4jaQyFuZwAWViSkNTy175vSWUFJs0IGBT1NJpRi/d/lDO2i0qapqW+sGpJ5atj+9h18vDlC9bbW/zz73d8e33Fy8sLnp4esVgskGUZkiSRiONY4nh+vJ+mqZyv12uc7Pd77L+94ut/37G9u8d8PsdqtcJ2uxXobDaTWC1XWNJ1VVby+2JRo6L7y+USZVlKPD8/4+T+/h41Pbh7+AtPL3uJYlYjLSrk1Qz5bI6immPz5y12fz9gcbvChl7GL3YcB3ckYrvZ0rmN27u7BqhpOnzfx7yuJYVer4ezszOcnZ81R4qppSOcp9A9E6ZpYjKZoNPpwPU8+U+n8weKomiAlm0jiiKSv5KbV5eXGAwGuLi4kCOH8m3k6wpO7MF1XYHyiyOCZVmOPp1zCU52ux1MpeB7Pup6gTwvBMQP9/t9gvXlaLgKySIXoGVZ0CkrfoYzYzHdbhdVVTUKlTIRBw7yJKQIYBsTWPoN9MlIYP3+AIZDz1DKKrAboH4Ecsrd7nkDfHx8JKCC59oo8hxJHGE8usblxUCiBeoEjAhohc4B2CWgR5nF0Q/At7c3GIYBPwiQpJn4y6EacdGHw6HU76gwOwA1TTsqJGCvTZn9xgVOogBlnqLIUpj6lGAjXF8Pjym/19COXNhkF86KFYZhiDAI0T1/V8getEwdeWBQmKgiJWHpY4yHVxheXaJHUNOzkG9mCKoYtu0goIwGdJ8zGo1GYiEegBN2uiIgQ+axjSq2UKcOylAh9gy45kQUNsAKXkZNI5sxsP8OvBmPj8AFAVuFVdTAOGzjRlJqUz4oLKODwhY4/hHICk0CFpRuC0tc/WDotikC3FYN0PkN0DA0xAQpSSHXUWljjKh+jbHbLiukywIupayoyzwt/HtADflUQ9NoFBZUN47Q1nBDXux2e9IQ8aFNtqEucw2t3wGV1NBE6pvIfIUZNca3NJkUfTqSURRg3QDZMgcg2Wb8WaEmdUupq6mnY5bY0qCMXsCpc9o8KexDN/VFoUdbhu+zQh6AD0Aeoyj06SGXOm6I/3j8RtdXNA3H5cA1ZIVBGGA6ncqksEJZDq2x2TZKGchCC/M8RJ0HiBwd2s3wQ1OaLje24XRbhRGNHY/u6enpxxpmvkHGtiQ8NcU1TcgvgTIptnxDuLbNpAw/d5kno04cqZ+rJphQyp+AmyOQF0IDjBsfkkL+rhyA3Nk5wRpz2wfb/AwM32eZQa1CBnLK/JX8YBvuahYoAaZUAkfmmJoyeDf2qoRfhGIb3jAM5Ilh2zAwp336wTZcRw42N7+AzW5qI/kMaJZBPsxoUnxZdwHtQX6Z7wcH2xwUOraFMnZo07goIqpj6sl1SdcxGZ3/YAcusmWJoIhou3u02WOZEG4OL1suDdvmf0zK2jIGBV7QAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/d757507cfc8080b0580af5e7f5ca2585/8ac56/driver-binary-ninja-001.webp 240w,\n/static/d757507cfc8080b0580af5e7f5ca2585/d3be9/driver-binary-ninja-001.webp 480w,\n/static/d757507cfc8080b0580af5e7f5ca2585/57e27/driver-binary-ninja-001.webp 682w\"\n              sizes=\"(max-width: 682px) 100vw, 682px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/d757507cfc8080b0580af5e7f5ca2585/8ff5a/driver-binary-ninja-001.png 240w,\n/static/d757507cfc8080b0580af5e7f5ca2585/e85cb/driver-binary-ninja-001.png 480w,\n/static/d757507cfc8080b0580af5e7f5ca2585/160a3/driver-binary-ninja-001.png 682w\"\n            sizes=\"(max-width: 682px) 100vw, 682px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/d757507cfc8080b0580af5e7f5ca2585/160a3/driver-binary-ninja-001.png\"\n            alt=\"DoPDriver のシンボル一覧画面\"\n            title=\"DoPDriver のシンボル一覧画面\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>シンボルが存在しないため DriverEntry 関数を Symbols ウインドウから見つけることはできません。</p>\n<p>しかし、エクスポートされている関数に <code class=\"language-text\">Wdf*</code> や <code class=\"language-text\">Wpp*</code> が含まれていないことから、KMDF/UMDF ではなく WDM ドライバの可能性が高いと判断できます。</p>\n<p>例えば、シンプルな KMDF ドライバの場合、Binary Ninja で解析した結果が以下のようになります。(DoPDriver.sys の解析画面ではありません)</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 485px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a58a1636ed7d143aafe627d665da793e/44c61/driver-binary-ninja-002.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABlElEQVQoz22SW3OCMBBGfe20goJ3JAEElATkqq3T//+7vu4Gi2j7kMkLnDlnN5NGhbiVMc5HiZJOdQpQ0L3bLGHZNmzLwnKzRv5ZofxuUHxV8KQHKSXatoXrupjSN8fjCVprTKosQBb7KAnE0IU7x9v7B2yCzWazHrhe4dTkUF1Ot4Y4CAhfoK7rARjHCZTKMGHDPBXo8gNqgm9WCzjzmYGNgVlXkGUJfS3hhz6EkGjIcMHAqYU0PZKhwoStsnhPdoEBFgQ/yB2268U92e6BbQ/kex/s4ZNhVVdk6AyGWZb1QJ30yWxbnmh+BHtNZpC+nCm7gIilMaybpjekb5IkhVbqAWx0ZJYS+JsnoHUHqlEyG5pkAv7OcEjmRJ6hosWwYRrsEBHUcebmw3Gyvp7N8WgkffJjKWyoOLkmSMupNMNLEdEMJS55RHPcYrV0n5bCMDb1I38w/JPc0c+a7BjU0FKS0MN+u6SzMsd+Sc7pHQZpaAzHwCH5VibodGiSOT1PBJLAQ0xZ/IT4STwthY4x5Hf4j+EPN3oUY6dd9JkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a58a1636ed7d143aafe627d665da793e/8ac56/driver-binary-ninja-002.webp 240w,\n/static/a58a1636ed7d143aafe627d665da793e/d3be9/driver-binary-ninja-002.webp 480w,\n/static/a58a1636ed7d143aafe627d665da793e/749af/driver-binary-ninja-002.webp 485w\"\n              sizes=\"(max-width: 485px) 100vw, 485px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a58a1636ed7d143aafe627d665da793e/8ff5a/driver-binary-ninja-002.png 240w,\n/static/a58a1636ed7d143aafe627d665da793e/e85cb/driver-binary-ninja-002.png 480w,\n/static/a58a1636ed7d143aafe627d665da793e/44c61/driver-binary-ninja-002.png 485w\"\n            sizes=\"(max-width: 485px) 100vw, 485px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a58a1636ed7d143aafe627d665da793e/44c61/driver-binary-ninja-002.png\"\n            alt=\"KMDF ドライバのシンボル一覧画面の例\"\n            title=\"KMDF ドライバのシンボル一覧画面の例\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>WDM ドライバでは、原則として DeviceEntry 関数で最初にデバイスを表すデバイスオブジェクトを 1 つ以上生成する必要があります。<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup></p>\n<p>デバイスオブジェクトの作成には IoCreateDevice 関数 <sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup> が使用されるため、多くの場合この API 関数の呼び出し箇所を確認することで DriverEntry 関数の実行コードを特定できます。</p>\n<p>Binary Ninja を使用する場合は Symbols ウインドウで .rdata セクションの IoCreateDevice をクリックします。</p>\n<p>すると、Cross References ウィンドウの [Code References] 欄に 0x1400011cc のアドレスが表示されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 788px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/84231d4d2c2bef85a91342120d314663/ea7fb/driver-binary-ninja-003.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABmUlEQVQoz22QzU/CUBDEexEKDSeFlraU0iqlhQBCVRQRQaVQJIoJiQcTI2I0kviJ8c8f97WiBz38MrOzs3nJ4ybXM4yvpuj0T9EbncMfT3DoDbHXOUGz20O756N90sduu0udIfaPPLSO+zgg2H5J69jD+PIKnH8zx2j6iLPbOYbTJ3jTFwxmb/Dv3jEgRg8LjOcLnN6/4mL+idH9B7HAGeVs738zuHtD7+YZXEKIIxHnA4RYFHw08kskghgfhUAdQYjRng9mRpw8H1n56S1vOC2rQ85oyJCqmgZVVf+ihKoov5nyT0+je67V7qDr+WgeHmGn2UK97qLuuqEucUPcIK8HuD+dcK7Vamg0GuCqm1Uy29jacVGtlOAUNmBbGyjaefJ5UgslOx/MlmXBcRzYto2ClYddsALPMkalXAFnUVCml9y9JpyiDTOnwchlSUPWDZ1gXoeu6zBNE4ZhkM8iRzBvUGaSloolcClRgkR/qJo5yEoamXQKkiQimUxCJZ+RU5DTElKUiaJIf6dQT4ZI2WpyLVA2s5ztvwByjvSFELFa/AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/84231d4d2c2bef85a91342120d314663/8ac56/driver-binary-ninja-003.webp 240w,\n/static/84231d4d2c2bef85a91342120d314663/d3be9/driver-binary-ninja-003.webp 480w,\n/static/84231d4d2c2bef85a91342120d314663/4d911/driver-binary-ninja-003.webp 788w\"\n              sizes=\"(max-width: 788px) 100vw, 788px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/84231d4d2c2bef85a91342120d314663/8ff5a/driver-binary-ninja-003.png 240w,\n/static/84231d4d2c2bef85a91342120d314663/e85cb/driver-binary-ninja-003.png 480w,\n/static/84231d4d2c2bef85a91342120d314663/ea7fb/driver-binary-ninja-003.png 788w\"\n            sizes=\"(max-width: 788px) 100vw, 788px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/84231d4d2c2bef85a91342120d314663/ea7fb/driver-binary-ninja-003.png\"\n            alt=\"Code References 画面\"\n            title=\"Code References 画面\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>このアドレスをクリックすると、<code class=\"language-text\">DRIVER_OBJECT</code> 構造体のポインタアドレスを引数として受け取り、IoCreateDevice 関数を実行している関数を見つけることができます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 890px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c89148b9d19e03704989b8a11c40bcc2/4ef49/driver-binary-ninja-004.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABr0lEQVQoz22SbW6jMBiEuUvUhAABDPgLg01CSUkr9f63mR07irTazY8RwjbjZ+YlC+uCOcxY/IR5crBuxuQX+HlKa8HP8MFjmiaM4whjDIy1z+cbZe7TQ80GfT+gaVrkpxP6roMQlFRQVqNXCmIYUBQFjh8fOB2PyPP8rbLxNkPTUGudCLq+h5QSgqYuUpFUk1Q7anTotYEcLcqyTBf8q8yEEYOVUKSIRufzGR3pmraFjGtGQ7MKQ3NlLC6NoFp+fE5n/zOc7oEENhHGDireHOMLIWCcI5VFx72Wa9GoqhtUl/otXTJ06ww1PSNHyrquadgnQ8uYlqaGQ+m0palEHdV2OLOvqJyUr/4icYqsnE5xLacXjTr21zKyZl+K1JI9mhAwMLIyIy/xMOyz46AigODZlvSX6sKhkFA6legGHjgcDmnCTdOk30MxsvYjHAdj2WXLC5tOQCiJggZlUSajqqqehPffHbfHimW5Yts2GksE0gTv8dgfuO87vn42fD823L+2ZGxS389UEeKl+J5d9xX+c4FjhEgZ+3PsLSqsN/grhyYHGDVA8Rn3X/rb7KU/w8VC+07gMMkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/c89148b9d19e03704989b8a11c40bcc2/8ac56/driver-binary-ninja-004.webp 240w,\n/static/c89148b9d19e03704989b8a11c40bcc2/d3be9/driver-binary-ninja-004.webp 480w,\n/static/c89148b9d19e03704989b8a11c40bcc2/8d1ba/driver-binary-ninja-004.webp 890w\"\n              sizes=\"(max-width: 890px) 100vw, 890px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/c89148b9d19e03704989b8a11c40bcc2/8ff5a/driver-binary-ninja-004.png 240w,\n/static/c89148b9d19e03704989b8a11c40bcc2/e85cb/driver-binary-ninja-004.png 480w,\n/static/c89148b9d19e03704989b8a11c40bcc2/4ef49/driver-binary-ninja-004.png 890w\"\n            sizes=\"(max-width: 890px) 100vw, 890px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/c89148b9d19e03704989b8a11c40bcc2/4ef49/driver-binary-ninja-004.png\"\n            alt=\"DriverEntry 関数の特定\"\n            title=\"DriverEntry 関数の特定\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>この関数が DriverEntry 関数ですので、必要に応じて関数名のリネームを行いましょう。</p>\n<p>これで DriverEntry 関数を特定することができました。</p>\n<p>なお、デバイスドライバが IOCTL インターフェース <sup id=\"fnref-6\"><a href=\"#fn-6\" class=\"footnote-ref\">6</a></sup> を実装している場合には、各 IOCTL リクエストを処理するための IOCTL ディスパッチルーチンを DriverEntry 関数で登録しているはずです。</p>\n<p>IOCTL ディスパッチルーチンは <code class=\"language-text\">DRIVER_OBJECT</code> 構造体 <sup id=\"fnref-7\"><a href=\"#fn-7\" class=\"footnote-ref\">7</a></sup> のオフセット 0x70 以降に <code class=\"language-text\">mov  qword [rcx+0x70], &lt;ディスパッチルーチンの関数ポインタ></code> というアセンブリコードで登録されます。<sup id=\"fnref-8\"><a href=\"#fn-8\" class=\"footnote-ref\">8</a></sup></p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_DRIVER_OBJECT</span> <span class=\"token punctuation\">{</span>\n  CSHORT             Type<span class=\"token punctuation\">;</span>\n  CSHORT             Size<span class=\"token punctuation\">;</span>\n  PDEVICE_OBJECT     DeviceObject<span class=\"token punctuation\">;</span>\n  ULONG              Flags<span class=\"token punctuation\">;</span>\n  PVOID              DriverStart<span class=\"token punctuation\">;</span>\n  ULONG              DriverSize<span class=\"token punctuation\">;</span>\n  PVOID              DriverSection<span class=\"token punctuation\">;</span>\n  PDRIVER_EXTENSION  DriverExtension<span class=\"token punctuation\">;</span>\n  UNICODE_STRING     DriverName<span class=\"token punctuation\">;</span>\n  PUNICODE_STRING    HardwareDatabase<span class=\"token punctuation\">;</span>\n  PFAST_IO_DISPATCH  FastIoDispatch<span class=\"token punctuation\">;</span>\n  PDRIVER_INITIALIZE DriverInit<span class=\"token punctuation\">;</span>\n  PDRIVER_STARTIO    DriverStartIo<span class=\"token punctuation\">;</span>\n  PDRIVER_UNLOAD     DriverUnload<span class=\"token punctuation\">;</span>\n  PDRIVER_DISPATCH   MajorFunction<span class=\"token punctuation\">[</span>IRP_MJ_MAXIMUM_FUNCTION <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> DRIVER_OBJECT<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PDRIVER_OBJECT<span class=\"token punctuation\">;</span></code></pre></div>\n<p>そのため、<code class=\"language-text\">DRIVER_OBJECT</code> 構造体のオフセット 0x70 にアクセスしているコードを探すアプローチからも、DriverEntry 関数を特定できる可能性があります。</p>\n<p>Binary Ninja を使用する場合はまず、画面左のメニューから <code class=\"language-text\">{T}</code> のマークをクリックして Types ウインドウを開きます。</p>\n<p>そこで、<code class=\"language-text\">DRIVER_OBJECT</code> 構造体を検索し、クリックして情報を表示します。</p>\n<p><code class=\"language-text\">DRIVER_OBJECT</code> 構造体のオフセット 0x70 にある <code class=\"language-text\">PDRIVER_DISPATCH MajorFunction[***];</code> をクリックした後に Code References ウインドウを参照すると、先ほどリネームした DriverEntry 関数のアドレスが表示されることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/36fe303c861819a4a0fad2df0ac85c76/906b5/driver-binary-ninja-005.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABsklEQVQoz32S3baaMBCFeQAVPeVXgRCBAyHyr3Iq2Gq77OpFz/s/zu4ktWv1pufiW0kGZmcye4z7/Y6fv94xTTNutxvmeUZd1zgej6iqCmwfw/dcZDzUJJwhjDmCMITnebBtG47jwLIsHA4HGNPlgkpKdF2Hvu8hyxLb7Ra+7yNiEXiewnUs1DkjIuR5gkSU4NkrbBIyTRObzQar1QpBEMAYxxFv42ddmdrHcYyQbmeM4dDXyKoCHgn2kqMvY8hCCUrw15yE1lpwvV5juVzqHON8PiNLUpRUmSgK7HY7/ZTFYkEV2GjHAaXIMZ1qvA0Sl/GE9+8/8O0yIRcFkjRFSnDO0bYtjOv1irob0AwnVF2v+6BQF0hqRdM2z7OEUDHiQHENxeVzVf8PwwDj8Xhg/nLD9PWOlgRVlUIohKZQZ6IshU7SL/mL+CdG+7ahCpumgR/FSKRAnHGE1Idovyd39wiikL5RLBOwbEf3ShnwPxxy3PjjrEDfVXRTTs4yMDJGEUURidKYME69DbT7H8EpR1fo+R52gQ+2c7F1Lbhkiktj84lmy6RxMM0V1k83P+Jl84LfIYn+WWqpgccAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/36fe303c861819a4a0fad2df0ac85c76/8ac56/driver-binary-ninja-005.webp 240w,\n/static/36fe303c861819a4a0fad2df0ac85c76/d3be9/driver-binary-ninja-005.webp 480w,\n/static/36fe303c861819a4a0fad2df0ac85c76/4a41d/driver-binary-ninja-005.webp 950w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/36fe303c861819a4a0fad2df0ac85c76/8ff5a/driver-binary-ninja-005.png 240w,\n/static/36fe303c861819a4a0fad2df0ac85c76/e85cb/driver-binary-ninja-005.png 480w,\n/static/36fe303c861819a4a0fad2df0ac85c76/906b5/driver-binary-ninja-005.png 950w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/36fe303c861819a4a0fad2df0ac85c76/906b5/driver-binary-ninja-005.png\"\n            alt=\"構造体情報から DriverEntry 関数を特定する\"\n            title=\"構造体情報から DriverEntry 関数を特定する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>このようにして、構造体の情報などからも、特定したい関数のアドレスを参照することができる場合があります。</p>\n<h2 id=\"driverentry-関数を解析する\" style=\"position:relative;\"><a href=\"#driverentry-%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\" aria-label=\"driverentry 関数を解析する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DriverEntry 関数を解析する</h2>\n<p>DriverEntry 関数のアドレスを特定できたので、3 章と同じように Binary Ninja の Graph ビューを使用して関数の実行コードを解析します。</p>\n<p>以下は、DriverEntry 関数の逆アセンブル結果を Graph ビューで表示したものです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/063abcc6a605c746d5a9a9c8d8f4726c/e4900/driver-binary-ninja-006.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 88.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACrElEQVQ4y41U23aiQBD0Y9aoKLpxvQGCUaMRhssAI6DmZP//K2p7GsXc9pw81GluU1NdNU3LMAxodDod2O4S5dsrVHFEmmfIqapCIVc5EpkgSZK6XpFlGZ53z+h2u7jxtBrChw4cjwj/nmqCNMWxKiGVouscYRhCRCGCIIDv+wwhBJ7Wa3R7ve8JbddB8VYhI3VpmjGhOlcoLxdkxwJxnjPJV8L/KLS9O6EkQlUWSKitME4gCEEUN2Q/JtQt3wiPFZFXJySK1NF9TK1H4b3tn7ec6ZZTVpifKhSXM/l6pJDonjaIE4mY1KYyxWa7/aiwd2XXKTehkFcqVyhPJ5TnI87nEpmi1imU8F0wOqj1Zo3eZ4X6QftXG9bSgnotqF0JmaUUhEIchwSBQAQ4HA41/AP8wGdib+XhofPAR0eDFY5GIzyOHzGZTGA5NhaWhQVVZ+XyvbNcwrFt2NaCYHGdTP5guXSwdBxMad14PGaelm5157+gfK1ISQxJvuTkXVYVUHRsUvJThxSTag7i2u5wOMR2/0zph3Xqwof3tKoJ9+KAiryTUrL5JZ296updQZMS0kYhvRNhxGFEVLWaZkIGA7ZNo6XT3QUvDWFGSWr/IvIsCgVCcZ8M7VnwTuGNsD8wa8JbKPP5HDZ7RZ54Lhya6fliAUt7Se809DfT6QzT2QwzgmmaTbo3Qk7ZpJ1W2w1czyOsGJpoT6qPl4LOmqSfguQqZUTX1Db9JFzX5aP2hbCRS9AnXrfRbrex2W0oGEUhCA4kljECCs9nHHjT7wnNIT/o9wdU7xjo5/TMMPr83hw9om+OMBj+xvD3mMHr+Pt3hHqB0f8ITdTt9rCiKRBJiAOp9CP6OcQRtrtdvRkLGdRrrsPRjN5n3EZxtXliwv1+zxCRwIY2MYzv1+j6D34Ja2bAjOFbAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/063abcc6a605c746d5a9a9c8d8f4726c/8ac56/driver-binary-ninja-006.webp 240w,\n/static/063abcc6a605c746d5a9a9c8d8f4726c/d3be9/driver-binary-ninja-006.webp 480w,\n/static/063abcc6a605c746d5a9a9c8d8f4726c/e46b2/driver-binary-ninja-006.webp 960w,\n/static/063abcc6a605c746d5a9a9c8d8f4726c/6257a/driver-binary-ninja-006.webp 988w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/063abcc6a605c746d5a9a9c8d8f4726c/8ff5a/driver-binary-ninja-006.png 240w,\n/static/063abcc6a605c746d5a9a9c8d8f4726c/e85cb/driver-binary-ninja-006.png 480w,\n/static/063abcc6a605c746d5a9a9c8d8f4726c/d9199/driver-binary-ninja-006.png 960w,\n/static/063abcc6a605c746d5a9a9c8d8f4726c/e4900/driver-binary-ninja-006.png 988w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/063abcc6a605c746d5a9a9c8d8f4726c/d9199/driver-binary-ninja-006.png\"\n            alt=\"DriverEntry 関数の Graph ビュー\"\n            title=\"DriverEntry 関数の Graph ビュー\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>最初のブロックでは IoCreateDevice 関数によるデバイスオブジェクトの作成を行っています。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">DriverEntry:\nmov     r11, rsp {__return_addr}\npush    rbx {__saved_rbx}\nsub     rsp, 0x60\nlea     rax, [rel sub_140001280]\nmov     dword [rsp+0x40 {DeviceName}], 0x240022\nmov     qword [rcx+0x68], rax  {sub_140001280}\nlea     r8, [r11-0x28 {DeviceName}]\nlea     rax, [rel sub_1400011a0]\nmov     r9d, 0x22\nmov     qword [rcx+0x70], rax  {sub_1400011a0}\nxor     edx, edx  {0x0}\nlea     rax, [rel sub_140001180]\nmov     qword [rcx+0x80], rax  {sub_140001180}\nlea     rax, [rel data_140001590]  {u\"\\Device\\DoPDriver\"}\nmov     qword [r11-0x20 {var_20}], rax  {data_140001590, u\"\\Device\\DoPDriver\"}\nlea     rax, [r11+0x8 {DeviceObject}]\nmov     qword [r11-0x38 {var_38}], rax {DeviceObject}\nmov     byte [rsp+0x28 {var_40}], 0x0\nand     dword [rsp+0x20 {var_48}], 0x0\ncall    qword [rel IoCreateDevice]\ntest    eax, eax\njns     0x140001238</code></pre></div>\n<p>IoCreateDevice 関数は以下の引数を取り、ドライバで使用するデバイスオブジェクトの作成を行う関数です。<sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup></p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">NTSTATUS <span class=\"token function\">IoCreateDevice</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           PDRIVER_OBJECT  DriverObject<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           ULONG           DeviceExtensionSize<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">,</span> optional<span class=\"token punctuation\">]</span> PUNICODE_STRING DeviceName<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           DEVICE_TYPE     DeviceType<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           ULONG           DeviceCharacteristics<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span>           BOOLEAN         Exclusive<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">]</span>          PDEVICE_OBJECT  <span class=\"token operator\">*</span>DeviceObject\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Binary Ninja の Graph ビューで IoCreateDevice 関数をクリックすると、以下のように Cross References ウインドウで引数を解析してくれるので非常に便利です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 801px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c470f7d63fb69cd8aed6bb0b5af39979/2ad15/driver-binary-ninja-007.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAnElEQVQY053KSw6CMBRGYXbAgJaW0jICI2ACJaDBZxxo4v4XdAQ0OmdwBv93b3B7vhjvD/bHC13Xrc57zziOBNfzicPQ49uWbVlSVdWq6rqmbRqCne9p+4FiU+BsinMOay2Z+/ezLFuy8558NreYW7zIcwKhNcoaYiWwWqBiiRAR5ruNltMtRkhJYhKSNEHOOxZE09/HDEorwjDkDVe6cwcNUA/fAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/c470f7d63fb69cd8aed6bb0b5af39979/8ac56/driver-binary-ninja-007.webp 240w,\n/static/c470f7d63fb69cd8aed6bb0b5af39979/d3be9/driver-binary-ninja-007.webp 480w,\n/static/c470f7d63fb69cd8aed6bb0b5af39979/99a1d/driver-binary-ninja-007.webp 801w\"\n              sizes=\"(max-width: 801px) 100vw, 801px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/c470f7d63fb69cd8aed6bb0b5af39979/8ff5a/driver-binary-ninja-007.png 240w,\n/static/c470f7d63fb69cd8aed6bb0b5af39979/e85cb/driver-binary-ninja-007.png 480w,\n/static/c470f7d63fb69cd8aed6bb0b5af39979/2ad15/driver-binary-ninja-007.png 801w\"\n            sizes=\"(max-width: 801px) 100vw, 801px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/c470f7d63fb69cd8aed6bb0b5af39979/2ad15/driver-binary-ninja-007.png\"\n            alt=\"IoCreateDevice の引数に渡される値\"\n            title=\"IoCreateDevice の引数に渡される値\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>第 1 引数の arg1 には、DriverEntry 関数が引数として受け取った <code class=\"language-text\">DRIVER_OBJECT</code> 構造体へのポインタが使用されます。</p>\n<p>また、DeviceName には関数内で定義したデバイスオブジェクトの名前が使用されます。</p>\n<p>この時、DeviceName として利用される文字列は <code class=\"language-text\">UNICODE_STRING</code> 構造体 <sup id=\"fnref-9\"><a href=\"#fn-9\" class=\"footnote-ref\">9</a></sup> のオブジェクトへのポインタであることに注意が必要です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_UNICODE_STRING</span> <span class=\"token punctuation\">{</span>\n  USHORT Length<span class=\"token punctuation\">;</span>\n  USHORT MaximumLength<span class=\"token punctuation\">;</span>\n  PWSTR  Buffer<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> UNICODE_STRING<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PUNICODE_STRING<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Windows カーネルドライバが使用する多くの関数では、ソフトウェアの安全性の観点から <code class=\"language-text\">UNICODE_STRING</code> 構造体などの適切なバッファ処理が考慮された安全な文字列オブジェクトを利用します。<sup id=\"fnref-10\"><a href=\"#fn-10\" class=\"footnote-ref\">10</a></sup></p>\n<p>前述の通り、<code class=\"language-text\">UNICODE_STRING</code> 構造体で表現される文字列は単純な文字列ではなく、文字列のバッファサイズなどの要素を持つ構造体として IoCreateDevice などの関数に渡されます。</p>\n<p>そのため、特にデバッガを使用して動的解析を行う場合には、この点を考慮する必要があります。</p>\n<p>実際に IoCreateDevice 関数の引数である DeviceName を用意しているコードを読んでみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">mov     r11, rsp {__return_addr}\npush    rbx {__saved_rbx}\nsub     rsp, 0x60\n***\nmov     dword [rsp+0x40 {DeviceName}], 0x240022\n***\nlea     r8, [r11-0x28 {DeviceName}]\n***\nlea     rax, [rel data_140001590]  {u\"\\Device\\DoPDriver\"}\nmov     qword [r11-0x20 {var_20}], rax  {data_140001590, u\"\\Device\\DoPDriver\"}</code></pre></div>\n<p>Binary Ninja がアドレス <code class=\"language-text\">RSP+0x40</code> のスタック領域を DeviceName として解釈しています。</p>\n<p>しかし、<code class=\"language-text\">mov  dword [rsp+0x40 {DeviceName}], 0x240022</code> のコードではこの領域に文字列ではなく 0x240022 という値を格納しています。</p>\n<p>これはなぜかというと、前述した通り DeviceName は単なる文字列ではなく、<code class=\"language-text\">UNICODE_STRING</code> 構造体のオブジェクトとして定義されているためです。</p>\n<p><code class=\"language-text\">UNICODE_STRING</code> 構造体では、最初の 2 バイトに Length、次の 2 バイトに MaximumLength の値が定義されます。</p>\n<p>つまり、<code class=\"language-text\">RSP+0x40</code> のスタック領域に 0x240022 を格納する操作は、Length が 0x22、MaximumLength が 0x24 の <code class=\"language-text\">UNICODE_STRING</code> 構造体を書き込む操作に当たります。</p>\n<p>そして、実際の文字列(<code class=\"language-text\">\\Device\\DoPDriver</code>)を指すポインタは、<code class=\"language-text\">UNICODE_STRING</code> 構造体の Buffer に格納されます。</p>\n<p>これは、カーネルデバッグで DriverEntry 関数の動的解析を行う際に、<code class=\"language-text\">dt nt!_UNICODE_STRING RSP+0x40</code> コマンドを実行することでも確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">kd> dt nt!_UNICODE_STRING rsp+0x40\n<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>\n<span class=\"token operator\">+</span>0x000 Length           : 0x22\n<span class=\"token operator\">+</span>0x002 MaximumLength    : 0x24\n<span class=\"token operator\">+</span>0x008 Buffer           : 0xfffff807`100a1590  <span class=\"token string\">\"\\Device\\DoPDriver\"</span></code></pre></div>\n<p>また、DeviceName の次の引数である DeviceType にはデバイスの種類を示す値が渡されます。</p>\n<p>DoPDriver では DeviceType の値が 0x22 に設定されていますが、これは <code class=\"language-text\">FILE_DEVICE_UNKNOWN</code> という、Windows の標準デバイスではないことを示す値に該当します。</p>\n<p>これらの引数を使用して IoCreateDevice 関数を実行すると、DeviceObject 引数のポインタが指すアドレスに <code class=\"language-text\">DEVICE_OBJECT</code> 構造体へのポインタが格納されます。</p>\n<p>そして、デバイスオブジェクトの作成に成功した場合、0x140001238 以降の以下のコードが実行されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">lea     rax, [rel data_140001570]  {u\"\\??\\DoPDriver\"}\nmov     dword [rsp+0x50 {SymbolicLinkName}], 0x1c001a\nlea     rdx, [rsp+0x40 {DeviceName}]\nmov     qword [rsp+0x58 {var_10_1}], rax  {data_140001570, u\"\\??\\DoPDriver\"}\nlea     rcx, [rsp+0x50 {SymbolicLinkName}]\ncall    qword [rel IoCreateSymbolicLink]\nmov     ebx, eax\ntest    eax, eax\njns     0x140001274</code></pre></div>\n<p>このコードでは、IoCreateSymbolicLink 関数 <sup id=\"fnref-12\"><a href=\"#fn-12\" class=\"footnote-ref\">12</a></sup> を使用してデバイスオブジェクトと対応するシンボリックリンク(<code class=\"language-text\">\\??\\DoPDriver</code>)を作成します。</p>\n<p>IoCreateDevice 関数で作成したデバイスオブジェクトの実体は <code class=\"language-text\">\\Device\\DoPDriver</code> に存在しますが、3 章で述べた通り、ユーザモードプロセスは <code class=\"language-text\">\\Device</code> ディレクトリ内のデバイスオブジェクトに直接アクセスができません。</p>\n<p>そのため、DoPClient のようなユーザモードプログラムからドライバにアクセスする必要がある場合は、カーネルドライバ側で <code class=\"language-text\">\\GLOBAL\\??</code> ディレクトリ内にシンボリックリンクを作成し、<code class=\"language-text\">\\Device</code> ディレクトリ内のデバイスオブジェクトの名前とリンクさせておく必要があります。</p>\n<p>上記のコードでは、<code class=\"language-text\">\\Device\\DoPDriver</code> に存在するデバイスオブジェクトのシンボリックリンクを <code class=\"language-text\">\\??\\DoPDriver</code> として登録しています。</p>\n<h2 id=\"ディスパッチルーチンのコールバック関数を解析する\" style=\"position:relative;\"><a href=\"#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\" aria-label=\"ディスパッチルーチンのコールバック関数を解析する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ディスパッチルーチンのコールバック関数を解析する</h2>\n<p>DriverEntry 関数では、デバイスオブジェクトの作成とデバイスオブジェクトに対するシンボリックリンクの登録のみを行っていました。</p>\n<p>では、ユーザモードプログラム DoPClient が DoPDriver を使用する場合に実行されるコードはどこにあるのでしょうか。</p>\n<p>WDM ドライバの場合、アプリケーションからの要求を受けてドライバ操作を実行するためのインターフェースとしては、ドライバオブジェクトの MajorFunction 配列のエントリで定義されるディスパッチルーチンが一般に利用されます。</p>\n<p>ドライバオブジェクトの MajorFunction 配列には、オープン(CreateFile)やクローズ(CloseHandle)、または読み取りや書き込み(ReadFile/WriteFile)、そしてユーザモードプログラムからの DeviceIoControl 操作などと対応するコールバック関数が含まれます。</p>\n<p>ユーザモードプログラムからデバイスドライバに対してこれらの操作を実施した場合、システムの I/O マネージャは I/O Request Packet(IRP) を割り当て、その要求と対応するドライバのディスパッチルーチンが実行されます。<sup id=\"fnref-13\"><a href=\"#fn-13\" class=\"footnote-ref\">13</a></sup></p>\n<p>本章で確認した通り、MajorFunction 配列は <code class=\"language-text\">DRIVER_OBJECT</code> 構造体のオフセット 0x70 以降に <code class=\"language-text\">PDRIVER_DISPATCH MajorFunction[***];</code> として定義されています。</p>\n<p>DoPDriver では、DriverEntry 関数の 0x1400011f8 と 0x1400011fe で 2 つのディスパッチルーチンのコールバック関数がドライバオブジェクトに設定されていました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">mov     qword [rcx+0x70], rax  {sub_1400011a0}\n***\nmov     qword [rcx+0x80], rax  {sub_140001180}</code></pre></div>\n<p>MajorFunction 配列は <code class=\"language-text\">PDRIVER_DISPATCH MajorFunction[***];</code> として定義されており、C 言語で実装する場合は <code class=\"language-text\">DriverObject->MajorFunction[IRP_MJ_CREATE] = &lt;コールバック関数のポインタ></code> のように記述します。</p>\n<p>そして、<code class=\"language-text\">IRP_MJ_CREATE</code> や <code class=\"language-text\">IRP_MJ_CLOSE</code> などの定数は wdm.h で定義されており、以下の値と対応しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">IRP_MJ_CREATE                   0x00\nIRP_MJ_CREATE_NAMED_PIPE        0x01\nIRP_MJ_CLOSE                    0x02\nIRP_MJ_READ                     0x03\nIRP_MJ_WRITE                    0x04\nIRP_MJ_QUERY_INFORMATION        0x05\nIRP_MJ_SET_INFORMATION          0x06\nIRP_MJ_QUERY_EA                 0x07\nIRP_MJ_SET_EA                   0x08\nIRP_MJ_FLUSH_BUFFERS            0x09\nIRP_MJ_QUERY_VOLUME_INFORMATION 0x0a\nIRP_MJ_SET_VOLUME_INFORMATION   0x0b\nIRP_MJ_DIRECTORY_CONTROL        0x0c\nIRP_MJ_FILE_SYSTEM_CONTROL      0x0d\nIRP_MJ_DEVICE_CONTROL           0x0e\nIRP_MJ_INTERNAL_DEVICE_CONTROL  0x0f\nIRP_MJ_SHUTDOWN                 0x10\nIRP_MJ_LOCK_CONTROL             0x11\nIRP_MJ_CLEANUP                  0x12\nIRP_MJ_CREATE_MAILSLOT          0x13\nIRP_MJ_QUERY_SECURITY           0x14\nIRP_MJ_SET_SECURITY             0x15\nIRP_MJ_POWER                    0x16\nIRP_MJ_SYSTEM_CONTROL           0x17\nIRP_MJ_DEVICE_CHANGE            0x18\nIRP_MJ_QUERY_QUOTA              0x19\nIRP_MJ_SET_QUOTA                0x1a\nIRP_MJ_PNP                      0x1b\nIRP_MJ_PNP_POWER                IRP_MJ_PNP\nIRP_MJ_MAXIMUM_FUNCTION         0x1b</code></pre></div>\n<p>つまり、DoPDriver では <code class=\"language-text\">RCX+0x70</code> と <code class=\"language-text\">RCX+0x80</code> にディスパッチルーチンが登録されていることから、<code class=\"language-text\">DriverObject->MajorFunction[0(IRP_MJ_CREATE)]</code> と <code class=\"language-text\">DriverObject->MajorFunction[2(IRP_MJ_CLOSE)]</code> が実装されていると判断できます。</p>\n<h2 id=\"irp_mj_create-のコールバック関数を解析する\" style=\"position:relative;\"><a href=\"#irp_mj_create-%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\" aria-label=\"irp_mj_create のコールバック関数を解析する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">IRP_MJ_CREATE</code> のコールバック関数を解析する</h2>\n<p><code class=\"language-text\">DriverObject->MajorFunction[0(IRP_MJ_CREATE)]</code> に登録されてるコールバック関数のアドレスは 0x1400011a0 でした。</p>\n<p>この関数を Binary Ninja の Graph ビューで解析した結果は以下の通りです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 524px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/59dde0be8f82114e49a96a3fba91bd4c/664c8/driver-binary-ninja-008.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABb0lEQVQoz32S2W6DMBBF+bW0SVi9r0BRVpoofetD+vm3g0OqVon6cGWLMYczY7KiqlFzhUZ7NMaj4gJFniP/J0VRPE1Zlsi4VuhPO7ihg44BbdejqipoY+GCh+08pFFggqFhDIyzVH+WpmmQNYKjPfQEM1BWIYaYvmScQ4gRxnsod6sJKSC0mAFlWqez99R1jYzRoW4cyMRBe4MY/wK18/TcEVSTpQAjYEH1orhB7naPwJ5eJJPJsKKiI1jsOlgf4KNDPwRYxaEVg5EMSjRg1OId+gs4tfxGQDIki8mwrqsECm0L6wgYLLrWIhgOr/nPKud51nPmGTLEaYatgTCSDEO6Sa40uNbUdgCjCyqtR24i1spjzSQWr0ssliu8rNZzVmkUmYsep88LNuMWw2bA+XxOltv9AePpHfvTEeNug+thh6/x8JBryp72R2xoRFlJqoZakvT7SCVhrQXnHMaYtFdk2TqLSxf/zUdP46H7+AZygmGL3fHhSQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/59dde0be8f82114e49a96a3fba91bd4c/8ac56/driver-binary-ninja-008.webp 240w,\n/static/59dde0be8f82114e49a96a3fba91bd4c/d3be9/driver-binary-ninja-008.webp 480w,\n/static/59dde0be8f82114e49a96a3fba91bd4c/1c5aa/driver-binary-ninja-008.webp 524w\"\n              sizes=\"(max-width: 524px) 100vw, 524px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/59dde0be8f82114e49a96a3fba91bd4c/8ff5a/driver-binary-ninja-008.png 240w,\n/static/59dde0be8f82114e49a96a3fba91bd4c/e85cb/driver-binary-ninja-008.png 480w,\n/static/59dde0be8f82114e49a96a3fba91bd4c/664c8/driver-binary-ninja-008.png 524w\"\n            sizes=\"(max-width: 524px) 100vw, 524px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/59dde0be8f82114e49a96a3fba91bd4c/664c8/driver-binary-ninja-008.png\"\n            alt=\"アドレス 0x1400011a0 の関数\"\n            title=\"アドレス 0x1400011a0 の関数\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>最初に実行される IofCompleteRequest <sup id=\"fnref-14\"><a href=\"#fn-14\" class=\"footnote-ref\">14</a></sup> は、I/O 処理を終了してドライバが受け取った IRP を I/O マネージャに返却するマクロです。</p>\n<p>このコードでは特に I/O 処理を行わずに IRP をすぐに返却しているようですが、もしデバイスドライバが IRP を使用する場合は IofCompleteRequest を実行する前に IRP に対して何らかの操作が行われます。</p>\n<p>このコールバック関数の中では IofCompleteRequest 以外に、PsSetCreateProcessNotifyRoutine 関数 <sup id=\"fnref-15\"><a href=\"#fn-15\" class=\"footnote-ref\">15</a></sup> が実行されます。</p>\n<p>PsSetCreateProcessNotifyRoutine は、プロセスが作成もしくは削除されるたびに実行されるルーチンの中に、デバイスドライバが指定するコールバックルーチンを追加、もしくは削除することができる関数です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">NTSTATUS <span class=\"token function\">PsSetCreateProcessNotifyRoutine</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span> PCREATE_PROCESS_NOTIFY_ROUTINE NotifyRoutine<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span> BOOLEAN                        Remove\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>この関数を使用することで、デバイスドライバはシステムで新しいプロセスが作成、もしくは削除される度に任意のコードを実行することができます。</p>\n<p>この PsSetCreateProcessNotifyRoutine は、Sysinternals の Procmon などが依存している PROCMON24.SYS でも一部利用されています。</p>\n<p>DoPDriver 内では、PsSetCreateProcessNotifyRoutine は以下のコードで呼び出されています。</p>\n<p>ここでは、0x1400012e0 の関数ポインタを第 1 引数として PsSetCreateProcessNotifyRoutine によりコールバックルーチンを追加しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">xor     edx, edx  {0x0}\nlea     rcx, [rel sub_1400012e0]\nadd     rsp, 0x28\njmp     qword [rel PsSetCreateProcessNotifyRoutine]</code></pre></div>\n<p>ここでコールバックルーチンに追加しているアドレス 0x1400012e0 の関数は 2 つ目の Flag の特定に関わるため、後の項で解析します。</p>\n<h2 id=\"irp_mj_close-のコールバック関数を解析する\" style=\"position:relative;\"><a href=\"#irp_mj_close-%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\" aria-label=\"irp_mj_close のコールバック関数を解析する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">IRP_MJ_CLOSE</code> のコールバック関数を解析する</h2>\n<p>もう一方の <code class=\"language-text\">DriverObject->MajorFunction[2(IRP_MJ_CLOSE)]</code> に登録されているコールバック関数のアドレスは 0x140001180 でした。</p>\n<p>この関数を逆アセンブルしたコードは以下の通りで、IofCompleteRequest による IRP の返却のみを行っています。</p>\n<p>そのため、この関数については無視しても問題なさそうです。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sub_140001180:\nsub     rsp, 0x28\nand     dword [rdx+0x30], 0x0\nmov     rcx, rdx\nand     qword [rdx+0x38], 0x0\nxor     edx, edx  {0x0}\ncall    qword [rel IofCompleteRequest]\nxor     eax, eax  {0x0}\nadd     rsp, 0x28\nretn     {__return_addr}</code></pre></div>\n<h2 id=\"pssetcreateprocessnotifyroutine-で登録したコールバック関数を解析する\" style=\"position:relative;\"><a href=\"#pssetcreateprocessnotifyroutine-%E3%81%A7%E7%99%BB%E9%8C%B2%E3%81%97%E3%81%9F%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\" aria-label=\"pssetcreateprocessnotifyroutine で登録したコールバック関数を解析する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PsSetCreateProcessNotifyRoutine で登録したコールバック関数を解析する</h2>\n<p><code class=\"language-text\">DriverObject->MajorFunction[0(IRP_MJ_CREATE)]</code> で登録したディスパッチルーチン内で PsSetCreateProcessNotifyRoutine を使用して登録していたコールバック関数のアドレスは 0x1400012e0 でした。</p>\n<p>この関数の中では <code class=\"language-text\">FLAG{The_important_process_is_</code> という文字列が参照されていることから、2 つ目の Flag に関わる何らかの処理が行われる関数であることを予想できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/69bfb63567c2d934a920c5120ae77023/46e30/driver-binary-ninja-009.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACB0lEQVQ4y5WU547iQBCEeRiCwSYIY4RxwoQFR4ID2AatdPv+z1DXPYRjD1an+1Eah/E3Nd01rjmOg9lihdl8AdM04dgmLMuEaVmYTqdCzsyF7cxgGAZ0XX8rnmfbNmqSJKHFakng67Z0G9ttNOp19Ho9+HGEcL/DaDxCnZ5JtznPajabUFUVtU6nA5Ysy1C6CmRFgaJcR22swTANcj+D4zqYksPxeCze84L3b1kM1TTtChQvZYIq8mMij0EQID+dkBVHHNIEO3IZb7fo9/sC8AxstVoYjUZ/AeXvQM/zkOQ5dsmBQDGCMITne/8BVF6BOQGPxwzFMUGW7LCNQwwGgxcg3/8TuCFglqU4EfB0ImC6R0hl+Mnhaw1vW74r8AOqX4l9liMKA8RRgJC2/Q74xiF3uSug3GEeOXfucg534VI2Leq4KbLapXnvujwcDv8AebvdXveWQUlsQaUVl6sl1t4ai80GK3I3mepoNBrfMngHPnJ4B6qaKk6I5dgif+zG5pPkUg7pFFgkdj2ZTIT4hLAr/v4FyDXUDR1JkiIrC+zTA3xqCnf6g9ytb/J8X+TTpzGKIlEK3s2PwIKaUF0uqD7PKM8FPqsSX9UFv6oKX+cLjvkRCYWclVGk3Pn8CiTGo4adJ2CWUkTKEsWFwSVKcnumRU78PE2xjWLRadaWTg3/EO61ZIe/AUzszhHS7DPmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/69bfb63567c2d934a920c5120ae77023/8ac56/driver-binary-ninja-009.webp 240w,\n/static/69bfb63567c2d934a920c5120ae77023/d3be9/driver-binary-ninja-009.webp 480w,\n/static/69bfb63567c2d934a920c5120ae77023/e46b2/driver-binary-ninja-009.webp 960w,\n/static/69bfb63567c2d934a920c5120ae77023/78953/driver-binary-ninja-009.webp 1303w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/69bfb63567c2d934a920c5120ae77023/8ff5a/driver-binary-ninja-009.png 240w,\n/static/69bfb63567c2d934a920c5120ae77023/e85cb/driver-binary-ninja-009.png 480w,\n/static/69bfb63567c2d934a920c5120ae77023/d9199/driver-binary-ninja-009.png 960w,\n/static/69bfb63567c2d934a920c5120ae77023/46e30/driver-binary-ninja-009.png 1303w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/69bfb63567c2d934a920c5120ae77023/d9199/driver-binary-ninja-009.png\"\n            alt=\"アドレス 0x1400012e0 の関数\"\n            title=\"アドレス 0x1400012e0 の関数\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>まずは関数呼び出し直後の以下のコードブロックを解析します。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">mov     qword [rsp+0x8 {__saved_rbx}], rbx\nmov     qword [rsp+0x18 {__saved_rdi}], rdi\npush    rbp {__saved_rbp}\nmov     rbp, rsp {__saved_rbp}\nsub     rsp, 0x80\nand     qword [rbp-0x60 {var_68}], 0x0\nmov     rax, rdx\nmov     rcx, rax\nlea     rdx, [rbp-0x60 {var_68}]\ncall    qword [rel PsLookupProcessByProcessId]\nmov     rcx, qword [rbp-0x60 {var_68}]\ncall    PsGetProcessImageFileName\nmov     rcx, qword [rbp-0x60 {var_68}]\nmov     rbx, rax\ncall    qword [rel ObfDereferenceObject]\nmov     rcx, rbx\ncall    sub_140001000\ntest    eax, eax\njne     0x1400013ec</code></pre></div>\n<p>このコードブロックではまずはじめに、コールバック関数が第 2 引数として受け取ったプロセス ID を引数として PsLookupProcessByProcessId 関数 <sup id=\"fnref-16\"><a href=\"#fn-16\" class=\"footnote-ref\">16</a></sup> が実行されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">NTSTATUS PsLookupProcessByProcessId(\n  [in]  HANDLE    ProcessId,\n  [out] PEPROCESS *Process\n);</code></pre></div>\n<p>この関数は PsSetCreateProcessNotifyRoutine で登録したコールバックルーチンですので、引数として ParentId、ProcessId、および Create の 3 つを受け取ります。<sup id=\"fnref-17\"><a href=\"#fn-17\" class=\"footnote-ref\">17</a></sup></p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">PCREATE_PROCESS_NOTIFY_ROUTINE PcreateProcessNotifyRoutine<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">PcreateProcessNotifyRoutine</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span> HANDLE ParentId<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span> HANDLE ProcessId<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span> BOOLEAN Create\n<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>つまり、PsLookupProcessByProcessId 関数は、このコールバックルーチンが受け取った ProcessId の値を受け取り、そのプロセスの EPROCESS 構造体へのポインタを取得していることがわかります。</p>\n<p>ここで受け取った EPROCESS 構造体へのポインタはスタック領域 <code class=\"language-text\">RBP-0x60</code> に格納されます。</p>\n<p>そして、次のコードではこのポインタアドレスを使用して PsGetProcessImageFileName 関数 <sup id=\"fnref-18\"><a href=\"#fn-18\" class=\"footnote-ref\">18</a></sup> を実行し、コールバックルーチンがキャプチャしたプロセスのイメージファイル名を取得しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">LPSTR NTAPI <span class=\"token function\">PsGetProcessImageFileName</span><span class=\"token punctuation\">(</span>PEPROCESS Process<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>LPSTR<span class=\"token punctuation\">)</span>Process<span class=\"token operator\">-></span>ImageFileName<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>PsGetProcessImageFileName 関数はドキュメント化されていない関数ではありますが、Sysinternals のニュースレターなどでプロセスのイメージファイル名を取得する用途で利用できる関数として紹介されています。<sup id=\"fnref-19\"><a href=\"#fn-19\" class=\"footnote-ref\">19</a></sup></p>\n<p>PsGetProcessImageFileName 関数でイメージファイルのファイル名を取得した後は、取得したファイル名を引数としてアドレス 0x140001000 の関数が実行されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">call    PsGetProcessImageFileName\n***\nmov     rbx, rax\n***\nmov     rcx, rbx\ncall    sub_140001000</code></pre></div>\n<p>この関数を Graph ビューで解析してみると、受け取ったファイル名を使用して非常に複雑な条件分岐が実装されており、一見する限りでは詳しい挙動を特定できません。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cbf1b53251766c7dd2b12a2a3ef4628e/d56b5/driver-binary-ninja-011.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB3ElEQVQ4y3VU2ZKbQAzka2yumeE+bAx4j2SPh1QlX5Cq5P8/oaMWzC7E64dGjJBa5xBM04Tp+oCH5++4jCPOw4C+7z/QdR3qukbbNDv9/zidThjENzgej1gQIgz3OBwOcJnDy/sbxnlGFEU3Nh7kiOMYAR/3QKOmbfH77x/8+PUTaZoijr62ZTBjDILUpEjSRI0p+ZEy4TlJYJ3Fy9srzpeLOnnn7buX5Ajo6A1IVJQFYiEiGc+h6NuuRZZlCCVj6unIbFjqNkMlLKoSeZHDWKMfzsNZh+CNaVjJuZahsJ8+Iw6Tdr53uwyzPEfXdyiFnC3g1HLRfRgLnGTYcaKnXonpzODOOQ1+UzIdWVYv42+kxHEaUUmAKPKZsjRpSVEoeVVXknWtpL58kivhZx8WaawV0g7Xx0cdDnuqWEsLw0ht2IaLBGZw7a3ZZqiDSFeChSQSGJchMUt/PbGxDk5aQju+F3UDk+Vwkr2szWocJ/vdWjNKjYXNSwlk9J3SinMpJAyUiI7ElFlZ7Xt4b2GHaUbd9QupZJRKuSRjAMV6tuwh18Xv3C2WYPN1/lyRdWdvIEPRKS83JdXDDl4vkveYVzDaLPJXlShhdCdivP4IrJTz9PxN/yTx5srdI/wHuEfNtFQR1PoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/cbf1b53251766c7dd2b12a2a3ef4628e/8ac56/driver-binary-ninja-011.webp 240w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/d3be9/driver-binary-ninja-011.webp 480w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/e46b2/driver-binary-ninja-011.webp 960w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/34ce3/driver-binary-ninja-011.webp 1215w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/cbf1b53251766c7dd2b12a2a3ef4628e/8ff5a/driver-binary-ninja-011.png 240w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/e85cb/driver-binary-ninja-011.png 480w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/d9199/driver-binary-ninja-011.png 960w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/d56b5/driver-binary-ninja-011.png 1215w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/cbf1b53251766c7dd2b12a2a3ef4628e/d9199/driver-binary-ninja-011.png\"\n            alt=\"アドレス 0x140001000 の関数\"\n            title=\"アドレス 0x140001000 の関数\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>しかし、以下の通りアドレス 0x140001000 の関数の戻り値が 0 の場合にのみ <code class=\"language-text\">FLAG{The_important_process_is_</code> を含むコードブロックに到達できることから、アドレス 0x140001000 の関数ではプロセスのイメージファイル名に対して何らかのチェックを行っている可能性が高いと推察できます。(アドレス 0x140001000 の関数の詳細な挙動については後述します)</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 905px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f3e95873469691a0e07a43f4f5308d9c/65d79/driver-binary-ninja-010.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACOUlEQVQ4y32U2Y7aQBBF+RmC2RISHDMGs4UBb93e7TaeRUoiRSMlykv+XzdVbWaCmAkPR71QdbvqdpvOaDxC3+ij3//HcDiEUgrfv37Dn1+/8fPHE2pV672qqtA0Dfb7PbrdLgaDgc7hkemMP7zXExZhBsMBRqMR5vM5ZvYNZksblj3DjWXBnE41Fs2nNBqG8VpwYn7UQlxpy1iLWjMLB/dAuAhFCNcPcCskDsRmu3kRuKQzmU7Q6/X0aYbRju9obX42sdvtsNvvsPcPNO6xPbi4JeHlaqXjOO8c3utMZyYcx8Hmy1azptNX6xWc5RILZ4HFomVJ2DNqnbBtW+9x3oLh3yneNM1WMIlj5GUJ9XBPHCGkQBAECMPwOkELx0optagWFKFAmmUo6BbzukRaZhDkGwuH5FkoxGlOUKKIIlpLLcIjx0RUFFvR+WRNIWkjLwrUda2fhWroadzVaOoCqiqRZTnyPEfGUFycpFpMkrA8icdJgtVq3VYY0QZXWDd3UI/EQ4Pm8R4lv7tjg7JSSNMMSZoSCQLfh/+M58PzPG2BQ162LYu2ZcUV1lThscSxUSiLFHEcIaBgTuZE7yTEvj3Da9bgS9KCrM4l88UUFVNo4SQmf04J5wLBxd4rwYh8yE4tl1WOKo+gCjogjfRhb4lcrVDSgivkW06LjNonsTzVQe5Zm9e4EJTacDZfe6ioWmo7S+iyYoEkkm9W9t8K2WxJ5meqpGcg6OZcTeB7L3j0TbtXYFH+Q/kLA3YdCiMkPqMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f3e95873469691a0e07a43f4f5308d9c/8ac56/driver-binary-ninja-010.webp 240w,\n/static/f3e95873469691a0e07a43f4f5308d9c/d3be9/driver-binary-ninja-010.webp 480w,\n/static/f3e95873469691a0e07a43f4f5308d9c/4d060/driver-binary-ninja-010.webp 905w\"\n              sizes=\"(max-width: 905px) 100vw, 905px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f3e95873469691a0e07a43f4f5308d9c/8ff5a/driver-binary-ninja-010.png 240w,\n/static/f3e95873469691a0e07a43f4f5308d9c/e85cb/driver-binary-ninja-010.png 480w,\n/static/f3e95873469691a0e07a43f4f5308d9c/65d79/driver-binary-ninja-010.png 905w\"\n            sizes=\"(max-width: 905px) 100vw, 905px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f3e95873469691a0e07a43f4f5308d9c/65d79/driver-binary-ninja-010.png\"\n            alt=\"アドレス 0x1400011a0 の関数\"\n            title=\"アドレス 0x1400011a0 の関数\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>アドレス 0x140001000 の関数で行われるイメージファイル名の検証にパスした場合、PsSetCreateProcessNotifyRoutine で登録したコールバック関数内では以下のコードが実行されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">xorps   xmm0, xmm0\nlea     ecx, [rax+0x1]\nmov     edi, 0x100\nmov     r8d, 0x67616c66\nmov     edx, edi  {0x100}\nmovups  xmmword [rbp-0x58 {Destination.Length} {Destination.MaximumLength} {Destination.Buffer}], xmm0\ncall    qword [rel ExAllocatePoolWithTag]</code></pre></div>\n<p>ここで実行されている ExAllocatePoolWithTag 関数 <sup id=\"fnref-19\"><a href=\"#fn-19\" class=\"footnote-ref\">19</a></sup> は、システムにメモリプールを割り当て、割り当てられたポインタを返す関数です。</p>\n<p>この関数の第 3 引数には割り当てたメモリ領域に指定するプールタグが指定されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">PVOID ExAllocatePoolWithTag(\n  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,\n  [in] SIZE_T                                         NumberOfBytes,\n  [in] ULONG                                          Tag\n);</code></pre></div>\n<p>そのため、Binary Ninja では認識されていませんが、<code class=\"language-text\">mov  r8d, 0x67616c66</code> の行で R8 レジスタに追加されている 0x67616c66 は、<code class=\"language-text\">g(0x67) a(0x61) l(0x6c) f(0x66)</code> というプールタグを指定するための 4 バイトの文字列であることがわかります。</p>\n<p>以降の処理については、逆アセンブル結果のみから解析しようとすると少々難しく感じますが、Binary Ninja のデコンパイル結果を参照すると簡単に挙動を把握できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bfd49b4ea82dd5711252f2824777f547/7b775/driver-binary-ninja-012.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABqUlEQVQoz32S626bQBSEeZqAbUywY9O45n4nMWDoGtNKVdoqSt//CSaz28ZyI5ofn86y4ozm7BzNXi4xn8+xkCwWmM1mWK9WOIkW4tSj7TuUZYE8z5FlmaIoCux2OxiGoXqv0W7NJQyKSCF5IX9ardf48fMJv19e8Pz8C0/fv2IYBIQgrOO3EWEUQdf1CUE6fBO7CNLhOAoMZ4HzSaDvezRti5Y0dY2mabHf7//jcFLQxnjqMIgjRRrUFKqPHR6bBlVZ4XA4fCA4NTIdnocvfMcj+q5FRxopTMFaOuTZc71pQfudwznPlmUhikLEUYAo8JGwxnGMIAiIr+rm7k4Jzv6aeUPzmFZV5ngsMzwUf6iqEmmaIqJIQvIsJQlSCqexJGTSGXKmnTH9PGdfVSBJYmgbjmfbthrzujrbrWqMQ1+5lI4932e6IVzXvfx7jbxTI9/oN9BpX66Bbuj81mFyJz/fO4gDD3kScv8SJSb3b821kuNOoW1ubVimCZm2DMgi8izvTL7pznHgM1GXOJ8c9c5T+3cJZbkwVfMUUliGdL+l03eL/E+QV7wC4IdpdY/YX5wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/bfd49b4ea82dd5711252f2824777f547/8ac56/driver-binary-ninja-012.webp 240w,\n/static/bfd49b4ea82dd5711252f2824777f547/d3be9/driver-binary-ninja-012.webp 480w,\n/static/bfd49b4ea82dd5711252f2824777f547/e46b2/driver-binary-ninja-012.webp 960w,\n/static/bfd49b4ea82dd5711252f2824777f547/f992d/driver-binary-ninja-012.webp 1440w,\n/static/bfd49b4ea82dd5711252f2824777f547/8b025/driver-binary-ninja-012.webp 1445w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/bfd49b4ea82dd5711252f2824777f547/8ff5a/driver-binary-ninja-012.png 240w,\n/static/bfd49b4ea82dd5711252f2824777f547/e85cb/driver-binary-ninja-012.png 480w,\n/static/bfd49b4ea82dd5711252f2824777f547/d9199/driver-binary-ninja-012.png 960w,\n/static/bfd49b4ea82dd5711252f2824777f547/07a9c/driver-binary-ninja-012.png 1440w,\n/static/bfd49b4ea82dd5711252f2824777f547/7b775/driver-binary-ninja-012.png 1445w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/bfd49b4ea82dd5711252f2824777f547/d9199/driver-binary-ninja-012.png\"\n            alt=\"コールバックルーチンのデコンパイル結果\"\n            title=\"コールバックルーチンのデコンパイル結果\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>まず、ExAllocatePoolWithTag 関数で取得したプール領域は Destination という <code class=\"language-text\">UNICODE_STRING</code> 構造体の Buffer に関連づけられます。</p>\n<p>そして、RtlInitAnsiString 関数と RtlAnsiStringToUnicodeString 関数によって、PsGetProcessImageFileName 関数で取得したイメージファイル名が <code class=\"language-text\">UNICODE_STRING</code> 構造体に変換されます。</p>\n<p>最後に、<code class=\"language-text\">UNICODE_STRING</code> 構造体を連結する RtlAppendUnicodeStringToString 関数によって Flag 文字列にイメージファイル名が連結され <code class=\"language-text\">FLAG{The_important_process_is_&lt;イメージファイル名>}</code> という文字列がプールタグ flag のメモリプールに書き込まれることになります。</p>\n<h2 id=\"イメージファイル名の検証を行う関数を解析する\" style=\"position:relative;\"><a href=\"#%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%90%8D%E3%81%AE%E6%A4%9C%E8%A8%BC%E3%82%92%E8%A1%8C%E3%81%86%E9%96%A2%E6%95%B0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B\" aria-label=\"イメージファイル名の検証を行う関数を解析する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>イメージファイル名の検証を行う関数を解析する</h2>\n<p>ここまでの解析結果から、アドレス 0x140001000 の関数による検証をパスできるイメージファイル名を持つプロセスが起動した場合に正しい Flag がメモリプールに書き込まれることがわかりました。</p>\n<p>前述の通り、この関数は受け取ったファイル名を使用する非常に複雑な条件分岐が実装されており、一見する限りでは詳しい挙動を特定できません。</p>\n<p>しかし、後はこの検証をパスできるファイル名を特定すれば 2 つ目の Flag を特定できそうです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cbf1b53251766c7dd2b12a2a3ef4628e/d56b5/driver-binary-ninja-011.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB3ElEQVQ4y3VU2ZKbQAzka2yumeE+bAx4j2SPh1QlX5Cq5P8/oaMWzC7E64dGjJBa5xBM04Tp+oCH5++4jCPOw4C+7z/QdR3qukbbNDv9/zidThjENzgej1gQIgz3OBwOcJnDy/sbxnlGFEU3Nh7kiOMYAR/3QKOmbfH77x/8+PUTaZoijr62ZTBjDILUpEjSRI0p+ZEy4TlJYJ3Fy9srzpeLOnnn7buX5Ajo6A1IVJQFYiEiGc+h6NuuRZZlCCVj6unIbFjqNkMlLKoSeZHDWKMfzsNZh+CNaVjJuZahsJ8+Iw6Tdr53uwyzPEfXdyiFnC3g1HLRfRgLnGTYcaKnXonpzODOOQ1+UzIdWVYv42+kxHEaUUmAKPKZsjRpSVEoeVVXknWtpL58kivhZx8WaawV0g7Xx0cdDnuqWEsLw0ht2IaLBGZw7a3ZZqiDSFeChSQSGJchMUt/PbGxDk5aQju+F3UDk+Vwkr2szWocJ/vdWjNKjYXNSwlk9J3SinMpJAyUiI7ElFlZ7Xt4b2GHaUbd9QupZJRKuSRjAMV6tuwh18Xv3C2WYPN1/lyRdWdvIEPRKS83JdXDDl4vkveYVzDaLPJXlShhdCdivP4IrJTz9PxN/yTx5srdI/wHuEfNtFQR1PoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/cbf1b53251766c7dd2b12a2a3ef4628e/8ac56/driver-binary-ninja-011.webp 240w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/d3be9/driver-binary-ninja-011.webp 480w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/e46b2/driver-binary-ninja-011.webp 960w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/34ce3/driver-binary-ninja-011.webp 1215w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/cbf1b53251766c7dd2b12a2a3ef4628e/8ff5a/driver-binary-ninja-011.png 240w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/e85cb/driver-binary-ninja-011.png 480w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/d9199/driver-binary-ninja-011.png 960w,\n/static/cbf1b53251766c7dd2b12a2a3ef4628e/d56b5/driver-binary-ninja-011.png 1215w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/cbf1b53251766c7dd2b12a2a3ef4628e/d9199/driver-binary-ninja-011.png\"\n            alt=\"アドレス 0x140001000 の関数\"\n            title=\"アドレス 0x140001000 の関数\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>そこで、解析を簡単にするため、この関数のデコンパイル結果を参照することにします。</p>\n<p>関数の構造としては DoPClient でパスワードの検証を行っていた関数と非常に類似しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token class-name\">int64_t</span> <span class=\"token function\">sub_140001000</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> arg1<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">int128_t</span> var_48<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">int64_t</span> rax_1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>__security_cookie <span class=\"token operator\">^</span> <span class=\"token operator\">&amp;</span>var_48<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">int128_t</span><span class=\"token operator\">*</span> r10 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>var_48<span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">int32_t</span> rdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">__builtin_memcpy</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>var_48<span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;ハードコードされたバイト列>\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x34</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> r11 <span class=\"token operator\">=</span> arg1<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">int32_t</span> r9 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">int64_t</span> rax_3<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">int32_t</span> rax_2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">int32_t</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">uint8_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>r11<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rax_2 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r9 <span class=\"token operator\">&lt;=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">int32_t</span> rdx_3<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>r9<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">case</span> <span class=\"token number\">0</span><span class=\"token operator\">:</span>\n          <span class=\"token punctuation\">{</span>\n            rdx <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>rax_2 <span class=\"token operator\">*</span> <span class=\"token number\">0x1c</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">0xf74</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n\n      <span class=\"token punctuation\">{</span>中略<span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rdx <span class=\"token operator\">==</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>r10<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">{</span>\n        r9 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>r9 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        r11 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>r11<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        r10 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>r10 <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r9 <span class=\"token operator\">>=</span> <span class=\"token number\">0xd</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            rax_3 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    rax_3 <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">sub_140001420</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>rax_1 <span class=\"token operator\">^</span> <span class=\"token operator\">&amp;</span>var_48<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> rax_3<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最終的に検証に成功した場合にはこの関数が 0 を返却することがわかっています。</p>\n<p>つまり、上記のコードの while ループ内で実行されている以下の箇所がポイントになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rdx <span class=\"token operator\">==</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>r10<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  r9 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>r9 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  r11 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>r11<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  r10 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>r10 <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r9 <span class=\"token operator\">>=</span> <span class=\"token number\">0xd</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n      rax_3 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>このコードではまず、RDX レジスタの値が R10 レジスタの持つ UINT32 型の値と一致するかを比較しています。</p>\n<p>また、RDX レジスタの値が R10 レジスタの持つ UINT32 型の値と一致する場合には、R9 レジスタのインクリメントと、R10 および R11 レジスタの値を次の要素に変更する操作を実施しています。</p>\n<p>そして、もしインクリメントされた R9 レジスタの値が 13(0xd) 以上となった場合には、ループを抜けて関数は 0 を返します。</p>\n<p>R9 レジスタは 0 で初期化されており、while ループ内でインクリメントされていることから、ループ回数のカウンタであると考えられます。</p>\n<p>また、R11 レジスタには <code class=\"language-text\">char* r11 = arg1;</code> のコードで関数が引数として受け取ったイメージファイル名のポインタが格納されていることがわかります。</p>\n<p>さらに、RDX レジスタには <code class=\"language-text\">rdx = ((rax_2 * 0x1c) + 0xf74);</code> などのコードで、イメージファイル名の文字を 1 文字ずつ取り出したものに対して、何らかの演算を行った結果を持つようです。</p>\n<p>ここまでの解析結果から、この関数では引数として受け取ったイメージファイル名の文字列から 1 文字ずつ取り出し、何らかの演算を行った結果をハードコードされた整数値と比較していることがわかりました。</p>\n<p>また、初期値が 0 のループカウンタが 13(0xd) 以上となった場合にループを抜けることから、正解となるイメージファイル名の長さは 13 文字であることも特定できました。</p>\n<p>あとは、DoPClient と同じようにデバッガを使用して総当たり攻撃を実施することで 2 つ目の Flag となる正しいイメージファイル名を特定することができます。</p>\n<h2 id=\"本章のまとめ\" style=\"position:relative;\"><a href=\"#%E6%9C%AC%E7%AB%A0%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"本章のまとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>本章のまとめ</h2>\n<p>本章では、Binary Ninja を使用して DoPDriver の静的解析を行いました。</p>\n<p>DoPDriver もデバッガを使用して総当たりをすることで Flag を特定できそうです。</p>\n<p>カーネルデバッグを使った動的解析については 6 章で実施します。</p>\n<h2 id=\"各章へのリンク\" style=\"position:relative;\"><a href=\"#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF\" aria-label=\"各章へのリンク permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>各章へのリンク</h2>\n<ul>\n<li><a href=\"/magical-windbg-vol2-00\">まえがき</a></li>\n<li><a href=\"/magical-windbg-vol2-01\">1 章 環境構築</a></li>\n<li><a href=\"/magical-windbg-vol2-02\">2 章 DoPClient と DoPDriver の表層解析</a></li>\n<li><a href=\"/magical-windbg-vol2-03\">3 章 DoPClient の静的解析を行う</a></li>\n<li><a href=\"/magical-windbg-vol2-04\">4 章 DoPClient を動的解析する</a></li>\n<li><a href=\"/magical-windbg-vol2-05\">5 章 DoPDriver の静的解析を行う</a></li>\n<li><a href=\"/magical-windbg-vol2-06\">6 章 DoPDriver を動的解析する</a></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>Windows Vistaデバイスドライバプログラミング P.36 (浜田 憲一郎 著 / ソフトバンククリエイティブ / 2007 年)</p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-2\">\n<p>DRIVER<em>INITIALIZE コールバック関数 (wdm.h) [<a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nc-wdm-driver\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nc-wdm-driver</a></em>initialize](<a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_initialize\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_initialize</a>)</p>\n<a href=\"#fnref-2\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-3\">\n<p>WDF ドライバー用 DriverEntry ルーチン <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/wdf/driverentry-for-kmdf-drivers\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/wdf/driverentry-for-kmdf-drivers</a></p>\n<a href=\"#fnref-3\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-4\">\n<p>WDMデバイスドライバプログラミング完全ガイド 上 P.185 (Edward N.Dekker, Joseph M.Newcomer 著 / クイック 翻訳 / アスキー / 2000 年)</p>\n<a href=\"#fnref-4\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-5\">\n<p>IoCreateDevice 関数 (wdm.h) <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatedevice\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatedevice</a></p>\n<a href=\"#fnref-5\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-6\">\n<p>デバイス入出力制御 (IOCTL) <a href=\"https://learn.microsoft.com/ja-jp/windows/win32/devio/device-input-and-output-control-ioctl-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows/win32/devio/device-input-and-output-control-ioctl-</a></p>\n<a href=\"#fnref-6\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-7\">\n<p>DRIVER<em>OBJECT 構造体 (wdm.h) [<a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/ns-wdm-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/ns-wdm-</a></em>driver<em>object](<a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/ns-wdm-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/ns-wdm-</a></em>driver_object)</p>\n<a href=\"#fnref-7\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-8\">\n<p>リバースエンジニアリング - Pythonによるバイナリ解析技法 P.172 (Justin Seitz 著 / 安藤 慶一 翻訳 / オライリージャパン / 2010 年)</p>\n<a href=\"#fnref-8\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-9\">\n<p>UNICODE<em>STRING 構造体 (ntdef.h) [<a href=\"https://learn.microsoft.com/ja-jp/windows/win32/api/ntdef/ns-ntdef-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows/win32/api/ntdef/ns-ntdef-</a></em>unicode<em>string](<a href=\"https://learn.microsoft.com/ja-jp/windows/win32/api/ntdef/ns-ntdef-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows/win32/api/ntdef/ns-ntdef-</a></em>unicode_string)</p>\n<a href=\"#fnref-9\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-10\">\n<p>Windows カーネルモード セーフ文字列ライブラリ <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/kernel/windows-kernel-mode-safe-string-library\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/kernel/windows-kernel-mode-safe-string-library</a></p>\n<a href=\"#fnref-10\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-11\">\n<p>デバイスの種類の指定 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/kernel/specifying-device-types\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/kernel/specifying-device-types</a></p>\n<a href=\"#fnref-11\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-12\">\n<p>IoCreateSymbolicLink 関数 (wdm.h) <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatesymboliclink\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatesymboliclink</a></p>\n<a href=\"#fnref-12\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-13\">\n<p>WDMデバイスドライバプログラミング完全ガイド 上 P.146 (Edward N.Dekker, Joseph M.Newcomer 著 / クイック 翻訳 / アスキー / 2000 年)</p>\n<a href=\"#fnref-13\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-14\">\n<p>IofCompleteRequest 関数 (wdm.h) <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nf-wdm-iocompleterequest\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nf-wdm-iocompleterequest</a></p>\n<a href=\"#fnref-14\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-15\">\n<p>PsSetCreateProcessNotifyRoutine 関数 (ntddk.h) <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutine\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutine</a></p>\n<a href=\"#fnref-15\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-16\">\n<p>PsLookupProcessByProcessId 関数 (ntifs.h) <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/ntifs/nf-ntifs-pslookupprocessbyprocessid\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/ntifs/nf-ntifs-pslookupprocessbyprocessid</a></p>\n<a href=\"#fnref-16\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-17\">\n<p><code class=\"language-text\">PCREATE_PROCESS_NOTIFY_ROUTINE</code> コールバック関数 (ntddk.h) <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/ntddk/nc-ntddk-pcreate_process_notify_routine\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/ntddk/nc-ntddk-pcreate<em>process</em>notify_routine</a></p>\n<a href=\"#fnref-17\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-18\">\n<p>PsGetProcessImageFileName <a href=\"https://doxygen.reactos.org/d2/d9f/ntoskrnl_2ps_2process_8c.html#a3f0cede0033a188f9525531fb104c482\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://doxygen.reactos.org/d2/d9f/ntoskrnl<em>2ps</em>2process_8c.html#a3f0cede0033a188f9525531fb104c482</a></p>\n<a href=\"#fnref-18\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-19\">\n<p>ExAllocatePoolWithTag 関数 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nf-wdm-exallocatepoolwithtag\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/ddi/wdm/nf-wdm-exallocatepoolwithtag</a></p>\n<a href=\"#fnref-19\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","fields":{"slug":"/magical-windbg-vol2-05","tagSlugs":["/tag/magical-win-dbg/","/tag/windows/","/tag/win-dbg/"]},"frontmatter":{"date":"2024-05-26","description":"技術書典 16 で頒布した Magical WinDbg 2 - CTF で学ぶユーザモード & カーネルデバッギング - の WEB 版です。","tags":["Magical WinDbg","Windows","WinDbg"],"title":"Magical WinDbg VOL.2【5 章 DoPDriver の静的解析を行う】","socialImage":{"publicURL":"/static/e9bfc3718fd53ab58623a496fc9a302e/magical-windbg-vol2.png"}}}},"pageContext":{"slug":"/magical-windbg-vol2-05"}},"staticQueryHashes":["251939775","401334301","825871152"]}