{"componentChunkName":"component---src-templates-post-template-js","path":"/magical-windbg-vol2-06","result":{"data":{"markdownRemark":{"id":"23cb45dd-fcff-55cb-a2d1-97fa15cb1418","html":"<p>この章では、Windows カーネルデバッグを使用して DoPDriver を動的解析することで、2 つ目の Flag を特定します。</p>\n<p>5 章で確認した通り、2 つ目の Flag を特定するためには、checkImageFileName 関数(アドレス 0x140001000 の関数)の検証をパスできるイメージファイル名を持つプロセスを起動する必要があります。</p>\n<p>本章では、カーネルデバッグで DoPDriver の動的解析を行いつつ、総当たり攻撃で正しいイメージファイル名を特定します。</p>\n<p>なお、Windows カーネルドライバを仮想マシンにロードし、カーネルデバッグを行う環境のセットアップ方法については 1 章を参照してください。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li><a href=\"#driverentry-%E9%96%A2%E6%95%B0%E3%81%AE%E5%8B%95%E7%9A%84%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86\">DriverEntry 関数の動的解析を行う</a></li>\n<li><a href=\"#pssetcreateprocessnotifyroutine-%E3%81%A7%E7%99%BB%E9%8C%B2%E3%81%97%E3%81%9F%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E9%96%A2%E6%95%B0%E3%81%AE%E5%8B%95%E7%9A%84%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86\">PsSetCreateProcessNotifyRoutine で登録したコールバック関数の動的解析を行う</a></li>\n<li><a href=\"#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E8%A8%AD%E5%AE%9A%E3%81%A7%E7%B7%8F%E5%BD%93%E3%81%9F%E3%82%8A%E6%94%BB%E6%92%83%E3%81%AB%E3%82%88%E3%82%8A-flag-%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\">ブレークポイント設定で総当たり攻撃により Flag を特定する</a></li>\n<li><a href=\"#checkimagefilename-%E9%96%A2%E6%95%B0%E3%81%AE%E5%8B%95%E7%9A%84%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86\">checkImageFileName 関数の動的解析を行う</a></li>\n<li><a href=\"#javascript-%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%AC%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%A7%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%90%8D%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\">JavaScript ベースのデバッガスクリプトでイメージファイル名を特定する</a></li>\n<li><a href=\"#%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%97%E3%83%BC%E3%83%AB%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\">ページプールの情報を確認する</a></li>\n<li><a href=\"#%E3%83%97%E3%83%BC%E3%83%AB%E3%82%BF%E3%82%B0%E3%81%8B%E3%82%89%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\">プールタグからメモリブロックのアドレスを特定する</a></li>\n<li><a href=\"#poolhittag-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\">PoolHitTag を使用してメモリの割り当てアドレスを特定する</a></li>\n<li><a href=\"#6-%E7%AB%A0%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81\">6 章のまとめ</a></li>\n<li><a href=\"#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D\">あとがき</a></li>\n<li><a href=\"#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF\">各章へのリンク</a></li>\n</ul>\n<h2 id=\"driverentry-関数の動的解析を行う\" style=\"position:relative;\"><a href=\"#driverentry-%E9%96%A2%E6%95%B0%E3%81%AE%E5%8B%95%E7%9A%84%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86\" aria-label=\"driverentry 関数の動的解析を行う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DriverEntry 関数の動的解析を行う</h2>\n<p>5 章に記載の通り、DoPDriver のようなカーネルドライバモジュールは起動時に DriverEntry 関数が実行されます。</p>\n<p>しかし、カーネルドライバの場合はユーザモードプログラムとは異なり、プログラムをデバッガから起動することはできません。</p>\n<p>また、DriverEntry 関数にブレークポイントを設定してデバッグを行うためには少し特別なアプローチが必要になります。</p>\n<p>その理由は、ドライバのロードが行われるまで DoPDriver のルーチン名を利用できず、DriverEntry 関数に bp コマンドを使用してブレークポイントを設定できないためです。</p>\n<p>そのため、DriverEntry 関数のデバッグを行うためには bu コマンドを使用して未解決のルーチン名に対して遅延ブレークポイントを設定するか、WinDbg の機能でモジュールのロード時のデバッグを有効化する必要があります。</p>\n<p>bu コマンドで DriverEntry 関数に遅延ブレークポイントを設定する場合には、<code class=\"language-text\">bu DoPDriver+0x11cc</code> コマンドを使用します。</p>\n<p><code class=\"language-text\">bu DoPDriver+0x11cc</code> コマンドの実行後に DoPDriver がロードされると、ルーチン名が自動的に解決されて DriverEntry 関数でシステムが一時停止します。</p>\n<p>なお、DriverEntry 関数のデバッグを行うために最も簡単は方法は bu コマンドによる遅延ブレークポイントの設定かと思いますが、本書ではあえてモジュールのロード時のデバッグを有効化する方法を使用することにします。</p>\n<p>モジュールのロード時のデバッグを有効化する場合は、WinDbg をカーネルデバッガとして仮想マシンにアタッチした後に WinDbg の [File]>[Settings] を開き、[Events &#x26; Exception] の [Load module on all modules] の設定を [Break] に変更します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 926px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7dfbb6d27ebd59e5e52a8495f81ff879/69476/driver-kernel-debug-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACKUlEQVQ4y31T227TQBA1PADqEyp9RSDxtVXVi0pA7XfxRArEvcix48t6vTfbiXOYmcQhEVVHGq13vXvmnNmz0afbW0Snp/hwdYXfT08wuoEPAc55ybZt0XU9+n5JYyfJ38vdvEcIrextGoPozfk53l1e4uNkgun9A5y1MGaTVaVoNNBaoyxLWPrnnKP1Cmlewlgn+3k9EIk8LxjwAseTr/hyc4Mf0yni2R85vFqttmw6WALp+x4cvGapiPMtVsOA/Wg0MXx7cYH319f4/O07fsYx0iRBTYwYsG07ktFI9fV6jWFYy5yTgbkdvM7JoaldO8kn1MPHbIFAbDQdWBKj2nhUqoZSClmaijRrjcgchpXsOQCsCfCIwI4I7JjGnIB2QZs0AXIvuYdFUaAlphUdSvIKhbZQ9G8fkPcKw+jsTG55UWv5MWw3GReg6lokMihfyDzL8TDPUTSkxIUDQEfz6DWBsW1O9gA3/RrkIswWbIySmNbUApbbhkNAaz2i6AVAHzrpW00sx4thWey3li+Fcj+E4atnAEfJDR3OidEomeWzL7lIT2Dee1HBuVySGuOeBxwtsnkBGyOzN/kg26WqSswXJTHshf0iy6AaZv4i4LB5Vt4LQ/YcB0svywIlvSIuyIUUWaujYs1/DPUhw1bYVGLYf6+hEclrKhh8QEr+ZED2pVL6EHAaP6Igj6VpjiwrZJzPF5LjGn8nSbZbT5IUs1mMOL7H3d0v/AWzRvFpGVJ8IQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7dfbb6d27ebd59e5e52a8495f81ff879/8ac56/driver-kernel-debug-001.webp 240w,\n/static/7dfbb6d27ebd59e5e52a8495f81ff879/d3be9/driver-kernel-debug-001.webp 480w,\n/static/7dfbb6d27ebd59e5e52a8495f81ff879/dafe9/driver-kernel-debug-001.webp 926w\"\n              sizes=\"(max-width: 926px) 100vw, 926px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7dfbb6d27ebd59e5e52a8495f81ff879/8ff5a/driver-kernel-debug-001.png 240w,\n/static/7dfbb6d27ebd59e5e52a8495f81ff879/e85cb/driver-kernel-debug-001.png 480w,\n/static/7dfbb6d27ebd59e5e52a8495f81ff879/69476/driver-kernel-debug-001.png 926w\"\n            sizes=\"(max-width: 926px) 100vw, 926px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7dfbb6d27ebd59e5e52a8495f81ff879/69476/driver-kernel-debug-001.png\"\n            alt=\"Load module on all modules の設定変更\"\n            title=\"Load module on all modules の設定変更\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>[Load module on all modules] の設定を [Break] に変更した後、g コマンドでシステムの実行を再開し、DoPClient により DoPDriver をシステムにロードさせます。</p>\n<p>設定が正しく反映されている場合、このタイミングで仮想マシンのシステムが一時停止し、カーネルデバッガのコマンド操作が可能になります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a826d54c05a22ea273fa1f080bfa0ceb/78415/driver-kernel-debug-002.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA7UlEQVQoz41Qi26DMAzM///dxmgQBALiMbYAg4rwkuDqeKLapkmtpZMdx7mcTyilkOc5jDHo+y9CD2stpmnCvu8PcRzHr7OI45jJ1nVlImtnzPOCZVkoz4zv/v8Yx/FeOxEiDEMEQQCXFZF7XgcV1UgShbr+4M+KoiCUqKqKUZblHW67szbmE8INNE3Dg13XoTEt1e/ca9uWlW/bxvknzt7fOyGlT2o0K9Q6wfU6ICZfoyhCmqZM7Lx5NmjlgAkTrYlQYxgGZFnGhM7fcbRs/LMQb94Lq/N9n/x7pTXJQ1J4uUhIKdHTBy7OB4/iBu8MFeUZhyKfAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a826d54c05a22ea273fa1f080bfa0ceb/8ac56/driver-kernel-debug-002.webp 240w,\n/static/a826d54c05a22ea273fa1f080bfa0ceb/d3be9/driver-kernel-debug-002.webp 480w,\n/static/a826d54c05a22ea273fa1f080bfa0ceb/e46b2/driver-kernel-debug-002.webp 960w,\n/static/a826d54c05a22ea273fa1f080bfa0ceb/459db/driver-kernel-debug-002.webp 1207w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a826d54c05a22ea273fa1f080bfa0ceb/8ff5a/driver-kernel-debug-002.png 240w,\n/static/a826d54c05a22ea273fa1f080bfa0ceb/e85cb/driver-kernel-debug-002.png 480w,\n/static/a826d54c05a22ea273fa1f080bfa0ceb/d9199/driver-kernel-debug-002.png 960w,\n/static/a826d54c05a22ea273fa1f080bfa0ceb/78415/driver-kernel-debug-002.png 1207w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a826d54c05a22ea273fa1f080bfa0ceb/d9199/driver-kernel-debug-002.png\"\n            alt=\"ドライバロード時にシステムが一時停止する\"\n            title=\"ドライバロード時にシステムが一時停止する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>[Load module on all modules] のデバッガ設定によって DoPDriver のロード時にシステムを一時停止することで、DoPDriver のシンボルを使用してブレークポイントを設定することができるようになります。</p>\n<p>そこで、DriverEntry 関数の解析を行うため、5 章で確認した DriverEntry 関数のアドレスである <code class=\"language-text\">DoPDriver+0x11cc</code> に対してブレークポイントを設定します。</p>\n<p>WinDbg をカーネルデバッガとして使用する場合も、多くのコマンドはユーザモードプログラムのデバッグを行う際と共通しています。</p>\n<p>そのため、<code class=\"language-text\">bp DoPDriver+0x11cc ; g</code> コマンドを実行することで DriverEntry 関数にブレークポイントを設定した上で、システムの実行を再開します。</p>\n<p>ブレークポイントを設定してシステムの実行を再開すると、すぐに <code class=\"language-text\">DoPDriver+0x11cc</code> でシステムが一時停止します。</p>\n<p>ここで、<code class=\"language-text\">uf @rip</code> などのコマンドを発行することで、DriverEntry 関数の逆アセンブル結果を参照できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 708px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d0d87671154942423c3a51540095c639/3cb0f/driver-kernel-debug-003.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB7klEQVQoz2VT13LqUAz0/39XCMGAfdzAvWCKC31432iVOPdO8qCRT1utdmVrs9nAcRykaYbb7Ybz+az5er1qnr6n9e/8O6yPhQ1n7cD3A8TbLaqqxuv1UuA8z9F1HZI0wTAMeD6feDweGvy+3+8aXE9FvgAdF67LcGDbtmSDrYBnWYa+H+AZF1G0QdM00kmKoiiQJIkUr2Sv1jULKkN7uYTneQjDCEHgYz6f6+UsS5UhL/q+L4AhIpGHhaMoQprlGMcRl8vlJyvgwl7qJbZsJM/e3kBdd22rDLq+RyCAxhhlV9c1drsdWjknY35z7z+GKwEyyoIP1+u1MCtwPB5RlqW03GvBoih1j0UINrGi1n8ZOq4Cep4RvTzEcaz6sfJJTOE+JaFW1JZSVHJGhm1LhtVfhp7nq/jvsxkWYlQomjXyqOt6BTSiM7VbrVaidaDgZMsuUtG76zt13LKFIQF5yZdHNIUgg7TKRxwbsg/DUNcEIPNRWp1aZkxzaS1Xax0T1VBAZ8IwlXbHcVCA4+mkZ/E2Vob8CUph9m+YOfS377hSQ1s1NKKd/20K2z8JEHU8HA7q8KRfGAY/blO/L5Ma1FWuZlkEikTwjVzmuOz3e538XlolEzprRFvOJs2oxQgWymQOuS6KHGlyEfZkesEnK91e0h2ObiQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/d0d87671154942423c3a51540095c639/8ac56/driver-kernel-debug-003.webp 240w,\n/static/d0d87671154942423c3a51540095c639/d3be9/driver-kernel-debug-003.webp 480w,\n/static/d0d87671154942423c3a51540095c639/3f436/driver-kernel-debug-003.webp 708w\"\n              sizes=\"(max-width: 708px) 100vw, 708px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/d0d87671154942423c3a51540095c639/8ff5a/driver-kernel-debug-003.png 240w,\n/static/d0d87671154942423c3a51540095c639/e85cb/driver-kernel-debug-003.png 480w,\n/static/d0d87671154942423c3a51540095c639/3cb0f/driver-kernel-debug-003.png 708w\"\n            sizes=\"(max-width: 708px) 100vw, 708px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/d0d87671154942423c3a51540095c639/3cb0f/driver-kernel-debug-003.png\"\n            alt=\"DriverEntry の逆アセンブル結果を参照する\"\n            title=\"DriverEntry の逆アセンブル結果を参照する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>5 章で確認した通り、DriverEntry 関数ではまずはじめに DeviceName などを引数として IoCreateDevice 関数でデバイスオブジェクトを作成しています。</p>\n<p>ここではまず、IoCreateDevice 関数の引数として受け渡される <code class=\"language-text\">UNICODE_STRING</code> 構造体のオブジェクトである DeviceName の値と、ドライバオブジェクトにディスパッチルーチンとして設定される関数のアドレスをデバッガで特定します。</p>\n<p>解析を行うため、<code class=\"language-text\">call  qword [rel IoCreateDevice]</code> のコードを実行する <code class=\"language-text\">DoPDriver+0x1229</code> まで実行を進めます。</p>\n<p>特定のアドレスまで実行を進める方法はいくつかありますが、今回は <code class=\"language-text\">pa DoPDriver+0x1229</code> コマンドを使用して <code class=\"language-text\">DoPDriver+0x1229</code> まで一気にステップ実行を進めました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 715px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0fb8f0402bc7ab6bc2cdeefff42c79af/d0c0e/driver-kernel-debug-004.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 90.41666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACRUlEQVQ4y4WUyZbaQAxF+f9PI2CTNBgIo/GAJ8Bm2iq6sssNnfTJQkdQlK6ehmLwe7mU5WIhs1kg6/VakjSVsizl8XjItWnkdruZPZ9Pud/v3xr3scGP4VC88Vg8z1foTI7Ho1RVJXVdS3Q4SJZlEkWR5Hkul8vlWzufz3I6nWQwNpgn+I9fH7JUxavVSlJVinEJIOqBZpowTY+WOI5jrShRH9k9wAb0FQh0qgp3u51BgyCQ/X4vRVFa4Ha7te+AN5uNJeWcCpIk+QRS8ng0UoWeBPO5XQZaFLkctGT6iQ/D0AIBAj4eMwPQmrpu+rIH1j81gHMFkpngRgeSdgOi5DDc9wkwgr9aX7JnJetQgnbSDkpJBOM5d2dtgtCUkgRfVad3IAqn06mVjNJIA1HIxMMukD4xmKIo7LMz7rwp9DsggwDIFF3JBlQ1AOkbnl4CaJq662H92UNgk4mv9tOmG0UHg2CsRllWViIgd04bUJnlmSnOddK9QgP6vvh+u9j0CjBrEqsSAABRjlJ+3253dobRU0vm1qZVOOleSmAggAs1Ljsgq+T28WAvKO/7iT/9rXAiC33Tbg/jOLFe9Qo7EL//X6Hvm0qUtaUd5Hq99ntIEKvBd6fqooNgcCw1vh/KSF8Ja+NryUG3h2Rkcq9AVCcdkOfGuvxzsVvY+9oAJeB1bdyk17r0fHaArzYYdm95NBr3i03plEUP8e5V4N0/EcFusV9VDngVrS1MmXtm7Q6WphAwQ4qitpftMCI753OS6Lkm4+4fdmUjQ9eZLakAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/0fb8f0402bc7ab6bc2cdeefff42c79af/8ac56/driver-kernel-debug-004.webp 240w,\n/static/0fb8f0402bc7ab6bc2cdeefff42c79af/d3be9/driver-kernel-debug-004.webp 480w,\n/static/0fb8f0402bc7ab6bc2cdeefff42c79af/cb533/driver-kernel-debug-004.webp 715w\"\n              sizes=\"(max-width: 715px) 100vw, 715px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/0fb8f0402bc7ab6bc2cdeefff42c79af/8ff5a/driver-kernel-debug-004.png 240w,\n/static/0fb8f0402bc7ab6bc2cdeefff42c79af/e85cb/driver-kernel-debug-004.png 480w,\n/static/0fb8f0402bc7ab6bc2cdeefff42c79af/d0c0e/driver-kernel-debug-004.png 715w\"\n            sizes=\"(max-width: 715px) 100vw, 715px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/0fb8f0402bc7ab6bc2cdeefff42c79af/d0c0e/driver-kernel-debug-004.png\"\n            alt=\"IoCreateDevice の呼び出しアドレスまでステップ実行する\"\n            title=\"IoCreateDevice の呼び出しアドレスまでステップ実行する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>pa コマンド <sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup> はステップ実行コマンドの一種ですが、指定のアドレスまでステップ実行をまとめて行うことができるため、ブレークポイントを設定することなく指定のアドレスまで実行を進める際などに便利です。</p>\n<p>ただし、pa コマンドではプログラムはステップ実行されるため、実行時のオーバーヘッドが大きくなります。</p>\n<p>そのため、指定のアドレスまでのステップ数が多い場合には g コマンドなどを利用する方がよいでしょう。</p>\n<p>pa コマンドによって IoCreateDevice 関数の呼び出し直前のアドレス(<code class=\"language-text\">DoPDriver+0x1229</code>)まで到達したので、次は <code class=\"language-text\">r rcx,rdx,r8,r9 ; dps rsp L3</code> コマンドでレジスタとスタックの情報を参照します。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1: kd> r rcx,rdx,r8,r9 ; dps rsp L3\nrcx=ffff818bb49eaa70 rdx=0000000000000000 r8=ffffbc0b8ff338a0 r9=0000000000000022\nffffbc0b`8ff33860  00000000`00000000\nffffbc0b`8ff33868  00000000`00000000\nffffbc0b`8ff33870  ffff818b`b71e83d0</code></pre></div>\n<p>Windows の x64 呼び出し規約では、引数がすべて整数値の場合、第 1 引数は RCX レジスタに、第 3 引数は R8 レジスタに格納されます。</p>\n<p>つまり、IoCreateDevice 関数の第 1 引数として設定されるドライバオブジェクトへのポインタは RCX に、そして第 3 引数として渡される DeviceName は R8 レジスタが持つアドレスに格納されています。</p>\n<p>実際に、<code class=\"language-text\">db @R8 L0x10</code> コマンドで R8 レジスタが指すアドレスのデータを出力しても、DeviceName は文字列としては保存されていないことを確認できます。</p>\n<p>しかし、<code class=\"language-text\">dt nt!_UNICODE_STRING @R8</code> コマンドで R8 レジスタが指すアドレスを <code class=\"language-text\">UNICODE_STRING</code> 構造として解釈させると、<code class=\"language-text\">\\Device\\DoPDriver</code> という DeviceName が定義されていることをデバッガでも確認することができました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 686px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b4c374a39ef9aa88718184128e402b7d/f6386/driver-kernel-debug-005.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABKUlEQVQoz41R246CQAyd//81dV1uicIICogRBLmjCJ5ta9y4b0tyUkpnzqUorTUMwyCYcBwH3+s1FosF+Pt+v4e73UotigJVVf1BWZa/ePfqcDjIZdf1EMcxkuSIKIqQZRciuaLrOrRth2EYBK++kTqOI263G6ZpkneuKk1TnM9nJKcTkaTIqI+IOAxDHImcBd9CQRAI+DyLJkkirvq+J4FWqmJ3lmXBtm2J7tgWVqsvmKZJrl0sl0tYNON1aO0JWZ7nJJ4J6romxy2aphEo3g+78H1PXHQ05Gh8ieM8pgfmecZ/H7Xzd9hsNDmISTGn5ZYyiCnSidbA5ByFwQKveJ244f75fMp5rgzFC66qHpcMdGAmN5MMhqGXKJ+43+/yQ5iMo7LYJxnjB8FWEBydqg5IAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b4c374a39ef9aa88718184128e402b7d/8ac56/driver-kernel-debug-005.webp 240w,\n/static/b4c374a39ef9aa88718184128e402b7d/d3be9/driver-kernel-debug-005.webp 480w,\n/static/b4c374a39ef9aa88718184128e402b7d/7dbce/driver-kernel-debug-005.webp 686w\"\n              sizes=\"(max-width: 686px) 100vw, 686px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b4c374a39ef9aa88718184128e402b7d/8ff5a/driver-kernel-debug-005.png 240w,\n/static/b4c374a39ef9aa88718184128e402b7d/e85cb/driver-kernel-debug-005.png 480w,\n/static/b4c374a39ef9aa88718184128e402b7d/f6386/driver-kernel-debug-005.png 686w\"\n            sizes=\"(max-width: 686px) 100vw, 686px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b4c374a39ef9aa88718184128e402b7d/f6386/driver-kernel-debug-005.png\"\n            alt=\"IoCreateDevice の呼び出し時の第 3 引数を確認する\"\n            title=\"IoCreateDevice の呼び出し時の第 3 引数を確認する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>DeviceName を確認できたので、次はドライバオブジェクトの情報を参照し、ディスパッチルーチンに設定されている値を確認してみます。</p>\n<p>ドライバオブジェクトのポインタは、IoCreateDevice 関数の第 1 引数である RCX レジスタに保持されています。</p>\n<p>このアドレスに対して <code class=\"language-text\">dt nt!_DRIVER_OBJECT @RCX</code> コマンドを実行すると、DriverName が <code class=\"language-text\">\\Device\\DoPDriver</code> に設定されているドライバオブジェクトの情報を参照できます。</p>\n<p>さらに MajorFunction をクリックすると、5 章で確認した通り <code class=\"language-text\">DriverObject->MajorFunction[0(IRP_MJ_CREATE)]</code> と <code class=\"language-text\">DriverObject->MajorFunction[2(IRP_MJ_CLOSE)]</code> の 2 つのディスパッチルーチンが登録されており、それぞれ登録されている関数のアドレスを確認することができました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9d31ccc98a589ebfed8b3cf1a8902a45/29229/driver-kernel-debug-006.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB50lEQVQoz32SXW+bMBSG8/9/xNZpa+83ad3HRdutiaZVSklFABuDKQGMCZAPkqsky7tjN43SVRrSI5uDec6xfXqO4yBNUyilIJMEi8UCy+US8/n8hBlmsydexl/Tu7v7Dc/z0DQ1fN9HFMdISFxV1XGRSfIvJv6c5BQSBri9LSFERWIXjjOyCTxvTDEBrUsr11rTqO3cjG3bvpAeKxwMOK6uO8RyDsYZAhbS1lM6hgxZrlDXLQlqqHJq0bqBrpqj8JljhYHr42GYIuYc3HeIEbjnYCJ9pDKAymKUeYxZHWO1eKRRoFLMVmxEXdfZM1+tVliv11Rh+wXun4+4yi7wafwG3+QHfE/O8VWc4TJ8h8/EJc1v8vf4WZzjRr3Fj8kFVdjQWRpRh81mg+12i91uh15OZnIjUAID9xcekjG8LMBQOLiPRhgS9zR304DiIfyc0xoPUkqUZWkv6PTprQ/vUzUF8xjyNKctlkgiSSQHJG1dQRclNJ1rKh8RUzeYVjPbNs9+v7f0mmZvA0VRwHVd2zKTyQShCO0th5bQxvI8JzK6QPkfYf0k1LpCEAS2yc2PURRZhDCjQJZlFC9Q0Dd5EJotvxLWByHnIfr9PkIazWLf98AZA2OcYFZiqswI0/wmmUls2udU+Bc38ycnIq1ZBQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/9d31ccc98a589ebfed8b3cf1a8902a45/8ac56/driver-kernel-debug-006.webp 240w,\n/static/9d31ccc98a589ebfed8b3cf1a8902a45/d3be9/driver-kernel-debug-006.webp 480w,\n/static/9d31ccc98a589ebfed8b3cf1a8902a45/e46b2/driver-kernel-debug-006.webp 960w,\n/static/9d31ccc98a589ebfed8b3cf1a8902a45/3eff0/driver-kernel-debug-006.webp 1167w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/9d31ccc98a589ebfed8b3cf1a8902a45/8ff5a/driver-kernel-debug-006.png 240w,\n/static/9d31ccc98a589ebfed8b3cf1a8902a45/e85cb/driver-kernel-debug-006.png 480w,\n/static/9d31ccc98a589ebfed8b3cf1a8902a45/d9199/driver-kernel-debug-006.png 960w,\n/static/9d31ccc98a589ebfed8b3cf1a8902a45/29229/driver-kernel-debug-006.png 1167w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/9d31ccc98a589ebfed8b3cf1a8902a45/d9199/driver-kernel-debug-006.png\"\n            alt=\"ドライバオブジェクトのディスパッチルーチンを確認する\"\n            title=\"ドライバオブジェクトのディスパッチルーチンを確認する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"pssetcreateprocessnotifyroutine-で登録したコールバック関数の動的解析を行う\" style=\"position:relative;\"><a href=\"#pssetcreateprocessnotifyroutine-%E3%81%A7%E7%99%BB%E9%8C%B2%E3%81%97%E3%81%9F%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E9%96%A2%E6%95%B0%E3%81%AE%E5%8B%95%E7%9A%84%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86\" aria-label=\"pssetcreateprocessnotifyroutine で登録したコールバック関数の動的解析を行う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PsSetCreateProcessNotifyRoutine で登録したコールバック関数の動的解析を行う</h2>\n<p>次は、PsSetCreateProcessNotifyRoutine で登録したコールバック関数の動作をデバッガで確認してみましょう。</p>\n<p>まずは、<code class=\"language-text\">bp DoPDriver+0x12E0 ; g</code> コマンドでブレークポイントを設定してシステムの実行を再開します。</p>\n<p>すると、システムで何らかのプロセスの作成もしくは削除が行われるまで、システムは中断されず、デバッガコマンドが利用できない状態になることを確認できます。</p>\n<p>続けて、<code class=\"language-text\">bc *</code> コマンドですべてのブレークポイント設定をクリアした後に、今度は <code class=\"language-text\">bp DoPDriver+0x131C \"da @RAX ; g\"</code> コマンドで新しいコマンド付きブレークポイントを設定し、g コマンドでシステムの実行を再開します。</p>\n<p>アドレス <code class=\"language-text\">DoPDriver+0x131C</code> は、5 章で確認したプロセスのイメージファイル名を返す PsGetProcessImageFileName 関数を実行した直後のアドレスです。</p>\n<p>PsGetProcessImageFileName 関数は戻り値にプロセスのイメージファイル名を返すので、<code class=\"language-text\">da @RAX</code> コマンドを実行することで、取得したイメージファイル名をコンソールに出力できます。</p>\n<p>実際にこのブレークポイントを設定することで、システム内で何らかのプロセスが作成される度に <code class=\"language-text\">da @RAX</code> コマンドが実行され、イメージファイル名がコンソールに出力されることを確認できました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 619px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6e1cf38b3bbc9c664ae330e7cd0a394a/e628c/driver-kernel-debug-007.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABu0lEQVQ4y5VT2ZKiQBDk/z9tnkYY5UYOhQZBQQ5FkJyqcnbDp92hIzKaPsjKyqrWmqZGniso1aGqFpzPTzT1THNJ+znNZ8E0zWjbFmVZCi6Xi5zzzOvb7YZlWaCBxjgOMHcTPj6AzQZw3QXHYwTbthGGISzbQtcPFLCE53pwPQ9hFME0Tbp3lHtFcWIqaBy1rjlaiyIfKdpIUUeKOOB6vRL4vMYwDOj7Hk3TCPiM59f/Ndquw+PxgKayDGma0oWa+Cc8nw/CRClOmOf5L3j9vvfn+30WwowIGSpTyFVOSgtZ1z8eJUkiPnVdj/v9Ll79C5rvudjtTETkSRAEUgBWnCQx0mMq6bDZv4W2D3xYliXmG19fKE4nMZ73WCmns2ZocURVNC3EcUwkr2qF+z1835N0azKex68VMqFtO6/2IFVVVQmR4zgShKv4TvhfhZzydruDR731+bkhhYWoM3SdSG1kSq0j9FyHmlkXRbpukG9KyA1DpwZ3UVGRljWEAanhKgek1DBeReH0mYxfATfz6pRNKgq3jUkenuhdsne+79P7VriP4zqFKktJ3R6Hw0FSPVMTcx+ySiZcq/Ab2vUtc5Ugi2gAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/6e1cf38b3bbc9c664ae330e7cd0a394a/8ac56/driver-kernel-debug-007.webp 240w,\n/static/6e1cf38b3bbc9c664ae330e7cd0a394a/d3be9/driver-kernel-debug-007.webp 480w,\n/static/6e1cf38b3bbc9c664ae330e7cd0a394a/3aa79/driver-kernel-debug-007.webp 619w\"\n              sizes=\"(max-width: 619px) 100vw, 619px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/6e1cf38b3bbc9c664ae330e7cd0a394a/8ff5a/driver-kernel-debug-007.png 240w,\n/static/6e1cf38b3bbc9c664ae330e7cd0a394a/e85cb/driver-kernel-debug-007.png 480w,\n/static/6e1cf38b3bbc9c664ae330e7cd0a394a/e628c/driver-kernel-debug-007.png 619w\"\n            sizes=\"(max-width: 619px) 100vw, 619px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/6e1cf38b3bbc9c664ae330e7cd0a394a/e628c/driver-kernel-debug-007.png\"\n            alt=\"コールバック関数をトリガーしたプロセスのイメージファイル名\"\n            title=\"コールバック関数をトリガーしたプロセスのイメージファイル名\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"ブレークポイント設定で総当たり攻撃により-flag-を特定する\" style=\"position:relative;\"><a href=\"#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E8%A8%AD%E5%AE%9A%E3%81%A7%E7%B7%8F%E5%BD%93%E3%81%9F%E3%82%8A%E6%94%BB%E6%92%83%E3%81%AB%E3%82%88%E3%82%8A-flag-%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"ブレークポイント設定で総当たり攻撃により flag を特定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ブレークポイント設定で総当たり攻撃により Flag を特定する</h2>\n<p>それでは WinDbg を使用して checkImageFileName 関数(アドレス 0x140001000 の関数)の検証をパスできるイメージファイル名を特定していきます。</p>\n<p>まずは、最もシンプルなブレークポイントを使用する方法で Flag を取得することを試みます。</p>\n<p>例えば、以下の 2 つのブレークポイントを設定すると、何らかのプロセスが起動する度に、そのイメージファイル名をコンソール上に表示した後、checkImageFileName 関数の検証をパスしたか否かを出力できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">bp DoPDriver+0x131C \"da @RAX ; g\"\nbp DoPDriver+0x1333 \".if (@zf == 1) { .printf \\\"======> Correct\\\\n \\\" } .else { .printf \\\"======> Failed\\\\n \\\" ; g }\"</code></pre></div>\n<p>2 つ目のブレークポイントでは、checkImageFileName 関数の戻り値を比較した後にゼロフラグが 1 であるか否かによって処理を分岐させています。</p>\n<p>イメージファイル名が checkImageFileName 関数の検証をパスした場合、Correct という文字列を出力してシステムの実行を一時停止します。</p>\n<p>一方で、イメージファイル名が検証をパスしなかった場合は、Failed という文字列を出力した後に g コマンドでプログラムの実行を再開します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a2f3ccc5325da5ffbfb7bc0706494928/0fb99/driver-kernel-debug-008.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA2klEQVQoz6WSiQ6CMBBE+f9flCMUaORquSyQaMfuAkqixmuTybKknbxZ8OI4hn/wEUURhBBIkgTCqWkaaK2htOLnuq557roOSikWvSdVVcW9bVt4+fGIIAiQSYlhGFCWJfq+B5W19tY37ef9ma08MiC6LMtgjGGSaZoeLm61n++mTuu8GIaL4cmcGJ9i2fWk/VJeURQcOU1TjkqG8zy/JHxXjrBAGIaOUGIcR7RuudSfRfzIkIjIUIiECXmH/xDmec6RpVwIyfR8vvxEx4ba/We0PzI260f5Z4dXtBS9jtM5hn0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a2f3ccc5325da5ffbfb7bc0706494928/8ac56/driver-kernel-debug-008.webp 240w,\n/static/a2f3ccc5325da5ffbfb7bc0706494928/d3be9/driver-kernel-debug-008.webp 480w,\n/static/a2f3ccc5325da5ffbfb7bc0706494928/e46b2/driver-kernel-debug-008.webp 960w,\n/static/a2f3ccc5325da5ffbfb7bc0706494928/32b94/driver-kernel-debug-008.webp 965w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a2f3ccc5325da5ffbfb7bc0706494928/8ff5a/driver-kernel-debug-008.png 240w,\n/static/a2f3ccc5325da5ffbfb7bc0706494928/e85cb/driver-kernel-debug-008.png 480w,\n/static/a2f3ccc5325da5ffbfb7bc0706494928/d9199/driver-kernel-debug-008.png 960w,\n/static/a2f3ccc5325da5ffbfb7bc0706494928/0fb99/driver-kernel-debug-008.png 965w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a2f3ccc5325da5ffbfb7bc0706494928/d9199/driver-kernel-debug-008.png\"\n            alt=\"ブレークポイント設定を利用した総当たり攻撃\"\n            title=\"ブレークポイント設定を利用した総当たり攻撃\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>上記のブレークポイントを設定した後に Python スクリプトなどで 13 文字のイメージファイル名を持つプロセスを総当たり実行することで、理論上はフラグを特定することが可能です。</p>\n<p>ただし、デバッガによるブレークポイントの評価はオーバーヘッドが大きく、特にデバッグ対象のシステムを中断することになるカーネルデバッグでは、上記のような繰り返しシステムの中断と再開を繰り返す操作には非常に長い時間を要します。</p>\n<p>そのため、今回のように、表示可能な ASCII 文字で 13 文字のイメージファイル名を総当たりするには必要な試行回数が膨大となるため、数十時間以上かけても正しいイメージファイル名を特定することはできません。</p>\n<p>そこで、checkImageFileName 関数の検証プロセスを動的解析することで、より効率的な Flag の特定方法を探っていくことにします。</p>\n<h2 id=\"checkimagefilename-関数の動的解析を行う\" style=\"position:relative;\"><a href=\"#checkimagefilename-%E9%96%A2%E6%95%B0%E3%81%AE%E5%8B%95%E7%9A%84%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86\" aria-label=\"checkimagefilename 関数の動的解析を行う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>checkImageFileName 関数の動的解析を行う</h2>\n<p>checkImageFileName 関数(アドレス 0x140001000 の関数)の動的解析を行うため、5 章の解析結果を振り返ります。</p>\n<p>5 章で確認した通り、checkImageFileName は引数として受け取ったイメージファイル名の文字列から 1 文字ずつ取り出し、何らかの複雑な演算を行った結果をハードコードされた整数値と比較していました。</p>\n<p>また、初期値が 0 のループカウンタが 13(0xd) 以上となった場合にループを抜けることから、正解となるイメージファイル名の長さは 13 文字であることもわかっています。</p>\n<p>そこで、まずは動的解析で上記の解析結果が正しいかどうかを確認します。</p>\n<p><code class=\"language-text\">bc *</code> で既存のブレークポイントをクリアした後、最初に <code class=\"language-text\">bp DoPDriver+0x1050</code> コマンドでブレークポイントを設定します。</p>\n<p>このアドレスでは、<code class=\"language-text\">movsx   eax,byte ptr [r11]</code> の処理が実行されます。</p>\n<p>5 章で確認した通り、checkImageFileName 関数が引数として受け取ったイメージファイル名は R11 レジスタの保持するポインタアドレスに格納されています。</p>\n<p>そして、<code class=\"language-text\">DoPDriver+0x1050</code> で実行されるコードは、ループ内でこれを 1 文字ずつ取り出す処理にあたります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 568px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5c738770c483f5a8b8ee5f39fc650d4f/10e91/driver-kernel-debug-009.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 104.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADOUlEQVQ4y31U23baSBDUtwQHJHS/oQuSJduY2AgkMJc42bNn9/9/orZ6Bmy8cfJQp0caTauqu3qM9XaDzX7AatNhtVopPK97dNs9ut0Rq+EF3csJ3bBD13XYDD3W/QbL5fJTGFldoLyrkBYzOI5L2IQDx9bRdR3Y0+kbppc196eX5/O3AqNo56i/tSqhZVoIwxBxHCOMI8yKDHESwXY9uEEIx/fhhRIDeJ6HIAjgE5LUsiwFo1o2aNcLzEqdME1TZFmGdDZDkmdI+JzXNfKmhhdF8JIEbhiphGEUIiAsawrTNBWMgnKrxS3iWaz+kGcx2ipDkSUocibLE30w8JU0n2x910VAliERkLWsIzIPqcKoHhs0z/dkk6qECQ9XRaoSzhnbpqT8WCV1ySqOYh6OkMQJZskMKWMUxnwmuGeUDzVun+5UwqkkTFKFKIlZw1xLohT52XWtLEtLNLk2L2uRnLclpI4xpY3HY0pO2BSyiSiH8WY0ws3NDUaC0VUk5L3sy7nJZKJgPO06rE8DFs8LFEWB23qObvWM/X6LDf3W9z02mx7bfo0dIXE7cE303B+2A5q2Za1zdd54GlboDj0WTwvU7GZZlti/bPHPv3/j9ecrfvz1A6fXVxwPL/h+2OHEKPh+3OFw2ON4OuJhscCc56qqYg3Z4WZ1rySbk0tddM0cz4XFupn2VEn9MnqXq9cjhfHXr++S82aubUO7iC00HFrCU6Z1aRHprm1Pr/Y/4jIxAkOm5I7Gzug9e/rxQ48M52WuJqeoSmXmS7c/BQ1OhiXmD7e0TfLxr2JisszSSDH1iD8mO1tKM9w8cpbTt6G/DLt8JCxlYlzPUQfMsyeVN01LwbzyqWbIGkZk8n/JF0gdo/g8v/SmMBaP+qrOPiKOrXsuh1EvP2d4XXBhe8dbSQzvMYlqlIq83qjAC9g0RyvgpOguK4ZXid4le5ilMdda2mTyPmYKfJ6MJ2qtJMvl0HYPtE3yQbJOyE6TTUK52jq2YugIwzM8SvY5psJYMSzvK9Sc5d/VUKwgyZtGJEfq1vHVxerrmvICjkjGDwN1uej78LH5RfIbU2kKE4ask8S3Lp9xkS7dFsn/Afn0nd3R4YcfAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/5c738770c483f5a8b8ee5f39fc650d4f/8ac56/driver-kernel-debug-009.webp 240w,\n/static/5c738770c483f5a8b8ee5f39fc650d4f/d3be9/driver-kernel-debug-009.webp 480w,\n/static/5c738770c483f5a8b8ee5f39fc650d4f/bebff/driver-kernel-debug-009.webp 568w\"\n              sizes=\"(max-width: 568px) 100vw, 568px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/5c738770c483f5a8b8ee5f39fc650d4f/8ff5a/driver-kernel-debug-009.png 240w,\n/static/5c738770c483f5a8b8ee5f39fc650d4f/e85cb/driver-kernel-debug-009.png 480w,\n/static/5c738770c483f5a8b8ee5f39fc650d4f/10e91/driver-kernel-debug-009.png 568w\"\n            sizes=\"(max-width: 568px) 100vw, 568px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/5c738770c483f5a8b8ee5f39fc650d4f/10e91/driver-kernel-debug-009.png\"\n            alt=\"イメージファイル名を 1 文字ずつ取り出すループ処理\"\n            title=\"イメージファイル名を 1 文字ずつ取り出すループ処理\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ブレークポイントを設定した後に g コマンドでシステムの実行を再開したら、仮想マシン内で任意のプログラムを実行します。</p>\n<p>本書では、以下のリポジトリからダウンロードできる HelloWorld.exe をテストとして実行しました。</p>\n<br>\n<p>HelloWorld.exe：</p>\n<p><a href=\"https://github.com/kash1064/ctf-and-windows-debug/blob/main/HelloWorld.exe\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/kash1064/ctf-and-windows-debug/</a></p>\n<br>\n<p>このプログラムを実行すると、<code class=\"language-text\">DoPDriver+0x1050</code> のブレークポイントにヒットして処理が一時停止します。</p>\n<p>ここで <code class=\"language-text\">da @R11</code> コマンドを実行すると、R11 レジスタが保持するポインタアドレスに <code class=\"language-text\">HelloWorld.exe</code> という文字列が保存されていることを確認できます。</p>\n<p>さらに、ステップ実行により <code class=\"language-text\">movsx   eax,byte ptr [r11]</code> の処理を行った後、EAX レジスタにイメージファイル名の先頭の文字である 0x48(H) が保存されたことを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 652px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/718ee5052e7cc5cb3fb1b7290e15faba/dba9a/driver-kernel-debug-010.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABS0lEQVQoz31Ri46CQAzc//8wgjExeshpRIwIIkrkJUjAx1xn4164O3ObTLrbdtvpVH26LsLdDvv9HpdLjfv9jr7v/8XtdtO26zoN4+dd+b6PIAiwWCxwOCRI0xTn81kHq6pEXhRomgZFkSPPc5RlhSzL0LYtuleh9nrVb96Vv9nAcRzMZjNMp1O48zkmkwlcYU72H6+YPRphLjHm2rYNy7LAv1EUYeWtQGKcUpHd2vOwkWCSJAjDELEEyJTMNAPpfhUWZkTzpjzP5/MbD4E6Ho+6EG0mo7IjOxUyalVVfzR69x5CcaTtNhD9DoikEBlSIzIgyJKo61pb+nhns3dQZVnKdi96ESxEZsZn/MbHpZxOqf5otv0bar32tOgUmHpyGY6Iv1wu9VLG4zE80TiOY81+KzmUyEjCRkMoI37X9eD5IfLjoe27M8wb4gsL1amkFWY9owAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/718ee5052e7cc5cb3fb1b7290e15faba/8ac56/driver-kernel-debug-010.webp 240w,\n/static/718ee5052e7cc5cb3fb1b7290e15faba/d3be9/driver-kernel-debug-010.webp 480w,\n/static/718ee5052e7cc5cb3fb1b7290e15faba/db2ac/driver-kernel-debug-010.webp 652w\"\n              sizes=\"(max-width: 652px) 100vw, 652px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/718ee5052e7cc5cb3fb1b7290e15faba/8ff5a/driver-kernel-debug-010.png 240w,\n/static/718ee5052e7cc5cb3fb1b7290e15faba/e85cb/driver-kernel-debug-010.png 480w,\n/static/718ee5052e7cc5cb3fb1b7290e15faba/dba9a/driver-kernel-debug-010.png 652w\"\n            sizes=\"(max-width: 652px) 100vw, 652px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/718ee5052e7cc5cb3fb1b7290e15faba/dba9a/driver-kernel-debug-010.png\"\n            alt=\"R11 レジスタから 1 文字を EAX レジスタに取り出す\"\n            title=\"R11 レジスタから 1 文字を EAX レジスタに取り出す\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">DoPDriver+0x1050</code> で取り出した文字に対して何らかの演算を行った結果をハードコードされた整数値と比較するコードは <code class=\"language-text\">DoPDriver+0x114a</code> でした。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 459px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7816dd122f2e719b452f962d3fcdb5f0/48711/driver-kernel-debug-011.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.916666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB10lEQVQ4y32SW2+bQBSE/WswLPfdZZer71JV3DgPiRKpiqqkb5XyB9IWO03zvydnMdBYwX0YGczyMWfmTL5+v8PN3S2ubq+xu7jAbrdrVW+3eLj/hufnA34f9mj2DZqmwZ/9T7wenvCyf6LrX3h5/Ysfj4/Y1nX73mRz+QnlZoZsliMIgkE+ScQxBBcQUpKOv1LEJA7OY3B6zjlHFEXwPQ++72My/7xCOs8hUgnG2AfZtg0uOYIwhExTxAQLZALbYbAsC1Oj6RSO47RqgdmyQJIpuARw6Uuu655IqgQJSWuNqsqgUw1JjsMobD/kkTMDMwYmi+0a6SInYPIBZGQOaa2gyJ0i0KxUqOYZRCIR0cghycTzD1ivkS0KqEKPAj1yLHgE1jlnrocgjuAwt43DMepg7ciL2oxcQpXjwF6mqLSgDAkWUSH+uzF72DCyASY5ZeiyUZhDBRjQks5pJcilccpOgL2Glo/AsZFdCFqVMPARUwnmvm/0vbMBeHRYjAL9NjdTikRBpZWUc+B7Z2FDKcWmgq7S49r0QIJ53SHLmtKu2cO+nYN1wBXyddWVwoZV4YlAZJY4DGg1wpOXzsFa4PLLBtmKgIU62b2CIqgpX5Mb6/77H6jXG2hqoJSvgUUKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7816dd122f2e719b452f962d3fcdb5f0/8ac56/driver-kernel-debug-011.webp 240w,\n/static/7816dd122f2e719b452f962d3fcdb5f0/25604/driver-kernel-debug-011.webp 459w\"\n              sizes=\"(max-width: 459px) 100vw, 459px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7816dd122f2e719b452f962d3fcdb5f0/8ff5a/driver-kernel-debug-011.png 240w,\n/static/7816dd122f2e719b452f962d3fcdb5f0/48711/driver-kernel-debug-011.png 459w\"\n            sizes=\"(max-width: 459px) 100vw, 459px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7816dd122f2e719b452f962d3fcdb5f0/48711/driver-kernel-debug-011.png\"\n            alt=\"取り出した文字に何らかの演算を行った結果を整数値と比較する\"\n            title=\"取り出した文字に何らかの演算を行った結果を整数値と比較する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>そのため、次はこのアドレスにブレークポイントを設定し、ゼロフラグを改ざんすることで上記の検証をバイパスできるか試します。</p>\n<p><code class=\"language-text\">bp DoPDriver+0x114a</code> コマンドでブレークポイントを設定した後、g コマンドで実行を再開します。</p>\n<p>整数値の検証を行った直後の状態で <code class=\"language-text\">r zf</code> コマンドを実行すると、ゼロフラグが 0 であることを確認できるため、文字 H は正しい Flag となるイメージファイル名の 1 文字目ではないことがわかります。</p>\n<p>このままプログラムの実行を再開すると、検証に失敗したことになりループ処理が終了してしまうため、実行を再開する前に <code class=\"language-text\">r zf=1</code> でゼロフラグを 1 に改ざんしておきます。</p>\n<p>ゼロフラグを改ざんした状態で g コマンドを入力してシステムの実行を再開すると、ループ処理が継続し、もう一度 <code class=\"language-text\">DoPDriver+0x1050</code> のブレークポイントにヒットします。</p>\n<p>この時、ループは 2 周目であり、R11 レジスタのポインタアドレスもイメージファイル名の 2 文字目を指すようにシフトされていることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 475px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/08a1cc12b9a7973f3395d5e9efd64b23/466da/driver-kernel-debug-012.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA+klEQVQoz51R22qEMBDN/3+YdB/qylq2FVbXKxh1jUlcLyCezggW6UNbOnCYa+ZyIqQs0fc9tNb4SdZ13fBbjUiSBOM4omkaWGMxzzOmafo3RBjekKYZ6rqGNmYL8oAde+HRP+a/Q5zPHi4XH3F8RxAE1DzF8zlsNOxUMAwNY5+1tfYrz/YR4vRyguu68DwPjuPglWxuGgQfiKIIj0cL3XUoyxJhGKKqKhRFQQvEuFOer8uyHEwdx8X+8M33cb2+o20VlFKQUqIiGoZh2E7h6RxnmzdTqkVHg/bNtdGwpEWaJsjzgrrnpPOtybIsqOj3eSv+LEm6Jxr+Ip/JtBVlVbDnXQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/08a1cc12b9a7973f3395d5e9efd64b23/8ac56/driver-kernel-debug-012.webp 240w,\n/static/08a1cc12b9a7973f3395d5e9efd64b23/4287c/driver-kernel-debug-012.webp 475w\"\n              sizes=\"(max-width: 475px) 100vw, 475px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/08a1cc12b9a7973f3395d5e9efd64b23/8ff5a/driver-kernel-debug-012.png 240w,\n/static/08a1cc12b9a7973f3395d5e9efd64b23/466da/driver-kernel-debug-012.png 475w\"\n            sizes=\"(max-width: 475px) 100vw, 475px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/08a1cc12b9a7973f3395d5e9efd64b23/466da/driver-kernel-debug-012.png\"\n            alt=\"R11 レジスタのポインタがイメージファイル名の 2 文字目を指している\"\n            title=\"R11 レジスタのポインタがイメージファイル名の 2 文字目を指している\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これで、checkImageFileName 関数がイメージファイル名を 1 文字ずつ検証していること、そしてアドレス <code class=\"language-text\">DoPDriver+0x114a</code> でゼロフラグを改ざんすることで検証結果をバイパスできることを確認できました。</p>\n<p>つまり、DoPClient と同じく、1 回の試行につきイメージファイル名のすべての文字を同時に検証することができ、0x20 から 0x7E までの最大 95 回の総当たりで正しいイメージファイル名を特定できることがわかります。</p>\n<h2 id=\"javascript-ベースのデバッガスクリプトでイメージファイル名を特定する\" style=\"position:relative;\"><a href=\"#javascript-%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%AC%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%A7%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%90%8D%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"javascript ベースのデバッガスクリプトでイメージファイル名を特定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JavaScript ベースのデバッガスクリプトでイメージファイル名を特定する</h2>\n<p>4 章では、正しい Flag を特定するために cdb.exe とデバッガコマンドスクリプトを利用しました。</p>\n<p>今回は DoPClient のように総当たりを試行するたびにロードしたデバッガスクリプトが初期化されることはないため、JavaScript ベースの強力なデバッガスクリプトで総当たり攻撃を行うことができます。</p>\n<p>正しいイメージファイル名を特定するため、以下カーネルデバッガにロードする JavaScript ファイルと、仮想マシンで実行し、イメージファイル名の総当たりを行う Python スクリプトファイルを使用します。</p>\n<p>カーネルデバッガにロードする JavaScript は以下の通りです。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// .scriptrun C:\\CTF\\Autorun2.js</span>\n<span class=\"token string\">\"use strict\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> word <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> correctImageFileName <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span><span class=\"token number\">13</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"*\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">RunCommands</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cmd</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">let</span> ctl <span class=\"token operator\">=</span> host<span class=\"token punctuation\">.</span>namespace<span class=\"token punctuation\">.</span>Debugger<span class=\"token punctuation\">.</span>Utility<span class=\"token punctuation\">.</span>Control<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">let</span> output <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">ExecuteCommand</span><span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> line <span class=\"token keyword\">of</span> output<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\thost<span class=\"token punctuation\">.</span>diagnostics<span class=\"token punctuation\">.</span><span class=\"token function\">debugLog</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"  \"</span><span class=\"token punctuation\">,</span> line<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">return</span> output<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">SetBreakPoints</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">let</span> ctl <span class=\"token operator\">=</span> host<span class=\"token punctuation\">.</span>namespace<span class=\"token punctuation\">.</span>Debugger<span class=\"token punctuation\">.</span>Utility<span class=\"token punctuation\">.</span>Control<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">let</span> breakpoint<span class=\"token punctuation\">;</span>\n\n\tbreakpoint <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">SetBreakpointAtOffset</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DoPDriver\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1054</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tbreakpoint<span class=\"token punctuation\">.</span>Command <span class=\"token operator\">=</span> <span class=\"token string\">\"dx -r1 @$autoRun2.CheckPoint1() ; g\"</span><span class=\"token punctuation\">;</span>\n\n\tbreakpoint <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">SetBreakpointAtOffset</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DoPDriver\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x114a</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tbreakpoint<span class=\"token punctuation\">.</span>Command <span class=\"token operator\">=</span> <span class=\"token string\">\"dx -r1 @$autoRun2.CheckPoint2() ; r zf = 1 ; g\"</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Result</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\thost<span class=\"token punctuation\">.</span>diagnostics<span class=\"token punctuation\">.</span><span class=\"token function\">debugLog</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"correctImageFileName is: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> w <span class=\"token keyword\">of</span> correctImageFileName <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\thost<span class=\"token punctuation\">.</span>diagnostics<span class=\"token punctuation\">.</span><span class=\"token function\">debugLog</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\thost<span class=\"token punctuation\">.</span>diagnostics<span class=\"token punctuation\">.</span><span class=\"token function\">debugLog</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">CheckPoint1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// EAX レジスタからイメージファイル名に含まれる 1 文字を取得</span>\n\t<span class=\"token keyword\">let</span> context <span class=\"token operator\">=</span> host<span class=\"token punctuation\">.</span>namespace<span class=\"token punctuation\">.</span>Debugger<span class=\"token punctuation\">.</span>State<span class=\"token punctuation\">.</span>DebuggerVariables<span class=\"token punctuation\">.</span>curthread<span class=\"token punctuation\">.</span>Registers<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">let</span> eaxValue <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>eax<span class=\"token punctuation\">;</span>\n\tword <span class=\"token operator\">=</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCodePoint</span><span class=\"token punctuation\">(</span>eaxValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">CheckPoint2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">let</span> context <span class=\"token operator\">=</span> host<span class=\"token punctuation\">.</span>namespace<span class=\"token punctuation\">.</span>Debugger<span class=\"token punctuation\">.</span>State<span class=\"token punctuation\">.</span>DebuggerVariables<span class=\"token punctuation\">.</span>curthread<span class=\"token punctuation\">.</span>Registers<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">let</span> r9Value <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>r9d<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">let</span> r11Value <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>r11<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">let</span> zeroFlagValue <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>zf<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token comment\">// ゼロフラグの値から検証に成功したかどうかを判断</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>zeroFlagValue <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tcorrectImageFileName<span class=\"token punctuation\">[</span><span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>r9Value<span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> word<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">initializeScript</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n\t\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">host<span class=\"token punctuation\">.</span>apiVersionSupport</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">invokeScript</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">RunCommands</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dx @$autoRun2 = Debugger.State.Scripts.Autorun2.Contents\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">RunCommands</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dx @$autoRun2.SetBreakPoints()\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">RunCommands</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"g\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>また、仮想マシン側で実行する Python スクリプトは以下の通りです。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">import</span> subprocess\n\nexe_path <span class=\"token operator\">=</span> <span class=\"token string\">\"C:\\\\CTF\\\\HelloWorld.exe\"</span>\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x7F</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"\\\\\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"?\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"&lt;\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\">\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\":\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"*\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"|\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\\\"\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n\t\t<span class=\"token keyword\">continue</span>\n\n\tnew_exe_path <span class=\"token operator\">=</span> <span class=\"token string\">\"C:\\\\CTF\\\\{}.exe\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span>\n\tos<span class=\"token punctuation\">.</span>rename<span class=\"token punctuation\">(</span>exe_path<span class=\"token punctuation\">,</span>new_exe_path<span class=\"token punctuation\">)</span>\n\texe_path <span class=\"token operator\">=</span> new_exe_path\n\tproc <span class=\"token operator\">=</span> subprocess<span class=\"token punctuation\">.</span>Popen<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>exe_path<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\tproc<span class=\"token punctuation\">.</span>kill<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>このスクリプトは以下のリポジトリから、それぞれ Autorun2.js および Stage2_Solver.py としてダウンロードできます。</p>\n<br>\n<p>Autorun2.js と <code class=\"language-text\">Stage2_Solver.py</code>：</p>\n<p><a href=\"https://github.com/kash1064/ctf-and-windows-debug/blob/main/Autorun2.js\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/kash1064/ctf-and-windows-debug/</a></p>\n<br>\n<p>カーネルデバッガにロードする JavaScript の構成は 4 章で使用した Autorun.js とほとんど同じです。</p>\n<p>このスクリプトでは、R11 レジスタの保持するアドレスからイメージファイル名を 1 文字取り出した直後のアドレスである <code class=\"language-text\">DoPDriver+0x1054</code> にブレークポイントを設定し、CheckPoint1 関数を使用して評価対象となる文字を変数 word に確保します。</p>\n<p>続けて、評価結果を確認できる <code class=\"language-text\">DoPDriver+0x114a</code> に設定したブレークポイントで CheckPoint2 関数を実行することで、ゼロフラグの値から word に保存した文字が正しいイメージファイル名のものと一致するかを確認しています。</p>\n<p>このスクリプトにより、<code class=\"language-text\">AAAAAAAAA.exe</code> や <code class=\"language-text\">ZZZZZZZZZ.exe</code> などのプロセスを実行することで正しいイメージファイル名の各文字を総当たりすることができます。</p>\n<p>そして、ファイル名の総当たりを行うためのスクリプトは Stage2_Solver.py です。</p>\n<p>このスクリプトでは、文字列 <code class=\"language-text\">Hello World</code> を出力するだけのプログラムである <code class=\"language-text\">C:\\CTF\\HelloWorld.exe</code> をリネームして実行することで、イメージファイル名の総当たりを行っています。</p>\n<p>この 2 つのスクリプトを使用することで、0x20 から 0x7E までの 95 回の試行で正しいイメージファイル名を特定することができます。</p>\n<p>なお、ここで使用するプログラムは任意の EXE ファイルで代用が可能ですが、文字列 “Hello World” をコンソールに出力するだけのプログラムである HelloWorld.exe を以下のリポジトリからダウンロードしてリネームすることで使用することもできます。</p>\n<p>ダウンロードした HelloWorld.exe は、仮想マシンの <code class=\"language-text\">C:\\CTF</code> フォルダ直下に配置しておきます。</p>\n<br>\n<p>HelloWorld.exe：</p>\n<p><a href=\"https://github.com/kash1064/ctf-and-windows-debug/blob/main/HelloWorld.exe\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/kash1064/ctf-and-windows-debug/blob/main/HelloWorld.exe</a></p>\n<br>\n<p>すべての準備が完了したら、総当たりを行うためにカーネルデバッガで以下のコマンドを順に実行します。</p>\n<p>これで、既存のブレークポイントをフラッシュした上で Autorun2.js のスクリプトをロードできます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">bc *\n.scriptrun &lt;Autorun2.js のフルパス></code></pre></div>\n<p>Autorun2.js をデバッガにロードしたら、仮想マシン側で <code class=\"language-text\">Stage2_Solver.py</code> を実行します。</p>\n<p>試行回数はたったの 95 回ですが、カーネルデバッガでブレークポイントにヒットした場合、システムそのものの動作が一時停止することもあり、すべての処理が終了するまで 10 分以上の時間がかかる場合があります。</p>\n<p><code class=\"language-text\">Stage2_Solver.py</code> の実行が完了したら、Autorun2.js の correctImageFileName 配列に正しいイメージファイル名が記録されているはずですので、デバッガで <code class=\"language-text\">dx -r1 @$autoRun2.Result()</code> コマンドを実行します。</p>\n<p>これで、正しいイメージファイル名が <code class=\"language-text\">topsecret.exe</code> であることを特定できました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 746px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/13e31db4212685fef69e731191a254df/62de4/driver-kernel-debug-013.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB60lEQVQ4y51TDXOqMBDM//9zr+PYKkJBgYDy4SeogLrv9mw6tuObzmtmzpwh2ezuXczb6yt8P0CaJJjPI8nfEScxhn4Ax+12w/8MM51OEYYRrLVYxAu8S54IeN/3vwScTAQkRJqmiAWQ4GT4a0AnOVHJcwQBJX9l+K94dqEZjUag7MWC7ELJZwp8uVx+ZPPskk/AKAox82fwvBn8wMfhcMAwDDgeW+x2WzRNg/P5rNG2rX57KrkoVijLElVVoSgK1HWN1Wql+Waz0Zx25HmOUvZw33K5lH1rvXS/32P/MfNS03WdsDgKi51uIMh2u9X/PLz7yPltvV7rN+4h00fZHFwznfz0Qt+miciei5extpDNLGLxld5GUYQsyzCRjuDctkdcr9cvXnKQnDKkJ7yZ8iiHFlAy1/I8U6adVN356MC+V5ydYVx7PI62bfSw8+XQ3P9Tuovv1f4ErOsKmc1UipVIRW4cxyiFIdlam94tkPB9X/fxEeT5UgvFgtHbsqzQSi0Mq+qCZruKUz5nHqJntMVFIwU6nU5aTDJnCznrjGsDMiLYHbBUWTzwCOTicd2BMpibRN7tm1SPr2OiDR4pOxaEBWC7cCYDMuELcvOzMGwLz/O0Jcbyrv+8vMh7DnRtPB7rBZRNO+jVT/EXcQjHW09fFCsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/13e31db4212685fef69e731191a254df/8ac56/driver-kernel-debug-013.webp 240w,\n/static/13e31db4212685fef69e731191a254df/d3be9/driver-kernel-debug-013.webp 480w,\n/static/13e31db4212685fef69e731191a254df/f7ebd/driver-kernel-debug-013.webp 746w\"\n              sizes=\"(max-width: 746px) 100vw, 746px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/13e31db4212685fef69e731191a254df/8ff5a/driver-kernel-debug-013.png 240w,\n/static/13e31db4212685fef69e731191a254df/e85cb/driver-kernel-debug-013.png 480w,\n/static/13e31db4212685fef69e731191a254df/62de4/driver-kernel-debug-013.png 746w\"\n            sizes=\"(max-width: 746px) 100vw, 746px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/13e31db4212685fef69e731191a254df/62de4/driver-kernel-debug-013.png\"\n            alt=\"イメージファイル名を総当たりで特定する\"\n            title=\"イメージファイル名を総当たりで特定する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"ページプールの情報を確認する\" style=\"position:relative;\"><a href=\"#%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%97%E3%83%BC%E3%83%AB%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\" aria-label=\"ページプールの情報を確認する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ページプールの情報を確認する</h2>\n<p>正しいイメージファイル名が topsecret.exe であることを総当たり攻撃で特定できたので、ExAllocatePoolWithTag で確保された領域に本当に Flag が格納されるかを確認してみましょう。</p>\n<p>確認を行う前に、既存のページプールをクリアするために一度仮想マシンを再起動しておきます。</p>\n<p>仮想マシンを再起動したら、DoPClient を起動する前にカーネルデバッガをアタッチし、!poolused コマンド <sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup> を実行します。</p>\n<p>この拡張コマンドをオプション無しで実行すると、ページプールおよび非ページプールのプールタグとメモリ使用量を一覧として出力できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/145896ed7fb8933da771ee64977df6d9/6acbf/driver-kernel-debug-014.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACJklEQVQ4y42U6Y6jQAyEef9XizSZEG4CgVyEI9cTeP05Y4RWu9H8sLrpbleXq0wHeZ5LURTCeDqd5Hg8StM00g+D3O93mabJ4na72ffj8fgYQV3XUpaFVDpWVSV1XUmaJDqvpW1bOZ/Pcr1edbzIoJeQBPD/IjgcDtIeWmM3KYuh740xTAHc7/fS69rz+ZzBPjJcr9ey2WxkE4ay3W4lTVMJdV6UpWRZJrvdzspdgn0CNYZvDTOJ41i+FTyKIpujKzK0TWs6/oohCYlqViqjg5bJiK5ccrlc5PV6zYb8JoJ+6KXrOhP+eu3sFvQixnG08G/X0WO57nsBLEjCFBzFCExgzkXscxkO+0iQ0/eDmch59qgkoDT0oS24BWNI4NA03exQd+mkUD2jKDajCKQhl2DeKBEDxNVRAWgPgDEEMBjDgvZB0zDcyGq10o74NsNi1Z1uiKKt9SzAwzBKADpiUhoaYBKAgPkfwh4JmAeB8qelnKlrbaZwgAl6UTJt1P/oMo6TaQl7kmFPJMow0Txy+U3Rb24bem0JyI0uPAyRw9oJhgoEiLMjkGPZVgGLLKAVgF4ygKxzO39Lbqa8GQJK+Q446sVz2zhDQGhiHPX2cF3QMNdkTHAgBzXApYZZBuBjNoWD/wLE2a+v9QyUZqmxpjJ0ZkSiuWQammT60EteAlI2DwlghLuO5uTOJbvLJLFI4t+Ane7xZkbxu7GTJJ4fZboCdv5o/AHmvynWoGUwNwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/145896ed7fb8933da771ee64977df6d9/8ac56/driver-kernel-debug-014.webp 240w,\n/static/145896ed7fb8933da771ee64977df6d9/d3be9/driver-kernel-debug-014.webp 480w,\n/static/145896ed7fb8933da771ee64977df6d9/e46b2/driver-kernel-debug-014.webp 960w,\n/static/145896ed7fb8933da771ee64977df6d9/4ad2e/driver-kernel-debug-014.webp 1001w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/145896ed7fb8933da771ee64977df6d9/8ff5a/driver-kernel-debug-014.png 240w,\n/static/145896ed7fb8933da771ee64977df6d9/e85cb/driver-kernel-debug-014.png 480w,\n/static/145896ed7fb8933da771ee64977df6d9/d9199/driver-kernel-debug-014.png 960w,\n/static/145896ed7fb8933da771ee64977df6d9/6acbf/driver-kernel-debug-014.png 1001w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/145896ed7fb8933da771ee64977df6d9/d9199/driver-kernel-debug-014.png\"\n            alt=\"カーネルデバッガでページプールの情報を参照する\"\n            title=\"カーネルデバッガでページプールの情報を参照する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>DoPDriver が作成するページプールのプールタグは flag でしたので、オプション引数にタグ名を使用し、<code class=\"language-text\">!poolused 0 flag</code> コマンドを実行します。</p>\n<p>しかし、DoPDriver を使用していないこの時点ではまだ flag というタグを持つページプールは存在していないため、何の情報も表示されません。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 621px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/410c18f4b92732e21fa9ad80024e4a46/3075e/driver-kernel-debug-015.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA70lEQVQoz6VRa2/DIAzM//+FqxSp05YsqaKkEF55cuW8UtHPtWSB7fP5DFXf/eHnt0HTNLhcvnC9fqNtW9R1jXEcoZSCtRbzPGNZFnjnoLWWnHMW1hg47yWOMaLiRSkNkwp0lxrYuG0bQghCxDxJhND/ExpjERIR8e55CmFIoCkpme53mUZFn1h1HAeO85SAqnyadrv16PteJjPHyVS377us1nUd1nUVZ630KgQvK8V4YhgGWYWN9LwqbZomuVMAa8sSJEcSWj4rKtgSINv5VFvGZdNbvYhfhFqrlwom+RElyKc4g7kiBWTjM1BxSfgAPy0iJf/FIqoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/410c18f4b92732e21fa9ad80024e4a46/8ac56/driver-kernel-debug-015.webp 240w,\n/static/410c18f4b92732e21fa9ad80024e4a46/d3be9/driver-kernel-debug-015.webp 480w,\n/static/410c18f4b92732e21fa9ad80024e4a46/b2315/driver-kernel-debug-015.webp 621w\"\n              sizes=\"(max-width: 621px) 100vw, 621px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/410c18f4b92732e21fa9ad80024e4a46/8ff5a/driver-kernel-debug-015.png 240w,\n/static/410c18f4b92732e21fa9ad80024e4a46/e85cb/driver-kernel-debug-015.png 480w,\n/static/410c18f4b92732e21fa9ad80024e4a46/3075e/driver-kernel-debug-015.png 621w\"\n            sizes=\"(max-width: 621px) 100vw, 621px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/410c18f4b92732e21fa9ad80024e4a46/3075e/driver-kernel-debug-015.png\"\n            alt=\"タグが flag のページプールの情報を参照する\"\n            title=\"タグが flag のページプールの情報を参照する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>現在のところシステムに flag というタグを持つページプールは存在していないことを確認できたので、次は DoPClient を起動し、パスワード <code class=\"language-text\">FLAG{You_can_use_debug_script_in_WinDbg_Next}</code> を入力して再び DoPDriver をシステムにロードします。</p>\n<p>そして、WinDbg で <code class=\"language-text\">bp DoPDriver+0x135e</code> コマンドを実行し、<code class=\"language-text\">DoPDriver+0x135e</code> にブレークポイントを設定します。</p>\n<p>このアドレスは、<code class=\"language-text\">call  qword [rel ExAllocatePoolWithTag]</code> にて ExAllocatePoolWithTag 関数が呼び出されるアドレスです。</p>\n<p>先ほど特定した topsecret.exe が正しいイメージファイル名に間違いない場合、checkImageFileName 関数の検証をパスしてこのコードが実行されるはずです。</p>\n<p>仮想マシンで topsecret.exe にリネームした任意の実行ファイルを起動すると、<code class=\"language-text\">DoPDriver+0x135e</code> のアドレスで処理が一時停止します。</p>\n<p>ここで、<code class=\"language-text\">r ECX,EDX,R8d</code> コマンドにより ExAllocatePoolWithTag 関数の引数を参照します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 553px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/545d2bfa1278e4bc45443315fc0d8bc5/74cfa/driver-kernel-debug-016.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACp0lEQVQ4y4VV2XLaQBDU/39SKpWDxIAkdIMkDgEWIO6zeHPBpHtANrExftjSqthtdU/3DEaSJNJsNqXT6Yjv+5LEsTSjSPemaUq1WhXbtuV3pSKu60q73ZYwDCVNU9yLJElSybJMlsulbDYbMcbjsQwGAxmPR9LtdvUgF/c8sMLB/X4vq9VKn6fTSc7n8+vzfD7p/uXlRZcxGo1kMpkIgfv9vn4tTdvS6/X0fbvdXS+e/7v42VLAAPKiKJQwCFR+BjDP8yXHb8oS7NbrtS6+P1rGfD6XWs2UP09P8hdPx/MkaqGOzZYsFgtlXBRTORwOemG73T5cxhyXvv+syLcfv6RSs8RyPalU6/L8nANooiwLlIRl2e12X4IaCzCkZMoNritutaQL17kfA2g2m0mej/RCCVhK/AgIho1GQ6PhIBY+JDMWjI3ve9IG8HA4VINWqCGdfsRSAS0LUk3rDRAGMYMEjcJIP0bzmASCl9LvMqQpDhh6AKOzzGAHGezC6aIotHb8KINLtyn/VvJ7UAVs2BfJFmUDXDsCWWTHdHuZgvAcGfISGd7W8y5DyzIBCDDnAshFyeWewDRpBNAyj/dAFdB1XLC0xb5KvxiCvk4TgDkwzdbAs48ZoRRPgt4FZH0ot16vS8Nxri5H6m6W9SSOE5V8PB7V4S8lE5CSHYB5YEVZBIwxdZIEHYNMkhmNmk6n2uMFnrchvwVWyR5Ykdkb4CWH3HOshWEA+ak6zfiwjp+xvEhGDpm7xjWHfuBfgg7WJn7zPFcnUAtsyZxRKgfGB4baKbjMbmGwaQqHbulwfJWcZX10S6bDgv3PMxPk9H1/Gyw4c2jCFLIh2wj5S2AGWca4mOe5sqJ8nn84vkg70ppRagBZTSn/FiiPzDg4eln2CsZRRsfvrX86XK17Nt2GGAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/545d2bfa1278e4bc45443315fc0d8bc5/8ac56/driver-kernel-debug-016.webp 240w,\n/static/545d2bfa1278e4bc45443315fc0d8bc5/d3be9/driver-kernel-debug-016.webp 480w,\n/static/545d2bfa1278e4bc45443315fc0d8bc5/e58ce/driver-kernel-debug-016.webp 553w\"\n              sizes=\"(max-width: 553px) 100vw, 553px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/545d2bfa1278e4bc45443315fc0d8bc5/8ff5a/driver-kernel-debug-016.png 240w,\n/static/545d2bfa1278e4bc45443315fc0d8bc5/e85cb/driver-kernel-debug-016.png 480w,\n/static/545d2bfa1278e4bc45443315fc0d8bc5/74cfa/driver-kernel-debug-016.png 553w\"\n            sizes=\"(max-width: 553px) 100vw, 553px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/545d2bfa1278e4bc45443315fc0d8bc5/74cfa/driver-kernel-debug-016.png\"\n            alt=\"ExAllocatePoolWithTag 関数の引数を参照する\"\n            title=\"ExAllocatePoolWithTag 関数の引数を参照する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>5 章で確認した通り、ExAllocatePoolWithTag 関数は以下の 3 つの引数を取り、割り当てられたメモリへのポインタを戻り値として返します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">PVOID <span class=\"token function\">ExAllocatePoolWithTag</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span> <span class=\"token function\">__drv_strictTypeMatch</span><span class=\"token punctuation\">(</span>__drv_typeExpr<span class=\"token punctuation\">)</span>POOL_TYPE PoolType<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span> SIZE_T                                         NumberOfBytes<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>in<span class=\"token punctuation\">]</span> ULONG                                          Tag\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ECX に保存されている値は 1 でしたが、これは PoolType を PagedPool に指定しています。</p>\n<p>また、R8d に保存されている 0x67616c66 は、プールタグ flag を逆順に並べた文字列 galf を 16 進数変換したものです。(ExAllocatePoolWithTag 関数でプールタグを指定する場合、最大 4 文字のタグ名を逆順に並び替えた値を使用します)</p>\n<p>次に、p コマンドでステップ実行を行い、ExAllocatePoolWithTag 関数によるページプールの割り当てを完了させます。</p>\n<p>ExAllocatePoolWithTag 関数によるページプールの割り当てに成功した場合、戻り値が格納される RAX レジスタには割り当てたメモリ領域のポインタアドレスが保存されます。</p>\n<p>また、再度 <code class=\"language-text\">!poolused 0 flag</code> コマンドを実行してみると、先ほどは存在しなかった flag というタグのページプールが 1 つ割り当てられていることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/46d24c84683c6ca44fb6f619c55b7b91/e4900/driver-kernel-debug-017.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABWklEQVQoz4WT2ZKCMBRE8/9fJwojIqJssi8qWPDUk74aS6Zq9KErubfISacTlOM4CMMQcZygrmtRVVXo+x632w1d26JpGnTdY2x1bb7jfBzHhZS/32O73eJwOGhojOv1KqD7/Y5pmjAMg9TvulwuIs7neV5IEeZ5HlzXlfF0OsH3fYHTaVmWMlJN075gRl3XLaSiKMTxeHweO0YURQJkj/AkSVAUOfI8FzgX8aj/SQVBIIsJKopCcvJ2O7DPHqNI01RAff+A/XW1cGitVlivN1prrPTccX7Ai6JL9wk2F2Bgn6Aq1Ucy+TFPy7Jg2zbszUbXrjhkHIR+gwmQDgg0R2NuBDAG5idP50tuiwyZGwOnCKiqWt4gRVfn8/nlir1P7sQhF/D2CCOULrkJ+1mWy5y9sqyQZ5l8+/6UTG16ikejAxbmaJy3zz+ErggnmJs+Nsr05pmMUmsZI7+3vTO8112gTAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/46d24c84683c6ca44fb6f619c55b7b91/8ac56/driver-kernel-debug-017.webp 240w,\n/static/46d24c84683c6ca44fb6f619c55b7b91/d3be9/driver-kernel-debug-017.webp 480w,\n/static/46d24c84683c6ca44fb6f619c55b7b91/e46b2/driver-kernel-debug-017.webp 960w,\n/static/46d24c84683c6ca44fb6f619c55b7b91/6257a/driver-kernel-debug-017.webp 988w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/46d24c84683c6ca44fb6f619c55b7b91/8ff5a/driver-kernel-debug-017.png 240w,\n/static/46d24c84683c6ca44fb6f619c55b7b91/e85cb/driver-kernel-debug-017.png 480w,\n/static/46d24c84683c6ca44fb6f619c55b7b91/d9199/driver-kernel-debug-017.png 960w,\n/static/46d24c84683c6ca44fb6f619c55b7b91/e4900/driver-kernel-debug-017.png 988w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/46d24c84683c6ca44fb6f619c55b7b91/d9199/driver-kernel-debug-017.png\"\n            alt=\"ExAllocatePoolWithTag 関数で割り当てたページプールのアドレスを参照する\"\n            title=\"ExAllocatePoolWithTag 関数で割り当てたページプールのアドレスを参照する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ExAllocatePoolWithTag 関数は、プールメモリを割り当て、割り当てられたブロックへのポインタを返します。</p>\n<p>この時割り当てられたブロックには、64 bit OS の場合 16 バイトの <code class=\"language-text\">POOL_HEADER</code> 構造体が付与されています。</p>\n<p>そのため、<code class=\"language-text\">dt nt!_POOL_HEADER @RAX-0x10</code> コマンドで、ExAllocatePoolWithTag 関数が割り当てたブロックのアドレスより 16 バイト手前のアドレスにアクセスすると、プールタグ flag を含むヘッダ情報が存在していることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 780px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dfe37b0c42ec88f28874d0fa4a36a95e/a1792/driver-kernel-debug-018.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB3UlEQVQoz5VTXY+TQBTl3/offPcHGOOjxgdjNvHJTdQXHzZ1k9K10gItS7ulUBgYZIBCTdYWbI93xnbjJqjZm5xcLsyce+4HGmMMy+USCecQQqAoCjRNg91uh/1+j5MdDgcV/w+aJJtMJr9h2xiPxyqB7wdwHIe8D5m0LEtsNhvUdf1PaCyKMBjomE4dReZ5nvqQkmJdH6DXu4RhjGBZNvI8V8RFUSrfBUU4HA6JcALbNpFlnJTUSJIYI0OnZD14yxusViGqqrrDer3uhMZYhKurAUzzhhR6dLEk0u9IUw+29ZTUPaGy+4giTu+4Kj+OY6Wmm1Ap/ALT8kiNi37fgesG1EePVJtYLFzyNoIgIMJUkSVJoobXWTLnCV3ySMWCSN7Q8zMq2cTtbUP4gbb9SRNvyLf3IDehC1oYrZDlNVj8EdPrRwjDx5TpNbZb47gv+7u1+dP/zTTBM6SrHLVwEMxeIvTPUa4/gfPnNNX3kgIPMW0cjXDJP0MXX/HW+AD92sJ85mI2H2E+N9WqyIXPsuy4MoXaRxnLaecUy2HIczLWLpILnBVnON++w6vwBQwxRFXURFKSym9qJ09/zqlPsocyvtfLY6wJRpniGm3VQgQZmB9RP9lRTa4OPcR+AenpgLoDt0zOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/dfe37b0c42ec88f28874d0fa4a36a95e/8ac56/driver-kernel-debug-018.webp 240w,\n/static/dfe37b0c42ec88f28874d0fa4a36a95e/d3be9/driver-kernel-debug-018.webp 480w,\n/static/dfe37b0c42ec88f28874d0fa4a36a95e/8369b/driver-kernel-debug-018.webp 780w\"\n              sizes=\"(max-width: 780px) 100vw, 780px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/dfe37b0c42ec88f28874d0fa4a36a95e/8ff5a/driver-kernel-debug-018.png 240w,\n/static/dfe37b0c42ec88f28874d0fa4a36a95e/e85cb/driver-kernel-debug-018.png 480w,\n/static/dfe37b0c42ec88f28874d0fa4a36a95e/a1792/driver-kernel-debug-018.png 780w\"\n            sizes=\"(max-width: 780px) 100vw, 780px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/dfe37b0c42ec88f28874d0fa4a36a95e/a1792/driver-kernel-debug-018.png\"\n            alt=\"プールヘッダの情報を参照する\"\n            title=\"プールヘッダの情報を参照する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>また、特定のプールの割り当てに関する情報を参照できる !pool コマンド <sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup> でこのメモリブロックの情報を参照することでも、プールヘッダのアドレスやプールタグを確認することができます。</p>\n<p>このコマンドを実行すると、引数として受け取ったアドレスがプールのブロック内に存在するかを確認し、存在する場合はプールヘッダのアドレスやプールタグ、またはそのプールに保存されているコンテンツなどを表示できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 647px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b8465ac9e0779d8b586bb0f33d2b1ba5/ca12d/driver-kernel-debug-019.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACL0lEQVQoz01STW+bQBTk/7dSWlVKD+mh6qVSGyVKTpXSi/NRwNjmy3ztB8uCjcE2bkguvU3f0ksPI+C9tzOz87B4wVGKEoIJrBYrVKVG13Zomxb9bo99t8dwGDDsj9O3waE7YPw94nV8xQs9x9OIl+cXjM8jLNlKeIkHN3YRsGB6hiJEohOIHcciWyIuI+RNNtVZy6CPFTbPG+oLtGOL4c8APWj0px5W9VXBezuHS3DeOFidLcE+cjSfGkKN4F2E5EOM4pyBnXN0nzscvxygLzSCswAx9cSFRPG+gJpVsE5PJ+zveogbgfR7BnkjkX/Loa4Vuh8diksGcS1Q3VZg9F7f1lCXCuqqBL/i6H/2BIrlbsAhO8JSOwXb/4XHxSMevAc4gY2Q0dUahrIVmEceFhSJqRmoTmF72oBvOJbJEmuZQO9rrAXFIgoiLBVc24Fju5i7cyy9BYqccqo0lCwRhTHSJAFnHIzqm2ZDS9vR8iqEQTQt1CyxyHIwWqy13W7pUAg/COD7PuI4BuMcWmvUtcaayLIso2HKkEjNfN/3Uz9NU3CabZoGUgooMmFJIXF/f4/ZzGCGp6dHRERqBqUQcI3rhUe1CGEUoaoq7Np26s+9OWzbnupZlqJUCpZhDwKfEExYr9cQUk6qxmE2XYXyLOlfJfGWyP53mOc5uZNQqvznsNY1PFIyThzHoRxdpHRFSQQVKa78ACFFYg6naUYiNbqumwSMgdXKn0RNX6kKfwHvQ793cEUAYgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b8465ac9e0779d8b586bb0f33d2b1ba5/8ac56/driver-kernel-debug-019.webp 240w,\n/static/b8465ac9e0779d8b586bb0f33d2b1ba5/d3be9/driver-kernel-debug-019.webp 480w,\n/static/b8465ac9e0779d8b586bb0f33d2b1ba5/8f3a3/driver-kernel-debug-019.webp 647w\"\n              sizes=\"(max-width: 647px) 100vw, 647px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b8465ac9e0779d8b586bb0f33d2b1ba5/8ff5a/driver-kernel-debug-019.png 240w,\n/static/b8465ac9e0779d8b586bb0f33d2b1ba5/e85cb/driver-kernel-debug-019.png 480w,\n/static/b8465ac9e0779d8b586bb0f33d2b1ba5/ca12d/driver-kernel-debug-019.png 647w\"\n            sizes=\"(max-width: 647px) 100vw, 647px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b8465ac9e0779d8b586bb0f33d2b1ba5/ca12d/driver-kernel-debug-019.png\"\n            alt=\"!pool コマンドで割り当てたブロックの情報を参照する\"\n            title=\"!pool コマンドで割り当てたブロックの情報を参照する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ExAllocatePoolWithTag 関数によるページプールの作成を確認できたので、念のため RAX レジスタに保持されていたメモリブロックのポインタアドレス(今回は 0xffff828292b6b270)を記録した後、g コマンドでシステムの処理を再開します。</p>\n<p>システムの処理が再開されると、DoPDriver は自身が作成したページプールの領域に 2 つめの Flag 文字列を保存するはずです。</p>\n<p>実際に、g コマンドで処理を再開した後に再度システムを一時停止し、先ほど特定したメモリブロックのアドレスを対象に <code class=\"language-text\">!pool 0xffff828292b6b270 1</code> コマンドを実行したところ、プールタグ flag が割り当てられた領域に書き込まれているデータを表示できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 638px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7ad829ee377b197cb8559625be73e6b4/41be6/driver-kernel-debug-020.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB0ElEQVQoz32SXW/iMBBF+f/vSEXqA9qX/hq0iZPYiRM7IR8QoLRk+9zc3nHaaldFC0KxRs6Zc2dYvT694rK9oN10qNce/UOHYT3gZXPFn+2EZt3isBlw2pxC/e3xDdPmhvPDmfUDnrdXTL8m3B5vmNSEFTDj8nJBXubIrYZ1Fq5xqNuazwqmLFB6C2MNqrqCLnS4W3k5Gzzfrvj6zPyu5vd3HA5H5CaHzXNobdC1tOx7qDhGy3NVlsjSjLUBaZLCOzasGyiVYBxPC2yehbgAe76cZRmhOgCbZk9oy1oK5zwM62mSoOO9mE28d6GulPoHKL8AHMcR2hgYnRGiadWi6zqkaQLna9iiCA2llhBcMIn3HlEU43w+/wSKodaaFwnl5ZYvCjSOowVoCzbT6IchNCzYoGmaT8PxJ/DIoqHhElljT5gAxdBzVjJDa20wFIhErusaMc//NRRgnhfY75fIEtMxmpiL2UBDiVxV5bfh6XRnhsfjMcwwGPIpMFlKkiiUlUNZ2pBgGYMKI3DcdPQ7uh+5599BtismebFE67olckNbRyPz2UgMpYHnbGMu5e6WxTDMkEAx/FqKUjGBe5ScX5qmoSZA56pguNvtwvz/Bn4AvssfcWjG3AYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7ad829ee377b197cb8559625be73e6b4/8ac56/driver-kernel-debug-020.webp 240w,\n/static/7ad829ee377b197cb8559625be73e6b4/d3be9/driver-kernel-debug-020.webp 480w,\n/static/7ad829ee377b197cb8559625be73e6b4/a2d8a/driver-kernel-debug-020.webp 638w\"\n              sizes=\"(max-width: 638px) 100vw, 638px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7ad829ee377b197cb8559625be73e6b4/8ff5a/driver-kernel-debug-020.png 240w,\n/static/7ad829ee377b197cb8559625be73e6b4/e85cb/driver-kernel-debug-020.png 480w,\n/static/7ad829ee377b197cb8559625be73e6b4/41be6/driver-kernel-debug-020.png 638w\"\n            sizes=\"(max-width: 638px) 100vw, 638px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7ad829ee377b197cb8559625be73e6b4/41be6/driver-kernel-debug-020.png\"\n            alt=\"!pool コマンドで割り当てたブロックのヘッダとコンテンツを参照する\"\n            title=\"!pool コマンドで割り当てたブロックのヘッダとコンテンツを参照する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>しかし、このままでは 2 つ目の Flag 文字列が本当に書き込まれているか判断しづらいので、対象アドレスの Unicode 文字列を表示する du コマンドを使用し、<code class=\"language-text\">du ffff828292b6b270</code> を実行することで正解の Flag である <code class=\"language-text\">FLAG{The_important_process_is_topsecret.exe}</code> がメモリブロックに書き込まれていることを確認できました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 508px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/35673e0e040c08514ee9bf2ae3824af5/2fd48/driver-kernel-debug-021.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAn0lEQVQI102OWQ6DMAxEuf/BGlIBaZZmkcJWfqhIgRtMnUhU/Xgae6QZu4qxR+x7yIdA0zTouhZtViEgpcSyLDjPE8dxFL3ma//3MxVjNZyzpejGWCm1zmGcJhitIZWCImKMUHRAawMfPKy18N4jhEB5h2EYiQFVLvHeQdBHjGbOawoErOubvA5aSRjzLAWc3zHPL+z7B9u2FVJKP818AapG1k4epK3TAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/35673e0e040c08514ee9bf2ae3824af5/8ac56/driver-kernel-debug-021.webp 240w,\n/static/35673e0e040c08514ee9bf2ae3824af5/d3be9/driver-kernel-debug-021.webp 480w,\n/static/35673e0e040c08514ee9bf2ae3824af5/7b066/driver-kernel-debug-021.webp 508w\"\n              sizes=\"(max-width: 508px) 100vw, 508px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/35673e0e040c08514ee9bf2ae3824af5/8ff5a/driver-kernel-debug-021.png 240w,\n/static/35673e0e040c08514ee9bf2ae3824af5/e85cb/driver-kernel-debug-021.png 480w,\n/static/35673e0e040c08514ee9bf2ae3824af5/2fd48/driver-kernel-debug-021.png 508w\"\n            sizes=\"(max-width: 508px) 100vw, 508px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/35673e0e040c08514ee9bf2ae3824af5/2fd48/driver-kernel-debug-021.png\"\n            alt=\"メモリブロック内の Flag を参照する\"\n            title=\"メモリブロック内の Flag を参照する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これで、2 つ目の正しい Flag を特定することができました。</p>\n<h2 id=\"プールタグからメモリブロックのアドレスを特定する\" style=\"position:relative;\"><a href=\"#%E3%83%97%E3%83%BC%E3%83%AB%E3%82%BF%E3%82%B0%E3%81%8B%E3%82%89%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"プールタグからメモリブロックのアドレスを特定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>プールタグからメモリブロックのアドレスを特定する</h2>\n<p>ExAllocatePoolWithTag 関数が割り当てたメモリブロックのアドレスを参照することで 2 つ目の正しい Flag を特定できましたが、必ずしも今回のように静的解析で特定のプールタグと紐づくプールを割り当てるコードを特定できるとは限りません。</p>\n<p>そのため、ここからは静的解析でメモリ割り当てを行う実行コードを特定する以外のアプローチで、特定のプールタグと紐づくメモリブロックのアドレスを特定することを試みます。</p>\n<p>プールタグからページプールのアドレスを特定可能な方法の 1 つとして、!poolfind コマンド <sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup> があります。</p>\n<p>!poolfind コマンドでは、ページプールや非ページプールの領域から、特定のプールタグを持つインスタンスをすべて検索することができます。</p>\n<p>例えば、以下のように <code class=\"language-text\">!poolfind -tag \"Proc\"</code> コマンドを実行すると、Proc というタグ名のインスタンスのアドレスをページプールから検索できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 785px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3cc43efb2e1cd279d858ccd6da8e553e/cda19/driver-kernel-debug-022.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACnElEQVQ4y4VU226bQBTk/z+geepDlVZVGyWK1KdKfagUxXXj+M5iG3AAYzBgbgv4FjuZnt3UaS5NgjQ6e3ZhdnbPHJQgCBAEIaaej2gey3GSZiirCqvVGkVZoaoWWCyXqBYL7HY7PHxub28f5UqeRCjzBDyLUfLkbpxGyJMQBc1lcYiUIN7jWUrkFTjnyLIMeZ7Tpqu/eSrnFPPsE0Y/D2FQnDWPMal/QdQ+AWffkHRP4f7+iqvzzxifHSK2OxB6rq+v7yEUb7dbbDYbmStpPEcUzpClMYoil7EqOVZLOmrBkcQRwmCGeRTS3BJvPYpt2zAME+PxFUUDKmM0HmM+n8N1p5hMJghCIluvsSTCsiyxoLt8CYpGBI1GA7VaDZeXl1BVVebdXg99glg3TRPD4RCWZcFxbIS0QZqmSJLkGRSTVPX7fTRbLYyGI/mxyBkRCRKh0HVdaJomFbuU+74PXhSyKE+h+J4Ha2zDsRxYpoU4jBHOAlKnSnWe72FNx93bQ8SbmxsZ/wdlGrroGj0MbIYZ9+VHyTJBrXWO7qAD23GwfeK9V4sS1gOY78cwPjjgJ2vgO8BPc7ADFdMfHjY7ssPmn0X2Kl9UGDkB9DpV+CIFO6NOYQWiQQCn48AduIiTWJr5zsTrtxUO9QGYztDqNdBmTdieBX/uI6RO4RUnT1b3lhDEwjavQdFU8p0xRrPRRKtJd2bZ8KmvZdWyXLaTsIiAGD/Ffm0PhQ0ZBoaGi/YFfl3UqbIa2u02dLJTFEWYUcWF7wREvofIxY8ljuNHGyjH2jEOvY84GL7DUecIrMeoW1TpRYcqLDpJeFFgOnUJ5EUB8qZtW7KL9kolYV/rY3SlQ6N7bPc60HVdkggTi7+IgDw+f25iufaATOAPMzWpc+pXCcYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/3cc43efb2e1cd279d858ccd6da8e553e/8ac56/driver-kernel-debug-022.webp 240w,\n/static/3cc43efb2e1cd279d858ccd6da8e553e/d3be9/driver-kernel-debug-022.webp 480w,\n/static/3cc43efb2e1cd279d858ccd6da8e553e/f2d53/driver-kernel-debug-022.webp 785w\"\n              sizes=\"(max-width: 785px) 100vw, 785px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/3cc43efb2e1cd279d858ccd6da8e553e/8ff5a/driver-kernel-debug-022.png 240w,\n/static/3cc43efb2e1cd279d858ccd6da8e553e/e85cb/driver-kernel-debug-022.png 480w,\n/static/3cc43efb2e1cd279d858ccd6da8e553e/cda19/driver-kernel-debug-022.png 785w\"\n            sizes=\"(max-width: 785px) 100vw, 785px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/3cc43efb2e1cd279d858ccd6da8e553e/cda19/driver-kernel-debug-022.png\"\n            alt=\"!poolfind によるプールタグの検索\"\n            title=\"!poolfind によるプールタグの検索\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>しかし、多くの場合 !poolfind によるプールタグの検索には極めて長い時間がかかります。</p>\n<p>また、詳細は不明ながらデバッガのハングアップやプールタグの検出漏れに関する情報も散見されるため、!poolfind によるプールタグの検索はあまり効率的ではありません。</p>\n<p>そこで、プールタグの検索ではなく、PoolHitTag を使用して特定のプールタグを使用するメモリ割り当てを検出することで、ExAllocatePoolWithTag 関数の戻り値からメモリブロックのアドレスを特定します。</p>\n<h2 id=\"poolhittag-を使用してメモリの割り当てアドレスを特定する\" style=\"position:relative;\"><a href=\"#poolhittag-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"poolhittag を使用してメモリの割り当てアドレスを特定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PoolHitTag を使用してメモリの割り当てアドレスを特定する</h2>\n<p>ライブデバッグを行う場合、特定のプールタグ名と紐づくメモリアドレスを特定する方法として、PoolHitTag を利用することができます。<sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup></p>\n<p>PoolHitTag は <code class=\"language-text\">ed nt!poolhittag</code> コマンドで設定できます。</p>\n<p>例えば、プールタグ名 flag を指定したい場合は、<code class=\"language-text\">ed nt!poolhittag 'galf'</code> のようにリトルエンディアン形式に合わせて逆順にした 4 文字のタグ名を指定します。</p>\n<p>設定が正しく反映されている場合、<code class=\"language-text\">db nt!poolhittag L4</code> コマンドで指定したプールタグ名が設定されていることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 725px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/567a7ccbceda95ad9550f3695717f788/a0209/driver-kernel-debug-023.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.583333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAvklEQVQI1z2Oy2rCQBSG87BKER/Ap3LR2oXQvZUoXnBRS0zMJDNTkpiFKLmMJF8zwfbAB+fC+fgdoSUykXyfPc5SECrBKQo4nr7wvSMq9MlTTZZlKKWI45g0TTDG0LYtTdP8Y2dnspcMtprhMmC48BitBS8byXijmR4SPrrbp3/lXlQ8OokV1XVNWZYURdFTVVWP7Z13N+B1FfHmhsxWgvlOd/wwP1xY+DfcyLCOuwfTwDORTfKH3eV53sts/QJX5tvkl+jOZAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/567a7ccbceda95ad9550f3695717f788/8ac56/driver-kernel-debug-023.webp 240w,\n/static/567a7ccbceda95ad9550f3695717f788/d3be9/driver-kernel-debug-023.webp 480w,\n/static/567a7ccbceda95ad9550f3695717f788/92338/driver-kernel-debug-023.webp 725w\"\n              sizes=\"(max-width: 725px) 100vw, 725px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/567a7ccbceda95ad9550f3695717f788/8ff5a/driver-kernel-debug-023.png 240w,\n/static/567a7ccbceda95ad9550f3695717f788/e85cb/driver-kernel-debug-023.png 480w,\n/static/567a7ccbceda95ad9550f3695717f788/a0209/driver-kernel-debug-023.png 725w\"\n            sizes=\"(max-width: 725px) 100vw, 725px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/567a7ccbceda95ad9550f3695717f788/a0209/driver-kernel-debug-023.png\"\n            alt=\"PoolHitTag を設定する\"\n            title=\"PoolHitTag を設定する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ちなみに、PoolHitTag の設定を解除する場合 <code class=\"language-text\">ed nt!poolhittag 0</code> コマンドを使用します。</p>\n<p>PoolHitTag を設定した後に topsecret.exe を仮想マシンで実行すると、以下のように ExAllocateHeapPool 関数の途中でシステムが一時停止します。</p>\n<p>この時の RAX レジスタには、指定したプールタグ名である flag が格納されていることを確認できます。</p>\n<p>また、PoolHitTag にヒットした箇所でスタックバックトレースを参照すると、DoPDriver がこのプールタグと紐づくメモリ割り当てを要求していることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 814px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5f9e8856f83d697b88fb77f811dc941f/a4262/driver-kernel-debug-024.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB70lEQVQoz5VTy27iQBD0//9FpIRLDjnmFq1WglOUkGBjMH6MMX6DMS9jbKC2u4EVV1oqjWfsqa6ubmtxkmI2m6Gua5zPZzRNgyzLsL/uT6cTjscjdpsd6qoGzhDw2Q383Q2aUivYjgWlFCaTCcIoxHg8xtiy4Ps+0jRFVVf41D/RN7/xRRhOTMRRJO/zPMctroRrOO5ECE3TRBiGcF1XSHnNsxzFpsDzn2d0/r7g6eMJXb2HslhisVhgs9mgLEupkEMIXc+Gr3whnDGh44hah1ZW2DYt8jhDFqVIwxRxmMCyLgnX6zWatpXShdBxSiIy6LKLEalSysPg9xeepzCkBBGVxr4aQ4OssSmRJclYXXFVeB/aaOSj3/+GYRgIggARKbRtG9NpQKQeeRqJClbLzWPvFHm3JqLD4YD9fo/tdovdbifQPO/il67rsGiN40TM5Y9v4Euskp/r+oCG1qqqhIDXe2jchHK5lMxDUsmesaLj8fS/c4+ElsznCKj1cVHAoFKDMBJv2LstKXgkZGyinx+k3a7g6/UV9mBA5jvUxcsc8kiw6iVVwYlWqxU1ZC57OSMht2chTHo9FG9vqN/fMe10sCCygi7l9LekaSbzxd6xh4yWRqS5299DCGMqOeHhpAOPlCjqNE8/jwV7+Wj8A+2JiC+wTRXoAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/5f9e8856f83d697b88fb77f811dc941f/8ac56/driver-kernel-debug-024.webp 240w,\n/static/5f9e8856f83d697b88fb77f811dc941f/d3be9/driver-kernel-debug-024.webp 480w,\n/static/5f9e8856f83d697b88fb77f811dc941f/f23e7/driver-kernel-debug-024.webp 814w\"\n              sizes=\"(max-width: 814px) 100vw, 814px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/5f9e8856f83d697b88fb77f811dc941f/8ff5a/driver-kernel-debug-024.png 240w,\n/static/5f9e8856f83d697b88fb77f811dc941f/e85cb/driver-kernel-debug-024.png 480w,\n/static/5f9e8856f83d697b88fb77f811dc941f/a4262/driver-kernel-debug-024.png 814w\"\n            sizes=\"(max-width: 814px) 100vw, 814px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/5f9e8856f83d697b88fb77f811dc941f/a4262/driver-kernel-debug-024.png\"\n            alt=\"PoolHitTag でプールタグ flag の割り当てを検出する\"\n            title=\"PoolHitTag でプールタグ flag の割り当てを検出する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>そのため、関数の完了後までシステムを実行する gu コマンドを 2 回発行することで、DoPDriver が ExAllocatePoolWithTag 関数を実行した直後のレジスタを参照できるようになります。</p>\n<p>ここから、前項と同じ手順で戻り値が格納される RAX レジスタよる、プールタグ名 flag と紐づけて割り当てたメモリブロックのアドレスを特定することができました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 799px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e8d8ece0f759dca4aded34dad3a6c48f/76cea/driver-kernel-debug-025.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAA7DAAAOwwHHb6hkAAADIUlEQVQ4y3VUa4/SUBDt//8JZqNf1g/Ez5qYqHHdKLJAebRA3w9oKe1SWihbWBY4zoyy0U1sMrlt7+2ZM2fOVJkYEwRBgOl0isD3aZ1hPp+jqio8PDygrmtZq22F/X6P3X4n6/9CMU1LANI0RUbBwGVZ4vHxEZvNBtvtFmt6LvICh/0B5+MZh8NBPuYzkmS3ew5lMBxgPJ4gDENhapoGOp0uHMeB53m4z+5hezZu27doD9tQxyosx0I0i+BTRfMkEQKr1Qp5nkPRtD76/QEGgz663S6Bj9Fq3WE4HKKrdpEuMrTHbbx6/wrXn69x9eEK39XvCLwAruciiiKpKs0yAVY0nQAHAwHo9XowDAN3dwSoaVBVlT6IEVPoQx3G2IBlmNA1Xc6ORiPEcSxyMbuiKKDo2hD9HjHs9dFutwWES+YkzWYTEX0QkhStVgsqgajE+ndik+QxnzXnkjmUn2oTvRFlM3UpgXVxXRez2QyWZUnmjMph5lwev2etK2rWpSHshIsblNcf3+Dt17do3DYQzALc3y8JIEWSLARsvV5LKat8hSXtFcQiSzNJklBDfjtkIfdSsk/i5ssc9UMtFmE9FosFAW0k+9PTE/IiRxiHmGdzLMslynUpe+LPP37lVXwYhB58KuGSLY4jTCYGgaZS4ol8N56O8PrTG7xrvkPjRwN2bON4OIrJ2YsMeDqdwBcBuuQ5Fy75jnViQO4e+5CnaEOZKzK479EUhVNMg1A0ZnuxlptNJZWx2QXQcUxYtg3btsTg3Dk+zM3RdY2y16INJ3HJ6I5jwyPAhGThinia/r4UfaRBI1+5Mhm+HLYpQUhsmHFRlKTxUpKwBFHEXfZRk4an0/GfMeRQuFw+LAwIjNt/Ebyud8Lw73eXHwY3gdm9DGVGGZNkTgxt+tt4ZNSQvDYlhgGWxKwmgC39aQ6PeyroLKxOx6Os/PzyUiztJ/TON2idG4mxegtHb6Hf+gJr2KS9G9i0hkYH/qSDwFCR+DpiZ4BtVQrI+Xx+DmUuo+XDtkzMiB03IF0k0u2MDLug+w2be5XLCPLeKicvloV49CXgL7cs4lr8cIwQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e8d8ece0f759dca4aded34dad3a6c48f/8ac56/driver-kernel-debug-025.webp 240w,\n/static/e8d8ece0f759dca4aded34dad3a6c48f/d3be9/driver-kernel-debug-025.webp 480w,\n/static/e8d8ece0f759dca4aded34dad3a6c48f/a2266/driver-kernel-debug-025.webp 799w\"\n              sizes=\"(max-width: 799px) 100vw, 799px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e8d8ece0f759dca4aded34dad3a6c48f/8ff5a/driver-kernel-debug-025.png 240w,\n/static/e8d8ece0f759dca4aded34dad3a6c48f/e85cb/driver-kernel-debug-025.png 480w,\n/static/e8d8ece0f759dca4aded34dad3a6c48f/76cea/driver-kernel-debug-025.png 799w\"\n            sizes=\"(max-width: 799px) 100vw, 799px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e8d8ece0f759dca4aded34dad3a6c48f/76cea/driver-kernel-debug-025.png\"\n            alt=\"割り当てたメモリブロックのアドレスを特定する\"\n            title=\"割り当てたメモリブロックのアドレスを特定する\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>このような PoolHitTag を利用したメモリの割り当て元の特定は、カーネル空間のメモリリークなどのトラブルシューティングを行う際にも有用です。</p>\n<h2 id=\"6-章のまとめ\" style=\"position:relative;\"><a href=\"#6-%E7%AB%A0%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"6 章のまとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6 章のまとめ</h2>\n<p>本章では、カーネルデバッガを使用した動的解析によって総当たりで正しいイメージファイル名を特定し、2 つ目の Flag を特定することができました。</p>\n<p>カーネルデバッグは、デバッグ対象となるメモリ空間は膨大で、難解な OS のアーキテクチャに対する一定の理解も必要となるため、かなりハードルの高い技術といえるでしょう。</p>\n<p>しかし、本章で紹介したような最低限の知識と基本的なコマンドを使用するだけでも、OS やドライバの動作を理解する助けとなり、プール領域のメモリリークなどのトラブルシューティングにも応用できるようになります。</p>\n<p>もちろん、実際のカーネルデバッグでは、本章では扱っていないプロセスやユーザセッションのコンテキストやオブジェクトマネージャ、I/O マネージャの動作など、様々な点を考慮する必要がありますが、本書の内容がそのようなより高度な技術を習得するための足掛かりの 1 つになれば幸いです。</p>\n<h2 id=\"あとがき\" style=\"position:relative;\"><a href=\"#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D\" aria-label=\"あとがき permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>あとがき</h2>\n<p>本書を最後までお読みいただき誠にありがとうございます。</p>\n<p>本書では、前著である 「Magical WinDbg -雰囲気で楽しむ Windows ダンプ解析とトラブルシューティング-」に引き続き、WinDbg を使用したユーザモードとカーネルドライバのライブデバッグのテクニックについて紹介しました。</p>\n<p>Windows のユーザモードデバッグに関するナレッジは比較的豊富に存在していますが、カーネルデバッグに関する情報や最新の WinDbg で利用できる強力なスクリプティング機能に関する情報はあまり多くはありません。</p>\n<p>そのため、本書では特に JavaScript ベースのデバッガスクリプトによる解析の自動化や、カーネルデバッグの入門に役立つ情報を紹介することを目的に執筆しました。</p>\n<p>本書が、少しでもこれから WinDbg や Windows のカーネルデバッグに関心を持ち、取り組む方の助けになることを願っております。</p>\n<p>改めて、本書をお読みいただきありがとうございました。</p>\n<h2 id=\"各章へのリンク\" style=\"position:relative;\"><a href=\"#%E5%90%84%E7%AB%A0%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF\" aria-label=\"各章へのリンク permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>各章へのリンク</h2>\n<ul>\n<li><a href=\"/magical-windbg-vol2-00\">まえがき</a></li>\n<li><a href=\"/magical-windbg-vol2-01\">1 章 環境構築</a></li>\n<li><a href=\"/magical-windbg-vol2-02\">2 章 DoPClient と DoPDriver の表層解析</a></li>\n<li><a href=\"/magical-windbg-vol2-03\">3 章 DoPClient の静的解析を行う</a></li>\n<li><a href=\"/magical-windbg-vol2-04\">4 章 DoPClient を動的解析する</a></li>\n<li><a href=\"/magical-windbg-vol2-05\">5 章 DoPDriver の静的解析を行う</a></li>\n<li><a href=\"/magical-windbg-vol2-06\">6 章 DoPDriver を動的解析する</a></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>pa (アドレスまでステップ実行) <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/pa--step-to-address-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/pa—step-to-address-</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-2\">\n<p>!poolused <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/-poolused\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/-poolused</a></p>\n<a href=\"#fnref-2\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-3\">\n<p>!pool <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/-pool\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/-pool</a></p>\n<a href=\"#fnref-3\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-4\">\n<p>!poolfind <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/-poolfind\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debuggercmds/-poolfind</a></p>\n<a href=\"#fnref-4\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-5\">\n<p>カーネルデバッガーを使用したカーネルモードメモリリークの検出 <a href=\"https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/using-the-kernel-debugger-to-find-a-kernel-mode-memory-leak\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://learn.microsoft.com/ja-jp/windows-hardware/drivers/debugger/using-the-kernel-debugger-to-find-a-kernel-mode-memory-leak</a></p>\n<a href=\"#fnref-5\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","fields":{"slug":"/magical-windbg-vol2-06","tagSlugs":["/tag/magical-win-dbg/","/tag/windows/","/tag/win-dbg/"]},"frontmatter":{"date":"2024-05-26","description":"技術書典 16 で頒布した Magical WinDbg 2 - CTF で学ぶユーザモード & カーネルデバッギング - の WEB 版です。","tags":["Magical WinDbg","Windows","WinDbg"],"title":"Magical WinDbg VOL.2【6 章 DoPDriver を動的解析する】","socialImage":{"publicURL":"/static/e9bfc3718fd53ab58623a496fc9a302e/magical-windbg-vol2.png"}}}},"pageContext":{"slug":"/magical-windbg-vol2-06"}},"staticQueryHashes":["251939775","401334301","825871152"]}