{"componentChunkName":"component---src-templates-post-template-js","path":"/note-githubactions-for-pages","result":{"data":{"markdownRemark":{"id":"1742b00e-6dc2-594c-852f-e2d4fac114d1","html":"<p>今回はGatsbyとGithub Pagesで運用しているこのブログで、公開する記事以外のファイルをPrivateリポジトリで管理する運用方法についてまとめます。</p>\n<p>GithubのPro以上のサブスクリプションであれば、Privateリポジトリでも特定のブランチのみをGithub Pagesで公開することができますが、Github Actionsを使うことでFreeのユーザーでも公開記事以外のファイルをPrivateリポジトリで管理できるようにしたいと思い、この記事の手順を使用しました。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li><a href=\"#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99\">事前準備</a></li>\n<li>\n<p><a href=\"#gatsby%E3%81%AE%E8%87%AA%E5%8B%95%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B\">Gatsbyの自動デプロイを構成する</a></p>\n<ul>\n<li><a href=\"#%E8%87%AA%E5%8B%95%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AEgithub-action%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\">自動デプロイのためのGithub Actionについて</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#github-actions%E3%81%A7%E4%BB%96%E3%81%AE%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92push%E3%81%99%E3%82%8B\">Github Actionsで他のリポジトリにファイルをPushする</a></p>\n<ul>\n<li><a href=\"#github-actions%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AB%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B\">Github Actionsを実行するリポジトリ(ソースリポジトリ)に秘密鍵を登録する</a></li>\n<li><a href=\"#push%E5%85%88%E3%81%AE%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AB%E5%85%AC%E9%96%8B%E9%8D%B5%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B\">Push先のリポジトリに公開鍵を登録する</a></li>\n<li><a href=\"#github-actions%E3%81%A7%E4%BB%96%E3%81%AE%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92push%E3%81%99%E3%82%8B-1\">Github Actionsで他のリポジトリにファイルをPushする</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n<h2 id=\"事前準備\" style=\"position:relative;\"><a href=\"#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99\" aria-label=\"事前準備 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>事前準備</h2>\n<p>この手順を実施するために、事前に以下の準備が必要になります。</p>\n<ul>\n<li><strong>Freeユーザーで登録されているGithubアカウント</strong></li>\n<li><strong>公開ページを作成するためのファイルとGithub Actionsを管理するPrivateリポジトリ</strong></li>\n<li><strong>静的サイトジェネレータにより生成された公開記事のみを配置し、Github Pagesで公開するPublicリポジトリ</strong></li>\n</ul>\n<p>静的サイトジェネレータの使用方法やGithub Pagesの設定については本記事の対象外としています。</p>\n<p>ローカルでGatsbyを使用し、デプロイされた記事をGithub Pagesで公開する方法については以下をご参照ください。</p>\n<p>参考：<a href=\"/note-how-to-deploy-gatsby-spa\">Gatsbyで作成したSPAブログをGitHubPagesに公開する環境を作る備忘録 - かえるのひみつきち</a></p>\n<h2 id=\"gatsbyの自動デプロイを構成する\" style=\"position:relative;\"><a href=\"#gatsby%E3%81%AE%E8%87%AA%E5%8B%95%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B\" aria-label=\"gatsbyの自動デプロイを構成する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gatsbyの自動デプロイを構成する</h2>\n<p>まずはGatsbyやマークダウンを管理するPrivateリポジトリにて以下のGithub Actionsを追加します。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy<span class=\"token punctuation\">-</span>and<span class=\"token punctuation\">-</span>push\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy-and-push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">container</span><span class=\"token punctuation\">:</span> kashiwabayuki/gatsby<span class=\"token punctuation\">-</span>env\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">submodules</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install npm\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">NODE_OPTIONS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"--max_old_space_size=4096\"</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install\n\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> gatsby clean <span class=\"token important\">&amp;&amp;</span> gatsby build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>prefix<span class=\"token punctuation\">-</span>paths <span class=\"token important\">&amp;&amp;</span> echo 'kashiwaba<span class=\"token punctuation\">-</span>yuki.com' <span class=\"token punctuation\">></span> public/CNAME\n\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Pushes to public repository\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> cpina/github<span class=\"token punctuation\">-</span>action<span class=\"token punctuation\">-</span>push<span class=\"token punctuation\">-</span>to<span class=\"token punctuation\">-</span>another<span class=\"token punctuation\">-</span>repository@main\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">SSH_DEPLOY_KEY</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SSH_DEPLOY_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">source-directory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'./public'</span>\n        <span class=\"token key atrule\">destination-github-username</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'kash1064'</span>\n        <span class=\"token key atrule\">destination-repository-name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Kaeru-no-Himitsukichi-Public'</span>\n        <span class=\"token key atrule\">user-email</span><span class=\"token punctuation\">:</span> kashiwabayuki@gmail.com\n        <span class=\"token key atrule\">target-branch</span><span class=\"token punctuation\">:</span> public</code></pre></div>\n<h3 id=\"自動デプロイのためのgithub-actionについて\" style=\"position:relative;\"><a href=\"#%E8%87%AA%E5%8B%95%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AEgithub-action%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"自動デプロイのためのgithub actionについて permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>自動デプロイのためのGithub Actionについて</h3>\n<p>上から順に見ていきます。</p>\n<p>まず、以下の箇所は、アクションの名前と実行されるタイミングを定義しています。</p>\n<p>今回は、mainリポジトリにpushされたタイミングで実行するようにします。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy<span class=\"token punctuation\">-</span>and<span class=\"token punctuation\">-</span>push\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main</code></pre></div>\n<p>続いて、jobの中で<code class=\"language-text\">ubuntu-latest</code>のワークフローを使用し、<code class=\"language-text\">kashiwabayuki/gatsby-env</code>という自作のデプロイ用のコンテナを用意させています。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">deploy-and-push</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n  <span class=\"token key atrule\">container</span><span class=\"token punctuation\">:</span> kashiwabayuki/gatsby<span class=\"token punctuation\">-</span>env</code></pre></div>\n<p>このコンテナイメージは、以下の記事の手順で作成したものです。</p>\n<p>参考：<a href=\"/note-how-to-deploy-gatsby-spa#gatsby%E9%96%8B%E7%99%BA%E7%94%A8%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\">Gatsbyで作成したSPAブログをGitHubPagesに公開する環境を作る備忘録 - かえるのひみつきち</a></p>\n<p>そして、<code class=\"language-text\">actions/checkout@v2</code>を使用してPrivateリポジトリ内のmainブランチのファイルをコンテナにcloneし、<code class=\"language-text\">actions/checkout@v2</code>で依存関係のnode moduleをインストール、最後にgatsbyコマンドで記事をビルドしています。</p>\n<p>ちなみに、<code class=\"language-text\">nom install</code>と<code class=\"language-text\">gatsby build</code>の完了までに、合わせて10分程度要しています。リソース的にも無駄が多いですし、Privateリポジトリの場合は2000分/月の実行時間制限もあるのでこの時間は短縮したいのですが、中々いいアイデアが浮かびませんでした。</p>\n<p>記事の公開時にしかこのActionsは動かないですし、2000分はどう考えても超えないはずなので一旦保留にしてます。</p>\n<p>また思いついたら修正しようと思います。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n  <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">submodules</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install npm\n  <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">NODE_OPTIONS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"--max_old_space_size=4096\"</span>\n  <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy\n  <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> gatsby clean <span class=\"token important\">&amp;&amp;</span> gatsby build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>prefix<span class=\"token punctuation\">-</span>paths <span class=\"token important\">&amp;&amp;</span> echo 'kashiwaba<span class=\"token punctuation\">-</span>yuki.com' <span class=\"token punctuation\">></span> public/CNAME</code></pre></div>\n<p>この時、<code class=\"language-text\">NODE_OPTIONS: \"--max_old_space_size=4096\"</code>をセットしないと<code class=\"language-text\">npm install</code>がタイムアウトで失敗しました。</p>\n<p>これでコンテナ内の<code class=\"language-text\">./public</code>ディレクトリに公開用のファイルがビルドされたので、生成されたファイルをPublicリポジトリにpushします。</p>\n<h2 id=\"github-actionsで他のリポジトリにファイルをpushする\" style=\"position:relative;\"><a href=\"#github-actions%E3%81%A7%E4%BB%96%E3%81%AE%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92push%E3%81%99%E3%82%8B\" aria-label=\"github actionsで他のリポジトリにファイルをpushする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Github Actionsで他のリポジトリにファイルをPushする</h2>\n<p>Github Actionsで他のリポジトリにファイルをPushする場合は、Push先のリポジトリに対して書き込み可能なDeploy Keyをセットする必要があります。</p>\n<p>このキーを登録するために、事前に<code class=\"language-text\">ssh-keygen</code>コマンドで公開鍵と秘密鍵のペアを生成しておきます。</p>\n<h3 id=\"github-actionsを実行するリポジトリソースリポジトリに秘密鍵を登録する\" style=\"position:relative;\"><a href=\"#github-actions%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AB%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B\" aria-label=\"github actionsを実行するリポジトリソースリポジトリに秘密鍵を登録する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Github Actionsを実行するリポジトリ(ソースリポジトリ)に秘密鍵を登録する</h3>\n<p>まずは、Github Actionsを実行するリポジトリに秘密鍵を登録します。</p>\n<p>GithubのリポジトリページのSettingsにて、[Secrets]>[Actions]から新しいSecretoを登録できます。</p>\n<p>この時、Secretの名前は<code class=\"language-text\">SSH_DEPLOY_KEY</code>としておきます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 868px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b9ddef0c27ce6c83ecdca474681a86f6/748b0/image-20221029005654913.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/0lEQVQoz5WR226CQBCG97YplIPL2QVBhXJQEBWNafr+b/V3dtSENL2oF192Zth8/AzCTmossgEL1cJNewRphaJskRafjGH7MJ3g34iQBG60hikVrCCH7S0hwxRelPH5ioyFSbZFmpeIVAFHRjApkTHjww0Z83HO+98yPRcxCf14xY0WvFse82qy5wuEpE9TeYXlqoQqatpbTfUWjp/AkjFj/4WX3JM+kukQG9q9yDYNxss3duMVh+kL/enGdMMF7TDxvDtQ3Z9pNnGtnxVlx7LnT3szJZpugNCJGrpc708saPZn6ifqj6i6kWZ3Qb078p2G0FKd0pitRifM1xV+AGNGt4bpE9F9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b9ddef0c27ce6c83ecdca474681a86f6/8ac56/image-20221029005654913.webp 240w,\n/static/b9ddef0c27ce6c83ecdca474681a86f6/d3be9/image-20221029005654913.webp 480w,\n/static/b9ddef0c27ce6c83ecdca474681a86f6/1ae05/image-20221029005654913.webp 868w\"\n              sizes=\"(max-width: 868px) 100vw, 868px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b9ddef0c27ce6c83ecdca474681a86f6/8ff5a/image-20221029005654913.png 240w,\n/static/b9ddef0c27ce6c83ecdca474681a86f6/e85cb/image-20221029005654913.png 480w,\n/static/b9ddef0c27ce6c83ecdca474681a86f6/748b0/image-20221029005654913.png 868w\"\n            sizes=\"(max-width: 868px) 100vw, 868px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b9ddef0c27ce6c83ecdca474681a86f6/748b0/image-20221029005654913.png\"\n            alt=\"image-20221029005654913\"\n            title=\"image-20221029005654913\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">SSH_DEPLOY_KEY</code>は、以下の通り<code class=\"language-text\">cpina/github-action-push-to-another-repository@main</code>の処理で使用されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Pushes to public repository\n\t<span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> cpina/github<span class=\"token punctuation\">-</span>action<span class=\"token punctuation\">-</span>push<span class=\"token punctuation\">-</span>to<span class=\"token punctuation\">-</span>another<span class=\"token punctuation\">-</span>repository@main\n    <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n    \t<span class=\"token key atrule\">SSH_DEPLOY_KEY</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SSH_DEPLOY_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"push先のリポジトリに公開鍵を登録する\" style=\"position:relative;\"><a href=\"#push%E5%85%88%E3%81%AE%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AB%E5%85%AC%E9%96%8B%E9%8D%B5%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B\" aria-label=\"push先のリポジトリに公開鍵を登録する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Push先のリポジトリに公開鍵を登録する</h3>\n<p>次に、公開用のリポジトリのSettingsからDeploy keyに公開鍵を登録します。</p>\n<p>このTitleは任意の名前でOKですが、[Allow write access]のチェックは有効にする必要があります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 876px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/48ae31ac4099608173b38e533e84898e/1b1d5/image-20221029010004464.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABY0lEQVQoz62SW07DMBBFXeI4cdo0zdN5p2mr0iIkBDtgG2yFxV/GzoMIiZYPPo7ujG3ZdzzDou4FSf+GmFR1V+xPV/TnZ8SqwTpI4YcKm10GX0PxPVhcHhFknSHMWnNRnLcI4pIO5NhG3/zpQlXtEWcV3HUA293ClgPCC+CMDPHOONZub8GirEaYVibxtgnWxFK9Ra4dLB0b1yNTBSyh8rxtbNwJqd3sBldyZHSoY1PBVMWo0zmd64fJYYWmOyFKS6R5DVW2yOkb8rKjvIEqWrOmKE9UNezrvaIZ18c9ukduQjDherBtTggI4cAWYo65bc+x0OsjYqETnHM40gezuABj7F/QjWUr7lJiEZwSG+xB3Maa1MGKyxlmuXA3EY1NfaZ/6qGqHrrjpqM0Hr/h+fGM/KFmbIrDGd3lCfXhEUVzRFLQB1PnJ02NDrEe+ruDffh4xdvnO4ILdUnSK2F2d3hv8QWFwBotlcb8dQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/48ae31ac4099608173b38e533e84898e/8ac56/image-20221029010004464.webp 240w,\n/static/48ae31ac4099608173b38e533e84898e/d3be9/image-20221029010004464.webp 480w,\n/static/48ae31ac4099608173b38e533e84898e/21dbd/image-20221029010004464.webp 876w\"\n              sizes=\"(max-width: 876px) 100vw, 876px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/48ae31ac4099608173b38e533e84898e/8ff5a/image-20221029010004464.png 240w,\n/static/48ae31ac4099608173b38e533e84898e/e85cb/image-20221029010004464.png 480w,\n/static/48ae31ac4099608173b38e533e84898e/1b1d5/image-20221029010004464.png 876w\"\n            sizes=\"(max-width: 876px) 100vw, 876px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/48ae31ac4099608173b38e533e84898e/1b1d5/image-20221029010004464.png\"\n            alt=\"image-20221029010004464\"\n            title=\"image-20221029010004464\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これで、ソースのリポジトリと公開用のリポジトリに秘密鍵と公開鍵のペアが登録されました。</p>\n<h3 id=\"github-actionsで他のリポジトリにファイルをpushする-1\" style=\"position:relative;\"><a href=\"#github-actions%E3%81%A7%E4%BB%96%E3%81%AE%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92push%E3%81%99%E3%82%8B-1\" aria-label=\"github actionsで他のリポジトリにファイルをpushする 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Github Actionsで他のリポジトリにファイルをPushする</h3>\n<p>ここまでですべての準備が整ったので、最後にデプロイされたGatsbyのファイルを公開用のPulicリポジトリにPushします。</p>\n<p>処理を自作してもいいのですが、今回は<a href=\"https://github.com/cpina/github-action-push-to-another-repository\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cpina/github-action-push-to-another-repository</a>を使わせてもらうことにしました。</p>\n<p>以下の処理をstepの最後に追加しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Pushes to public repository\n  <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> cpina/github<span class=\"token punctuation\">-</span>action<span class=\"token punctuation\">-</span>push<span class=\"token punctuation\">-</span>to<span class=\"token punctuation\">-</span>another<span class=\"token punctuation\">-</span>repository@main\n  <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">SSH_DEPLOY_KEY</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SSH_DEPLOY_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">source-directory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'./public'</span>\n    <span class=\"token key atrule\">destination-github-username</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'kash1064'</span>\n    <span class=\"token key atrule\">destination-repository-name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Kaeru-no-Himitsukichi-Public'</span>\n    <span class=\"token key atrule\">user-email</span><span class=\"token punctuation\">:</span> kashiwabayuki@gmail.com\n    <span class=\"token key atrule\">target-branch</span><span class=\"token punctuation\">:</span> public</code></pre></div>\n<p>詳しくは以下のドキュメントにある通りですが、<code class=\"language-text\">cpina/github-action-push-to-another-repository</code>ではSecretにセットされた秘密鍵を使用して、コンテナ内の任意のディレクトリを指定のリポジトリにPushすることができます。</p>\n<p>参考：<a href=\"https://cpina.github.io/push-to-another-repository-docs/overview.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Overview — github-action-push-to-another-repository documentation</a></p>\n<p>今回は、Gatsbyのデプロイされたファイルが配置される<code class=\"language-text\">./public</code>ディレクトリを、公開用のリポジトリのpublicブランチにPushするよう構成しています。</p>\n<p>これでActionが最後まで完了すると、Privateリポジトリの更新をトリガーにビルドされた記事がPublicリポジトリの公開用ブランチにPushされ、Github Pages上のブログが更新されます。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>Github Actionsは便利。</p>","fields":{"slug":"/note-githubactions-for-pages","tagSlugs":["/tag/notes/","/tag/github/","/tag/blog/"]},"frontmatter":{"date":"2022-10-29","description":"FreeプランのユーザーがGithub Pagesを使用する場合でも、公開記事以外のファイルをPrivateリポジトリで管理するする運用方法について","tags":["Notes","Github","Blog"],"title":"Github Free ユーザーでも公開記事以外のファイルを Private リポジトリで管理したい！","socialImage":{"publicURL":"/static/014b9da38c6ab107e526b407bd34b72a/note-githubactions-for-pages.png"}}}},"pageContext":{"slug":"/note-githubactions-for-pages"}},"staticQueryHashes":["251939775","401334301","825871152"]}