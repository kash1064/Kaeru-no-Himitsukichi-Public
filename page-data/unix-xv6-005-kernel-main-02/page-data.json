{"componentChunkName":"component---src-templates-post-template-js","path":"/unix-xv6-005-kernel-main-02","result":{"data":{"markdownRemark":{"id":"15037a43-4571-57fd-a518-57707f1740e2","html":"<p><a href=\"https://amzn.to/3q8TU3K\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ</a>にインスパイアされて<a href=\"https://github.com/mit-pdos/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">xv6 OS</a>を読んでます。</p>\n<p>UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした<a href=\"https://github.com/mit-pdos/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">xv6 OS</a>のリポジトリをForkした<a href=\"https://github.com/kash1064/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">kash1064/xv6-public: xv6 OS</a>のソースコードを読んでいくことにしました。</p>\n<p><a href=\"/unix-xv6-004-kernel-main-01\">前回</a>は<code class=\"language-text\">main</code>関数で初めに実行される<code class=\"language-text\">kinit1</code>関数による排他制御周りの挙動を確認しました。</p>\n<p>今回は<code class=\"language-text\">kvmalloc</code>関数によるxv6カーネルのページテーブルの初期化を追っていきます。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li>\n<p><a href=\"#32bit%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\">32bitページングについて</a></p>\n<ul>\n<li><a href=\"#pdt%E3%81%A8pt\">PDTとPT</a></li>\n<li><a href=\"#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%8B%E3%82%89%E7%89%A9%E7%90%86%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B%E6%B5%81%E3%82%8C\">仮想アドレスから物理アドレスを参照する流れ</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#kvmalloc%E9%96%A2%E6%95%B0\">kvmalloc関数</a></p>\n<ul>\n<li><a href=\"#%E4%BB%AE%E6%83%B3%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\">仮想メモリについて</a></li>\n<li><a href=\"#setupkvm%E9%96%A2%E6%95%B0\">setupkvm関数</a></li>\n<li><a href=\"#kalloc%E9%96%A2%E6%95%B0%E3%81%AB%E3%82%88%E3%82%8B%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%AE%E7%A2%BA%E4%BF%9D\">kalloc関数によるページの確保</a></li>\n<li><a href=\"#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AEpte%E3%81%AE%E4%BD%9C%E6%88%90\">仮想アドレスのPTEの作成</a></li>\n<li><a href=\"#freevm%E9%96%A2%E6%95%B0\">freevm関数</a></li>\n</ul>\n</li>\n<li><a href=\"#switchkvm%E9%96%A2%E6%95%B0\">switchkvm関数</a></li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n<li><a href=\"#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D\">参考書籍</a></li>\n</ul>\n<h2 id=\"32bitページングについて\" style=\"position:relative;\"><a href=\"#32bit%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"32bitページングについて permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>32bitページングについて</h2>\n<p>今回はxv6OSの<code class=\"language-text\">kvmalloc</code>関数から読んでいきます。</p>\n<p><code class=\"language-text\">kvmalloc</code>関数はカーネルのページテーブルを作成する関数です。</p>\n<p>そのため、ソースコードを読む前に、32bit環境でのページング機構について整理しておきます。</p>\n<p>ページング機構はMMU(Memory Management Unit)によって実装されます。</p>\n<p>x86環境では、MMUはPD(ページングディレクトリ)とPT(ページングテーブル)を利用してメモリマップを行います。</p>\n<h3 id=\"pdtとpt\" style=\"position:relative;\"><a href=\"#pdt%E3%81%A8pt\" aria-label=\"pdtとpt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PDTとPT</h3>\n<p>PDTとPTにはそれぞれPDE(ページディレクトリエントリ)とPTE(ページテーブルエントリ)が含まれます。</p>\n<p>PDEとPTEはどちらも1つ当たり4バイト(32bit)のサイズであり、PDにはPDEが、PTにはPTEが、それぞれ1024個含まれます。</p>\n<p>これによってPDEとPTEはどちらも4KiBのサイズ(x86におけるデフォルトの1ページ分)になります。</p>\n<p>各エントリの詳細については以下のリンク先が参考になります。</p>\n<p>参考：<a href=\"https://wiki.osdev.org/Paging\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Paging - OSDev Wiki</a></p>\n<h3 id=\"仮想アドレスから物理アドレスを参照する流れ\" style=\"position:relative;\"><a href=\"#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%8B%E3%82%89%E7%89%A9%E7%90%86%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B%E6%B5%81%E3%82%8C\" aria-label=\"仮想アドレスから物理アドレスを参照する流れ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>仮想アドレスから物理アドレスを参照する流れ</h3>\n<p>仮想アドレスを物理アドレスに変換する際、仮想アドレスは以下の3つに分割されます。</p>\n<ul>\n<li>最上位10bit：PDEのインデックス</li>\n<li>次の10bit：PTEのインデックス</li>\n<li>最下位12bit：ページオフセット</li>\n</ul>\n<p>アドレス変換の際、MMUはPDを参照して仮想アドレスのインデックスからPDEを特定します。</p>\n<p>次にPDEの情報と、仮想アドレスのインデックスからPTEを特定します。</p>\n<p>PTEは物理アドレスのベースアドレスを解決するため、仮想アドレスのオフセットと合わせて参照先の物理アドレスを特定することができます。</p>\n<p>詳細な流れは以下の図がわかりやすかったため引用しています。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c4e6687bec1fc2e4b2022ecd1f666969/41099/zu04.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.24999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHtXcgqv//EABgQAAMBAQAAAAAAAAAAAAAAAAABEQIQ/9oACAEBAAEFAuZdUIJQ/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Bp//EABgQAAIDAAAAAAAAAAAAAAAAAAABIDFB/9oACAEBAAY/AtLcf//EABsQAQADAAMBAAAAAAAAAAAAAAEAESExQVGB/9oACAEBAAE/IafR9iUblBuGIeZ21gCif//aAAwDAQACAAMAAAAQPM//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQIBAT8QVs//xAAaEAEBAQEBAQEAAAAAAAAAAAABEQAhMUFR/9oACAEBAAE/EAxtvyOZEYOrTdYgZ7vBDP0wR6B5F0AQ3//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/c4e6687bec1fc2e4b2022ecd1f666969/8ac56/zu04.webp 240w,\n/static/c4e6687bec1fc2e4b2022ecd1f666969/d3be9/zu04.webp 480w,\n/static/c4e6687bec1fc2e4b2022ecd1f666969/b0a15/zu04.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/c4e6687bec1fc2e4b2022ecd1f666969/09b79/zu04.jpg 240w,\n/static/c4e6687bec1fc2e4b2022ecd1f666969/7cc5e/zu04.jpg 480w,\n/static/c4e6687bec1fc2e4b2022ecd1f666969/41099/zu04.jpg 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/c4e6687bec1fc2e4b2022ecd1f666969/41099/zu04.jpg\"\n            alt=\"img\"\n            title=\"img\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>参照画像：<a href=\"https://xtech.nikkei.com/it/article/COLUMN/20071107/286632/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">第6回 メモリー上のデータを見えなくする（前編） | 日経クロステック（xTECH）</a></p>\n<p>PDは単なるPDEの配列形式になっています。</p>\n<p>PDの先頭アドレスはCR3レジスタに格納されています。</p>\n<h2 id=\"kvmalloc関数\" style=\"position:relative;\"><a href=\"#kvmalloc%E9%96%A2%E6%95%B0\" aria-label=\"kvmalloc関数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>kvmalloc関数</h2>\n<p>さて、<a href=\"/unix-xv6-004-kernel-main-01\">前回</a>に引き続きカーネルの<code class=\"language-text\">main</code>関数の処理を追っていきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Bootstrap processor starts running C code here.</span>\n<span class=\"token comment\">// Allocate a real stack and switch to it, first</span>\n<span class=\"token comment\">// doing some setup required for memory allocator to work.</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token function\">kinit1</span><span class=\"token punctuation\">(</span>end<span class=\"token punctuation\">,</span> <span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token operator\">*</span><span class=\"token number\">1024</span><span class=\"token operator\">*</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// phys page allocator</span>\n  <span class=\"token function\">kvmalloc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// kernel page table</span>\n  <span class=\"token function\">mpinit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// detect other processors</span>\n  <span class=\"token function\">lapicinit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// interrupt controller</span>\n  <span class=\"token function\">seginit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">// segment descriptors</span>\n  <span class=\"token function\">picinit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">// disable pic</span>\n  <span class=\"token function\">ioapicinit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// another interrupt controller</span>\n  <span class=\"token function\">consoleinit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// console hardware</span>\n  <span class=\"token function\">uartinit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// serial port</span>\n  <span class=\"token function\">pinit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">// process table</span>\n  <span class=\"token function\">tvinit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// trap vectors</span>\n  <span class=\"token function\">binit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">// buffer cache</span>\n  <span class=\"token function\">fileinit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// file table</span>\n  <span class=\"token function\">ideinit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">// disk </span>\n  <span class=\"token function\">startothers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// start other processors</span>\n  <span class=\"token function\">kinit2</span><span class=\"token punctuation\">(</span><span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token operator\">*</span><span class=\"token number\">1024</span><span class=\"token operator\">*</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span>PHYSTOP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// must come after startothers()</span>\n  <span class=\"token function\">userinit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// first user process</span>\n  <span class=\"token function\">mpmain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// finish this processor's setup</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"/unix-xv6-004-kernel-main-01\">前回</a>は<code class=\"language-text\">kinit1</code>関数が終了するところまで進めたので、今回は<code class=\"language-text\">kvmalloc</code>関数から見ていきます。</p>\n<p><code class=\"language-text\">kvmalloc</code>関数は<code class=\"language-text\">vm.c</code>で以下のように定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Allocate one page table for the machine for the kernel address</span>\n<span class=\"token comment\">// space for scheduler processes.</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">kvmalloc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  kpgdir <span class=\"token operator\">=</span> <span class=\"token function\">setupkvm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">switchkvm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">kvmalloc</code>関数はカーネルのページテーブルを変更します。</p>\n<p>ここで、カーネルがプロセスのアドレス空間を管理するための設計を持ったページテーブルに切り替えます。</p>\n<p>参考：<a href=\"https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">P.30 xv6OS</a></p>\n<p>なお、xv6OSではプロセスごとに1つのページテーブルが作成され、プロセスの実行時にはカーネルは現在のプロセスのページテーブルを使用します。</p>\n<p>また、<code class=\"language-text\">kpgdir</code>というCPUが実行していないプロセスを管理するページテーブルが用意されています。</p>\n<h3 id=\"仮想メモリについて\" style=\"position:relative;\"><a href=\"#%E4%BB%AE%E6%83%B3%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"仮想メモリについて permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>仮想メモリについて</h3>\n<p>xv6OSだけでなく、WindowsやLinuxなどの32bitOS(x86アーキテクチャ)では、プロセスごとに仮想メモリというプライベートなメモリ空間が割り当てられます。</p>\n<p>各プロセスごとの仮想アドレス空間は独立しているため、それぞれが任意のアドレスから2GiB分の仮想アドレスを指定してメモリアクセスを行うことができます。</p>\n<p>(プロセス側があるアドレスの参照を行ったときに、実際に物理メモリのどのアドレスを参照することになるかは、カーネル側で管理します。)</p>\n<p>この仕組みによって、ページングを行っていてもプロセスは常に仮想アドレスに対してメモリアクセスを行うことができるため、アプリケーション側は物理メモリのアドレス変更を考慮することなく開発することができます。</p>\n<p>また、32bitOSは最大4GiBまでのアドレス空間しか管理することができません。</p>\n<p>しかし、プロセスごとに仮想アドレス空間を作成しページングの仕組みを利用することで、実際よりも大きなメモリ空間を利用してシステムを動かすことができるようになります。</p>\n<p>そのほかにも、プロセス間でメモリ空間が独立していることによってメモリの競合を防いだりやアクセス制御を行ったりすることもできます。</p>\n<p>ちなみに、なぜ32bitOSの扱うことができるアドレス空間が最大4GiBなのに、仮想アドレス空間は2GiBなのかというと、上位2GiBはカーネルに予約されているためのようです。</p>\n<p>詳しくは以下の図が参考になります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 454px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 97.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxElEQVQ4y42Ui5KaQBBF/f/fSmpTlY1bRkVBUQFBXsLwBhG56Z5diG4eu1S1DjBz5/TtHiZ93+P9laYxyqp4eDbM+9v8+2vCP9driziO4fsRPK+EZcVwnAxBUCMMC3RdN4p9SvB1cgfTDKGqDRZzgdkswnJZ0L1AkohPU05utxstSJBlKXTdgaZVFAXWao7NpsZKCYjUfyD8r2BPgmVZUhSUpsBiIfDy4slgyv0+R12XlPbtU5ST+5swLKXgdEqCU5dSTsnPmjbLpY+czUdeTu5fum5CnpUPKW+3CRFWVLiO4voh5ZsgaPcOp5MgH1siE5jPz9jtOykYhoFcfLlc/qB8Lz4ZBpdLI4uyXCbSv+dnB4qSUfhwvRMJ9Wjb9oHyfYwe8s5dd6WixJLu6emAL191LJUU63UoO4CFhviXf/x80suTkUKIGMYhgLpuKEqoqxJbrYVGfZimiaxy0zQoikIC1FVFAA7yvJBCgxWSMM9zROcQumFBO9K/E8nY2hSmizzL5OSK2uschvJUVSQohJBr67qWm90dPUrlQikLG4duC7PbvUa/g1UZqIpKTmY6FuK+5awMw6A+3eN8Pkt/X1O+8yMofBxh4QSHwn6NxiaySi4Ig0CmyQJMxXQZ0XPwZiPhIGpHR6j5CiuxxDpRaKxgl+ioy3r8QPDF6TGZrus4Ho+wbVtS/+5D9COhQaka7Z5SPtB4D7u20F5a+T6KIknn+75MmQnZLi4SW/HgYSIS7NwdlGSBeTDD1HmGIhbYhCq9SzHMY1ImZCIuDsdQ+VGQT0ld1bBCE1qxxsx7wbf9E1apgm2kwXd9KeS5LjW5N1aWv1IsxuOR8D5lL3OxaVQs45/4cfoOrVbJwy0VI5Q+B1QUl0RZiAXYO37GxA+CkpIOv3kyYcYH7HwdmqPCoLEdWUiTFEMvcEN7b5QsxsHjoSi/ABqT/23sEaz0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ac56/image-20.webp 240w,\n/static/bda5ce08cfe2ad1e3267f7b9bcef994f/44d9f/image-20.webp 454w\"\n              sizes=\"(max-width: 454px) 100vw, 454px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ff5a/image-20.png 240w,\n/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20.png 454w\"\n            sizes=\"(max-width: 454px) 100vw, 454px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20.png\"\n            alt=\"img\"\n            title=\"img\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>参考画像：<a href=\"https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">P.31 xv6OS</a></p>\n<h3 id=\"setupkvm関数\" style=\"position:relative;\"><a href=\"#setupkvm%E9%96%A2%E6%95%B0\" aria-label=\"setupkvm関数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>setupkvm関数</h3>\n<p>とりあえず<code class=\"language-text\">kvmalloc</code>関数の処理を追ってみます。</p>\n<p><code class=\"language-text\">kpgdir = setupkvm();</code>の行では、<code class=\"language-text\">setupkvm</code>関数の戻り値を<code class=\"language-text\">pde_t</code>型の<code class=\"language-text\">kpgdir</code>に格納しています。</p>\n<p>ちなみに、<code class=\"language-text\">pde_t</code>型は<code class=\"language-text\">mmu.h</code>で以下のように定義されており、<code class=\"language-text\">uint</code>型であることがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> uint <span class=\"token class-name\">pte_t</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">setupkvm</code>関数は<code class=\"language-text\">vm.c</code>で以下のように定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Set up kernel part of a page table.</span>\n<span class=\"token class-name\">pde_t</span><span class=\"token operator\">*</span> <span class=\"token function\">setupkvm</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">kmap</span> <span class=\"token operator\">*</span>k<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pgdir <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span>PHYSTOP<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>DEVSPACE<span class=\"token punctuation\">)</span> <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PHYSTOP too high\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> kmap<span class=\"token punctuation\">;</span> k <span class=\"token operator\">&lt;</span> <span class=\"token operator\">&amp;</span>kmap<span class=\"token punctuation\">[</span><span class=\"token function\">NELEM</span><span class=\"token punctuation\">(</span>kmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> k<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>virt<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>phys_end <span class=\"token operator\">-</span> k<span class=\"token operator\">-></span>phys_start<span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">)</span>k<span class=\"token operator\">-></span>phys_start<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>perm<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">freevm</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> pgdir<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>まずは変数宣言の部分です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">kmap</span> <span class=\"token operator\">*</span>k<span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">pde_t</code>は前述の通り<code class=\"language-text\">uint</code>と同義です。</p>\n<p>次の<code class=\"language-text\">kmap</code>構造体は<code class=\"language-text\">vm.c</code>で定義されているカーネルのメモリマッピングテーブルです。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// This table defines the kernel's mappings, which are present in</span>\n<span class=\"token comment\">// every process's page table.</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">kmap</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>virt<span class=\"token punctuation\">;</span>\n  uint phys_start<span class=\"token punctuation\">;</span>\n  uint phys_end<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> perm<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> kmap<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>KERNBASE<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>             EXTMEM<span class=\"token punctuation\">,</span>    PTE_W<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// I/O space</span>\n <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>KERNLINK<span class=\"token punctuation\">,</span> <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>KERNLINK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\">// kern text+rodata</span>\n <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>data<span class=\"token punctuation\">,</span>     <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>     PHYSTOP<span class=\"token punctuation\">,</span>   PTE_W<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// kern data+memory</span>\n <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>DEVSPACE<span class=\"token punctuation\">,</span> DEVSPACE<span class=\"token punctuation\">,</span>      <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>         PTE_W<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// more devices</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>開始・終了アドレスと権限が定義されています。</p>\n<p>初期化されているテーブルのマッピングは、先ほど貼った以下の画像のレイアウトと一致します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 454px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20-16455945916397.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 97.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxElEQVQ4y42Ui5KaQBBF/f/fSmpTlY1bRkVBUQFBXsLwBhG56Z5diG4eu1S1DjBz5/TtHiZ93+P9laYxyqp4eDbM+9v8+2vCP9driziO4fsRPK+EZcVwnAxBUCMMC3RdN4p9SvB1cgfTDKGqDRZzgdkswnJZ0L1AkohPU05utxstSJBlKXTdgaZVFAXWao7NpsZKCYjUfyD8r2BPgmVZUhSUpsBiIfDy4slgyv0+R12XlPbtU5ST+5swLKXgdEqCU5dSTsnPmjbLpY+czUdeTu5fum5CnpUPKW+3CRFWVLiO4voh5ZsgaPcOp5MgH1siE5jPz9jtOykYhoFcfLlc/qB8Lz4ZBpdLI4uyXCbSv+dnB4qSUfhwvRMJ9Wjb9oHyfYwe8s5dd6WixJLu6emAL191LJUU63UoO4CFhviXf/x80suTkUKIGMYhgLpuKEqoqxJbrYVGfZimiaxy0zQoikIC1FVFAA7yvJBCgxWSMM9zROcQumFBO9K/E8nY2hSmizzL5OSK2uschvJUVSQohJBr67qWm90dPUrlQikLG4duC7PbvUa/g1UZqIpKTmY6FuK+5awMw6A+3eN8Pkt/X1O+8yMofBxh4QSHwn6NxiaySi4Ig0CmyQJMxXQZ0XPwZiPhIGpHR6j5CiuxxDpRaKxgl+ioy3r8QPDF6TGZrus4Ho+wbVtS/+5D9COhQaka7Z5SPtB4D7u20F5a+T6KIknn+75MmQnZLi4SW/HgYSIS7NwdlGSBeTDD1HmGIhbYhCq9SzHMY1ImZCIuDsdQ+VGQT0ld1bBCE1qxxsx7wbf9E1apgm2kwXd9KeS5LjW5N1aWv1IsxuOR8D5lL3OxaVQs45/4cfoOrVbJwy0VI5Q+B1QUl0RZiAXYO37GxA+CkpIOv3kyYcYH7HwdmqPCoLEdWUiTFEMvcEN7b5QsxsHjoSi/ABqT/23sEaz0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ac56/image-20-16455945916397.webp 240w,\n/static/bda5ce08cfe2ad1e3267f7b9bcef994f/44d9f/image-20-16455945916397.webp 454w\"\n              sizes=\"(max-width: 454px) 100vw, 454px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/bda5ce08cfe2ad1e3267f7b9bcef994f/8ff5a/image-20-16455945916397.png 240w,\n/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20-16455945916397.png 454w\"\n            sizes=\"(max-width: 454px) 100vw, 454px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/bda5ce08cfe2ad1e3267f7b9bcef994f/b3c1d/image-20-16455945916397.png\"\n            alt=\"img\"\n            title=\"img\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>参考画像：<a href=\"https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">P.31 xv6OS</a></p>\n<h3 id=\"kalloc関数によるページの確保\" style=\"position:relative;\"><a href=\"#kalloc%E9%96%A2%E6%95%B0%E3%81%AB%E3%82%88%E3%82%8B%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%AE%E7%A2%BA%E4%BF%9D\" aria-label=\"kalloc関数によるページの確保 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>kalloc関数によるページの確保</h3>\n<p>ページテーブルの初期化後、使用するメモリ領域の確認と初期化を行っています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pgdir <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span>PHYSTOP<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>DEVSPACE<span class=\"token punctuation\">)</span> <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PHYSTOP too high\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">kalloc</code>関数は<code class=\"language-text\">kalloc.c</code>で定義されている以下の関数です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Allocate one 4096-byte page of physical memory.</span>\n<span class=\"token comment\">// Returns a pointer that the kernel can use.</span>\n<span class=\"token comment\">// Returns 0 if the memory cannot be allocated.</span>\n<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> <span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">run</span> <span class=\"token operator\">*</span>r<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>kmem<span class=\"token punctuation\">.</span>use_lock<span class=\"token punctuation\">)</span> <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>kmem<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  r <span class=\"token operator\">=</span> kmem<span class=\"token punctuation\">.</span>freelist<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span> kmem<span class=\"token punctuation\">.</span>freelist <span class=\"token operator\">=</span> r<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>kmem<span class=\"token punctuation\">.</span>use_lock<span class=\"token punctuation\">)</span> <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>kmem<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>r<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"/unix-xv6-004-kernel-main-01\">前回</a>の記事で確認した通り、この時点ではまだロックは無効化されています。</p>\n<p>そのため<code class=\"language-text\">acquire</code>関数と<code class=\"language-text\">release</code>関数は無視します。</p>\n<p><code class=\"language-text\">kmem.freelist</code>には、解放されているページが短方向連結リストで格納されています。</p>\n<p>つまり、<code class=\"language-text\">kalloc</code>関数は単に解放されている領域の有無を確認して、1ページ分の領域を確保している処理を行っているようです。</p>\n<p>確保に成功した場合<code class=\"language-text\">kalloc</code>関数は確保したページのポインタ(?)を返却し、<code class=\"language-text\">pgdir</code>に格納します。</p>\n<p>これによって、次の行の<code class=\"language-text\">memset(pgdir, 0, PGSIZE);</code>で確保した1ページ分のメモリ領域を0で初期化することができます。</p>\n<p><code class=\"language-text\">memset</code>関数の挙動も<a href=\"/unix-xv6-004-kernel-main-01\">前回</a>の記事で確認したので割愛します。</p>\n<p>最後の行は<code class=\"language-text\">PHYSTOP</code>の値が<code class=\"language-text\">DEVSPACE</code>を超過していないかを検証しているだけなので割愛します。</p>\n<p>最終的に確保された1ページ分の領域<code class=\"language-text\">pgdir</code>が、この後PDTとして使用されます。</p>\n<h3 id=\"仮想アドレスのpteの作成\" style=\"position:relative;\"><a href=\"#%E4%BB%AE%E6%83%B3%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AEpte%E3%81%AE%E4%BD%9C%E6%88%90\" aria-label=\"仮想アドレスのpteの作成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>仮想アドレスのPTEの作成</h3>\n<p>ここまでの処理で<code class=\"language-text\">pgdir</code>には確保した1ページ分のメモリ領域の参照が格納されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> kmap<span class=\"token punctuation\">;</span> k <span class=\"token operator\">&lt;</span> <span class=\"token operator\">&amp;</span>kmap<span class=\"token punctuation\">[</span><span class=\"token function\">NELEM</span><span class=\"token punctuation\">(</span>kmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> k<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>virt<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>phys_end <span class=\"token operator\">-</span> k<span class=\"token operator\">-></span>phys_start<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">)</span>k<span class=\"token operator\">-></span>phys_start<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>perm<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> \n\t<span class=\"token punctuation\">{</span>\n        <span class=\"token function\">freevm</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">return</span> pgdir<span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">NELEM</code>は<code class=\"language-text\">defs.h</code>で定義された以下のマクロで、固定サイズの配列の要素数を返却します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// number of elements in fixed-size array</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">NELEM</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span></code></pre></div>\n<p>つまり、<code class=\"language-text\">k = kmap; k &lt; &amp;kmap[NELEM(kmap)]; k++</code>のループ条件は単にすべての<code class=\"language-text\">kmap</code>配列の要素に対して処理を実行せよという命令と同義です。</p>\n<p>ここで肝になるのが以下の行です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>virt<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>phys_end <span class=\"token operator\">-</span> k<span class=\"token operator\">-></span>phys_start<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">)</span>k<span class=\"token operator\">-></span>phys_start<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>perm<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">freevm</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">mappages</code>関数は、<code class=\"language-text\">vm.c</code>で定義された関数で、 引数として与えられた仮想アドレスのPTE(ページテーブルエントリ)を作成し、同じく引数として与えられた物理アドレスを参照します。</p>\n<p>PTEはページに対応する物理アドレスの値とアクセス制御や属性に関する情報を保持します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cea566737a194af6446f300861a595e8/41099/zu03b.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABtiAP/8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAQABBQJzD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABYQAAMAAAAAAAAAAAAAAAAAAAAQMf/aAAgBAQAGPwJU/8QAGRAAAgMBAAAAAAAAAAAAAAAAAAERMUFx/9oACAEBAAE/IWkvWdD/2gAMAwEAAgADAAAAEIvv/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQMBAT8Qqv/EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/EIj/xAAaEAEAAgMBAAAAAAAAAAAAAAABABExUXGR/9oACAEBAAE/EEWU4wKHtcHtn//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/cea566737a194af6446f300861a595e8/8ac56/zu03b.webp 240w,\n/static/cea566737a194af6446f300861a595e8/d3be9/zu03b.webp 480w,\n/static/cea566737a194af6446f300861a595e8/b0a15/zu03b.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/cea566737a194af6446f300861a595e8/09b79/zu03b.jpg 240w,\n/static/cea566737a194af6446f300861a595e8/7cc5e/zu03b.jpg 480w,\n/static/cea566737a194af6446f300861a595e8/41099/zu03b.jpg 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/cea566737a194af6446f300861a595e8/41099/zu03b.jpg\"\n            alt=\"img\"\n            title=\"img\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>参考画像：<a href=\"https://xtech.nikkei.com/it/article/COLUMN/20071107/286632/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">第6回 メモリー上のデータを見えなくする（前編） | 日経クロステック（xTECH）</a></p>\n<p>参考：<a href=\"http://softwaretechnique.web.fc2.com/OS_Development/kernel_development07.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">０から作るOS開発　ページングその１　ページとPTEとPDE</a></p>\n<p>まずはソースコードを見てみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Create PTEs for virtual addresses starting at va that refer to</span>\n<span class=\"token comment\">// physical addresses starting at pa. va and size might not</span>\n<span class=\"token comment\">// be page-aligned.</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>va<span class=\"token punctuation\">,</span> uint size<span class=\"token punctuation\">,</span> uint pa<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> perm<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>a<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>last<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">pte_t</span> <span class=\"token operator\">*</span>pte<span class=\"token punctuation\">;</span>\n\n  a <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">PGROUNDDOWN</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">)</span>va<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  last <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">PGROUNDDOWN</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">)</span>va<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> size <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pte <span class=\"token operator\">=</span> <span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte <span class=\"token operator\">&amp;</span> PTE_P<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"remap\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">*</span>pte <span class=\"token operator\">=</span> pa <span class=\"token operator\">|</span> perm <span class=\"token operator\">|</span> PTE_P<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>a <span class=\"token operator\">==</span> last<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    a <span class=\"token operator\">+=</span> PGSIZE<span class=\"token punctuation\">;</span>\n    pa <span class=\"token operator\">+=</span> PGSIZE<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">mappages</code>は以下の5つの引数を受け取ります。</p>\n<ul>\n<li>*pgdir：確保したページ(PDT)</li>\n<li>*va：PTEを作成する仮想アドレス</li>\n<li>size：紐づける物理アドレス領域のサイズ</li>\n<li>pa：紐づける物理アドレスの先頭アドレス</li>\n<li>perm：割り当てる権限</li>\n</ul>\n<p>まず、PTEを作成する仮想アドレスと紐づける物理アドレス領域のサイズをもとにしてページサイズでアラインメントされたアドレスが<code class=\"language-text\">a</code>と<code class=\"language-text\">last</code>に格納されます。</p>\n<p>アラインメントに使用する<code class=\"language-text\">PGROUNDDOWN</code>については過去の記事で解説済みのため割愛します。</p>\n<p>次のループはこの<code class=\"language-text\">a</code>が<code class=\"language-text\">last</code>と一致するまでページサイズを加算しつつ実行されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pte <span class=\"token operator\">=</span> <span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte <span class=\"token operator\">&amp;</span> PTE_P<span class=\"token punctuation\">)</span> <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"remap\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token operator\">*</span>pte <span class=\"token operator\">=</span> pa <span class=\"token operator\">|</span> perm <span class=\"token operator\">|</span> PTE_P<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>a <span class=\"token operator\">==</span> last<span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  a <span class=\"token operator\">+=</span> PGSIZE<span class=\"token punctuation\">;</span>\n  pa <span class=\"token operator\">+=</span> PGSIZE<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>実際にPTEの領域を確保しているのは<code class=\"language-text\">walkpgdir</code>関数です。</p>\n<p><code class=\"language-text\">walkpgdir</code>関数は<code class=\"language-text\">vm.c</code>で定義された関数です。</p>\n<p>引数として受け取ったページテーブル<code class=\"language-text\">pgdir</code>のPTEのアドレスを返します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Return the address of the PTE in page table pgdir</span>\n<span class=\"token comment\">// that corresponds to virtual address va.  If alloc!=0,</span>\n<span class=\"token comment\">// create any required page table pages.</span>\n<span class=\"token keyword\">static</span> <span class=\"token class-name\">pte_t</span> <span class=\"token operator\">*</span> \n<span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>va<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> alloc<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pde<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">pte_t</span> <span class=\"token operator\">*</span>pgtab<span class=\"token punctuation\">;</span>\n\n  pde <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>pgdir<span class=\"token punctuation\">[</span><span class=\"token function\">PDX</span><span class=\"token punctuation\">(</span>va<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pde <span class=\"token operator\">&amp;</span> PTE_P<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    pgtab <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">pte_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span><span class=\"token function\">PTE_ADDR</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pde<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>alloc <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>pgtab <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">pte_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Make sure all those PTE_P bits are zero.</span>\n    <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>pgtab<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// The permissions here are overly generous, but they can</span>\n    <span class=\"token comment\">// be further restricted by the permissions in the page table</span>\n    <span class=\"token comment\">// entries, if necessary.</span>\n    <span class=\"token operator\">*</span>pde <span class=\"token operator\">=</span> <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>pgtab<span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> PTE_P <span class=\"token operator\">|</span> PTE_W <span class=\"token operator\">|</span> PTE_U<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>pgtab<span class=\"token punctuation\">[</span><span class=\"token function\">PTX</span><span class=\"token punctuation\">(</span>va<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>まず、<code class=\"language-text\">pde = &amp;pgdir[PDX(va)];</code>の行ではPDTとして確保しているページのうち、PTEを格納するインデックスを解決しています。</p>\n<p><code class=\"language-text\">PDX(va)</code>は<code class=\"language-text\">mmu.h</code>で定義されているマクロで、仮想アドレスから<code class=\"language-text\">page directory index</code>を解決しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// A virtual address 'la' has a three-part structure as follows:</span>\n<span class=\"token comment\">//</span>\n<span class=\"token comment\">// +--------10------+-------10-------+---------12----------+</span>\n<span class=\"token comment\">// | Page Directory |   Page Table   | Offset within Page  |</span>\n<span class=\"token comment\">// |      Index     |      Index     |                     |</span>\n<span class=\"token comment\">// +----------------+----------------+---------------------+</span>\n<span class=\"token comment\">//  \\--- PDX(va) --/ \\--- PTX(va) --/</span>\n\n<span class=\"token comment\">// page directory index</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">PDX</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>va<span class=\"token punctuation\">)</span>         <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>va<span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> PDXSHIFT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x3FF</span><span class=\"token punctuation\">)</span></span></span>\n\n<span class=\"token comment\">// page table index</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">PTX</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>va<span class=\"token punctuation\">)</span>         <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>va<span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> PTXSHIFT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x3FF</span><span class=\"token punctuation\">)</span></span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PTXSHIFT</span>        <span class=\"token expression\"><span class=\"token number\">12</span>      </span><span class=\"token comment\">// offset of PTX in a linear address</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PDXSHIFT</span>        <span class=\"token expression\"><span class=\"token number\">22</span>      </span><span class=\"token comment\">// offset of PDX in a linear address</span></span></code></pre></div>\n<p>続いて、<code class=\"language-text\">if(*pde &amp; PTE_P)</code>の行では、取得したPDEのPresentビットを確認します。</p>\n<p>PDEのPresentビットはページが現在物理メモリにあるのか仮想メモリにあるのかを特定するために使用します。</p>\n<p>参考：<a href=\"https://wiki.osdev.org/Paging\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Paging - OSDev Wiki</a></p>\n<p>ここでは、引数として受け取った仮想アドレスのPDEの有無を検証しているようです。</p>\n<p>初期状態では、<code class=\"language-text\">memset</code>関数によってPDは0に初期化されているため、以下の処理が呼び出されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>alloc <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>pgtab <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">pte_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Make sure all those PTE_P bits are zero.</span>\n<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>pgtab<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// The permissions here are overly generous, but they can</span>\n<span class=\"token comment\">// be further restricted by the permissions in the page table</span>\n<span class=\"token comment\">// entries, if necessary.</span>\n<span class=\"token operator\">*</span>pde <span class=\"token operator\">=</span> <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>pgtab<span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> PTE_P <span class=\"token operator\">|</span> PTE_W <span class=\"token operator\">|</span> PTE_U<span class=\"token punctuation\">;</span></code></pre></div>\n<p>第3引数の<code class=\"language-text\">alloc</code>が1に設定されており、かつ仮想アドレスに対応するPDEが存在しない場合、ここで必要なPTが作成されます。</p>\n<p><code class=\"language-text\">kalloc</code>関数の挙動は先ほども確認したので割愛します。</p>\n<p>ここで取得された1ページ分の領域は<code class=\"language-text\">pgtab</code>として参照されます。</p>\n<p>また、<code class=\"language-text\">memset</code>によってすべてのバイトが0に初期化されます。</p>\n<p>そして、PDEには物理アドレスに変換された<code class=\"language-text\">pgtab</code>のアドレスと、PDEに設定される権限が与えられます。</p>\n<p>最終的に<code class=\"language-text\">walkpgdir</code>関数の戻り値としては、引数で受け取った仮想アドレスに対応するPDEから解決されるPDTの参照となります。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>pgtab<span class=\"token punctuation\">[</span><span class=\"token function\">PTX</span><span class=\"token punctuation\">(</span>va<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>さて、<code class=\"language-text\">walkpgdir</code>関数が終了したので<code class=\"language-text\">mappages</code>関数に戻ります。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pte <span class=\"token operator\">=</span> <span class=\"token function\">walkpgdir</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pte <span class=\"token operator\">&amp;</span> PTE_P<span class=\"token punctuation\">)</span> <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"remap\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token operator\">*</span>pte <span class=\"token operator\">=</span> pa <span class=\"token operator\">|</span> perm <span class=\"token operator\">|</span> PTE_P<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>a <span class=\"token operator\">==</span> last<span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  a <span class=\"token operator\">+=</span> PGSIZE<span class=\"token punctuation\">;</span>\n  pa <span class=\"token operator\">+=</span> PGSIZE<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">pte</code>にはこの仮想アドレスに対応するPTEの領域が確保されました。</p>\n<p><code class=\"language-text\">walkpgdir</code>関数が実行された段階ではまだPTEはすべて0で初期化されたままですので、<code class=\"language-text\">*pte = pa | perm | PTE_P;</code>の行で物理アドレスとパーミッションの割り当てを行っています。</p>\n<p>これで、<code class=\"language-text\">mappages</code>関数によって仮想アドレスと物理アドレスを紐づけるPTEの作成が完了しました。</p>\n<h3 id=\"freevm関数\" style=\"position:relative;\"><a href=\"#freevm%E9%96%A2%E6%95%B0\" aria-label=\"freevm関数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>freevm関数</h3>\n<p>最後に<code class=\"language-text\">setupkvm</code>関数に戻ります。</p>\n<p>以下のループは<code class=\"language-text\">kmap</code>配列の要素の数だけ繰り返されていました。</p>\n<p><code class=\"language-text\">mappages</code>関数によって、仮想アドレスと物理アドレスを紐づけるPDEとPTEが作成されました。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> kmap<span class=\"token punctuation\">;</span> k <span class=\"token operator\">&lt;</span> <span class=\"token operator\">&amp;</span>kmap<span class=\"token punctuation\">[</span><span class=\"token function\">NELEM</span><span class=\"token punctuation\">(</span>kmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> k<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>virt<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>phys_end <span class=\"token operator\">-</span> k<span class=\"token operator\">-></span>phys_start<span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">(</span>uint<span class=\"token punctuation\">)</span>k<span class=\"token operator\">-></span>phys_start<span class=\"token punctuation\">,</span> k<span class=\"token operator\">-></span>perm<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">freevm</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">return</span> pgdir<span class=\"token punctuation\">;</span></code></pre></div>\n<p>もしページテーブルの作成に失敗した場合、<code class=\"language-text\">freevm</code>関数の引数にここまで使用してきたPDTのページ<code class=\"language-text\">pgdir</code>が与えられメモリ領域が解放されます。</p>\n<p><code class=\"language-text\">freevm</code>関数も<code class=\"language-text\">vm.c</code>で定義された関数です。</p>\n<p><code class=\"language-text\">freevm</code>関数この時点では実行されないため、詳細は割愛します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Free a page table and all the physical memory pages</span>\n<span class=\"token comment\">// in the user part.</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">freevm</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pde_t</span> <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  uint i<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>pgdir <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"freevm: no pgdir\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">deallocuvm</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">,</span> KERNBASE<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> NPDENTRIES<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;</span> PTE_P<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span> v <span class=\"token operator\">=</span> <span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span><span class=\"token function\">PTE_ADDR</span><span class=\"token punctuation\">(</span>pgdir<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">kfree</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">kfree</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>pgdir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"switchkvm関数\" style=\"position:relative;\"><a href=\"#switchkvm%E9%96%A2%E6%95%B0\" aria-label=\"switchkvm関数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>switchkvm関数</h2>\n<p>ここまでで<code class=\"language-text\">setupkvm</code>関数の処理は終了し、戻り値としてカーネルのPDTが返却されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Allocate one page table for the machine for the kernel address</span>\n<span class=\"token comment\">// space for scheduler processes.</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">kvmalloc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  kpgdir <span class=\"token operator\">=</span> <span class=\"token function\">setupkvm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">switchkvm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>この記事の前半で確認した通り、カーネルの参照するPDTの先頭アドレスは、x86ではCR3レジスタに格納されます。</p>\n<p><code class=\"language-text\">switchkvm</code>関数の挙動はシンプルで、CR3レジスタに作成したPDTの仮想アドレスを物理アドレスに変換して格納しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Switch h/w page table register to the kernel-only page table,</span>\n<span class=\"token comment\">// for when no process is running.</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">switchkvm</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token function\">lcr3</span><span class=\"token punctuation\">(</span><span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>kpgdir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// switch to the kernel page table</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">lcr3</code>関数は<code class=\"language-text\">x86.h</code>に定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> <span class=\"token keyword\">void</span>\n<span class=\"token function\">lcr3</span><span class=\"token punctuation\">(</span>uint val<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">asm</span> <span class=\"token keyword\">volatile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"movl %0,%%cr3\"</span> <span class=\"token operator\">:</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"r\"</span> <span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>これで<code class=\"language-text\">kvmalloc</code>関数によるカーネルのページテーブルの作成と切り替えが完了しました。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>これでxv6カーネルの<code class=\"language-text\">main</code>関数で呼び出している18個の関数のうち、3つのソースコードを読みました。</p>\n<p>まだまだ先は長いですが少しずつ進めていきます。</p>\n<h2 id=\"参考書籍\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D\" aria-label=\"参考書籍 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考書籍</h2>\n<ul>\n<li><a href=\"https://amzn.to/3qZSCY7\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">30日でできる! OS自作入門</a></li>\n<li><a href=\"https://amzn.to/3qXYsZX\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ゼロからのOS自作入門</a></li>\n<li><a href=\"https://amzn.to/3q8TU3K\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ</a></li>\n<li><a href=\"https://amzn.to/3I6fkVt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">詳解 Linuxカーネル</a></li>\n<li><a href=\"https://amzn.to/3JRUdI2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">作って理解するOS x86系コンピュータを動かす理論と実装</a></li>\n</ul>","fields":{"slug":"/unix-xv6-005-kernel-main-02","tagSlugs":["/tag/unix/","/tag/xv-6/","/tag/kernel/","/tag/os/"]},"frontmatter":{"date":"2022-01-26","description":"教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。","tags":["Unix","xv6","Kernel","OS"],"title":"xv6OSを真面目に読みこんでカーネルを完全に理解する -ページテーブル(PDT/PTD) 編-","socialImage":{"publicURL":"/static/988e06e77b527a3d56e1d03e058a92da/unix-xv6-005-kernel-main-02.png"}}}},"pageContext":{"slug":"/unix-xv6-005-kernel-main-02"}},"staticQueryHashes":["251939775","401334301","825871152"]}