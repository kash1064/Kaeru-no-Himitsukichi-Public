{"componentChunkName":"component---src-templates-post-template-js","path":"/unix-xv6-008-kernel-main-05","result":{"data":{"markdownRemark":{"id":"1459a0d1-f1cb-56e7-ab7e-605055d59ba1","html":"<p><a href=\"https://amzn.to/3q8TU3K\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ</a>にインスパイアされて<a href=\"https://github.com/mit-pdos/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">xv6 OS</a>を読んでます。</p>\n<p>UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした<a href=\"https://github.com/mit-pdos/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">xv6 OS</a>のリポジトリをForkした<a href=\"https://github.com/kash1064/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">kash1064/xv6-public: xv6 OS</a>のソースコードを読んでいくことにしました。</p>\n<p><a href=\"/unix-xv6-007-kernel-main-04\">前回</a>は<code class=\"language-text\">main</code>関数で実行される<code class=\"language-text\">lapicinit</code>関数によるローカルAPICの設定を確認しました。</p>\n<p>今回は<code class=\"language-text\">seginit</code>関数の挙動を追っていきます。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li>\n<p><a href=\"#seginit%E9%96%A2%E6%95%B0\">seginit関数</a></p>\n<ul>\n<li><a href=\"#cpus%E9%96%A2%E6%95%B0\">cpus関数</a></li>\n<li><a href=\"#gdt%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88\">GDTのセット</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n<li><a href=\"#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D\">参考書籍</a></li>\n</ul>\n<h2 id=\"seginit関数\" style=\"position:relative;\"><a href=\"#seginit%E9%96%A2%E6%95%B0\" aria-label=\"seginit関数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>seginit関数</h2>\n<p><code class=\"language-text\">seginit</code>関数はCPUにカーネルセグメントディスクリプタを設定します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">seginit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">// segment descriptors</span></code></pre></div>\n<p><code class=\"language-text\">seginit</code>関数は<code class=\"language-text\">vm.c</code>で以下のように定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Set up CPU's kernel segment descriptors.</span>\n<span class=\"token comment\">// Run once on entry on each CPU.</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">seginit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">cpu</span> <span class=\"token operator\">*</span>c<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Map \"logical\" addresses to virtual addresses using identity map.</span>\n  <span class=\"token comment\">// Cannot share a CODE descriptor for both kernel and user</span>\n  <span class=\"token comment\">// because it would have to have DPL_USR, but the CPU forbids</span>\n  <span class=\"token comment\">// an interrupt from CPL=0 to DPL=3.</span>\n  c <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>cpus<span class=\"token punctuation\">[</span><span class=\"token function\">cpuid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  c<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">[</span>SEG_KCODE<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">SEG</span><span class=\"token punctuation\">(</span>STA_X<span class=\"token operator\">|</span>STA_R<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  c<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">[</span>SEG_KDATA<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">SEG</span><span class=\"token punctuation\">(</span>STA_W<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  c<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">[</span>SEG_UCODE<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">SEG</span><span class=\"token punctuation\">(</span>STA_X<span class=\"token operator\">|</span>STA_R<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">,</span> DPL_USER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  c<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">[</span>SEG_UDATA<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">SEG</span><span class=\"token punctuation\">(</span>STA_W<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">,</span> DPL_USER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">lgdt</span><span class=\"token punctuation\">(</span>c<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>c<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ソースコードを読んでいきます。</p>\n<p>まず、<code class=\"language-text\">cpu</code>構造体は<code class=\"language-text\">proc.h</code>で次のように定義されていました。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Per-CPU state</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">cpu</span> <span class=\"token punctuation\">{</span>\n  uchar apicid<span class=\"token punctuation\">;</span>                <span class=\"token comment\">// Local APIC ID</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">context</span> <span class=\"token operator\">*</span>scheduler<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// swtch() here to enter scheduler</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">taskstate</span> ts<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// Used by x86 to find stack for interrupt</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">segdesc</span> gdt<span class=\"token punctuation\">[</span>NSEGS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// x86 global descriptor table</span>\n  <span class=\"token keyword\">volatile</span> uint started<span class=\"token punctuation\">;</span>       <span class=\"token comment\">// Has the CPU started?</span>\n  <span class=\"token keyword\">int</span> ncli<span class=\"token punctuation\">;</span>                    <span class=\"token comment\">// Depth of pushcli nesting.</span>\n  <span class=\"token keyword\">int</span> intena<span class=\"token punctuation\">;</span>                  <span class=\"token comment\">// Were interrupts enabled before pushcli?</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">proc</span> <span class=\"token operator\">*</span>proc<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// The process running on this cpu or null</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">cpu</code>構造体は、配列<code class=\"language-text\">cpus</code>に格納されています。</p>\n<p>これは、<a href=\"/unix-xv6-006-kernel-main-03\">マルチプロセッサ 編</a>で見た通り<code class=\"language-text\">param.h</code>で定義された<code class=\"language-text\">NCPU</code>に設定されている通り、最大8つのCPUをサポートする配列です。</p>\n<h3 id=\"cpus関数\" style=\"position:relative;\"><a href=\"#cpus%E9%96%A2%E6%95%B0\" aria-label=\"cpus関数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>cpus関数</h3>\n<p>配列<code class=\"language-text\">cpus</code>から<code class=\"language-text\">cpu</code>構造体を取得する箇所を見てみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">cpu</span> <span class=\"token operator\">*</span>c<span class=\"token punctuation\">;</span>\nc <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>cpus<span class=\"token punctuation\">[</span><span class=\"token function\">cpuid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">cpuid</code>関数は<code class=\"language-text\">proc.c</code>で以下のように定義された関数です。</p>\n<p><code class=\"language-text\">mycpu</code>関数の戻り値から<code class=\"language-text\">cpu</code>を引いた値を返します(何やってるんだろう…)。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Must be called with interrupts disabled</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">cpuid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">mycpu</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>cpus<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Must be called with interrupts disabled to avoid the caller being</span>\n<span class=\"token comment\">// rescheduled between reading lapicid and running through the loop.</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">cpu</span><span class=\"token operator\">*</span> <span class=\"token function\">mycpu</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> apicid<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">;</span>\n  \n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">readeflags</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>FL_IF<span class=\"token punctuation\">)</span> <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mycpu called with interrupts enabled\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  apicid <span class=\"token operator\">=</span> <span class=\"token function\">lapicid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// APIC IDs are not guaranteed to be contiguous. Maybe we should have</span>\n  <span class=\"token comment\">// a reverse map, or reserve a register to store &amp;cpus[i].</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> ncpu<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cpus<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>apicid <span class=\"token operator\">==</span> apicid<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>cpus<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unknown apicid\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">mycpu</code>関数の肝は以下のコードです。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">apicid <span class=\"token operator\">=</span> <span class=\"token function\">lapicid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// APIC IDs are not guaranteed to be contiguous. Maybe we should have</span>\n<span class=\"token comment\">// a reverse map, or reserve a register to store &amp;cpus[i].</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> ncpu<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cpus<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>apicid <span class=\"token operator\">==</span> apicid<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>cpus<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">lapicid</code>関数は、<code class=\"language-text\">lapic.c</code>で定義されている、ローカルAPICからAPICIDを取得して24bitの右シフトを行ったものを返却する関数です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">lapicid</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>lapic<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> lapic<span class=\"token punctuation\">[</span>ID<span class=\"token punctuation\">]</span> <span class=\"token operator\">>></span> <span class=\"token number\">24</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>変数<code class=\"language-text\">lapic</code>には、<a href=\"/unix-xv6-006-kernel-main-03\">マルチプロセッサ 編</a>で見た通り<code class=\"language-text\">mp.c</code>でローカルAPICのアドレスが格納されています。</p>\n<p>Intelのマルチプロセッサ仕様書(5-1)によると、ローカルAPICはベースメモリアドレス<code class=\"language-text\">0x0FEE00000</code>に置かれ、ローカルAPICIDは0から始まるハードウェアに連続して割り当てされるようです。</p>\n<p>参考：<a href=\"https://www.manualslib.com/manual/77733/Intel-Multiprocessor.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">INTEL MULTIPROCESSOR SPECIFICATION Pdf Download | ManualsLib</a></p>\n<p>デバッガで確認してみたところ、初回呼び出し時は<code class=\"language-text\">lapic[ID]</code>の値は0でした。</p>\n<p>つまり<code class=\"language-text\">lapicid</code>の戻り値も0になります。</p>\n<p>これによって<code class=\"language-text\">apicid = lapicid();</code>の<code class=\"language-text\">apicid</code>には0が入ります。</p>\n<p>続くループの処理をデバッガで確認したところ、<code class=\"language-text\">cpus[i].apicid</code>の値も0で<code class=\"language-text\">apicid</code>と一致するため、<code class=\"language-text\">&amp;cpus[i]</code>には<code class=\"language-text\">&amp;cpus[0]</code>が返却さえｒました。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> ncpu<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cpus<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>apicid <span class=\"token operator\">==</span> apicid<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>cpus<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>つまり、<code class=\"language-text\">return mycpu()-cpus;</code>も0となり、最初の<code class=\"language-text\">cpuid</code>関数実行時の戻り値は0となることを確認しました。</p>\n<p>これによって、初回起動時の<code class=\"language-text\">c = &amp;cpus[cpuid()];</code>は<code class=\"language-text\">c = &amp;cpus[0];</code>となります。</p>\n<h3 id=\"gdtのセット\" style=\"position:relative;\"><a href=\"#gdt%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88\" aria-label=\"gdtのセット permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GDTのセット</h3>\n<p>というわけで、続く以下の行では、<code class=\"language-text\">&amp;cpus[0]</code>の<code class=\"language-text\">gdt[NSEGS]</code>要素に値をセットしていることがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Map \"logical\" addresses to virtual addresses using identity map.</span>\n<span class=\"token comment\">// Cannot share a CODE descriptor for both kernel and user</span>\n<span class=\"token comment\">// because it would have to have DPL_USR, but the CPU forbids</span>\n<span class=\"token comment\">// an interrupt from CPL=0 to DPL=3.</span>\nc <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>cpus<span class=\"token punctuation\">[</span><span class=\"token function\">cpuid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nc<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">[</span>SEG_KCODE<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">SEG</span><span class=\"token punctuation\">(</span>STA_X<span class=\"token operator\">|</span>STA_R<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nc<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">[</span>SEG_KDATA<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">SEG</span><span class=\"token punctuation\">(</span>STA_W<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nc<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">[</span>SEG_UCODE<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">SEG</span><span class=\"token punctuation\">(</span>STA_X<span class=\"token operator\">|</span>STA_R<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">,</span> DPL_USER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nc<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">[</span>SEG_UDATA<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">SEG</span><span class=\"token punctuation\">(</span>STA_W<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">,</span> DPL_USER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">lgdt</span><span class=\"token punctuation\">(</span>c<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>c<span class=\"token operator\">-></span>gdt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">&amp;cpus[0]</code>は前述した<code class=\"language-text\">cpu</code>構造体であり、<code class=\"language-text\">gdt</code>は以下のように定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">segdesc</span> gdt<span class=\"token punctuation\">[</span>NSEGS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// x86 global descriptor table</span></code></pre></div>\n<p><code class=\"language-text\">segdesc</code>構造体は<code class=\"language-text\">mmu.h</code>で定義されている構造体です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">__ASSEMBLER__</span></span>\n<span class=\"token comment\">// Segment Descriptor</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">segdesc</span> <span class=\"token punctuation\">{</span>\n  uint lim_15_0 <span class=\"token operator\">:</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Low bits of segment limit</span>\n  uint base_15_0 <span class=\"token operator\">:</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Low bits of segment base address</span>\n  uint base_23_16 <span class=\"token operator\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Middle bits of segment base address</span>\n  uint type <span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">// Segment type (see STS_ constants)</span>\n  uint s <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// 0 = system, 1 = application</span>\n  uint dpl <span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// Descriptor Privilege Level</span>\n  uint p <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Present</span>\n  uint lim_19_16 <span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// High bits of segment limit</span>\n  uint avl <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// Unused (available for software use)</span>\n  uint rsv1 <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">// Reserved</span>\n  uint db <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">// 0 = 16-bit segment, 1 = 32-bit segment</span>\n  uint g <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Granularity: limit scaled by 4K when set</span>\n  uint base_31_24 <span class=\"token operator\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// High bits of segment base address</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ちなみに<code class=\"language-text\">NSEGS</code>も、<code class=\"language-text\">mmu.h</code>で定数6として定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// cpu->gdt[NSEGS] holds the above segments.</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">NSEGS</span>     <span class=\"token expression\"><span class=\"token number\">6</span></span></span></code></pre></div>\n<p>ここで定義されている<code class=\"language-text\">segdesc</code>構造体は、セグメントディスクリプタです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/67703d9268cb5e9193a27b143a5996d8/0b533/image-4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.083333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAABpklEQVQoz3VSDW+CUAz0//8u3fyYLktchprFOZ18CAo8EFT01it5inFrUovvtdf27rWKokBVVern81ndflfV7f/t7PH7dDppJFbreDyCluc5DoeDXm63W6xWPwiCDYzJsJHo+b7k7JFJHgtZV5al1NT1NJ4pINHzLIPn+YiiLdI0xYfjYLH4xsSZwhcw1/MQ+IE2S+IY67WreUmS4nK5KCAHUkAe7Pd7PbCd4yRGJk2MMVKUXCej13mH66TWroDkg6vxIMtyGAFig1L+M3Iq5pEW60VRamPePwByZV4SeLMJ1QnCCTg97xiDIIDn1qtzVfLN6S9NQP7Q2IkikJf5/AuuFNIpDrklZ5yqaRyAje44tIAmNXCciRSu0W4/YfgyQrfbx2AwvAIulyvEcYLdblcLJQ2bKt8BUoC162pir9cX8CnCMJLiGFY4UmMjzyz/+G/lMAylq4tO5xmj1zdZfaH88f2VRaliUDw++Kb9uTJjFEUyYYDx+B2z2acIsxNOjSpPYILxGXHCJtAdoD6Psn4CVJWR6lFRrm/5Io9Ul5GgLLZ1Tf8Fhqic9oHnDUAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/67703d9268cb5e9193a27b143a5996d8/8ac56/image-4.webp 240w,\n/static/67703d9268cb5e9193a27b143a5996d8/d3be9/image-4.webp 480w,\n/static/67703d9268cb5e9193a27b143a5996d8/b0a15/image-4.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/67703d9268cb5e9193a27b143a5996d8/8ff5a/image-4.png 240w,\n/static/67703d9268cb5e9193a27b143a5996d8/e85cb/image-4.png 480w,\n/static/67703d9268cb5e9193a27b143a5996d8/0b533/image-4.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/67703d9268cb5e9193a27b143a5996d8/0b533/image-4.png\"\n            alt=\"2022/02/image-4.png\"\n            title=\"2022/02/image-4.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>参考画像：<a href=\"http://flint.cs.yale.edu/cs422/doc/24547212.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Intel SDM vol3</a></p>\n<p>セグメントディスクリプタは、<a href=\"/linux-memory-protect-gdt-ldt\">x86CPUのメモリ保護機構に関するメモ書き(GDTとLDT)</a>で軽く触れたGDTとLDTのエントリとなるデータ構造です。</p>\n<p>セグメントディスクリプタは、CPUにセグメントのサイズやアドレス、またアクセス権限や状態を通知します。</p>\n<p>x86CPUでは、この仕組みによってメモリ保護を実現していました。</p>\n<p><code class=\"language-text\">SEG_KCODE</code>などのセグメントセレクタと、割り当てしている権限についてはブートストラップを参照したときにも確認したので、この記事では割愛します。</p>\n<p>参考：<a href=\"/unix-xv6-001-bootstrap\">xv6OSを真面目に読みこんでカーネルを完全に理解する -ブートストラップ編-</a></p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>カーネル側でセグメントディスクリプタの初期化を行いました。</p>\n<p>次回は<code class=\"language-text\">picinit</code>関数から。。。</p>\n<h2 id=\"参考書籍\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D\" aria-label=\"参考書籍 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考書籍</h2>\n<ul>\n<li><a href=\"https://amzn.to/3qZSCY7\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">30日でできる! OS自作入門</a></li>\n<li><a href=\"https://amzn.to/3qXYsZX\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ゼロからのOS自作入門</a></li>\n<li><a href=\"https://amzn.to/3q8TU3K\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ</a></li>\n<li><a href=\"https://amzn.to/3I6fkVt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">詳解 Linuxカーネル</a></li>\n<li><a href=\"https://amzn.to/3JRUdI2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">作って理解するOS x86系コンピュータを動かす理論と実装</a></li>\n</ul>","fields":{"slug":"/unix-xv6-008-kernel-main-05","tagSlugs":["/tag/unix/","/tag/xv-6/","/tag/kernel/","/tag/os/"]},"frontmatter":{"date":"2022-02-03","description":"教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。","tags":["Unix","xv6","Kernel","OS"],"title":"xv6OSを真面目に読みこんでカーネルを完全に理解する -セグメントディスクリプタ初期化 編-","socialImage":{"publicURL":"/static/0490ada38a265ebd2cfb9e8a556d291d/unix-xv6-008-kernel-main-05.png"}}}},"pageContext":{"slug":"/unix-xv6-008-kernel-main-05"}},"staticQueryHashes":["251939775","401334301","825871152"]}