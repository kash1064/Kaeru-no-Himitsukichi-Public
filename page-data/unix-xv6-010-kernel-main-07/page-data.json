{"componentChunkName":"component---src-templates-post-template-js","path":"/unix-xv6-010-kernel-main-07","result":{"data":{"markdownRemark":{"id":"490a3d36-1a3a-5fe5-98c5-60ca8ca08835","html":"<p><a href=\"https://amzn.to/3q8TU3K\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ</a>にインスパイアされて<a href=\"https://github.com/mit-pdos/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">xv6 OS</a>を読んでます。</p>\n<p>UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした<a href=\"https://github.com/mit-pdos/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">xv6 OS</a>のリポジトリをForkした<a href=\"https://github.com/kash1064/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">kash1064/xv6-public: xv6 OS</a>のソースコードを読んでいくことにしました。</p>\n<p><a href=\"/unix-xv6-009-kernel-main-06\">前回</a>は<code class=\"language-text\">main</code>関数で実行される<code class=\"language-text\">picinit</code>関数と<code class=\"language-text\">ioapicinit</code>関数の動きを確認しました。</p>\n<p>今回は<code class=\"language-text\">consoleinit</code>関数の挙動を追っていきます。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li>\n<p><a href=\"#consoleinit%E9%96%A2%E6%95%B0\">consoleinit関数</a></p>\n<ul>\n<li><a href=\"#devsw%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\">devsw構造体について</a></li>\n<li><a href=\"#inode%E3%81%A8%E3%81%AF\">inodeとは</a></li>\n<li><a href=\"#consolewrite%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80\">consolewrite関数を読む</a></li>\n<li><a href=\"#%E3%83%93%E3%83%87%E3%82%AA%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF\">ビデオメモリの書き込み</a></li>\n<li><a href=\"#consoleread%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80\">consoleread関数を読む</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n<li><a href=\"#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D\">参考書籍</a></li>\n</ul>\n<h2 id=\"consoleinit関数\" style=\"position:relative;\"><a href=\"#consoleinit%E9%96%A2%E6%95%B0\" aria-label=\"consoleinit関数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>consoleinit関数</h2>\n<p><code class=\"language-text\">consoleinit</code>関数は<code class=\"language-text\">console.c</code>で以下のように定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">consoleinit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token function\">initlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>cons<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">,</span> <span class=\"token string\">\"console\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  devsw<span class=\"token punctuation\">[</span>CONSOLE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>write <span class=\"token operator\">=</span> consolewrite<span class=\"token punctuation\">;</span>\n  devsw<span class=\"token punctuation\">[</span>CONSOLE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>read <span class=\"token operator\">=</span> consoleread<span class=\"token punctuation\">;</span>\n  cons<span class=\"token punctuation\">.</span>locking <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">ioapicenable</span><span class=\"token punctuation\">(</span>IRQ_KBD<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>まず1行目の<code class=\"language-text\">initlock(&amp;cons.lock, \"console\");</code>ですが、これは<a href=\"/unix-xv6-004-kernel-main-01\">メモリ割り当て・排他制御 編</a>で確認したメモリロックのために<code class=\"language-text\">spinlock</code>構造体を初期化する関数でした。</p>\n<p>今回使用している<code class=\"language-text\">&amp;cons.lock</code>は、以下のように定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">spinlock</span> lock<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> locking<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> cons<span class=\"token punctuation\">;</span></code></pre></div>\n<p>なお、<code class=\"language-text\">consoleinit</code>関数の中ではメモリロックは行われません。</p>\n<p><code class=\"language-text\">consoleread</code>関数や<code class=\"language-text\">consolewrite</code>関数などが実行される際に、<code class=\"language-text\">cons</code>が使われてメモリロックが行われます。</p>\n<p>続いて、以下の行を見ていきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">devsw<span class=\"token punctuation\">[</span>CONSOLE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>write <span class=\"token operator\">=</span> consolewrite<span class=\"token punctuation\">;</span>\ndevsw<span class=\"token punctuation\">[</span>CONSOLE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>read <span class=\"token operator\">=</span> consoleread<span class=\"token punctuation\">;</span></code></pre></div>\n<p>ここで参照している<code class=\"language-text\">devsw</code>は<code class=\"language-text\">devsw</code>構造体の配列であり、この配列は<code class=\"language-text\">file.c</code>で定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">devsw</span> devsw<span class=\"token punctuation\">[</span>NDEV<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>また、<code class=\"language-text\">devsw</code>構造体の定義は<code class=\"language-text\">file.h</code>で行われています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// table mapping major device number to</span>\n<span class=\"token comment\">// device functions</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">devsw</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>read<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">inode</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>write<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">inode</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">devsw</span> devsw<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONSOLE</span> <span class=\"token expression\"><span class=\"token number\">1</span></span></span></code></pre></div>\n<p>ちなみに<code class=\"language-text\">NDEV</code>は<code class=\"language-text\">param.h</code>で10と定義されていることがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">NDEV</span>         <span class=\"token expression\"><span class=\"token number\">10</span>  </span><span class=\"token comment\">// maximum major device number</span></span></code></pre></div>\n<h3 id=\"devsw構造体について\" style=\"position:relative;\"><a href=\"#devsw%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"devsw構造体について permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>devsw構造体について</h3>\n<p>ここで詳しく知りたいのは、<code class=\"language-text\">devsw</code>構造体が何者かという点です。</p>\n<p>UNIXのマニュアルなどを見ると、<code class=\"language-text\">devsw</code>構造体はデバイスドライバが<code class=\"language-text\">character device interfaces</code>を持つ場合に使用されるもののように見えます。</p>\n<p>参考：<a href=\"https://man.netbsd.org/devsw.9\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">devsw(9) - NetBSD Manual Pages</a></p>\n<p>また、以下のページのように、「システムが一文字ずつデータを転送する機器に対応」した入出力インターフェースが<code class=\"language-text\">character device interfaces</code>に該当すると考えられます。</p>\n<p>参考：<a href=\"https://ja.wikipedia.org/wiki/%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">デバイスファイル - Wikipedia</a></p>\n<p>ここで<code class=\"language-text\">devsw</code>構造体の定義を見ると、<code class=\"language-text\">read</code>と<code class=\"language-text\">write</code>の2種類の関数ポインタが設定されています。</p>\n<p>ここには、<code class=\"language-text\">consoleinit</code>関数のように任意の関数割り当てが行われます。</p>\n<p>引数にはいずれも<code class=\"language-text\">inode</code>構造体が含まれます。</p>\n<p><code class=\"language-text\">inode</code>構造体は、<code class=\"language-text\">devsw</code>構造体と同様に<code class=\"language-text\">file.h</code>で定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// in-memory copy of an inode</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">inode</span> <span class=\"token punctuation\">{</span>\n  uint dev<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// Device number</span>\n  uint inum<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Inode number</span>\n  <span class=\"token keyword\">int</span> ref<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// Reference count</span>\n  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sleeplock</span> lock<span class=\"token punctuation\">;</span> <span class=\"token comment\">// protects everything below here</span>\n  <span class=\"token keyword\">int</span> valid<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// inode has been read from disk?</span>\n\n  <span class=\"token keyword\">short</span> type<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// copy of disk inode</span>\n  <span class=\"token keyword\">short</span> major<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">short</span> minor<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">short</span> nlink<span class=\"token punctuation\">;</span>\n  uint size<span class=\"token punctuation\">;</span>\n  uint addrs<span class=\"token punctuation\">[</span>NDIRECT<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"inodeとは\" style=\"position:relative;\"><a href=\"#inode%E3%81%A8%E3%81%AF\" aria-label=\"inodeとは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>inodeとは</h3>\n<p>そもそも<code class=\"language-text\">inode</code>とは何かについて触れておきます。</p>\n<p><code class=\"language-text\">inode</code>とはざっくり言うとファイル、ディレクトリなどのファイルシステムのオブジェクトに関する情報が格納されている構造体です。</p>\n<p><code class=\"language-text\">inode</code>の持つ情報としては以下のようなものが挙げられます。</p>\n<ul>\n<li>ファイルサイズ(バイト数)</li>\n<li>ファイルを格納しているデバイスのデバイスID</li>\n<li>ファイルの所有者、グループのID</li>\n<li>ファイルシステム内でファイルを識別するinode番号</li>\n<li>タイムスタンプ</li>\n</ul>\n<p>参考：<a href=\"https://ja.wikipedia.org/wiki/Inode\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">inode - Wikipedia</a></p>\n<p>xv6OSの<code class=\"language-text\">inode</code>構造体を見ても上記に近い情報が格納されています。</p>\n<p><code class=\"language-text\">inode</code>は、システム内に一意のIDで管理されます。(xv6OSでは恐らく<code class=\"language-text\">inum</code>が該当する)</p>\n<p>割り当て可能な<code class=\"language-text\">inode</code>番号には通常上限があり、もし<code class=\"language-text\">inode</code>番号が枯渇した場合は、ストレージデバイスのディスク容量に空きがあっても新規にファイルの作成ができなくなります。</p>\n<p>一般的なLinuxシステムの場合は、<code class=\"language-text\">df -i</code>コマンドで各デバイスごとの使用可能な<code class=\"language-text\">inode</code>の上限を確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">df</span> -i\nFilesystem                         Inodes  IUsed   IFree IUse% Mounted on\nudev                              <span class=\"token number\">1007124</span>    <span class=\"token number\">449</span> <span class=\"token number\">1006675</span>    <span class=\"token number\">1</span>% /dev\ntmpfs                             <span class=\"token number\">1019154</span>    <span class=\"token number\">919</span> <span class=\"token number\">1018235</span>    <span class=\"token number\">1</span>% /run\n/dev/mapper/ubuntu--vg-ubuntu--lv <span class=\"token number\">1310720</span> <span class=\"token number\">380878</span>  <span class=\"token number\">929842</span>   <span class=\"token number\">30</span>% /\ntmpfs                             <span class=\"token number\">1019154</span>      <span class=\"token number\">1</span> <span class=\"token number\">1019153</span>    <span class=\"token number\">1</span>% /dev/shm\ntmpfs                             <span class=\"token number\">1019154</span>      <span class=\"token number\">5</span> <span class=\"token number\">1019149</span>    <span class=\"token number\">1</span>% /run/lock\ntmpfs                             <span class=\"token number\">1019154</span>     <span class=\"token number\">18</span> <span class=\"token number\">1019136</span>    <span class=\"token number\">1</span>% /sys/fs/cgroup\n/dev/loop0                             <span class=\"token number\">29</span>     <span class=\"token number\">29</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/bare/5\n/dev/loop2                          <span class=\"token number\">10847</span>  <span class=\"token number\">10847</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/core18/2284\n/dev/loop1                          <span class=\"token number\">10836</span>  <span class=\"token number\">10836</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/core18/2253\n/dev/loop3                          <span class=\"token number\">11776</span>  <span class=\"token number\">11776</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/core20/1270\n/dev/loop5                          <span class=\"token number\">18500</span>  <span class=\"token number\">18500</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/gnome-3-34-1804/72\n/dev/loop4                          <span class=\"token number\">11777</span>  <span class=\"token number\">11777</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/core20/1328\n/dev/loop6                          <span class=\"token number\">18500</span>  <span class=\"token number\">18500</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/gnome-3-34-1804/77\n/dev/loop7                          <span class=\"token number\">65095</span>  <span class=\"token number\">65095</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/gtk-common-themes/1519\n/dev/loop8                            <span class=\"token number\">796</span>    <span class=\"token number\">796</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/lxd/21835\n/dev/loop9                          <span class=\"token number\">64986</span>  <span class=\"token number\">64986</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/gtk-common-themes/1515\n/dev/loop10                           <span class=\"token number\">796</span>    <span class=\"token number\">796</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/lxd/21545\n/dev/loop11                           <span class=\"token number\">479</span>    <span class=\"token number\">479</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/snapd/14295\n/dev/loop12                           <span class=\"token number\">482</span>    <span class=\"token number\">482</span>       <span class=\"token number\">0</span>  <span class=\"token number\">100</span>% /snap/snapd/14549\n/dev/sda2                           <span class=\"token number\">65536</span>    <span class=\"token number\">320</span>   <span class=\"token number\">65216</span>    <span class=\"token number\">1</span>% /boot\ntmpfs                             <span class=\"token number\">1019154</span>     <span class=\"token number\">45</span> <span class=\"token number\">1019109</span>    <span class=\"token number\">1</span>% /run/user/121\ntmpfs                             <span class=\"token number\">1019154</span>     <span class=\"token number\">83</span> <span class=\"token number\">1019071</span>    <span class=\"token number\">1</span>% /run/user/1000</code></pre></div>\n<p>参考：<a href=\"https://kazmax.zpp.jp/linux_beginner/inode.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">iノード（inode）とは</a></p>\n<h3 id=\"consolewrite関数を読む\" style=\"position:relative;\"><a href=\"#consolewrite%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80\" aria-label=\"consolewrite関数を読む permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>consolewrite関数を読む</h3>\n<p>この時点ではまだ<code class=\"language-text\">inode</code>を使ってファイルを作成することはないので、ひとまずxv6OSのコードに戻ります。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">devsw<span class=\"token punctuation\">[</span>CONSOLE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>write <span class=\"token operator\">=</span> consolewrite<span class=\"token punctuation\">;</span>\ndevsw<span class=\"token punctuation\">[</span>CONSOLE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>read <span class=\"token operator\">=</span> consoleread<span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">devsw</code>配列の<code class=\"language-text\">CONSOLE = 1</code>要素の<code class=\"language-text\">write</code>と<code class=\"language-text\">read</code>には、それぞれ<code class=\"language-text\">console.c</code>で定義された関数が割り当てされます。</p>\n<p>まずは<code class=\"language-text\">consolewrite</code>関数を読んでみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">consolewrite</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">inode</span> <span class=\"token operator\">*</span>ip<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>buf<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> n<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">iunlock</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>cons<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> n<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token function\">consputc</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xff</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>cons<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">ilock</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> n<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">consolewrite</code>関数はターゲットとなる<code class=\"language-text\">inode</code>構造体変数のポインタと<code class=\"language-text\">consputc</code>関数に引き渡す文字およびその長さが引数として与えられます。</p>\n<p>まず<code class=\"language-text\">iunlock</code>関数ですが、これは<code class=\"language-text\">fs.c</code>で定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Unlock the given inode.</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">iunlock</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">inode</span> <span class=\"token operator\">*</span>ip<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>ip <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token function\">holdingsleep</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>ip<span class=\"token operator\">-></span>lock<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> ip<span class=\"token operator\">-></span>ref <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"iunlock\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">releasesleep</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>ip<span class=\"token operator\">-></span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>この関数についてはファイルシステムを扱う際に詳しく見ていきますが、受け渡しされた<code class=\"language-text\">inode</code>の持つ‘sleeplock‘構造体を操作してロックを解放しています。</p>\n<p>続いては<code class=\"language-text\">acquire</code>でロックを取得した後、<code class=\"language-text\">consputc</code>関数に受け渡しされた文字列を一文字ずつ流し込んでいます。</p>\n<p>この時、与えられた文字列は<code class=\"language-text\">0xFF</code>とのANDになるので、印字可能な状態が担保されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">consputc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> c<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>panicked<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">cli</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> BACKSPACE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">uartputc</span><span class=\"token punctuation\">(</span><span class=\"token char\">'\\b'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">uartputc</span><span class=\"token punctuation\">(</span><span class=\"token char\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">uartputc</span><span class=\"token punctuation\">(</span><span class=\"token char\">'\\b'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n      <span class=\"token function\">uartputc</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">cgaputc</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ここで、与えられた値を引数として<code class=\"language-text\">uartputc</code>関数が呼び出されます。</p>\n<p><code class=\"language-text\">uartputc</code>関数は<code class=\"language-text\">uart.c</code>で定義された関数で、シリアルポート(UART)への空きこみを行います。</p>\n<p>ここでは、<code class=\"language-text\">COM1(I/Oポート 0x3f8)</code>に受け取った値を書き込んでいます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">uartputc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> c<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>uart<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">128</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token function\">inb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token function\">microdelay</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">COM1+0</code>はデータレジスタになっており、ここに値が書き込まれると送信バッファに書き込みが行われます。</p>\n<p>その前の行の<code class=\"language-text\">inb(COM1+5)</code>はラインステータスレジスタの値の読み取りを行っています。</p>\n<p>ラインステータスレジスタの6番目のbitは<code class=\"language-text\">THRE</code>と呼ばれるレジスタで、このbitが立っているときは送信バッファが空で、新たなデータを送信可能であることを意味します。</p>\n<p>参考：<a href=\"https://wiki.osdev.org/Serial_Ports\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Serial Ports - OSDev Wiki</a></p>\n<p>つまり<code class=\"language-text\">!(inb(COM1+5) &amp; 0x20)</code>の行は、ラインステータスレジスタの<code class=\"language-text\">THRE</code>をチェックして、送信バッファが使用可能でない場合は<code class=\"language-text\">microdelay</code>関数により処理を遅延させる処理を行っているわけです。</p>\n<p>ちなみに、<code class=\"language-text\">BACKSPACE</code>が入力された場合の書き込みが<code class=\"language-text\">uartputc('\\b'); uartputc(' '); uartputc('\\b');</code>になっているのは、カーソルを一つ戻してスペースで上書きした上で、もう一度書き込み前の位置にカーソルを戻しているイメージみたいです。</p>\n<h3 id=\"ビデオメモリの書き込み\" style=\"position:relative;\"><a href=\"#%E3%83%93%E3%83%87%E3%82%AA%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF\" aria-label=\"ビデオメモリの書き込み permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ビデオメモリの書き込み</h3>\n<p>シリアルポートへの書き込みが完了したら、最後に<code class=\"language-text\">cgaputc</code>関数が呼び出されます。</p>\n<p><code class=\"language-text\">cgaputc</code>関数では、入力値をビデオメモリに書き込んで出力します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">cgaputc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> c<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> pos<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Cursor position: col + 80*row.</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  pos <span class=\"token operator\">=</span> <span class=\"token function\">inb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  pos <span class=\"token operator\">|=</span> <span class=\"token function\">inb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> <span class=\"token char\">'\\n'</span><span class=\"token punctuation\">)</span> pos <span class=\"token operator\">+=</span> <span class=\"token number\">80</span> <span class=\"token operator\">-</span> pos<span class=\"token operator\">%</span><span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> BACKSPACE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>pos <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">--</span>pos<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n    crt<span class=\"token punctuation\">[</span>pos<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>c<span class=\"token operator\">&amp;</span><span class=\"token number\">0xff</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x0700</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// black on white</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>pos <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> pos <span class=\"token operator\">></span> <span class=\"token number\">25</span><span class=\"token operator\">*</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span> <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pos under/overflow\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pos<span class=\"token operator\">/</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>  <span class=\"token comment\">// Scroll up.</span>\n    <span class=\"token function\">memmove</span><span class=\"token punctuation\">(</span>crt<span class=\"token punctuation\">,</span> crt<span class=\"token operator\">+</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>crt<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">23</span><span class=\"token operator\">*</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    pos <span class=\"token operator\">-=</span> <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>crt<span class=\"token operator\">+</span>pos<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>crt<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">24</span><span class=\"token operator\">*</span><span class=\"token number\">80</span> <span class=\"token operator\">-</span> pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> pos<span class=\"token operator\">>></span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  crt<span class=\"token punctuation\">[</span>pos<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token char\">' '</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x0700</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ここで使用している書き込み先の<code class=\"language-text\">crt</code>はアドレス<code class=\"language-text\">0xb8000</code>の領域です。</p>\n<p>この領域はフレームバッファと呼ばれる領域です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">//PAGEBREAK: 50</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BACKSPACE</span> <span class=\"token expression\"><span class=\"token number\">0x100</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CRTPORT</span> <span class=\"token expression\"><span class=\"token number\">0x3d4</span></span></span>\n<span class=\"token keyword\">static</span> ushort <span class=\"token operator\">*</span>crt <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ushort<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">P2V</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xb8000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// CGA memory</span></code></pre></div>\n<p>参考：<a href=\"https://e-words.jp/w/%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%83%90%E3%83%83%E3%83%95%E3%82%A1.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">フレームバッファ（frame buffer）とは - IT用語辞典 e-Words</a></p>\n<p>参考：<a href=\"http://www.jamesmolloy.co.uk/tutorial_html/3.-The%20Screen.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">3.-The Screen</a></p>\n<p>まず<code class=\"language-text\">CRTPORT</code>ですが、これは<code class=\"language-text\">CRT Controller</code>のレジスタである<code class=\"language-text\">0x3D4</code>を指しています。</p>\n<p>これは制御用のレジスタで、<code class=\"language-text\">0x3D4</code>に対応するデータレジスタ領域は<code class=\"language-text\">0x3D5</code>となります。</p>\n<p>この2つの領域を利用してコンソール上のカーソル位置をコントロールできます。</p>\n<p><code class=\"language-text\">0x3D4</code>に14をセットすることで、16bitで表現されるカーソルの上位8bitを制御することを指定します。</p>\n<p>そして、15をセットした場合は、カーソルの下位8bitを制御することを指定します。</p>\n<p>つまり、以下の行では変数<code class=\"language-text\">pos</code>に現在のカーソルの16bitを格納しているわけです。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\npos <span class=\"token operator\">=</span> <span class=\"token function\">inb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\npos <span class=\"token operator\">|=</span> <span class=\"token function\">inb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ここで取得したカーソルの上位bitと下位bitの関係は以下のようになります。</p>\n<p>上位8bitがカーソルの行の位置を指し、下位8bitが何文字目かを指しています。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ac478630360bb1e1ebc49d50bbf1a5cd/0b533/image-37.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAAB4ElEQVQ4y52UiW7aQBCGjd1KTQQ4QRBzBFVRpUqN2kp9/xcBQgLGBzZHEoPNYhvzZ2eJjQNJmnalj/UMs/9eMyv5qxBRvEEY7Yg3CbcT0aeQnSeNzUMaAYsghVGMfDMMA67rotfrodvpoN+/gWVZ0HUd+nAI0zTxVluHMST6obbdbjkAY2tEUQQ/CLBYLLBcLuH7PgJuU88YQ8xXkyRbTiKgsa8KHs24ZpmfrVYY2zafYPHxFdLMs/kDJtM5prN7OO40+x47EximDXvsihjyEbP5PT/nzaHgbhUjw8SP6584r1SgaXVcEBcaahz61uoN4U/tarWG9tcr9G8HYvyKhZDYOsq2NRiOoJ6dQ5KkD6Mon9Hp3uwFKQ3SNtRHYmYKlGUFhUJBkBdIfbIsC/vktMgzor8XpHPwPC8TrNa0bGAqUiqVoKoqisXi0Qq/nJyi28utkA444OnwniAJVfi5lsvlvwu+uWXlP7d8dCnq2T9diqx8enkpL9PGwq/ff0RatC7baLYuBY0m71Oefa1WG/VGE1ffvuP2bnAouEtsKrmx48KyHdgc6xnHnYjEJqycP40J+bgssQ8fh1dLipeg5z2K/t04Ejx8vmiCMNxBAfQflR+V3cOjJ2zyi7iM/fP1BEPRt77flC1tAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ac478630360bb1e1ebc49d50bbf1a5cd/8ac56/image-37.webp 240w,\n/static/ac478630360bb1e1ebc49d50bbf1a5cd/d3be9/image-37.webp 480w,\n/static/ac478630360bb1e1ebc49d50bbf1a5cd/b0a15/image-37.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ac478630360bb1e1ebc49d50bbf1a5cd/8ff5a/image-37.png 240w,\n/static/ac478630360bb1e1ebc49d50bbf1a5cd/e85cb/image-37.png 480w,\n/static/ac478630360bb1e1ebc49d50bbf1a5cd/0b533/image-37.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ac478630360bb1e1ebc49d50bbf1a5cd/0b533/image-37.png\"\n            alt=\"2022/02/image-37.png\"\n            title=\"2022/02/image-37.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>以下の行は、改行文字が渡された場合の挙動です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> <span class=\"token char\">'\\n'</span><span class=\"token punctuation\">)</span> pos <span class=\"token operator\">+=</span> <span class=\"token number\">80</span> <span class=\"token operator\">-</span> pos<span class=\"token operator\">%</span><span class=\"token number\">80</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>カーソル位置が次の行の一番左端の位置になるように<code class=\"language-text\">pos</code>を加算しています。</p>\n<p>また、<code class=\"language-text\">BACKSPACE</code>が与えられた場合はカーソル位置を一つ戻します。</p>\n<p>文字入力が与えられた場合は、16bitの文字データを格納します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> BACKSPACE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>pos <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">--</span>pos<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n  crt<span class=\"token punctuation\">[</span>pos<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>c<span class=\"token operator\">&amp;</span><span class=\"token number\">0xff</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x0700</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// black on white</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>この文字データの上位8bitには、背景と文字の色の情報が保持されます。</p>\n<p>また、下位8bitには表示する文字が指定されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 311px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9119764dfbb86dac586e9a998536c1a0/ffa0f/image-35.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABP0lEQVQY012RiWrjQBBE/f9/tRByrCzbClkfso7IOmZG10iWJcvOwstIgRDS8KhqKHp66EVXDaReQaMuhp4iaZBRRZWd516LjjzWVGmLliYj+1l/+sZQJi0izFlkQcnLg013vnDtb4T+O7a1RqSKcbjR1C3u/kgcJeiqoe+uDJeJkf48fPWGoxuwszwW4T7m6fEZa/mX9Xo1s91tefv3xnJp4TibGSEFt9s46+kUERmkEsRJjFKSrr/w+rydBqZUuWa/P7DZOOhaUxuapsWylnieP29flRVTCSHx/QDXPSIySeCHSKm4f/zHeTIDRVSYdSOC9xjPjwij1LyekcmCUyxIzNcnHyfSaIkqaoqymZl8XmpUXpOazNEJWahQYf+xOTgHdvaO1cMKEQg+2jujHr+or996NUf8zWC4m7x0JZ/C87uCiI7abQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/9119764dfbb86dac586e9a998536c1a0/8ac56/image-35.webp 240w,\n/static/9119764dfbb86dac586e9a998536c1a0/c6a73/image-35.webp 311w\"\n              sizes=\"(max-width: 311px) 100vw, 311px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/9119764dfbb86dac586e9a998536c1a0/8ff5a/image-35.png 240w,\n/static/9119764dfbb86dac586e9a998536c1a0/ffa0f/image-35.png 311w\"\n            sizes=\"(max-width: 311px) 100vw, 311px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/9119764dfbb86dac586e9a998536c1a0/ffa0f/image-35.png\"\n            alt=\"2022/02/image-35.png\"\n            title=\"2022/02/image-35.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>参考画像：<a href=\"http://www.jamesmolloy.co.uk/tutorial_html/3.-The%20Screen.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">3.-The Screen</a></p>\n<p>実際にデバッガで確認してみると、この処理によってコンソールに文字が表示されていることを確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/287bd96654e766d4a3f99968fe97efa7/0b533/image-34.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACYklEQVQoz4WTy08TURSHp6R2Wlpo7HTamekLSukLKO20tNPHTB8gJYSSkOhCE1cu1CiPugGi6MYYFz7+AxNXrvRf/Lwd0I0kLr7cc29yf/d37jlHGms1Buomo0STfmyTgbbOMNHC0arY2gZOrEYzVPyLJagHihym8/ya5vj+tMIbR+XtQOGqH0GykyadqIktLvbjJj2lSnNxjWaw6NIKzkRKWAtld20vlDDlAkdLeX68MPl51ubrJMPHHYX32ypSK1XFiln09CYHhSH7OQcrfC3YEiJmKE81tEI1eIOIzXCZw2yOd3sZvj1Z48tRkquRyrtBDMlKV7C0jki3Ri/VpCdSnaXZiazTWCzxYHzEyekxp8cnvJpOXS7Oz7m8OOdMnJ8dP2d6+pKpOL989hipn6pzb6nLji7STtZp3S0yjK3hRFdpR1bJaxk0Q0fTNBLJBOl0mriIo9Eoum64GIJoXCOrK0iT4pD7tTGT8ohJYSCclbD1IqOkEI2UMYIKXtmHX5bxeDxIkvQPnptVCcwh7S53OCgO2Mv2GC93sZUK20aD3eSWqH6NnJoRr6vE1BjzgXlkIez3+11kn4zP5yMgYskzRyx0Rwjm+myJP7SNJs4MIdIVlbZENdvhDSLexVtd3eYwPhPcK4wwDZtOfAs749BPtumKittag77WRPUrN5c8twrNmPNc77UFIbgj0mxH61jCmRUXzSx6sT3rxfC625OqP/Jfh39Q5r1Iw/j1pGynWgx0MTF6haHewIlvupNiRgqsyDo52XBZ9RsseQ2cRIIPkxSfH2X59NDkYr/M691lfgMT9j+/578oxQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/287bd96654e766d4a3f99968fe97efa7/8ac56/image-34.webp 240w,\n/static/287bd96654e766d4a3f99968fe97efa7/d3be9/image-34.webp 480w,\n/static/287bd96654e766d4a3f99968fe97efa7/b0a15/image-34.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/287bd96654e766d4a3f99968fe97efa7/8ff5a/image-34.png 240w,\n/static/287bd96654e766d4a3f99968fe97efa7/e85cb/image-34.png 480w,\n/static/287bd96654e766d4a3f99968fe97efa7/0b533/image-34.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/287bd96654e766d4a3f99968fe97efa7/0b533/image-34.png\"\n            alt=\"2022/02/image-34.png\"\n            title=\"2022/02/image-34.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>次の処理は非常にシンプルで、最大の行数である24行をオーバーした場合に、先頭行を削除してスクロールした上で、末尾の行を空行にしています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pos<span class=\"token operator\">/</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>  <span class=\"token comment\">// Scroll up.</span>\n  <span class=\"token function\">memmove</span><span class=\"token punctuation\">(</span>crt<span class=\"token punctuation\">,</span> crt<span class=\"token operator\">+</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>crt<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">23</span><span class=\"token operator\">*</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  pos <span class=\"token operator\">-=</span> <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>crt<span class=\"token operator\">+</span>pos<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>crt<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">24</span><span class=\"token operator\">*</span><span class=\"token number\">80</span> <span class=\"token operator\">-</span> pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最後の処理は、現在のカーソル位置を<code class=\"language-text\">CRTPORT</code>と<code class=\"language-text\">CRTPORT+1</code>に保存しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> pos<span class=\"token operator\">>></span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>CRTPORT<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncrt<span class=\"token punctuation\">[</span>pos<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token char\">' '</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x0700</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>これで<code class=\"language-text\">consputc</code>関数によるコンソールへの書き込みが完了します。</p>\n<p><code class=\"language-text\">consolewrite</code>関数に戻ったらメモリロックの解除と<code class=\"language-text\">inode</code>のロックを行って終了です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>cons<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">ilock</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"consoleread関数を読む\" style=\"position:relative;\"><a href=\"#consoleread%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80\" aria-label=\"consoleread関数を読む permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>consoleread関数を読む</h3>\n<p>次は<code class=\"language-text\">consoleread</code>関数を読んでいきます。</p>\n<p><code class=\"language-text\">consoleread</code>関数は、<code class=\"language-text\">inode</code>と読み取り先のポインタ、読み取るバッファサイズを引数として受け取ります。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">consoleread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">inode</span> <span class=\"token operator\">*</span>ip<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>dst<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> n<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  uint target<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> c<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">iunlock</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  target <span class=\"token operator\">=</span> n<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>cons<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span>r <span class=\"token operator\">==</span> input<span class=\"token punctuation\">.</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>killed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>cons<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">ilock</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>input<span class=\"token punctuation\">.</span>r<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>cons<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    c <span class=\"token operator\">=</span> input<span class=\"token punctuation\">.</span>buf<span class=\"token punctuation\">[</span>input<span class=\"token punctuation\">.</span>r<span class=\"token operator\">++</span> <span class=\"token operator\">%</span> INPUT_BUF<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> <span class=\"token function\">C</span><span class=\"token punctuation\">(</span><span class=\"token char\">'D'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>  <span class=\"token comment\">// EOF</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">&lt;</span> target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Save ^D for next time, to make sure</span>\n        <span class=\"token comment\">// caller gets a 0-byte result.</span>\n        input<span class=\"token punctuation\">.</span>r<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">*</span>dst<span class=\"token operator\">++</span> <span class=\"token operator\">=</span> c<span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">--</span>n<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> <span class=\"token char\">'\\n'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>cons<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">ilock</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> target <span class=\"token operator\">-</span> n<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">consolwrite</code>関数同様メモリロックと<code class=\"language-text\">inode</code>のロック解除を行った後、指定されたバッファサイズのループ内で以下の処理を行います。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">c <span class=\"token operator\">=</span> input<span class=\"token punctuation\">.</span>buf<span class=\"token punctuation\">[</span>input<span class=\"token punctuation\">.</span>r<span class=\"token operator\">++</span> <span class=\"token operator\">%</span> INPUT_BUF<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> <span class=\"token function\">C</span><span class=\"token punctuation\">(</span><span class=\"token char\">'D'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>  <span class=\"token comment\">// EOF</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">&lt;</span> target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Save ^D for next time, to make sure</span>\n    <span class=\"token comment\">// caller gets a 0-byte result.</span>\n    input<span class=\"token punctuation\">.</span>r<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token operator\">*</span>dst<span class=\"token operator\">++</span> <span class=\"token operator\">=</span> c<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">--</span>n<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> <span class=\"token char\">'\\n'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">input</code>構造体は以下の構造体です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">INPUT_BUF</span> <span class=\"token expression\"><span class=\"token number\">128</span></span></span>\n<span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">char</span> buf<span class=\"token punctuation\">[</span>INPUT_BUF<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  uint r<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Read index</span>\n  uint w<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Write index</span>\n  uint e<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Edit index</span>\n<span class=\"token punctuation\">}</span> input<span class=\"token punctuation\">;</span></code></pre></div>\n<p>この<code class=\"language-text\">input</code>構造体に入ってきた値を1文字ずつ読みだして取得しているようです。</p>\n<p>実際にこの処理が呼び出されるのは、OSの起動が完了してからです。</p>\n<p>具体的には、シェルに入力した文字を取得する際などに使用されます。</p>\n<p>以下の画像は、コンソールに「l」という文字を打ち込んだ際の挙動をデバッガで確認したときのものです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/43ea7f9468b2523fc26c4779efb0ac06/0b533/image-38.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACZklEQVQoz4VTSW/TQBidNnYIzerETtokbaqozeY6e7xNHGfpRkq6QVNa2v4DRCUoJy69IBDiwoUrFyQucOAvIH7X44svwIUensbfjPX0lhm2uVSHk6hBD5VhhMvQZ4hptFa8vb9hRCowI/QdLKMvl/HpSsP3F028m6zjdiDjdpgEG+Zb6M0IFwowggX6uejBCJVo/rPO9hpCHvX5VWhsFWZgGW+3Uvj2TMeXpyv4sBnCGzcMZi830UnZsJUGnGUOLtdhxuukRoUeJaXRDRgEXapibIxwNBzjeDTB6fZDXD/ZwfvrKT7eTPHqag8vz7fBeJYsr3ThpmpwF1twlmoYJKsw4mVYCbKYIKsxUkoWjw4OMD079XB2cY7p+QX2H51i7/AxJkeE4xOwcaGHSWmA3TzHeN1BTyF1MRU8VYWba4AvbhBUGIkSfGwOjLH/Y18d4qS5S6R9HKojDEilFVrHMFnCg1wR/UwZo1wFbqaCbDKNTDYDRVEQCATg9/v/gSiKYKNVG+4Kh5vuoJe1wJUmHMqzSxk6URU2Nc4pPyuuIRVXEJNiCAWD8Pl8HoEoiN4qCIK3x7bWXDQzLiylhXbagZXS4WQ5OlHKUW6gQwVxugVtSYN/Trzb8mbe8YhMuQk9zT3iWUk2Ec/U6rEqTFLZoqZFJtxNOMySogQ1vdTyirCTbXTlKnrUqhEtkdUquqTQlFRE/AtkcR73BMpsXkB8QYASEaGE/UiE7kOimfWlCrrUqiPXKCsNFuVlSxuwo3RV6FWYdDabLcqzHS6gFV5DnR5BTyni62URP29U/HrN8eN5H58vNfwGvBdC44No/BYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/43ea7f9468b2523fc26c4779efb0ac06/8ac56/image-38.webp 240w,\n/static/43ea7f9468b2523fc26c4779efb0ac06/d3be9/image-38.webp 480w,\n/static/43ea7f9468b2523fc26c4779efb0ac06/b0a15/image-38.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/43ea7f9468b2523fc26c4779efb0ac06/8ff5a/image-38.png 240w,\n/static/43ea7f9468b2523fc26c4779efb0ac06/e85cb/image-38.png 480w,\n/static/43ea7f9468b2523fc26c4779efb0ac06/0b533/image-38.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/43ea7f9468b2523fc26c4779efb0ac06/0b533/image-38.png\"\n            alt=\"2022/02/image-38.png\"\n            title=\"2022/02/image-38.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ユーザの入力値がどのように<code class=\"language-text\">input.buf</code>に格納されるかは、実際にシェルが使えるようになってから詳しく追っていこうと思います。</p>\n<p>最後に<code class=\"language-text\">ioapicenable(IRQ_KBD, 0);</code>で割込みを有効化して、<code class=\"language-text\">consoleinit</code>関数は終了します。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回はコンソールの初期化を行いました。</p>\n<p>入出力インターフェースの仕組みについて知ることができたので非常に興味深かったです。</p>\n<p>次回はシリアルポートを初期化する<code class=\"language-text\">uartinit</code>関数から見ていきたいと思います。</p>\n<h2 id=\"参考書籍\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D\" aria-label=\"参考書籍 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考書籍</h2>\n<ul>\n<li><a href=\"https://amzn.to/3qZSCY7\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">30日でできる! OS自作入門</a></li>\n<li><a href=\"https://amzn.to/3qXYsZX\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ゼロからのOS自作入門</a></li>\n<li><a href=\"https://amzn.to/3q8TU3K\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ</a></li>\n<li><a href=\"https://amzn.to/3I6fkVt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">詳解 Linuxカーネル</a></li>\n<li><a href=\"https://amzn.to/3JRUdI2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">作って理解するOS x86系コンピュータを動かす理論と実装</a></li>\n</ul>","fields":{"slug":"/unix-xv6-010-kernel-main-07","tagSlugs":["/tag/unix/","/tag/xv-6/","/tag/kernel/","/tag/os/"]},"frontmatter":{"date":"2022-02-11","description":"教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。","tags":["Unix","xv6","Kernel","OS"],"title":"xv6OSを真面目に読みこんでカーネルを完全に理解する -画面描画 編-","socialImage":{"publicURL":"/static/2bbbff90b6d0181ef10d1cabaa04b22e/unix-xv6-010-kernel-main-07.png"}}}},"pageContext":{"slug":"/unix-xv6-010-kernel-main-07"}},"staticQueryHashes":["251939775","401334301","825871152"]}