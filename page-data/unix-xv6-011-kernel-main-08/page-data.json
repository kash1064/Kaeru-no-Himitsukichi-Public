{"componentChunkName":"component---src-templates-post-template-js","path":"/unix-xv6-011-kernel-main-08","result":{"data":{"markdownRemark":{"id":"646f1311-d3d1-53f5-8f86-c6d54537ec8a","html":"<p><a href=\"https://amzn.to/3q8TU3K\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ</a>にインスパイアされて<a href=\"https://github.com/mit-pdos/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">xv6 OS</a>を読んでます。</p>\n<p>UNIX V6自体はx86CPUでは動作しないため、基本的には、UNIXv6をX86アーキテクチャで動くようにした<a href=\"https://github.com/mit-pdos/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">xv6 OS</a>のリポジトリをForkした<a href=\"https://github.com/kash1064/xv6-public\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">kash1064/xv6-public: xv6 OS</a>のソースコードを読んでいくことにしました。</p>\n<p><a href=\"/unix-xv6-010-kernel-main-07\">前回</a>は<code class=\"language-text\">main</code>関数で実行される<code class=\"language-text\">consoleinit</code>関数の動きを確認しました。</p>\n<p>今回は<code class=\"language-text\">uartinit</code>関数の挙動を追っていきます。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li>\n<p><a href=\"#uartinit%E9%96%A2%E6%95%B0\">uartinit関数</a></p>\n<ul>\n<li><a href=\"#uart%E3%81%A8%E3%81%AF\">UARTとは</a></li>\n<li><a href=\"#%E9%80%9A%E4%BF%A1%E3%81%AB%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B\">通信にシリアルポートを使用する</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n<li><a href=\"#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D\">参考書籍</a></li>\n</ul>\n<h2 id=\"uartinit関数\" style=\"position:relative;\"><a href=\"#uartinit%E9%96%A2%E6%95%B0\" aria-label=\"uartinit関数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>uartinit関数</h2>\n<p><code class=\"language-text\">uartinit</code>関数は<code class=\"language-text\">uart.c</code>関数で定義された関数で、シリアルポート関連の初期化を行っています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">COM1</span>    <span class=\"token expression\"><span class=\"token number\">0x3f8</span></span></span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> uart<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// is there a uart?</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">uartinit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Turn off the FIFO</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 9600 baud, 8 data bits, 1 stop bit, parity off.</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Unlock divisor</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">115200</span><span class=\"token operator\">/</span><span class=\"token number\">9600</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x03</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Lock divisor, 8 data bits.</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x01</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Enable receive interrupts.</span>\n\n  <span class=\"token comment\">// If status is 0xFF, no serial port.</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">inb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  uart <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Acknowledge pre-existing interrupt conditions;</span>\n  <span class=\"token comment\">// enable interrupts.</span>\n  <span class=\"token function\">inb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">inb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">ioapicenable</span><span class=\"token punctuation\">(</span>IRQ_COM1<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Announce that we're here.</span>\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">=</span><span class=\"token string\">\"xv6...\\n\"</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">;</span> p<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token function\">uartputc</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"uartとは\" style=\"position:relative;\"><a href=\"#uart%E3%81%A8%E3%81%AF\" aria-label=\"uartとは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>UARTとは</h3>\n<p>そもそもUARTとは何かですが、<code class=\"language-text\">**Universal Asynchronous Receiver/Transmitter**（汎用非同期送受信機）</code>を指すようです。</p>\n<p>UARTは、2つのデバイス間でシリアルデータを交換するためのプロトコルを指します。</p>\n<p>参考：<a href=\"https://www.rohde-schwarz.com/jp/products/test-and-measurement/oscilloscopes/educational-content/understanding-uart_254524.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">UARTの概要 | Rohde &#x26; Schwarz</a></p>\n<p>参考：<a href=\"https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Universal asynchronous receiver-transmitter - Wikipedia</a></p>\n<p>近年では主として使われていないようですが、UARTはシリアルポートによる通信で使用されていたプロトコルみたいです。</p>\n<p><code class=\"language-text\">uartinit</code>関数では、いわゆるCOMポートをセットアップしているようですね。</p>\n<h3 id=\"通信にシリアルポートを使用する\" style=\"position:relative;\"><a href=\"#%E9%80%9A%E4%BF%A1%E3%81%AB%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B\" aria-label=\"通信にシリアルポートを使用する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>通信にシリアルポートを使用する</h3>\n<p>OSが通信にシリアルポートを使用する場合は、初めにシリアルポートを初期化する必要があります。</p>\n<p>参考：<a href=\"https://wiki.osdev.org/Serial_Ports\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Serial Ports - OSDev Wiki</a></p>\n<p>ソースコードを順に見ていきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">COM1</span>    <span class=\"token expression\"><span class=\"token number\">0x3f8</span></span></span>\n\n<span class=\"token comment\">// Turn off the FIFO</span>\n<span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">COM1</code>は<code class=\"language-text\">0x3f8</code>として定義されています。</p>\n<p>これは、固定されたCOM1ポートのIOポートのアドレスです。</p>\n<p>各COMポートのレジスタについては、IOポートアドレスからのオフセットでアクセスできます。</p>\n<p><code class=\"language-text\">COM1+2</code>は<code class=\"language-text\">Interrupt Identification</code>と<code class=\"language-text\">FIFO control registers</code>を指します。</p>\n<p>ここでは、0をセットすることでUART内のFIFOの動作を無効化しています。</p>\n<p>FIFOが無効化されている場合、受信したデータは<code class=\"language-text\">Receiver buffer register</code>に受け渡されます。</p>\n<p>続いて、以下のコードを見てみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// 9600 baud, 8 data bits, 1 stop bit, parity off.</span>\n<span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Unlock divisor</span>\n<span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">115200</span><span class=\"token operator\">/</span><span class=\"token number\">9600</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x03</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Lock divisor, 8 data bits.</span>\n<span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">outb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x01</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Enable receive interrupts.</span></code></pre></div>\n<p><code class=\"language-text\">COM1+3</code>は<code class=\"language-text\">Line control register</code>に該当します。</p>\n<p>これは、セットされたbitに応じて通信パラメータを変更します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 428px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/47730/image-54.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 102.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD5UlEQVQ4y2VUW2/bZBjO30RCQ0jco0kIiRu4KFRC4gaBEFyAgNttQqDCurVdS8fSdlm7tEua2LFzsJ2D48RnO+c8PO+XjRU10asvtuP3e97n8BW2fj3C3W928OHXO/jgy9/w0Xe7+OynPby/fQ8ff/8Yn/zwCJ/+uIetX57g7rd/4d3P7+HO9gPc+eJtvbd9H+9sPcBXP++gMBwFMBs6vOEQSRSiaZqoVF5Ba9SRJjE0rYa6Voemy3WC6STDJM8wvVGTPMV8PsPZ+SUKozAFsOYXyLMMQza2LAtDz8NiPke366Db66I/6GGxWGK1Wt2q5XIJ+ZTKFRQcd4yESJI0Vc00TUO1ckWEDURRhFq9hur1tUIZhCHiOL5V8r80y3FSKqPgKYTAar1WCF13CMe2MBqPOd4EtmPDJkqH65yIBc3tWrxF2PdCxV/GZr4/VhxWqxWO2VfIDV6bpgGLDSeTKWtyq9I0Qc5npy/IoTuOEBPyZDpVpA/6fYUmCEL+OUen04FpNGDbDjcM4A5dUiPlYTwawfOGfHcGDoiziysUgmSCN5/5bIYxRxXEKTldLBZs2CZqA7quod22YNk2DMNU3Oq6rjj3KGBELs8vayh0ui503hTuItqm2+2qsce+D5/NDYojLwlCIT+OYoV0THqkkeeNFGI/CDYj94Y+hq6LmOPKyLXrqmogiibctdVqoU0buUQtiGecYrGYq98ihqxSYrvnF6/IoR9jvVqqm1EY4LJcRqNhYER+ojBCkw3NZhOtdhtT8ixKy3qzRJg5Pao47HuBcn7Om6KyNBSEYuwRCZeRTaPJe7raRGhIkhR5nitnvKkpkZ9KUryAPlyL21f0YY4GFRVlhYI8S+FYNnq0UH/QR4/8tolY7CMJ2Yy9mU758CV92JWkxJFS1SWXV1fMMRV0+PKIKEXJWq3Ojag0UWq8DknF/9MSEeXrpPhxTj95KikpH4rCfXpRbJBxE9NsEmGPlmmrTDdbwmdL8bbmOzez/KJcZZYHY3ZPyUtCDn2FSJoOiFb8WK/X2XTjuyYbabUaJ9BU9uW9VK2ZoqFYesnTJsqoZsid1qqhwdFsmtdnUlKSr+uGokLEGZDHDjm0HIcnUoeTDBS3DT7r08fnl9dUeRS+Ps/mmyw3TVgURRITcyNRVxo5dkdFUpLT6bTUKnZq8LwUg89mc6pM21T1Np6dXSi4x8USHh8+xd7hPzh69hzHJyXsHhzjydNTHBwXsf93EQ/3j/Bw71Ctf+we4Pc/H/H5CfaPiup/BZFcFMroqzyf0KgzdVCIL/+7VqfMVP3uUbAuRZKISoIs2qpJpJVKldGM8S+pabx/t0/rAgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/8ac56/image-54.webp 240w,\n/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/3b73a/image-54.webp 428w\"\n              sizes=\"(max-width: 428px) 100vw, 428px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/8ff5a/image-54.png 240w,\n/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/47730/image-54.png 428w\"\n            sizes=\"(max-width: 428px) 100vw, 428px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/71dfa1e3f1bdd7ff90d7dd26a33318b1/47730/image-54.png\"\n            alt=\"2022/02/image-54.png\"\n            title=\"2022/02/image-54.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>参考画像：<a href=\"https://www.lammertbies.nl/comm/info/serial-uart\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Serial UART, an in depth tutorial - Lammert Bies</a></p>\n<p><code class=\"language-text\">outb(COM1+3, 0x80);</code>は8bit目をセットして<code class=\"language-text\">DLAB</code>を有効化しています。</p>\n<p>これによって、次の<code class=\"language-text\">COM1+0</code>と<code class=\"language-text\">COM1+1</code>への書き込みアクセスが<code class=\"language-text\">Divisor latch registers (R/W)</code>に変化します。</p>\n<p>ここに<code class=\"language-text\">115200/9600</code>と0をそれぞれ書き込むことでUARTのタイムベースを9,600bpsに設定していることになります。</p>\n<p>続く<code class=\"language-text\">outb(COM1+3, 0x03);</code>では、LRCの<code class=\"language-text\">DLAB</code>を解除するとともに<code class=\"language-text\">8 data bits</code>をセットしています。</p>\n<p>その後、<code class=\"language-text\">Modem control register</code>に0をセットした後、割込みを有効化してます。</p>\n<p>一通りの初期化処理を行った後、<code class=\"language-text\">Line status register</code>のチェックを行ってシリアルポートが利用可能であることを確認しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// If status is 0xFF, no serial port.</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">inb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\nuart <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>最後に、RBRとIIRの情報を参照して現在の割込み状態を確認した後、割込みを有効化して終了です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Acknowledge pre-existing interrupt conditions;</span>\n<span class=\"token comment\">// enable interrupts.</span>\n<span class=\"token function\">inb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">inb</span><span class=\"token punctuation\">(</span>COM1<span class=\"token operator\">+</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">ioapicenable</span><span class=\"token punctuation\">(</span>IRQ_COM1<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回はシリアルポートの初期化処理を追いかけてました。</p>\n<p>次回は<code class=\"language-text\">pinit</code>関数です。</p>\n<h2 id=\"参考書籍\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D\" aria-label=\"参考書籍 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考書籍</h2>\n<ul>\n<li><a href=\"https://amzn.to/3qZSCY7\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">30日でできる! OS自作入門</a></li>\n<li><a href=\"https://amzn.to/3qXYsZX\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ゼロからのOS自作入門</a></li>\n<li><a href=\"https://amzn.to/3q8TU3K\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">はじめてのOSコードリーディング ~UNIX V6で学ぶカーネルのしくみ</a></li>\n<li><a href=\"https://amzn.to/3I6fkVt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">詳解 Linuxカーネル</a></li>\n<li><a href=\"https://amzn.to/3JRUdI2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">作って理解するOS x86系コンピュータを動かす理論と実装</a></li>\n</ul>","fields":{"slug":"/unix-xv6-011-kernel-main-08","tagSlugs":["/tag/unix/","/tag/xv-6/","/tag/kernel/","/tag/os/"]},"frontmatter":{"date":"2022-02-13","description":"教育用OSのxv6OSのソースコードを読んでカーネルについて学んでいきます。この記事ではxv6OSのカーネルのmain関数の挙動を読み解きます。","tags":["Unix","xv6","Kernel","OS"],"title":"xv6OSを真面目に読みこんでカーネルを完全に理解する -シリアルポート 編-","socialImage":{"publicURL":"/static/c61f0e90db47df1f83c37024f2eab7a7/unix-xv6-011-kernel-main-08.png"}}}},"pageContext":{"slug":"/unix-xv6-011-kernel-main-08"}},"staticQueryHashes":["251939775","401334301","825871152"]}