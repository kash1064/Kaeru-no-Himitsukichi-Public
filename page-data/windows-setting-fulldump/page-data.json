{"componentChunkName":"component---src-templates-post-template-js","path":"/windows-setting-fulldump","result":{"data":{"markdownRemark":{"id":"95ea83a5-5627-5fa9-bd9e-73bece70f3f7","html":"<p>なんとなく毎回手動でフルダンプの取得設定を行うのが面倒になったので、設定を自動化できる Power Shell スクリプトを書いてみました。</p>\n<p>基本的な設定値は以下の公式 Blog の内容をベースにしています。</p>\n<p>参考：<a href=\"https://jpwinsup.github.io/blog/2021/02/15/Performance/Hang_BSOD/MemoryDump/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">完全メモリ ダンプの出力設定 | Microsoft Japan Windows Technology Support Blog</a></p>\n<p>スクリプトは以下です。</p>\n<p>また、<a href=\"/file/EnableFulldump.ps1\">EnableFulldump.ps1</a> からもダウンロードできます。</p>\n<p>※ 実行には管理者権限が必要です。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token comment\"># Settings of Full memory dump</span>\n<span class=\"token variable\">$crashControlRegPath</span> = <span class=\"token string\">\"HKLM:System\\CurrentControlSet\\Control\\CrashControl\"</span>\n<span class=\"token variable\">$isExistKey</span> = <span class=\"token function\">Test-Path</span> <span class=\"token operator\">-</span>LiteralPath <span class=\"token variable\">$crashControlRegPath</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$isExistKey</span> <span class=\"token operator\">-eq</span> <span class=\"token boolean\">$False</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">New-Item</span> <span class=\"token operator\">-</span>Path <span class=\"token variable\">$parameterRegPath</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">New-ItemProperty</span> <span class=\"token operator\">-</span>LiteralPath <span class=\"token variable\">$CrashControlRegPath</span> <span class=\"token operator\">-</span>Name <span class=\"token string\">\"CrashDumpEnabled\"</span> <span class=\"token operator\">-</span>PropertyType <span class=\"token string\">\"DWord\"</span> <span class=\"token operator\">-</span>Value <span class=\"token string\">\"1\"</span> <span class=\"token operator\">-</span>Force\n<span class=\"token function\">New-ItemProperty</span> <span class=\"token operator\">-</span>LiteralPath <span class=\"token variable\">$CrashControlRegPath</span> <span class=\"token operator\">-</span>Name <span class=\"token string\">\"AutoReboot\"</span> <span class=\"token operator\">-</span>PropertyType <span class=\"token string\">\"DWord\"</span> <span class=\"token operator\">-</span>Value <span class=\"token string\">\"1\"</span> <span class=\"token operator\">-</span>Force\n<span class=\"token function\">New-ItemProperty</span> <span class=\"token operator\">-</span>LiteralPath <span class=\"token variable\">$CrashControlRegPath</span> <span class=\"token operator\">-</span>Name <span class=\"token string\">\"DumpFile\"</span> <span class=\"token operator\">-</span>PropertyType <span class=\"token string\">\"ExpandString\"</span> <span class=\"token operator\">-</span>Value <span class=\"token string\">\"%SystemRoot%\\FULL_MEMORY.DMP\"</span> <span class=\"token operator\">-</span>Force\n<span class=\"token function\">New-ItemProperty</span> <span class=\"token operator\">-</span>LiteralPath <span class=\"token variable\">$CrashControlRegPath</span> <span class=\"token operator\">-</span>Name <span class=\"token string\">\"LogEvent\"</span> <span class=\"token operator\">-</span>PropertyType <span class=\"token string\">\"DWord\"</span> <span class=\"token operator\">-</span>Value <span class=\"token string\">\"1\"</span> <span class=\"token operator\">-</span>Force\n\n<span class=\"token comment\"># Disable CrashOnCtrlScroll</span>\n<span class=\"token variable\">$parameterRegPaths</span> = @<span class=\"token punctuation\">(</span><span class=\"token string\">\"HKLM:System\\CurrentControlSet\\Services\\i8042prt\\Parameters\"</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t  <span class=\"token string\">\"HKLM:System\\CurrentControlSet\\Services\\kbdhid\\Parameters\"</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t  <span class=\"token string\">\"HKLM:System\\CurrentControlSet\\Services\\hyperkbd\\Parameters\"</span>\n\t\t\t\t\t<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$parameterRegPath</span> in <span class=\"token variable\">$parameterRegPaths</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token variable\">$isExistKey</span> = <span class=\"token function\">Test-Path</span> <span class=\"token operator\">-</span>LiteralPath <span class=\"token variable\">$parameterRegPath</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$isExistKey</span> <span class=\"token operator\">-eq</span> <span class=\"token boolean\">$False</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">New-Item</span> <span class=\"token operator\">-</span>Path <span class=\"token variable\">$parameterRegPath</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token function\">New-ItemProperty</span> <span class=\"token operator\">-</span>LiteralPath <span class=\"token variable\">$parameterRegPath</span> <span class=\"token operator\">-</span>Name <span class=\"token string\">\"CrashOnCtrlScroll\"</span> <span class=\"token operator\">-</span>PropertyType <span class=\"token string\">\"DWord\"</span> <span class=\"token operator\">-</span>Value <span class=\"token string\">\"0\"</span> <span class=\"token operator\">-</span>Force\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># Setting alt dump key</span>\n<span class=\"token variable\">$parameterRegPaths</span> = @<span class=\"token punctuation\">(</span><span class=\"token string\">\"HKLM:System\\CurrentControlSet\\Services\\i8042prt\\crashdump\"</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t  <span class=\"token string\">\"HKLM:System\\CurrentControlSet\\Services\\kbdhid\\crashdump\"</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t  <span class=\"token string\">\"HKLM:System\\CurrentControlSet\\Services\\hyperkbd\\crashdump\"</span>\n\t\t\t\t\t<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$parameterRegPath</span> in <span class=\"token variable\">$parameterRegPaths</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token variable\">$isExistKey</span> = <span class=\"token function\">Test-Path</span> <span class=\"token operator\">-</span>LiteralPath <span class=\"token variable\">$parameterRegPath</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$isExistKey</span> <span class=\"token operator\">-eq</span> <span class=\"token boolean\">$False</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">New-Item</span> <span class=\"token operator\">-</span>Path <span class=\"token variable\">$parameterRegPath</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token function\">New-ItemProperty</span> <span class=\"token operator\">-</span>LiteralPath <span class=\"token variable\">$parameterRegPath</span> <span class=\"token operator\">-</span>Name <span class=\"token string\">\"Dump1Keys\"</span> <span class=\"token operator\">-</span>PropertyType <span class=\"token string\">\"DWord\"</span> <span class=\"token operator\">-</span>Value <span class=\"token string\">\"0x2\"</span> <span class=\"token operator\">-</span>Force\n\t<span class=\"token function\">New-ItemProperty</span> <span class=\"token operator\">-</span>LiteralPath <span class=\"token variable\">$parameterRegPath</span> <span class=\"token operator\">-</span>Name <span class=\"token string\">\"Dump2Key\"</span> <span class=\"token operator\">-</span>PropertyType <span class=\"token string\">\"DWord\"</span> <span class=\"token operator\">-</span>Value <span class=\"token string\">\"0x3d\"</span> <span class=\"token operator\">-</span>Force\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># Change PageFileSize</span>\n<span class=\"token variable\">$totalPhysicalMemSize</span> = $<span class=\"token punctuation\">(</span><span class=\"token namespace\">[Math]</span>::Round<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">Get-WmiObject</span> Win32_OperatingSystem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>TotalVisibleMemorySize <span class=\"token operator\">/</span> 1024<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token variable\">$freeStorageSizeofC</span> = $<span class=\"token punctuation\">(</span><span class=\"token namespace\">[Math]</span>::Round<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">Get-PSDrive</span> C<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Free <span class=\"token operator\">/</span> 1024 <span class=\"token operator\">/</span> 1024<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token variable\">$pageFileSize</span> = <span class=\"token variable\">$totalPhysicalMemSize</span> <span class=\"token operator\">+</span> 400\n<span class=\"token variable\">$pageFileSetting</span> = <span class=\"token string\">\"c:\\pagefile.sys <span class=\"token variable\">$pageFileSize</span> <span class=\"token variable\">$pageFileSize</span>\"</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$freeStorageSizeofC</span> <span class=\"token operator\">-gt</span> <span class=\"token variable\">$pageFileSize</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-eq</span> <span class=\"token boolean\">$True</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">New-ItemProperty</span> <span class=\"token operator\">-</span>LiteralPath <span class=\"token string\">\"HKLM:System\\CurrentControlSet\\Control\\Session Manager\\Memory Management\"</span> <span class=\"token operator\">-</span>Name <span class=\"token string\">\"PagingFiles\"</span> <span class=\"token operator\">-</span>PropertyType <span class=\"token string\">\"MultiString\"</span> <span class=\"token operator\">-</span>Value <span class=\"token variable\">$pageFileSetting</span> <span class=\"token operator\">-</span>Force\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">Write-Warning</span> <span class=\"token string\">\"C drive space is too small.\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>なお、上記のスクリプトでは、フルダンプの取得設定に加えてキーボードクラッシュの設定を行っています。</p>\n<p>僕のメインで使っている ThinkPad のキーボードには CtrlScroll キーがないため、CrashOnCtrlScroll ではなく代替キーを設定しています。</p>\n<p>上記のスクリプトの設定適用後、OS を再起動して [右 CTRL を押しながら Space キー を 2 回] 叩くとキーボードクラッシュが発生し、システムの再起動後に <code class=\"language-text\">C:\\Windows\\FULL_MEMORY.DMP</code> からフルダンプを取得することができます。</p>\n<p>※ キーボードダンプは RDP 接続や Hyper-V の拡張セッション経由では動作しないので、コンソールを使用するか NotMyFault などのツールを利用する必要があります。</p>","fields":{"slug":"/windows-setting-fulldump","tagSlugs":["/tag/win-dbg/","/tag/reversing/"]},"frontmatter":{"date":"2023-07-25","description":"Windows でフルダンプの取得設定とキーボードクラッシュの設定を自動化する Power Shell スクリプトを作成しました。","tags":["WinDbg","Reversing"],"title":"Power Shell スクリプトで Windows のフルメモリダンプの取得設定とキーボードクラッシュの設定を行う","socialImage":{"publicURL":"/static/43e9771c642ee0a3c999884b3f417f55/windows-setting-fulldump.png"}}}},"pageContext":{"slug":"/windows-setting-fulldump"}},"staticQueryHashes":["251939775","401334301","825871152"]}