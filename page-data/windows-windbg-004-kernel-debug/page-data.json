{"componentChunkName":"component---src-templates-post-template-js","path":"/windows-windbg-004-kernel-debug","result":{"data":{"markdownRemark":{"id":"42f497de-9721-5fdf-9e16-82e80029bd4e","html":"<p>WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。</p>\n<p><a href=\"/windows-windbg-002-tutorial\">WinDbgのユーザモードデバッグチュートリアルを試してみた</a>の記事では、公式チュートリアルの内容を参考にWinDbgでユーザモードプロセスのデバッグを行う最初の一歩について紹介しました。</p>\n<p>今回の記事では、WinDbgを用いてカーネル モードデバッグを実施する方法についてまとめます。</p>\n<p>WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。</p>\n<p>参考：<a href=\"/windows-windbg-001-index\">WinDbgを用いたデバッグとトラブルシューティングのテクニック</a></p>\n<p>この記事では以下の内容についてまとめています。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li>\n<p><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89\">カーネルモードデバッグのための環境構築</a></p>\n<ul>\n<li><a href=\"#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83\">今回使用する環境</a></li>\n<li><a href=\"#virtualbox%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4\">VirtualBoxの設定変更</a></li>\n<li><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96\">カーネルモードデバッグの有効化</a></li>\n<li><a href=\"#windbg%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B\">WinDbgの設定をする</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#windbg%E3%81%A7%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86\">WinDbgでカーネルデバッグを行う</a></p>\n<ul>\n<li><a href=\"#windbg%E3%81%8B%E3%82%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B\">WinDbgからカーネルを停止する</a></li>\n<li><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\">カーネルモードデバッグでモジュール一覧を表示する</a></li>\n<li><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\">カーネルモジュールにブレークポイントを設定する</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n<h2 id=\"カーネルモードデバッグのための環境構築\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89\" aria-label=\"カーネルモードデバッグのための環境構築 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カーネルモードデバッグのための環境構築</h2>\n<p>WinDbgを用いてカーネルモードデバッグを行うためには、WinDbgを使用する「ホストコンピュータ」と、デバッグ対象のターゲットコンピュータの2つを用意し、下記のいずれかの方法で接続する必要があります。</p>\n<ul>\n<li>イーサネット</li>\n<li>USB 2.0 / USB 3.0</li>\n<li>シリアル (null モデムとも呼ばれる)</li>\n</ul>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/getting-started-with-windbg--kernel-mode-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">WinDbg の概要 (カーネル モード) - Windows drivers | Microsoft Docs</a></p>\n<p>※ より正確には、すべてのカーネルプロセスにアクセスしてデバッグを行うためには2台のマシンが必要です。\n1台のマシンでローカルカーネルデバッグを実施することもできますが、OSの稼働を止める必要があるような解析は行うことができず、制限が発生します。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/setting-up-local-kernel-debugging-of-a-single-computer-manually\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">単一コンピューターのローカル カーネル デバッグの手動設定 - Windows drivers | Microsoft Docs</a></p>\n<p>なお、通常カーネルモードデバッグを行う際には2台のコンピュータが必要ですが、WinDbgは仮想マシンにインストールしたWindowsに対してもカーネルモードデバッグを行うことができます。</p>\n<p>今回は、VirtualBox上に構築したWindowsマシンに対してカーネルモードデバッグを仕掛けていきます。</p>\n<h3 id=\"今回使用する環境\" style=\"position:relative;\"><a href=\"#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E7%92%B0%E5%A2%83\" aria-label=\"今回使用する環境 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>今回使用する環境</h3>\n<ul>\n<li>\n<p>ホストマシン</p>\n<ul>\n<li>Windows10 Pro 20H2</li>\n<li>WinDbg 10.0.22000.1 AMD64 (管理者権限で起動)</li>\n<li>VirtualBox 6.1.26</li>\n</ul>\n</li>\n<li>\n<p>ターゲットマシン</p>\n<ul>\n<li>Windows 10 Pro 1511 (VirtualBox上に構築)</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"virtualboxの設定変更\" style=\"position:relative;\"><a href=\"#virtualbox%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%A4%89%E6%9B%B4\" aria-label=\"virtualboxの設定変更 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>VirtualBoxの設定変更</h3>\n<p>今回は、VirtualBox側ですでにWindowsの仮想マシンが構築されていることを前提とします。</p>\n<p>カーネルモードデバッグを行うために、VirtualBoxの仮想マシン側でCOMポートの設定を行います。</p>\n<ol>\n<li>ホストマシンのVirtualBoxマネージャで、デバッグ対象の仮想マシンの設定を開きます。</li>\n<li>次に[シリアルポート]の設定項目を開き、[ポート1]を有効化します。</li>\n<li>ここで、以下の設定をそれぞれ実施します。</li>\n<li>ポート番号：COM1</li>\n<li>ポートモード：ホストにパイプ</li>\n<li>パス/アドレス：<code class=\"language-text\">\\\\.\\pipe\\com1</code></li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/57d56d521ef808486eb1a1b8a20d0c26/0b533/image-11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.08333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACy0lEQVQ4y51SSU9TURR+LYXwP9SdY+JCE40sXJCIA7pQXGhYoGjqT1ASTdy4UnCjlAroAtQERGVUpLRWOtFJChShAx1e2/c6Pdq+1+Hz3guoG2PiSb57bs4757vfOedxbosZGVFEio8jnUogIyQRj/HEJ5ATk0jySWSFFLmnIKYECCSeThPwMfRrWzB0aS/eXNmPp62H8OjcYXAOlwclpYw/bTUSQFbKQlYqEBKkWBSQyeUglxTEhBAychLVCjBw+wL0Lftwr/kozp84jtaTx8ANfjRhanED3o04QmkF0VwF4c04fL5lhEIhokYkSEMUtn04HEY0EkVgYx3d15rxsGkP7p4+AO2pg7jZdATc9Z7PuKhfx5kXUZwdlnB5KAm3P4jNcAiBQBAiGQdFNptFJpNhnoKSB3xe/HDbEfDYwK99x/jjLnCv3r7HrG0JU2YXpglmzE7MLxFl+QJrn+d5RCIR5EjLW1tbkCQJpVKJoVytQqnWfo1sbLAX3PiHMfi8LrgcVrgX7XATb/NvIpWVUKtUkM9LiMVi8Pv9jJyqKxaLJJ5HsVBAheTIcokRDuoI4cjIKNweD6w2O+wOB2w2GzxknlJRZkmKojBVwWCQzNVHtiwwUhovl8uoEpVlcqc2qn8Obnj4NZxOJxYWFmCxWGG1WDDnWsPy2gaSZMMFooYW05YpkSzLrF2qjBLSb3JpW+E7/TNwExMT7PWVlRXWln91Fd5ADAmy1QKZmSwr+JdVCTm1l306cG1tV6HV3kFn5y10dNxAe3s7Jr+5kSuUGKGy006tVvsrKjuEOl0fOGL0gKa+ESqVht1npmdYwu426Zxo0W9UWWwXu4/29hKFKrUGaoq6etQ3NDJCo8mE/7H+/gFSr1KTo44wa6BSNzDCJ909sFqtmJ39gjmDAYb5eRgMFEbmjUYjW+Ai+TM+zZkxNmnAV5MZD7ru4yfPlHJ8skb53QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/57d56d521ef808486eb1a1b8a20d0c26/8ac56/image-11.webp 240w,\n/static/57d56d521ef808486eb1a1b8a20d0c26/d3be9/image-11.webp 480w,\n/static/57d56d521ef808486eb1a1b8a20d0c26/b0a15/image-11.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/57d56d521ef808486eb1a1b8a20d0c26/8ff5a/image-11.png 240w,\n/static/57d56d521ef808486eb1a1b8a20d0c26/e85cb/image-11.png 480w,\n/static/57d56d521ef808486eb1a1b8a20d0c26/0b533/image-11.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/57d56d521ef808486eb1a1b8a20d0c26/0b533/image-11.png\"\n            alt=\"image-11.png\"\n            title=\"image-11.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これでVirtualBox側の設定は完了したので、仮想マシンを起動します。</p>\n<h3 id=\"カーネルモードデバッグの有効化\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96\" aria-label=\"カーネルモードデバッグの有効化 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カーネルモードデバッグの有効化</h3>\n<p>仮想マシンが起動したら、コマンドラインを管理者権限で起動して、以下のコマンドを入力します。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">bcdedit <span class=\"token operator\">/</span>debug on\nbcdedit <span class=\"token operator\">/</span>dbgsettings serial debugport:1 baudrate:115200</code></pre></div>\n<p>もしくは、<code class=\"language-text\">Msconfig.exe</code>を起動して、詳細オプションからCOM1ポートを指定してデバッグを有効化します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 666px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7be9c75f374117e7a6f4bb8a457bd035/ace37/image-9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAADQ0lEQVQ4y41Tz4tbVRi9dKBQKwi1RYrLakFtUReCq67tyo11VcFFFyIUayuFKpTROgstUysMUloVBRcuWov/hB3QOp02Y5LJZCbJe3k/7n0/8/J+JJPk+H33JTPtrg8O3+U+7vnOOd+94q/lf7DeaKBaX0e700Gr/Tja2Go9HTYZm1sQjXoNgzQGRgXS2EcvkIh9F/3IQ9YLMBmmwHb2VBjkGcTfNRN310b4ozLE3UcFbq/muLOa4feVFH8+SvHb/Qw3lzPcWi5riXSK2b8UN5ZzbLgphGm7yMZAnE+QDKBh+BlqLQeVZhcd1YcVD9ENB7AixhBOb0TYhs37tMd1vRvB9SMI13FQfsSKiYYfRvClA9fuQrkWWUkxyPooCGkSQU73kzjUe8O8jzAMID0fwpkSTiaTshK6rkKlUsHqw4f4d2UF/1WrsCwbURRDKYUODc80u5BSaXieB0d6cBURGoaBZrOJytoaGjRtwzTRMiyaWBONjQ0isuC6LnzfJ8JII45jDV4HQaArE3oBWbZtGz53IKVZliHPc5i2RLvVQovAB5Mk2SGLwpDs7WLWwFUeAnIgpJQoigKKap8O8qeoE6timN2ubsaHHieYKeS9eKrQD4mQM+GPLfV6CcbjMSRNq9ncQK1eR5Xya9MFnylkAWWGJlxal5ZD2JQ7D3OHkDt5RMqVLW9RhtVaTR/knLkyIat+8GBF524YJjr0j8VYdP12pswT5vzKDAu4XkidfT0QVsRN/GmzmVKdIaljhaVlBeWHZYbj0RCDIsf2oNCV82DliobFVyKgw1LbC3fIdokj9ChP03K0C/HuB2dx6sxneI/w/kef4+Tpc1j69Q4iUrg1nbRDNp8kCqcor03aT1Cpb+LUuasQ4pmXIfYRnn0F4sCbEHuO4MPzCxht05NyXK1SqvICK+VpSAblJadrJrx3vwJx5B2IuUPHMXfoGOZeeAN7X3wLYv9RXPjqevlqKIrySe5iMhnD8HowZAAvKciJh34cYK3WwHNHT5DCA6zsVYjnX8Oeg8eJ8CW8ffI0vln6BZe/vYH5xZuEW5i/9hO+/O5nXF78EZ9e+QGfzH+PiwtLuHTlGr5YuI6PL36NvYdfx/+wGK4WmV5fYAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7be9c75f374117e7a6f4bb8a457bd035/8ac56/image-9.webp 240w,\n/static/7be9c75f374117e7a6f4bb8a457bd035/d3be9/image-9.webp 480w,\n/static/7be9c75f374117e7a6f4bb8a457bd035/be082/image-9.webp 666w\"\n              sizes=\"(max-width: 666px) 100vw, 666px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7be9c75f374117e7a6f4bb8a457bd035/8ff5a/image-9.png 240w,\n/static/7be9c75f374117e7a6f4bb8a457bd035/e85cb/image-9.png 480w,\n/static/7be9c75f374117e7a6f4bb8a457bd035/ace37/image-9.png 666w\"\n            sizes=\"(max-width: 666px) 100vw, 666px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7be9c75f374117e7a6f4bb8a457bd035/ace37/image-9.png\"\n            alt=\"image-9.png\"\n            title=\"image-9.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>上記の設定が完了したら、ホストマシン側でWinDbgの設定を行います。</p>\n<h3 id=\"windbgの設定をする\" style=\"position:relative;\"><a href=\"#windbg%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B\" aria-label=\"windbgの設定をする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbgの設定をする</h3>\n<p>ホストマシン側で、WinDbgを管理者権限で起動します。</p>\n<p>カーネルモードデバッグの場合は、WinDbgも管理者権限で起動しておく必要があります。\nもしユーザモードで起動している場合は、<code class=\"language-text\">Kernel debugger failed initialization, Win32 error 5 アクセス拒否されました</code>というエラーとともにカーネルモードデバッグに失敗します。</p>\n<p>WinDbgを管理者権限で起動したら、[File]>[Kernel Debug]を選択し、以下の画像のように名前付きパイプを利用してターゲットマシンに接続させます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4ee28ac0fb172f16033a6266f6071c7a/0b533/image-13.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAABdElEQVQoz52S6W6CUBCFef83UVGoCiSKaRMTdsGoD9AfdWmtstcKwilzE4220dpO8mVm7oWTWS4XRRG2YQw/SuDHKT7zDPs8R14cUJQFvltZlrhlnGObsG0bhq6foNx1XTiOA02v7gyniscwTReeO4FVxbY3hWVZGI1GmM1mmE6nzHOWaUDTdEwmk9MFQbnneRiPx5BkCbVaDTzPo9lsotHgUeeb7Kxer7OzI1wSx1iv14iiEGEYIkkS7HY77Pd7RlEUrBJBEKAoCiRJOiHL8kVOcPP5C5bLJXzfx2q1wmazQRAESNMUh8OBzUWvxtBqtdgPnU7nJtxiMQcthiphC9pufyzAMIwLwW63exXWclC1SoJUGQlSTGL/EjyvpjyPK0j4X4LHWV2zPwtmWYbX4APPqwBvQYrN+5q1T1unuWqadr8gbXA4HELuP0GQVSjqI/q9HlRVxWAwYJ4+bLfbzP8qKIoie5Ci0MKDKDBPb+6ce8WIL0AtNRYExCc0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4ee28ac0fb172f16033a6266f6071c7a/8ac56/image-13.webp 240w,\n/static/4ee28ac0fb172f16033a6266f6071c7a/d3be9/image-13.webp 480w,\n/static/4ee28ac0fb172f16033a6266f6071c7a/b0a15/image-13.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4ee28ac0fb172f16033a6266f6071c7a/8ff5a/image-13.png 240w,\n/static/4ee28ac0fb172f16033a6266f6071c7a/e85cb/image-13.png 480w,\n/static/4ee28ac0fb172f16033a6266f6071c7a/0b533/image-13.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4ee28ac0fb172f16033a6266f6071c7a/0b533/image-13.png\"\n            alt=\"image-13.png\"\n            title=\"image-13.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ここまで完了したところで[OK]をクリックすると、カーネルデバッグ用のCommandウィンドウが起動し、COMポートへの接続を待機し始めます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">Waiting <span class=\"token keyword\">for</span> pipe \\\\<span class=\"token punctuation\">.</span>\\pipe\\com1\nWaiting to reconnect<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>最後に、ターゲット側のWindowsマシンを再起動します。</p>\n<p>すると、以下の画面のようにWinDbgがターゲットマシンに接続され、ターゲットマシンがテストモードで起動しました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5909177960178f54921d390b555c8b13/0b533/image-10.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAACu0lEQVQoz42SW0hUURSG95zxFpGWUJGYqaljVuIY5KUUK5HQxocsU0tLyKCyvBX2JkFUL0EUlpcMnehCWeB1gnzo8tBbotltAoNgTHMyndFRnNGvfQ5ZEBEd+FiHtc/511p7/cJmG8JuH2VkZISxsTFGR0dxOh1Mu1zMzMzgknF6elrDpeL6zZQ8m52dpa+vj9bWVtrb2xEDAwMMDg4yPDwshZzaj+pHHo+Hubk5/uf5MmTj+bOnGsJqtWKz2TTsdjsOh4PJyUkp5uGr/RuNzXclt7lSb+Zqwy3qm+9R13yfOvND6loeUC+pbbrD5est1Da0INxut1Zlfn7+V0XPz87631rxj9iGX1gyIjAWsSQGEbABsSwOsSJJ5uIR/jLnvw7hF0mIMQOhjrcguMDCqAMfPrE8oRARnIISth0lfAfK2gwUwy6UjXkomw6jk+ijdiFWbcGQuu/fgm+sn1iVXY6IMqFbvwdhPIiSdBxl53l0+c3oj7TjXd2LV00/IusiUZllfxdUF6IJvrMSmyaFDNkI2ZGIL8Y7tRLfvCaU6n70tRME3HOy++U8sTUWQjNOIP61yfcfB4lMMiFWp6IzmDRBr21n8M5tRKnqRVEFH01R3DtH8tlOQtKPIVTvjY+PMzExoW1XxeFw4nbP8qrvNeuTMxFBiejC0hExOYgk2UXWJUTRfZTyF/hc+Exg43d8DpmJzJTX09XVRWdnJ2q0WCwa3d3d9PQ84cbNFowpJpSV8ShBm1FCUtCvTUcfnY3eWIR+ayVKxjl0ibJIuImo7UWIjo4OFlCdrsa2tjYeP7ZQe62B6Lg0aYk1CN8QxKIw+R4hbSKts9SIWCzt4iPzvsEI71AMCXIatbs/UUXVTs3mWxwrLaO88jRlFVWUnixn/8ESCkuOkltQRG7eAbJz8snMOYBpbwEVlaf4AZpplz8gK+T/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/5909177960178f54921d390b555c8b13/8ac56/image-10.webp 240w,\n/static/5909177960178f54921d390b555c8b13/d3be9/image-10.webp 480w,\n/static/5909177960178f54921d390b555c8b13/b0a15/image-10.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/5909177960178f54921d390b555c8b13/8ff5a/image-10.png 240w,\n/static/5909177960178f54921d390b555c8b13/e85cb/image-10.png 480w,\n/static/5909177960178f54921d390b555c8b13/0b533/image-10.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/5909177960178f54921d390b555c8b13/0b533/image-10.png\"\n            alt=\"image-10.png\"\n            title=\"image-10.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これで、WinDbgでWindowsのカーネルデバッグを実施する準備が完了しました。</p>\n<h2 id=\"windbgでカーネルデバッグを行う\" style=\"position:relative;\"><a href=\"#windbg%E3%81%A7%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86\" aria-label=\"windbgでカーネルデバッグを行う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbgでカーネルデバッグを行う</h2>\n<p>WinDbgがCOMポート経由でターゲットマシンに接続したことで、カーネルデバッグの準備が整いました。</p>\n<p>しかし、現在はターゲットマシンのWindowsOSが稼働しているため、WinDbgのCommandウィンドウによる操作を行うことができません。</p>\n<p>WinDbgでカーネルデバッグを進めるためには、一度Windowsカーネルを停止する必要があります。</p>\n<h3 id=\"windbgからカーネルを停止する\" style=\"position:relative;\"><a href=\"#windbg%E3%81%8B%E3%82%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B\" aria-label=\"windbgからカーネルを停止する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbgからカーネルを停止する</h3>\n<p>カーネルデバッグのためにWindowsカーネルを停止するには、WinDbg上部のツールバーから[Break]ボタンをクリックするか、[Ctrl+Break]キーを押して下さい。</p>\n<p>または、WinDbg上部の[Debug]メニューから[Break]を選択することでも停止が可能です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 426px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ff4901184468bdbffd12fe366e0a50f0/531e1/image-14.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 104.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAADqElEQVQ4y21Ua2/bRhDk///aD0WBfmiRAm1ToCkSoCiQBq2jxKlsvSzqQVLi+yG+RZGSLBu1prsrU3GNCFgcJN3Nzc7MnnI9mcJ3XRR5jjzLkMQxqpLWyMcqCpEXObIsQUr/lesCfuAjDCKkaYokSZDTubIs4HkB0jiCkpU1mrrBel1ht22QrBtcGTH6ZgY/ShCFITabCvEqpnWD/X6Pptni9vZW6nA44O7uDrvdHneHWygfO29x1b3EoN9H76qL3nCMkRmjp/lIskIY13RhnuWoqg3u7+/PYAzO63a7pUtqujyB8u13X+OHn37Gy1/f4MWPv+D3P97isGsQBx61FkpLMYGmaSZrkqTY1DU2VUUXVMK6KAppu9cfEuDrPr562cE3v3Xx/Z8a3nxaCBPf86DrBtQbFVN1gvlsDnWsEouI2DQCxOuJ3Rb31O5obkN51+lC1UyM50tMdBuWF6GmjWyUsVjAdVzR0fd9BH5wBquJJZsYx4kw507CKIbSvephaeiYTSewLZPEj8igNbnmYj6fkcPZqTVizWwYrAVcRREWxpLOTuXCjJxXOpddjEYjmKaFsapiNpsJgMsMqeUpxUodj+HYroC0gFx8AV/o2DbiJJYYKRcdcnjQh2EYAmxZFira7Di2gFumCV3TiMnizKwt/r4uSzLkVAyuvP9wifH4RgxYLpfUqvfYskdgFra73WeAR2dbd9flGjbt0XSdWDrStnJBgLquwSRmzEgjNrw5DANhx9Hh7y3I02KD0jQRvaNoReasoPx10UGvd40pCTscDglcl43c+oQ0ZW2F4bN225Z5TUk/y7KRsCnvP3zCiIBGoxsENKfMkseQTWHt/OBzVJ7XlkbVcz25PCTHRcO/Ox/Ru74WHQaDAQV4hl1dSSQ8Al2tVrQx/yIgPxCsNbfMYJ5HGtquj+PDg4zPngwoNw0GLgE+BlYCTTrWTwLdasph5nNcbBBfoExmGvjDr4VB5rzr/INX6gYm5c4k1zku5tIUBlmeyVoU5f+0ZElESwY0HQ8PD//KD8zGJj0Ou1r05GyyRgzIITdpkjRNl9Z4f/UkRlyi4WRuEL+jpL59jiqJTUjhdk7RIT0beQSaM5vnevJvfEZZWo60fDweH1vfnUdPoxfGorEqKeithl/K43m2yUClN7yhw460x5PCK7OI6U+bsuXT087mcLVhfp7HlnFEnSgLYsiTElDemDKD8mFD5xdoJprxA8Hv4cnx076nxUD8H0v0HysIC+BNy+NRAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ff4901184468bdbffd12fe366e0a50f0/8ac56/image-14.webp 240w,\n/static/ff4901184468bdbffd12fe366e0a50f0/dca0e/image-14.webp 426w\"\n              sizes=\"(max-width: 426px) 100vw, 426px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ff4901184468bdbffd12fe366e0a50f0/8ff5a/image-14.png 240w,\n/static/ff4901184468bdbffd12fe366e0a50f0/531e1/image-14.png 426w\"\n            sizes=\"(max-width: 426px) 100vw, 426px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ff4901184468bdbffd12fe366e0a50f0/531e1/image-14.png\"\n            alt=\"image-14.png\"\n            title=\"image-14.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>すると、次のような出力の後にCommandウィンドウから操作が可能になります。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">Connected to Windows 10 10586 x64 target at <span class=\"token punctuation\">(</span>Mon Oct  4 17:32:25<span class=\"token punctuation\">.</span>121 2021 <span class=\"token punctuation\">(</span>UTC <span class=\"token operator\">+</span> 9:00<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ptr64 TRUE\nKernel Debugger connection established<span class=\"token punctuation\">.</span>\nSymbol search path is: srv*\nExecutable search path is: \nWindows 10 Kernel Version 10586 <span class=\"token function\">MP</span> <span class=\"token punctuation\">(</span>1 procs<span class=\"token punctuation\">)</span> Free x64\nEdition build lab: 10586<span class=\"token punctuation\">.</span>162<span class=\"token punctuation\">.</span>amd64fre<span class=\"token punctuation\">.</span>th2_release_sec<span class=\"token punctuation\">.</span>160223-1728\nMachine Name:\nKernel base = 0xfffff803`5280b000 PsLoadedModuleList = 0xfffff803`52ae9cd0\nSystem Uptime: 0 days 0:00:00<span class=\"token punctuation\">.</span>121\nKDTARGET: Refreshing KD connection\n<span class=\"token keyword\">Break</span> instruction exception <span class=\"token operator\">-</span> code 80000003 <span class=\"token punctuation\">(</span>first chance<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>                                                                             <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>   You are seeing this message because you pressed either                    <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>       CTRL+C <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> you run console kernel debugger<span class=\"token punctuation\">)</span> or<span class=\"token punctuation\">,</span>                       <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>       CTRL+<span class=\"token keyword\">BREAK</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> you run GUI kernel debugger<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>                          <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>   on your debugger machine's keyboard<span class=\"token punctuation\">.</span>                                      <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>                                                                             <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>                   THIS IS NOT A BUG OR A SYSTEM CRASH                       <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>                                                                             <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span> <span class=\"token keyword\">If</span> you did not intend to <span class=\"token keyword\">break</span> into the debugger<span class=\"token punctuation\">,</span> press the <span class=\"token string\">\"g\"</span> key<span class=\"token punctuation\">,</span> then   <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span> press the <span class=\"token string\">\"Enter\"</span> key now<span class=\"token punctuation\">.</span>  This message might immediately reappear<span class=\"token punctuation\">.</span>  <span class=\"token keyword\">If</span> it <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span> does<span class=\"token punctuation\">,</span> press <span class=\"token string\">\"g\"</span> and <span class=\"token string\">\"Enter\"</span> again<span class=\"token punctuation\">.</span>                                          <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>                                                                             <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>\nnt!DbgBreakPointWithStatus:\nfffff803`52952eb0 cc              int     3</code></pre></div>\n<h3 id=\"カーネルモードデバッグでモジュール一覧を表示する\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E4%B8%80%E8%A6%A7%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\" aria-label=\"カーネルモードデバッグでモジュール一覧を表示する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カーネルモードデバッグでモジュール一覧を表示する</h3>\n<p>カーネルモードデバッグの場合でも、Commandウィンドウから行う基本的な操作は、<a href=\"/windows-windbg-002-tutorial\">こちらの記事</a>で紹介したユーザモードデバッグとほぼ同一です。</p>\n<p>試しに、<code class=\"language-text\">lm</code>コマンドを実行して読み込まれているモジュールの一覧を出力してみました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1d792de8449ddeac48b488e2dd683b09/1134b/image-12.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9ElEQVQ4y62TaXObQAyG+f9/qtNPPdIG2OVawuX6xE7ABgzG11tpfYzTZuqmU808s9ICL9JKa1jSw8Oj1AhXwRQBvpkubCeEG2ZwgggqzhASKrohvoHi4CmF8kMYHz6Z+PhF4LOlYKsB5NOQGEGEQ5hBBksz0M8c2j89/x0nGuHhqw0jjkIMshT5bIri5RnVaol+02G37YHjAdou6x0rVxUMpRSyLEOapphOp8jzHIvFAquqQtu2OBxOYsfjkXzi+Abnd/LFM4zRaKTFkiShNUNCflEU2O126LoOm83mKvgn2OYs+EJlclaTyYTWGRbzuRZsmkYL9n2Pv7WqWcNI4hjD4RBlWaIol3QONeq6RkUlM5zhfr/XGf/Kdru9wnHTdjCiKEJM5WZJhGS6QjavdZNYhM+GM+QPeGX4B5eY/QscVzVlaNs2PM+HFBa8wQuS2Qqh72J/OOC9tm43MBxHIggUfFfC/1HAH9c0qIkum7O814zbppwFHRIM4JFgNC4QTip4KsJ6vdYlv0+QzlDKU4aeIxCOl0jzGpHy8S/Wdj0MIQSdoQdXCrjxBDKZ0Z30aHTKV92+B1+Cckk3paGPeN544wKXy7zydXzmvHcLd1qPDf6zGUI6cFwP8g2u+w75NFqeH2jYt2yJR9M+YdmwhcR3U+AnWWa+Jd832uIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/1d792de8449ddeac48b488e2dd683b09/8ac56/image-12.webp 240w,\n/static/1d792de8449ddeac48b488e2dd683b09/d3be9/image-12.webp 480w,\n/static/1d792de8449ddeac48b488e2dd683b09/e46b2/image-12.webp 960w,\n/static/1d792de8449ddeac48b488e2dd683b09/f992d/image-12.webp 1440w,\n/static/1d792de8449ddeac48b488e2dd683b09/bb6b4/image-12.webp 1470w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/1d792de8449ddeac48b488e2dd683b09/8ff5a/image-12.png 240w,\n/static/1d792de8449ddeac48b488e2dd683b09/e85cb/image-12.png 480w,\n/static/1d792de8449ddeac48b488e2dd683b09/d9199/image-12.png 960w,\n/static/1d792de8449ddeac48b488e2dd683b09/07a9c/image-12.png 1440w,\n/static/1d792de8449ddeac48b488e2dd683b09/1134b/image-12.png 1470w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/1d792de8449ddeac48b488e2dd683b09/d9199/image-12.png\"\n            alt=\"image-12.png\"\n            title=\"image-12.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>続いて、<code class=\"language-text\">x nt!MmCreate*</code>を実行して、ntモジュールのいくつかのシンボル一覧を取得します。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">kd> x nt!MmCreate*\nfffff803`52bd46ac nt!MmCreateTeb <span class=\"token punctuation\">(</span>MmCreateTeb<span class=\"token punctuation\">)</span>\nfffff803`52c5733c nt!MmCreatePeb <span class=\"token punctuation\">(</span>MmCreatePeb<span class=\"token punctuation\">)</span>\nfffff803`528ecfb8 nt!MmCreateMdl <span class=\"token punctuation\">(</span>MmCreateMdl<span class=\"token punctuation\">)</span>\nfffff803`528a5fc8 nt!MmCreateSystemSection <span class=\"token punctuation\">(</span>MmCreateSystemSection<span class=\"token punctuation\">)</span>\nfffff803`52c08c40 nt!MmCreateSection <span class=\"token punctuation\">(</span>MmCreateSection<span class=\"token punctuation\">)</span>\nfffff803`52c4a2fc nt!MmCreateProcessAddressSpace <span class=\"token punctuation\">(</span>MmCreateProcessAddressSpace<span class=\"token punctuation\">)</span>\nfffff803`52c08d30 nt!MmCreateCacheManagerSection <span class=\"token punctuation\">(</span>MmCreateCacheManagerSection<span class=\"token punctuation\">)</span>\nfffff803`52c88c8c nt!MmCreateSpecialImageSection <span class=\"token punctuation\">(</span>MmCreateSpecialImageSection<span class=\"token punctuation\">)</span>\nfffff803`5281cda0 nt!MmCreateKernelStack <span class=\"token punctuation\">(</span>MmCreateKernelStack<span class=\"token punctuation\">)</span>\nfffff803`52e2e838 nt!MmCreateMirror <span class=\"token punctuation\">(</span>MmCreateMirror<span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"カーネルモジュールにブレークポイントを設定する\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AB%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"カーネルモジュールにブレークポイントを設定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カーネルモジュールにブレークポイントを設定する</h3>\n<p>次に、<code class=\"language-text\">bu nt!MmCreateProcessAddressSpace</code>を実行し、ブレークポイントを設定します。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">kd> bu nt!MmCreateProcessAddressSpace\nkd> bl\n     0 e Disable Clear  fffff803`52c4a2fc     0001 <span class=\"token punctuation\">(</span>0001<span class=\"token punctuation\">)</span> nt!MmCreateProcessAddressSpace</code></pre></div>\n<p>ここで<code class=\"language-text\">g</code>コマンドを実行してWindowsカーネルの実行を再開すると、新しいプロセスが起動するごとに設定したブレークポイント設定により、その都度カーネルが停止し、WinDbgによるデバッグモードに移行します。</p>\n<p>例えば、今回はターゲットマシン環境でMicrosoft Edgeアプリケーションを起動してみました。\nすると、新たなプロセス起動時の処理で<code class=\"language-text\">nt!MmCreateProcessAddressSpace</code>が呼び出されたため、カーネルが停止し、WinDbgでのデバッグが可能になります。</p>\n<p>ここから、WinDbgによりWindowsカーネルの処理をステップ実行したり、スタックトレースを参照したり、レジストリの情報を書き換えたり、といった操作が可能になります。</p>\n<p>以下の画像は、Microsoft Edgeの起動中の状態までステップ実行し、スタックトレースを出力した状態の画像です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4971cbcbb8730b99f99fd16584f1a897/0b533/image-15.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAADCElEQVQ4y32Sa2hTZxjHX9aKOrygHQ76XfwgXkA7cIidNa013ot2Tu2F2mlTp9YLVRHRwawtVhG8tV5WrZPJsurWffLzGCKbdDPNSZpLkxMTk5MmNuklvfe395z4QVF84M/7f98DP57/cx7xT0cHXS4vnUoXTpcHxeHGLuWQb/rd7fV9UF3y26uwhqW6BiGmMnX6XDIyP0U8ffY3iqsbh7sbj+8lXjVIIKQR0uJoscQb9b7l0wpHXzMwNMp3h2olcCYzZmUzTUKF0+kgEFB5FQoRjWr0RKOMDA8xPj7Gx2pyctI4Dx87JYEZiE/myHM6Qg0ECIfD+P1+VFUlHImQSqUYGh5mdHRUaozhN35iYuI98C/W39lVso/KfQcpr6hCKIpCMBgkIkHxeJxEIkFvby+vpfS6fd+KubiSbeXV5Jq/oWBrGWuLKigotlCwfS/rd1SxZdd+Nu+0sLnkAKLb5yfZn6K/v5+RkREZddzoJpUaMoAn65sRs5ZiqmrAcvUJpfVtlDY8pqzxD8outFPS0MbuOqt8e8TsxRsRHS/sRDWNZF+fAdPj6TU2no539k47YsEGltX+xiZrisK7EQrvRTG3apjvR1jXmtaGn+N8bj6B+NfmQPX7jPnpkfX4uk8kkwbw+yt3JdDMoiNtrG0JknfdxZomD6uuu/nqhtvwefLMv+Una2s94j+bQigURJNdDg4OGlBdAwODBrDu4jUysnMk8FfZWVgC3OTe8LL/UZCvf1INb2r2UnBH5bONZxHPnr/A3mnDZrMZnTmdTlwulzFTvX641ISYt4RFNQ/fAVZaX7Kt1S+7fAu45TzCrjiJxWLyL8sd7ImRlFH1TvXV0etc4xWmzFvI4kMPjFnpwPybXgmVUWVc3ZuaPWmgWe6kpkU/usCXr7WQOWc+86taMN3rMbrLbfKx+qbK6ltq+mz2s+bHEFm5FsRffz7FYe+iU87S3ulAkV6/697r8XH6TB05X+axfk8tRUcayf/2DPnVdawsPc4XxYdZvr2GnOKjrNh9ghxTEf8DP8EcKp4eO4EAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4971cbcbb8730b99f99fd16584f1a897/8ac56/image-15.webp 240w,\n/static/4971cbcbb8730b99f99fd16584f1a897/d3be9/image-15.webp 480w,\n/static/4971cbcbb8730b99f99fd16584f1a897/b0a15/image-15.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4971cbcbb8730b99f99fd16584f1a897/8ff5a/image-15.png 240w,\n/static/4971cbcbb8730b99f99fd16584f1a897/e85cb/image-15.png 480w,\n/static/4971cbcbb8730b99f99fd16584f1a897/0b533/image-15.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4971cbcbb8730b99f99fd16584f1a897/0b533/image-15.png\"\n            alt=\"image-15.png\"\n            title=\"image-15.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回は、WinDbgを用いたカーネルデバッグの設定方法と、簡単な操作について紹介しました。</p>\n<p>実際にカーネルデバッグを用いてトラブルシューティングを行うテクニックについては、また違う記事でまとめていく予定です。</p>\n<p>WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。</p>\n<p>参考：<a href=\"/windows-windbg-001-index\">WinDbgを用いたデバッグとトラブルシューティングのテクニック</a></p>","fields":{"slug":"/windows-windbg-004-kernel-debug","tagSlugs":["/tag/win-dbg/","/tag/kernel/","/tag/reversing/"]},"frontmatter":{"date":"2021-10-06","description":"","tags":["WinDbg","Kernel","Reversing"],"title":"WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩","socialImage":{"publicURL":"/static/e155911f0b081dbeea1b753c64f1bb79/windows-windbg-004-kernel-debug.png"}}}},"pageContext":{"slug":"/windows-windbg-004-kernel-debug"}},"staticQueryHashes":["251939775","401334301","825871152"]}