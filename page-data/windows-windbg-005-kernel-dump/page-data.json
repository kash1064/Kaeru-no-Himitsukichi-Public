{"componentChunkName":"component---src-templates-post-template-js","path":"/windows-windbg-005-kernel-dump","result":{"data":{"markdownRemark":{"id":"069163c9-74a5-5871-8f66-431fd4d06e43","html":"<p>WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。</p>\n<p><a href=\"/windows-windbg-004-kernel-debug\">WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩</a>の記事では、WinDbgでカーネルモードデバッグを行う最初の一歩について紹介しました。</p>\n<p>今回は、ライブデバッグではなく、カーネルメモリダンプの解析方法について紹介します。</p>\n<p>WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。</p>\n<p>参考：<a href=\"/windows-windbg-001-index\">WinDbgを用いたデバッグとトラブルシューティングのテクニック</a></p>\n<p>この記事では以下の内容についてまとめています。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li>\n<p><a href=\"#%E4%BB%8A%E5%9B%9E%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%83%84%E3%83%BC%E3%83%AB\">今回利用するツール</a></p>\n<ul>\n<li><a href=\"#windbg-preview\">WinDbg Preview</a></li>\n<li><a href=\"#notmyfault\">NotMyFault</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\">カーネルメモリダンプを取得する</a></p>\n<ul>\n<li><a href=\"#power-shell-%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%A7%E3%81%BE%E3%81%A8%E3%82%81%E3%81%A6%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B2023-%E5%B9%B4-7-%E6%9C%88-%E8%BF%BD%E8%A8%98\">Power Shell スクリプトでまとめて設定する(2023 年 7 月 追記)</a></li>\n<li><a href=\"#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%83%91%E3%83%8D%E3%83%AB%E3%81%8B%E3%82%89%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B\">コントロールパネルから設定を変更する</a></li>\n<li><a href=\"#notmyfault%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\">NotMyFaultを取得する</a></li>\n<li><a href=\"#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\">メモリダンプを取得する</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%81%AE%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86\">カーネルメモリダンプの解析を行う</a></p>\n<ul>\n<li><a href=\"#windbg%E3%81%AB%E3%83%80%E3%83%B3%E3%83%97%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80\">WinDbgにダンプファイルを読み込む</a></li>\n<li><a href=\"#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AE%E5%87%BA%E5%8A%9B%E3%82%92%E8%AA%AD%E3%82%80\">メモリダンプ読み込み時の出力を読む</a></li>\n<li><a href=\"#analyze--v-%E3%81%A7%E8%87%AA%E5%8B%95%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86\">!analyze -v で自動解析を行う</a></li>\n<li><a href=\"#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%90%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A7%A3%E6%9E%90\">スタックバックトレースの解析</a></li>\n<li><a href=\"#%E3%83%88%E3%83%A9%E3%83%83%E3%83%97%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%81%8B%E3%82%89%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%92%E5%BE%A9%E5%85%83%E3%81%99%E3%82%8B\">トラップフレームからスレッドを復元する</a></li>\n<li><a href=\"#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\">プロセスを確認する</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n<h2 id=\"今回利用するツール\" style=\"position:relative;\"><a href=\"#%E4%BB%8A%E5%9B%9E%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%83%84%E3%83%BC%E3%83%AB\" aria-label=\"今回利用するツール permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>今回利用するツール</h2>\n<p>今回は、Windows10環境にて、次の2つのツールを使用します。</p>\n<ul>\n<li>WinDbg Preview</li>\n<li>notmyfault64</li>\n</ul>\n<h3 id=\"windbg-preview\" style=\"position:relative;\"><a href=\"#windbg-preview\" aria-label=\"windbg preview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbg Preview</h3>\n<p>WinDbg Previewは、Microsoft Storeから入手可能なUWP版のWinDbgです。</p>\n<p>Windows Debug Toolsの中に含まれている従来のWinDbgと比較して、UIがかなりモダンになっていたり、タイムトラベルデバッグ（TTD）に対応していたりと機能強化されています。</p>\n<p>なお、従来のWinDbgとは同じエンジンを使用しているらしく、すべての機能が引き続き利用できます。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/debugging-using-windbg-preview\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">WinDbg プレビューを使用したデバッグ - Windows drivers | Microsoft Docs</a></p>\n<h3 id=\"notmyfault\" style=\"position:relative;\"><a href=\"#notmyfault\" aria-label=\"notmyfault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NotMyFault</h3>\n<p>NotMyFaultは、本来コンピュータがクラッシュしたときに生成されるメモリダンプを手動で取得するために用いるツールです。</p>\n<p>以下のドキュメント内のリンクから取得できます。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows/client-management/generate-kernel-or-complete-crash-dump\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">カーネル ダンプまたは完全なクラッシュ ダンプを生成する - Windows Client Management | Microsoft Docs</a></p>\n<h2 id=\"カーネルメモリダンプを取得する\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\" aria-label=\"カーネルメモリダンプを取得する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カーネルメモリダンプを取得する</h2>\n<p>解析のため、まずはカーネルメモリダンプを取得していきます。</p>\n<h3 id=\"power-shell-スクリプトでまとめて設定する2023-年-7-月-追記\" style=\"position:relative;\"><a href=\"#power-shell-%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%A7%E3%81%BE%E3%81%A8%E3%82%81%E3%81%A6%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B2023-%E5%B9%B4-7-%E6%9C%88-%E8%BF%BD%E8%A8%98\" aria-label=\"power shell スクリプトでまとめて設定する2023 年 7 月 追記 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Power Shell スクリプトでまとめて設定する(2023 年 7 月 追記)</h3>\n<p>以下の記事にてカーネルメモリダンプの取得設定を Power Shell スクリプトからまとめて設定する方法をまとめました。</p>\n<p>参考：<a href=\"/windows-setting-fulldump\">Power Shell スクリプトで Windows のフルメモリダンプの取得設定とキーボードクラッシュの設定を行う</a></p>\n<h3 id=\"コントロールパネルから設定を変更する\" style=\"position:relative;\"><a href=\"#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%83%91%E3%83%8D%E3%83%AB%E3%81%8B%E3%82%89%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B\" aria-label=\"コントロールパネルから設定を変更する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>コントロールパネルから設定を変更する</h3>\n<p>メモリダンプを取得する端末でコントロールパネルを開き、[システムとセキュリティ]を開きます。</p>\n<p>次に[システムの詳細設定]をクリックして、[システムのプロパティ]ウィンドウを開きます。</p>\n<p>まずは、[パフォーマンス]セクションの設定から仮想メモリのページングサイズを物理メモリのサイズより 300 MB 以上大きい値に変更します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 850px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0be04a73a5284ec54ca5c110d4a54a5d/ae694/image-20230409203416047.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 85.83333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAADX0lEQVQ4y3VTW4hNURjeRYkSI3dCefEgUh7EFKmRJIxC5N6giXjwgAfEkEQyXoQ8SaO8KLcoRaYZZjDjzJxzzJiac9/3sy/n7HOdsz//v05HB1n1t9Zee/3f+r7/+5ekyEmk0xYcx0EmkxGRzWZpLw3XdZHP55HPeSiUge6nZ9De0oD9Wxdg29pZaFw2FetXNqB51Uw0N83B7sPzIMlyAqaZpjChaRpSqRQMw0AykYSiqlApXNeBD+Dt47NoOzQdrTsXYM8GAlzRgMblU9C8Zhp2Nc7Avr0LIZmmDlVRYds2PM9DjtgwM2bJrAuFAuBXwOPNk3O4eHA29mxZiCWLG7Bx1XTs2zgTO1bPwMnm+Wg5QIDptCFk5nI5EcViUQAzIAeD65oqGD5/cAqXdozHpnWTsWiuhMal47B5+XjsXz0Bh5smYvvWSZB0XcPY2JgAKpVKKJfL4rs6VwRzLoOT8fDh2X08utmCa5dbcePKUZw4fgjnTx/BzfPHcP0CxdUWSKlUQiQoiiLqaJqGmNkMZsisGVyWU6LGhSJdVK7QXoXmMkpEJOvlaS7Rtw9JVWXouo5UMikSLMsSwczqWbM5fYEgur8G8LlvEF1fvqM/9BP9wWH09g/iSyCMSFKBpCiyYKMTmOO4ApRryrWrVKpm8DB0Fa/6Ymh/M4yHH6Po+Gqg45uJjs8JvBzQ8ahHw+tBjRgSICcnEgkyIwePZDJgTXKRGPKQZRlZ7lFqoQoxro1iIf97XaazksIHKZGd5eH7vpDIUjnYIN7jsoTDYcTpYocIcAlYDZPh9mJ1lmVD0lRFvIqhoSGRxD9V2uM68tqmQwzKzR4IBBAMBoUaWdWg6mSi5Yj8WtBLUQWT+j5kuQzCTT06OgqXpHKNI5GI+E6SgaadgZUtwLBcYSCXiWfp3u0LqPj+7zr4dWsGZab5fEG0VTQaFUpCoRC4f/lJOgTC0vkiVih1tG0iQIEkwOqjfrApDBiPxwVTZlnrXQaKxWJVwOftR1DN/ReM51rrsHmDAwOUGBe1GhkZQYwucB2bpFrCHFYjPbx7DTUyf7OqB2ejIiSLX1U26wl2smZAtz2qZ9Vpm0K6c/vWH4z+BxiNRqh2QYz8HKb2CeFHOIjOnm948a4T77t70dXVid6eT/gFFpqwHZ59ORQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/0be04a73a5284ec54ca5c110d4a54a5d/8ac56/image-20230409203416047.webp 240w,\n/static/0be04a73a5284ec54ca5c110d4a54a5d/d3be9/image-20230409203416047.webp 480w,\n/static/0be04a73a5284ec54ca5c110d4a54a5d/10237/image-20230409203416047.webp 850w\"\n              sizes=\"(max-width: 850px) 100vw, 850px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/0be04a73a5284ec54ca5c110d4a54a5d/8ff5a/image-20230409203416047.png 240w,\n/static/0be04a73a5284ec54ca5c110d4a54a5d/e85cb/image-20230409203416047.png 480w,\n/static/0be04a73a5284ec54ca5c110d4a54a5d/ae694/image-20230409203416047.png 850w\"\n            sizes=\"(max-width: 850px) 100vw, 850px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/0be04a73a5284ec54ca5c110d4a54a5d/ae694/image-20230409203416047.png\"\n            alt=\"image-20230409203416047\"\n            title=\"image-20230409203416047\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>そして、[起動と回復]セクションの[設定]をクリックし、起動したウィンドウ内の[デバッグ情報の書き込み]の設定を[カーネルメモリダンプ]に変更します。</p>\n<p>最終的に、以下の画像の設定になっていればOKです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/df507aee8ef651273247df2766ef4b5b/0b533/image-16.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAARlAAAEZQAGA43XUAAACk0lEQVQoz01S204TURSdb/BZMBgp0d/xTX/BFz/BxBcMPoCBIA+KbyZGXkRIuBilFCSA0dDSOp1brzOdmc59preZLvc5WOAkK6c9+8w6a+21BaNtwDQsWIYNs2PD0E3oLQO25cB1PDTrOo4OzqGqNV5n5xM4tguX4DsuojDE5fEhBNMyYds2OmYHRofITRPtdpv2DuIkRhwluPhdhixX0Wq1oBs6v+/7PlyXSBkcB34QQjz7CcFxuryYxAl6SQ9RFCGgYkK/2Rr0BhBLIiRJgqKo0DSN1KoczWaL0IRK537oY+vjDoQsy5Cm6TUGgwGGwyHiOOaXfc+HVlWg1TRSKXNUKhWUSpfcjWVZkKoSuQnxfmUTQhRHJN1Fv9/nZGNSNR6PwR5iexL38LckcWsu9Yq5mcCj79i37JwRflrfgzBKR1eWk4STThYj73a7CPwQ5SKzK5E1UkpWG/U6HKq5/wlZD6M4xLcNCoURpWnGSW6UAUOyH9BDESkUywpUsv+nXIZGgTnUZwaXkr1NuPM5D8GilJlklhhTGgQBstEIST4P/+AAXr4A6VKCVDhEcWsLjeNj6KenaLL94gKu53HCkAj3Nr5DmCi7Bv3PKBRndxe17W1Ye/tQKiLkkxPIhQLkoyM0z38hEEV4ZN+j0FxGGIX4sbl/Q3h7sf419DYMSjGktDWpCpn6VmEJywoUsl+nutaoo15jA2/SHAbIf/0CIWR98K7SY2PAh5cuN+gyG/Ai2aqUivyh0WiIjHqbZSmS/gCmG8CnwQ8CnztTz3YhzM7k8OD+LHIzc8hNz2F2Kkc7YWoOD+89wt0703jy+CnW333A8tIKVpffYm1lDYuLq3g5v4hXC0t4Pb+A5TerePH8Gf4BaKNdYR1kH9QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/df507aee8ef651273247df2766ef4b5b/8ac56/image-16.webp 240w,\n/static/df507aee8ef651273247df2766ef4b5b/d3be9/image-16.webp 480w,\n/static/df507aee8ef651273247df2766ef4b5b/b0a15/image-16.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/df507aee8ef651273247df2766ef4b5b/8ff5a/image-16.png 240w,\n/static/df507aee8ef651273247df2766ef4b5b/e85cb/image-16.png 480w,\n/static/df507aee8ef651273247df2766ef4b5b/0b533/image-16.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/df507aee8ef651273247df2766ef4b5b/0b533/image-16.png\"\n            alt=\"image-16.png\"\n            title=\"image-16.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>設定の反映のために OS を再起動して完了です。</p>\n<h3 id=\"notmyfaultを取得する\" style=\"position:relative;\"><a href=\"#notmyfault%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\" aria-label=\"notmyfaultを取得する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NotMyFaultを取得する</h3>\n<p>以下のドキュメント内の[メモリダンプファイルを手動で生成する]の項から、NotMyFaultの入ったZIPファイルダウンロードし、解凍します。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows/client-management/generate-kernel-or-complete-crash-dump\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">カーネル ダンプまたは完全なクラッシュ ダンプを生成する - Windows Client Management | Microsoft Docs</a></p>\n<h3 id=\"メモリダンプを取得する\" style=\"position:relative;\"><a href=\"#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\" aria-label=\"メモリダンプを取得する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>メモリダンプを取得する</h3>\n<p>すべてのウィンドウを閉じ、メモ帳アプリを開きます。</p>\n<p>適当に文字を書き込んだところで保存を実行し、以下の画像のようにファイルを書き込む前の状態で操作を中断します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f943dd66de27fc0bc932bf88313edd91/0b533/image-17.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACWElEQVQ4y42Ty08TURSHR0Lc2EKhWmmn82hn+goNtLQyU0tp6SsxcdGNbt1ZSxMSTEjQYDQmunTpWnbGtSu3blxIjAiRx0xbiohAgn/Cz3vvtLWoCU7y5Zx77sx3n8O9f/sG258+oPXlIw62PuP79jqOjE0cmWf5QTEsDjvxmNSOd9dxum/g3cuneHYjAu5grwH6nJz+RHOvjUZrD0ajBbNJILnZtKD1frr1XbOB9uEJXr94guclFdy3psGE8/U6HA4H3LwA5+gInM5R2G02DNntsNttsNkukWhnNdoeHhpijJBvRhzDsJG+26kouP1GR1ir4YrLhXAkgkAgAJ/PB1mWe9AajX6/n/VRaG71qZCUINLXNHDtjnBh6SHCkwlc1zWEQiFIktST0XxiYgLRaBSxWAzR8fGenPb5SM6LMlaKIXCtjvDByiMkyAgpXUcgGIQoij0ZpduWZalXswa18AgSHheC4AzDElZr83BdHYOqKmx5/cL+mf4WyWcQyPtzyQS4nZ1dJry3sAgXLyEUDEDtE/4vgijhljYJ7uvWFhPW7i9BUMNQfDLEf8zgPLxEeEcjp7yxscmE9cUlKOEovB43eJ7v7dt5dLfAKwi4mYyBM02TCZeXl9kpapqGZDKJqampv4jH44w/21YtTq6NDu7V6irW1tZwt1pFuVxGpVJhMZfLIZPJYHZ2lkHzfH4OxWIR2WwWMzMzpJ1HqVzCHImFQgEpLQ1uYPAiLgwMkj/jMps6Xe7YmBtutweeLh6eIZKr4fcpUPwqVEWFPq2jmCMDZLIMfTqNX7YP/N7xkrLuAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f943dd66de27fc0bc932bf88313edd91/8ac56/image-17.webp 240w,\n/static/f943dd66de27fc0bc932bf88313edd91/d3be9/image-17.webp 480w,\n/static/f943dd66de27fc0bc932bf88313edd91/b0a15/image-17.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f943dd66de27fc0bc932bf88313edd91/8ff5a/image-17.png 240w,\n/static/f943dd66de27fc0bc932bf88313edd91/e85cb/image-17.png 480w,\n/static/f943dd66de27fc0bc932bf88313edd91/0b533/image-17.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f943dd66de27fc0bc932bf88313edd91/0b533/image-17.png\"\n            alt=\"image-17.png\"\n            title=\"image-17.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>この状態で、先ほど解凍したNotMyFaultを実行します。\n※ 途中で同意を求められるのでOKを選択してください。</p>\n<p>起動すると次の画面が表示されるので、初期状態のまま[Crash]をクリックします。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 396px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/56332a5e1b75d8bd5ca15658b2030727/db910/image-18.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 116.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAACtElEQVQ4y41Vi1LiQBDk/z9L705F0CJRngbzJuH9CCgE6JseCBUg3LlVU+wuSW/3TO+kdH93h0ajgZpRQ6vVwiJZYDqdYjwea4xGo9N8MpnoOtvLz+M4VpyS6ziYzeaYz+fyO8NisdDgerlcYrVancXX19dVcP/7+xv9fh8ly7IwHA6x2Wzgey4s6xPDwQCdTgczAU2EcZIkGjyQ7IuCBIIgQMkRhly4rodYTojjCIEfoNfrwdffCK7jwvN8YbwCx263w36/PwXXHAMhUrJtB2EQwjTfNAeddgfNRhP1ehONel2YWpKCRGWlaaovZkDZyOYK6Lqu6rc/bUymM+yOJ26321PkRx4sY3cG6Hme5sA0TNgiLQxDlchfylXpIjcMmQJf8xTHfZ0nyersgBNDVrXyXIFRM1GtvEhU8fryKntVlJ/KqFQqqNUMPP55QLn8jF/3v2EIgc+ujVQUXAEmkqOu1VUm3pGNbdtaHNoqFJZUwSrzJbriskDngGKJVqsDR6RSiiOFoqxBf6DeGo3GKBqFOaRt6EFPbEOb9AWIOdwcK3pZjHwUMiTger0W6wQqOerFKpU3gA9ut7uzqubnNwHJMBCplEuDbzZpobyi9Q3AtYCFmjuC0ugEpnVofBr7EvSfgLwBzCGlssIE5h5TsUyWJ3P/GJA3xVew8JBL/2De+XxxBfCjoihDL0Bb7vFH5wOR9DYyHY8nNyv8X8DhcKSsxtJE05xlikDy+4XGvswPH0rT7VmDOFhoq4cx9rkmctUcimyRDb7cajbxIPeYKeHNCcMAT49PMExTr+EZIO8sB72YnZ4P7s/kHvPbMZX2xmvKZnJYT9UJ2Th9AvjQrdaetffsO5MF1+zu7VYTb2+m9II2ut0uSu/v70qVfS+KIv163Qr+z+eyIIBhGKhWKyqfHf8vf4PZY60odpIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/56332a5e1b75d8bd5ca15658b2030727/8ac56/image-18.webp 240w,\n/static/56332a5e1b75d8bd5ca15658b2030727/2a0bc/image-18.webp 396w\"\n              sizes=\"(max-width: 396px) 100vw, 396px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/56332a5e1b75d8bd5ca15658b2030727/8ff5a/image-18.png 240w,\n/static/56332a5e1b75d8bd5ca15658b2030727/db910/image-18.png 396w\"\n            sizes=\"(max-width: 396px) 100vw, 396px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/56332a5e1b75d8bd5ca15658b2030727/db910/image-18.png\"\n            alt=\"image-18.png\"\n            title=\"image-18.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>すると、Windowsマシンでブルースクリーンが発生して再起動されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5f27b29b3cbaa39e7cc0bd3d8142b686/0b533/image-19.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAABfklEQVQ4y9VSu04CQRRdYFfEtwFNjMYCY2d8UKiV/6SEXUBRML5NVKLGyn+wsrK0RRvYXVYXKo1+xfHe2eEZUFuKkzs7O/fcc86MouhFKIYJRS9BSZQa9T/gs7Vew4KaKEARhLqJQNLEUMbCIGFiv4wIYWTXru9N0vfYno1RQiRXFujftiRZjfAFik8S9qVNzBw5WLpysX5bRSzvYu70DVHC4qWLtZsKVvJeXbhwxdm+dCuhpjcRqikTwxkb41kboR1LDGDVDFbCzQz+p9HZFtsCbYTcNH/2jqkDRzRws5b2KpP6DM8FD1ZT3rp2JkjwJaVlv0GE8RKiJw6yj5+IP3xg9tgRSjm3sMyLsxR5kkIezgjJ9QBVf8qGygoDTLhZRIyyu3/+xvnTF5Ypq3DOxvShU7+EIOfVbrP5VQjLr2SZCWmDb3TjrorV64pYa9JaIyP5RDqi6VLq75CnkFJlq9iqor256147IU3xy/C7knRT2ZHwV0t/oIcICz2g8AeTP71+51uxDgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/5f27b29b3cbaa39e7cc0bd3d8142b686/8ac56/image-19.webp 240w,\n/static/5f27b29b3cbaa39e7cc0bd3d8142b686/d3be9/image-19.webp 480w,\n/static/5f27b29b3cbaa39e7cc0bd3d8142b686/b0a15/image-19.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/5f27b29b3cbaa39e7cc0bd3d8142b686/8ff5a/image-19.png 240w,\n/static/5f27b29b3cbaa39e7cc0bd3d8142b686/e85cb/image-19.png 480w,\n/static/5f27b29b3cbaa39e7cc0bd3d8142b686/0b533/image-19.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/5f27b29b3cbaa39e7cc0bd3d8142b686/0b533/image-19.png\"\n            alt=\"image-19.png\"\n            title=\"image-19.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>再起動後、<code class=\"language-text\">C:\\Windows</code>直下に、<code class=\"language-text\">MEMORY.DMP</code>が存在することを確認します。\n※ 僕の環境では大体450MBくらいになりました。</p>\n<p>これでカーネルメモリダンプの取得が完了しました。</p>\n<h2 id=\"カーネルメモリダンプの解析を行う\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E3%81%AE%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86\" aria-label=\"カーネルメモリダンプの解析を行う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カーネルメモリダンプの解析を行う</h2>\n<h3 id=\"windbgにダンプファイルを読み込む\" style=\"position:relative;\"><a href=\"#windbg%E3%81%AB%E3%83%80%E3%83%B3%E3%83%97%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80\" aria-label=\"windbgにダンプファイルを読み込む permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbgにダンプファイルを読み込む</h3>\n<p>解析を行うために、WinDbgを管理者権限で起動します。</p>\n<p>次に、[File]から[Open dump file]を選択し、先ほど出力された<code class=\"language-text\">MEMORY.DMP</code>をインポートします。\n（メモリダンプがWinDbgに読み込まれるまで数分かかる場合があります。）</p>\n<p>メモリダンプが読み込まれると、以下の出力が確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">Loading Dump File <span class=\"token namespace\">[C:\\Windows\\MEMORY.DMP]</span>\nKernel Bitmap Dump File: Kernel address space is available<span class=\"token punctuation\">,</span> User address space may not be available<span class=\"token punctuation\">.</span>\n\nSymbol search path is: srv*\nExecutable search path is: \nWindows 10 Kernel Version 19041 <span class=\"token function\">MP</span> <span class=\"token punctuation\">(</span>3 procs<span class=\"token punctuation\">)</span> Free x64\nProduct: WinNt<span class=\"token punctuation\">,</span> suite: TerminalServer SingleUserTS\nEdition build lab: 19041<span class=\"token punctuation\">.</span>1<span class=\"token punctuation\">.</span>amd64fre<span class=\"token punctuation\">.</span>vb_release<span class=\"token punctuation\">.</span>191206-1406\nMachine Name:\nKernel base = 0xfffff800`62600000 PsLoadedModuleList = 0xfffff800`6322a230\nDebug session time: Thu Oct  7 20:33:12<span class=\"token punctuation\">.</span>945 2021 <span class=\"token punctuation\">(</span>UTC <span class=\"token operator\">+</span> 9:00<span class=\"token punctuation\">)</span>\nSystem Uptime: 0 days 0:00:54<span class=\"token punctuation\">.</span>755\nLoading Kernel Symbol</code></pre></div>\n<h3 id=\"メモリダンプ読み込み時の出力を読む\" style=\"position:relative;\"><a href=\"#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AE%E5%87%BA%E5%8A%9B%E3%82%92%E8%AA%AD%E3%82%80\" aria-label=\"メモリダンプ読み込み時の出力を読む permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>メモリダンプ読み込み時の出力を読む</h3>\n<p>前項の出力結果から、次の情報が取得できます。</p>\n<ul>\n<li>読み込まれたダンプファイルがカーネルメモリダンプであること</li>\n<li>WindowsのカーネルバージョンとCPUのコア数、bit数</li>\n<li>Kernel base と PsLoadedModuleList のアドレス</li>\n<li>Debug session time：STOPエラー（ブルースクリーン）が発生した時間</li>\n<li>System Uptime：システムがクラッシュまでに稼働していた時間（今回は検証環境なので54秒）</li>\n</ul>\n<p>特に<code class=\"language-text\">Debug session time</code>や<code class=\"language-text\">System Uptime</code>はトラブルシューティングの際に重要な情報になることもあるので、確認しておくとよいでしょう。</p>\n<h3 id=\"analyze--v-で自動解析を行う\" style=\"position:relative;\"><a href=\"#analyze--v-%E3%81%A7%E8%87%AA%E5%8B%95%E8%A7%A3%E6%9E%90%E3%82%92%E8%A1%8C%E3%81%86\" aria-label=\"analyze  v で自動解析を行う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>!analyze -v で自動解析を行う</h3>\n<p>次に、以下のコマンドを入力して自動解析を行います。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token operator\">!</span>analyze <span class=\"token operator\">-</span>v</code></pre></div>\n<p>最新のWinDbgの自動解析機能はかなり高機能であり、<code class=\"language-text\">!analyze -v</code>コマンドだけでも非常に多くのことがわかります。</p>\n<p>このコマンドを実行すると多くの出力が得られますが、その中からいくつか抜粋して確認していきます。</p>\n<p>まず最初に出力されるのは、クラッシュ原因の解析結果です。\nトラブルシューティングの際はまずこの出力を手掛かりにしていくのが効果的な場合もあります。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">2: kd> <span class=\"token operator\">!</span>analyze <span class=\"token operator\">-</span>v\n<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>                                                                             <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>                        Bugcheck Analysis                                    <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span>                                                                             <span class=\"token operator\">*</span>\n<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>\n\nDRIVER_IRQL_NOT_LESS_OR_EQUAL <span class=\"token punctuation\">(</span>d1<span class=\"token punctuation\">)</span>\nAn attempt was made to access a pageable <span class=\"token punctuation\">(</span>or completely invalid<span class=\"token punctuation\">)</span> address at an\ninterrupt request level <span class=\"token punctuation\">(</span>IRQL<span class=\"token punctuation\">)</span> that is too high<span class=\"token punctuation\">.</span>  This is usually\ncaused by drivers <span class=\"token keyword\">using</span> improper addresses<span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">If</span> kernel debugger is available get stack backtrace<span class=\"token punctuation\">.</span>\nArguments:\nArg1: ffffd8024aaa8010<span class=\"token punctuation\">,</span> memory referenced\nArg2: 0000000000000002<span class=\"token punctuation\">,</span> IRQL\nArg3: 0000000000000000<span class=\"token punctuation\">,</span> value 0 = read operation<span class=\"token punctuation\">,</span> 1 = <span class=\"token function\">write</span> operation\nArg4: fffff80060da1981<span class=\"token punctuation\">,</span> address which referenced memory</code></pre></div>\n<p>今回は、NotMyFaultの<code class=\"language-text\">High IRQL Fault(Kernel-mode)</code>を選択してシステムをクラッシュさせたため、<code class=\"language-text\">DRIVER_IRQL_NOT_LESS_OR_EQUAL (d1)</code>エラーが発生したことが示されています。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0xd1--driver-irql-not-less-or-equal\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bug Check 0xD1 DRIVER<em>IRQL</em>NOT<em>LESS</em>OR_EQUAL - Windows drivers | Microsoft Docs</a></p>\n<p>このエラーは、<code class=\"language-text\">PASSIVE_LEVEL(=最も低い割込みレベル)</code>より高いレベルの<code class=\"language-text\">Interrupt Request Level (IRQL)</code>で動作するコードをページプール領域に展開しようとした際に発生するエラーです。</p>\n<p>詳しくは次の記事が参考になります。</p>\n<p>参考：<a href=\"https://sciencepark.co.jp/device_driver/dvdr/report-12/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">デバドラ講座12 │ サイエンスパーク株式会社</a></p>\n<p>続いてレジストリ情報が出力されたあと、クラッシュした原因のプロセスとスタックトレースが出力されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">PROCESS_NAME:  notmyfault64<span class=\"token punctuation\">.</span>exe\n\nTRAP_FRAME:  ffffd48f77af97e0 <span class=\"token operator\">--</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">trap</span> 0xffffd48f77af97e0<span class=\"token punctuation\">)</span>\nNOTE: The <span class=\"token keyword\">trap</span> frame does not contain all registers<span class=\"token punctuation\">.</span>\nSome register values may be zeroed or incorrect<span class=\"token punctuation\">.</span>\nrax=00000000c85c00f0 rbx=0000000000000000 rcx=ffffd80241e00340\nrdx=0000000000000890 rsi=0000000000000000 rdi=0000000000000000\nrip=fffff80060da1981 rsp=ffffd48f77af9970 <span class=\"token function\">rbp</span>=0000000000000002\n r8=ffffd8024abbdc80  r9=0000000000000000 r10=ffffd80241e002c0\nr11=ffffd8024aa9bff0 r12=0000000000000000 r13=0000000000000000\nr14=0000000000000000 r15=0000000000000000\niopl=0         <span class=\"token function\">nv</span> up ei ng nz na pe nc\nmyfault+0x1981:\nfffff800`60da1981 8b03            mov     eax<span class=\"token punctuation\">,</span>dword ptr <span class=\"token namespace\">[rbx]</span> ds:00000000`00000000=????????\nResetting default scope\n\nSTACK_TEXT:  \nffffd48f`77af9698 fffff800`62a09169     : 00000000`0000000a ffffd802`4aaa8010 00000000`00000002 00000000`00000000 : nt!KeBugCheckEx\nffffd48f`77af96a0 fffff800`62a05469     : 00007ff8`f16ecc00 00000000`00000000 00000000`00000f4d 00000000`00000000 : nt!KiBugCheckDispatch+0x69\nffffd48f`77af97e0 fffff800`60da1981     : 00000000`00000000 ffffd48f`77af99c8 00000000`00000000 00000000`00000000 : nt!KiPageFault+0x469\nffffd48f`77af9970 fffff800`60da1d3d     : 00000000`c85c00f0 000001e3`5fb24550 00000000`000000f0 00000000`00000000 : myfault+0x1981\nffffd48f`77af99a0 fffff800`60da1ea1     : ffff9189`4ed94d70 00000000`00000000 00000000`00000000 fffff800`62bf5e51 : myfault+0x1d3d\nffffd48f`77af9ae0 fffff800`6288f865     : ffff9189`4ed94d70 00000000`00000001 ffffd48f`77af9ec0 00000000`00000001 : myfault+0x1ea1\nffffd48f`77af9b40 fffff800`62c75328     : ffffd48f`77af9ec0 ffff9189`4ed94d70 00000000`00000001 fffff800`00000000 : nt!IofCallDriver+0x55\nffffd48f`77af9b80 fffff800`62c74bf5     : 00000000`00000000 ffffd48f`77af9ec0 00000000`00000000 ffffd48f`77af9ec0 : nt!IopSynchronousServiceTail+0x1a8\nffffd48f`77af9c20 fffff800`62c745f6     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!IopXxxControlFile+0x5e5\nffffd48f`77af9d60 fffff800`62a08bb5     : 00000000`fffffffc ffff5121`00000000 00000000`00000001 000001e3`5f5e99a0 : nt!NtDeviceIoControlFile+0x56\nffffd48f`77af9dd0 00007ff8`f16ece54     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!KiSystemServiceCopyEnd+0x25\n0000007a`e6bde8d8 00000000`00000000     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : 0x00007ff8`f16ece54\n\nSYMBOL_NAME:  myfault+1981\nMODULE_NAME: myfault\nIMAGE_NAME:  myfault<span class=\"token punctuation\">.</span>sys\nSTACK_COMMAND:  <span class=\"token punctuation\">.</span>thread <span class=\"token punctuation\">;</span> <span class=\"token punctuation\">.</span>cxr <span class=\"token punctuation\">;</span> kb\nBUCKET_ID_FUNC_OFFSET:  1981\nFAILURE_BUCKET_ID:  AV_myfault!unknown_function\nOS_VERSION:  10<span class=\"token punctuation\">.</span>0<span class=\"token punctuation\">.</span>19041<span class=\"token punctuation\">.</span>1\nBUILDLAB_STR:  vb_release\nOSPLATFORM_TYPE:  x64\nOSNAME:  Windows 10\nFAILURE_ID_HASH:  <span class=\"token punctuation\">{</span>9745090a-9bce-ccba-c096-ca6e9ca04c64<span class=\"token punctuation\">}</span>\nFollowup:     MachineOwner</code></pre></div>\n<p>このように、<code class=\"language-text\">!analyze -v</code>だけでもかなりの情報を確認することができます。</p>\n<h3 id=\"スタックバックトレースの解析\" style=\"position:relative;\"><a href=\"#%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%90%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%AE%E8%A7%A3%E6%9E%90\" aria-label=\"スタックバックトレースの解析 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>スタックバックトレースの解析</h3>\n<p>続いて、スタックバックトレースを解析してみます。</p>\n<p>スタックバックトレースの表示コマンドについては、以下のドキュメントを参照。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/k--kb--kc--kd--kp--kp--kv--display-stack-backtrace-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">k、kb、kc、kd、kp、kP、kv (スタック バックトレースの表示) - Windows drivers | Microsoft Docs</a></p>\n<p>ここでは、<code class=\"language-text\">k / kb / kv</code>の3つのコマンド結果を比較してみました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1143b35b663a53e8d322c8d21a49e0e2/cf8e5/image-21.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjUlEQVQoz5VS2W7CMBDM//8V4kxJI0AJSRwngZyEUwgIh4Dp7qrloepDsTRar2WPZ2fXSNMa6/UKdV1jtVrheDxisVhgv9/jdruB1/P5/DcM36uglAfP8+E4DpbLJYIgQFlWuN/veDwe7xGqoEIcayJR0Fpju90iSRLMZjNRyqTvLMN1IiKMkOc5qfSEaD6fC/K8ECsYrLyqKolsx+FwEHt+w7DtEJb1gTTNYNs27S1Yw6HEXq+PwcBEv9+XfDweYzKZoCRiruQvGKYZ0IMuKZvT4wE6nQ663a7EVquFdrtN6MA0TYxGI3zSp0op8rgUgs1m84IQOlSy1qE0gT2M4xi+70ljOA/DUOKMfM3SVCyJ44QmY43T6YSmaV7g3EiSJfIiE4V8mQ/Z04SIOedzJoyiCIHvyxn7XZSF3L1er4KfEZMua62kDJ8esOGK1E2nU7iuK2DfeKRcAivmhjHxbrcj0kYmgSFjE+maLiSigCGEKpCSw+9PmJwngPdcbpZlMlpFUUhnL5cLzuez4AtJwOPcIhjU0QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/1143b35b663a53e8d322c8d21a49e0e2/8ac56/image-21.webp 240w,\n/static/1143b35b663a53e8d322c8d21a49e0e2/d3be9/image-21.webp 480w,\n/static/1143b35b663a53e8d322c8d21a49e0e2/e46b2/image-21.webp 960w,\n/static/1143b35b663a53e8d322c8d21a49e0e2/7e452/image-21.webp 1402w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/1143b35b663a53e8d322c8d21a49e0e2/8ff5a/image-21.png 240w,\n/static/1143b35b663a53e8d322c8d21a49e0e2/e85cb/image-21.png 480w,\n/static/1143b35b663a53e8d322c8d21a49e0e2/d9199/image-21.png 960w,\n/static/1143b35b663a53e8d322c8d21a49e0e2/cf8e5/image-21.png 1402w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/1143b35b663a53e8d322c8d21a49e0e2/d9199/image-21.png\"\n            alt=\"image-21.png\"\n            title=\"image-21.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">kv</code>の方が情報量が多いことがわかります。\nこのコマンドではフレームポインターの省略された情報(FPO) 情報も表示します。</p>\n<p>ここで、<code class=\"language-text\">(TrapFrame @ ffffd48f</code>77af97e0)`という表示に注視します。</p>\n<p>これはトラップフレーム(割り込み発生時のレジスタ、スタック)といって、この時点のスレッドの状態を復元するための非常に重要な情報です。</p>\n<h3 id=\"トラップフレームからスレッドを復元する\" style=\"position:relative;\"><a href=\"#%E3%83%88%E3%83%A9%E3%83%83%E3%83%97%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%81%8B%E3%82%89%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%92%E5%BE%A9%E5%85%83%E3%81%99%E3%82%8B\" aria-label=\"トラップフレームからスレッドを復元する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>トラップフレームからスレッドを復元する</h3>\n<p><code class=\"language-text\">.trap</code>コマンドを使ってトラップフレームからスレッドの復元をしてみます。</p>\n<p>トラップフレームで復元した時点でのレジスタの情報が出力されました。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">2: kd> <span class=\"token punctuation\">.</span><span class=\"token keyword\">trap</span> ffffd48f`77af97e0\nNOTE: The <span class=\"token keyword\">trap</span> frame does not contain all registers<span class=\"token punctuation\">.</span>\nSome register values may be zeroed or incorrect<span class=\"token punctuation\">.</span>\nrax=00000000c85c00f0 rbx=0000000000000000 rcx=ffffd80241e00340\nrdx=0000000000000890 rsi=0000000000000000 rdi=0000000000000000\nrip=fffff80060da1981 rsp=ffffd48f77af9970 <span class=\"token function\">rbp</span>=0000000000000002\n r8=ffffd8024abbdc80  r9=0000000000000000 r10=ffffd80241e002c0\nr11=ffffd8024aa9bff0 r12=0000000000000000 r13=0000000000000000\nr14=0000000000000000 r15=0000000000000000\niopl=0         <span class=\"token function\">nv</span> up ei ng nz na pe nc\nmyfault+0x1981:\nfffff800`60da1981 8b03            mov     eax<span class=\"token punctuation\">,</span>dword ptr <span class=\"token namespace\">[rbx]</span> ds:00000000`00000000=????????</code></pre></div>\n<p>また、スタックバックトレースの結果からも、トラップフレーム時点の状態に戻っていることがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">2: kd> kv\n  <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> Stack trace <span class=\"token keyword\">for</span> last <span class=\"token function\">set</span> context <span class=\"token operator\">-</span> <span class=\"token punctuation\">.</span>thread/<span class=\"token punctuation\">.</span>cxr resets it\n <span class=\"token comment\"># Child-SP          RetAddr               : Args to Child                                                           : Call Site</span>\n00 ffffd48f`77af9970 fffff800`60da1d3d     : 00000000`c85c00f0 000001e3`5fb24550 00000000`000000f0 00000000`00000000 : myfault+0x1981\n01 ffffd48f`77af99a0 fffff800`60da1ea1     : ffff9189`4ed94d70 00000000`00000000 00000000`00000000 fffff800`62bf5e51 : myfault+0x1d3d\n02 ffffd48f`77af9ae0 fffff800`6288f865     : ffff9189`4ed94d70 00000000`00000001 ffffd48f`77af9ec0 00000000`00000001 : myfault+0x1ea1\n03 ffffd48f`77af9b40 fffff800`62c75328     : ffffd48f`77af9ec0 ffff9189`4ed94d70 00000000`00000001 fffff800`00000000 : nt!IofCallDriver+0x55\n04 ffffd48f`77af9b80 fffff800`62c74bf5     : 00000000`00000000 ffffd48f`77af9ec0 00000000`00000000 ffffd48f`77af9ec0 : nt!IopSynchronousServiceTail+0x1a8\n05 ffffd48f`77af9c20 fffff800`62c745f6     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!IopXxxControlFile+0x5e5\n06 ffffd48f`77af9d60 fffff800`62a08bb5     : 00000000`fffffffc ffff5121`00000000 00000000`00000001 000001e3`5f5e99a0 : nt!NtDeviceIoControlFile+0x56\n07 ffffd48f`77af9dd0 00007ff8`f16ece54     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!KiSystemServiceCopyEnd+0x25 <span class=\"token punctuation\">(</span>TrapFrame @ ffffd48f`77af9e40<span class=\"token punctuation\">)</span>\n08 0000007a`e6bde8d8 00000000`00000000     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : 0x00007ff8`f16ece54</code></pre></div>\n<h3 id=\"プロセスを確認する\" style=\"position:relative;\"><a href=\"#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\" aria-label=\"プロセスを確認する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>プロセスを確認する</h3>\n<p>ここからは、ファイルの保存途中で停止したメモ帳プログラムの動きをメモリダンプから解析してみます。</p>\n<p>次のコマンドで、稼働中のプロセスの一覧を参照できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token operator\">!</span><span class=\"token keyword\">process</span> 0 0</code></pre></div>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/-process\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">プロセス (WinDbg) - Windows drivers | Microsoft Docs</a></p>\n<p><code class=\"language-text\">!process 0 0</code>のように、1番目の数値を0にした場合は、全プロセスについて情報が出力されます。</p>\n<p>特定のプロセスに関する情報のみを表示する場合は、1番目の値でプロセスの16進数アドレス、またはプロセスIDを指定します。</p>\n<p>また、2番目の数値を変更することでより詳細な情報を出力させることができます。</p>\n<p><code class=\"language-text\">!process 0 0</code>とした場合は、すべてのプロセスについて時間と優先度の統計情報が出力されます。</p>\n<p><code class=\"language-text\">!process 0 1</code>とした場合は、プロセスに関連付けられているスレッドとイベントの一覧と、それらの待機状態に関する情報も出力させることができます。</p>\n<p>この出力の中から、メモ帳のプロセスの情報を探し当てます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token keyword\">PROCESS</span> ffff9189527e9080\n    SessionId: 2  Cid: 1e90    Peb: bb6f2ac000  ParentCid: 15e8\n    DirBase: 1d822d000  ObjectTable: ffffd80249eb8040  HandleCount: 817<span class=\"token punctuation\">.</span>\n    Image: notepad<span class=\"token punctuation\">.</span>exe</code></pre></div>\n<p>続いて、このプロセスのアドレスを利用して、プロセスの詳細情報を出力してみます。</p>\n<p>フラグ（2番目の値）を7に設定することで、1つのプロセスの完全な詳細を表示することができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">2: kd> <span class=\"token operator\">!</span><span class=\"token keyword\">process</span> ffff9189527e9080 7\n<span class=\"token keyword\">PROCESS</span> ffff9189527e9080\n    SessionId: 2  Cid: 1e90    Peb: bb6f2ac000  ParentCid: 15e8\n    DirBase: 1d822d000  ObjectTable: ffffd80249eb8040  HandleCount: 817<span class=\"token punctuation\">.</span>\n    Image: notepad<span class=\"token punctuation\">.</span>exe\n    VadRoot ffff918953a30a20 Vads 285 Clone 0 Private 2175<span class=\"token punctuation\">.</span> Modified 340<span class=\"token punctuation\">.</span> Locked 2<span class=\"token punctuation\">.</span>\n    DeviceMap ffffd80247fe8cf0\n    Token                             ffffd8024a19c770\n    ElapsedTime                       00:00:47<span class=\"token punctuation\">.</span>378\n    UserTime                          00:00:00<span class=\"token punctuation\">.</span>000\n    KernelTime                        00:00:00<span class=\"token punctuation\">.</span>000\n    QuotaPoolUsage<span class=\"token namespace\">[PagedPool]</span>         430688\n    QuotaPoolUsage<span class=\"token namespace\">[NonPagedPool]</span>      39648\n    Working <span class=\"token function\">Set</span> Sizes <span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">,</span>min<span class=\"token punctuation\">,</span>max<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">(</span>11788<span class=\"token punctuation\">,</span> 50<span class=\"token punctuation\">,</span> 345<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>47152KB<span class=\"token punctuation\">,</span> 200KB<span class=\"token punctuation\">,</span> 1380KB<span class=\"token punctuation\">)</span>\n    PeakWorkingSetSize                11793\n    VirtualSize                       2101500 Mb\n    PeakVirtualSize                   2101501 Mb\n    PageFaultCount                    14745\n    MemoryPriority                    BACKGROUND\n    BasePriority                      8\n    CommitCharge                      3452\n\n        THREAD ffff91895309d080  Cid 1e90<span class=\"token punctuation\">.</span>1e94  Teb: 000000bb6f2ad000 Win32Thread: ffff9189523d0fc0 WAIT: <span class=\"token punctuation\">(</span>UserRequest<span class=\"token punctuation\">)</span> UserMode Non-Alertable\n            ffff918953118260  SynchronizationEvent\n            ffff918952d83d80  QueueObject\n        Not impersonating\n        DeviceMap                 ffffd80247fe8cf0\n        Owning <span class=\"token keyword\">Process</span>            ffff9189527e9080       Image:         notepad<span class=\"token punctuation\">.</span>exe\n        Attached <span class=\"token keyword\">Process</span>          N/A            Image:         N/A\n        Wait <span class=\"token function\">Start</span> TickCount      3492           Ticks: 12 <span class=\"token punctuation\">(</span>0:00:00:00<span class=\"token punctuation\">.</span>187<span class=\"token punctuation\">)</span>\n        Context <span class=\"token keyword\">Switch</span> Count      10798          IdealProcessor: 2             \n        UserTime                  00:00:00<span class=\"token punctuation\">.</span>140\n        KernelTime                00:00:00<span class=\"token punctuation\">.</span>328\n        Win32 <span class=\"token function\">Start</span> Address 0x00007ff7e2e85a30\n        Stack Init ffffd48f777bffd0 Current ffffd48f777bead0\n        Base ffffd48f777c0000 Limit ffffd48f777ba000 Call 0000000000000000\n        Priority 10 BasePriority 8 PriorityDecrement 0 IoPriority 2 PagePriority 5\n        Child-<span class=\"token function\">SP</span>          RetAddr               Call Site\n        ffffd48f`777beb10 fffff800`6280c970     nt!KiSwapContext+0x76\n        ffffd48f`777bec50 fffff800`6280be9f     nt!KiSwapThread+0x500\n        ffffd48f`777bed00 fffff800`628805ce     nt!KiCommitThreadWait+0x14f\n        ffffd48f`777beda0 fffff800`62c6f620     nt!KeWaitForMultipleObjects+0x2be\n        ffffd48f`777beeb0 ffffeccb`d0c3798d     nt!ObWaitForMultipleObjects+0x2f0\n        ffffd48f`777bf3b0 ffffeccb`d0b46c5e     win32kfull!xxxMsgWaitForMultipleObjectsEx+0xd9\n        ffffd48f`777bf460 ffffeccb`d15d6fd0     win32kfull!NtUserMsgWaitForMultipleObjectsEx+0x3fe\n        fffff800`62a08bb5     win32k!NtUserMsgWaitForMultipleObjectsEx+0x20\n        ffffd48f`777bfdd0 00007ff8`eed7a104     nt!KiSystemServiceCopyEnd+0x25 <span class=\"token punctuation\">(</span>TrapFrame @ ffffd48f`777bfe40<span class=\"token punctuation\">)</span>\n        000000bb`6f17e2d8 00000000`00000000     0x00007ff8`eed7a104\n<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> 中略 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>この出力情報から、ファイルを保存しようとしているタイミングのプロセスの情報を取得することができました。</p>\n<p>※今回はカーネルメモリダンプなので、カーネルモードプロセスの情報しか含まれていません。\nユーザモードのプロセスの情報も見る場合は、完全メモリダンプを取得する必要があります。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回は、Windows環境でカーネルメモリダンプを取得する方法と、WinDbgを用いた簡単な解析方法について紹介しました。</p>\n<p>今後は、より高度な解析手法についてもまとめていく予定です。</p>\n<p>WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧ください。</p>\n<p>参考：<a href=\"/windows-windbg-001-index\">WinDbgを用いたデバッグとトラブルシューティングのテクニック</a>s</p>","fields":{"slug":"/windows-windbg-005-kernel-dump","tagSlugs":["/tag/win-dbg/","/tag/kernel/","/tag/reversing/"]},"frontmatter":{"date":"2021-10-08","description":"","tags":["WinDbg","Kernel","Reversing"],"title":"Windows環境でカーネルメモリダンプを手動で取得し、WinDbgで解析する方法","socialImage":{"publicURL":"/static/21701f5e36fa675d31449570ab3e9c7d/windows-windbg-005-kernel-dump.png"}}}},"pageContext":{"slug":"/windows-windbg-005-kernel-dump"}},"staticQueryHashes":["251939775","401334301","825871152"]}