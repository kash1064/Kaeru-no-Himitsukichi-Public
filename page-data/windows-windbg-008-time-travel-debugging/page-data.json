{"componentChunkName":"component---src-templates-post-template-js","path":"/windows-windbg-008-time-travel-debugging","result":{"data":{"markdownRemark":{"id":"c5d7103d-aea5-5014-9ca7-7725143ce218","html":"<p>WinDbgによるWindowsデバッグやダンプ解析によるトラブルシューティングに習熟することを目指しています。</p>\n<p>今回は、UWP版のWinDbg Previewから利用可能になった Time Travel Debugging 機能の公式チュートリアルを試していきます。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-walkthrough\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Time Travel Debugging - サンプル アプリのチュートリアル - Windows drivers | Microsoft Docs</a></p>\n<p>WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開している情報については、以下のページに一覧をまとめているので、よければご覧ください。</p>\n<p>参考：<a href=\"/windows-windbg-001-index\">WinDbgを用いたデバッグとトラブルシューティングのテクニック</a></p>\n<p>この記事では以下の内容についてまとめています。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li>\n<p><a href=\"#time-travel-debugging-%E3%81%A8%E3%81%AF\">Time Travel Debugging とは</a></p>\n<ul>\n<li><a href=\"#ttd%E3%81%A7%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\">TTDで作成されるファイル</a></li>\n<li><a href=\"#ttd%E3%81%A7%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8\">TTDでできないこと</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E6%BA%96%E5%82%99\">チュートリアル：サンプルプログラムの準備</a></li>\n<li><a href=\"#ttd_sampleexe-%E3%82%92ttd%E3%81%A7%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%99%E3%82%8B\">ttd_sample.exe をTTDでトレースする</a></li>\n<li>\n<p><a href=\"#ttd%E3%81%A7%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86\">TTDでトラブルシューティングを行う</a></p>\n<ul>\n<li><a href=\"#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80\">シンボルファイルを読み込む</a></li>\n<li><a href=\"#%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89%E4%BE%8B%E5%A4%96%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\">トレースファイルから例外を確認する</a></li>\n<li><a href=\"#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E5%86%85%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E4%B8%80%E8%A6%A7%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\">TTDトレース内のイベント一覧を確認する</a></li>\n<li><a href=\"#%E4%BE%8B%E5%A4%96%E3%81%AE%E8%A9%B3%E7%B4%B0%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\">例外の詳細を取得する</a></li>\n<li><a href=\"#%E4%BE%8B%E5%A4%96%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%9F%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97%E3%81%99%E3%82%8B\">例外が発生したタイミングにジャンプする</a></li>\n<li><a href=\"#step-into-back\">Step Into Back!!!</a></li>\n<li><a href=\"#bsp%E3%81%AE%E6%8C%87%E3%81%99%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B\">BSPの指すアドレスのメモリデータを参照する</a></li>\n<li><a href=\"#%E8%A3%9C%E8%B6%B3esp%E3%81%A8ebp%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\">補足：ESPとEBPについて</a></li>\n<li><a href=\"#%E5%95%8F%E9%A1%8C%E3%81%AE%E5%8E%9F%E5%9B%A0%E7%AE%87%E6%89%80%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\">問題の原因箇所を特定する</a></li>\n<li><a href=\"#getcppcongreetingpwy%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0\">GetCppConGreetingPwy関数のデバッグ</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n<h2 id=\"time-travel-debugging-とは\" style=\"position:relative;\"><a href=\"#time-travel-debugging-%E3%81%A8%E3%81%AF\" aria-label=\"time travel debugging とは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time Travel Debugging とは</h2>\n<p>Time Travel Debugging(TTD) 機能を使用することで、ユーザは実行中のプロセスの挙動を記録して、あとで「前後に」再生することができます。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-overview\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Time Travel Debugging - 概要 - Windows drivers | Microsoft Docs</a></p>\n<p>TTDを利用した場合、以下の利点があります。</p>\n<ul>\n<li>ライブデバッグとは異なり、問題が発生したタイミングに「巻き戻し」て解析を行うことができる</li>\n<li>TTDのトレースファイルを共有することで、問題再現時の情報の共有が容易になる</li>\n<li>クラッシュダンプと異なり、問題の原因となるコード実行時の情報を含む</li>\n<li>統合言語クエリ（LINQ）を用いてトレースに対してクエリを実行できる</li>\n</ul>\n<p>一方で、TTDの記録には大きなオーバーヘッドが必要になり、数分程度の記録でもGB単位の容量になる場合があります。</p>\n<p>TTD機能はWinDbg Previewで利用可能な機能ですが、VisualStudioでも同様に利用することが可能なようです。</p>\n<p>参考：<a href=\"https://devblogs.microsoft.com/visualstudio/introducing-time-travel-debugging-for-visual-studio-enterprise-2019/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Introducing Time Travel Debugging for Visual Studio Enterprise 2019 - Visual Studio Blog</a></p>\n<h3 id=\"ttdで作成されるファイル\" style=\"position:relative;\"><a href=\"#ttd%E3%81%A7%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\" aria-label=\"ttdで作成されるファイル permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TTDで作成されるファイル</h3>\n<p>トレース時には、通常以下の3つのファイルが作成されます。</p>\n<ul>\n<li>.idx ファイル：トレース情報にアクセスするためのインデックス</li>\n<li>.run ファイル：コードの実行が保存されるファイル</li>\n<li>.out ファイル：TTD実行時の情報が出力されるファイル</li>\n</ul>\n<p>特に.idx ファイルと.run ファイルは、トレースに要する時間によって非常に大きなサイズになる場合があります。</p>\n<h3 id=\"ttdでできないこと\" style=\"position:relative;\"><a href=\"#ttd%E3%81%A7%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8\" aria-label=\"ttdでできないこと permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TTDでできないこと</h3>\n<p>本記事執筆時点（2021/10/17）のWinDbg Previewで行うTTDでは、以下の3点については実現していない点に注意が必要です。</p>\n<ul>\n<li>カーネルモードプロセスのトレース</li>\n<li>TTD再生時のメモリ書き込み</li>\n<li>Protected Process Light（PPL）で保護されたプロセスのトレース</li>\n</ul>\n<p>特に、TTDトレースは読み取り専用となるため、条件分岐のタイミングにブレークポイントを設定して、レジスタを書き換えて任意のアドレスに分岐させるといった、ライブデバッグでよく行われる手法はTTDでは使用できません。</p>\n<h2 id=\"チュートリアルサンプルプログラムの準備\" style=\"position:relative;\"><a href=\"#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E6%BA%96%E5%82%99\" aria-label=\"チュートリアルサンプルプログラムの準備 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>チュートリアル：サンプルプログラムの準備</h2>\n<p>それではここから、TTDの公式チュートリアルを実践していきたいと思います。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-walkthrough\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Time Travel Debugging - サンプル アプリのチュートリアル - Windows drivers | Microsoft Docs</a></p>\n<p>今回使用した環境は以下の通り。</p>\n<ul>\n<li>WIndows 10 Pro 20H2</li>\n<li>WInDbg Preview 1.2106.26002.0（管理者権限で起動）</li>\n</ul>\n<p>サンプルプログラムについては、VisualStudioではなくllvm-mingwでクロスコンパイルしたものを使用していきます。</p>\n<p>サンプルプログラムのソースコードと、コンパイル環境については以下の記事にまとめています。</p>\n<p>参考：<a href=\"/windows-windbg-006-symbol\">llvm-mingwを使ってLinux環境でもシンボルファイル（.pdb）を作成する方法</a></p>\n<p>今回使用したサンプルプログラムは以下のようなコードです。</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;array></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;cstring></span> </span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">GetCppConGreeting</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">wchar_t</span> <span class=\"token operator\">*</span>buffer<span class=\"token punctuation\">,</span> size_t size<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">wchar_t</span> <span class=\"token keyword\">const</span> <span class=\"token operator\">*</span><span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span> L<span class=\"token string\">\"HELLO FROM THE WINDBG TEAM. GOOD LUCK IN ALL OF YOUR TIME TRAVEL DEBUGGING!\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">wcscpy_s</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    std<span class=\"token double-colon punctuation\">::</span>array<span class=\"token operator\">&lt;</span><span class=\"token keyword\">wchar_t</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token operator\">></span> greeting<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">GetCppConGreeting</span><span class=\"token punctuation\">(</span>greeting<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>greeting<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">wprintf</span><span class=\"token punctuation\">(</span>L<span class=\"token string\">\"%ls\\n\"</span><span class=\"token punctuation\">,</span> greeting<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>公式チュートリアルのソースコードを参考に作成した実行ファイル（ttd_sample.exe）をPowerShellから実行したところ、何らかの理由でプログラムが異常終了します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a67b31f412fbc8448faa3c68f717a457/0b533/image-28.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAARlAAAEZQAGA43XUAAADQUlEQVQ4y4WUW2yTZRjH366OnUC2MWVAt7Gta8vafS3tECMsw61lhe5b23U9jIUyDsNkJgaHazw1mRAWTBYTJMELiN6YKImJN0YIN94ZQ4zRO6PRRIyJso2DFg9E8/Pp1+rqhnDxy/vm+573//3f5/Cpx5NZfP4U24JpvLvH0PqSuPvjQoKt8tzrH8UbGMUX2IenP4W2K2nQ1ZvE1Zug68kUrp1Rnth/msCJqyj73gzrtBQbto3T2J2m3j1KgydGnRZlrStGtSNBzZY4a5wpyjuiqNYQqm1wifYwytKPO5IhdOpTVPPuZ1Gb5IU1LgExCRgR4gWsy+gQbIkS4pjsKVRLCKc+zdDsZxK397ioDmK2JzDZRjB1/BdVpHS/REzOiHBLEE84w+jcF/KR0HOopkHK7PF7HHgQIihGVHMQX3Sa9Gufo7bopYKxEh4sVupQ048Tnb2aF5y+r8MyydP/YaTFENyDMzRF6MTHqE79Ple2iouWiBBeRqSAdbhwZXHo1qeIzX6CcoXFoeUegiK2qjNJU88RmnsnaOk9apDfN/VMYJHnFc5kofLi0DU4xZ7sRyiP9M9yQXN+b9HZmXiRr765xpdff8+31+b57odFYYEf528xv3iTHfHnpeV0zLYodR091Nr8UuXglFRJXym4MUQgPUMu9xs/Xb/Bwo2fub5wi0VZc7k7wF/0jWWNuHJHnMr6VkwVDaj6HU9L9w9JcpeqbHYUBAfGZ+TcH9z9Pcefd3/9l5u3b/PLnRy79r1sxD3kGKGqoZ2yGgtqVVdapmJ4RWVVc5jOgWd48+JlLrxzifPCBYPLnHrjPV45+y7WvkmjSGa7CP7j0CRJzbszpqSIyq8SpNpkdh8dWEljsEBbpHhmmJr1DsprN6Mq3QelbYbk2uKyNVpci8hsl8kHDaTfllOY+zwRVm/SqGr0oLShl6jzHWL99qdoeOwo67onqPcdodZ7mLVbD/Gw5yBr3OOs1sap0Q5QLSmqdqWpcu2n0lmgQv5IG7qTWPzSgpnXr3Bs7kMmT3/A4ZPvM5a9SCzzNvqxtwhMnqdn4hzbD5zBOzZHV+JVOmOz2CInaddn2BzK0hR8gY2BDI3+DI/0Zfgbc5BcoR3iOeEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a67b31f412fbc8448faa3c68f717a457/8ac56/image-28.webp 240w,\n/static/a67b31f412fbc8448faa3c68f717a457/d3be9/image-28.webp 480w,\n/static/a67b31f412fbc8448faa3c68f717a457/b0a15/image-28.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a67b31f412fbc8448faa3c68f717a457/8ff5a/image-28.png 240w,\n/static/a67b31f412fbc8448faa3c68f717a457/e85cb/image-28.png 480w,\n/static/a67b31f412fbc8448faa3c68f717a457/0b533/image-28.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a67b31f412fbc8448faa3c68f717a457/0b533/image-28.png\"\n            alt=\"image-28.png\"\n            title=\"image-28.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>この異常終了の原因をTTDを用いて特定していくのが、このチュートリアルのシナリオになります。</p>\n<h2 id=\"ttd_sampleexe-をttdでトレースする\" style=\"position:relative;\"><a href=\"#ttd_sampleexe-%E3%82%92ttd%E3%81%A7%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%81%99%E3%82%8B\" aria-label=\"ttd_sampleexe をttdでトレースする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ttd_sample.exe をTTDでトレースする</h2>\n<p>まずはWindowsストアからダウンロードしたWinDbg Previewを管理者権限で起動します。</p>\n<p>次に、右上の[ファイル]から、以下の画像のように[Launch executable(advanced)]を選択します。</p>\n<p>ここから、デバッグ対象のバイナリを実行して、TTDトレースを取得することができます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/29a630fa24b406d2131da2f51a2b8d6c/0b533/image-29.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAARlAAAEZQAGA43XUAAABJUlEQVQoz4WSvU7DMBSFvTLyNgwVdOEReBMQbAy8AogCK++CRBGkElFbIVHi5seOf5I4LEyndtKgFtJkOLqSdfz53ntM9i5fcfzgQ6cMdBmC0iWklCiKYkt5nneq8ZH9Kw8nj3MowZCmHFpJ5JlGnCQQQvzCjTGdclDnJeR8jOH9FNOFxJP3ibdZjDnVFi7+XCp7ZOoOycULhnc+BOeYfXyBhgxc5mCMVS+WZdnbnVPjI+RsjKPRBEZGCKNoPXIGZatWqnd3TkkS290zhKGogYObCTIeI+Fp1ZnS2hqLf8HskrZ+N41SugYeXHsI6AJBQKsg3KuZ7bJJd7NuJ7953uzw9BmD23c7nqiS1RbUBmz7Rm1fqgIejnz8fBsLqU3ZGtoF3KUVxheS6t47uDkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/29a630fa24b406d2131da2f51a2b8d6c/8ac56/image-29.webp 240w,\n/static/29a630fa24b406d2131da2f51a2b8d6c/d3be9/image-29.webp 480w,\n/static/29a630fa24b406d2131da2f51a2b8d6c/b0a15/image-29.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/29a630fa24b406d2131da2f51a2b8d6c/8ff5a/image-29.png 240w,\n/static/29a630fa24b406d2131da2f51a2b8d6c/e85cb/image-29.png 480w,\n/static/29a630fa24b406d2131da2f51a2b8d6c/0b533/image-29.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/29a630fa24b406d2131da2f51a2b8d6c/0b533/image-29.png\"\n            alt=\"image-29.png\"\n            title=\"image-29.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>今回は、[Executable]の欄に、先ほどコンパイルした<code class=\"language-text\">ttd_sample.exe</code>の絶対パスを入力しています。</p>\n<p>また、右下の[Record with Time Travel Debugging]のチェックを有効化します。</p>\n<p>あとの項目については、今回はデフォルトのままで問題ないので[Record]ボタンをクリックします。</p>\n<p>[Configure location]ウィンドウでは、トレースファイルの保存先を設定できます。\n任意のフォルダを選択して[Record]ボタンをクリックしてください。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 527px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/19c7d77f0173fa84d4f0a31389cda00b/44385/image-30.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABb0lEQVQoz6WSu0/DMBDG+//viAmJgY0ZgcTAipAYoeHROLZju3k/G9om6sc5oSWIQpEYfrqzcz5/98WTIs+R76Eoij8zPjOxSVVVKMvyx8JDjOsnNuGcw/M8aKWgPjDGIIoihGF4EFtvaweFWYaHxyk8LhAFEeI4gdFzpEmGtu2wWq2/0a5bdF2Hjr5vNhsEQQApZT/lJEkSusEQczBP0gdDN9XUMEfyQZqWyLKBPC8RBikJMBByDi4Cmk59bSilJhRmM7eHk1opJJSv4Ps+XVCiaRrU9QLL5Rvu7qc4OrnA2fkNjk+vcHl9SxbpYeQ4ick7A+ZyPDkvcF2PmnrwGO9hrqA9iozijPV7dj11XnsYqRNCjxXGpMLQokFV1igLy4Ko+tG3e9ZTrTX5a3qfE0IrTXlK5zU1FUPDNE1JEQMn/wSXNO4Qx7mNg3KXIttZY2Gk2HGePxXaue1fUqMnsw+r7jessN3Dtp3/y/ZhvwPQ6DVs85U7BgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/19c7d77f0173fa84d4f0a31389cda00b/8ac56/image-30.webp 240w,\n/static/19c7d77f0173fa84d4f0a31389cda00b/d3be9/image-30.webp 480w,\n/static/19c7d77f0173fa84d4f0a31389cda00b/042cc/image-30.webp 527w\"\n              sizes=\"(max-width: 527px) 100vw, 527px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/19c7d77f0173fa84d4f0a31389cda00b/8ff5a/image-30.png 240w,\n/static/19c7d77f0173fa84d4f0a31389cda00b/e85cb/image-30.png 480w,\n/static/19c7d77f0173fa84d4f0a31389cda00b/44385/image-30.png 527w\"\n            sizes=\"(max-width: 527px) 100vw, 527px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/19c7d77f0173fa84d4f0a31389cda00b/44385/image-30.png\"\n            alt=\"画像に alt 属性が指定されていません。ファイル名: image-30.png\"\n            title=\"画像に alt 属性が指定されていません。ファイル名: image-30.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>アプリケーションが実行され、障害が再現されました。この時点でTTDトレースが取得されているため、[プログラムの終了]をクリックしてアプリケーションを終了します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4b165877ec22631875e1dc785be8a9b9/0b533/image-31.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACrUlEQVQ4y41SS08aURQeH6mhC3cSFxqjaSiRxFXdl/7JpsvSBbY/QJsuuqkoVoOCwMDAwAwDzDDDPEB88vh6zqXVtjHRm/lyTs6c+93vPKRvGRWO48Jsd9BqW2ibDBst00GxbkM3XXRsF07XR+D34fs9XFxcYjC4EvYPLi+v0ek4kA7SGbyNx7G5GcPW1hZisZjwo4SNSAyvIlFEIhG8jkaxvr6BePwdPW6TiACe10cQDOCTZTSbFqQf+yksLi5CkqRnIRwOQy5VUdfa0A0TDcNCl9Tz6boepGw2i+XlZZE8OzuLmZmZf8Axxvz8vMhZXV1FLneOWq2OalVFuazApDbx8fwA0unZGZaWwiKZCZ5SuLKyAlmWYRiGgKZpsDv2lNAjwnQ6fa+QVczNzQmwKrYLCy8ICwiFQvcK8/k86vU6VFVFpVJBu91+IDw8OEToZehRNW+2t3F8cor91BFy5wXs7e1hbW0NSrlM6prQdZ1Kr9F0Ow+EhUIRiUQCHxOf8HlnB8lkEjtk37//gN3dr7QSAzQtF11KZiXJ5BeUlRpqag2NRkOo7FjWw1C4qa7bxcVggH6f14DXwRcwGgYURUEuLyOTOYVclMUwstm8IOL+Valk0zSnhF0irNAFXavTGmh0uSIaLpdKUCixVCyKeKVaRbGQpxKnBBr1T9d0UmiIsm37r6GoNHqTSuFyuC9cBoN9vthsUkz4GlqtFkpyCSV6kBUyuAKO3xNWSJVldUiui17Qo40PqGwunXx/6nvUG88N6H8fFu0cD8FxHHGHbUB5o9EIJvFIrufh+uYWw+EI48kEo/FE2Kk/Jgvc3N7hbjjEWPwD6Jvit89xtj71XxrdXuPpM8Fzzs3VANL38waO9R5+asGjONZ6SKseUootcFTzROz/vJNGH6migV/NBKZqnNlXpwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4b165877ec22631875e1dc785be8a9b9/8ac56/image-31.webp 240w,\n/static/4b165877ec22631875e1dc785be8a9b9/d3be9/image-31.webp 480w,\n/static/4b165877ec22631875e1dc785be8a9b9/b0a15/image-31.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4b165877ec22631875e1dc785be8a9b9/8ff5a/image-31.png 240w,\n/static/4b165877ec22631875e1dc785be8a9b9/e85cb/image-31.png 480w,\n/static/4b165877ec22631875e1dc785be8a9b9/0b533/image-31.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4b165877ec22631875e1dc785be8a9b9/0b533/image-31.png\"\n            alt=\"image-31.png\"\n            title=\"image-31.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>アプリケーションが終了すると、自動的にTTDトレースが開始され、Timelinesの位置が先頭の状態で開始されます。</p>\n<p>ここから、いよいよTTDを用いたトラブルシューティングを開始します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4848fb3a587368a95aca2e693ab84c50/0b533/image-32.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACOElEQVQ4y41S2ZLaMBD0//9NKqmw+wd5ILA2vi+MMT7lQ+ZYKI7OjGDZ4i2q6tI16umekTb5Y8KOM+RFiSwvsd7kaNoOXS9p7tGI7glB+yhewwsShPQmWRVI0oLuetxuN+x2B2iOMYc+/4vpdArLMhEEPsyFAduyEEURijxHWZYQTQM5SIRBCN93sVqtCEQchaiqCjw+P0/QFgsTjuvCtGzYtkckMTzPI+IAOZG1oiW1PbquQ98P6j4MAyJLsV6vsVwuUdf1N6FHZHzIARuyW1U12lZASqlIGMMwEFmvzgJSGJKLJEnUuzAMlYMnYUQHLJ8v2CKDA1kdW+FgBq852f0+VurSNEUcx0+Fh8ORamg7yLJMBbBKzqzIHiS8LopCkeZ5QfULlGVOyrEBCeF7HuM4QvuYz2EYBhaLBXyqmwoKAqWY10pdzWVoH5YDROE9Lk1XSnH5aIoiNHQdOmE2m1NjLDiOC/1Dh2ma9Gil7AghVF25nvfS3JNxqVjpV5eVZZbMdjv6Y3JgDNhtR4XtKLGjrPv9HtvdnhRs4VITPddBTN1mdb7vq7Lcm0KEaUiZxB7uZoBH8HMJj8F7mh2ak4I/+gi5PZB9gaZhxZ2CEPwLJE6nM/0ECa2lzmXdDlElEddM2CIqByybEXHRq/WmGZS68+WKy/WGyw2voLMzLQ5H+jbAGd/jSjgSLngdV/zfuEL7Mcvw5ghMbIE3htMq8H7y2P82a/w0SvwivNnNI0a84J3O3q0K/wBQasHtOBOkhwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4848fb3a587368a95aca2e693ab84c50/8ac56/image-32.webp 240w,\n/static/4848fb3a587368a95aca2e693ab84c50/d3be9/image-32.webp 480w,\n/static/4848fb3a587368a95aca2e693ab84c50/b0a15/image-32.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4848fb3a587368a95aca2e693ab84c50/8ff5a/image-32.png 240w,\n/static/4848fb3a587368a95aca2e693ab84c50/e85cb/image-32.png 480w,\n/static/4848fb3a587368a95aca2e693ab84c50/0b533/image-32.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4848fb3a587368a95aca2e693ab84c50/0b533/image-32.png\"\n            alt=\"image-32.png\"\n            title=\"image-32.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>このままTTD解析を行うこともできますが、せっかくなので保存されたトレースファイルを開いて解析を行いましょう。</p>\n<p>一度WinDbgを閉じたあと、再度管理者権限で起動します。</p>\n<p>先ほどと同じく[ファイル]の一覧から、今度は[Open trace file]を選択して、作成された.runファイルを開きます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e6b8480b8b5affa1bf60a2cc654a5781/0b533/image-33.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAARlAAAEZQAGA43XUAAACFklEQVQoz5WSXU/SURjA/+uGlWhs0OJtAiLGkv68hay2Xr5Fn6SWa90gMt7a3KqLtm4s1PoONu+8MDNzuSlSICAITOpKQTd+/c9xMXXddLbfnnOe7fntOec5ysM333k0t0OtecDvX20ODtq022263S7/u05OTlCuxta5/WqTfLHMXrXC7m6ZVrPF2tpXUqkUmWyWrEY6nZbns4icIJPJMDU1xdLSEoru+RfCLzfZrrZo7Nep1ev0ej1mZ2fR6XSYLTYMBgMDAwPo9XqGhoZkHBwclIizyWTi8hU9sXgC5dKzVTwvNijVmlRKRfL5bTpHh8wvLGB3ewkFAzy4f49IJEIgECAajTIxMUFEoOXC4TBer5frZrPWaRZFefqZkfQGhfIehZ9lCqUqh8c93uXm8Y6Po6q3uHsnKgtVVSUYDBIKhfrR7/fj8XgwGo3yGRTl8QouTbier7C2VWd1q0ax1eH12xxmq4WxsTGGhx1YrVbsdrvEZrP19wKXyyWvfSp8soIz/Y2dwg9ajTpVbTDH3SPmP3zkmt3JDU3oHh3F6XTKwn/hdrulUAxICl2acHUrr025SkVDDOV9bo6RmyoupwOHwyGFFxGyv/GcUHS4Xdmn2dinVjudci6Xw2KxyIJRrUPRhRBfROR9Pp98knPCsx+70+mwvLzM5OQk09PTkng8TiwW6yP+nYjJZJKZmRkSiQSfFhf5A3Qe4rocuYGSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e6b8480b8b5affa1bf60a2cc654a5781/8ac56/image-33.webp 240w,\n/static/e6b8480b8b5affa1bf60a2cc654a5781/d3be9/image-33.webp 480w,\n/static/e6b8480b8b5affa1bf60a2cc654a5781/b0a15/image-33.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e6b8480b8b5affa1bf60a2cc654a5781/8ff5a/image-33.png 240w,\n/static/e6b8480b8b5affa1bf60a2cc654a5781/e85cb/image-33.png 480w,\n/static/e6b8480b8b5affa1bf60a2cc654a5781/0b533/image-33.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e6b8480b8b5affa1bf60a2cc654a5781/0b533/image-33.png\"\n            alt=\"image-33.png\"\n            title=\"image-33.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これでトレースファイルがWinDbgに読み込まれ、解析ができるようになりました。</p>\n<h2 id=\"ttdでトラブルシューティングを行う\" style=\"position:relative;\"><a href=\"#ttd%E3%81%A7%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E8%A1%8C%E3%81%86\" aria-label=\"ttdでトラブルシューティングを行う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TTDでトラブルシューティングを行う</h2>\n<p>ここからは、取得したトレースファイルを解析して、トラブルシューティングを行います。</p>\n<h3 id=\"シンボルファイルを読み込む\" style=\"position:relative;\"><a href=\"#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80\" aria-label=\"シンボルファイルを読み込む permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>シンボルファイルを読み込む</h3>\n<p>公式チュートリアルでは、まず初めにシンボルファイルのパスをWinDbgに読み込ませていきます。</p>\n<p>僕の環境では、デスクトップに<code class=\"language-text\">ttd_tutorial.pdb</code>を配置しているため、<code class=\"language-text\">.sympath+ &lt;デスクトップのパス></code>としてます。\nシンボルファイルのパスを追加した後は<code class=\"language-text\">.reload</code>コマンドを実行します。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token punctuation\">.</span>sympath+ C:\\Users\\Tadpole01\\Desktop\n<span class=\"token punctuation\">.</span>reload</code></pre></div>\n<p>シンボルファイルが適切に読み込まれている場合、以下の画像のように<code class=\"language-text\">ttd_tutorial.exe</code>の関数名などをWinDbgが解釈して表示することができるようになります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 539px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/250917af9537b4cef03305202ba42a47/10f9a/image-36.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 95.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADkklEQVQ4y21UiW6jWBDk//9mZ7UrRUqU7EwOx45PfHCDAZvDJxhiJz5qq18mGa1mkdpgHl3dXV3dWrEtkOc5Xl9fsVgsUNU15LpcLjifz/8x4JddLuffzsW0IAgwGAwwm81QlqUCXi6XWK3WqKoKu93up5XIsp2yPN/xvFTvfp3vlL9mTCZoNBrwPA+O42A4HKLf76HT6cK2HQS+rwLGcYjmc4nv3wvc3BTo9XcMnMAwLFiWzYTm2Gw20EajER4fHzEhcPulRYcfeHl5wdNTg8B9BXZ3e8eADlrNCn98K9EgcK+3IJBBnzZ9DSRJgu12C63b6eD6+hq6rjODZ0a/wf39PW5vb9Fut+nYw9XVFZ1NOtf46++SAUvEUYRnft/hN1JdURRYr9fQTMNAs9mCZVrMps/nJrrdHp3aDDKEPtTx8PBAJ5cAJb79ucVAL+C5FoP1VSJRFCuw1WoFbUiH+/sf5GLMMh/I5xMza+GJd5PcRMxEeE3SObN8Z3l71PUec3Lmeb7iPZyGqik1FaLN4nf4/js5OJP4EwGAeHYkySf8fh1/2v+dfVya6wRM3cAiL5Cma4JL5zyMJ56SjpThs9MbEj4e5ex+zgoyeH5BiVWYzxOl3/1+/wF4PB75ImE5Q2bnYzYPWU4AP3AwnXpwXVt1eLnKGHRDHW6RL0pqUZqwUkMh+vsQPgHlJ0sPaLUyGJMNLPuV3B3ITcUm7RBGFcKwhmkeGOxAWg6s5IDT6cAM95CEPi+ZLgW4XKwx1C2MxjZ21TskWM5sWi2dTbAp4C05XvFespotMytRkAIpVZrxCfYFKCMkIo2ikLNc4eNdgdFIV/qT7h0O+y+T8RQT3uRMnr+a8vb2hjSZMcMBSRcAi9nMyJ/P8eqydFtJynYsxZnYar1gs2iceclyzZE7nc60E7QwzChkH1G8IlgK18l5jzAeh7QYjpvwjJMR1yy5oh4rSqomUM3O18ywYlN2ao7VLAsvvpcRJKAUBDBBEMxZ/pLdTTBlQNcVFUjWc0ooZdYJfWYIpjE1GyNjpwVMjZ7nuhyzZ2qxwwaMuRC6HKcBN42pOJR3ui4j1lN8yvsh/wsNos8so5xY+leGfc7j3d0//MBU2+WRW2Yw0NVzh4tDloNsH5lvnZtHZtwwTcgenU6najTTNFU8qlmWJshWkWi2bXPwdbXfXNeh9kzVFFltnuup/67rKUcRtJgCY6mfC/ZfFrVyHSA5Wl0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/250917af9537b4cef03305202ba42a47/8ac56/image-36.webp 240w,\n/static/250917af9537b4cef03305202ba42a47/d3be9/image-36.webp 480w,\n/static/250917af9537b4cef03305202ba42a47/9cb26/image-36.webp 539w\"\n              sizes=\"(max-width: 539px) 100vw, 539px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/250917af9537b4cef03305202ba42a47/8ff5a/image-36.png 240w,\n/static/250917af9537b4cef03305202ba42a47/e85cb/image-36.png 480w,\n/static/250917af9537b4cef03305202ba42a47/10f9a/image-36.png 539w\"\n            sizes=\"(max-width: 539px) 100vw, 539px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/250917af9537b4cef03305202ba42a47/10f9a/image-36.png\"\n            alt=\"image-36.png\"\n            title=\"image-36.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>シンボルファイルの読み込みまで完了したら、いよいよ解析を始めていきます。</p>\n<h3 id=\"トレースファイルから例外を確認する\" style=\"position:relative;\"><a href=\"#%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89%E4%BE%8B%E5%A4%96%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\" aria-label=\"トレースファイルから例外を確認する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>トレースファイルから例外を確認する</h3>\n<p>トレースファイルを開くと、次のように<code class=\"language-text\">code 80000003</code>例外が発生したことがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token punctuation\">(</span>19e0<span class=\"token punctuation\">.</span>1f9c<span class=\"token punctuation\">)</span>: <span class=\"token keyword\">Break</span> instruction exception <span class=\"token operator\">-</span> code 80000003 <span class=\"token punctuation\">(</span>first/second chance not available<span class=\"token punctuation\">)</span>\nTime Travel Position: D:0 <span class=\"token namespace\">[Unindexed]</span> Index\n<span class=\"token operator\">!</span>index\nIndexed 2/2 keyframes\nSuccessfully created the index in 362ms<span class=\"token punctuation\">.</span></code></pre></div>\n<p>また、ここに表示されている<code class=\"language-text\">Time Travel Position</code>は、TTDトレースの位置を表しています。（ポジションの情報は、実行環境によって変わる場合があります。）</p>\n<p><code class=\"language-text\">!ttdexe.tt &lt;Time Travel Position></code>のようなコマンドを実行することで、任意のトレースポイントにジャンプすることもできます。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-extension-tt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">タイムトラベルデバッグ拡張機能! tt コマンド - Windows drivers | Microsoft Docs</a></p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">0:000> <span class=\"token operator\">!</span>ttdext<span class=\"token punctuation\">.</span>tt D:0\nSetting position: D:0\n<span class=\"token punctuation\">(</span>19e0<span class=\"token punctuation\">.</span>1f9c<span class=\"token punctuation\">)</span>: <span class=\"token keyword\">Break</span> instruction exception <span class=\"token operator\">-</span> code 80000003 <span class=\"token punctuation\">(</span>first/second chance not available<span class=\"token punctuation\">)</span>\nTime Travel Position: D:0\nntdll!LdrInitializeThunk:\n00007ffd`f1944b00 4053            push    rbx</code></pre></div>\n<h3 id=\"ttdトレース内のイベント一覧を確認する\" style=\"position:relative;\"><a href=\"#ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E5%86%85%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E4%B8%80%E8%A6%A7%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\" aria-label=\"ttdトレース内のイベント一覧を確認する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TTDトレース内のイベント一覧を確認する</h3>\n<p>続いて、<code class=\"language-text\">dx -r1 @$curprocess.TTD.Events</code>を呼び出して、TTDトレースの中で発生したイベントの一覧を取得します。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/debugger/time-travel-debugging-event-objects\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">TTD イベントオブジェクト - Windows drivers | Microsoft Docs</a></p>\n<p>以下の出力を見ると、プログラムの実行時に各種モジュールがロードされた後にスレッドが立ち上がり、例外が発生したためスレッドを停止して、各モジュールをアンロードしてプロセス終了した一連の流れを確認できました。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">0:000> dx <span class=\"token operator\">-</span>r1 @<span class=\"token variable\">$curprocess</span><span class=\"token punctuation\">.</span>TTD<span class=\"token punctuation\">.</span>Events\n@<span class=\"token variable\">$curprocess</span><span class=\"token punctuation\">.</span>TTD<span class=\"token punctuation\">.</span>Events                \n    <span class=\"token punctuation\">[</span>0x0<span class=\"token punctuation\">]</span>            : Module ttd_tutorial<span class=\"token punctuation\">.</span>exe Loaded at position: 2:0\n    <span class=\"token punctuation\">[</span>0x1<span class=\"token punctuation\">]</span>            : Module TTDRecordCPU<span class=\"token punctuation\">.</span>dll Loaded at position: 3:0\n    <span class=\"token punctuation\">[</span>0x2<span class=\"token punctuation\">]</span>            : Module apphelp<span class=\"token punctuation\">.</span>dll Loaded at position: 4:0\n    <span class=\"token punctuation\">[</span>0x3<span class=\"token punctuation\">]</span>            : Module KERNELBASE<span class=\"token punctuation\">.</span>dll Loaded at position: 5:0\n    <span class=\"token punctuation\">[</span>0x4<span class=\"token punctuation\">]</span>            : Module ucrtbase<span class=\"token punctuation\">.</span>dll Loaded at position: 6:0\n    <span class=\"token punctuation\">[</span>0x5<span class=\"token punctuation\">]</span>            : Module KERNEL32<span class=\"token punctuation\">.</span>DLL Loaded at position: 7:0\n    <span class=\"token punctuation\">[</span>0x6<span class=\"token punctuation\">]</span>            : Module ntdll<span class=\"token punctuation\">.</span>dll Loaded at position: 8:0\n    <span class=\"token punctuation\">[</span>0x7<span class=\"token punctuation\">]</span>            : Thread UID:   2 TID: 0x1F9C created at D:0\n    <span class=\"token punctuation\">[</span>0x8<span class=\"token punctuation\">]</span>            : Exception 0xC0000005 of <span class=\"token function\">type</span> Hardware at PC: 0X52005400200045\n    <span class=\"token punctuation\">[</span>0x9<span class=\"token punctuation\">]</span>            : Thread UID:   2 TID: 0x1F9C terminated at 96:1\n    <span class=\"token punctuation\">[</span>0xa<span class=\"token punctuation\">]</span>            : Module apphelp<span class=\"token punctuation\">.</span>dll Unloaded at position: FFFFFFFFFFFFFFFE:0\n    <span class=\"token punctuation\">[</span>0xb<span class=\"token punctuation\">]</span>            : Module TTDRecordCPU<span class=\"token punctuation\">.</span>dll Unloaded at position: FFFFFFFFFFFFFFFE:0\n    <span class=\"token punctuation\">[</span>0xc<span class=\"token punctuation\">]</span>            : Module ttd_tutorial<span class=\"token punctuation\">.</span>exe Unloaded at position: FFFFFFFFFFFFFFFE:0\n    <span class=\"token punctuation\">[</span>0xd<span class=\"token punctuation\">]</span>            : Module KERNEL32<span class=\"token punctuation\">.</span>DLL Unloaded at position: FFFFFFFFFFFFFFFE:0\n    <span class=\"token punctuation\">[</span>0xe<span class=\"token punctuation\">]</span>            : Module KERNELBASE<span class=\"token punctuation\">.</span>dll Unloaded at position: FFFFFFFFFFFFFFFE:0\n    <span class=\"token punctuation\">[</span>0xf<span class=\"token punctuation\">]</span>            : Module ntdll<span class=\"token punctuation\">.</span>dll Unloaded at position: FFFFFFFFFFFFFFFE:0\n    <span class=\"token punctuation\">[</span>0x10<span class=\"token punctuation\">]</span>           : Module ucrtbase<span class=\"token punctuation\">.</span>dll Unloaded at position: FFFFFFFFFFFFFFFE</code></pre></div>\n<h3 id=\"例外の詳細を取得する\" style=\"position:relative;\"><a href=\"#%E4%BE%8B%E5%A4%96%E3%81%AE%E8%A9%B3%E7%B4%B0%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\" aria-label=\"例外の詳細を取得する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>例外の詳細を取得する</h3>\n<p>例外のイベントをクリックして詳細を表示したところ、例外発生時の<code class=\"language-text\">Time Travel Position</code>が<code class=\"language-text\">7C:0</code>であることがわかりました。（ポジションは実行環境によって変わる可能性があります。）</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">0:000> dx <span class=\"token operator\">-</span>r1 @<span class=\"token variable\">$curprocess</span><span class=\"token punctuation\">.</span>TTD<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">[</span>8<span class=\"token punctuation\">]</span>\n@<span class=\"token variable\">$curprocess</span><span class=\"token punctuation\">.</span>TTD<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">[</span>8<span class=\"token punctuation\">]</span>                 : Exception 0xC0000005 of <span class=\"token function\">type</span> Hardware at PC: 0X52005400200045\n    <span class=\"token function\">Type</span>             : Exception\n    Position         : 7C:0 <span class=\"token namespace\">[Time Travel]</span>\n    Exception        : Exception 0xC0000005 of <span class=\"token function\">type</span> Hardware at PC: 0X52005400200045</code></pre></div>\n<p>また、子要素の[Exception]を選択することで、さらに詳細な例外の情報も取得することができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">0:000> dx <span class=\"token operator\">-</span>r1 @<span class=\"token variable\">$curprocess</span><span class=\"token punctuation\">.</span>TTD<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">[</span>8<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Exception\n@<span class=\"token variable\">$curprocess</span><span class=\"token punctuation\">.</span>TTD<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">[</span>8<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Exception                 : Exception 0xC0000005 of <span class=\"token function\">type</span> Hardware at PC: 0X52005400200045\n    Position         : 7C:0 <span class=\"token namespace\">[Time Travel]</span>\n    <span class=\"token function\">Type</span>             : Hardware\n    ProgramCounter   : 0x52005400200045\n    Code             : 0xc0000005\n    Flags            : 0x0\n    RecordAddress    : 0x0</code></pre></div>\n<h3 id=\"例外が発生したタイミングにジャンプする\" style=\"position:relative;\"><a href=\"#%E4%BE%8B%E5%A4%96%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%9F%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97%E3%81%99%E3%82%8B\" aria-label=\"例外が発生したタイミングにジャンプする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>例外が発生したタイミングにジャンプする</h3>\n<p>ここで、<code class=\"language-text\">7C:0 [Time Travel]</code>をクリックして、例外が発生した位置にジャンプします。</p>\n<p>画面下部の[Timelines]のカーソルの位置が進みました。</p>\n<p>TTDでは、現在の<code class=\"language-text\">Time Travel Position</code>でトレースされたメモリやレジスタの情報を参照することができます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8e3bc7f6f574ab989430b7790e7ea787/0b533/image-34.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAACEklEQVQ4y42T6Y6bQBCEef83SqLdfYD8sr0cNubwcuMZrsGcxpWesUUix5EyUqlhYD6qq4X27SeDHZxhWRY2Ox26YeGTFMYpeFkhZwV4UaHreozjiCTJIMQF1+sV8zyTrpimGctyQ0Xva/5RoKBDpqFjt9thu91A13X4nocwDFEUBdr2gtttoUMLXNqfpgmvlmgENNOskGaMHBowCGoYJkzTUI5t+wjGmHIkYRKU52eC3/6SXE3TQHPcDlF0wemUI05KVFWpIJzz1V3bduqQBDLGV8BzVUDDzMlJhu3mBNNKFYTToSzLlKQjIVrlUObmuB6GYXgJlDlrvu9QLgdq8ZMy8xHFAcLoi0AZfbFGSUELIVag55/UcF4B+2GCZh8dmuweB9snYIAgOBGUgOec2heqjYbClu1KoEvA4V/AfoQWhIwyLOB5CTnjSFKGsqpQNy3VTrUhHUpXK3D4DfxzKA+gdEVtBiHSNEYch6SYcqTs6pJUoSWghMm2j467tvy8FDD9ihDyFnZSw0kbuJlYZScN9nGNIOVq2pdLhzPjaup9P9B9Tx3c6zhOlHcNTfASUdnimNaw0wpmxHCISzhZjT1FsafrtBCYyeEo/wjqbpoXjPP9fnrUmR70FIV2N3t7aAaWjqr8E5bHHu77/7UWaN+NHG97jrdDgXfSh12q+vbQ+6HED5Ph/h5bnz9L7n9YOX4Bc+/a8n94GSYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/8e3bc7f6f574ab989430b7790e7ea787/8ac56/image-34.webp 240w,\n/static/8e3bc7f6f574ab989430b7790e7ea787/d3be9/image-34.webp 480w,\n/static/8e3bc7f6f574ab989430b7790e7ea787/b0a15/image-34.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/8e3bc7f6f574ab989430b7790e7ea787/8ff5a/image-34.png 240w,\n/static/8e3bc7f6f574ab989430b7790e7ea787/e85cb/image-34.png 480w,\n/static/8e3bc7f6f574ab989430b7790e7ea787/0b533/image-34.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/8e3bc7f6f574ab989430b7790e7ea787/0b533/image-34.png\"\n            alt=\"image-34.png\"\n            title=\"image-34.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>WinDbgでは、<code class=\"language-text\">p</code>コマンドでレジスタの情報を参照できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">Time Travel Position: 7C:0\n0:000> r\nrax=0000000000000000 rbx=0000000000000001 rcx=00000000ffffffff\nrdx=00007ffdef6e0980 rsi=000002b36fa33520 rdi=000000000000002c\nrip=0052005400200045 rsp=000000b936effb20 <span class=\"token function\">rbp</span>=004d004900540020\n r8=000000b936efde98  r9=000002b36fa3899c r10=0000000000000000\nr11=000000b936eff980 r12=0000000000000000 r13=0000000000000000\nr14=000002b36fa2d110 r15=0000000000000001\niopl=0         <span class=\"token function\">nv</span> up ei pl nz na pe nc\ncs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202\n00520054`00200045 ??              ???</code></pre></div>\n<p>上記のように、<code class=\"language-text\">rsp</code>と<code class=\"language-text\">rbp</code>レジスタの値が大きく異なる場合、何らかの理由でスタックが破壊されている可能性があります。</p>\n<h3 id=\"step-into-back\" style=\"position:relative;\"><a href=\"#step-into-back\" aria-label=\"step into back permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step Into Back!!!</h3>\n<p>ここから、スタックが破壊されたタイミングを特定するために、時間を戻します。</p>\n<p>画面の通り[Step Into Back]ボタンをクリックすることで、1つずつトレース位置を戻すことができます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 852px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/12d497b36084dbe911d3bc61dcac5f79/47ff6/image-37-852x1024.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 120%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAARlAAAEZQAGA43XUAAAD3UlEQVQ4y4VU2ZLiRhDUj/vZz/4F+wP8YIftxTG7MTjwBnMxMAgY0AFCAh3oPkAtIF3VGJZd76wVkVF9qTq7KquU7290vB+pWFpraJoF/VXDjK3lQJtpWK0CrBwXI9PFfG7jaWLjlweyeoil48N2Q1i2j2CTIIpSKNt4A3OuwppbmP35AeMff4LR/huG4UCfGlivfXhrD+3+HFNjifHMwu2Thle6oMpzpHGKPMnIJnKs/PBhge9+1fBedREFdOvSheN48OhG14/hBTH8IMHKC+HTWhxniMIIMbEJwhQbshuyYZTBpTNKV9Xw7uMzPvaG0BdLPA5U9IZjjKY6XsZTdLr36Nw9IspKiCNQicNXsMe2OSKIcyj2wqSnTWDqGqzFHCN1iOfnHkzTJCYbiqED3/cgRI2mETjsG7z1bbc7KJqmwVmt6Kk2gmCDNM3oCRtkFJ9qu0VdC3lYCEHPjZEXBfaHAznfY78/QY4PexRFBWU8HkPXdXJoIQwLZJmgmypUVYXdbkfj7WVcE8u6ruUaz884z7OsgGIYBhYLC5a1oIxG9DPo1gYN3Xw8Hi84MWkurL7E4czw5eUFzHIymcC2bWK6BF9iOw5dsCbtzeU4SVL6oUBOofgaeC8h+SicgHa7jW63i8FggNvbW5r/hfv7B7nWarVwc3NDlzkU35TEG1FoQmnPCEO2IdkYypAYPj4+ot/vg9ne3d2h0+nIMbObzWYy455PAvc8yrgvk3Pt8JPjhBySTDjT/GROjue68un8cxAEkk1ZltKJQ0/ndWaaJMlnSNN/S09VVUynM4qbDnvp0+YOZfEpLtdxO4+zLPsPeJ2r6CIbxnpN5RfFcInlmR0zY0bMkuXzFlg6aUqyYUf9/gCj0VhqkRPD8dM0HRO6jBPz1OvJn/7vK8stFNM0KH6vUirWYiGd9ciBYZgyXpyQOa1zWZEcSW+Hz/R5Bn9S2PO5SfW6ImFbMuicLXaUJLFkxWLm70iOkjj+JtM8o+bgU6yCTUiyCOQNguqyqnYoyorqlmKzq6mmubxqKi8h54xaNIT9BaI5IOJ+OBlNqafliNJSWj/MLgi+mF9jExeEUtogKqh/pnDWAZTw4VkKcmBF+F310Rr5eHeF1hWu1/5QPfzcW8nxb0MXnakn5aNU1FlYlNyqkpzqMS8lUmkLaqwZ4jRHQuFIr/doviZGfCYtSkRUx9zqFG5H3OsE2UbUspHKZkqbO7GFm6yxoTjneUb7p3Pick5cGm9ZVqcGyzKQoNSfJcGZPR0W5KQ5zRtOgpD98Pr8+Z/drpZQON3nXvcmRPPtfVIGP7eqtvgHh9kNveAdOTUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/12d497b36084dbe911d3bc61dcac5f79/8ac56/image-37-852x1024.webp 240w,\n/static/12d497b36084dbe911d3bc61dcac5f79/d3be9/image-37-852x1024.webp 480w,\n/static/12d497b36084dbe911d3bc61dcac5f79/39392/image-37-852x1024.webp 852w\"\n              sizes=\"(max-width: 852px) 100vw, 852px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/12d497b36084dbe911d3bc61dcac5f79/8ff5a/image-37-852x1024.png 240w,\n/static/12d497b36084dbe911d3bc61dcac5f79/e85cb/image-37-852x1024.png 480w,\n/static/12d497b36084dbe911d3bc61dcac5f79/47ff6/image-37-852x1024.png 852w\"\n            sizes=\"(max-width: 852px) 100vw, 852px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/12d497b36084dbe911d3bc61dcac5f79/47ff6/image-37-852x1024.png\"\n            alt=\"image-37-852x1024.png\"\n            title=\"image-37-852x1024.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">Time Travel Position: 7B:17</code>の時点では正常であった<code class=\"language-text\">rbp</code>レジスタの値が、<code class=\"language-text\">Time Travel Position: 7B:18</code>のタイミングで破損したことが推察できます。</p>\n<h3 id=\"bspの指すアドレスのメモリデータを参照する\" style=\"position:relative;\"><a href=\"#bsp%E3%81%AE%E6%8C%87%E3%81%99%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B\" aria-label=\"bspの指すアドレスのメモリデータを参照する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>BSPの指すアドレスのメモリデータを参照する</h3>\n<p>スタックが破壊される直前にBSPが保持していたアドレス情報が、<code class=\"language-text\">0xb936effb00</code>であることが確認できました。</p>\n<p>次は、このBSPが示すメモリアドレスの情報を表示してみます。</p>\n<p>WinDbgの[View]から、memoryウィンドウを開き、アドレスバーに<code class=\"language-text\">0xb936effb00</code>を入力します。</p>\n<p>このとき、[Memory]タブの[Text]の設定項目を[none]から[ASCII]に変更することで、メモリデータ内の文字列を表示させることができるようになります。</p>\n<p>以下の画像のように、BSPの指すアドレスにはどうやら文字列が格納されていることがわかります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9622b7e84612443b9124da99e3025e1e/2bef9/image-38-1024x568.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACCElEQVQoz4VSy5KbMBDk/78kp+yecs05lWzs2CCEhHhJgME2mIfBXh86I3krqcolh64eGM2rZ7wv33zwRGMnNLpzj+Pxibbt0XeDw+l4cTz043/hcV9ApkdseEGBE04ncgwzpnHGV1bj03eDl02Nz9uDw+uvBi//4HXX/oEnZYa6OsHoEhVx308YxxGPxwNcxGCRRFoYpNogozcWuqqRmwpJrsk+YJgXwhXX2zu8zc89OI8RhjHiOEOWlTg0LS6XC1jAEHEOFZNPSihl30j3LYRwti4KmmbEOAy43VZ4+32IPC+RZgZaH1DXJ0zTTM47FeKQ8hmUpin5C3qbOagkcVwaQ+8nzPNEMTd4PiXUukaWGxhTo2nPuF4XN3LAOFjIqVgBGSvEKoWQijp9spAxkiRDVTcoafTLQEsRUQ5Tnqlai5aW0nULJVyxrgv8gGO3Z5RUOAQsIpYftnD+SChKeISpGpJpoi2HtJT6grLs0DQjYSLHSCPMYCyksUMaW7jRrWaW7bfVUBKsDFa7dV3xfr/De3v7Qc7I6eX7e2dvtxuMpIsQ0gUqpRxiWoblLHtqaL+11liWxenoNAwZcz8LEt5y3/euuztVC4Lgo8Nn4iiKHNui1g5D5pLb7iweDzqbiO7sfO5ozIGqXOkGJ3Le3GHzSLgulUpoyzkF/0VKsAsxpnRXYWGX+RvmiiSvmi5QuAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/9622b7e84612443b9124da99e3025e1e/8ac56/image-38-1024x568.webp 240w,\n/static/9622b7e84612443b9124da99e3025e1e/d3be9/image-38-1024x568.webp 480w,\n/static/9622b7e84612443b9124da99e3025e1e/e46b2/image-38-1024x568.webp 960w,\n/static/9622b7e84612443b9124da99e3025e1e/a9a89/image-38-1024x568.webp 1024w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/9622b7e84612443b9124da99e3025e1e/8ff5a/image-38-1024x568.png 240w,\n/static/9622b7e84612443b9124da99e3025e1e/e85cb/image-38-1024x568.png 480w,\n/static/9622b7e84612443b9124da99e3025e1e/d9199/image-38-1024x568.png 960w,\n/static/9622b7e84612443b9124da99e3025e1e/2bef9/image-38-1024x568.png 1024w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/9622b7e84612443b9124da99e3025e1e/d9199/image-38-1024x568.png\"\n            alt=\"image-38-1024x568.png\"\n            title=\"image-38-1024x568.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"補足espとebpについて\" style=\"position:relative;\"><a href=\"#%E8%A3%9C%E8%B6%B3esp%E3%81%A8ebp%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"補足espとebpについて permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>補足：ESPとEBPについて</h3>\n<p>少しだけコンピュータの話に触れておきます。</p>\n<p>x64アーキテクチャなどのCPUで稼働するコンピュータ上で関数を呼び出す場合は、CALL命令が利用されます。</p>\n<p>CALL命令は、簡単に言うと以下の処理を実行する命令です。</p>\n<ul>\n<li>CALL命令の次の命令のアドレスをスタックに格納する（CALLする関数の処理がすべて完了したら、この時スタックしたアドレスが呼び出される）</li>\n<li>CALLする関数のメモリアドレスにジャンプする</li>\n</ul>\n<p>参考：<a href=\"https://qiita.com/tobira-code/items/75d3034aed8bb9828981\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">x86-64プロセッサのスタックを理解する - Qiita</a></p>\n<p>詳しくは、こちらの記事にまとめていますので、良ければ参照してください。</p>\n<p>参考：<a href=\"/windows-windbg-007-memory-spoofing\">WinDbgでスタックポインタの指すメモリの情報を書き換えて任意の関数を実行させてみる</a></p>\n<h3 id=\"問題の原因箇所を特定する\" style=\"position:relative;\"><a href=\"#%E5%95%8F%E9%A1%8C%E3%81%AE%E5%8E%9F%E5%9B%A0%E7%AE%87%E6%89%80%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"問題の原因箇所を特定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>問題の原因箇所を特定する</h3>\n<p>ここで、先ほど確認したように、BSPレジスタの値が示すアドレスは文字列になっていました。</p>\n<p>今回のサンプルのようなプログラムの場合、BSPに格納されているアドレスは、main関数の処理が完了した後に呼び出される命令のアドレスとなることが想定されます。</p>\n<p>では、一体どこでスタックが破壊されたのか、それを特定していきましょう。</p>\n<p>次のコマンドでmain関数にブレークポイントを設定した状態で、[Go Back]ボタンを押して時間を巻き戻します。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">bu ttd_tutorial!main</code></pre></div>\n<p>するとmain関数の先頭で停止するので、BSPにメモリアドレスがプッシュされるまで[Step Into]で処理を進めます。</p>\n<p>BSPにアドレスがプッシュされた直後のメモリの情報を見ると、この時点ではまだ文字列ではなく、main関数実行後に呼び出される命令のアドレスが格納されています。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8df57812168816d1b3f7494929bc0953/2bef9/image-47-1024x578.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACB0lEQVQoz12S65KaQBBGff/3yTtkk3+uArIoslkRBOQOw/WkZ0hlk7WqS2qgznyX3lmuz4sb8e01wo0asrzlI4pJ8oK6V3TjSDuMdDJ1q7gGN7zLO8GviFv4ILynxI8nYZSRpAU7y7IIrj5DnaN/VTnQxBVLMbNWCzT6UGaAdV05Hm32+wOn0xvOycWyHdw3jzTL6bqe3eH1wPlykdvu1E1H/uyIbzFZnDG20wbqV5DHeV5wnJOMg+9fOJ/PAj7Jv0dd14ziZnc8HgmCgPs9ZBgmilwJLCFPctq8QZU93bNlaAemacKybGzbNjDP83Bdl4sIKsoSpZQGOvLiKv6fYkncic2+GkHxOatJQxRigCdR+BVYCrDvjeXv8sFPotBlGp+U+Z0yDSTTB2OdyiSMncyQ0HcpOnNt83q9mqg0UIOLohCHgyg8/ODj3SJLpJg+pSpimuIm+aUogZlpZboHbfPYgCZD36jUeRqgKBxkE3a6sfMlIAwj2m4SyyuJFJI+CirJrpI1qstOzlux1WAdrf8y3IBvlFW1KdQ3avlheGNZ9Noo4iiiLEqWXg6GlXVe/2Q4C8zB0UCx+wn05MJqa/l1v5dQfdJUbKnRtFzd5WU6Mj/nbQfVVsqyrAZoW18VeqaUvwp9XysMZZdasrQxz1EcSwmKeVykrNmoU2owdp1/Wv4EbpZ/A82gNdfb8y55AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/8df57812168816d1b3f7494929bc0953/8ac56/image-47-1024x578.webp 240w,\n/static/8df57812168816d1b3f7494929bc0953/d3be9/image-47-1024x578.webp 480w,\n/static/8df57812168816d1b3f7494929bc0953/e46b2/image-47-1024x578.webp 960w,\n/static/8df57812168816d1b3f7494929bc0953/a9a89/image-47-1024x578.webp 1024w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/8df57812168816d1b3f7494929bc0953/8ff5a/image-47-1024x578.png 240w,\n/static/8df57812168816d1b3f7494929bc0953/e85cb/image-47-1024x578.png 480w,\n/static/8df57812168816d1b3f7494929bc0953/d9199/image-47-1024x578.png 960w,\n/static/8df57812168816d1b3f7494929bc0953/2bef9/image-47-1024x578.png 1024w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/8df57812168816d1b3f7494929bc0953/d9199/image-47-1024x578.png\"\n            alt=\"image-47-1024x578.png\"\n            title=\"image-47-1024x578.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>DisassemblyウインドウとMemoryウインドウを見比べながら何度か[Step Over]で処理を進めていくと、<code class=\"language-text\">GetCppConGreetingPwy</code>関数を呼び出した直後にスタックが破壊されたことがわかりました。</p>\n<p>↓ スタック破壊前</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1e99b97d538901f0412fcb48be81cab8/0b533/image-48.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACIElEQVQoz1WTaW7bQAyFff+T9BztjwZF0Bi2tWu0WiNr3z3a7FfOJGkbAQQ5EOcjHykdPD/Cm5fh22sCM2lQ1R2uaYG0qNAOd4xixXhflHV0juIUYcTBKSfLa+RFg7JqKW5QNz0OhmkiuUYoeIjH/kQ/bvQyA89TtH2HuxAYpxFimSGfi2bgdNZg2a6KbYepOMsryhM46McTLEqIXQ8FVa/SkoyjzwuMZaV8X5QYyKa6gaETxLIQBD4s8q7rwHEcDMOAbdtwOP58wYns7fsPRLqFzL0iPGm4mQydl6ALyK7v1iYcmqbBNC14nqc8Yy5cxtC2LZZlwcGilmOeIU5SLDswjEBdDVilwie+PPIogbIzz2MENJVnzPsH1M4vYM5vBN4R21KiLTl1EmAuc6xlgaUg3xTYuxK7qGhu70ApWQI/JTdNg3VdCXj5BeYeYZuvmEVBwBuqyMfAOab0hpFkjhmHqDNsov6vQw+GaRDMpqXYqkMFNAwbUZTQlkra0oq+2zENAs8F2En2Nj+xrU/sD4q3J87nM3RDp7m5ytu2pQr8lXyhBFktikLa1B0Vze+Wc+R1jm1fv87w8cDlclEgRotQQIeA9gdwJaCcQxCGahZi3tB1ApxfkWQJxnGi7jZVeZ5n5TVNhyGBH0uR92zboXvdu2Rd1+H7PuI4hqC/oq5GNHVN8icqMKtvSyZKk1BdN9QSgiAgkK227LoMfd+rnD87SDCQKCF7DgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/1e99b97d538901f0412fcb48be81cab8/8ac56/image-48.webp 240w,\n/static/1e99b97d538901f0412fcb48be81cab8/d3be9/image-48.webp 480w,\n/static/1e99b97d538901f0412fcb48be81cab8/b0a15/image-48.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/1e99b97d538901f0412fcb48be81cab8/8ff5a/image-48.png 240w,\n/static/1e99b97d538901f0412fcb48be81cab8/e85cb/image-48.png 480w,\n/static/1e99b97d538901f0412fcb48be81cab8/0b533/image-48.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/1e99b97d538901f0412fcb48be81cab8/0b533/image-48.png\"\n            alt=\"image-48.png\"\n            title=\"image-48.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>↓ スタック破壊後</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7e9f90fc440fcfb013fd35325207dfee/0b533/image-49.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAACHElEQVQoz22SaZKbMBCFff+D5CxxkrEr9gAS62AwZhMg9sXjl5bsSeVHVPWqkVB96uXtvCDEwUvx7UcEI6ogqhZRkuOaFhCyg+wnyG7UsSVdohs+wgRXupPlAmkmkBc1xQqlaLBjnCG5RuiqDHgA/XBH3dQQdUWAFuM00tlAcYJapslwOr3DdjxYjIPbLkyLI7llaGSLnXE44vzzDe7ZwM0PUUYZ8kuIJknR5QW6LEerlOboCwFmMXDGEAQBHNuG67lgtO+6Ftu2Ynf69QZ+OuO03yN2A4LluBgcmRuij0sMSYm+pKgkBEzD1FDP82ET0PM9HWUjMc8zdtz2EFJfLnGCjUruOqAtRmw91TeSnpX+XaZp6Yxcj0Ccw/efYCklJgU0zt/huUd4zgHrXECKG+Q1xCZyoBF4VCUeglST5oqApgaqkm2bw3GfJdd1jWVZFHBPsCMC/zeWuSRgChldMKUpFtKU3DDmCeY6xedSwbKeQFUqp4E6jqPPmqZ5AhmzyQoJsoyykxP92NCTTe4L8LnR4O+khzaAjoZhwDCNV2YWTdvWWSug7uH7+1n3IQh8jONMqQ9kgRhxFmNavhr4+KeHpga6/wMuBGSWRbAPuuDQCxtNa6JsUxTUu3Ecsa6rLkW9rr4tmrCpgK+hfIHVUJaVSrY0MEAcU0bTiqoaIMgeDV0YyNTbdifQ9tITyF/TVT5U9lF7SaZelhV/AGhmMLpFANVVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7e9f90fc440fcfb013fd35325207dfee/8ac56/image-49.webp 240w,\n/static/7e9f90fc440fcfb013fd35325207dfee/d3be9/image-49.webp 480w,\n/static/7e9f90fc440fcfb013fd35325207dfee/b0a15/image-49.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7e9f90fc440fcfb013fd35325207dfee/8ff5a/image-49.png 240w,\n/static/7e9f90fc440fcfb013fd35325207dfee/e85cb/image-49.png 480w,\n/static/7e9f90fc440fcfb013fd35325207dfee/0b533/image-49.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7e9f90fc440fcfb013fd35325207dfee/0b533/image-49.png\"\n            alt=\"image-49.png\"\n            title=\"image-49.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>このことから、スタック破壊の原因は<code class=\"language-text\">GetCppConGreetingPwy</code>関数に存在することが特定できました。</p>\n<h3 id=\"getcppcongreetingpwy関数のデバッグ\" style=\"position:relative;\"><a href=\"#getcppcongreetingpwy%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0\" aria-label=\"getcppcongreetingpwy関数のデバッグ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GetCppConGreetingPwy関数のデバッグ</h3>\n<p>TTDトレース内の時間を少し戻して、今度は<code class=\"language-text\">GetCppConGreetingPwy</code>関数の処理を追ってみました。</p>\n<p>すると、<code class=\"language-text\">wcscpy_s</code>関数を呼び出した直後にスタックが破壊されたことがわかりました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4d151361fce7650a5121ec8d9bf7f8af/2bef9/image-50-1024x575.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAARlAAAEZQAGA43XUAAAB6ElEQVQoz3WSbZOTMBSF+///lB+ccRx1XVelQBK6QKAtS3gpaWiB0uNNqNVdx8ycuQTIk3Nys4rjBHm+g1INus44HQ4djOkxDCPGcXolme0Q8hjP8RYyf0GaFci2pVO+U1gFvg8pJS6XCXYYM2GeL/jf4FzAW/tgjEMIAUbzIAiw3xfOyMrzPNotpt1HAgFa2zq7xdfr9ZXsECJCGIYE5ogIuMwD1HVNiQashLA7cRTFHk3T0i4G4zQ4lwvkasmLaDDGyNECtA6jaEPvQlRVhdPphNV6HdDLBLZqPRDwgizb4jmVqOqWfprQ9wNpScApqoUuQO6AnOZ3YBA8IJUe4viJFhU4mgplSY5Lhrp9hj5mOHSpq0BHoJAiMmw2G2yi6B5ZKUXAMzn88h7rz++Q/PyIHX9EGfukJzSpB52HOGQ+ujxAR1VvGULfQ8h+x43AxdIU6/B8JuCPh2/wvn7H44dPkCyGkjXSdYS9kND0fMwb6BdS2cColoDBvSkWugD9P01h9CHLcyQyxTBdYPoZlapxNiNgb8+bGyTcNfkLyBdgVd2A9to465xhmmZ07UhRO8yKSDURFKl1x+fg4hbxX+Atsj3gJEndIWtt0DY96i1FLQ1O1Rmm6EkGpuwx9pMDhfcuizdnOOAXFtczjy08/3QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4d151361fce7650a5121ec8d9bf7f8af/8ac56/image-50-1024x575.webp 240w,\n/static/4d151361fce7650a5121ec8d9bf7f8af/d3be9/image-50-1024x575.webp 480w,\n/static/4d151361fce7650a5121ec8d9bf7f8af/e46b2/image-50-1024x575.webp 960w,\n/static/4d151361fce7650a5121ec8d9bf7f8af/a9a89/image-50-1024x575.webp 1024w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4d151361fce7650a5121ec8d9bf7f8af/8ff5a/image-50-1024x575.png 240w,\n/static/4d151361fce7650a5121ec8d9bf7f8af/e85cb/image-50-1024x575.png 480w,\n/static/4d151361fce7650a5121ec8d9bf7f8af/d9199/image-50-1024x575.png 960w,\n/static/4d151361fce7650a5121ec8d9bf7f8af/2bef9/image-50-1024x575.png 1024w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4d151361fce7650a5121ec8d9bf7f8af/d9199/image-50-1024x575.png\"\n            alt=\"image-50-1024x575.png\"\n            title=\"image-50-1024x575.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ここまで特定できたところで、ソースコードを見てみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;array></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;cstring></span> </span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">GetCppConGreeting</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">wchar_t</span> <span class=\"token operator\">*</span>buffer<span class=\"token punctuation\">,</span> size_t size<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">wchar_t</span> <span class=\"token keyword\">const</span> <span class=\"token operator\">*</span><span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span> L<span class=\"token string\">\"HELLO FROM THE WINDBG TEAM. GOOD LUCK IN ALL OF YOUR TIME TRAVEL DEBUGGING!\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">wcscpy_s</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    std<span class=\"token double-colon punctuation\">::</span>array<span class=\"token operator\">&lt;</span><span class=\"token keyword\">wchar_t</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token operator\">></span> greeting<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">GetCppConGreeting</span><span class=\"token punctuation\">(</span>greeting<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>greeting<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">wprintf</span><span class=\"token punctuation\">(</span>L<span class=\"token string\">\"%ls\\n\"</span><span class=\"token punctuation\">,</span> greeting<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>どうやらワイド文字列で50字分しか設定されていなかった配列<code class=\"language-text\">greeting</code>に対して、75文字の<code class=\"language-text\">message</code>を書き込んだことで、スタックオーバフローが発生したことが原因のようです。</p>\n<p>そこで配列<code class=\"language-text\">greeting</code>の要素数を75に修正した<code class=\"language-text\">ttd_tutorial_fixed.cpp</code>を使用して<code class=\"language-text\">ttd_tutorial_fixed.exe</code>を作成しました。</p>\n<p>これで無事にエラーが解消され、無事に実行に成功しました！</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">$ ttd_tutorial_fixed<span class=\"token punctuation\">.</span>exe\nHELLO <span class=\"token keyword\">FROM</span> THE WINDBG TEAM<span class=\"token punctuation\">.</span> GOOD LUCK IN ALL OF YOUR TIME TRAVEL DEBUGGING!</code></pre></div>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>過去と未来の双方向にトレースしていくことができるTTDによるデバッグを試してみました。</p>\n<p>特に、メモリダンプやプロセスダンプからはわからなかった過去のメモリやレジスタの状態がわかるため、非常に解析がスムーズになりました。</p>\n<p>また、ライブデバッグと異なり前の処理に戻ることができるため、「ブレークポイントを設定して問題を再発させて・・・」という手間がなくなる点も非常に便利でした。</p>\n<p>今後もTTDを活用したデバッグ手法についてまとめていこうと思っております。</p>\n<p>WinDbgを用いたWindowsのデバッグやダンプの解析方法について公開しているその他情報については、以下のページのリストをご覧くださいますと幸いです。</p>\n<p>参考：<a href=\"/windows-windbg-001-index\">WinDbgを用いたデバッグとトラブルシューティングのテクニック</a></p>","fields":{"slug":"/windows-windbg-008-time-travel-debugging","tagSlugs":["/tag/win-dbg/","/tag/kernel/","/tag/reversing/"]},"frontmatter":{"date":"2021-10-18","description":"","tags":["WinDbg","Kernel","Reversing"],"title":"【WinDbg Preview】Time Travel Debuggingで始める新しいデバッグ手法","socialImage":{"publicURL":"/static/f6765d3ca61ba0f6df1a4575ba7c225a/windows-windbg-008-time-travel-debugging.png"}}}},"pageContext":{"slug":"/windows-windbg-008-time-travel-debugging"}},"staticQueryHashes":["251939775","401334301","825871152"]}