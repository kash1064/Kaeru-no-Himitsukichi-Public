{"componentChunkName":"component---src-templates-post-template-js","path":"/windows-windbg-010-socket","result":{"data":{"markdownRemark":{"id":"501990c3-0cc5-5507-ba3b-e70997508ff6","html":"<p>リバースエンジニアリング能力向上とWinDbgのプロになるため、自作のモジュールをリバーシングしてます。</p>\n<p>今回は、C言語で実装したWindowsのソケット通信プログラムを解析していきます。</p>\n<p>※検証目的に作成したプログラムでエラー処理などは実装していないため実用性は担保しません。</p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li>\n<p><a href=\"#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0\">今回作成したプログラム</a></p>\n<ul>\n<li><a href=\"#winsock2\">winsock2</a></li>\n<li><a href=\"#pragma-comment\">pragma comment()</a></li>\n<li><a href=\"#ws2tcpiph\">ws2tcpip.h</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#post%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E9%80%81%E4%BF%A1%E3%81%99%E3%82%8B%E9%96%A2%E6%95%B0\">POSTリクエストを送信する関数</a></p>\n<ul>\n<li><a href=\"#wsadata%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96\">WSADATAの初期化</a></li>\n<li><a href=\"#%E9%80%9A%E4%BF%A1%E5%85%88%E3%81%AE%E6%8C%87%E5%AE%9A\">通信先の指定</a></li>\n<li><a href=\"#socket%E3%81%AE%E4%BD%9C%E6%88%90\">Socketの作成</a></li>\n<li><a href=\"#%E3%82%B3%E3%83%8D%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%A2%BA%E7%AB%8B\">コネクションの確立</a></li>\n<li><a href=\"#http%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E9%80%81%E4%BF%A1\">HTTPリクエストの送信</a></li>\n<li><a href=\"#udp%E9%80%9A%E4%BF%A1%E3%82%92%E8%A1%8C%E3%81%86%E9%96%A2%E6%95%B0\">UDP通信を行う関数</a></li>\n</ul>\n</li>\n<li><a href=\"#%E9%80%9A%E4%BF%A1%E3%81%AE%E7%A2%BA%E8%AA%8D\">通信の確認</a></li>\n<li>\n<p><a href=\"#%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B\">リバーシングする</a></p>\n<ul>\n<li><a href=\"#ghidra%E3%81%A7%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B\">Ghidraでデコンパイルする</a></li>\n<li><a href=\"#windbg%E3%81%A7ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\">WinDbgでTTDトレースを取得する</a></li>\n<li><a href=\"#socket%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%82%92%E8%BF%BD%E3%81%86\">Socketの中身を追う</a></li>\n<li><a href=\"#%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%81%9F%E3%82%BD%E3%82%B1%E3%83%83%E3%83%88\">作成されたソケット</a></li>\n<li><a href=\"#sockaddr_in%E6%A7%8B%E9%80%A0%E4%BD%93%E3%82%92%E8%AA%AD%E3%82%80\">sockaddr_in構造体を読む</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n<h2 id=\"今回作成したプログラム\" style=\"position:relative;\"><a href=\"#%E4%BB%8A%E5%9B%9E%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0\" aria-label=\"今回作成したプログラム permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>今回作成したプログラム</h2>\n<p>今回作成したプログラムは以下のリポジトリに置いてあります。</p>\n<p>参考：<a href=\"https://github.com/kash1064/Try2WinDbg/blob/master/build/c/win_tcp_udp.c\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Try2WinDbg/win<em>tcp</em>udp.c</a></p>\n<p>次の2つの機能を実装してます。</p>\n<ul>\n<li>TCPコネクションを確立してPOSTリクエストを送信する</li>\n<li>UDPでデータを送信する</li>\n</ul>\n<p>ヘッダファイルは以下のものを使用してます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;winsock2.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdint.h></span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"ws2_32.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span>\n\n<span class=\"token comment\">// IPアドレスを扱う場合などに利用</span>\n<span class=\"token comment\">// #include &lt;ws2tcpip.h></span>\n<span class=\"token comment\">// #include &lt;iphlpapi.h></span>\n<span class=\"token comment\">// #pragma comment(lib, \"iphlpapi.lib\")</span>\n\n<span class=\"token comment\">// winsock2.h と併用して使用する場合は、必ずwinsock2.hより後に定義する</span>\n<span class=\"token comment\">// #include &lt;windows.h></span></code></pre></div>\n<h3 id=\"winsock2\" style=\"position:relative;\"><a href=\"#winsock2\" aria-label=\"winsock2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>winsock2</h3>\n<p><code class=\"language-text\">winsock2.h</code>は、Windows Sockets 2を含むいくつかの実装を行う際に使用するヘッダファイルです。</p>\n<p>Windows環境におけるソケット通信に使用するAPI関数などが含まれています。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/winsock2/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Winsock2.h header - Win32 apps | Microsoft Docs</a></p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/_winsock/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Windows Sockets 2 - Win32 apps | Microsoft Docs</a></p>\n<p>参考：<a href=\"https://en.wikipedia.org/wiki/Winsock\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Winsock - Wikipedia</a></p>\n<p>Windowsでソケットプログラミングを行う際の最初の一歩は、この<code class=\"language-text\">winsock2.h</code>で定義されている<code class=\"language-text\">WSAStartup</code>関数を使って<code class=\"language-text\">WSADATA</code>構造体の初期化を行うことです。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/winsock/ns-winsock-wsadata\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">WSADATA (winsock.h) - Win32 apps | Microsoft Docs</a></p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsastartup\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">WSAStartup function (winsock2.h) - Win32 apps | Microsoft Docs</a></p>\n<p><code class=\"language-text\">WSAStartup</code>関数は使用するWindows Socketsのバージョンと、初期化する<code class=\"language-text\">WSADATA</code>構造体の2つを引数に取ります。</p>\n<p>少々ややこしい点として、<code class=\"language-text\">WSAStartup</code>関数の第一引数は、16bit符号なし整数(WORD型)を取りますが、下位8bitにWindows Socketsのメジャーバージョン、上位8bitにマイナーバージョンを指定する必要があります。</p>\n<p>そのため、引数に与える値は<code class=\"language-text\">MAKEWORD</code>マクロを使用して作成しています。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/previous-versions/windows/desktop/legacy/ms632663(v=vs.85)\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MAKEWORD macro (Windows) | Microsoft Docs</a></p>\n<p>また、初期化に成功した場合、<code class=\"language-text\">WSAStartup</code>関数は戻り値0を返し、失敗した場合は定義されているエラーコードのいずれかを返します。</p>\n<p>そのため、今回の実装には含めていませんが<code class=\"language-text\">WSAStartup</code>関数の戻り値でエラー処理を実装します。</p>\n<h3 id=\"pragma-comment\" style=\"position:relative;\"><a href=\"#pragma-comment\" aria-label=\"pragma comment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>pragma comment()</h3>\n<p><code class=\"language-text\">winsock2.h</code>などのヘッダファイルをインクルードしてコンパイルしようとすると、<code class=\"language-text\">error LNK2019: 未解決の外部シンボル</code>のようなエラーが返ってくる場合があります。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">win_tcp_udp<span class=\"token punctuation\">.</span>obj : error LNK2019: 未解決の外部シンボル __imp__closesocket@4 が関数 _send_http_post で参照されました\nwin_tcp_udp<span class=\"token punctuation\">.</span>obj : error LNK2019: 未解決の外部シンボル __imp__connect@12 が関数 _send_http_post で参照されました\nwin_tcp_udp<span class=\"token punctuation\">.</span>obj : error LNK2019: 未解決の外部シンボル __imp__htons@4 が関数 _send_http_post で参照されました\nwin_tcp_udp<span class=\"token punctuation\">.</span>obj : error LNK2019: 未解決の外部シンボル __imp__inet_addr@4 が関数 _send_http_post で参照されました\nwin_tcp_udp<span class=\"token punctuation\">.</span>obj : error LNK2019: 未解決の外部シンボル __imp__send@16 が関数 _send_http_post で参照されました\nwin_tcp_udp<span class=\"token punctuation\">.</span>obj : error LNK2019: 未解決の外部シンボル __imp__sendto@24 が関数 _send_udp で参照されました\nwin_tcp_udp<span class=\"token punctuation\">.</span>obj : error LNK2019: 未解決の外部シンボル __imp__socket@12 が関数 _send_http_post で参照されました\nwin_tcp_udp<span class=\"token punctuation\">.</span>obj : error LNK2019: 未解決の外部シンボル __imp__WSAStartup@8 が関数 _send_http_post で参照されました\nwin_tcp_udp<span class=\"token punctuation\">.</span>obj : error LNK2019: 未解決の外部シンボル __imp__WSACleanup@0 が関数 _send_http_post で参照されました\n<span class=\"token punctuation\">.</span>\\build\\bin\\win_tcp_udp<span class=\"token punctuation\">.</span>exe : fatal error LNK1120: 9 件の未解決の外部参照</code></pre></div>\n<p>これは、コンパイラがライブラリをリンクできないことで発生します。</p>\n<p>解決方法として、次のどちらかを実施します。</p>\n<ul>\n<li>VisualStudioで開発している場合は、プロジェクトのプロパティの[構成プロパティ]>[リンカー]>[入力]から[追加の依存ファイル]に参照エラーの発生しているライブラリを追加します</li>\n<li><code class=\"language-text\">#pragma comment(lib, \"&lt;ライブラリ名>.lib\")</code>を追記します。</li>\n</ul>\n<p>今回はプロジェクトは作成せずCファイルをcl.exeでコンパイルしたいので、<code class=\"language-text\">pragma</code>を使っていきます。</p>\n<p><code class=\"language-text\">pragma</code>とは、コンパイル時に特定のアクションを指示する命令です。</p>\n<p>特に、<code class=\"language-text\">comment</code>の<code class=\"language-text\">lib</code>構文を使用することで、コンパイル時にリンクするライブラリをソースコード側から指定することができます。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/cpp/c-language/c-pragmas?view=msvc-170\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">C Pragmas | Microsoft Docs</a></p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/cpp/preprocessor/comment-c-cpp?view=msvc-170\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">comment pragma | Microsoft Docs</a></p>\n<p>そのため、<code class=\"language-text\">#pragma comment(lib, \"ws2_32.lib\")</code>の行を追加することで<code class=\"language-text\">winsock2.h</code>のリンクエラーを回避することができるようになります。</p>\n<h3 id=\"ws2tcpiph\" style=\"position:relative;\"><a href=\"#ws2tcpiph\" aria-label=\"ws2tcpiph permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ws2tcpip.h</h3>\n<p>今回の実装では不要ですが、<code class=\"language-text\">ws2tcpip.h</code>はIPアドレスの取得に関連する構造体などが定義された、TCP/IPを行うために必要なヘッダファイルです。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/winsock/creating-a-basic-winsock-application\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Creating a Basic Winsock Application - Win32 apps | Microsoft Docs</a></p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/ws2tcpip/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Ws2Tcpip.h header - Win32 apps | Microsoft Docs</a></p>\n<h2 id=\"postリクエストを送信する関数\" style=\"position:relative;\"><a href=\"#post%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E9%80%81%E4%BF%A1%E3%81%99%E3%82%8B%E9%96%A2%E6%95%B0\" aria-label=\"postリクエストを送信する関数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POSTリクエストを送信する関数</h2>\n<p>任意のアドレスに対してPOSTリクエストを送信する関数は以下の通りです。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">send_http_post</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>senddata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">char</span> destination<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> RSERVER<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> port <span class=\"token operator\">=</span> <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> httppath<span class=\"token punctuation\">[</span><span class=\"token number\">20</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"/upload\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">char</span> httphost<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> LSERVER<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> dstSocket<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> result<span class=\"token punctuation\">;</span>\n \n    <span class=\"token keyword\">char</span> toSendText<span class=\"token punctuation\">[</span>MAXBUF<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">char</span> postdata<span class=\"token punctuation\">[</span>MAXBUF<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> read_size<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// WSADATAの初期化</span>\n    WSADATA data<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">WSAStartup</span><span class=\"token punctuation\">(</span><span class=\"token function\">MAKEWORD</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// AF_INETを設定</span>\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr_in</span> dstAddr<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>dstAddr<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>dstAddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dstAddr<span class=\"token punctuation\">.</span>sin_port <span class=\"token operator\">=</span> <span class=\"token function\">htons</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dstAddr<span class=\"token punctuation\">.</span>sin_family <span class=\"token operator\">=</span> AF_INET<span class=\"token punctuation\">;</span>\n    dstAddr<span class=\"token punctuation\">.</span>sin_addr<span class=\"token punctuation\">.</span>s_addr <span class=\"token operator\">=</span> <span class=\"token function\">inet_addr</span><span class=\"token punctuation\">(</span>destination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Socket通信の開始(SOCK_STREAMを指定)</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Creating socket...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dstSocket <span class=\"token operator\">=</span> <span class=\"token function\">socket</span><span class=\"token punctuation\">(</span>AF_INET<span class=\"token punctuation\">,</span> SOCK_STREAM<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dstSocket <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Creating socket failed!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Creating socket succeeded!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n    <span class=\"token comment\">// 通信の開始</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Connecting...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    result <span class=\"token operator\">=</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>dstSocket<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>dstAddr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>dstAddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Binding failed!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Connecting succeeded!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n    <span class=\"token comment\">// HTTPリクエストの作成</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Creating HTTP request...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span>toSendText<span class=\"token punctuation\">,</span> <span class=\"token string\">\"POST %s HTTP/1.1\\r\\n\"</span><span class=\"token punctuation\">,</span> httppath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">send</span><span class=\"token punctuation\">(</span>dstSocket<span class=\"token punctuation\">,</span> toSendText<span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>toSendText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n    <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span>toSendText<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Host: %s:%d\\r\\n\"</span><span class=\"token punctuation\">,</span> httphost<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">send</span><span class=\"token punctuation\">(</span>dstSocket<span class=\"token punctuation\">,</span> toSendText<span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>toSendText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span>postdata<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%s\\r\\n\"</span><span class=\"token punctuation\">,</span> senddata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span>toSendText<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Content-Length: %d\\r\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>postdata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">send</span><span class=\"token punctuation\">(</span>dstSocket<span class=\"token punctuation\">,</span> toSendText<span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>toSendText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         \n    <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span>toSendText<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">send</span><span class=\"token punctuation\">(</span>dstSocket<span class=\"token punctuation\">,</span> toSendText<span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>toSendText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// HTTPリクエストの送信</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Sending HTTP request...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">send</span><span class=\"token punctuation\">(</span>dstSocket<span class=\"token punctuation\">,</span> postdata<span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>postdata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n    <span class=\"token comment\">// 通信のクローズ</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>HTTP request is sent!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">closesocket</span><span class=\"token punctuation\">(</span>dstSocket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">WSACleanup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"wsadataの初期化\" style=\"position:relative;\"><a href=\"#wsadata%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96\" aria-label=\"wsadataの初期化 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WSADATAの初期化</h3>\n<p>まずはソケット通信に必要な<code class=\"language-text\">WSADATA</code>構造体を<code class=\"language-text\">WSAStartup</code>関数で初期化します。</p>\n<p>Windows Socketsのバージョンは2.0を指定しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// WSADATAの初期化</span>\nWSADATA data<span class=\"token punctuation\">;</span>\n<span class=\"token function\">WSAStartup</span><span class=\"token punctuation\">(</span><span class=\"token function\">MAKEWORD</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"通信先の指定\" style=\"position:relative;\"><a href=\"#%E9%80%9A%E4%BF%A1%E5%85%88%E3%81%AE%E6%8C%87%E5%AE%9A\" aria-label=\"通信先の指定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>通信先の指定</h3>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// AF_INETを設定</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr_in</span> dstAddr<span class=\"token punctuation\">;</span>\n<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>dstAddr<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>dstAddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndstAddr<span class=\"token punctuation\">.</span>sin_port <span class=\"token operator\">=</span> <span class=\"token function\">htons</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndstAddr<span class=\"token punctuation\">.</span>sin_family <span class=\"token operator\">=</span> AF_INET<span class=\"token punctuation\">;</span>\ndstAddr<span class=\"token punctuation\">.</span>sin_addr<span class=\"token punctuation\">.</span>s_addr <span class=\"token operator\">=</span> <span class=\"token function\">inet_addr</span><span class=\"token punctuation\">(</span>destination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">WSADATA</code>構造体の初期化後、<code class=\"language-text\">sockaddr_in</code>構造体を作成してアドレスファミリと通信先のアドレス、ポート番号を定義します。</p>\n<p>公式ドキュメントでは<code class=\"language-text\">addrinfo</code>構造体を使用する方法が紹介されていますが、今回は<code class=\"language-text\">sockaddr_in</code>構造体を使用してます。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/winsock/creating-a-socket-for-the-client\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Creating a Socket for the Client - Win32 apps | Microsoft Docs</a></p>\n<p><code class=\"language-text\">sockaddr_in</code>構造体はIPv4の通信にのみ利用でき、IPv6を使用する場合は<code class=\"language-text\">sockaddr_in6</code>構造体を使用します。</p>\n<p>公式ドキュメントで使用している<code class=\"language-text\">addrinfo</code>構造体はIPv4とIPv6の両方にソケットを使用する場合に利用します。</p>\n<p>特に理由がなければ<code class=\"language-text\">addrinfo</code>構造体を使っておけば問題なさそうですね。</p>\n<p>参考：<a href=\"https://medium.com/adamedelwiess/operating-system-9-socket-programming-experiment-2-enable-ipv4-and-ipv6-c2f034511cd4\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Operating System 9 | Socket Programming Experiment 2: Enable IPv4 and IPv6 | by Adam Edelweiss | SereneField | Medium</a></p>\n<p>参考：<a href=\"https://stackoverflow.com/questions/23401147/what-is-the-difference-between-struct-addrinfo-and-struct-sockaddr\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">c - What is the difference between struct addrinfo and struct sockaddr - Stack Overflow</a></p>\n<p>アドレスファミリには<code class=\"language-text\">AF_INET</code>を指定しています。</p>\n<p><code class=\"language-text\">AF_INET</code>はIPv4の通信を行う場合に定義するアドレスファミリです。</p>\n<p>参考：<a href=\"https://stackoverflow.com/questions/1593946/what-is-af-inet-and-why-do-i-need-it\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">sockets - What is AF_INET, and why do I need it? - Stack Overflow</a></p>\n<h3 id=\"socketの作成\" style=\"position:relative;\"><a href=\"#socket%E3%81%AE%E4%BD%9C%E6%88%90\" aria-label=\"socketの作成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Socketの作成</h3>\n<p><code class=\"language-text\">socket</code>関数を使ってソケットを作成します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Socket通信の開始(SOCK_STREAMを指定)</span>\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Creating socket...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndstSocket <span class=\"token operator\">=</span> <span class=\"token function\">socket</span><span class=\"token punctuation\">(</span>AF_INET<span class=\"token punctuation\">,</span> SOCK_STREAM<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dstSocket <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Creating socket failed!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Creating socket succeeded!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>今回はTCP接続を行うため、第2引数には<code class=\"language-text\">SOCK_STREAM</code>を指定しています。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-socket\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">socket function (winsock2.h) - Win32 apps | Microsoft Docs</a></p>\n<p>第3引数には<em>プロトコル</em>パラメータであり、使用するプロトコルを定義できます。</p>\n<p>今回はTCPを明示的に指定しておらず、0を渡しています。</p>\n<p>これは、プロトコルの指定を呼び出し元が行わないことを意味します。</p>\n<p>参考：<a href=\"https://stackoverflow.com/questions/3735773/what-does-0-indicate-in-socket-system-call\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">c - what does 0 indicate in socket() system call? - Stack Overflow</a></p>\n<h3 id=\"コネクションの確立\" style=\"position:relative;\"><a href=\"#%E3%82%B3%E3%83%8D%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%A2%BA%E7%AB%8B\" aria-label=\"コネクションの確立 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>コネクションの確立</h3>\n<p>次は<code class=\"language-text\">connect</code>関数でソケット接続を確立します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// 通信の開始</span>\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Connecting...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nresult <span class=\"token operator\">=</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>dstSocket<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>dstAddr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>dstAddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Binding failed!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Connecting succeeded!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">connect</code>関数はSocket通信におけるクライアント側の接続を行います。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/winsock/connecting-to-a-socket\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Connecting to a Socket - Win32 apps | Microsoft Docs</a></p>\n<p>この関数によってbindされているSocketサーバとのTCPコネクションを確立します。</p>\n<p><img src=\"/70d7cbb162e7199a3a6b8596fc9fc683/socket_client_server.gif\" alt=\"https://www.tutorialspoint.com/unix_sockets/images/socket_client_server.gif\"></p>\n<p>画像引用元：<a href=\"https://www.tutorialspoint.com/unix_sockets/client_server_model.htm\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Unix Socket - Client Server Model</a></p>\n<h3 id=\"httpリクエストの送信\" style=\"position:relative;\"><a href=\"#http%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E9%80%81%E4%BF%A1\" aria-label=\"httpリクエストの送信 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HTTPリクエストの送信</h3>\n<p>事前に作成したPOSTリクエストのデータを<code class=\"language-text\">send</code>関数でサーバに送信します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// HTTPリクエストの送信</span>\n<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Sending HTTP request...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">send</span><span class=\"token punctuation\">(</span>dstSocket<span class=\"token punctuation\">,</span> postdata<span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>postdata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>今回は実装していませんが、レスポンスを受信するには<code class=\"language-text\">recv</code>関数を使います。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/winsock/sending-and-receiving-data-on-the-client\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Sending and Receiving Data on the Client - Win32 apps | Microsoft Docs</a></p>\n<h3 id=\"udp通信を行う関数\" style=\"position:relative;\"><a href=\"#udp%E9%80%9A%E4%BF%A1%E3%82%92%E8%A1%8C%E3%81%86%E9%96%A2%E6%95%B0\" aria-label=\"udp通信を行う関数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>UDP通信を行う関数</h3>\n<p>UDP通信を行う関数は以下の通りです。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">send_udp</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>senddata<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">char</span> destination<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> RSERVER<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> port <span class=\"token operator\">=</span> <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">char</span> httphost<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> LSERVER<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> dstSocket<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> result<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">char</span> toSendText<span class=\"token punctuation\">[</span>MAXBUF<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> read_size<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// WSADATAの初期化</span>\n    WSADATA wsaData<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">WSAStartup</span><span class=\"token punctuation\">(</span><span class=\"token function\">MAKEWORD</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>wsaData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr_in</span> dstAddr<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>dstAddr<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>dstAddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dstAddr<span class=\"token punctuation\">.</span>sin_port <span class=\"token operator\">=</span> <span class=\"token function\">htons</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dstAddr<span class=\"token punctuation\">.</span>sin_family <span class=\"token operator\">=</span> AF_INET<span class=\"token punctuation\">;</span>\n    dstAddr<span class=\"token punctuation\">.</span>sin_addr<span class=\"token punctuation\">.</span>s_addr <span class=\"token operator\">=</span> <span class=\"token function\">inet_addr</span><span class=\"token punctuation\">(</span>destination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Socket通信の開始(SOCK_DGRAMを指定)</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Creating socket...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dstSocket <span class=\"token operator\">=</span> <span class=\"token function\">socket</span><span class=\"token punctuation\">(</span>AF_INET<span class=\"token punctuation\">,</span> SOCK_DGRAM<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dstSocket <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Creating socket failed!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Creating socket succeeded!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// UDPパケットの送信</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>Sending UDP...\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">sendto</span><span class=\"token punctuation\">(</span>dstSocket<span class=\"token punctuation\">,</span> senddata<span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>senddata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>SOCKADDR <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>dstAddr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>dstAddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\t==>UDP is sent!!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">closesocket</span><span class=\"token punctuation\">(</span>dstSocket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">WSACleanup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>基本的にはTCP接続の時と同じ実装なので詳細は割愛します。</p>\n<p>違いとしては、UDP接続なのでSocketを作成する際の指定を<code class=\"language-text\">SOCK_DGRAM</code>にする点と、3wayハンドシェイクを行わないので<code class=\"language-text\">connect</code>関数を使用せず、<code class=\"language-text\">sendto</code>関数でデータ転送を行う点です。</p>\n<h2 id=\"通信の確認\" style=\"position:relative;\"><a href=\"#%E9%80%9A%E4%BF%A1%E3%81%AE%E7%A2%BA%E8%AA%8D\" aria-label=\"通信の確認 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>通信の確認</h2>\n<p>このプログラムを実行し、実際に通信が行われているかWireSharkで確認してみました。</p>\n<p>まず、以下の通りPOSTリクエストが送信されていることが確認できました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 540px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/64768d2f9690187105b1c5461918aaac/07484/image-70.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.16666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABsklEQVQ4y51S207CQBTsrxmNJhpFQfBG/AtffPDfjBiFAlIoKJdaBLZAgdJWCpTYjrsbCHjBJjaZnLPb2dk5Z49wdX2D7f0wdg7C2NoLYXM3hFDsAsdnlwgdn3FETuI4ip0jchrHYfQcYfqfge0dRikncooDio3tPQjS4yOUnIRq9gmVbBbllIhaLgdCCIim0ahBo7E1X7N8ERc54zAwjtDMS7CLRZgUPVHEUMpjTEn//QRNecWo0YDTacO1THjTCXzvA77vw/O8b/DXYMkRpHQFhVQd5TyBXDRQU2yUK0PYtvvjdnZJEISkqCIpDpCXh3h4aEMUu7hPaHh+NtBqvePtzUajYXMnq6JrS85kVNzeEiSTbdzdEaTTOs076PXGnLAoa1XoT0G13qFOHBjGFJblYjCYwDRduO7HrweWYr+LCrLcpGXq0PUx+v0xd2YYE77udp35/oSXb1nTwLKFQqFJS9ShKCZeXgwORbFQrZqo0Mep1UzeRyY4m3nBgnKRIJHooFQa8INMgJARzxlU1aItmH4R+3MO6/UudWLCcWaBQ7sqttahRYd50eTV11yHIJef8U/CCQzXhkMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/64768d2f9690187105b1c5461918aaac/8ac56/image-70.webp 240w,\n/static/64768d2f9690187105b1c5461918aaac/d3be9/image-70.webp 480w,\n/static/64768d2f9690187105b1c5461918aaac/9e625/image-70.webp 540w\"\n              sizes=\"(max-width: 540px) 100vw, 540px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/64768d2f9690187105b1c5461918aaac/8ff5a/image-70.png 240w,\n/static/64768d2f9690187105b1c5461918aaac/e85cb/image-70.png 480w,\n/static/64768d2f9690187105b1c5461918aaac/07484/image-70.png 540w\"\n            sizes=\"(max-width: 540px) 100vw, 540px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/64768d2f9690187105b1c5461918aaac/07484/image-70.png\"\n            alt=\"image-70.png\"\n            title=\"image-70.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>また、UDPパケットも受信していることを確認しました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 714px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/816c1ea998498b98edaeb6ba60edab0f/d67ca/image-71.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABG0lEQVQoz52NTUsCYRSF5/8ELSK0WkQQQaswnD50wjbt+xnRKgqinCmbnNEkLSKIMgjaqCV9QYsoBRdtxqWrhHdmnt6JkmgR6IGHe+65cK5iXlawrx9IXlQxziuYxTLH5WdO7+vkSi+kr6ro8pYq3lAoPcm8xtljnZO7Goe3rx3y1bcvlI38EWu5PKv7BZZX1hlPLDEUjdE/qdI3oTIaS0g/RyiiMaYtMjKzwHA0LqdGWM7ByDyh6ThhNc7A1CwKv/TeaGDu7JLc3MLQDVLSZzNZMpaNnbYktvSZDgd29ju3MFN76NtJFOG6CCFwPR/HaSJaLfA8epXi+z4BgRzH4aPdJtiCJ8EztwuEcP8UNpu0ZWGgn7xb/i3sRZ9q5+QYMReR+QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/816c1ea998498b98edaeb6ba60edab0f/8ac56/image-71.webp 240w,\n/static/816c1ea998498b98edaeb6ba60edab0f/d3be9/image-71.webp 480w,\n/static/816c1ea998498b98edaeb6ba60edab0f/80c40/image-71.webp 714w\"\n              sizes=\"(max-width: 714px) 100vw, 714px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/816c1ea998498b98edaeb6ba60edab0f/8ff5a/image-71.png 240w,\n/static/816c1ea998498b98edaeb6ba60edab0f/e85cb/image-71.png 480w,\n/static/816c1ea998498b98edaeb6ba60edab0f/d67ca/image-71.png 714w\"\n            sizes=\"(max-width: 714px) 100vw, 714px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/816c1ea998498b98edaeb6ba60edab0f/d67ca/image-71.png\"\n            alt=\"image-71.png\"\n            title=\"image-71.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これでプログラムがちゃんと動作していることが確認できたので、最後にリバーシングしてみたいと思います。</p>\n<h2 id=\"リバーシングする\" style=\"position:relative;\"><a href=\"#%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B\" aria-label=\"リバーシングする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>リバーシングする</h2>\n<h3 id=\"ghidraでデコンパイルする\" style=\"position:relative;\"><a href=\"#ghidra%E3%81%A7%E3%83%87%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B\" aria-label=\"ghidraでデコンパイルする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ghidraでデコンパイルする</h3>\n<p>まずは<code class=\"language-text\">entry</code>関数から<code class=\"language-text\">main</code>関数を特定しました。</p>\n<p>その後、<code class=\"language-text\">send_http_post</code>関数と<code class=\"language-text\">send_udp</code>関数を特定した後、<code class=\"language-text\">win_tcp_udp.exe</code>を実行したときに展開されたイメージベースを設定しました。</p>\n<h3 id=\"windbgでttdトレースを取得する\" style=\"position:relative;\"><a href=\"#windbg%E3%81%A7ttd%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\" aria-label=\"windbgでttdトレースを取得する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WinDbgでTTDトレースを取得する</h3>\n<p>解析を容易にするため、ビルドしたプログラムのTTDトレースを取得しました。</p>\n<p>TTDトレースの取得方法は以下の記事にまとめてあります。</p>\n<p>参考：<a href=\"/windows-windbg-008-time-travel-debugging\">【WinDbg Preview】Time Travel Debuggingで始める新しいデバッグ手法</a></p>\n<p>また、取得したトレースファイルは以下のリポジトリにも置いてあります。</p>\n<p>参考：<a href=\"https://github.com/kash1064/Try2WinDbg/blob/master/traces/win_tcp_udp.zip\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">kash1064/Try2WinDbg</a></p>\n<h3 id=\"socketの中身を追う\" style=\"position:relative;\"><a href=\"#socket%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%82%92%E8%BF%BD%E3%81%86\" aria-label=\"socketの中身を追う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Socketの中身を追う</h3>\n<p>とりあえず最初の解析ターゲットとして、<code class=\"language-text\">socket</code>関数の挙動を追っていくことにします。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 550px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/31cf08774dc03bba6fb203b469fa0aae/dd45a/image-73.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpElEQVQoz42SW2/bMAyF/f9/0wqsW7J6bdM2bTDUaJpuXRbk4qtkWfL1G31BXraH0jgQLZHnkJS8LFO8vW04hYo4gTxv6U1rx26nBt+WhkjHlE1FJ1/b/YtugqcSzWuwJtznxCfJ7hhJdMP7Jh38oizJBR8x7/HPNZe/5lwfVnw//mQRbXjp1ix1wOz3SvxXlvkK/3jLk17xlAcS88x9+sxD1q+BrAFB8yJY4/mZz8Xxki/xgov9Dz7tVty1S67M3bB33z7im1s+hzO+plfMtc8su+FbuhgwS26YK59F/SBY4llbksQxKqs4HiA8jaWXrsHk1eT3MQlGG5zV1KWlMTVNXlPmDuf0eVSec44sS+UShPAIh31H00BVCaGZCGV+fUxhzJBcCmElhJUIWiHU8n+eodY52+2WOCo4SIVp2lHXcim2IgzNeClFJUKavSBJLW3bx7Q0PZoR9eR7xhRS2UGILNK5JI+1O1cTichYYU2SFCIqz0dE0t6PC9mzQ55Sbiio78izhZXEUA4cJ2lZqe5MojI3zbAbxBJBKm81ihi6+J/9BbP7rreQUFCPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/31cf08774dc03bba6fb203b469fa0aae/8ac56/image-73.webp 240w,\n/static/31cf08774dc03bba6fb203b469fa0aae/d3be9/image-73.webp 480w,\n/static/31cf08774dc03bba6fb203b469fa0aae/12b65/image-73.webp 550w\"\n              sizes=\"(max-width: 550px) 100vw, 550px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/31cf08774dc03bba6fb203b469fa0aae/8ff5a/image-73.png 240w,\n/static/31cf08774dc03bba6fb203b469fa0aae/e85cb/image-73.png 480w,\n/static/31cf08774dc03bba6fb203b469fa0aae/dd45a/image-73.png 550w\"\n            sizes=\"(max-width: 550px) 100vw, 550px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/31cf08774dc03bba6fb203b469fa0aae/dd45a/image-73.png\"\n            alt=\"image-73.png\"\n            title=\"image-73.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Ghidraのディスアセンブリ結果から<code class=\"language-text\">0xdf726e</code>にブレークポイントを設定し、<code class=\"language-text\">g</code>コマンドで処理を進めます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">> bu 0x00df726e\n> g</code></pre></div>\n<p><code class=\"language-text\">Step into</code>で<code class=\"language-text\">socket</code>関数の中に入ってみると、<code class=\"language-text\">Prolog</code>とついたオブジェクトを扱っているように見えます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5aa795fee13d8d07c18442c435645cfe/f058b/image-74.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABn0lEQVQoz42S2Y6bQBRE/f8/lNdR3iZKRhlLxpCAw05jFoON2emTC7YUZZ6mpVI1EpzuqsvO+fUV6/AF13lhbA3AZmgM/NNPutte/IVL9oOpN9CjyTKYm38UT98FocJxAnxfkeVX1jXPkJ7lnQkSVdK1M59dO9/3sCwT33MJZL8+N7c7SdIzDAPnTHGKUyw52AoTjD8Bpp9g+RFxFJLnGWWRo1RCXVcr0Md2bDzP25TnOW07oNKRZZy5BleOe8X315D9N8X7u+LtNeL4llKVlRx4pmnuTNMkyWZ2p9MJ0zQltk1RlI/Ik8YPevpuIJWbNWXNLatAfyKy4zgcjAOrn9OUrusY+gnX7eWmPUESUNQl2SWjnTq6sdt8WIatkqZpGMdxg2mtHx3atkR+9peeV+hInAzMw0IXCyBsubt36t81V+9Kday4uTfpunlW1P4Drr2tQF88DEMptpYuNFEsQ5Hp9qHcyu9AyReZ6CKKRMX/UVfYFjlVahvGCosimVwSUcjvE8UylHmhN6RLib+oBR1pdCYqRaFI6Q20wfQD+hcxwKsrrj13jwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/5aa795fee13d8d07c18442c435645cfe/8ac56/image-74.webp 240w,\n/static/5aa795fee13d8d07c18442c435645cfe/d3be9/image-74.webp 480w,\n/static/5aa795fee13d8d07c18442c435645cfe/8aab1/image-74.webp 630w\"\n              sizes=\"(max-width: 630px) 100vw, 630px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/5aa795fee13d8d07c18442c435645cfe/8ff5a/image-74.png 240w,\n/static/5aa795fee13d8d07c18442c435645cfe/e85cb/image-74.png 480w,\n/static/5aa795fee13d8d07c18442c435645cfe/f058b/image-74.png 630w\"\n            sizes=\"(max-width: 630px) 100vw, 630px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/5aa795fee13d8d07c18442c435645cfe/f058b/image-74.png\"\n            alt=\"image-74.png\"\n            title=\"image-74.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">Prolog</code>に関してはしばらく調べたものの該当しそうな情報が見つからなかったのでいったんスキップしました。</p>\n<p>誰か詳しい人いたら教えてください。。</p>\n<h3 id=\"作成されたソケット\" style=\"position:relative;\"><a href=\"#%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%81%9F%E3%82%BD%E3%82%B1%E3%83%83%E3%83%88\" aria-label=\"作成されたソケット permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>作成されたソケット</h3>\n<p>続いて、<code class=\"language-text\">socket</code>関数の直後の行を見てみます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 654px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2e2565f594cff149c4bdd1c3b1b05539/68e9c/image-75.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABu0lEQVQoz5WRW2/aUBCE+f+/pEoTpUoJhaioIEraB5KWVDTG+G7APjbgK8YX4OspeepjVxqd0e7qaGanpeoaijrHWbr8rdMZLLehbE5EScyRM/9TLeXHL2aTn/imyzEvSbwtyrNHYPpkwY7DNmUfxhSbhCJMLjwPIvIweuvLebFLycWOdB3SmnZumHaumXy84qn9npf7W14fOmj9O6bdG156Et1rnrtXTB7eMet/QB3eo3/toY0+YX7/jPmtj9pvo/ZuaZn6HabextA6bMSAbTDCW42heWJjDEiXYxJnTKgNEfoXEntEYo2JnEdi45FUQlgDhD/kWE9o6bqNKe1qmslq5XE8gmFUHIozwgkR9gbPDFhpPmtTIMwQV13jaCv0mYVnhSS7TN47I0sLeUPlFWWuyA8XNE1NU59YLkuqqsJ1HYJAUJYHqrJ8e6tS7jTUcl4UheT1v6HMVRVdN/g9m7FYqHLhjGUfqMsjkbUjMmUITk5mZeTLnL3ksRYTy368iMkMqSxISTIZzl4qtCwbx3FQFIUwDKTl80VhWdasvRVCSJtSpSd8PM+7KPYv8LFdm220vbgppYNaqv0Dgw5OWzAP3qIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2e2565f594cff149c4bdd1c3b1b05539/8ac56/image-75.webp 240w,\n/static/2e2565f594cff149c4bdd1c3b1b05539/d3be9/image-75.webp 480w,\n/static/2e2565f594cff149c4bdd1c3b1b05539/d7085/image-75.webp 654w\"\n              sizes=\"(max-width: 654px) 100vw, 654px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2e2565f594cff149c4bdd1c3b1b05539/8ff5a/image-75.png 240w,\n/static/2e2565f594cff149c4bdd1c3b1b05539/e85cb/image-75.png 480w,\n/static/2e2565f594cff149c4bdd1c3b1b05539/68e9c/image-75.png 654w\"\n            sizes=\"(max-width: 654px) 100vw, 654px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2e2565f594cff149c4bdd1c3b1b05539/68e9c/image-75.png\"\n            alt=\"image-75.png\"\n            title=\"image-75.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">socket</code>関数は、作成したSocketを指すファイルディスクリプタを戻り値として返します。</p>\n<p>EAXレジスタの中身を見てみると以下の値が格納されていました。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">> r eax\neax=00000150</code></pre></div>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-socket\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">socket function (winsock2.h) - Win32 apps | Microsoft Docs</a></p>\n<p>このファイルディスクリプタを指すハンドルはTTDでは拾うことができませんが、ライブデバッグを行うと<code class=\"language-text\">!handle</code>コマンドで参照することができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">> r eax\neax=00000108\n\n> <span class=\"token operator\">!</span>handle 108 f\nHandle 108\n  <span class=\"token function\">Type</span>         \tFile\n  Attributes   \t0\n  GrantedAccess\t0x16019f:\n         ReadControl<span class=\"token punctuation\">,</span>WriteDac<span class=\"token punctuation\">,</span>Synch\n         Read/List<span class=\"token punctuation\">,</span><span class=\"token function\">Write</span><span class=\"token operator\">/</span>Add<span class=\"token punctuation\">,</span>Append/SubDir/CreatePipe<span class=\"token punctuation\">,</span>ReadEA<span class=\"token punctuation\">,</span>WriteEA<span class=\"token punctuation\">,</span>ReadAttr<span class=\"token punctuation\">,</span>WriteAttr\n  HandleCount  \t2\n  PointerCount \t65534\n  No Object Specific Information available</code></pre></div>\n<p>ファイルオブジェクトの中身も見ようと思ったら多分カーネルデバッグを仕掛けないとだめなのかな？（たぶん）</p>\n<h3 id=\"sockaddr_in構造体を読む\" style=\"position:relative;\"><a href=\"#sockaddr_in%E6%A7%8B%E9%80%A0%E4%BD%93%E3%82%92%E8%AA%AD%E3%82%80\" aria-label=\"sockaddr_in構造体を読む permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>sockaddr_in構造体を読む</h3>\n<p>次に解析するのはソースコードでいうと以下の箇所です。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr_in</span> dstAddr<span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>dstAddr<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>dstAddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndstAddr<span class=\"token punctuation\">.</span>sin_port <span class=\"token operator\">=</span> <span class=\"token function\">htons</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndstAddr<span class=\"token punctuation\">.</span>sin_family <span class=\"token operator\">=</span> AF_INET<span class=\"token punctuation\">;</span>\ndstAddr<span class=\"token punctuation\">.</span>sin_addr<span class=\"token punctuation\">.</span>s_addr <span class=\"token operator\">=</span> <span class=\"token function\">inet_addr</span><span class=\"token punctuation\">(</span>destination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">sockaddr_in</code>のメモリ領域を確保して、ポート番号、アドレスファミリ、IPアドレスをセットしています。</p>\n<p><code class=\"language-text\">sockaddr_in</code>構造体は以下の構造になっています。</p>\n<p><code class=\"language-text\">in_addr</code>構造体には4バイトでIPv4アドレスが格納されます。</p>\n<p><code class=\"language-text\">sin_zero</code>はシステムに予約された領域で、すべて0埋めされます。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr_in</span> <span class=\"token punctuation\">{</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></span></span>\n  <span class=\"token keyword\">short</span>          sin_family<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span>\n  ADDRESS_FAMILY sin_family<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span>\n  USHORT         sin_port<span class=\"token punctuation\">;</span>\n  IN_ADDR        sin_addr<span class=\"token punctuation\">;</span>\n  CHAR           sin_zero<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> SOCKADDR_IN<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PSOCKADDR_IN<span class=\"token punctuation\">;</span></code></pre></div>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/ws2def/ns-ws2def-sockaddr_in\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SOCKADDR_IN (ws2def.h) - Win32 apps | Microsoft Docs</a></p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/winsock2/ns-winsock2-in_addr\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">in_addr (winsock2.h) - Win32 apps | Microsoft Docs</a></p>\n<p>ちなみに、<code class=\"language-text\">sin_port</code>と<code class=\"language-text\">sin_addr</code>にはネットワークバイトオーダの値を入れる必要があるため、ソースコードでは<code class=\"language-text\">htons</code>関数と<code class=\"language-text\">inet_addr</code>関数を使用しています。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-htons\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">htons function (winsock.h) - Win32 apps | Microsoft Docs</a></p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-inet_addr\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">inet_addr function (winsock2.h) - Win32 apps | Microsoft Docs</a></p>\n<p>解析対象の構造がおおむね確認できたところで、<code class=\"language-text\">memset</code>関数の呼び出し後のアドレス<code class=\"language-text\">0xdf7227</code>にブレークポイントを設定します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 543px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/573d26875a221e470c21f73fe4403d2f/29579/image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACr0lEQVQ4y02Te28bRRTF/f0/CRISBUpV8QcUEdLQhkCT5lGnjuOs196H9/3emfX+etaGhlldzazmzpl7zrkzM9YyjiPexsN1XeLI0LYcRmtGnPc/4NzfMg5QlxFNFdLUDduyxa86dpoHc8xnhNkREPytj+f5JMmA70En0M4Y1p9vuFte43U+909zxR2fwg238Q2L7COL8hqnWpKSkeg7AE6jLErKsiBN9wIcsWaq0LK5fsf5w1su7Qdu/Rdcbb/hoviF8+Q3/i5O+CO+4NfojJPyhMvh6r8KR1zHZb1eEyeWLDsyaHqLM/+As1wyThfUoWKDaQKKJKfOW4rU6h/6rgfJMhvs/nA4S3OyOCXe7XlaCqwEoz3n5h3LxZyu7wmCmO02ZLcreHIsy6Vl5VRsooogb/CygFlhK9pBIvsu7m5DkNUkdUdlW3LT4fz5Hav5R3o7kGc6JH093xDlGWVVsd/vMVOMe6yYzt50p/zenPDafcXL8Gde+mf8uJEu7Smn7T+s3n/P47+AWdqzepK7fksYtarU0jSWsjY0kq42PTPfiMIYcxfMJfodi3jH7TbF6yMCm+GcfasKrzDDSN/XqjIll3ZpmmidUBQZTTfQCrAfBmajHQ8aVmlFmRaUMiTYINE59OP64jWr+xtpaAXUieLUdFKfabbH5vvf+OpyGISEYUAUWYpyqmak0s3OX69E+RorneJ45GEBWxc2Cr0D5UuCuCZV4+6a9rkP00QOx7GoWGkztYFikOPnP6lCAYpy23S6uGAXyn1H5ni9zpQ40tSTmVmdPwMWeSFK6vZ4UEtM/1MfDriXb3jU0+uV13VWLyk+6BiGhl3UyJRBjAbpaHVp8wxYldKwLOXkoOQjYCX3HlYPPK5WGD3D/X7UvtF+rcoqzblMEVWtt3FLVBq+AOqF2CDCCgFdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/573d26875a221e470c21f73fe4403d2f/8ac56/image.webp 240w,\n/static/573d26875a221e470c21f73fe4403d2f/d3be9/image.webp 480w,\n/static/573d26875a221e470c21f73fe4403d2f/4b567/image.webp 543w\"\n              sizes=\"(max-width: 543px) 100vw, 543px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/573d26875a221e470c21f73fe4403d2f/8ff5a/image.png 240w,\n/static/573d26875a221e470c21f73fe4403d2f/e85cb/image.png 480w,\n/static/573d26875a221e470c21f73fe4403d2f/29579/image.png 543w\"\n            sizes=\"(max-width: 543px) 100vw, 543px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/573d26875a221e470c21f73fe4403d2f/29579/image.png\"\n            alt=\"image.png\"\n            title=\"image.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ここで<code class=\"language-text\">memset</code>関数の戻り値を確認すると、確保されたアドレスが<code class=\"language-text\">0x55d810</code>から始まることがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">> r eax\neax=0055d810</code></pre></div>\n<p>メモリアドレスを見てみると16バイト分の領域に値がセットされているように見えます。</p>\n<p><code class=\"language-text\">sockaddr_in</code>構造体は、ポートとアドレスファミリの領域にそれぞれ2バイトずつ、IPアドレスに4バイト、システム予約領域に8バイトを使用します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 517px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/96374987ee5c17149aca7c34d5cbca5d/fa2f5/image-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABLUlEQVQY0z1Q2XKDMAzk/7+pR6ZpmplCOGxjbgwEQogh6R9sJWcmDzuWtdJKKy/LMhy+D+D3FIbY77+QJAmapkFRFOj7HmVZoqprdF3nch3l7vc7tnXFtm0vPB5/8LTOcDz+QKUaDTUFQYCcxFnUxXmOkAZFceyG+r6PnESHoXfiVVU5lARrN3hCCOx2nwijGD1tIKUk4ed2aZqiaVsnlGU5WtpaKQVjOudAiMT9FfVIJXG7rfCKoqSpv9DUNJCVVGu0JMJTWcgY48S5zpgWmni2zMOZf3JPuA2jKMLH+xv84ERCDW0avbZj23w/SS6kVC6OyXpNp6nrysVCCrBLxrJYeOM4USHf5Ix1tRjHkYgF8zxjmiayccPlciHMFC+Ot9bCUp555vjl+ut8xT8XoqsBy1ipXAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/96374987ee5c17149aca7c34d5cbca5d/8ac56/image-1.webp 240w,\n/static/96374987ee5c17149aca7c34d5cbca5d/d3be9/image-1.webp 480w,\n/static/96374987ee5c17149aca7c34d5cbca5d/7f59e/image-1.webp 517w\"\n              sizes=\"(max-width: 517px) 100vw, 517px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/96374987ee5c17149aca7c34d5cbca5d/8ff5a/image-1.png 240w,\n/static/96374987ee5c17149aca7c34d5cbca5d/e85cb/image-1.png 480w,\n/static/96374987ee5c17149aca7c34d5cbca5d/fa2f5/image-1.png 517w\"\n            sizes=\"(max-width: 517px) 100vw, 517px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/96374987ee5c17149aca7c34d5cbca5d/fa2f5/image-1.png\"\n            alt=\"image-1.png\"\n            title=\"image-1.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>このまま処理を進めていくと、空だったメモリの領域にポート番号、アドレスファミリ、IPアドレスが設定されました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 496px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/28807a629a0e13d12b351cd801596f5c/bb630/image-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABG0lEQVQY01WR246DMAxE+f+PW4rEnVYQCBAuCS1U7bbqdtY26kMfRrHI2HMcPN3USLMcwzBA6wZBECAvjrher1iWBeu6Yp5nDOOIxTnxGWPw+3jg9Xrhfr/h8Xzi/X7jj+SlaYIf30dxPGKipjAMUVUVmqZBEsdSn04n+h6hrmtkaYooiuDcgq7rUJWleBlG6xZeVZWIkwRK1bhcLmKapgnWWqlnOh2p740Qj+MglLyBoZM9rLZt0fU9vDzP4B8OKIqCUi1KSmQDN3Hdk8mYXkhH2oBplFISzkO4ZnIR3XmMvBMqnM9nwtbSyO/GNdOyuNlaB0MBHLht2xehiAk/A0siWL9WdvvKNNjaWUj53T4/hVfm4H0Ds4vu/gFdE7teJSikEQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/28807a629a0e13d12b351cd801596f5c/8ac56/image-2.webp 240w,\n/static/28807a629a0e13d12b351cd801596f5c/d3be9/image-2.webp 480w,\n/static/28807a629a0e13d12b351cd801596f5c/6f16c/image-2.webp 496w\"\n              sizes=\"(max-width: 496px) 100vw, 496px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/28807a629a0e13d12b351cd801596f5c/8ff5a/image-2.png 240w,\n/static/28807a629a0e13d12b351cd801596f5c/e85cb/image-2.png 480w,\n/static/28807a629a0e13d12b351cd801596f5c/bb630/image-2.png 496w\"\n            sizes=\"(max-width: 496px) 100vw, 496px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/28807a629a0e13d12b351cd801596f5c/bb630/image-2.png\"\n            alt=\"image-2.png\"\n            title=\"image-2.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>このままだと少しわかりづらいので表示を変えてみました。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">> dyb 0055d810\n          76543210 76543210 76543210 76543210\n          <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span>\n0055d810  00000010 00000000 00000000 01010000  02 00 00 50\n0055d814  10101001 11111110 01100100 00011110  a9 fe 64 1e\n0055d818  00000000 00000000 00000000 00000000  00 00 00 00\n0055d81c  00000000 00000000 00000000 00000000  00 00 00 00</code></pre></div>\n<p>ポート番号80が<code class=\"language-text\">0x0050</code>とネットワークバイトオーダ（ビッグエンディアン）形式で格納されています。</p>\n<p>また、<code class=\"language-text\">0x55d814</code>からの4バイトは、IPアドレスが同じくネットワークバイトオーダで格納されています。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>年の瀬にソケットプログラミングとリバーシングなどをしてました。</p>\n<p>来年も良い年になるとよいですね。</p>","fields":{"slug":"/windows-windbg-010-socket","tagSlugs":["/tag/win-dbg/","/tag/kernel/","/tag/reversing/","/tag/c-c/"]},"frontmatter":{"date":"2022-01-01","description":"","tags":["WinDbg","Kernel","Reversing","C/C++"],"title":"Windows SocketsでTCP通信とUDP通信を実装したプログラムをリバーシングしてみる","socialImage":{"publicURL":"/static/5c0b851ce6b11ba9ab8d74d12a5a4a1b/windows-windbg-010-socket.png"}}}},"pageContext":{"slug":"/windows-windbg-010-socket"}},"staticQueryHashes":["251939775","401334301","825871152"]}