{"componentChunkName":"component---src-templates-post-template-js","path":"/windows-windriver-001-tutorial","result":{"data":{"markdownRemark":{"id":"d5cff4c8-e048-5e15-a850-724191befadc","html":"<p>Windowsのカーネルデバッグを試す上で壁になったのが、詳細な仕様が公開されているカーネルドライバが少ないという壁にぶつかりました。</p>\n<p>なければ作ってしまおう、と思いカーネルドライバの開発を始めました。</p>\n<p>カーネルドライバの開発にあたっては、基本的に以下の書籍を参考にしつつ進めてます。</p>\n<p>参考：<a href=\"https://amzn.to/3H3WMoe\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Windowsカーネルドライバプログラミング</a></p>\n<p>カーネルデバッグの設定方法については以下の記事でまとめてあります。</p>\n<p>参考：<a href=\"/windows-windbg-004-kernel-debug\">WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩</a></p>\n<!-- omit in toc -->\n<h2 id=\"もくじ\" style=\"position:relative;\"><a href=\"#%E3%82%82%E3%81%8F%E3%81%98\" aria-label=\"もくじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もくじ</h2>\n<ul>\n<li>\n<p><a href=\"#%E6%9C%80%E5%88%9D%E3%81%AE%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E4%BD%9C%E3%82%8B\">最初のドライバを作る</a></p>\n<ul>\n<li><a href=\"#wdm%E3%81%A8%E3%81%AF\">WDMとは</a></li>\n<li><a href=\"#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%B3%E3%83%BC%E3%83%89\">シンプルなコード</a></li>\n<li><a href=\"#driverentry\">DriverEntry</a></li>\n<li><a href=\"#firstdriverunload\">FirstDriverUnload</a></li>\n<li><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89\">システムスレッド（カーネルモードシステムスレッド）</a></li>\n<li><a href=\"#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B\">ドライバをビルドする</a></li>\n<li><a href=\"#%E5%AF%BE%E8%B1%A1%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E8%A8%AD%E5%AE%9A\">対象プラットフォームの設定</a></li>\n<li><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B\">カーネルドライバをロードする</a></li>\n<li><a href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%81%9C%E6%AD%A2%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E5%95%8F%E9%A1%8C\">サービスの停止ができない問題</a></li>\n<li><a href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E5%86%8D%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E3%81%99%E3%82%8B\">サービスを再読み込みする</a></li>\n<li><a href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E7%A2%BA%E8%AA%8D\">サービスの確認</a></li>\n<li><a href=\"#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%8C%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D\">ドライバがシステムに読み込まれていることを確認</a></li>\n<li><a href=\"#kdprint%E3%83%9E%E3%82%AF%E3%83%AD%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\">KdPrintマクロを追加する</a></li>\n<li><a href=\"#debugview%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\">DebugViewを設定する</a></li>\n</ul>\n</li>\n<li><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E8%87%AA%E4%BD%9C%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\">カーネルデバッグで自作ドライバを解析してみる</a></li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>\n<h2 id=\"最初のドライバを作る\" style=\"position:relative;\"><a href=\"#%E6%9C%80%E5%88%9D%E3%81%AE%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E4%BD%9C%E3%82%8B\" aria-label=\"最初のドライバを作る permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>最初のドライバを作る</h2>\n<p>とりあえず最初のドライバを作っていきます。</p>\n<p>VisualStudioからWDMプロジェクトを作成します。</p>\n<p>この時、本記事を執筆した2021/12/01時点では、VisualStudio 2022はカーネルドライバの開発に非対応でした。</p>\n<p>そのため、VisualStudio 2022以降にアップデートしていると、WDMプロジェクトを作成することができませんので注意が必要です。</p>\n<p>今回はVisualStudio 2019を使用しています。</p>\n<h3 id=\"wdmとは\" style=\"position:relative;\"><a href=\"#wdm%E3%81%A8%E3%81%AF\" aria-label=\"wdmとは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WDMとは</h3>\n<p>WDMは<code class=\"language-text\">Microsoft Windows Driver Model</code>の略称で、Windows 2000以降のデバイスドライバーのアーキテクチャです。</p>\n<p>現在では非推奨のドライバモデルです。</p>\n<p>現在カーネルドライバを作成する場合は、<code class=\"language-text\">Windows Driver Foundation(WDF)</code>かユニバーサルWindowsドライバが主流になっているのかな？</p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/introduction-to-wdm\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">WDM の概要 - Windows drivers | Microsoft Docs</a></p>\n<p>WDMドライバには、以下の3つの種類があります。</p>\n<ul>\n<li>bus driver</li>\n<li>function driver</li>\n<li>filter drivers</li>\n</ul>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/bus-drivers\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bus Drivers - Windows drivers | Microsoft Docs</a></p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/function-drivers\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Function Drivers - Windows drivers | Microsoft Docs</a></p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/filter-drivers\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Filter Drivers - Windows drivers | Microsoft Docs</a></p>\n<h3 id=\"シンプルなコード\" style=\"position:relative;\"><a href=\"#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%B3%E3%83%BC%E3%83%89\" aria-label=\"シンプルなコード permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>シンプルなコード</h3>\n<p>VisualStudioでWDMプロジェクトを作成したら、適当な名前のC++ソースファイルを追加して以下のコードを追加します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c++\"><pre class=\"language-c++\"><code class=\"language-c++\">#include &lt;ntddk.h&gt;\n\nvoid FirstDriverUnload(_In_ PDRIVER_OBJECT DriverObject)\n{\n\tUNREFERENCED_PARAMETER(DriverObject);\n}\n\nextern &quot;C&quot;\nNTSTATUS\nDriverEntry(_In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath)\n{\n\tUNREFERENCED_PARAMETER(DriverObject);\n\tUNREFERENCED_PARAMETER(RegistryPath);\n\n\treturn STATUS_SUCCESS;\n}</code></pre></div>\n<h3 id=\"driverentry\" style=\"position:relative;\"><a href=\"#driverentry\" aria-label=\"driverentry permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DriverEntry</h3>\n<p><code class=\"language-text\">DriverEntry</code>は、ドライバモジュールのエントリポイントになります。</p>\n<p><code class=\"language-text\">DriverEntry</code>は、システムスレッド（カーネルモードシステムスレッド）から<code class=\"language-text\">IRQL_PASSIVE_LEVEL(0)</code>のIRQLで呼び出されます。</p>\n<h3 id=\"firstdriverunload\" style=\"position:relative;\"><a href=\"#firstdriverunload\" aria-label=\"firstdriverunload permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FirstDriverUnload</h3>\n<p><code class=\"language-text\">FirstDriverUnload</code>は、ドライバのアンロードルーチンを定義します。</p>\n<p>関数名は<code class=\"language-text\">FirstDriverUnload</code>以外に変更しても問題ありません。</p>\n<p>上記のサンプルコードではまだ定義されていませんが、<code class=\"language-text\">DriverObject</code>の<code class=\"language-text\">DriverUnload</code>に指定することでドライバモジュールのアンロード時に呼び出す関数を定義します。</p>\n<div class=\"gatsby-highlight\" data-language=\"c++\"><pre class=\"language-c++\"><code class=\"language-c++\">// アンロードルーチンを定義\nDriverObject-&gt;DriverUnload = FirstDriverUnload;</code></pre></div>\n<p>カーネルドライバの場合はアンロードされるタイミングでメモリリソースなどの解放が必要となるため、このアンロードルーチンでクリーンアップの処理を定義します。</p>\n<h3 id=\"システムスレッドカーネルモードシステムスレッド\" style=\"position:relative;\"><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%83%BC%E3%83%89%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89\" aria-label=\"システムスレッドカーネルモードシステムスレッド permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>システムスレッド（カーネルモードシステムスレッド）</h3>\n<p>システムプロセス(プロセスID 4)が実行しているスレッドがシステムスレッドであり、カーネルモードで実行されています。</p>\n<p>システムスレッドは、<code class=\"language-text\">Ntoskrnl.exe</code>か、ロードされているデバイスドライバのカーネルモードコードを実行します。</p>\n<p>参考：<a href=\"https://amzn.to/3ei56Eg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">インサイドWindows 第7版 上</a></p>\n<h3 id=\"ドライバをビルドする\" style=\"position:relative;\"><a href=\"#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B\" aria-label=\"ドライバをビルドする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ドライバをビルドする</h3>\n<p>最低限のコードが作成できたらカーネルドライバをビルドします。</p>\n<p>とりあえずデバッグビルドで作成するので、[Ctrl+Shift+B]を押してビルドします。</p>\n<h3 id=\"対象プラットフォームの設定\" style=\"position:relative;\"><a href=\"#%E5%AF%BE%E8%B1%A1%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-label=\"対象プラットフォームの設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>対象プラットフォームの設定</h3>\n<p>今回はx64環境向けのドライバモジュールをビルドするので、VisualStudioのプロジェクトのプロパティから、[アクティブソリューションプラットフォーム]の設定を[x64]にしておきます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 944px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e5202bb713f0239c106e61aa9276e9d5/966a0/image-58.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACu0lEQVQ4y41TS08TURSeH0DCig1pEDCgCa8N/gckboj/g3/QhQsXmCBuCW4AY4GakCBqQmq7wIUYQyAQGzt9t9PpPDswnU6ffJ5zSxF1gTf55t5z7z3f+c45d6Sjo68wDB2ZTAalUgmapkHX9S5orWllFItFcVYul6+hIpfLwbYs7O3tIRAIYGhoSEA6PPyCRCKJH/GfKCoqlJKKhJxCLl+EbljQdBPZXAH5AtsmDNOiYCYy2TzsioP9/Q9/Eh59+w45mSEyDWXNIgcHqXSOnG20r4BWB3A9n85L8Go+rmivQ2jzh0Y0GsXg4OBvwtPTU1gk3TRNeF4VFeeS0skLu9lsCifHcaAoCkxS6DgX6HQ6aLXb4iwWiwmikZERDA8PQzo5OYGqqqJOruvi4tKFnJCRTKZQI0U8DN3A+fk54vG4qCWTtVotcXZwcIC+vj709/djYGCgS6gQWbGowPd9UmYhm82iQvVhhfV6XQSybRuXFKy3x3fbRJxOp7G6uoqNjQ0sLi5eE1I6CVJlWbZQyx0vFAqQZVnYvZIYhoF8Pn8DDsyvwa/VhNpwONytIW/26laiLnNqqVRGOMly8tpOdUGKVLUsyFV6QjqVI0PErlvF+vo6KSRCll6jKAyNyPmtsVpOrd3uiCC8V6lUUKJuswAuAZeCfbhRPLa2tiEdHx+LzW6NuMNZkSJ3lgkYvO7Zf695Zl9u0ubmG0hnZ2eoVquCxPM8kTZDXL7lfJvg9ppn9u0SbkIKBoNYWXmF5eWXWFp6gbW11/843wUm5O6HQiFIY2MPMTo6Bp4DgXuYn39ykwZf5PkuWJRRq9lAeGcH0uTkNKamZjAxMUXE97Gw8BSNRlO8s/9Bve7DvnDhNq4Q2n4HaXb2ERjT0zMYH3+AubnH4neKRCKEz3cgglj0M3bff8Lb3Y8IPnuOX6ZgBqT8x/wCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e5202bb713f0239c106e61aa9276e9d5/8ac56/image-58.webp 240w,\n/static/e5202bb713f0239c106e61aa9276e9d5/d3be9/image-58.webp 480w,\n/static/e5202bb713f0239c106e61aa9276e9d5/59b61/image-58.webp 944w\"\n              sizes=\"(max-width: 944px) 100vw, 944px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e5202bb713f0239c106e61aa9276e9d5/8ff5a/image-58.png 240w,\n/static/e5202bb713f0239c106e61aa9276e9d5/e85cb/image-58.png 480w,\n/static/e5202bb713f0239c106e61aa9276e9d5/966a0/image-58.png 944w\"\n            sizes=\"(max-width: 944px) 100vw, 944px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e5202bb713f0239c106e61aa9276e9d5/966a0/image-58.png\"\n            alt=\"image-58.png\"\n            title=\"image-58.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ここがデフォルトの設定のままだとx86環境向けのドライバモジュールがビルドされるので、64bit Windowsで起動しようとしても失敗する問題が発生します。</p>\n<h3 id=\"カーネルドライバをロードする\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B\" aria-label=\"カーネルドライバをロードする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カーネルドライバをロードする</h3>\n<p>ドライバのビルドができたら、ビルドしたドライバモジュールを仮想マシンの<code class=\"language-text\">Z:\\FirstDriverSample.sys</code>として配置します。</p>\n<p>※ここは任意のフォルダ、ドライバ名でOKです。</p>\n<p>次に<code class=\"language-text\">sc</code>コマンドで、作成したドライバを<code class=\"language-text\">001_sample</code>サービスとしてロードします。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">sc</span> create 001_sample <span class=\"token function\">type</span>= kernel binPath= Z:\\FirstDriverSample<span class=\"token punctuation\">.</span>sys</code></pre></div>\n<p>成功すると次のような画面になり、レジストリの<code class=\"language-text\">HKLM\\SYSTEM\\CurrentControlSet\\Services</code>配下に追加したサービスが登録されています。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/817cd8b424ed771b6a711b20326e9a20/0b533/image-22.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAARlAAAEZQAGA43XUAAAB0UlEQVQ4y6WT227aMBzGzVFI3PCa3WWhWqXuMRBQngEhTm+wabftzS4mrQu0FMg5ThwnDShfbUOAbhdNN0u/+PT35892/uTHwyNWax2rjSkwYFo2TNOC7XhwPQrHFTUNBD4c2xFjvupTAfMDBJQqvEMs8cTH1h/w/LzE0+JRiJlYLpciwFNtxhg45+BhuK8FcRz/xXa7xW63A+FxAk7nMA0dtu1DFrk4TVPhguIjRa4hjMdgrgbLMvH123f0bm/R7/fR6/UUWbvb7R7pdDpHZL/dbkPTNCVKQh4hcH7D9yk+X1+DEIJ6vY5yuYxKpaJqOfYek8lkL8gPgowFuLn5okQajQZqtRpKpZJCimYb/Em1WlWCs9ns5JBav8SlJmi1rtSkDMzj6pzpdHoSdI2f4vVCNJstNVksFnMLFQqFt4Is5OpRkiTG5WVTTcpj/rNgKP4reeQ45keH8r5kYB6y05zd4d5hFHFcXHz68N1ljMfjg6A8sqdB1ze4u7vHYDBQk6PRKDfD4RDr9frkMPKfYBgb/G9RmSLzMPTmIu0svLwkKh+zvMyLjJdiyqEU5P5CWF6Jl94ed8oCkOa1t6+I4zqgzgKLuXyY6K1gehb8Hoe4V6zTlknLrnNnAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/817cd8b424ed771b6a711b20326e9a20/8ac56/image-22.webp 240w,\n/static/817cd8b424ed771b6a711b20326e9a20/d3be9/image-22.webp 480w,\n/static/817cd8b424ed771b6a711b20326e9a20/b0a15/image-22.webp 500w\"\n              sizes=\"(max-width: 500px) 100vw, 500px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/817cd8b424ed771b6a711b20326e9a20/8ff5a/image-22.png 240w,\n/static/817cd8b424ed771b6a711b20326e9a20/e85cb/image-22.png 480w,\n/static/817cd8b424ed771b6a711b20326e9a20/0b533/image-22.png 500w\"\n            sizes=\"(max-width: 500px) 100vw, 500px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/817cd8b424ed771b6a711b20326e9a20/0b533/image-22.png\"\n            alt=\"image-22.png\"\n            title=\"image-22.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>次に、追加したサービスを起動します。</p>\n<p><code class=\"language-text\">sc start 001_sample</code>コマンドを実行すると、起動に失敗します。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">> <span class=\"token function\">sc</span> <span class=\"token function\">start</span> 001_sample\n<span class=\"token namespace\">[SC]</span> StartService FAILED 1275:\nこのドライバーの読み込みはブロックされています</code></pre></div>\n<p>これは、64bitのシステムドライバには署名が必要なのに対して、自分で作成したドライバには署名が付与されていないためです。</p>\n<p>このエラーを回避するため、ドライバを検証する仮想マシンをテスト署名モードで起動します。</p>\n<p>以下のコマンドを実行し、再起動すればOKです。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">bcdedit <span class=\"token operator\">/</span><span class=\"token function\">set</span> testsigning on</code></pre></div>\n<p>※ OSを再起動するまで、テスト署名モードには移行しません。</p>\n<p>※ セキュアブート環境の場合、テスト署名モードへの移行に失敗します。</p>\n<p>再起動には、管理者権限で起動したコマンドプロンプトで以下のコマンドを実行します。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">shutdown <span class=\"token operator\">/</span>r <span class=\"token operator\">/</span>t 0</code></pre></div>\n<p>再起動後、再びサービス起動を実行すると、登録したサービスが起動しました。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">> <span class=\"token function\">sc</span> <span class=\"token function\">start</span> 001_sample\nSERVICE_NAME: sample\n        <span class=\"token function\">TYPE</span>               : 1  KERNEL_DRIVER\n        STATE              : 4  RUNNING\n                                <span class=\"token punctuation\">(</span>STOPPABLE<span class=\"token punctuation\">,</span> NOT_PAUSABLE<span class=\"token punctuation\">,</span> IGNORES_SHUTDOWN<span class=\"token punctuation\">)</span>\n        WIN32_EXIT_CODE    : 0  <span class=\"token punctuation\">(</span>0x0<span class=\"token punctuation\">)</span>\n        SERVICE_EXIT_CODE  : 0  <span class=\"token punctuation\">(</span>0x0<span class=\"token punctuation\">)</span>\n        CHECKPOINT         : 0x0\n        WAIT_HINT          : 0x0\n        PID                : 0\n        FLAGS              :</code></pre></div>\n<p>次はサービスの停止を実行します。</p>\n<h3 id=\"サービスの停止ができない問題\" style=\"position:relative;\"><a href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%81%9C%E6%AD%A2%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E5%95%8F%E9%A1%8C\" aria-label=\"サービスの停止ができない問題 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>サービスの停止ができない問題</h3>\n<p>ここまでのドライバモジュールでサービスの停止を実行しようとしても、停止に失敗します。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">> <span class=\"token function\">sc</span> stop 001_sample\n<span class=\"token namespace\">[SC]</span> ControlService FAILED 1052:s\n要求された制御はこのサービスに対して無効です。</code></pre></div>\n<p>また、ProcessHackerなどのツールを利用してサービスの停止を実行しても同様になります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c18158a0b8a4ca06a2913b1f95005dbb/2bef9/image-62-1024x756.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACN0lEQVQ4y31UibKiMBDk/39vtZ6CgCI3yH2K2K8niKuutamaIoFJz9E9aHESoW1b1HVNazAMA263m7J5njHxeb/f8brkvJr4jeOI6/WKoiyh/ex+EHgubMuGYRyQpimyS4YwDBFFMZIkwSWJkeU56qpGyUsSvOs6ZVVVIYkT5Pzu+QG0zeYPL6UKYL/f8xkhjmMEQUDAiM4xLMuCruvqXVEU6PteZScViK0VSHDNsk3WAOXkMVOJNk0TekZvmqUFASOHYUCfAd/WCijBNJ1ZSeoCeDgcVBayF1tL830fruuq8j57uNoCyB7q+l41tetaOCcHRV6gI0lNXSmAllm65zNOpyP7VyyALPOToGeGe8NQDEkmlmnhzMt+lCDKS5RVg7YbkF5yxOkFddvhOs3ox0ntIWCfJVtkV/qkANl81/ORkd3+sEPbL+8bybhpKa+lr1JRw0DzI9M3QIPsSbNFiwklI0vk0VGf4zjwW6cIEuCRgWsCe0mBOKueQO+kUHsqQwIe7aPSU8lLYZrBMG04roejc4Z1PPFswT772Jou/CT/3sOdbpKIXGVgsJ/CqOyFYds+KY16nkdSHEQPSf3N7AugyagC0LaNIkUui0Tko1hD4EBkQ7K+yebfHpomqpIS4Ug5joM8y5+6FEGX1FbE6VmE3VMRo2rRK/A8v5ZMYTePn4Jt22pSREYTLWW5wqoAi5xk/78lc65ttxvl7LHMdVJklmW2JaI4xdFyznlulYSaN1snSnx+Ae3/e/VyADnqAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/c18158a0b8a4ca06a2913b1f95005dbb/8ac56/image-62-1024x756.webp 240w,\n/static/c18158a0b8a4ca06a2913b1f95005dbb/d3be9/image-62-1024x756.webp 480w,\n/static/c18158a0b8a4ca06a2913b1f95005dbb/e46b2/image-62-1024x756.webp 960w,\n/static/c18158a0b8a4ca06a2913b1f95005dbb/a9a89/image-62-1024x756.webp 1024w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/c18158a0b8a4ca06a2913b1f95005dbb/8ff5a/image-62-1024x756.png 240w,\n/static/c18158a0b8a4ca06a2913b1f95005dbb/e85cb/image-62-1024x756.png 480w,\n/static/c18158a0b8a4ca06a2913b1f95005dbb/d9199/image-62-1024x756.png 960w,\n/static/c18158a0b8a4ca06a2913b1f95005dbb/2bef9/image-62-1024x756.png 1024w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/c18158a0b8a4ca06a2913b1f95005dbb/d9199/image-62-1024x756.png\"\n            alt=\"image-62-1024x756.png\"\n            title=\"image-62-1024x756.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これは、前述したアンロードルーチンをデバイスドライバに実装していないことに起因します。</p>\n<p>参考：<a href=\"https://proc-cpuinfo.fixstars.com/2017/06/windows-device-driver-1/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Windowsデバイスドライバの基本動作を確認する (1) - Fixstars Tech Blog /proc/cpuinfo</a></p>\n<p>そのため、コードを以下のように修正しました。</p>\n<div class=\"gatsby-highlight\" data-language=\"c++\"><pre class=\"language-c++\"><code class=\"language-c++\">#include &lt;ntddk.h&gt;\n\nvoid FirstDriverUnload(_In_ PDRIVER_OBJECT DriverObject)\n{\n\tUNREFERENCED_PARAMETER(DriverObject);\n}\n\nextern &quot;C&quot;\nNTSTATUS\nDriverEntry(_In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath)\n{\n\tUNREFERENCED_PARAMETER(RegistryPath);\n\n    // アンロードルーチンを定義\n\tDriverObject-&gt;DriverUnload = FirstDriverUnload;\n\n\treturn STATUS_SUCCESS;\n}</code></pre></div>\n<p>これでデバイスドライバを再読み込みし、サービスを起動した後に<code class=\"language-text\">sc stop 001_sample</code>コマンドを実行すると、サービスが停止できるようになりました。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">> <span class=\"token function\">sc</span> stop 001_sample\nSERVICE_NAME: 001_sample\n        <span class=\"token function\">TYPE</span>               : 1  KERNEL_DRIVER\n        STATE              : 1  STOPPED\n        WIN32_EXIT_CODE    : 0  <span class=\"token punctuation\">(</span>0x0<span class=\"token punctuation\">)</span>\n        SERVICE_EXIT_CODE  : 0  <span class=\"token punctuation\">(</span>0x0<span class=\"token punctuation\">)</span>\n        CHECKPOINT         : 0x0\n        WAIT_HINT          続いて、サービスの確認を行います。</code></pre></div>\n<h3 id=\"サービスを再読み込みする\" style=\"position:relative;\"><a href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E5%86%8D%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E3%81%99%E3%82%8B\" aria-label=\"サービスを再読み込みする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>サービスを再読み込みする</h3>\n<p>サービスの再読み込みのためには、一度登録していたサービスを削除する必要があります。</p>\n<p>以下のコマンドでサービスの削除と再登録が可能なので、これを<code class=\"language-text\">reload.bat</code>などの適当なバッチファイルとして保存して使用していきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">sc</span> stop 001_sample\n<span class=\"token function\">sc</span> delete 001_sample\n<span class=\"token function\">sc</span> create 001_sample <span class=\"token function\">type</span>= kernel binPath= Z:\\FirstDriverSample<span class=\"token punctuation\">.</span>sys\n<span class=\"token function\">sc</span> <span class=\"token function\">start</span> 001_sample</code></pre></div>\n<p>次は登録されたカーネルドライバのサービスを確認します。</p>\n<h3 id=\"サービスの確認\" style=\"position:relative;\"><a href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E7%A2%BA%E8%AA%8D\" aria-label=\"サービスの確認 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>サービスの確認</h3>\n<p>そもそもサービスとは、という話を簡単に触れておきます。</p>\n<p>Windowsにおけるサービスは、サービスコントロールマネージャー（SCM）によって開始されるプロセスを指します。</p>\n<p>カーネルドライバを追加した場合、サービスとして追加されるのでややこしいですが、多くの場合「Windowsサービス」と「ドライバサービス」は区別されることが多いようです。</p>\n<p>インサイドWindowsでも、「サービス」とはSCMによって起動されるユーザモードプロセスであり、デバイスドライバはサービスとしては扱わないことが明示されています。</p>\n<p>参考：<a href=\"https://amzn.to/3ei56Eg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">インサイドWindows 第7版 上</a></p>\n<p>参考：<a href=\"https://docs.microsoft.com/ja-jp/windows/win32/services/service-control-manager\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">サービス コントロール マネージャー - Win32 apps | Microsoft Docs</a></p>\n<p>カーネルドライバは先ほど確認した通り<code class=\"language-text\">HKLM\\SYSTEM\\CurrentCntrolSet\\Services</code>のサブキーとして登録され、SCMで起動されます。</p>\n<p>ここで、<code class=\"language-text\">HKLM\\SYSTEM\\CurrentCntrolSet\\Services</code>に登録されたサービスはカーネルドライバとWindowsサービスとで区別されており、各サブキーの[Type]の値が小さな値のものはカーネルドライバであり、0x10もしくは0x20の値のものはWindowsサービスとして登録されていることを意味します。</p>\n<p>実際に登録されたカーネルドライバのサービスは、ProcessHackerやProexpなどのツールによって確認することができます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 835px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3ed7b1a1f81b29509725d9a3d2f23633/f0685/image-59.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACpUlEQVQ4y3VUaY+bMBTM//9pVT+1ym4uwEA4w2EgHAmQ6bzHRlpVrSXL4Jh5czxnl2Qx2qZBVZWwtkFZlOi6Ox6PBx7TA+M4YZomPJcVM9/xeuEFWbb177EzgY8sTZAmEYwfIEkS1FUNW1vUZYWyZKG6Rt20sMUNj3FkgW2O44C+73UOX+vucPxEGIZkWMPzXOz3e+R5rkBVXSGKYrgmQJbfcDhd4Pkhfv3eww+uSLkXXCM0VNQPouSB3flyQhCEmOcZeZbBGEPG2QZIhkGU4Ox4cD2DKE5RsHCS5ShKsqZFlswHAglo3d6xc7wz2rZV/VVVwfd9FgjQ8OC6LOiGUW24Xq9orIXxPBRFwb0YcRxr4dPxiGsUoawb7FzXQUDvNsASR/4oB2+3GxYCtveBzwWGYVAVEpLsy/vz+fzaGzXQYgO8IKVEBWQ1Ydjwx7bt1OjKtvSH5t/v+uHI51GDmTQES9YCXjG4orIENA5DuCmgJGvoVRiEKl8Am65HToYi+XQ6aUHxWT3mGbEnotxMgmTxXRhn+sPGkB6azcMkTZWBAIo/4p/rujrFkoa9q4w5U57NaZECysdptkmuSduQgVSUUKR5BTBlqtbWyvByuei5Oy0QUAlUnmuqUw8DAkiK75QljO9DQumHrYnXddU9CUXCkPU9J96s0koonq+N/A5Fmlxk6CDD9t5jWV/vV2X9rzETVCU77HiRrYC8x67j0kejkt8M50WYvbb7+48p40nGytAPYziOo7SF4eFw0AIZfZV3aZv1P6y+j5UqlKG0wFtyQf/E9CROtqSZZtV09GvRW7P5NfNj8eyJqh3Q9pP2oYSjoZyNpz3WdZ1eKcO2Kdh30rDipVyns8ve5J+EH0bbyj51wgQ/Pgx+fjj4PDn4OBwJaPEHXr3AFDq1+HQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/3ed7b1a1f81b29509725d9a3d2f23633/8ac56/image-59.webp 240w,\n/static/3ed7b1a1f81b29509725d9a3d2f23633/d3be9/image-59.webp 480w,\n/static/3ed7b1a1f81b29509725d9a3d2f23633/2321d/image-59.webp 835w\"\n              sizes=\"(max-width: 835px) 100vw, 835px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/3ed7b1a1f81b29509725d9a3d2f23633/8ff5a/image-59.png 240w,\n/static/3ed7b1a1f81b29509725d9a3d2f23633/e85cb/image-59.png 480w,\n/static/3ed7b1a1f81b29509725d9a3d2f23633/f0685/image-59.png 835w\"\n            sizes=\"(max-width: 835px) 100vw, 835px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/3ed7b1a1f81b29509725d9a3d2f23633/f0685/image-59.png\"\n            alt=\"image-59.png\"\n            title=\"image-59.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>続いて、ドライバ（.sysファイル）がシステムにロードされていることも確認してみます。</p>\n<h3 id=\"ドライバがシステムに読み込まれていることを確認\" style=\"position:relative;\"><a href=\"#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%8C%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D\" aria-label=\"ドライバがシステムに読み込まれていることを確認 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ドライバがシステムに読み込まれていることを確認</h3>\n<p>Proexpで、[Lower Pane View]から[DLLs]を開きます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 786px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/92071d128e5860eb218f94bc82b0ce0b/321ea/image-60.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAES0lEQVQ4y1VUiW7bRhDVN7dA0KBAPyABCjRtgRQBEuRoDiRwkBaJ4zOOY8l2bImiqJMURYqieIgiJUqUZR3269s1GrQLPOxyZ/dx5s3s5KJBiJ7rom65sPoDhIGPMAy/YTAYYJKmGI1GGKcTjMepnC8XSyxXa6yIxXJFLLleIef7MeIoQBRHcFwP3W4XvV6PF8cSk8kEcRzLH6WRiyzsYpGNcJmNkcYB4tDFLI2RpQmSJEGu73vYqQQ4aCSwbAdmuw1dN+D7PrIsk4STdAS7H+EvJcKH6gT7xgL77aXErj7HgXWNSgg5cgndP6zY2K4OoNv00OrAIKlNT/t9j2EPMCNxPxxip2TjoOoTHg7rIU7NEY6aA+T1BN2xoLtGzgtjuHYHLSdCw7DhWCbcngPHtuB7fYyTmIRTJIMAQ0tH5jmYBT1kfg9Tr8u9FmZ+l2Qr0tFDIaTnBShoFmp2AMN20fWHCJIMfjKFF0/gDUY4bzu487mA307O8EtJxT2tiZ8LCu5+OsHdvIKtcHIT8pKEuFrhkK5vnLnYKOjYpKafzRk+tac4MDPsNUf4SI33TBdlaq4Qn3UTv77+gjuPt3Hn6T7+PjZvCNfrFbLZHB0mJPJd2GYbkxHDnIwxm47lvJhnsNoG7v/2B36/dx8PHzzBg/uP8OMPP+HW97dx67vb+PPJixvCq6srDIcJDL0Dy7JQUTUmxeRejJQZHrF0pkxKr+vi4P0nnOzkUf5Sgl5sQTks4uveMcqc035yQyg0dHse7FYbQRjAtm0EQShLJmVBi7K5mF/Ac/oofsijvl+EunWK2l4J1d1zKJvHqG6fIWkFWK1lYfus/BTDZETiHur1OpPky2IW8P2Ahe7A80PUWz1UajZ0M4BpRzA6IVptD22LLyy6wHQ6Ra7VamG9Xkt3RXjlcpmFrcvwhYedTgfn5+cwDB2r5SVqNY32JiVqos71iHr/d+RqtZokEDoJPUWo8/kcs9lMvs3Ly8v/7ZVKJf5UhaqqctY0DS57wdXVNa6vWdgaDR3TxGqxwAUvirBteiUaghiDIODrsRBQGvFiFBJWGIW4V+a6qmmycQiyG0I+sw4viZHSI9UwoNLjJp/egAQWbUqzCSeKsOCZMiUSd2r8qVirhPD8W8hfnz+H+uoV3N1d2FtbKL98ieqbNzDfv4e1uYnG27dyT8zO9jYKjx7hmDh79gyKuPvuHZPoyTYniHM1Hna4mR0dIfz4EQ0ear54IedoZwc2ibSnT2G8fo0hv8skqzx+DFXg4UPUNjZk8i6o8ZI9MVelfn1q8G/IFYbTYLgaQ5oySc5wiDJlaNOLCxEy5ajwjkY0HLa7fl/Wquw1QsMaRRWii5HRIL4N6iKSMWNdCVu9WpXzkhlXFQXVSkVCJEbYRCP+puHp6SlOTk5k6VRpFN+i7hqNhkSxWET+KI98oYAKSYRNoERiRSlzXeS5Jkx63OaT/Qd/JJ8rm+28SgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/92071d128e5860eb218f94bc82b0ce0b/8ac56/image-60.webp 240w,\n/static/92071d128e5860eb218f94bc82b0ce0b/d3be9/image-60.webp 480w,\n/static/92071d128e5860eb218f94bc82b0ce0b/4cb1e/image-60.webp 786w\"\n              sizes=\"(max-width: 786px) 100vw, 786px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/92071d128e5860eb218f94bc82b0ce0b/8ff5a/image-60.png 240w,\n/static/92071d128e5860eb218f94bc82b0ce0b/e85cb/image-60.png 480w,\n/static/92071d128e5860eb218f94bc82b0ce0b/321ea/image-60.png 786w\"\n            sizes=\"(max-width: 786px) 100vw, 786px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/92071d128e5860eb218f94bc82b0ce0b/321ea/image-60.png\"\n            alt=\"image-60.png\"\n            title=\"image-60.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>画像の通り、作成したドライバモジュールがロードされていることが確認できます。</p>\n<h3 id=\"kdprintマクロを追加する\" style=\"position:relative;\"><a href=\"#kdprint%E3%83%9E%E3%82%AF%E3%83%AD%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\" aria-label=\"kdprintマクロを追加する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>KdPrintマクロを追加する</h3>\n<p>次に、デバイスドライバにPrintメソッドを追加します。</p>\n<p>その前に、カーネルドライバの<code class=\"language-text\">KdPrint</code>の出力をDebugViewで拾えるようにするために、<code class=\"language-text\">HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager</code>配下にサブキー[Debug Print Filter]を作成し、DWORD型のキー<code class=\"language-text\">DEFAULT</code>を追加して、値を1に設定します。</p>\n<p>※設定の反映にはOSの再起動が必要です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 660px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/024db07d72761c7ed65f81cf9a321a17/1f083/image-64.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 124.58333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC/klEQVQ4y6WVSXPaQBCF+f+nXFIunwIHV8q55Z5U5RTH8YKNMZLQjpBAAiEJtKD1pWcAb7FTAU9VFxoB33TPvH7T+m168N0pNN1AEETIixJ5nmO9XqMoCqRpiqZpwEZd1zzYYO/qqkazm2+/ay2XEaIogufN4XsaLFOCphlQVQ1hGNEiAVzPQ7haoaI/sph4MyS0KFsmJ0iUJCjqBiXNW2VZMTxoMTSpClU8gzTUKNMcu2HLKoSfv7ByHIDA48GARzGfo6YFh5eXULpdrGnhFiurqioC1CgTHc6oD2+2wLYunpH7/Qecj0fwO22kp6dYdDpwjo/htzdz9swiOjnZAOu6QlFSyrGK+USC7bjIsowzy7JEtFw+ZNvg+Xg5fwDmxQZomz2IogJ5OKTqYn4wbC9Zts1bUT8+v8hQhqXfQBBkCLRHrutRpmt+aLuT3QW28XT+DMj2MF9ptIc9KIoBQ9d5OQ0dWBiGfwN3JT+ZPwHWVFqJskiRBXcwDQOWNYZDp7qiU42i5aHAHNniBpqqwB47lDUJmzT2asn/BSzXSP1rSMIA1timLsl4x4QHA4sNUCSgN5sjpnJZ670LmAU9WKMR4jh+1OG7gLSH1sikQ7FgmiOSjkt9PjsQmGdIvUvIImlwMkFKJQeLBXWOcwAwp54m5SW5BGFswSVBsxGTq9i2vSeQzIE6D7muYdz+gO7RJwjtL9A7nxEO7uGQi+wJLMnPCGjfYvrtK/yzcywvLoD7e4Qkcns63bdkypCZw9rA1NcwS3IE5Dbl1kDn5Ht7Azduo0CXzslpNCTxCjmJuiLZHKDDrdskGkz1GubI4dafJinXIbevfYAV20PKsIg1uLaA5SrlLcd+8BaweWFfD37I7J/5LrtT6lTDhOxLN8aYkA4ZjH0fBOGrwNcybrH9YeUtFvQ5k0nUXbqkFPi+z/WZkNvsMvzX2F2xLYGMoN/v4+b2Fr3eHY+rqyt06RYTRZFCgiRJGA5lMl66GmSF7E3j72VZ5tetNbJ4vzMj/gOlaYYc0p/6eQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/024db07d72761c7ed65f81cf9a321a17/8ac56/image-64.webp 240w,\n/static/024db07d72761c7ed65f81cf9a321a17/d3be9/image-64.webp 480w,\n/static/024db07d72761c7ed65f81cf9a321a17/cc661/image-64.webp 660w\"\n              sizes=\"(max-width: 660px) 100vw, 660px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/024db07d72761c7ed65f81cf9a321a17/8ff5a/image-64.png 240w,\n/static/024db07d72761c7ed65f81cf9a321a17/e85cb/image-64.png 480w,\n/static/024db07d72761c7ed65f81cf9a321a17/1f083/image-64.png 660w\"\n            sizes=\"(max-width: 660px) 100vw, 660px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/024db07d72761c7ed65f81cf9a321a17/1f083/image-64.png\"\n            alt=\"image-64.png\"\n            title=\"image-64.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>次に、デバイスドライバのコードを以下のように書き換え、ビルド後にデバイスドライバを再読み込みします。</p>\n<div class=\"gatsby-highlight\" data-language=\"c++\"><pre class=\"language-c++\"><code class=\"language-c++\">#include &lt;ntddk.h&gt;\n\nvoid FirstDriverUnload(_In_ PDRIVER_OBJECT DriverObject)\n{\n\tUNREFERENCED_PARAMETER(DriverObject);\n\n\tKdPrint((&quot;This driver unloaded\\n&quot;));\n}\n\nextern &quot;C&quot;\nNTSTATUS\nDriverEntry(_In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath)\n{\n\tUNREFERENCED_PARAMETER(RegistryPath);\n\n\tDriverObject-&gt;DriverUnload = FirstDriverUnload;\n\n\tOSVERSIONINFOEXW osVersionInfo;\n\tNTSTATUS status = STATUS_SUCCESS;\n\tosVersionInfo.dwOSVersionInfoSize = sizeof(OSVERSIONINFOEXW);\n\tstatus = RtlGetVersion((POSVERSIONINFOW)&amp;osVersionInfo);\n\n\tKdPrint((&quot;This is my first sample driver\\n&quot;));\n\tKdPrint((&quot;OS version is : %d.%d.%d\\n&quot;, osVersionInfo.dwMajorVersion, osVersionInfo.dwMinorVersion, osVersionInfo.dwBuildNumber));\n\n\treturn STATUS_SUCCESS;\n}</code></pre></div>\n<p>ここでは、<code class=\"language-text\">KdPrint</code>マクロを使って、現在のOSのバージョン情報を出力しています。</p>\n<p>OSのバージョン情報の取得には<code class=\"language-text\">RtlGetVersion</code>を使っています。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlgetversion\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RtlGetVersion function (wdm.h) - Windows drivers | Microsoft Docs</a></p>\n<p>取得した情報は<code class=\"language-text\">OSVERSIONINFOEXW</code>構造体として取得されます。</p>\n<p>参考：<a href=\"https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-osversioninfoa\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">OSVERSIONINFOA (winnt.h) - Win32 apps | Microsoft Docs</a></p>\n<div class=\"gatsby-highlight\" data-language=\"c++\"><pre class=\"language-c++\"><code class=\"language-c++\">typedef struct _OSVERSIONINFOA {\n  DWORD dwOSVersionInfoSize;\n  DWORD dwMajorVersion;\n  DWORD dwMinorVersion;\n  DWORD dwBuildNumber;\n  DWORD dwPlatformId;\n  CHAR  szCSDVersion[128];\n} OSVERSIONINFOA, *POSVERSIONINFOA, *LPOSVERSIONINFOA;</code></pre></div>\n<h3 id=\"debugviewを設定する\" style=\"position:relative;\"><a href=\"#debugview%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\" aria-label=\"debugviewを設定する permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DebugViewを設定する</h3>\n<p>SysInternalのDebugViewでKdprintマクロの出力を拾っていきます。</p>\n<p>まずはアプリケーションを起動し、[Caputure]から[Capture Kernel]と[Enable Verbose Output]を有効化します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 453px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f15f75aa75f9687bbf2686d7e50e4671/2108e/image-66.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 110.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD2ElEQVQ4y22VSW8bRxCF+TtzSW52HCXRVYl98A+wlZNgJIoMGIkudmxAt0DQvu8rF4mc4T5DcjgiRZHapZf6OiaDBGmgwJ6eqlevXlUPE0s7e6pWqqqFoeLmmRpRU/l8XoE9h2blclmNRkONekM3NzdiPTw86PHx8X8tUaqECqqhCsWypnd8/blb1GmxppKXUxxFqpZLymZOVDfwUr6gq14PRD3e3ztgrL/YJ1LJTc3MTGlmfkaTqa72g1iZalWpUkm5Wl3x7a0al5dq3T+oaQyj62t5xjiIz5ROpRTWalpbW9PBwYHa7bYShYKnZrOu0uTvqo79rODNG+VevZL/+rXyo6P2O6rQzs4mJnT29q1is2hsTNHysgKT58YSnJ+fO+t2u0q0L7q6a7VV/PIrzf70m/x3k/LHfzEbV/7XCcXvP6j18aPanz6p9eEPxVNTKrx4ocbLlyobo0qxqJqxBJCVaMSxrhp1+d8Na3w91lExVDKTViqbU8bzVLDyi0Eov1JR1GqpY0HhxoaiH5/Lq9eVTiblmR8NdBqGQaDOZU+pkR+08sU3yg19L//JE/lPv3ZWGvrWbMj2TxUMDysaGdHZs2dqWQWnluRwb09HR0cqGlPXZQB7BniQTCnl2Zjki/IzGXnptPKnpzpvNtX5bG3rettYVQsFNawpuVxOSWOYzWb/YRiZE/XvW6Zet6OoGcmzOaxYqVVLdn5xoY6JjV1gva7Kxoy5zOaySlvik5MTN68OsGqBtHtra0slO/R935WQy3kiWWCgDHb4edCx2HTnXcYqOTw8dKDg/F2yOQCYspnaMLFPrUzaTxlLS0vurGAl7u/vu+fNzU3t7Oxod3fX3Sj8/9UUxCTb9va2FhcXHXUWzuvr6y4YlsfHx5qfn3eV4Ms5sewZapI6hhXT48J0gjbOBPOCjDgRxBkJ8KERSIDuPbuGnU7HGXsHSGmUSAkLCwtOPxZaLttt4FpREqVOT09rdXV1oBtJkYqy2Q8Ygk4QYNDnBaVTDsH9BlAmPuwBohF91gMNYXJpl5/yYNEHJBESwJw9GtKUvob4kZRzwEv2MXEMYXZ1deU06gOSCe0Ag1HdhpmglZUVB8YZRiIqgPFgbACEIVoCyJDyAsaA40wVBJIEcMrrN4aZxNg7QALQkGDGpt8UEszNzTlGAKEfCSmRd8TxlUFDSJFo0OVr+6YBRIk48gIQgjmnKQjf145zgBin/mCzd02hRBiSfXZ21jmzcNqz+81wIz5ADDZ+AJOcRnCDSDpoCjPIurVPPc3hl3V3d+f+lLB7+//gHOOZX97/1wD8C7ehKnzFNI1QAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f15f75aa75f9687bbf2686d7e50e4671/8ac56/image-66.webp 240w,\n/static/f15f75aa75f9687bbf2686d7e50e4671/2430e/image-66.webp 453w\"\n              sizes=\"(max-width: 453px) 100vw, 453px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f15f75aa75f9687bbf2686d7e50e4671/8ff5a/image-66.png 240w,\n/static/f15f75aa75f9687bbf2686d7e50e4671/2108e/image-66.png 453w\"\n            sizes=\"(max-width: 453px) 100vw, 453px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f15f75aa75f9687bbf2686d7e50e4671/2108e/image-66.png\"\n            alt=\"image-66.png\"\n            title=\"image-66.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これで、ツールバーのキャプチャボタンを押してキャプチャを開始した状態でサービスを起動すると、DebugViewでOSのバージョン情報を取得することができます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8a20c71a43fccf4a87343dbe533bf956/2bef9/image-67-1024x642.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAARlAAAEZQAGA43XUAAABy0lEQVQ4y52S20pCURCG1/aUhwRTEcsrL3yNyCwqoh6gCKLzgYiIniOIbrqJ7sIwJeoiqF4iEIWCgih129EySc2/NdMuysgOC35mZi/WN/+stcWlqkLNpJDJpJHNZpHL3SKXz8uYQ6FQ+LPE2ekp0qlzJBIJpC4uoKqvYMrzEvz4mOf4W4nDeBzq9TXiySSSR0c4PjnBze0dHuTmf5bIbG/j7uAAV7u7SO/s4H5vD/ubMaysrmF9PYzIZhTR2BYi0RgrvBGpKYFKBSiVgHIZz09P3GV0bBxCCNjr66HX6Ti3mM0w19VxXlMEqGgqEliuweERCEVBIBCAw+GAxWKB1+uFyWSCIr/rZBOFpGh6rxUNKF2SShpwfHKauzU1NjKMRDC9Xv9Lh1XAufkFmOR4Ho+HndntdpjlyDabDUajEQaDgWO1vnU4MzvHmy6Xi0cmEDkkp+SSRtZpI1KkBqRvgRNT03yHDRJGnekQuXW73XyQagJT/uUaPgLfHmVoZJQ3/X4/nE4nO/P5fDw65VarlWWTfwHVbw0ofgYWiwzs6x9gII374yPUepSy/BdpLS4to7mlFd09vejs6kaovQMtwRCCoTYEWz+oupZ6AewCe2nx8DgEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/8a20c71a43fccf4a87343dbe533bf956/8ac56/image-67-1024x642.webp 240w,\n/static/8a20c71a43fccf4a87343dbe533bf956/d3be9/image-67-1024x642.webp 480w,\n/static/8a20c71a43fccf4a87343dbe533bf956/e46b2/image-67-1024x642.webp 960w,\n/static/8a20c71a43fccf4a87343dbe533bf956/a9a89/image-67-1024x642.webp 1024w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/8a20c71a43fccf4a87343dbe533bf956/8ff5a/image-67-1024x642.png 240w,\n/static/8a20c71a43fccf4a87343dbe533bf956/e85cb/image-67-1024x642.png 480w,\n/static/8a20c71a43fccf4a87343dbe533bf956/d9199/image-67-1024x642.png 960w,\n/static/8a20c71a43fccf4a87343dbe533bf956/2bef9/image-67-1024x642.png 1024w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/8a20c71a43fccf4a87343dbe533bf956/d9199/image-67-1024x642.png\"\n            alt=\"image-67-1024x642.png\"\n            title=\"image-67-1024x642.png\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>最後は、自作のドライバに対してWinDbgでカーネルデバッグを仕掛けてみます（ようやく本題）</p>\n<h2 id=\"カーネルデバッグで自作ドライバを解析してみる\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E8%87%AA%E4%BD%9C%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"カーネルデバッグで自作ドライバを解析してみる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カーネルデバッグで自作ドライバを解析してみる</h2>\n<p>まずはカーネルデバッグを有効化します。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">bcdedit <span class=\"token operator\">/</span>debug on\nbcdedit <span class=\"token operator\">/</span>dbgsettings serial debugport:1 baudrate:115200\nshutdown <span class=\"token operator\">/</span>r <span class=\"token operator\">/</span>t 0</code></pre></div>\n<p>詳しい設定方法は以下の記事にまとめてあります。</p>\n<p>参考：<a href=\"/windows-windbg-004-kernel-debug\">WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩</a></p>\n<p>カーネルデバッグの接続に成功したら、今回ビルドしたドライバのpdbファイルをSympathに追加します。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token punctuation\">.</span>sympath+ C:\\Users\\Tadpole01\\source\\repos\\Try2WinDbg\\drivers\\FirstDriverSample\\x64\\Debug</code></pre></div>\n<p>モジュールの一覧を参照すると<code class=\"language-text\">FirstDriverSample</code>の存在が確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">kd> lm\n<span class=\"token function\">start</span>             <span class=\"token keyword\">end</span>                 module name\nfffff800`64520000 fffff800`64527000   FirstDriverSample   <span class=\"token punctuation\">(</span>deferred<span class=\"token punctuation\">)</span>             \nfffff801`74000000 fffff801`747cc000   nt         <span class=\"token punctuation\">(</span>pdb symbols<span class=\"token punctuation\">)</span>          C:\\ProgramData\\Dbg\\sym\\ntkrnlmp<span class=\"token punctuation\">.</span>pdb\\F7971FB6AA7E450CBCA7054A98D659421\\ntkrnlmp<span class=\"token punctuation\">.</span>pdb\nUnloaded modules:\nfffff800`62c80000 fffff800`62c8f000   dump_storport<span class=\"token punctuation\">.</span>sys\nfffff800`62cc0000 fffff800`62ce5000   dump_storahci<span class=\"token punctuation\">.</span>sys\nfffff800`62d10000 fffff800`62d2c000   dump_dumpfve<span class=\"token punctuation\">.</span>sys\nfffff800`63400000 fffff800`63413000   dam<span class=\"token punctuation\">.</span>sys \nfffff800`61ec0000 fffff800`61ed0000   WdBoot<span class=\"token punctuation\">.</span>sys\nfffff800`62ba0000 fffff800`62bae000   hwpolicy<span class=\"token punctuation\">.</span>sys</code></pre></div>\n<p>シンボルがロードされているので、関数名も確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">kd> x <span class=\"token operator\">/</span>D <span class=\"token operator\">/</span>f FirstDriverSample!d*\nfffff800`64521020 FirstDriverSample!DriverEntry <span class=\"token punctuation\">(</span>struct _DRIVER_OBJECT <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> struct _UNICODE_STRING <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\nfffff800`645210f7 FirstDriverSample!DbgPrint <span class=\"token punctuation\">(</span>DbgPrint<span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">uf</code>コマンドでエントリ関数のディスアセンブル結果を見てみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">kd> uf FirstDriverSample!DriverEntry\nFirstDriverSample!DriverEntry <span class=\"token namespace\">[C:\\Users\\Tadpole01\\source\\repos\\Try2WinDbg\\drivers\\FirstDriverSample\\FirstDriver.cpp @ 13]</span>:\n   13 fffff800`64521020 4889542410      mov     qword ptr <span class=\"token namespace\">[rsp+10h]</span><span class=\"token punctuation\">,</span>rdx\n   13 fffff800`64521025 48894c2408      mov     qword ptr <span class=\"token namespace\">[rsp+8]</span><span class=\"token punctuation\">,</span>rcx\n   13 fffff800`6452102a 4881ec68010000  sub     rsp<span class=\"token punctuation\">,</span>168h\n   13 fffff800`64521031 488b05c81f0000  mov     rax<span class=\"token punctuation\">,</span>qword ptr <span class=\"token namespace\">[FirstDriverSample!__security_cookie (fffff800`64523000)]</span>\n   13 fffff800`64521038 4833c4          xor     rax<span class=\"token punctuation\">,</span>rsp\n   13 fffff800`6452103b 4889842450010000 mov     qword ptr <span class=\"token namespace\">[rsp+150h]</span><span class=\"token punctuation\">,</span>rax\n   16 fffff800`64521043 488b842470010000 mov     rax<span class=\"token punctuation\">,</span>qword ptr <span class=\"token namespace\">[rsp+170h]</span>\n   16 fffff800`6452104b 488d0daeffffff  lea     rcx<span class=\"token punctuation\">,</span><span class=\"token namespace\">[FirstDriverSample!FirstDriverUnload (fffff800`64521000)]</span>\n   16 fffff800`64521052 48894868        mov     qword ptr <span class=\"token namespace\">[rax+68h]</span><span class=\"token punctuation\">,</span>rcx\n   19 fffff800`64521056 c744242000000000 mov     dword ptr <span class=\"token namespace\">[rsp+20h]</span><span class=\"token punctuation\">,</span>0\n   20 fffff800`6452105e c74424301c010000 mov     dword ptr <span class=\"token namespace\">[rsp+30h]</span><span class=\"token punctuation\">,</span>11Ch\n   21 fffff800`64521066 488d4c2430      lea     rcx<span class=\"token punctuation\">,</span><span class=\"token namespace\">[rsp+30h]</span>\n   21 fffff800`6452106b ff158f0f0000    call    qword ptr <span class=\"token namespace\">[FirstDriverSample!_imp_RtlGetVersion (fffff800`64522000)]</span>\n   21 fffff800`64521071 89442420        mov     dword ptr <span class=\"token namespace\">[rsp+20h]</span><span class=\"token punctuation\">,</span>eax\n   23 fffff800`64521075 488d0d74010000  lea     rcx<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>FirstDriverSample! ?? ::FNODOBFM::`string<span class=\"token string\">' (fffff800`645211f0)]\n   23 fffff800`6452107c e876000000      call    FirstDriverSample!DbgPrint (fffff800`645210f7)\n   24 fffff800`64521081 448b4c243c      mov     r9d,dword ptr [rsp+3Ch]\n   24 fffff800`64521086 448b442438      mov     r8d,dword ptr [rsp+38h]\n   24 fffff800`6452108b 8b542434        mov     edx,dword ptr [rsp+34h]\n   24 fffff800`6452108f 488d0d7a010000  lea     rcx,[FirstDriverSample! ?? ::FNODOBFM::`string'</span> <span class=\"token punctuation\">(</span>fffff800`64521210<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n   24 fffff800`64521096 e85c000000      call    FirstDriverSample!DbgPrint <span class=\"token punctuation\">(</span>fffff800`645210f7<span class=\"token punctuation\">)</span>\n   26 fffff800`6452109b 33c0            xor     eax<span class=\"token punctuation\">,</span>eax\n   27 fffff800`6452109d 488b8c2450010000 mov     rcx<span class=\"token punctuation\">,</span>qword ptr <span class=\"token namespace\">[rsp+150h]</span>\n   27 fffff800`645210a5 4833cc          xor     rcx<span class=\"token punctuation\">,</span>rsp\n   27 fffff800`645210a8 e823000000      call    FirstDriverSample!__security_check_cookie <span class=\"token punctuation\">(</span>fffff800`645210d0<span class=\"token punctuation\">)</span>\n   27 fffff800`645210ad 4881c468010000  add     rsp<span class=\"token punctuation\">,</span>168h\n   27 fffff800`645210b4 c3              ret</code></pre></div>\n<p>今回は特に動きのあるカーネルドライバではないのでいったんここで終了します。</p>\n<p>次回以降では、実際に自作のドライバに対してライブデバッグを仕掛けていこうと思います。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>カーネルモードデバッグの検証のために、カーネルドライバの開発を始めました。</p>\n<p>WinDbg関連記事はこちらにまとめてあります。</p>\n<p>参考：<a href=\"/windows-windbg-001-index\">WinDbgを用いたデバッグとトラブルシューティングのテクニック</a></p>","fields":{"slug":"/windows-windriver-001-tutorial","tagSlugs":["/tag/win-dbg/","/tag/kernel/","/tag/kernel-driver/","/tag/reversing/"]},"frontmatter":{"date":"2021-12-22","description":"","tags":["WinDbg","Kernel","KernelDriver","Reversing"],"title":"Windowsカーネルドライバを自作してWinDbgで解析してみる","socialImage":{"publicURL":"/static/1d61c36eea0cac0d4e6ab1a46fc920c4/windows-windriver-001-tutorial.png"}}}},"pageContext":{"slug":"/windows-windriver-001-tutorial"}},"staticQueryHashes":["251939775","401334301","825871152"]}