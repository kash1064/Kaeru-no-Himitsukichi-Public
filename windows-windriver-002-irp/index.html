<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e71379dda153709d1a9a.css" id="gatsby-global-css">html{font-size:100}body{margin:0 0 0 calc(100vw - 100%);color:#222;line-height:1.4;font-size:.875rem;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background-color:#fcfcfc}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:1.575rem;line-height:2.25rem;margin-top:5rem;margin-bottom:1.25rem}h2{font-size:1.47656rem;line-height:1.875rem}h2,h3{margin-top:2.5rem;margin-bottom:.625rem}h3{font-size:1.20313rem;line-height:1.25rem}h4{font-size:1.05rem;margin-top:1.875rem}h4,h5{line-height:1.25rem;margin-bottom:.625rem}h5,h6{font-size:.875rem;margin-top:3.125rem}h6{line-height:1.25rem;margin-bottom:.625rem}img{max-width:100%;margin:inherit auto}hr,img{border:0;display:block}hr{color:#222;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);width:6.25rem}a{color:#918d40;text-decoration:none}a:active,a:focus,a:hover{color:#a9d159}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.25rem}ul li{padding:0 .3125rem;margin-bottom:.625rem}p{line-height:1.25rem;margin-bottom:1.25rem}blockquote{font-style:italic;text-align:center;background-color:#f5f5f5;padding:.1875rem .625rem}figure{display:block;width:100%;height:auto}figcaption{line-height:.9375rem;margin-top:.3125rem;color:#222;font-size:.75rem;font-style:italic;margin-bottom:0;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.25rem}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}li>code[class*=language-text],p>code[class*=language-text]{background:#f9f9f9!important;color:#2d2d2d!important}.Author-module--author__photo--36xCH{display:inline-block;margin-bottom:0;border-radius:50%;background-clip:padding-box}.Author-module--author__title--2CaTb{font-size:.98438rem;font-weight:600;line-height:1.40625rem;margin:.625rem 0}.Author-module--author__title-link--Yrism,.Author-module--author__title-link--Yrism:focus,.Author-module--author__title-link--Yrism:hover{color:#222}.Author-module--author__subtitle--cAaEB{color:#888;line-height:1.25rem;margin-bottom:1.25rem}.Icon-module--icon--Gpyvw{display:inline-block;width:1em;height:1em;stroke-width:0;stroke:currentColor;fill:currentColor;font-style:normal;font-weight:400;speak:none;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.Contacts-module--contacts--1rGd1{margin-bottom:1.25rem}.Contacts-module--contacts__list--3OgdW{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;padding:0;margin:.625rem -.1875rem;width:8.75rem}.Contacts-module--contacts__list-item--16p9q{padding:0;margin:.25rem;display:flex;align-content:center;align-items:center;justify-content:center;height:2.1875rem;width:2.1875rem;line-height:2.1875rem;border-radius:50%;text-align:center;border:1px solid #ebebeb}.Contacts-module--contacts__list-item-link--2MIDn{border:0;display:flex;color:#222}.Contacts-module--contacts__list-item-link--2MIDn:focus,.Contacts-module--contacts__list-item-link--2MIDn:hover{color:#918d40}.Copyright-module--copyright--1ariN{color:#b6b6b6;font-size:.75rem}.Menu-module--menu--Efbin{margin-bottom:1.25rem}.Menu-module--menu__list--31Zeo{list-style:none;padding:0;margin:0}.Menu-module--menu__list-item--1lJ6B{padding:0;margin:.625rem 0}.Menu-module--menu__list-item-link--10Ush{font-size:.875rem;color:#222;font-weight:400;border:0}.Menu-module--menu__list-item-link--10Ush:focus,.Menu-module--menu__list-item-link--10Ush:hover{color:#918d40;border-bottom:1px solid #918d40}.Menu-module--menu__list-item-link--active--2CbUO{color:#222;border-bottom:1px solid #222}.Sidebar-module--sidebar--X4z2p{width:100%}.Sidebar-module--sidebar__inner--Jdc5s{position:relative;padding:1.5625rem 1.25rem 0}.Sidebar-module--headerimage--19Rdy{width:100%;min-height:70px;max-height:120px;margin:0 0 .625rem}.Sidebar-module--logo-image--XDYae{min-height:70px;max-height:120px;margin:0 auto}input{-webkit-appearance:none;-moz-appearance:none;appearance:none;padding:.625rem;margin:.3125rem 0;border:1px solid #999;border-radius:.3125rem}.Sidebar-module--search-container--17C6F{position:relative}.Sidebar-module--search-container-input--27Tw4{width:100%}.Sidebar-module--search-container-submit--WwtLg{position:absolute;width:2.375rem;height:2.375rem;top:calc(50% - 19px);right:0;border:3px solid #999;border-radius:0 .25rem .25rem 0;background:#999}.Sidebar-module--search-container-submit--WwtLg:before{position:absolute;content:"";width:.9375rem;height:.9375rem;top:calc(50% - 9px);left:calc(50% - 9px);border-radius:50%;box-shadow:0 0 0 2px #fff}.Sidebar-module--search-container-submit--WwtLg:after{position:absolute;content:"";width:.5rem;height:.375rem;top:calc(50% + 6px);left:calc(50% + 2px);border-top:2px solid #fff;transform:rotate(45deg)}@media screen and (min-width:685px){.Sidebar-module--sidebar--X4z2p{width:calc(41.625% - 1.09375rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(12n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--Jdc5s:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);position:absolute;content:"";width:.0625rem;height:33.75rem;top:30px;right:-10px;bottom:0}}@media screen and (min-width:960px){.Sidebar-module--sidebar--X4z2p{width:calc(33.3% - 1.25rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(3n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:2.5rem}}.Layout-module--layout--3Pyz6{max-width:66.875rem;margin-left:auto;margin-right:auto}.Layout-module--layout--3Pyz6:before{content:"";display:table}.Layout-module--layout--3Pyz6:after{content:"";display:table;clear:both}.Feed-module--feed__item--2D5rE{margin-bottom:1.5625rem}.Feed-module--feed__item--2D5rE:last-child{margin-bottom:.625rem}.Feed-module--feed__item-title--3nigr{font-size:1.47656rem;line-height:1.875rem;margin-top:0;margin-bottom:.625rem}.Feed-module--feed__item-title-link--iFMRs{color:#222}.Feed-module--feed__item-title-link--iFMRs:focus,.Feed-module--feed__item-title-link--iFMRs:hover{color:#222;border-bottom:1px solid #222}.Feed-module--feed__item-description--1uO8e{font-size:.875rem;line-height:1.25rem;margin-bottom:.9375rem}.Feed-module--feed__item-meta-time--3t1fg{font-size:.75rem;color:#222;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--N-Q0A{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--23f8F{font-size:.75rem;color:#a9d159;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--23f8F:focus,.Feed-module--feed__item-meta-category-link--23f8F:hover{color:#918d40}.Feed-module--feed__item-readmore--1u6bI{font-size:.875rem;color:#918d40}.Feed-module--feed__item-readmore--1u6bI:focus,.Feed-module--feed__item-readmore--1u6bI:hover{color:#918d40;border-bottom:1px solid #918d40}.Page-module--page--2nMky{margin-bottom:2.5rem}.Page-module--page__inner--2M_vz{padding:1.5625rem 1.25rem}.Page-module--page__title--GPD8L{font-size:1.575rem;font-weight:600;line-height:2.5rem;margin-top:0;margin-bottom:1.8125rem}.Page-module--page__body--Ic6i6{font-size:.875rem;line-height:1.25rem;margin:0 0 1.25rem}@media screen and (min-width:685px){.Page-module--page--2nMky{width:calc(58.275% - .78125rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(12n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(12n+1){clear:both}.Page-module--page__inner--2M_vz{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--2nMky{width:calc(66.6% - .625rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(3n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(3n+1){clear:both}.Page-module--page__inner--2M_vz{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--2H3nO{margin-top:2.5rem;display:flex}.Pagination-module--pagination__prev--bet5s{width:50%;text-align:left}.Pagination-module--pagination__prev-link--1Nzs6{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--1Nzs6:focus,.Pagination-module--pagination__prev-link--1Nzs6:hover{color:#918d40}.Pagination-module--pagination__prev-link--disable--Yklx9{pointer-events:none;color:#bbb}.Pagination-module--pagination__next--3hFiN{width:50%;text-align:right}.Pagination-module--pagination__next-link--3FUtA{color:#a9d159;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--3FUtA:focus,.Pagination-module--pagination__next-link--3FUtA:hover{color:#918d40}.Pagination-module--pagination__next-link--disable--30UwZ{pointer-events:none;color:#bbb}.Author-module--author--2Yefr{border-top:1px solid #e6e6e6;max-width:43.75rem;padding-top:1.25rem;line-height:1.25rem;margin-top:1.25rem;margin-bottom:2.5rem}.Author-module--author__bio-twitter--n-O9n{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2Yefr{margin-left:auto;margin-right:auto}}.Content-module--content--3p512{max-width:62.8125rem;padding:0 .9375rem;margin:0 auto}.Content-module--content__title--2BDW9{font-size:1.75rem;max-width:43.75rem;font-weight:600;text-align:center;line-height:2.0625rem;margin:1.25rem auto 0}.Content-module--content__body--2TrQ- figure{margin-bottom:1.25rem}.Content-module--content__body--2TrQ- figure blockquote{font-style:italic;text-align:center;margin-top:0;padding:1.25rem 0}.Content-module--content__body--2TrQ- figure blockquote p{max-width:43.75rem;font-size:1.47149rem;margin-top:1.25rem;margin-bottom:1.25rem;line-height:1.875rem}.Content-module--content__body--2TrQ- a{text-decoration:underline}.Content-module--content__body--2TrQ- *{max-width:43.75rem;margin-left:auto;margin-right:auto}.Content-module--content__body--2TrQ- img{max-width:100%;margin-top:.625rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- li ul{margin-bottom:.625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}.Content-module--content__body--2TrQ- h2{position:relative;padding:1rem 1.5rem;color:#fff;border-radius:.625rem;background:#0c0000}.Content-module--content__body--2TrQ- h2:after{position:absolute;bottom:-9px;left:1rem;width:0;height:0;content:"";border-color:#0c0000 transparent transparent;border-style:solid;border-width:10px 10px 0}.Content-module--content__body--2TrQ- h3{border-bottom:3px dotted #0c0000;padding:1rem 0}@media screen and (min-width:960px){.Content-module--content--3p512{padding:0}.Content-module--content__title--2BDW9{font-size:1.75rem;line-height:2.8125rem;margin-top:2.8125rem;margin-bottom:1.875rem}.Content-module--content__body--2TrQ-,.Content-module--content__body--2TrQ- p{font-size:.98438rem;line-height:1.40625rem;margin-bottom:1.40625rem}.Content-module--content__body--2TrQ- li p{line-height:1.25rem;margin-bottom:.625rem}}.Meta-module--meta__date--29eD7{font-style:italic}.Tags-module--tags--1L_ct{margin-bottom:.625rem}.Tags-module--tags__list--91FqN{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--1M30P{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3SL_8{display:inline-block;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;border:1px solid #e6e6e6;text-decoration:none;border-radius:1.25rem;color:#222}.Tags-module--tags__list-item-link--3SL_8:focus,.Tags-module--tags__list-item-link--3SL_8:hover{color:#918d40}.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{max-width:43.75rem;margin:0 auto;padding:0 .9375rem}.Post-module--post__home-button--16Kl0{display:block;max-width:5.625rem;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;text-align:center;color:#222;border:1px solid #e6e6e6;border-radius:1.25rem;font-size:.875rem;font-weight:400;margin-left:auto;margin-right:auto;margin-top:1.25rem}.Post-module--post__home-button--16Kl0:focus,.Post-module--post__home-button--16Kl0:hover{color:#918d40}@media screen and (min-width:960px){.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{padding:0}.Post-module--post__home-button--16Kl0{position:fixed;max-width:auto;margin:0;top:30px;left:30px}}</style><meta name="generator" content="Gatsby 2.32.13"/><link rel="alternate" type="application/rss+xml" title="かえるのひみつきち" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-122086587-6"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-122086587-6', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#F7A046"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a0f47f11c0e7e9c18dcf5ce2a040fc9d"/><title data-react-helmet="true">Windowsカーネルドライバを自作してWinDbgでIRP要求をのぞいてみる - かえるのひみつきち</title><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" property="og:site_name" content="Windowsカーネルドライバを自作してWinDbgでIRP要求をのぞいてみる - かえるのひみつきち"/><meta data-react-helmet="true" property="og:image" content="https://kashiwaba-yuki.com/static/d540acb87fd7fe1b60f3feef78deb15c/windows-windriver-002-irp.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="Windowsカーネルドライバを自作してWinDbgでIRP要求をのぞいてみる - かえるのひみつきち"/><meta data-react-helmet="true" name="twitter:description" content=""/><meta data-react-helmet="true" name="twitter:image" content="https://kashiwaba-yuki.com/static/d540acb87fd7fe1b60f3feef78deb15c/windows-windriver-002-irp.png"/><link as="script" rel="preload" href="/webpack-runtime-a3c0f166cb4b802ff58f.js"/><link as="script" rel="preload" href="/framework-3761df4ab6ee9f056936.js"/><link as="script" rel="preload" href="/532a2f07-92db97c0addf07d5cb73.js"/><link as="script" rel="preload" href="/dc6a8720040df98778fe970bf6c000a41750d3ae-84d7c7f527ea24afde0e.js"/><link as="script" rel="preload" href="/app-f5b45fb557768b3cf36f.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-js-381c1b847824134fa4bd.js"/><link as="fetch" rel="preload" href="/page-data/windows-windriver-002-irp/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/251939775.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/401334301.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/825871152.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--3Pyz6"><div><a class="Post-module--post__home-button--16Kl0" href="/">All Articles</a><div><div class="Content-module--content--3p512"><h1 class="Content-module--content__title--2BDW9">Windowsカーネルドライバを自作してWinDbgでIRP要求をのぞいてみる</h1><div class="Content-module--content__body--2TrQ-"><p>Windowsのカーネルデバッグを試す上で壁になったのが、詳細な仕様が公開されているカーネルドライバが少ないという壁にぶつかりました。</p>
<p>なければ作ってしまおう、と思いカーネルドライバの開発を始めました。</p>
<p>カーネルドライバの開発にあたっては、基本的に以下の書籍を参考にしつつ進めてます。</p>
<p>参考：<a href="https://amzn.to/3H3WMoe" target="_blank" rel="nofollow noopener noreferrer">Windowsカーネルドライバプログラミング</a></p>
<p>カーネルデバッグの設定方法については以下の記事でまとめてあります。</p>
<p>参考：<a href="/windows-windbg-004-kernel-debug">WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩</a></p>
<p><a href="/windows-windriver-001-tutorial">前回</a>の記事ではDebugViewを設定してKdPrintでOSのバージョンを出力するだけのドライバを作成し、ライブデバッグを行いました。</p>
<p>今回はもう少し動きのあるドライバを作成してデバッグをしていきたいと思います。</p>
<!-- omit in toc -->
<h2 id="もくじ" style="position:relative;"><a href="#%E3%82%82%E3%81%8F%E3%81%98" aria-label="もくじ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>もくじ</h2>
<ul>
<li>
<p><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">カーネルプログラミングについて</a></p>
<ul>
<li><a href="#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E6%AF%94%E8%BC%83%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E9%96%8B%E7%99%BA%E3%81%AE%E7%9B%B8%E9%81%95%E7%82%B9">ユーザモードと比較した場合の、カーネルドライバ開発の相違点</a></li>
<li><a href="#%E6%A7%8B%E9%80%A0%E5%8C%96%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86seh%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">構造化例外処理(SEH)について</a></li>
<li><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">カーネル関数について</a></li>
<li><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">カーネルドライバのメモリ割り当てについて</a></li>
<li><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">デバイスオブジェクトについて</a></li>
</ul>
</li>
<li>
<p><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%A8%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">カーネルドライバとクライアントアプリケーションを作成する</a></p>
<ul>
<li><a href="#%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D">スケジュールの優先順位</a></li>
<li><a href="#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%9C%E3%82%8B">DriverEntry関数を作る</a></li>
</ul>
</li>
<li>
<p><a href="#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80">DriverEntry関数を読む</a></p>
<ul>
<li><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88">ディスパッチルーチンのサポート</a></li>
<li><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%8C%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E6%96%87%E5%AD%97%E5%88%97">カーネル関数が使用する文字列</a></li>
<li><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90">デバイスオブジェクトの作成</a></li>
<li><a href="#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AA%E3%83%83%E3%82%AF%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AE%E4%BD%9C%E6%88%90">シンボリックリンクの作成</a></li>
</ul>
</li>
<li>
<p><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AB%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97">ディスパッチルーチンに割り当てるルーチンのセットアップ</a></p>
<ul>
<li><a href="#%E9%96%A2%E6%95%B0%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3">関数アノテーション</a></li>
<li><a href="#irp%E3%81%AE%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8A">IRPの受け取り</a></li>
<li><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97">デバイスコントロールのセットアップ</a></li>
<li><a href="#%E7%8F%BE%E5%9C%A8%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%AD%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%8F%96%E5%BE%97">現在のスタックロケーションの取得</a></li>
<li><a href="#%E8%A6%81%E6%B1%82%E3%81%95%E3%82%8C%E3%81%9F%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D%E3%82%92%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B">要求された優先順位をスレッドに設定する</a></li>
</ul>
</li>
<li><a href="#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">ドライバのインストール</a></li>
<li>
<p><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E6%8C%99%E5%8B%95%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">カーネルデバッグで挙動を確認してみる</a></p>
<ul>
<li><a href="#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B">ブレークポイントを設定する</a></li>
<li><a href="#irp%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B">IRPを解析する</a></li>
</ul>
</li>
<li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D">参考書籍</a></li>
</ul>
<h2 id="カーネルプログラミングについて" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" aria-label="カーネルプログラミングについて permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネルプログラミングについて</h2>
<p><a href="https://amzn.to/3H3WMoe" target="_blank" rel="nofollow noopener noreferrer">Windowsカーネルドライバプログラミング</a>を参考にカーネルドライバの開発を行っています。</p>
<p>前回インストールしたWDK(Windows Driver Kit)にはカーネルドライバ開発で使用するライブラリとヘッダファイルが格納されています。</p>
<p>カーネルAPIはC言語の関数群で構成されていますが、ユーザモード開発とは主に以下の点で異なります。</p>
<h3 id="ユーザモードと比較した場合のカーネルドライバ開発の相違点" style="position:relative;"><a href="#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E6%AF%94%E8%BC%83%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E9%96%8B%E7%99%BA%E3%81%AE%E7%9B%B8%E9%81%95%E7%82%B9" aria-label="ユーザモードと比較した場合のカーネルドライバ開発の相違点 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ユーザモードと比較した場合の、カーネルドライバ開発の相違点</h3>
<p><a href="https://amzn.to/3H3WMoe" target="_blank" rel="nofollow noopener noreferrer">Windowsカーネルドライバプログラミング</a>よりユーザモードと比較した場合の、カーネルドライバ開発の相違点について引用します。</p>
<ul>
<li>未処理の例外発生時、システムをクラッシュさせる(BSOD)</li>
<li>プロセスの終了時のアンロードルーチンでリソースを解放する必要がある(解放されない場合はリークが発生する)</li>
<li>カーネルドライバ開発時のエラーは決して無視してはいけない</li>
<li>IRQLが0より大きくなる場合がある</li>
<li>埋め込まれたバグがシステム全体に影響を及ぼす可能性がある</li>
<li>デバッグは他のマシンからリモートデバッグする必要がある</li>
<li>ほとんどの標準ライブラリは使えない</li>
<li>例外処理に使えるのは<code class="language-text">Structured Exception Handling(SEH)</code>のみ</li>
<li>C++ランタイムが利用できない</li>
</ul>
<h3 id="構造化例外処理sehについて" style="position:relative;"><a href="#%E6%A7%8B%E9%80%A0%E5%8C%96%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86seh%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" aria-label="構造化例外処理sehについて permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>構造化例外処理(SEH)について</h3>
<p>SEHはハードウェア障害などの特定の例外コードの状況を適切に処理するための機能です。</p>
<p>SEHを使用することで、例外が発生した場合でも、メモリブロックやファイルなどのリソースが正常に解放されるようにプログラムを書くことができるようになります。</p>
<p>SEHでは、「例外ハンドラ」と「終了ハンドラ」の2つのメカニズムを利用できます。</p>
<p>例外ハンドラは特定のエラーに対応するために使用されます。</p>
<p>参考：<a href="https://docs.microsoft.com/ja-jp/cpp/cpp/writing-an-exception-handler?view=msvc-170" target="_blank" rel="nofollow noopener noreferrer">例外ハンドラーの記述 | Microsoft Docs</a></p>
<p>一方、終了ハンドラはコードブロックの処理が正常に終了したか例外が発生したかに関わらず常に実行させることができます。</p>
<p>参考：<a href="https://docs.microsoft.com/ja-jp/cpp/cpp/writing-a-termination-handler?view=msvc-170" target="_blank" rel="nofollow noopener noreferrer">終了ハンドラーの記述 | Microsoft Docs</a></p>
<p>カーネルドライバ開発を行う場合は、SEHを使い、上記のいずれかを用いて例外処理を実装していく必要があります。</p>
<p>参考：<a href="https://docs.microsoft.com/ja-jp/cpp/cpp/structured-exception-handling-c-cpp?view=msvc-170" target="_blank" rel="nofollow noopener noreferrer">Structured Exception Handling (C/C++) | Microsoft Docs</a></p>
<h3 id="カーネル関数について" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" aria-label="カーネル関数について permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネル関数について</h3>
<p>カーネルドライバ開発の際にはCの標準ライブラリは基本的には使用できません。</p>
<p>カーネルドライバ開発では、カーネルのコンポーネントからエクスポートされている関数を使用します。</p>
<p>多くのカーネル関数は<code class="language-text">Ntoskrnl.exe</code>の中で実装されています。</p>
<p><code class="language-text">Ntoskrnl.exe</code>で実装されている関数には、文書化されているものと文書化されていないものがあります。</p>
<p>カーネル関数の名前にはある程度規則性があり、目的ごとに接頭語が付属しています。</p>
<p>接頭語の対応表については以下のWikipediaページに詳しく書いてありました。</p>
<p>参考：<a href="https://en.wikipedia.org/wiki/Ntoskrnl.exe" target="_blank" rel="nofollow noopener noreferrer">ntoskrnl.exe - Wikipedia</a></p>
<p>文書化されているカーネル関数については以下のページなどから参照することができます。</p>
<p>参考：<a href="https://docs.microsoft.com/ja-jp/windows-hardware/drivers/ddi/_kernel/" target="_blank" rel="nofollow noopener noreferrer">Windows kernel - Windows drivers | Microsoft Docs</a></p>
<h3 id="カーネルドライバのメモリ割り当てについて" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" aria-label="カーネルドライバのメモリ割り当てについて permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネルドライバのメモリ割り当てについて</h3>
<p>カーネルはドライバが利用可能な以下の2つのメモリプールを提供しています。</p>
<ul>
<li>ページプール：必要に応じてページアウトされる領域</li>
<li>非ページプール：ページアウトされない領域</li>
</ul>
<p>また、非ページプールは実行が可能な領域と実行不可の領域をそれぞれ制御することができます。</p>
<p>ページングを行わない非ページプールを使用すればページフォールトが発生しないことが保証されますが、ドライバ開発を行う場合は可能な限りページプールで開発することが推奨されるようです。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-exallocatepool" target="_blank" rel="nofollow noopener noreferrer">ExAllocatePool function (wdm.h) - Windows drivers | Microsoft Docs</a></p>
<h3 id="デバイスオブジェクトについて" style="position:relative;"><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" aria-label="デバイスオブジェクトについて permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>デバイスオブジェクトについて</h3>
<p>カーネルドライバは原則として1つ以上のデバイスオブジェクトを作成する必要があります。</p>
<p>デバイスオブジェクトとは、OSがデバイスを表すために使用されるものです。</p>
<p>参考：<a href="https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/introduction-to-device-objects" target="_blank" rel="nofollow noopener noreferrer">デバイス オブジェクトの概要 - Windows drivers | Microsoft Docs</a></p>
<p>デバイスオブジェクトは<code class="language-text">DEVICEOBJECT</code>構造体のインスタンスとして作成されます。</p>
<p>カーネルドライバは、デバイスオブジェクトを経由してクライアントアプリケーションと通信を行います。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_device_object" target="_blank" rel="nofollow noopener noreferrer"><em>DEVICE</em>OBJECT (wdm.h) - Windows drivers | Microsoft Docs</a></p>
<h2 id="カーネルドライバとクライアントアプリケーションを作成する" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%A8%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B" aria-label="カーネルドライバとクライアントアプリケーションを作成する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネルドライバとクライアントアプリケーションを作成する</h2>
<p><a href="https://amzn.to/3H3WMoe" target="_blank" rel="nofollow noopener noreferrer">Windowsカーネルドライバプログラミング</a>の4章で解説されているコードを写経しつつSecondDriverSampleの開発を行っていきます。</p>
<p>4章では、スレッドの優先度をコントロールするカーネルドライバとクライアントアプリケーションのセットを作成しました。</p>
<h3 id="スケジュールの優先順位" style="position:relative;"><a href="#%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D" aria-label="スケジュールの優先順位 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>スケジュールの優先順位</h3>
<p>そもそもの話ですが、僕はWindowsAPIを使ったスレッド優先度の設定が何かについてそもそもよく知らなかったので簡単に調べてみました。</p>
<p>Windows環境において、スレッドはスレッドの優先順位によってスケジュールされます。</p>
<p>スレッドの優先順位は以下の2つの条件で決定されます。</p>
<ul>
<li>プロセスの優先度クラス</li>
<li>プロセスの優先度クラス内のスレッドの優先度レベル</li>
</ul>
<p>プロセスの優先度クラスは以下のいずれかに属しており、<code class="language-text">SetPriorityClass</code>によって設定することができます。</p>
<p>デフォルトではプロセスの優先度クラスは<code class="language-text">THREAD_PRIORITY_NORMAL</code>になるようです。</p>
<ul>
<li>THREAD<em>PRIORITY</em>IDLE</li>
<li>THREAD<em>PRIORITY</em>LOWEST</li>
<li>THREAD<em>PRIORITY</em>BELOW_NORMAL</li>
<li>THREAD<em>PRIORITY</em>NORMAL</li>
<li>THREAD<em>PRIORITY</em>ABOVE_NORMAL</li>
<li>THREAD<em>PRIORITY</em>HIGHEST</li>
<li>THREAD<em>PRIORITY</em>TIME_CRITICAL</li>
</ul>
<p>一方で、各優先度クラス内のスレッドの優先度レベルは以下のいずれかが設定されます。</p>
<p><code class="language-text">SetThreadPriority</code>で変更することができます。</p>
<p>こちらもデフォルトでは<code class="language-text">THREAD_PRIORITY_NORMAL</code>が割り当てされます。</p>
<ul>
<li>THREAD<em>PRIORITY</em>IDLE</li>
<li>THREAD<em>PRIORITY</em>LOWEST</li>
<li>THREAD<em>PRIORITY</em>BELOW_NORMAL</li>
<li>THREAD<em>PRIORITY</em>NORMAL</li>
<li>THREAD<em>PRIORITY</em>ABOVE_NORMAL</li>
<li>THREAD<em>PRIORITY</em>HIGHEST</li>
<li>THREAD<em>PRIORITY</em>TIME_CRITICAL</li>
</ul>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setpriorityclass" target="_blank" rel="nofollow noopener noreferrer">SetPriorityClass function (processthreadsapi.h) - Win32 apps | Microsoft Docs</a></p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadpriority" target="_blank" rel="nofollow noopener noreferrer">SetThreadPriority function (processthreadsapi.h) - Win32 apps | Microsoft Docs</a></p>
<p>これらの組みあわせによって各スレッドの優先順位が決定するものの、以下のリンク先の表の通り通常の設定方法では、すべてのレベルの優先順位を柔軟に設定することができないようです。</p>
<p>参考：<a href="https://docs.microsoft.com/ja-jp/windows/win32/procthread/scheduling-priorities" target="_blank" rel="nofollow noopener noreferrer">スケジュールの優先順位 - Win32 apps | Microsoft Docs</a></p>
<p>そこで、4章で開発するドライバとクライアントでは、スレッドの優先度を柔軟に設定できるようにすることを目標にしています。</p>
<h3 id="driverentry関数を作る" style="position:relative;"><a href="#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%9C%E3%82%8B" aria-label="driverentry関数を作る permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DriverEntry関数を作る</h3>
<p>ベースは<a href="/windows-windriver-001-tutorial">過去の記事</a>で作成した手順と同じです。</p>
<p>まずはエントリポイントになる<code class="language-text">DriverEntry</code>関数を作ります。</p>
<p><code class="language-text">DriverEntry</code>関数では、以下の処理を実装します。</p>
<ul>
<li>アンロードルーチンの設定</li>
<li>ドライバがサポートするディスパッチルーチンの設定</li>
<li>デバイスオブジェクトの生成</li>
<li>デバイスオブジェクトへのシンボリックリンクの作成</li>
</ul>
<p>アンロードルーチンとデバイスオブジェクトが必要な理由は前述した通りです。</p>
<p>詳しくは以下の「必須の標準ドライバー ルーチン」の項が参考になります。</p>
<p>参考：<a href="https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/introduction-to-standard-driver-routines" target="_blank" rel="nofollow noopener noreferrer">標準ドライバー ルーチンの概要 - Windows drivers | Microsoft Docs</a></p>
<p>ディスパッチルーチンはIRP(受信I/O要求パケット)を処理するものです。</p>
<p>IRPには様々な要求に対してその要求に関する情報が格納されます。</p>
<p>カーネルドライバは、ドライバのデバイスハンドルをオープンするために、最低限<code class="language-text">IRP_MJ_CREATE</code>と<code class="language-text">IRP_MJ_CLOSE</code>のディスパッチルーチンについてはサポートする必要があるようです。</p>
<p>参考：<a href="https://docs.microsoft.com/ja-jp/windows-hardware/drivers/kernel/dispatch-routine-functionality" target="_blank" rel="nofollow noopener noreferrer">ディスパッチ ルーチンの機能 - Windows drivers | Microsoft Docs</a></p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_dispatch" target="_blank" rel="nofollow noopener noreferrer">DRIVER_DISPATCH (wdm.h) - Windows drivers | Microsoft Docs</a></p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/dispatchcreate--dispatchclose--and-dispatchcreateclose-routines" target="_blank" rel="nofollow noopener noreferrer">DispatchCreate, DispatchClose, and DispatchCreateClose Routines - Windows drivers | Microsoft Docs</a></p>
<p>デバイスオブジェクトへのシンボリックリンクを作成するのは、クライアントからカーネルドライバのデバイスオブジェクトを参照するためです。</p>
<p>例えば<code class="language-text">CreateFile</code>関数などは第1引数にデバイスオブジェクトのシンボリックリンクを受け取ります。</p>
<h2 id="driverentry関数を読む" style="position:relative;"><a href="#driverentry%E9%96%A2%E6%95%B0%E3%82%92%E8%AA%AD%E3%82%80" aria-label="driverentry関数を読む permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DriverEntry関数を読む</h2>
<p>ここで、実際に写経しつつ作成した<code class="language-text">DriverEntry</code>関数は次のようになりました。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">extern</span> <span class="token string">"C"</span> NTSTATUS
<span class="token function">DriverEntry</span><span class="token punctuation">(</span>_In_ PDRIVER_OBJECT DriverObject<span class="token punctuation">,</span> _In_ PUNICODE_STRING RegistryPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">UNREFERENCED_PARAMETER</span><span class="token punctuation">(</span>RegistryPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">KdPrint</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"SecondDriver DriverEntry started\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	DriverObject<span class="token operator">-></span>DriverUnload <span class="token operator">=</span> SecondDriverUnload<span class="token punctuation">;</span>

	DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span>IRP_MJ_CREATE<span class="token punctuation">]</span> <span class="token operator">=</span> SecondDriverCreateClose<span class="token punctuation">;</span>
	DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span>IRP_MJ_CLOSE<span class="token punctuation">]</span> <span class="token operator">=</span> SecondDriverCreateClose<span class="token punctuation">;</span>
	DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span>IRP_MJ_DEVICE_CONTROL<span class="token punctuation">]</span> <span class="token operator">=</span> SecondDriverDeviceControl<span class="token punctuation">;</span>

	UNICODE_STRING devName <span class="token operator">=</span> <span class="token function">RTL_CONSTANT_STRING</span><span class="token punctuation">(</span>L<span class="token string">"\\Device\\SecondDriver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//RtlInitUnicodeString(&amp;devName, L"\\Device\\ThreadBoost");</span>
	PDEVICE_OBJECT DeviceObject<span class="token punctuation">;</span>
	NTSTATUS status <span class="token operator">=</span> <span class="token function">IoCreateDevice</span><span class="token punctuation">(</span>DriverObject<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>devName<span class="token punctuation">,</span> FILE_DEVICE_UNKNOWN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>DeviceObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">KdPrint</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"Failed to create device (0x%08X)\n"</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> status<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	UNICODE_STRING symLink <span class="token operator">=</span> <span class="token function">RTL_CONSTANT_STRING</span><span class="token punctuation">(</span>L<span class="token string">"\\??\\SecondDriver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token function">IoCreateSymbolicLink</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>symLink<span class="token punctuation">,</span> <span class="token operator">&amp;</span>devName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">KdPrint</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"Failed to create symbolic link (0x%08X)\n"</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">IoDeleteDevice</span><span class="token punctuation">(</span>DeviceObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> status<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">KdPrint</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"SecondDriverSecondDriver DriverEntry completed successfully\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="ディスパッチルーチンのサポート" style="position:relative;"><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88" aria-label="ディスパッチルーチンのサポート permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ディスパッチルーチンのサポート</h3>
<p>とりあえず気になったのは以下の3行です。</p>
<p>ここではディスパッチルーチンのセットアップを行っています。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span>IRP_MJ_CREATE<span class="token punctuation">]</span> <span class="token operator">=</span> SecondDriverCreateClose<span class="token punctuation">;</span>
DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span>IRP_MJ_CLOSE<span class="token punctuation">]</span> <span class="token operator">=</span> SecondDriverCreateClose<span class="token punctuation">;</span>
DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span>IRP_MJ_DEVICE_CONTROL<span class="token punctuation">]</span> <span class="token operator">=</span> SecondDriverDeviceControl<span class="token punctuation">;</span></code></pre></div>
<p><code class="language-text">DriverObject</code>は<code class="language-text">semi-documented</code>な構造体で、ロードされたカーネルモードドライバーのイメージを表します。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_DRIVER_OBJECT</span> <span class="token punctuation">{</span>
  CSHORT             Type<span class="token punctuation">;</span>
  CSHORT             Size<span class="token punctuation">;</span>
  PDEVICE_OBJECT     DeviceObject<span class="token punctuation">;</span>
  ULONG              Flags<span class="token punctuation">;</span>
  PVOID              DriverStart<span class="token punctuation">;</span>
  ULONG              DriverSize<span class="token punctuation">;</span>
  PVOID              DriverSection<span class="token punctuation">;</span>
  PDRIVER_EXTENSION  DriverExtension<span class="token punctuation">;</span>
  UNICODE_STRING     DriverName<span class="token punctuation">;</span>
  PUNICODE_STRING    HardwareDatabase<span class="token punctuation">;</span>
  PFAST_IO_DISPATCH  FastIoDispatch<span class="token punctuation">;</span>
  PDRIVER_INITIALIZE DriverInit<span class="token punctuation">;</span>
  PDRIVER_STARTIO    DriverStartIo<span class="token punctuation">;</span>
  PDRIVER_UNLOAD     DriverUnload<span class="token punctuation">;</span>
  PDRIVER_DISPATCH   MajorFunction<span class="token punctuation">[</span>IRP_MJ_MAXIMUM_FUNCTION <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> DRIVER_OBJECT<span class="token punctuation">,</span> <span class="token operator">*</span>PDRIVER_OBJECT<span class="token punctuation">;</span></code></pre></div>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_driver_object" target="_blank" rel="nofollow noopener noreferrer"><em>DRIVER</em>OBJECT (wdm.h) - Windows drivers | Microsoft Docs</a></p>
<p>「ロードされたカーネルモードドライバーのイメージ」とは？って感じですが<code class="language-text">DriverEntry</code>関数が呼び出されるときにカーネル側で割り当てと初期化をされた後で渡されるオブジェクトとのことで、カーネル側でよしなにしてくれたオブジェクトなんだろうなと思ってます。（調べてもよくわからなかった・・・）</p>
<p>ここで、このドライバオブジェクトのメンバである<code class="language-text">MajorFunction</code>にディスパッチルーチンを登録することでドライバがサポートする具体的な機能を指定できます。</p>
<p><code class="language-text">MajorFunction</code>は関数ポインタの配列として管理されていて、<code class="language-text">IRP_MJ_</code>という接頭語がついたインデックスが事前定義されています。</p>
<p>ここで、サポートするディスパッチルーチンのみ追加すればいい理由は、<code class="language-text">MajorFunction</code>配列はカーネル側で初期化された際にすべての要素がドライバがサポートしていないIRPであることを示す<code class="language-text">nt!IopInvalidDeviceRequest</code>に設定されているためです。</p>
<p>そのため、サポートするディスパッチルーチンのみ更新を行う方式になっています。</p>
<p>参考：<a href="https://social.msdn.microsoft.com/Forums/ja-JP/4f42ce1d-cbd1-4968-b458-1d96239368a8/driverobject-12392-driverentry?forum=wdksupportteamja" target="_blank" rel="nofollow noopener noreferrer">DriverObject と DriverEntry</a></p>
<h3 id="カーネル関数が使用する文字列" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E9%96%A2%E6%95%B0%E3%81%8C%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E6%96%87%E5%AD%97%E5%88%97" aria-label="カーネル関数が使用する文字列 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネル関数が使用する文字列</h3>
<p>カーネル関数で文字列を使用する場合、基本的には<code class="language-text">UNICODE_STRING</code>型の構造体が期待されます。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_unicode_string" target="_blank" rel="nofollow noopener noreferrer"><em>UNICODE</em>STRING (ntdef.h) - Win32 apps | Microsoft Docs</a></p>
<p>ソースコードの以下の行では、<code class="language-text">RTL_CONSTANT_STRING</code>マクロを使ってパスの文字列<code class="language-text">\\Device\\SecondDriver</code>を<code class="language-text">UNICODE_STRING</code>に変換して変数<code class="language-text">devname</code>に格納しています。</p>
<p>そのあとに出てくる<code class="language-text">symLink</code>の行も同様です。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">UNICODE_STRING devName <span class="token operator">=</span> <span class="token function">RTL_CONSTANT_STRING</span><span class="token punctuation">(</span>L<span class="token string">"\\Device\\SecondDriver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

UNICODE_STRING symLink <span class="token operator">=</span> <span class="token function">RTL_CONSTANT_STRING</span><span class="token punctuation">(</span>L<span class="token string">"\\??\\SecondDriver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlinitstring" target="_blank" rel="nofollow noopener noreferrer">RtlInitString function (wdm.h) - Windows drivers | Microsoft Docs</a></p>
<h3 id="デバイスオブジェクトの作成" style="position:relative;"><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90" aria-label="デバイスオブジェクトの作成 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>デバイスオブジェクトの作成</h3>
<p><code class="language-text">DriverEntry</code>関数内で行う必要がある「デバイスオブジェクトの生成」はここで行います。</p>
<p>もともと<code class="language-text">DriverEntry</code>関数の引数としてカーネルが初期化した<code class="language-text">DriverObject</code>を受け取ってはいますが、これは<code class="language-text">IoCreateDevice</code>関数でデバイスオブジェクトを作成するために必要な情報になります。</p>
<p>デバイスオブジェクトが存在しない場合、ハンドルをオープンしてユーザモードのクライアントがドライバと通信する方法がない状態となります。</p>
<p>デバイスオブジェクトは<code class="language-text">IoCreateDevice</code>関数で作成します。</p>
<p><code class="language-text">IoCreateDevice</code>関数は以下の構造です。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">NTSTATUS <span class="token function">IoCreateDevice</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>in<span class="token punctuation">]</span>           PDRIVER_OBJECT  DriverObject<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>in<span class="token punctuation">]</span>           ULONG           DeviceExtensionSize<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>in<span class="token punctuation">,</span> optional<span class="token punctuation">]</span> PUNICODE_STRING DeviceName<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>in<span class="token punctuation">]</span>           DEVICE_TYPE     DeviceType<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>in<span class="token punctuation">]</span>           ULONG           DeviceCharacteristics<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>in<span class="token punctuation">]</span>           BOOLEAN         Exclusive<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>out<span class="token punctuation">]</span>          PDEVICE_OBJECT  <span class="token operator">*</span>DeviceObject
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatedevice" target="_blank" rel="nofollow noopener noreferrer">IoCreateDevice function (wdm.h) - Windows drivers | Microsoft Docs</a></p>
<p>第1引数として受け取る<code class="language-text">PDRIVER_OBJECT</code>型の<code class="language-text">DriverObject</code>は呼び出し元のデバイスオブジェクトになります。</p>
<p>これは<code class="language-text">DriverEntry</code>関数の引数として受け取っていたものです。</p>
<p>第7引数には、新しく作成する<code class="language-text">DeviceObject</code>構造体のポインタが与えられます。</p>
<p>新たに宣言した<code class="language-text">PDEVICE_OBJECT</code>型の<code class="language-text">DeviceObject</code>のポインタを引数として与えられます。</p>
<p><code class="language-text">IoCreateDevice</code>関数が正常に動作した場合、このポインタの参照先に非ページプールから割り当てられたデバイスオブジェクトが格納されます。</p>
<p>また、第3引数の<code class="language-text">DeviceName</code>では、作成するデバイスオブジェクトに名前を付けることができます。</p>
<p>ここでは、先ほど定義した<code class="language-text">devname</code>を設定しています。</p>
<p><code class="language-text">DeviceType</code>には<code class="language-text">FILE_DEVICE_UNKNOWN</code>を指定します。</p>
<p>その他設定可能なデバイスタイプについては以下のドキュメントにまとまってます。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/specifying-device-types" target="_blank" rel="nofollow noopener noreferrer">Specifying Device Types - Windows drivers | Microsoft Docs</a></p>
<p>実際のコードは以下のようになります。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">PDEVICE_OBJECT DeviceObject<span class="token punctuation">;</span>
NTSTATUS status <span class="token operator">=</span> <span class="token function">IoCreateDevice</span><span class="token punctuation">(</span>DriverObject<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>devName<span class="token punctuation">,</span> FILE_DEVICE_UNKNOWN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>DeviceObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">KdPrint</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"Failed to create device (0x%08X)\n"</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>処理に失敗した場合は、<code class="language-text">KdPrint</code>関数でエラーメッセージを出力します。</p>
<h3 id="シンボリックリンクの作成" style="position:relative;"><a href="#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AA%E3%83%83%E3%82%AF%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AE%E4%BD%9C%E6%88%90" aria-label="シンボリックリンクの作成 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>シンボリックリンクの作成</h3>
<p>デバイスオブジェクトを作成しましたが、このままではユーザモードのクライアントからはアクセスすることができません。</p>
<p>ユーザモードのクライアントからデバイスドライバにアクセスするためには、デバイスオブジェクトのシンボリックリンクの作成が必要になります。</p>
<p>シンボリックリンクの作成は<code class="language-text">IoCreateSymbolicLink</code>関数で行います。</p>
<p>関数自体はシンプルで、<code class="language-text">PUNICODE_STRING</code>構造体に変換したシンボリックリンクとデバイスオブジェクトの名前を引数に与えるだけです。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iocreatesymboliclink" target="_blank" rel="nofollow noopener noreferrer">IoCreateSymbolicLink function (wdm.h) - Windows drivers | Microsoft Docs</a></p>
<p>実際のコードは以下のようになります。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">UNICODE_STRING symLink <span class="token operator">=</span> <span class="token function">RTL_CONSTANT_STRING</span><span class="token punctuation">(</span>L<span class="token string">"\\??\\SecondDriver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
status <span class="token operator">=</span> <span class="token function">IoCreateSymbolicLink</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>symLink<span class="token punctuation">,</span> <span class="token operator">&amp;</span>devName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">KdPrint</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"Failed to create symbolic link (0x%08X)\n"</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IoDeleteDevice</span><span class="token punctuation">(</span>DeviceObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>シンボリックリンクの作成に失敗した場合、すべての作業を取り消して終了する必要があります。</p>
<p>ここでは、<code class="language-text">IoDeleteDevice</code>関数を用いてシステムからデバイスオブジェクトを削除しています。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iodeletedevice" target="_blank" rel="nofollow noopener noreferrer">IoDeleteDevice function (wdm.h) - Windows drivers | Microsoft Docs</a></p>
<p>デバイスオブジェクトとシンボリックリンクの作成が完了したら<code class="language-text">DriverEntry</code>の処理は終了します。</p>
<h2 id="ディスパッチルーチンに割り当てるルーチンのセットアップ" style="position:relative;"><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%91%E3%83%83%E3%83%81%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AB%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97" aria-label="ディスパッチルーチンに割り当てるルーチンのセットアップ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ディスパッチルーチンに割り当てるルーチンのセットアップ</h2>
<p>先ほど以下の行で設定したCREATEとCLOSEをサポートするルーチンをセットアップしていきます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span>IRP_MJ_CREATE<span class="token punctuation">]</span> <span class="token operator">=</span> SecondDriverCreateClose<span class="token punctuation">;</span>
DriverObject<span class="token operator">-></span>MajorFunction<span class="token punctuation">[</span>IRP_MJ_CLOSE<span class="token punctuation">]</span> <span class="token operator">=</span> SecondDriverCreateClose<span class="token punctuation">;</span></code></pre></div>
<p>4章で作成したプログラムでは、CREATEとCLOSEのルーチンが同じ<code class="language-text">SecondDriverCreateClose</code>に設定されています。</p>
<p>これは、特別な処理をせずに単にIRP要求を受け入れるだけの挙動だからです。</p>
<p>CREATEとCLOSEで処理を分けたい場合は、ルーチンも異なるルーチンを作成して割り当てる必要があります。</p>
<p>実際にコードを見てみます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">_Use_decl_annotations_
NTSTATUS <span class="token function">SecondDriverCreateClose</span><span class="token punctuation">(</span>PDEVICE_OBJECT DeviceObject<span class="token punctuation">,</span> PIRP Irp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">UNREFERENCED_PARAMETER</span><span class="token punctuation">(</span>DeviceObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

	Irp<span class="token operator">-></span>IoStatus<span class="token punctuation">.</span>Status <span class="token operator">=</span> STATUS_SUCCESS<span class="token punctuation">;</span>
	Irp<span class="token operator">-></span>IoStatus<span class="token punctuation">.</span>Information <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">IoCompleteRequest</span><span class="token punctuation">(</span>Irp<span class="token punctuation">,</span> IO_NO_INCREMENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>なお、実際に書籍のサンプルのようにディスパッチルーチンを定義すると、ビルド時にコンパイルエラーC2440が発生しました。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">エラー	C2440	<span class="token char">'='</span><span class="token operator">:</span> '<span class="token function">NTSTATUS</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PDRIVER_OBJECT<span class="token punctuation">,</span>PIRP<span class="token punctuation">)</span><span class="token char">' から '</span>PDRIVER_DISPATCH' に変換できません。</code></pre></div>
<p>ググっても正直よくわからなかったのですが、割り当てる関数をプロトタイプ宣言じゃなくて<code class="language-text">DriverEntry</code>関数より前に直接定義してみたら解決しました。</p>
<p>ほんとにこれでいいのかはわからん。</p>
<p>そもそもWDMでカーネル開発すること自体が非推奨なので、最新のコンパイラだと何か引っかかっちゃうんですかね？</p>
<h3 id="関数アノテーション" style="position:relative;"><a href="#%E9%96%A2%E6%95%B0%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" aria-label="関数アノテーション permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>関数アノテーション</h3>
<p>先頭行に<code class="language-text">_Use_decl_annotations_</code>がありますが、用途が全く分かりませんでした。</p>
<p><code class="language-text">_Use_decl_annotations_</code>を使用することで、同じ関数のスコープ内のヘッダに表示されるアノテーションが<code class="language-text">_Use_decl_annotations_</code>を持つ定義にも存在するかのように使用される、とドキュメントに記載があります。</p>
<p>参考：<a href="https://stackoverflow.com/questions/24426875/what-is-use-decl-annotations-meaning" target="_blank" rel="nofollow noopener noreferrer">c++ - what is <em>Use</em>decl<em>annotations</em> meaning - Stack Overflow</a></p>
<p>参考：<a href="https://docs.microsoft.com/en-us/cpp/code-quality/annotating-function-behavior?view=msvc-170" target="_blank" rel="nofollow noopener noreferrer">Annotating function behavior | Microsoft Docs</a></p>
<p>しばらく調べたものの用途がわからなかったので、わかったら追記しようかと思います。</p>
<h3 id="irpの受け取り" style="position:relative;"><a href="#irp%E3%81%AE%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8A" aria-label="irpの受け取り permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IRPの受け取り</h3>
<p>IRPはアプリケーションからI/O要求が発生した場合に、I/Oマネージャによって作成される構造体です。</p>
<p>IRPは非ページプールに割り当てされ、データのパケットとして受け渡されます。</p>
<p>先にコードを見てみます。</p>
<p>4章のドライバで行っていることはシンプルで、引数として受け取ったIRPの<code class="language-text">IoStatus</code>の値を何やら書き換えた後、<code class="language-text">IoCompleteRequest</code>に引き渡しています。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">Irp<span class="token operator">-></span>IoStatus<span class="token punctuation">.</span>Status <span class="token operator">=</span> STATUS_SUCCESS<span class="token punctuation">;</span>
Irp<span class="token operator">-></span>IoStatus<span class="token punctuation">.</span>Information <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">IoCompleteRequest</span><span class="token punctuation">(</span>Irp<span class="token punctuation">,</span> IO_NO_INCREMENT<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>IRPは大きくIRPヘッダとスタックロケーションで構成されています。</p>
<p>アプリケーションからの要求をI/Oマネージャが受け取った後、IRPを非ページプールメモリに割り当てます。</p>
<p>その後、IRPヘッダとスタックロケーションを初期化してドライバのディスパッチルーチンを呼び出します。</p>
<p>詳細な流れについては以下の記事が非常に参考になりました。</p>
<p>参考：<a href="https://sciencepark.co.jp/device_driver/dvdr/report-25/" target="_blank" rel="nofollow noopener noreferrer">デバドラ講座25 │ サイエンスパーク株式会社</a></p>
<p><code class="language-text">IoStatus</code>はI/Oステータスブロックで、IRPが完了するとその完了状態が<code class="language-text">IoStatus.Status</code>に設定されます。</p>
<p>また<code class="language-text">IoStatus.Information</code>には読み書きされたバイト長が保持されます。</p>
<p>ここでは何も読み書きをしていないので、<code class="language-text">IoStatus.Information</code>は0を代入しています。</p>
<p><code class="language-text">IoCompleteRequest</code>マクロは、ディスパッチルーチンがI/O要求の処理をすべて完了し、IRPをI/Oマネージャに返却するためのマクロです。</p>
<p>これでCREATEとCLOSEに対してサポートするディスパッチルーチンの定義は完了しました。</p>
<h3 id="デバイスコントロールのセットアップ" style="position:relative;"><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97" aria-label="デバイスコントロールのセットアップ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>デバイスコントロールのセットアップ</h3>
<p>次に、<code class="language-text">DriverObject->MajorFunction[IRP_MJ_DEVICE_CONTROL] = SecondDriverDeviceControl;</code>の行で設定しているデバイスコントロールルーチンのセットアップを行います。</p>
<p>DEVICE_CONTROLは、ドライバとデータを受け渡す際に汎用的に使用可能なルーチンです。</p>
<p>DEVICE_CONTROLは入力バッファ、出力バッファ、制御コードの3つを受け取る必要があります。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-device-control" target="_blank" rel="nofollow noopener noreferrer">IRP<em>MJ</em>DEVICE_CONTROL - Windows drivers | Microsoft Docs</a></p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-i-o-control-codes" target="_blank" rel="nofollow noopener noreferrer">Introduction to I/O Control Codes - Windows drivers | Microsoft Docs</a></p>
<p>DEVICE_CONTROLには、以下のドキュメントに記載されている制御コードが渡され、操作が決定されます。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol" target="_blank" rel="nofollow noopener noreferrer">DeviceIoControl function (ioapiset.h) - Win32 apps | Microsoft Docs</a></p>
<p>実際にコードを見てみます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">_Use_decl_annotations_
NTSTATUS <span class="token function">SecondDriverDeviceControl</span><span class="token punctuation">(</span>PDEVICE_OBJECT<span class="token punctuation">,</span> PIRP Irp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// get our IO_STACK_LOCATION</span>
	<span class="token keyword">auto</span> stack <span class="token operator">=</span> <span class="token function">IoGetCurrentIrpStackLocation</span><span class="token punctuation">(</span>Irp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">auto</span> status <span class="token operator">=</span> STATUS_SUCCESS<span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span>stack<span class="token operator">-></span>Parameters<span class="token punctuation">.</span>DeviceIoControl<span class="token punctuation">.</span>IoControlCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> IOCTL_SECOND_DRIVER_SET_PRIORITY<span class="token operator">:</span>
	<span class="token punctuation">{</span>
		<span class="token comment">// do the work</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token operator">-></span>Parameters<span class="token punctuation">.</span>DeviceIoControl<span class="token punctuation">.</span>InputBufferLength <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ThreadData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			status <span class="token operator">=</span> STATUS_BUFFER_TOO_SMALL<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">auto</span> data <span class="token operator">=</span> <span class="token punctuation">(</span>ThreadData<span class="token operator">*</span><span class="token punctuation">)</span>stack<span class="token operator">-></span>Parameters<span class="token punctuation">.</span>DeviceIoControl<span class="token punctuation">.</span>Type3InputBuffer<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			status <span class="token operator">=</span> STATUS_INVALID_PARAMETER<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-></span>Priority <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> data<span class="token operator">-></span>Priority <span class="token operator">></span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			status <span class="token operator">=</span> STATUS_INVALID_PARAMETER<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		PETHREAD Thread<span class="token punctuation">;</span>
		status <span class="token operator">=</span> <span class="token function">PsLookupThreadByThreadId</span><span class="token punctuation">(</span><span class="token function">ULongToHandle</span><span class="token punctuation">(</span>data<span class="token operator">-></span>ThreadId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>

		<span class="token function">KeSetPriorityThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PKTHREAD<span class="token punctuation">)</span>Thread<span class="token punctuation">,</span> data<span class="token operator">-></span>Priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">ObDereferenceObject</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">KdPrint</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"Thread Priority change for %d to %d succeeded!\n"</span><span class="token punctuation">,</span>
			data<span class="token operator">-></span>ThreadId<span class="token punctuation">,</span> data<span class="token operator">-></span>Priority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">default</span><span class="token operator">:</span>
		status <span class="token operator">=</span> STATUS_INVALID_DEVICE_REQUEST<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	Irp<span class="token operator">-></span>IoStatus<span class="token punctuation">.</span>Status <span class="token operator">=</span> status<span class="token punctuation">;</span>
	Irp<span class="token operator">-></span>IoStatus<span class="token punctuation">.</span>Information <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">IoCompleteRequest</span><span class="token punctuation">(</span>Irp<span class="token punctuation">,</span> IO_NO_INCREMENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="現在のスタックロケーションの取得" style="position:relative;"><a href="#%E7%8F%BE%E5%9C%A8%E3%81%AE%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%AD%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%8F%96%E5%BE%97" aria-label="現在のスタックロケーションの取得 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>現在のスタックロケーションの取得</h3>
<p><code class="language-text">IoGetCurrentIrpStackLocation</code>関数は、現在のスタックロケーションを取得できます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">auto</span> stack <span class="token operator">=</span> <span class="token function">IoGetCurrentIrpStackLocation</span><span class="token punctuation">(</span>Irp<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>スタックロケーションは<code class="language-text">IO_STACK_LOCATION</code>構造体で定義されています。</p>
<p>ドライバはIRP内のスタックロケーションを利用してI/O操作に関するドライバ固有の情報を取得します。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-iogetcurrentirpstacklocation" target="_blank" rel="nofollow noopener noreferrer">IoGetCurrentIrpStackLocation function (wdm.h) - Windows drivers | Microsoft Docs</a></p>
<p>スタックロケーションには以下のような情報が含まれます。</p>
<ul>
<li>ドライバが実行するMajorFunctionsの情報</li>
<li>ドライバが実行するMinorFunctionsの情報</li>
<li>ドライバが転送するデータのバッファの長さや開始位置など</li>
<li>ドライバーが作成したデバイスオブジェクトへのポインタ</li>
<li>開いているファイル、デバイス、ディレクトリ、またはボリュームを表すファイルオブジェクトへのポインタ</li>
</ul>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/i-o-stack-locations" target="_blank" rel="nofollow noopener noreferrer">I/O Stack Locations - Windows drivers | Microsoft Docs</a></p>
<h3 id="要求された優先順位をスレッドに設定する" style="position:relative;"><a href="#%E8%A6%81%E6%B1%82%E3%81%95%E3%82%8C%E3%81%9F%E5%84%AA%E5%85%88%E9%A0%86%E4%BD%8D%E3%82%92%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B" aria-label="要求された優先順位をスレッドに設定する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>要求された優先順位をスレッドに設定する</h3>
<p>ここが今回作成するドライバの核になる実装です。</p>
<p><code class="language-text">SecondDriverDeviceControl</code>関数内で定義しています。</p>
<p><code class="language-text">IoGetCurrentIrpStackLocation</code>関数で取得したスタックロケーションには、受け渡された制御コードなどの情報が含まれます。</p>
<p>そのため、<code class="language-text">stack->Parameters.DeviceIoControl.IoControlCode</code>内の情報を元に処理を分岐させています。</p>
<p>ソースコードは以下です。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// switch (stack->Parameters.DeviceIoControl.IoControlCode)</span>
<span class="token keyword">case</span> IOCTL_SECOND_DRIVER_SET_PRIORITY<span class="token operator">:</span>
<span class="token punctuation">{</span>
	<span class="token comment">// do the work</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token operator">-></span>Parameters<span class="token punctuation">.</span>DeviceIoControl<span class="token punctuation">.</span>InputBufferLength <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ThreadData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		status <span class="token operator">=</span> STATUS_BUFFER_TOO_SMALL<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">auto</span> data <span class="token operator">=</span> <span class="token punctuation">(</span>ThreadData<span class="token operator">*</span><span class="token punctuation">)</span>stack<span class="token operator">-></span>Parameters<span class="token punctuation">.</span>DeviceIoControl<span class="token punctuation">.</span>Type3InputBuffer<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		status <span class="token operator">=</span> STATUS_INVALID_PARAMETER<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-></span>Priority <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> data<span class="token operator">-></span>Priority <span class="token operator">></span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		status <span class="token operator">=</span> STATUS_INVALID_PARAMETER<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	PETHREAD Thread<span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token function">PsLookupThreadByThreadId</span><span class="token punctuation">(</span><span class="token function">ULongToHandle</span><span class="token punctuation">(</span>data<span class="token operator">-></span>ThreadId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token function">KeSetPriorityThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PKTHREAD<span class="token punctuation">)</span>Thread<span class="token punctuation">,</span> data<span class="token operator">-></span>Priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ObDereferenceObject</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">KdPrint</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"Thread Priority change for %d to %d succeeded!\n"</span><span class="token punctuation">,</span>
		data<span class="token operator">-></span>ThreadId<span class="token punctuation">,</span> data<span class="token operator">-></span>Priority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">IOCTL_SECOND_DRIVER_SET_PRIORITY</code>は以下ように定義しています。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IOCTL_SECOND_DRIVER_SET_PRIORITY</span> <span class="token expression"><span class="token function">CTL_CODE</span><span class="token punctuation">(</span>SECOND_DRIVER_DEVICE<span class="token punctuation">,</span> <span class="token number">0x800</span><span class="token punctuation">,</span> METHOD_NEITHER<span class="token punctuation">,</span> FILE_ANY_ACCESS<span class="token punctuation">)</span></span></span></code></pre></div>
<p><code class="language-text">CTL_CODE</code>マクロは、引数の情報を元に制御コードのオブジェクトを生成します。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/d4drvif/nf-d4drvif-ctl_code" target="_blank" rel="nofollow noopener noreferrer">CTL_CODE macro (d4drvif.h) - Windows drivers | Microsoft Docs</a></p>
<p>受け渡された制御コードが<code class="language-text">IOCTL_SECOND_DRIVER_SET_PRIORITY</code>の場合、処理を実行します。</p>
<p>以下は入力値チェックを行っています。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token comment">// do the work</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token operator">-></span>Parameters<span class="token punctuation">.</span>DeviceIoControl<span class="token punctuation">.</span>InputBufferLength <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ThreadData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	status <span class="token operator">=</span> STATUS_BUFFER_TOO_SMALL<span class="token punctuation">;</span>
	<span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">auto</span> data <span class="token operator">=</span> <span class="token punctuation">(</span>ThreadData<span class="token operator">*</span><span class="token punctuation">)</span>stack<span class="token operator">-></span>Parameters<span class="token punctuation">.</span>DeviceIoControl<span class="token punctuation">.</span>Type3InputBuffer<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	status <span class="token operator">=</span> STATUS_INVALID_PARAMETER<span class="token punctuation">;</span>
	<span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-></span>Priority <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> data<span class="token operator">-></span>Priority <span class="token operator">></span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	status <span class="token operator">=</span> STATUS_INVALID_PARAMETER<span class="token punctuation">;</span>
	<span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>今回は最終的にスレッドの優先順位を設定するため、受け渡されたバッファに<code class="language-text">ThreadData</code>を格納する必要があります。</p>
<p>そのため、<code class="language-text">stack->Parameters.DeviceIoControl.InputBufferLength</code>のサイズの確認を行っています。</p>
<p>サイズ確認後、<code class="language-text">(ThreadData*)stack->Parameters.DeviceIoControl.Type3InputBuffer</code>にてスタックロケーションのバッファを<code class="language-text">ThreadData</code>にキャストします。</p>
<p>ヌルポインタになった場合はエラーを返します。</p>
<p>最後に、<code class="language-text">ThreadData</code>の<code class="language-text">Priority</code>の値が規定の範囲に収まっているかを確認します。</p>
<p>受け渡されたデータのチェックが完了したら、<code class="language-text">KeSetPriorityThread</code>関数でスレッドの優先順位を設定します。</p>
<p><code class="language-text">KeSetPriorityThread</code>関数は、第1引数に優先順位を設定するスレッドのポインタを受け取る必要があります。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-kesetprioritythread" target="_blank" rel="nofollow noopener noreferrer">KeSetPriorityThread function (wdm.h) - Windows drivers | Microsoft Docs</a></p>
<p>そのため、<code class="language-text">PsLookupThreadByThreadId</code>関数を用いて、受け渡されたスレッドIDからスレッドオブジェクトのポインタを取得します。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-pslookupthreadbythreadid" target="_blank" rel="nofollow noopener noreferrer">PsLookupThreadByThreadId function (ntifs.h) - Windows drivers | Microsoft Docs</a></p>
<p><code class="language-text">PsLookupThreadByThreadId</code>関数は<code class="language-text">ntifs.h</code>をインクルードすることで使用可能です。</p>
<p>コンパイルエラーを回避するため、<code class="language-text">ntifs.h</code>は<code class="language-text">ntddk.h</code>より前にインクルードする必要があります。</p>
<p>コードを見てみます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">PETHREAD Thread<span class="token punctuation">;</span>
status <span class="token operator">=</span> <span class="token function">PsLookupThreadByThreadId</span><span class="token punctuation">(</span><span class="token function">ULongToHandle</span><span class="token punctuation">(</span>data<span class="token operator">-></span>ThreadId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

<span class="token function">KeSetPriorityThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PKTHREAD<span class="token punctuation">)</span>Thread<span class="token punctuation">,</span> data<span class="token operator">-></span>Priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ObDereferenceObject</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">KdPrint</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token string">"Thread Priority change for %d to %d succeeded!\n"</span><span class="token punctuation">,</span>
      data<span class="token operator">-></span>ThreadId<span class="token punctuation">,</span> data<span class="token operator">-></span>Priority
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">break</span><span class="token punctuation">;</span></code></pre></div>
<p>優先順位をセットした後に<code class="language-text">ObDereferenceObject</code>マクロを呼び出しています。</p>
<p>このマクロは引数で受け取ったオブジェクトの参照カウントをデクリメントするマクロですが、用途がいまいちよくわかりませんでした。</p>
<p>参考：<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-obdereferenceobject" target="_blank" rel="nofollow noopener noreferrer">ObDereferenceObject macro (wdm.h) - Windows drivers | Microsoft Docs</a></p>
<p>参照カウントとは、そのオブジェクトへの参照もしくはポインタがシステム内にいくつ存在しているかをカウントするもののようです。</p>
<p>この参照カウントが0であれば、システム(たぶんGCなど)によって破棄することが許可されます。</p>
<p>参考：<a href="https://ja.wikipedia.org/wiki/%E5%8F%82%E7%85%A7%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88" target="_blank" rel="nofollow noopener noreferrer">参照カウント - Wikipedia</a></p>
<p>ここで<code class="language-text">ObDereferenceObject</code>による参照カウントのデクリメントを行うのは、システムのリークを防ぐためです。</p>
<p><code class="language-text">PsLookupThreadByThreadId</code>は、受け取ったスレッドに対しての参照カウントをインクリメントします。</p>
<p>そのため、終了時までに<code class="language-text">ObDereferenceObject</code>によってデクリメントを行わないと参照カウントが増加したままになり、リークが発生します。</p>
<p>これでカーネルドライバ側の実装を一通り追うことができました。</p>
<p>クライアントの実装についてはこの記事では割愛します。</p>
<p>詳しくやりたい方は<a href="https://amzn.to/3H3WMoe" target="_blank" rel="nofollow noopener noreferrer">Windowsカーネルドライバプログラミング</a>をご購入ください。</p>
<h2 id="ドライバのインストール" style="position:relative;"><a href="#%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" aria-label="ドライバのインストール permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ドライバのインストール</h2>
<p>前の記事と同様の手順で、作成したドライバをシステムにインストールします。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">$ <span class="token function">sc</span> create second <span class="token function">type</span>= kernel binPath= C:\Driver\SecondDriver\SecondDriver<span class="token punctuation">.</span>sys
<span class="token namespace">[SC]</span> CreateService SUCCESS

$ <span class="token function">sc</span> <span class="token function">start</span> second
SERVICE_NAME: second
        <span class="token function">TYPE</span>               : 1  KERNEL_DRIVER
        STATE              : 4  RUNNING
                                <span class="token punctuation">(</span>STOPPABLE<span class="token punctuation">,</span> NOT_PAUSABLE<span class="token punctuation">,</span> IGNORES_SHUTDOWN<span class="token punctuation">)</span>
        WIN32_EXIT_CODE    : 0  <span class="token punctuation">(</span>0x0<span class="token punctuation">)</span>
        SERVICE_EXIT_CODE  : 0  <span class="token punctuation">(</span>0x0<span class="token punctuation">)</span>
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 0
        FLAGS              :</code></pre></div>
<p>このあと<code class="language-text">WinObj</code>の<code class="language-text">GLOBAL??</code>を確認すると、作成した<code class="language-text">SecondDriver</code>のシンボリックリンクが存在していることが確認できます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/11cd136e5be9b88c1e7f11fa9ff10614/0b533/image-21.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 74.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACJUlEQVQ4y5WUCY+iQBCF+f9/bbJHdjMqKF4Icsh9CYpv69XYhtlsJtlOKqSb5utXr6qx4qxC29So6xpN06CqZN52mKYJ9/sdt9vty+A+Mx6PByw3OCMrY6TpBVmawfd9hOcQQRAgiuLXQX8HD87zAlmWKXgYBhEwweqrPdJ4h7rp9GUcxxoEt22L67VH13X/DL7fbDbY7/a4XC6q0hrbAIf1G4qyVZVU1IoCquUBZVliHEdVMA+ztt1uFfoC3roA3vYHmnbQE5nOcL0KLFelBNNLBj0y3hp/CfNPvqSfywEjrGmIsHPeEMWZwqgoFxjhxmgGAX3fq7L5muu6EhuEUaRz636VAhx+I0kKSbdCJcC6+ijEVZRSET+mmrIo9UCzRgAVLpdLJCble3/WlPO8ViBBVBGGkao0agjJ0lRTI4iDT8dxsFgsECfJsyidj6P7XWC9wGoURaEgFsb0mAHO4SbWzvpDYfJUOEiV/cMv5EUj/XeWlCR16bFIFLIPz7LGnqRqAzeDQHrItHMRosBpGjEOvU7YMpX4p+mwWcVDFoLxUvh8mmqzbdabNTKxQoGYDXY/of8zCKTKSKrMLCzji1HIBu26VuHzaORdnJVwjiHcIFUrPM+Dbds47Pd6W+i/NfeFFV6tVtjLBvoWhuGn8OWOv9sbfPv5Lqq2uo/A0+mkQlThHMj7aduO3JDkedk//224ryxyrGVPXTf6DVU6MveOngL/AA+cfmoXU3IpAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/11cd136e5be9b88c1e7f11fa9ff10614/8ac56/image-21.webp 240w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/d3be9/image-21.webp 480w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/b0a15/image-21.webp 500w"
              sizes="(max-width: 500px) 100vw, 500px"
              type="image/webp"
            />
          <source
            srcset="/static/11cd136e5be9b88c1e7f11fa9ff10614/8ff5a/image-21.png 240w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/e85cb/image-21.png 480w,
/static/11cd136e5be9b88c1e7f11fa9ff10614/0b533/image-21.png 500w"
            sizes="(max-width: 500px) 100vw, 500px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/11cd136e5be9b88c1e7f11fa9ff10614/0b533/image-21.png"
            alt="image-21.png"
            title="image-21.png"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>ドライバがインストールできたので、クライアントアプリケーションを使ってスレッドの優先順位を設定してみます。</p>
<p>今回は検証のためにメモ帳アプリのスレッドを操作することにしました。</p>
<p>Proexpから、メモ帳のスレッドの優先順位が10に設定されていることがわかります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 554px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/87f9871280c443cd79688290c6f4679e/04abd/image-22.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 115.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD/0lEQVQ4y51VWW8bVRSev4yExBu8wBu80AfUNwQPPLRpgUqJEzduHbUpjp3W9tgzXmbfN8/qNfb449wxCUGtIOLI13eZud/5zjrcelei2+5hePQU0vExgqkEfzKBrSowHBO+Z0BXJ3AsDas8Qeg5SFwHqa7DGA5hj0Zwx2N4kgTp8hLchgCHXR6jkxeQ6mcIoxlM14XregiCEJblwDJtFPMFFssV4iRBmuVI8wLbskRO5wHdYcQsIsKttzsIoym06w6mVy1kcYzRaAyTgNjFducaE0mG6/no80NMyAJBHKHVakNRNdi2g3a7A1UzYCsKOCeM0TlvYFKvQW82MScGyyLFfrMAsAUtaN4BJc3bJa33f+9vVof1dl2dK4MBuClpcS0Tq8WiYhfMErT1Ag0xRI33cdL38OK9hedXGl5PM/zWMfDsSkWNzpuij9MPOi7lBCN/BZ98yw2nUzJBhGXbiKIQUZLjlz8M/PjWwK/iAkd8jqNBgWc07tbDAk/7GX6o8fj+9w4eHffRGEWIAg+cTY4XKVKGYVAQAhR5TuyZqTf4LynJLdtljnI9J8tv4DjEUJRl6KaJzXaLxeoQxf2tp8r9v477sqMo2wxQljWofR4JMVxSJLM0w57e3dPf7bgvt/t/PKex3e0QMMCmIeIRsfwpmeHnOIJHDKsL+BjsU1KBVvaX6FgWuCfda3x20sXndQFfnAuwKI3uM3gIYLk/OOl8IIOT7BRvzmS06z4+NGeYRelfL+LBgKh+JaYimRyEFlrvFdQaFuqvTEqd7CMfPWSQzRgKZHIYBaidXuDJ8z5qZyrCMMX/lcHAoNKLU5y+fId6vYWLix4xjLHZbLBar7GlOmfr9XpDabEjv5fVXBQFZrMZzXPklLcRNYcVpZw4Ih8W8zmSNEaWJZSYFmIqP03TqXKcSmuWZXBovSYFaZpiSd0ljiKMqboC34dNOczzlHaUHTZVG+d5HhZUx4yJROnj096y7OqMCZtVRYVGNT+hvucQm3CxREyMdofWcCesfLlut1shM3MUaj8+aTVNi4D9O0BFUirAkvb56yaEL7+C8PU3CB4/hvXtd4jfvK3eHVMJc4wus58JA6yaKgGahkkmZpWPWLPNqTcyWVJFKWcvoTZeIe/1MWtdISFlTCaswfZ6PWJkVgcj0hCGYQXAfMv8tlwu4BFbBs5kQ5bofgjDDxCT6fczVSaXcYIgVIuIHM3YMsd/Slg3YsrZnFGJGvTNicMAlqGD7x/uVYCqqt5dEilyjCFzAfPd/cGizZQmSQrNnUFQbMh2BJfY6ppGaRRXFlYMbyPd7/crLS59pCwqdBas28F6HTtnLaotqGhc8XjHyxhLKq47HQiCWFn4J+DUtzkoTpmRAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/87f9871280c443cd79688290c6f4679e/8ac56/image-22.webp 240w,
/static/87f9871280c443cd79688290c6f4679e/d3be9/image-22.webp 480w,
/static/87f9871280c443cd79688290c6f4679e/5e3e0/image-22.webp 554w"
              sizes="(max-width: 554px) 100vw, 554px"
              type="image/webp"
            />
          <source
            srcset="/static/87f9871280c443cd79688290c6f4679e/8ff5a/image-22.png 240w,
/static/87f9871280c443cd79688290c6f4679e/e85cb/image-22.png 480w,
/static/87f9871280c443cd79688290c6f4679e/04abd/image-22.png 554w"
            sizes="(max-width: 554px) 100vw, 554px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/87f9871280c443cd79688290c6f4679e/04abd/image-22.png"
            alt="image-22.png"
            title="image-22.png"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>このスレッドを最大の優先順位である31に設定してみます。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">C:\Driver\SecondDriverClient<span class="token punctuation">.</span>exe 8616 31</code></pre></div>
<p>アプリケーションの実行が完了すると、このようにメモ帳スレッドの優先順位が31に変更されました。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/590aec4f72437db74fea11a1a8190b43/0b533/image-23.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 73.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAARlAAAEZQAGA43XUAAACGElEQVQ4y41UyW7aUBQ1IKGUn2EDUrpJJSS+gR3iY1inq4Ao/YAki+YbElA2CClpWiExKHbAE3gMNmCwOb3vpaG0JYErHb/B9x7f0cJYVWFbFkzT4PC8KVzHxrNtw3NdOKYJlyA1mlBub6E0mwgHAzBZr9fsgW0RGKFhWtB1HaqqQdNe1sdHkT5gQVYUqIoK8eYGo0YDw+trhP3+24TGZAKFjAzDICIVEzqPx2Mi1iBJEr9zyFtHeoIvy/BGI0QUESPbBUEnY0kUYZESIzUpPAZG3G630Wq1uPchDhMhCIK9Sp7ncS+Z7mI+R7BY8P2/WC6XEHxSYBLtcH+1WvF3366ucHLyCfl8HrlcDh+Pj5HNZjkymcxmTafTECxvtknwW4Rf6nUIgoBUKoVkMokPR0dIJBL87j9Mp/O9hLVabUMYi8U2xmz/emZrPB5nhH88/Eu2CM/OKtyIG+zyahu6PoZtO5ToAI7jwvd8eL4PjaqsU9W92Qynp58PJ5RHMhHaiMIIIjXzkPpMfxpC+vETJrUTogjVavVwQta4bDJ88kqVFd5v07t7dOtfoV1eAt0uar+LchAha+L5bM57yKHQ2dlynzGkEZzQLDOpVF5yyCrMqvsehBnlKKKwwjAk0gAyjZdJudNp9GQKn+3L5fJ+z17R6XQwoL9HnwaeQaS89bo9PHx/QK/X47N8fn6BQqGAUqmEYrH4Ln4Bvx1oDKTeWugAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/590aec4f72437db74fea11a1a8190b43/8ac56/image-23.webp 240w,
/static/590aec4f72437db74fea11a1a8190b43/d3be9/image-23.webp 480w,
/static/590aec4f72437db74fea11a1a8190b43/b0a15/image-23.webp 500w"
              sizes="(max-width: 500px) 100vw, 500px"
              type="image/webp"
            />
          <source
            srcset="/static/590aec4f72437db74fea11a1a8190b43/8ff5a/image-23.png 240w,
/static/590aec4f72437db74fea11a1a8190b43/e85cb/image-23.png 480w,
/static/590aec4f72437db74fea11a1a8190b43/0b533/image-23.png 500w"
            sizes="(max-width: 500px) 100vw, 500px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/590aec4f72437db74fea11a1a8190b43/0b533/image-23.png"
            alt="image-23.png"
            title="image-23.png"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h2 id="カーネルデバッグで挙動を確認してみる" style="position:relative;"><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%A7%E6%8C%99%E5%8B%95%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B" aria-label="カーネルデバッグで挙動を確認してみる permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>カーネルデバッグで挙動を確認してみる</h2>
<p>さて、ここまでずいぶん時間がかかりましたが、ここからがようやく本題です。</p>
<p>WinDbgからカーネルデバッグを行い、自作したカーネルドライバの動きを見てみたいと思います。</p>
<p>カーネルデバッグの設定方法については過去にも紹介したので割愛します。</p>
<p>参考：<a href="/windows-windbg-004-kernel-debug">WinDbgでWindows10環境のカーネルデバッグを行う最初の一歩</a></p>
<p>参考：<a href="/windows-windriver-001-tutorial">Windowsカーネルドライバを自作してWinDbgで解析してみる</a></p>
<h3 id="ブレークポイントを設定する" style="position:relative;"><a href="#%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B" aria-label="ブレークポイントを設定する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ブレークポイントを設定する</h3>
<p>とりあえずカーネルデバッグを仕掛けたあと、<code class="language-text">SecondDriver</code>のモジュールがロードされていることを確認します。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">kd> lmDvmSecondDriver
Browse full module list
<span class="token function">start</span>             <span class="token keyword">end</span>                 module name
fffff801`18390000 fffff801`18397000   SecondDriver   <span class="token punctuation">(</span>deferred<span class="token punctuation">)</span>             
    Image path: \??\C:\Driver\SecondDriver\SecondDriver<span class="token punctuation">.</span>sys
    Image name: SecondDriver<span class="token punctuation">.</span>sys
    Browse all global symbols  functions  <span class="token keyword">data</span>
    Timestamp:        Sat Jan 29 20:08:51 2022 <span class="token punctuation">(</span>61F52043<span class="token punctuation">)</span>
    CheckSum:         0000EB8D
    ImageSize:        00007000
    Translations:     0000<span class="token punctuation">.</span>04b0 0000<span class="token punctuation">.</span>04e4 0409<span class="token punctuation">.</span>04b0 0409<span class="token punctuation">.</span>04e4
    Information <span class="token keyword">from</span> resource tables:</code></pre></div>
<p>ここまでソースコードを見てきた通り、クライアントからのIRPを受け取って実際に優先順位を変更する処理を行うのは<code class="language-text">SecondDriverDeviceControl</code>です。</p>
<p>そのため、<code class="language-text">SecondDriverDeviceControl</code>にブレークポイントを仕掛けた状態でクライアントアプリケーションによる優先順位変更を実施します。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">kd> bu SecondDriver!SecondDriverDeviceControl
kd> bl
     0 e Disable Clear  fffff801`18391040  <span class="token namespace">[G:\Try2WinDbg\drivers\SecondDriverSample\SecondDriver\SecondDriver.cpp @ 18]</span>     0001 <span class="token punctuation">(</span>0001<span class="token punctuation">)</span> SecondDriver!SecondDriverDeviceControl</code></pre></div>
<p>先ほど同様にメモ帳を起動して、メモ帳のスレッドの優先順位を31に変更するよう、クライアントアプリケーションから要求を実行します。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">C:\Driver\SecondDriverClient<span class="token punctuation">.</span>exe 8520 31</code></pre></div>
<h3 id="irpを解析する" style="position:relative;"><a href="#irp%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%99%E3%82%8B" aria-label="irpを解析する permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IRPを解析する</h3>
<p>今回はソースウィンドウも出してみました。</p>
<p>ブレークポイントで処理が停止したときに、ソースコードのどの箇所かが一目でわかるのでとても便利です。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 932px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/821532881aff984b5d35308ef816777d/f6f78/image-24.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 93.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADWUlEQVQ4y41U2W4jNxCcL88X5Cm/k7dkN8FaWh/yWrJkaWRJc5+c+55KNSUHxgIBQqDQlEg2q7qLY/z2p4Vf/3Dwy+8XfDmkyPIaQVrBTwp4cc55qRGqCm6UYbc/Y7lcYfW8RRSlOJ0uGmEYw/NCGGXdoO9auJYsHGEe32E5DmHD9Tw0XYdpnjW6foDKChwOJtYvG5zez3h+fsEPzo+cO44HIy0rVA0QRh1vVIhChboeMI7Q+DymaSaTDL7fEBUsK4XjKgRBA6VGVBVgxHEC33tC4P4F1/4bgX+HLH1ElhDxE/GIQq1QZU9oa5csIry9XWCaNvZ7h3MP+0OI4zGmwoAM8xx5WeB4NuH4O8Yf2JmPuNhbFLkPldioyhDjkGHoa9i2h91uj/3bHpuNidXqjO3WxcGM8W46MDLyrFtKDibSZhP8mBIiJLHSRW+a7oYeXdfrkvg+GxWwaV5L2YDtEDYon5LTokI/TsiLGn7swfIsJmLCJEYcxyiKAiUVSKx4uWO7ZLjF6+sL2Z2wWJZYr1t2vcXD9wFGkpcYpIvsgB/mtE3OwywDY5ZlbFCNYRhuGHE+W7TNEg8Pj7i7W2CxWLLr4g4Tr2vrynBkwqaemYAdZ8vTNGcsNaOczCSp/K5psTM9t1gscH9/r3H37RtL4FP6hTXcw1C3hG078U+RWbE2qWanVKalTtNEC31iqBN+J8t7fP36BevNhl038U4Pa4Yiue8GyixRsF5NU2tWIrssSjajY8IR3MbLAnZ1i836jdEkdpR8oG2OvOxyqyENOxNxUmvJZVlqZmma6jhLJsza2Emq4LoeLpecUlvuKWj2gF33eVl8TThxuxyMaHJJIrUTVh/NaNtW/xbbWJbD7q5o6h0lHmjmEy9wdR0Vzxox3+bAGhVFo51u0xZym1Lq1oxKo2kaHUWyR4ZhGPGF+Xoury1JrmQMy3K1gaMo4ULORAVvyrkh46FExywrNaT7tu3rr0qeV7rmAlmTfXHMhEVxtYNACi9RujnS7DLv+6vsru14WOqqdJQ9svYZNZ+cEYShlvIxxC5ibJEotRPLyOj7ns/S17Uef/4M3YZcYgw/LUoCYSSHrgfnf9ek2/M84b+G7DfyTOqlUFZXywiE+kcZPv77Pyjo6X8AsbaeA26Sb2AAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/821532881aff984b5d35308ef816777d/8ac56/image-24.webp 240w,
/static/821532881aff984b5d35308ef816777d/d3be9/image-24.webp 480w,
/static/821532881aff984b5d35308ef816777d/3b46e/image-24.webp 932w"
              sizes="(max-width: 932px) 100vw, 932px"
              type="image/webp"
            />
          <source
            srcset="/static/821532881aff984b5d35308ef816777d/8ff5a/image-24.png 240w,
/static/821532881aff984b5d35308ef816777d/e85cb/image-24.png 480w,
/static/821532881aff984b5d35308ef816777d/f6f78/image-24.png 932w"
            sizes="(max-width: 932px) 100vw, 932px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/821532881aff984b5d35308ef816777d/f6f78/image-24.png"
            alt="image-24.png"
            title="image-24.png"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>ソースウィンドウは非常に便利で、ソースコードからブレークポイントをさらに設定することができます。</p>
<p>今回はクライアントアプリケーションから受け取ったIRPの情報を確認したいので、スタックロケーションの取得が終わった次の行にブレークポイントを設定します。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 565px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e832e3c4755d1dba113b7cb74dd97190/07eba/image-25.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 77.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACnklEQVQ4y51SaWvcMBDd//9bCik0NNC0C0lp6UELSWC76+2uL61vr23Zsny/jrQHaUL6oQPDjEbS6L2nmaWej4hzuNYXuOZnBOw77M0nbI1b+O43VPkSNTcgyUWxAs+WkJWBkupNtUZdriD4iuISY59jlrAdwiJD4t/AMC5gsktsnUtYuyssrVfYum+wti9gOK/hs2v4zjVi7wM8ivtwjjy+0Z5Fc/SNj1lkOciaHsp+2ykebr/i/t0NFu8/4ufVHHfXt3ig/MfbOUIWo5IDOG9RVR1y3uCpzSLTRiJoYxrpkES0ceH/WsK9u4e/XMFbLBGu1gioVuUZmrZBXQu0jYSUAkJU2mvycRwxK0SNQraYpgmODYRJhyhNESQpGOlrMxfObocgjmFaFsliIAhDlGWJnB7gpL+KRVFgGKhhlhcIy5oQTvRSh5JeSnmCOI8R7gPUhKJrO/R9j77r0PU9XjIFapYXXCM8WcF7+JEHL2LYBQyWbSEIAnieB9/3Ke6wI8T7/R5JktBeiJQYRVGkIyHkB4Rk4zjRMwBjJVariHRq9SF1MSbKqolaq1wIoTVTrpANw6BdI0yEPDYcqdgec/yX6Yb5kbJ6ybQ5HNcjNDEJLeC6KSyLISFkGSEs8hxZliEMD1RThfrIQDHRDeNKnhtWJbBe29hsTLogsFiE2G4OusVxpLVkjCGmyyeaJ1cf9wwhMNA8gkQejiSUTofDyg+yDDq+SPkxwroeaGBrtK2kvKZc6vlSey2NTUMD3dBnqXrbtto7qv81Nll9Qgj6WfXLHhyHaX1M0zyOjU96unptbk2d19RU1lI3PzdUgx1wcSBHhWkaSLuRmkrKR01ToWiaRiNRKNW6H4ZnQ32mXDzScHhy8F82aQDTuZmKfwBc9sV5X3o0CgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/e832e3c4755d1dba113b7cb74dd97190/8ac56/image-25.webp 240w,
/static/e832e3c4755d1dba113b7cb74dd97190/d3be9/image-25.webp 480w,
/static/e832e3c4755d1dba113b7cb74dd97190/acb73/image-25.webp 565w"
              sizes="(max-width: 565px) 100vw, 565px"
              type="image/webp"
            />
          <source
            srcset="/static/e832e3c4755d1dba113b7cb74dd97190/8ff5a/image-25.png 240w,
/static/e832e3c4755d1dba113b7cb74dd97190/e85cb/image-25.png 480w,
/static/e832e3c4755d1dba113b7cb74dd97190/07eba/image-25.png 565w"
            sizes="(max-width: 565px) 100vw, 565px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/e832e3c4755d1dba113b7cb74dd97190/07eba/image-25.png"
            alt="image-25.png"
            title="image-25.png"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>今回は今までと趣向を変えて、GUI中心に解析をしてみようと思います。</p>
<p>スタックロケーションの取得が終わった次の行に処理を進めた時点で、Localsウィンドウからスタックロケーションの情報を参照します。</p>
<p>WinDbgのGUI上では、こんな感じで構造体の情報が整形されて確認できるようになります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 899px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/dd5b748009f59f5d831aa65ca2a4850a/681f1/image-26.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABZUlEQVQoz3WQ/U6DMBTF9/5/G+O2zBgTE9/CxGzTJe4J/JoDyvimhQKDwrG9yIIzNjk0vYf76+md3G8Zrjcu5msLNy8eFhuG6WqPmdZ8bVP94uEN06U+P9lUm60sLJ77vqvlFy4fP3G79XG39TCppYAIXSjJYVZbCPCAoUgClGlIqniESvSCKnuhAfcZYtc69QKdBtYNbOYi4UIfAS4y1E37Y/eii4y6fjc1pT+v7x9w/YB8pU3VaaCUBRzHQS5zMsqyBOcceZ6jqiocj0eqKaX6S3TTIOYw2LaNtm1P3sQ07XY7uK6rjQ48TbG39ojimIBG50BKrCGMMXieB6FfJXPZA02SVEOGH7Msw8E7INZAKSWKoqD9HGj2IAgQhiHquiafgHGcIIoieqIpmISWZZ0uGWsMNACTMEkS6i306AjIhaAnDcsk8n2fEpq5mnQmddM0fxIOs/41w/Fh+Pm/dZ5yXB/0DZlCsRg+O4h1AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/dd5b748009f59f5d831aa65ca2a4850a/8ac56/image-26.webp 240w,
/static/dd5b748009f59f5d831aa65ca2a4850a/d3be9/image-26.webp 480w,
/static/dd5b748009f59f5d831aa65ca2a4850a/8bcb7/image-26.webp 899w"
              sizes="(max-width: 899px) 100vw, 899px"
              type="image/webp"
            />
          <source
            srcset="/static/dd5b748009f59f5d831aa65ca2a4850a/8ff5a/image-26.png 240w,
/static/dd5b748009f59f5d831aa65ca2a4850a/e85cb/image-26.png 480w,
/static/dd5b748009f59f5d831aa65ca2a4850a/681f1/image-26.png 899w"
            sizes="(max-width: 899px) 100vw, 899px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/dd5b748009f59f5d831aa65ca2a4850a/681f1/image-26.png"
            alt="image-26.png"
            title="image-26.png"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>アプリケーションから受け渡しされた引数は、デバイスコントロールルーチンに渡されたIRPの入力バッファに格納されているのでした。</p>
<p>入力バッファの参照先を確認すると<code class="language-text">0x1cefd9f6d8</code>であることがわかります。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 309px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/2b706ba164031ccb8f6aa1e71b152317/532e8/image-27.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 48.75000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaElEQVQoz51Sa3OCMBDk//+6dqYqIEkgQVTeCFYewvYSi6XUT72ZnUnC3XK7d9bnrUVZXdDUNeI4Rl4UBhMeMU2TwfL8fX2+L8O6NFdIFSIIAgOfIKVEQ+/DMDwT18WvyAzhre2QpClCIlFKGTIpFVzHRVlWGMcR9/vdJM/nZYdrYmu+5nkGxgR8weExD77vQx0i2LaNlH6ooyhyCCFwH6eF/N92WPNDQYQ+JXPG4bp7yPAAxpnBHFVZGgVr6Uv8EGYZBBdQRKS91J2cz2cjc86pqhLbzQZMBAhVgOh4+uth13VUMOJ0OmG/38NxHXDOSeoOu52N6lKj7ztCjzRJqHvHKHh/f8PHZktWFTS8Hm3bQnNZNU2zIClKSdiOA+a5ROwaqXo4GRVosq7ryZacujricAiNGuZ5iJMUQ/8g1LCqujF+Sb0utD6aWPuUkgX/CSK8Gt886sqhVeE03SiKnmuyNn2JV9+/AHrb/uPrOEYXAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/2b706ba164031ccb8f6aa1e71b152317/8ac56/image-27.webp 240w,
/static/2b706ba164031ccb8f6aa1e71b152317/451be/image-27.webp 309w"
              sizes="(max-width: 309px) 100vw, 309px"
              type="image/webp"
            />
          <source
            srcset="/static/2b706ba164031ccb8f6aa1e71b152317/8ff5a/image-27.png 240w,
/static/2b706ba164031ccb8f6aa1e71b152317/532e8/image-27.png 309w"
            sizes="(max-width: 309px) 100vw, 309px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/2b706ba164031ccb8f6aa1e71b152317/532e8/image-27.png"
            alt="image-27.png"
            title="image-27.png"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>というわけで、メモリウィンドウから参照先のアドレスに格納されている値を見てみます。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 403px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/321e106c693079f7889192779df1e18a/045fd/image-28.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 96.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADfklEQVQ4y1VUy44iNxTlW7LJcr4hi/xdlMVEihQpUTSfMYtITTfh2VBV1NvlerseUBQ0dAMzPZo5uXYBPUG6cvnaPj73nmN6TbNDXTUQeQXGQoQ8UfP9bo+oaPFhXOCvYY7f7zO8v8vwWz+DFjV4ftqj3Txh2/4/eqvVBq4fQWMCMzfFo1/AKQ4I6wM+Ohv8/DfHT38yvHvv4IdfTPz4q4U/hiWSeg8z28HJu7ApXEGAL8/PSFOBdrtD27bYPB0RiTXCtISoWxRFiSwrcDqdcf19+gK8fP6G42s3XmN//ore6+sXbLcHZElM5QZYbzYoqwpRnGC1brBqGmSiQEXfTbvF4eWI4+mE7W6HzXaLl+OR4oT94UD5cwfYtntM5xb+6U8xmtkYzyw8DHUMpzblPQxGSwzGMgz0/9XVqOYjg/Y6GD86t7F3otvqusFCd9AfzDCRi1PaPNQw0zxoywBz3YducugWx9xgKmdYIQw7VPNHWp/rjPb76B2JsgQ09AXu7/uIqXTOXFiWhaoq0TQrNdZ1iVVdqXG9qlGIHEJkKAuBshSoKGpa752o/hUBuo6D2WyGJM1UL13Xp16WJEpBuRRplpE4GQmYIs9zRFFMERGBhIBztU+I8g1Q1xbo9/vgYQzmuTAME7kQSOiA7/tgQYA47kAksMy5rgvOOQJa4xSO670BOraFyWSi1OWBD9t2kRGTuq4VqAxpoYoc0JDyEpiH9BAosixVzIvyu5KXBik3GCCkUgLmwTRttamkTTFdIkvMMiqNLLSiHgYBp5fFVEhQTm0KePgGaBPDMTGUPYzCgOaOYiPLkwckwyiOVNkxgYcXdh0YV6PvszdA01xiOBophsx3MZ8vqOQMOQHKA4L6eRXkmpO9C0NOF0RKOHn2BmjoGtnmnpIJwoBhsdCUsvJwFEYXNpEqWxCoLFWJxXz1Hcn17wFdh17FdEY2SGmRE2MLgqxQlqUSIKG8LL+45TrFVRCYZBkQazJ2B6gt5ri7u1ON9Vwbo/FEbUhIEIc86nnehREj0ZiaS9t4ZLFu9GBR32+Ajm1jMp3eGC6XJv0p5IqNEoJC9kmy7Ix9aUPUCSPnLLgwlE/PXHa2kT6UPdQ1Q5WcU8+kAFfPKWBSnLHgZhvFms4oY5/Pn7Bet0qUh4cHdYvvOdA0nRglShRpB/9ykNO6BL2Kcg05l4D/AZt2VHCOZCKvAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/321e106c693079f7889192779df1e18a/8ac56/image-28.webp 240w,
/static/321e106c693079f7889192779df1e18a/ca1b5/image-28.webp 403w"
              sizes="(max-width: 403px) 100vw, 403px"
              type="image/webp"
            />
          <source
            srcset="/static/321e106c693079f7889192779df1e18a/8ff5a/image-28.png 240w,
/static/321e106c693079f7889192779df1e18a/045fd/image-28.png 403w"
            sizes="(max-width: 403px) 100vw, 403px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/321e106c693079f7889192779df1e18a/045fd/image-28.png"
            alt="image-28.png"
            title="image-28.png"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>クライアントアプリケーションでは、受け取った引数は以下のように<code class="language-text">atoi</code>関数で数値化され、ドライバルーチンに渡されます。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">data<span class="token punctuation">.</span>ThreadId <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">.</span>Priority <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>C++の<code class="language-text">atoi</code>関数は文字列を4バイトの<code class="language-text">int</code>型の数値に変換します。</p>
<p>そのため、メモリに格納されているデータも4バイト単位のリトルエンディアン形式で読むのがよさそうです。</p>
<p>上記より、入力バッファの参照先のメモリに保存されている値は、以下の通りクライアントアプリケーションに与えた引数と一致していることがわかりました。</p>
<div class="gatsby-highlight" data-language="powershell"><pre class="language-powershell"><code class="language-powershell">0x2148 = 8520
0x1F = 31</code></pre></div>
<p>WinDbgを使うと、カーネルドライバに渡されたIRPの情報も簡単に参照できるので非常に便利ですね。</p>
<h2 id="まとめ" style="position:relative;"><a href="#%E3%81%BE%E3%81%A8%E3%82%81" aria-label="まとめ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>まとめ</h2>
<p>さて、これで最低限の機能をそろえたカーネルドライバの実装と、デバッグによるIRPの解析に入門することができました。</p>
<p>まだまだ先は長いですが、引き続きカーネルプログラミングとデバッグは続けていこうと思います。</p>
<h2 id="参考書籍" style="position:relative;"><a href="#%E5%8F%82%E8%80%83%E6%9B%B8%E7%B1%8D" aria-label="参考書籍 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考書籍</h2>
<ul>
<li><a href="https://amzn.to/3H3WMoe" target="_blank" rel="nofollow noopener noreferrer">Windowsカーネルドライバプログラミング</a></li>
</ul></div></div></div><div class="Post-module--post__footer--3WzWU"><div><p class="Meta-module--meta__date--29eD7">Published <!-- -->Jan 29, 2022</p></div><div class="Tags-module--tags--1L_ct"><ul class="Tags-module--tags__list--91FqN"><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/win-dbg/">WinDbg</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/kernel/">Kernel</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/kernel-driver/">KernelDriver</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/reversing/">Reversing</a></li></ul></div><div class="Author-module--author--2Yefr"><p>リバースエンジニアになりたいCTF Player(Team: 0nePadding)。WinDbgとYARAが好き。OSCP / CISSP / AtCoder 緑 Microsoft Japanに所属してます。発言はすべて個人の見解。<a class="Author-module--author__bio-twitter--n-O9n" href="https://www.twitter.com/kash1064" rel="noopener noreferrer" target="_blank"><strong>かしわば</strong> on Twitter</a></p></div></div><div class="Post-module--post__comments--25y6I"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/windows-windriver-002-irp";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-299cfcade846097f4d4b.js"],"app":["/app-f5b45fb557768b3cf36f.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-fd4fb51a6fac1c18bdde.js"],"component---src-templates-categories-list-template-js":["/component---src-templates-categories-list-template-js-2181ec47d28e5c35d3e9.js"],"component---src-templates-category-template-js":["/component---src-templates-category-template-js-76f2006942127b3c7274.js"],"component---src-templates-index-template-js":["/component---src-templates-index-template-js-70ba56c0f46525baa629.js"],"component---src-templates-not-found-template-js":["/component---src-templates-not-found-template-js-d19905e5c8fc953958f1.js"],"component---src-templates-page-template-js":["/component---src-templates-page-template-js-6ba68ef37e264f701345.js"],"component---src-templates-post-template-js":["/component---src-templates-post-template-js-381c1b847824134fa4bd.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-0faa242d92f89b71e668.js"],"component---src-templates-tags-list-template-js":["/component---src-templates-tags-list-template-js-2d7007993fc2bf0f9caf.js"]};/*]]>*/</script><script src="/polyfill-299cfcade846097f4d4b.js" nomodule=""></script><script src="/component---src-templates-post-template-js-381c1b847824134fa4bd.js" async=""></script><script src="/cd95ea5cbd2c605f26db819f07999610c9ff4310-c2f05dc74373de400085.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-f5b45fb557768b3cf36f.js" async=""></script><script src="/dc6a8720040df98778fe970bf6c000a41750d3ae-84d7c7f527ea24afde0e.js" async=""></script><script src="/532a2f07-92db97c0addf07d5cb73.js" async=""></script><script src="/framework-3761df4ab6ee9f056936.js" async=""></script><script src="/webpack-runtime-a3c0f166cb4b802ff58f.js" async=""></script></body></html>